diff --git a/TMessagesProj/build.gradle b/TMessagesProj/build.gradle
index 683d05edc..21e63ba64 100644
--- a/TMessagesProj/build.gradle
+++ b/TMessagesProj/build.gradle
@@ -80,7 +80,7 @@ android {
     defaultConfig {
         minSdkVersion 8
         targetSdkVersion 19
-        versionCode 330
-        versionName "1.9.0"
+        versionCode 343
+        versionName "1.9.1"
     }
 }
diff --git a/TMessagesProj/src/main/AndroidManifest.xml b/TMessagesProj/src/main/AndroidManifest.xml
index d8ee6d5e8..f7bfaaa0c 100644
--- a/TMessagesProj/src/main/AndroidManifest.xml
+++ b/TMessagesProj/src/main/AndroidManifest.xml
@@ -138,6 +138,7 @@
 
         <service android:name="org.telegram.android.NotificationsService" android:enabled="true"/>
         <service android:name="org.telegram.android.NotificationRepeat" android:exported="false"/>
+        <service android:name="org.telegram.android.VideoEncodingService" android:enabled="true"/>
 
         <receiver android:name="org.telegram.android.AppStartReceiver" android:enabled="true">
             <intent-filter>
diff --git a/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java b/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
index cc8a2439c..9f9431299 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
@@ -41,8 +41,8 @@
     public static int statusBarHeight = 0;
     public static float density = 1;
     public static Point displaySize = new Point();
+    public static Integer photoSize = null;
     private static Boolean isTablet = null;
-    private static Boolean isSmallTablet = null;
 
     public static int[] arrColors = {0xffee4928, 0xff41a903, 0xffe09602, 0xff0f94ed, 0xff8f3bf7, 0xfffc4380, 0xff00a1c4, 0xffeb7002};
     public static int[] arrUsersAvatars = {
@@ -277,11 +277,8 @@ public static boolean isTablet() {
     }
 
     public static boolean isSmallTablet() {
-        if (isSmallTablet == null) {
-            float minSide = Math.min(displaySize.x, displaySize.y) / density;
-            isSmallTablet = minSide <= 700;
-        }
-        return isSmallTablet;
+        float minSide = Math.min(displaySize.x, displaySize.y) / density;
+        return minSide <= 700;
     }
 
     public static int getMinTabletSide() {
@@ -354,4 +351,15 @@ public static int getGroupAvatarForId(int id) {
     public static int getBroadcastAvatarForId(int id) {
         return arrBroadcastAvatars[getColorIndex(-Math.abs(id))];
     }
+
+    public static int getPhotoSize() {
+        if (photoSize == null) {
+            if (Build.VERSION.SDK_INT >= 16) {
+                photoSize = 1280;
+            } else {
+                photoSize = 800;
+            }
+        }
+        return photoSize;
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/ContactsController.java b/TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
index cd6cd1385..6278d4e5d 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
@@ -105,7 +105,7 @@ public ContactsController() {
         try {
             nameDisplayOrder = Settings.System.getInt(ApplicationLoader.applicationContext.getContentResolver(), "android.contacts.DISPLAY_ORDER");
         } catch (Exception e) {
-            FileLog.e("tmessages", e);
+            //don't promt
         }
     }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java b/TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
index 49255f7e3..1592076e3 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
@@ -64,6 +64,8 @@
     private int lastImageNum = 0;
     private long lastProgressUpdateTime = 0;
 
+    private File telegramPath = null;
+
     private class HttpTask extends AsyncTask<Void, Void, Boolean> {
 
         private CacheImage cacheImage = null;
@@ -548,6 +550,13 @@ public void fileDidLoaded(final String location, final File finalFile, final Fil
                 AndroidUtilities.RunOnUIThread(new Runnable() {
                     @Override
                     public void run() {
+                        if (location != null) {
+                            if (MediaController.getInstance().canSaveToGallery() && telegramPath != null && finalFile != null && finalFile.exists() && (location.endsWith(".mp4") || location.endsWith(".jpg"))) {
+                                if (finalFile.toString().startsWith(telegramPath.toString())) {
+                                    Utilities.addMediaToGallery(finalFile.toString());
+                                }
+                            }
+                        }
                         ImageLoader.this.fileDidLoaded(location, finalFile, tempFile);
                         NotificationCenter.getInstance().postNotificationName(NotificationCenter.FileDidLoaded, location);
                     }
@@ -555,12 +564,12 @@ public void run() {
             }
 
             @Override
-            public void fileDidFailedLoad(final String location, final boolean canceled) {
+            public void fileDidFailedLoad(final String location, final int state) {
                 AndroidUtilities.RunOnUIThread(new Runnable() {
                     @Override
                     public void run() {
                         ImageLoader.this.fileDidFailedLoad(location);
-                        NotificationCenter.getInstance().postNotificationName(NotificationCenter.FileDidFailedLoad, location, canceled);
+                        NotificationCenter.getInstance().postNotificationName(NotificationCenter.FileDidFailedLoad, location, state);
                     }
                 });
             }
@@ -586,41 +595,68 @@ public void run() {
     private HashMap<Integer, File> createMediaPaths() {
         HashMap<Integer, File> mediaDirs = new HashMap<Integer, File>();
         File cachePath = AndroidUtilities.getCacheDir();
-        try {
-            cachePath.mkdirs();
-            new File(cachePath, ".nomedia").createNewFile();
-        } catch (Exception e) {
-            FileLog.e("tmessages", e);
+        if (!cachePath.isDirectory()) {
+            try {
+                cachePath.mkdirs();
+            } catch (Exception e) {
+                FileLog.e("tmessages", e);
+            }
         }
         mediaDirs.put(FileLoader.MEDIA_DIR_CACHE, cachePath);
+
         try {
             if (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())) {
-                File telegramPath = new File(Environment.getExternalStorageDirectory(), LocaleController.getString("AppName", R.string.AppName));
+                telegramPath = new File(Environment.getExternalStorageDirectory(), LocaleController.getString("AppName", R.string.AppName));
                 telegramPath.mkdirs();
+                if (telegramPath.isDirectory()) {
+                    try {
+                        File imagePath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Images");
+                        imagePath.mkdir();
+                        if (imagePath.isDirectory()) {
+                            //new File(imagePath, ".nomedia").delete();
+                            mediaDirs.put(FileLoader.MEDIA_DIR_IMAGE, imagePath);
+                        }
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
+
+                    try {
+                        File videoPath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Video");
+                        videoPath.mkdir();
+                        if (videoPath.isDirectory()) {
+                            mediaDirs.put(FileLoader.MEDIA_DIR_VIDEO, videoPath);
+                        }
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
 
-                File imagePath = new File(telegramPath, "Images");
-                imagePath.mkdir();
-                new File(imagePath, ".nomedia").createNewFile();
-                mediaDirs.put(FileLoader.MEDIA_DIR_IMAGE, imagePath);
-
-                File videoPath = new File(telegramPath, "Video");
-                videoPath.mkdir();
-                new File(videoPath, ".nomedia").createNewFile();
-                mediaDirs.put(FileLoader.MEDIA_DIR_VIDEO, videoPath);
-
-                File audioPath = new File(telegramPath, "Audio");
-                audioPath.mkdir();
-                new File(audioPath, ".nomedia").createNewFile();
-                mediaDirs.put(FileLoader.MEDIA_DIR_AUDIO, audioPath);
-
-                File documentPath = new File(telegramPath, "Documents");
-                documentPath.mkdir();
-                new File(documentPath, ".nomedia").createNewFile();
-                mediaDirs.put(FileLoader.MEDIA_DIR_DOCUMENT, documentPath);
+                    try {
+                        File audioPath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Audio");
+                        audioPath.mkdir();
+                        if (audioPath.isDirectory()) {
+                            new File(audioPath, ".nomedia").createNewFile();
+                            mediaDirs.put(FileLoader.MEDIA_DIR_AUDIO, audioPath);
+                        }
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
+
+                    try {
+                        File documentPath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Documents");
+                        documentPath.mkdir();
+                        if (documentPath.isDirectory()) {
+                            new File(documentPath, ".nomedia").createNewFile();
+                            mediaDirs.put(FileLoader.MEDIA_DIR_DOCUMENT, documentPath);
+                        }
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
+                }
             }
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
+
         return mediaDirs;
     }
 
@@ -1013,22 +1049,7 @@ public static Bitmap loadBitmap(String path, Uri uri, float maxWidth, float maxH
         return b;
     }
 
-    public static TLRPC.PhotoSize scaleAndSaveImage(Bitmap bitmap, float maxWidth, float maxHeight, int quality, boolean cache) {
-        if (bitmap == null) {
-            return null;
-        }
-        float photoW = bitmap.getWidth();
-        float photoH = bitmap.getHeight();
-        if (photoW == 0 || photoH == 0) {
-            return null;
-        }
-        float scaleFactor = Math.max(photoW / maxWidth, photoH / maxHeight);
-        int w = (int)(photoW / scaleFactor);
-        int h = (int)(photoH / scaleFactor);
-        if (h == 0 || w == 0) {
-            return null;
-        }
-
+    private static TLRPC.PhotoSize scaleAndSaveImageInternal(Bitmap bitmap, int w, int h, float photoW, float photoH, float scaleFactor, int quality, boolean cache) throws Exception {
         Bitmap scaledBitmap = Bitmap.createScaledBitmap(bitmap, w, h, true);
 
         TLRPC.TL_fileLocation location = new TLRPC.TL_fileLocation();
@@ -1045,25 +1066,54 @@ public static Bitmap loadBitmap(String path, Uri uri, float maxWidth, float maxH
         size.location = location;
         size.w = (int)(photoW / scaleFactor);
         size.h = (int)(photoH / scaleFactor);
+
+        if (!cache) {
+            String fileName = location.volume_id + "_" + location.local_id + ".jpg";
+            final File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
+            FileOutputStream stream = new FileOutputStream(cacheFile);
+            scaledBitmap.compress(Bitmap.CompressFormat.JPEG, quality, stream);
+            size.size = (int)stream.getChannel().size();
+        } else {
+            ByteArrayOutputStream stream = new ByteArrayOutputStream();
+            scaledBitmap.compress(Bitmap.CompressFormat.JPEG, quality, stream);
+            size.bytes = stream.toByteArray();
+            size.size = size.bytes.length;
+        }
+        if (scaledBitmap != bitmap) {
+            scaledBitmap.recycle();
+        }
+
+        return size;
+    }
+
+    public static TLRPC.PhotoSize scaleAndSaveImage(Bitmap bitmap, float maxWidth, float maxHeight, int quality, boolean cache) {
+        if (bitmap == null) {
+            return null;
+        }
+        float photoW = bitmap.getWidth();
+        float photoH = bitmap.getHeight();
+        if (photoW == 0 || photoH == 0) {
+            return null;
+        }
+        float scaleFactor = Math.max(photoW / maxWidth, photoH / maxHeight);
+        int w = (int)(photoW / scaleFactor);
+        int h = (int)(photoH / scaleFactor);
+        if (h == 0 || w == 0) {
+            return null;
+        }
+
         try {
-            if (!cache) {
-                String fileName = location.volume_id + "_" + location.local_id + ".jpg";
-                final File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
-                FileOutputStream stream = new FileOutputStream(cacheFile);
-                scaledBitmap.compress(Bitmap.CompressFormat.JPEG, quality, stream);
-                size.size = (int)stream.getChannel().size();
-            } else {
-                ByteArrayOutputStream stream = new ByteArrayOutputStream();
-                scaledBitmap.compress(Bitmap.CompressFormat.JPEG, quality, stream);
-                size.bytes = stream.toByteArray();
-                size.size = size.bytes.length;
-            }
-            if (scaledBitmap != bitmap) {
-                scaledBitmap.recycle();
-            }
-            return size;
+            return scaleAndSaveImageInternal(bitmap, w, h, photoW, photoH, scaleFactor, quality, cache);
         } catch (Throwable e) {
-            return null;
+            FileLog.e("tmessages", e);
+            ImageLoader.getInstance().clearMemory();
+            System.gc();
+            try {
+                return scaleAndSaveImageInternal(bitmap, w, h, photoW, photoH, scaleFactor, quality, cache);
+            } catch (Throwable e2) {
+                FileLog.e("tmessages", e2);
+                return null;
+            }
         }
     }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/MediaController.java b/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
index b97a7add8..64e8c6c8a 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
@@ -8,6 +8,7 @@
 
 package org.telegram.android;
 
+import android.annotation.TargetApi;
 import android.app.Activity;
 import android.app.ProgressDialog;
 import android.content.BroadcastReceiver;
@@ -21,16 +22,26 @@
 import android.media.AudioManager;
 import android.media.AudioRecord;
 import android.media.AudioTrack;
+import android.media.MediaCodec;
+import android.media.MediaCodecInfo;
+import android.media.MediaCodecList;
+import android.media.MediaExtractor;
+import android.media.MediaFormat;
 import android.media.MediaPlayer;
 import android.media.MediaRecorder;
 import android.net.ConnectivityManager;
 import android.net.Uri;
+import android.os.Build;
 import android.os.Environment;
 import android.os.ParcelFileDescriptor;
 import android.os.Vibrator;
 import android.provider.MediaStore;
 import android.view.View;
 
+import org.telegram.android.video.InputSurface;
+import org.telegram.android.video.MP4Builder;
+import org.telegram.android.video.Mp4Movie;
+import org.telegram.android.video.OutputSurface;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.DispatchQueue;
 import org.telegram.messenger.FileLoader;
@@ -133,6 +144,20 @@ public PhotoEntry(int bucketId, int imageId, long dateTaken, String path, int or
         }
     }
 
+    private final static String MIME_TYPE = "video/avc";
+    private final static int PROCESSOR_TYPE_OTHER = 0;
+    private final static int PROCESSOR_TYPE_QCOM = 1;
+    private final static int PROCESSOR_TYPE_INTEL = 2;
+    private final static int PROCESSOR_TYPE_MTK = 3;
+    private final static int PROCESSOR_TYPE_SEC = 4;
+    private final static int PROCESSOR_TYPE_TI = 5;
+    private final Object videoConvertSync = new Object();
+
+    private ArrayList<MessageObject> videoConvertQueue = new ArrayList<MessageObject>();
+    private final Object videoQueueSync = new Object();
+    private boolean cancelCurrentVideoConversion = false;
+    private boolean videoConvertFirstWrite = true;
+
     public static final int AUTODOWNLOAD_MASK_PHOTO = 1;
     public static final int AUTODOWNLOAD_MASK_AUDIO = 2;
     public static final int AUTODOWNLOAD_MASK_VIDEO = 4;
@@ -147,6 +172,8 @@ public PhotoEntry(int bucketId, int imageId, long dateTaken, String path, int or
     private ArrayList<DownloadObject> videoDownloadQueue = new ArrayList<DownloadObject>();
     private HashMap<String, DownloadObject> downloadQueueKeys = new HashMap<String, DownloadObject>();
 
+    private boolean saveToGallery = true;
+
     private HashMap<String, ArrayList<WeakReference<FileDownloadProgressListener>>> loadingFileObservers = new HashMap<String, ArrayList<WeakReference<FileDownloadProgressListener>>>();
     private HashMap<Integer, String> observersByTag = new HashMap<Integer, String>();
     private boolean listenerInProgress = false;
@@ -367,6 +394,7 @@ public MediaController() {
         mobileDataDownloadMask = preferences.getInt("mobileDataDownloadMask", AUTODOWNLOAD_MASK_PHOTO | AUTODOWNLOAD_MASK_AUDIO);
         wifiDownloadMask = preferences.getInt("wifiDownloadMask", AUTODOWNLOAD_MASK_PHOTO | AUTODOWNLOAD_MASK_AUDIO);
         roamingDownloadMask = preferences.getInt("roamingDownloadMask", 0);
+        saveToGallery = preferences.getBoolean("save_gallery", false);
 
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileDidFailedLoad);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileDidLoaded);
@@ -468,6 +496,8 @@ public void cleanup() {
         documentDownloadQueue.clear();
         videoDownloadQueue.clear();
         downloadQueueKeys.clear();
+        videoConvertQueue.clear();
+        cancelVideoConvert(null);
     }
 
     protected int getAutodownloadMask() {
@@ -593,9 +623,9 @@ protected void processDownloadObjects(int type, ArrayList<DownloadObject> object
             } else if (downloadObject.object instanceof TLRPC.PhotoSize) {
                 FileLoader.getInstance().loadFile((TLRPC.PhotoSize)downloadObject.object, false);
             } else if (downloadObject.object instanceof TLRPC.Video) {
-                FileLoader.getInstance().loadFile((TLRPC.Video)downloadObject.object);
+                FileLoader.getInstance().loadFile((TLRPC.Video)downloadObject.object, false);
             } else if (downloadObject.object instanceof TLRPC.Document) {
-                FileLoader.getInstance().loadFile((TLRPC.Document)downloadObject.object);
+                FileLoader.getInstance().loadFile((TLRPC.Document)downloadObject.object, false);
             } else {
                 added = false;
             }
@@ -622,12 +652,12 @@ protected void newDownloadObjectsAvailable(int downloadMask) {
         }
     }
 
-    private void checkDownloadFinished(String fileName, boolean canceled) {
+    private void checkDownloadFinished(String fileName, int state) {
         DownloadObject downloadObject = downloadQueueKeys.get(fileName);
         if (downloadObject != null) {
             downloadQueueKeys.remove(fileName);
-            if (!canceled) {
-                MessagesStorage.getInstance().removeFromDownloadQueue(downloadObject.id, downloadObject.type);
+            if (state == 0 || state == 2) {
+                MessagesStorage.getInstance().removeFromDownloadQueue(downloadObject.id, downloadObject.type, state != 0);
             }
             if (downloadObject.type == AUTODOWNLOAD_MASK_PHOTO) {
                 photoDownloadQueue.remove(downloadObject);
@@ -885,7 +915,7 @@ public void didReceivedNotification(int id, Object... args) {
             }
             listenerInProgress = false;
             processLaterArrays();
-            checkDownloadFinished(fileName, (Boolean)args[1]);
+            checkDownloadFinished(fileName, (Integer)args[1]);
         } else if (id == NotificationCenter.FileDidLoaded) {
             listenerInProgress = true;
             String fileName = (String)args[0];
@@ -901,7 +931,7 @@ public void didReceivedNotification(int id, Object... args) {
             }
             listenerInProgress = false;
             processLaterArrays();
-            checkDownloadFinished(fileName, false);
+            checkDownloadFinished(fileName, 0);
         } else if (id == NotificationCenter.FileLoadProgressChanged) {
             listenerInProgress = true;
             String fileName = (String)args[0];
@@ -917,7 +947,6 @@ public void didReceivedNotification(int id, Object... args) {
             listenerInProgress = false;
             processLaterArrays();
         } else if (id == NotificationCenter.FileUploadProgressChanged) {
-            String location = (String)args[0];
             listenerInProgress = true;
             String fileName = (String)args[0];
             ArrayList<WeakReference<FileDownloadProgressListener>> arrayList = loadingFileObservers.get(fileName);
@@ -1441,11 +1470,10 @@ public void run() {
                         public void run() {
                             audioToSend.date = ConnectionsManager.getInstance().getCurrentTime();
                             audioToSend.size = (int) recordingAudioFileToSend.length();
-                            audioToSend.path = recordingAudioFileToSend.getAbsolutePath();
                             long duration = recordTimeCount;
                             audioToSend.duration = (int) (duration / 1000);
                             if (duration > 700) {
-                                SendMessagesHelper.getInstance().sendMessage(audioToSend, recordDialogId);
+                                SendMessagesHelper.getInstance().sendMessage(audioToSend, recordingAudioFileToSend.getAbsolutePath(), recordDialogId);
                             } else {
                                 recordingAudioFileToSend.delete();
                             }
@@ -1502,8 +1530,8 @@ public void run() {
         });
     }
 
-    public static void saveFile(String path, String fullPath, Context context, final int type, final String name) {
-        if (path == null && fullPath == null) {
+    public static void saveFile(String fullPath, Context context, final int type, final String name) {
+        if (fullPath == null) {
             return;
         }
 
@@ -1514,8 +1542,9 @@ public static void saveFile(String path, String fullPath, Context context, final
                 file = null;
             }
         }
+
         if (file == null) {
-            file = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), path);
+            return;
         }
 
         final File sourceFile = file;
@@ -1759,6 +1788,43 @@ public static String copyDocumentToCache(Uri uri, String ext) {
         return null;
     }
 
+    public void toggleSaveToGallery() {
+        saveToGallery = !saveToGallery;
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("save_gallery", saveToGallery);
+        editor.commit();
+        try {
+            File telegramPath = new File(Environment.getExternalStorageDirectory(), LocaleController.getString("AppName", R.string.AppName));
+            File imagePath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Images");
+            imagePath.mkdir();
+            File videoPath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Video");
+            videoPath.mkdir();
+
+            if (saveToGallery) {
+                if (imagePath.isDirectory()) {
+                    new File(imagePath, ".nomedia").delete();
+                }
+                if (videoPath.isDirectory()) {
+                    new File(videoPath, ".nomedia").delete();
+                }
+            } else {
+                if (imagePath.isDirectory()) {
+                    new File(imagePath, ".nomedia").createNewFile();
+                }
+                if (videoPath.isDirectory()) {
+                    new File(videoPath, ".nomedia").createNewFile();
+                }
+            }
+        } catch (Exception e) {
+            FileLog.e("tmessages", e);
+        }
+    }
+
+    public boolean canSaveToGallery() {
+        return saveToGallery;
+    }
+
     public static void loadGalleryPhotosAlbums(final int guid) {
         new Thread(new Runnable() {
             @Override
@@ -1838,4 +1904,653 @@ public void run() {
             }
         }).start();
     }
+
+    public void scheduleVideoConvert(MessageObject messageObject) {
+        videoConvertQueue.add(messageObject);
+        if (videoConvertQueue.size() == 1) {
+            startVideoConvertFromQueue();
+        }
+    }
+
+    public void cancelVideoConvert(MessageObject messageObject) {
+        if (messageObject == null) {
+            synchronized (videoConvertSync) {
+                cancelCurrentVideoConversion = true;
+            }
+        } else {
+            if (!videoConvertQueue.isEmpty()) {
+                if (videoConvertQueue.get(0) == messageObject) {
+                    synchronized (videoConvertSync) {
+                        cancelCurrentVideoConversion = true;
+                    }
+                }
+                videoConvertQueue.remove(messageObject);
+            }
+        }
+    }
+
+    private void startVideoConvertFromQueue() {
+        if (!videoConvertQueue.isEmpty()) {
+            synchronized (videoConvertSync) {
+                cancelCurrentVideoConversion = false;
+            }
+            MessageObject messageObject = videoConvertQueue.get(0);
+            Intent intent = new Intent(ApplicationLoader.applicationContext, VideoEncodingService.class);
+            intent.putExtra("path", messageObject.messageOwner.attachPath);
+            ApplicationLoader.applicationContext.startService(intent);
+            VideoConvertRunnable.runConversion(messageObject);
+        }
+    }
+
+    private static MediaCodecInfo selectCodec(String mimeType) {
+        int numCodecs = MediaCodecList.getCodecCount();
+        MediaCodecInfo lastCodecInfo = null;
+        for (int i = 0; i < numCodecs; i++) {
+            MediaCodecInfo codecInfo = MediaCodecList.getCodecInfoAt(i);
+            if (!codecInfo.isEncoder()) {
+                continue;
+            }
+            String[] types = codecInfo.getSupportedTypes();
+            for (String type : types) {
+                if (type.equalsIgnoreCase(mimeType)) {
+                    lastCodecInfo = codecInfo;
+                    if (!lastCodecInfo.getName().equals("OMX.SEC.avc.enc")) {
+                        return lastCodecInfo;
+                    } else if (lastCodecInfo.getName().equals("OMX.SEC.AVC.Encoder")) {
+                        return lastCodecInfo;
+                    }
+                }
+            }
+        }
+        return lastCodecInfo;
+    }
+
+    private static boolean isRecognizedFormat(int colorFormat) {
+        switch (colorFormat) {
+            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Planar:
+            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420PackedPlanar:
+            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420SemiPlanar:
+            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420PackedSemiPlanar:
+            case MediaCodecInfo.CodecCapabilities.COLOR_TI_FormatYUV420PackedSemiPlanar:
+                return true;
+            default:
+                return false;
+        }
+    }
+
+    private static int selectColorFormat(MediaCodecInfo codecInfo, String mimeType) {
+        MediaCodecInfo.CodecCapabilities capabilities = codecInfo.getCapabilitiesForType(mimeType);
+        int lastColorFormat = 0;
+        for (int i = 0; i < capabilities.colorFormats.length; i++) {
+            int colorFormat = capabilities.colorFormats[i];
+            if (isRecognizedFormat(colorFormat)) {
+                lastColorFormat = colorFormat;
+                if (!(codecInfo.getName().equals("OMX.SEC.AVC.Encoder") && colorFormat == 19)) {
+                    return colorFormat;
+                }
+            }
+        }
+        return lastColorFormat;
+    }
+
+    @TargetApi(16)
+    private int selectTrack(MediaExtractor extractor, boolean audio) {
+        int numTracks = extractor.getTrackCount();
+        for (int i = 0; i < numTracks; i++) {
+            MediaFormat format = extractor.getTrackFormat(i);
+            String mime = format.getString(MediaFormat.KEY_MIME);
+            if (audio) {
+                if (mime.startsWith("audio/")) {
+                    return i;
+                }
+            } else {
+                if (mime.startsWith("video/")) {
+                    return i;
+                }
+            }
+        }
+        return -5;
+    }
+
+    private void didWriteData(final MessageObject messageObject, final File file, final boolean last, final boolean error) {
+        final boolean firstWrite = videoConvertFirstWrite;
+        if (firstWrite) {
+            videoConvertFirstWrite = false;
+        }
+        AndroidUtilities.RunOnUIThread(new Runnable() {
+            @Override
+            public void run() {
+                if (error) {
+                    NotificationCenter.getInstance().postNotificationName(NotificationCenter.FilePreparingFailed, messageObject, file.toString());
+                } else {
+                    if (firstWrite) {
+                        NotificationCenter.getInstance().postNotificationName(NotificationCenter.FilePreparingStarted, messageObject, file.toString());
+                    }
+                    NotificationCenter.getInstance().postNotificationName(NotificationCenter.FileNewChunkAvailable, messageObject, file.toString(), last ? file.length() : 0);
+                }
+                if (error || last) {
+                    synchronized (videoConvertSync) {
+                        cancelCurrentVideoConversion = false;
+                    }
+                    videoConvertQueue.remove(messageObject);
+                    startVideoConvertFromQueue();
+                }
+            }
+        });
+    }
+
+    @TargetApi(16)
+    private long readAndWriteTrack(final MessageObject messageObject, MediaExtractor extractor, MP4Builder mediaMuxer, MediaCodec.BufferInfo info, long start, long end, File file, boolean isAudio) throws Exception {
+        int trackIndex = selectTrack(extractor, isAudio);
+        if (trackIndex >= 0) {
+            extractor.selectTrack(trackIndex);
+            MediaFormat trackFormat = extractor.getTrackFormat(trackIndex);
+            int muxerTrackIndex = mediaMuxer.addTrack(trackFormat, isAudio);
+            int maxBufferSize = trackFormat.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
+            boolean inputDone = false;
+            if (start > 0) {
+                extractor.seekTo(start, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
+            } else {
+                extractor.seekTo(0, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
+            }
+            ByteBuffer buffer = ByteBuffer.allocateDirect(maxBufferSize);
+            long startTime = -1;
+
+            checkConversionCanceled();
+
+            while (!inputDone) {
+                checkConversionCanceled();
+
+                boolean eof = false;
+                int index = extractor.getSampleTrackIndex();
+                if (index == trackIndex) {
+                    info.size = extractor.readSampleData(buffer, 0);
+
+                    if (info.size < 0) {
+                        info.size = 0;
+                        eof = true;
+                    } else {
+                        info.presentationTimeUs = extractor.getSampleTime();
+                        if (start > 0 && startTime == -1) {
+                            startTime = info.presentationTimeUs;
+                        }
+                        if (end < 0 || info.presentationTimeUs < end) {
+                            info.offset = 0;
+                            info.flags = extractor.getSampleFlags();
+                            if (!isAudio) {
+                                buffer.limit(info.offset + info.size);
+                                buffer.position(info.offset);
+                                buffer.putInt(info.size - 4);
+                            }
+                            if (mediaMuxer.writeSampleData(muxerTrackIndex, buffer, info)) {
+                                didWriteData(messageObject, file, false, false);
+                            }
+                            extractor.advance();
+                        } else {
+                            eof = true;
+                        }
+                    }
+                } else if (index == -1) {
+                    eof = true;
+                }
+                if (eof) {
+                    inputDone = true;
+                }
+            }
+
+            extractor.unselectTrack(trackIndex);
+            return startTime;
+        }
+        return -1;
+    }
+
+    private static class VideoConvertRunnable implements Runnable {
+
+        private MessageObject messageObject;
+
+        private VideoConvertRunnable(MessageObject message) {
+            messageObject = message;
+        }
+
+        @Override
+        public void run() {
+            MediaController.getInstance().convertVideo(messageObject);
+        }
+
+        public static void runConversion(final MessageObject obj) {
+            new Thread(new Runnable() {
+                @Override
+                public void run() {
+                    try {
+                        VideoConvertRunnable wrapper = new VideoConvertRunnable(obj);
+                        Thread th = new Thread(wrapper, "VideoConvertRunnable");
+                        th.start();
+                        th.join();
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
+                }
+            }).start();
+        }
+    }
+
+    private void checkConversionCanceled() throws Exception {
+        boolean cancelConversion = false;
+        synchronized (videoConvertSync) {
+            cancelConversion = cancelCurrentVideoConversion;
+        }
+        if (cancelConversion) {
+            throw new RuntimeException("canceled conversion");
+        }
+    }
+
+    @TargetApi(16)
+    private boolean convertVideo(final MessageObject messageObject) {
+        String videoPath = messageObject.messageOwner.videoEditedInfo.originalPath;
+        long startTime = messageObject.messageOwner.videoEditedInfo.startTime;
+        long endTime = messageObject.messageOwner.videoEditedInfo.endTime;
+        int resultWidth = messageObject.messageOwner.videoEditedInfo.resultWidth;
+        int resultHeight = messageObject.messageOwner.videoEditedInfo.resultHeight;
+        int rotationValue = messageObject.messageOwner.videoEditedInfo.rotationValue;
+        int originalWidth = messageObject.messageOwner.videoEditedInfo.originalWidth;
+        int originalHeight = messageObject.messageOwner.videoEditedInfo.originalHeight;
+        int bitrate = messageObject.messageOwner.videoEditedInfo.bitrate;
+        int rotateRender = 0;
+        File cacheFile = new File(messageObject.messageOwner.attachPath);
+
+        if (Build.VERSION.SDK_INT < 18 && resultHeight > resultWidth && resultWidth != originalWidth && resultHeight != originalHeight) {
+            int temp = resultHeight;
+            resultHeight = resultWidth;
+            resultWidth = temp;
+            rotationValue = 90;
+            rotateRender = 270;
+        }
+
+        File inputFile = new File(videoPath);
+        if (!inputFile.canRead()) {
+            return false;
+        }
+
+        videoConvertFirstWrite = true;
+        boolean error = false;
+        long videoStartTime = startTime;
+
+        long time = System.currentTimeMillis();
+
+        if (resultWidth != 0 && resultHeight != 0) {
+            MP4Builder mediaMuxer = null;
+            MediaExtractor extractor = null;
+
+            try {
+                MediaCodec.BufferInfo info = new MediaCodec.BufferInfo();
+                Mp4Movie movie = new Mp4Movie();
+                movie.setCacheFile(cacheFile);
+                movie.setRotation(rotationValue);
+                movie.setSize(resultWidth, resultHeight);
+                mediaMuxer = new MP4Builder().createMovie(movie);
+                extractor = new MediaExtractor();
+                extractor.setDataSource(inputFile.toString());
+
+                checkConversionCanceled();
+
+                if (resultWidth != originalWidth || resultHeight != originalHeight) {
+                    int videoIndex = -5;
+                    videoIndex = selectTrack(extractor, false);
+                    if (videoIndex >= 0) {
+                        MediaCodec decoder = null;
+                        MediaCodec encoder = null;
+                        InputSurface inputSurface = null;
+                        OutputSurface outputSurface = null;
+
+                        try {
+                            long videoTime = -1;
+                            boolean outputDone = false;
+                            boolean inputDone = false;
+                            boolean decoderDone = false;
+                            int swapUV = 0;
+                            int videoTrackIndex = -5;
+
+                            int colorFormat = 0;
+                            int processorType = PROCESSOR_TYPE_OTHER;
+                            String manufacturer = Build.MANUFACTURER.toLowerCase();
+                            if (Build.VERSION.SDK_INT < 18) {
+                                MediaCodecInfo codecInfo = selectCodec(MIME_TYPE);
+                                colorFormat = selectColorFormat(codecInfo, MIME_TYPE);
+                                if (colorFormat == 0) {
+                                    throw new RuntimeException("no supported color format");
+                                }
+                                String codecName = codecInfo.getName();
+                                if (codecName.contains("OMX.qcom.")) {
+                                    processorType = PROCESSOR_TYPE_QCOM;
+                                    if (Build.VERSION.SDK_INT == 16) {
+                                        if (manufacturer.equals("lge") || manufacturer.equals("nokia")) {
+                                            swapUV = 1;
+                                        }
+                                    }
+                                } else if (codecName.contains("OMX.Intel.")) {
+                                    processorType = PROCESSOR_TYPE_INTEL;
+                                } else if (codecName.equals("OMX.MTK.VIDEO.ENCODER.AVC")) {
+                                    processorType = PROCESSOR_TYPE_MTK;
+                                } else if (codecName.equals("OMX.SEC.AVC.Encoder")) {
+                                    processorType = PROCESSOR_TYPE_SEC;
+                                    swapUV = 1;
+                                } else if (codecName.equals("OMX.TI.DUCATI1.VIDEO.H264E")) {
+                                    processorType = PROCESSOR_TYPE_TI;
+                                }
+                                FileLog.e("tmessages", "codec = " + codecInfo.getName() + " manufacturer = " + manufacturer + "device = " + Build.MODEL);
+                            } else {
+                                colorFormat = MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface;
+                            }
+                            FileLog.e("tmessages", "colorFormat = " + colorFormat);
+
+                            int resultHeightAligned = resultHeight;
+                            int padding = 0;
+                            int bufferSize = resultWidth * resultHeight * 3 / 2;
+                            if (processorType == PROCESSOR_TYPE_OTHER) {
+                                if (resultHeight % 16 != 0) {
+                                    resultHeightAligned += (16 - (resultHeight % 16));
+                                    padding = resultWidth * (resultHeightAligned - resultHeight);
+                                    bufferSize += padding * 5 / 4;
+                                }
+                            } else if (processorType == PROCESSOR_TYPE_QCOM) {
+                                if (!manufacturer.toLowerCase().equals("lge")) {
+                                    int uvoffset = (resultWidth * resultHeight + 2047) & ~2047;
+                                    padding = uvoffset - (resultWidth * resultHeight);
+                                    bufferSize += padding;
+                                }
+                            } else if (processorType == PROCESSOR_TYPE_TI) {
+                                //resultHeightAligned = 368;
+                                //bufferSize = resultWidth * resultHeightAligned * 3 / 2;
+                                //resultHeightAligned += (16 - (resultHeight % 16));
+                                //padding = resultWidth * (resultHeightAligned - resultHeight);
+                                //bufferSize += padding * 5 / 4;
+                            } else if (processorType == PROCESSOR_TYPE_MTK) {
+                                if (manufacturer.equals("baidu")) {
+                                    resultHeightAligned += (16 - (resultHeight % 16));
+                                    padding = resultWidth * (resultHeightAligned - resultHeight);
+                                    bufferSize += padding * 5 / 4;
+                                }
+                            }
+
+                            extractor.selectTrack(videoIndex);
+                            if (startTime > 0) {
+                                extractor.seekTo(startTime, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
+                            } else {
+                                extractor.seekTo(0, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
+                            }
+                            MediaFormat inputFormat = extractor.getTrackFormat(videoIndex);
+
+                            MediaFormat outputFormat = MediaFormat.createVideoFormat(MIME_TYPE, resultWidth, resultHeight);
+                            outputFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);
+                            outputFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate != 0 ? bitrate : 921600);
+                            outputFormat.setInteger(MediaFormat.KEY_FRAME_RATE, 25);
+                            outputFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 10);
+                            if (Build.VERSION.SDK_INT < 18) {
+                                outputFormat.setInteger("stride", resultWidth + 32);
+                                outputFormat.setInteger("slice-height", resultHeight);
+                            }
+
+                            encoder = MediaCodec.createEncoderByType(MIME_TYPE);
+                            encoder.configure(outputFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);
+                            if (Build.VERSION.SDK_INT >= 18) {
+                                inputSurface = new InputSurface(encoder.createInputSurface());
+                                inputSurface.makeCurrent();
+                            }
+                            encoder.start();
+
+                            decoder = MediaCodec.createDecoderByType(inputFormat.getString(MediaFormat.KEY_MIME));
+                            if (Build.VERSION.SDK_INT >= 18) {
+                                outputSurface = new OutputSurface();
+                            } else {
+                                outputSurface = new OutputSurface(resultWidth, resultHeight, rotateRender);
+                            }
+                            decoder.configure(inputFormat, outputSurface.getSurface(), null, 0);
+                            decoder.start();
+
+                            final int TIMEOUT_USEC = 2500;
+                            ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();
+                            ByteBuffer[] encoderOutputBuffers = encoder.getOutputBuffers();
+                            ByteBuffer[] encoderInputBuffers = null;
+                            if (Build.VERSION.SDK_INT < 18) {
+                                encoderInputBuffers = encoder.getInputBuffers();
+                            }
+
+                            checkConversionCanceled();
+
+                            while (!outputDone) {
+                                checkConversionCanceled();
+                                if (!inputDone) {
+                                    boolean eof = false;
+                                    int index = extractor.getSampleTrackIndex();
+                                    if (index == videoIndex) {
+                                        int inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);
+                                        if (inputBufIndex >= 0) {
+                                            ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];
+                                            int chunkSize = extractor.readSampleData(inputBuf, 0);
+                                            if (chunkSize < 0) {
+                                                decoder.queueInputBuffer(inputBufIndex, 0, 0, 0L, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
+                                                inputDone = true;
+                                            } else {
+                                                decoder.queueInputBuffer(inputBufIndex, 0, chunkSize, extractor.getSampleTime(), 0);
+                                                extractor.advance();
+                                            }
+                                        }
+                                    } else if (index == -1) {
+                                        eof = true;
+                                    }
+                                    if (eof) {
+                                        int inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);
+                                        if (inputBufIndex >= 0) {
+                                            decoder.queueInputBuffer(inputBufIndex, 0, 0, 0L, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
+                                            inputDone = true;
+                                        }
+                                    }
+                                }
+
+                                boolean decoderOutputAvailable = !decoderDone;
+                                boolean encoderOutputAvailable = true;
+                                while (decoderOutputAvailable || encoderOutputAvailable) {
+                                    checkConversionCanceled();
+                                    int encoderStatus = encoder.dequeueOutputBuffer(info, TIMEOUT_USEC);
+                                    if (encoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) {
+                                        encoderOutputAvailable = false;
+                                    } else if (encoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) {
+                                        encoderOutputBuffers = encoder.getOutputBuffers();
+                                    } else if (encoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) {
+                                        MediaFormat newFormat = encoder.getOutputFormat();
+                                        if (videoTrackIndex == -5) {
+                                            videoTrackIndex = mediaMuxer.addTrack(newFormat, false);
+                                        }
+                                    } else if (encoderStatus < 0) {
+                                        throw new RuntimeException("unexpected result from encoder.dequeueOutputBuffer: " + encoderStatus);
+                                    } else {
+                                        ByteBuffer encodedData = encoderOutputBuffers[encoderStatus];
+                                        if (encodedData == null) {
+                                            throw new RuntimeException("encoderOutputBuffer " + encoderStatus + " was null");
+                                        }
+                                        if (info.size > 1) {
+                                            if ((info.flags & MediaCodec.BUFFER_FLAG_CODEC_CONFIG) == 0) {
+                                                encodedData.limit(info.offset + info.size);
+                                                encodedData.position(info.offset);
+                                                encodedData.putInt(Integer.reverseBytes(info.size - 4));
+                                                if (mediaMuxer.writeSampleData(videoTrackIndex, encodedData, info)) {
+                                                    didWriteData(messageObject, cacheFile, false, false);
+                                                }
+                                            } else if (videoTrackIndex == -5) {
+                                                byte[] csd = new byte[info.size];
+                                                encodedData.limit(info.offset + info.size);
+                                                encodedData.position(info.offset);
+                                                encodedData.get(csd);
+                                                ByteBuffer sps = null;
+                                                ByteBuffer pps = null;
+                                                for (int a = info.size - 1; a >= 0; a--) {
+                                                    if (a > 3) {
+                                                        if (csd[a] == 1 && csd[a - 1] == 0 && csd[a - 2] == 0 && csd[a - 3] == 0) {
+                                                            sps = ByteBuffer.allocate(a - 3);
+                                                            pps = ByteBuffer.allocate(info.size - (a - 3));
+                                                            sps.put(csd, 0, a - 3).position(0);
+                                                            pps.put(csd, a - 3, info.size - (a - 3)).position(0);
+                                                            break;
+                                                        }
+                                                    } else {
+                                                        break;
+                                                    }
+                                                }
+
+                                                MediaFormat newFormat = MediaFormat.createVideoFormat(MIME_TYPE, resultWidth, resultHeight);
+                                                if (sps != null && pps != null) {
+                                                    newFormat.setByteBuffer("csd-0", sps);
+                                                    newFormat.setByteBuffer("csd-1", pps);
+                                                }
+                                                videoTrackIndex = mediaMuxer.addTrack(newFormat, false);
+                                            }
+                                        }
+                                        outputDone = (info.flags & MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0;
+                                        encoder.releaseOutputBuffer(encoderStatus, false);
+                                    }
+                                    if (encoderStatus != MediaCodec.INFO_TRY_AGAIN_LATER) {
+                                        continue;
+                                    }
+
+                                    if (!decoderDone) {
+                                        int decoderStatus = decoder.dequeueOutputBuffer(info, TIMEOUT_USEC);
+                                        if (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) {
+                                            decoderOutputAvailable = false;
+                                        } else if (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) {
+
+                                        } else if (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) {
+                                            MediaFormat newFormat = decoder.getOutputFormat();
+                                            FileLog.e("tmessages", "newFormat = " + newFormat);
+                                        } else if (decoderStatus < 0) {
+                                            throw new RuntimeException("unexpected result from decoder.dequeueOutputBuffer: " + decoderStatus);
+                                        } else {
+                                            boolean doRender = false;
+                                            if (Build.VERSION.SDK_INT >= 18) {
+                                                doRender = info.size != 0;
+                                            } else {
+                                                doRender = info.size != 0 || info.presentationTimeUs != 0;
+                                            }
+                                            if (endTime > 0 && info.presentationTimeUs >= endTime) {
+                                                inputDone = true;
+                                                decoderDone = true;
+                                                doRender = false;
+                                                info.flags |= MediaCodec.BUFFER_FLAG_END_OF_STREAM;
+                                            }
+                                            if (startTime > 0 && videoTime == -1) {
+                                                if (info.presentationTimeUs < startTime) {
+                                                    doRender = false;
+                                                    FileLog.e("tmessages", "drop frame startTime = " + startTime + " present time = " + info.presentationTimeUs);
+                                                } else {
+                                                    videoTime = info.presentationTimeUs;
+                                                }
+                                            }
+                                            decoder.releaseOutputBuffer(decoderStatus, doRender);
+                                            if (doRender) {
+                                                boolean errorWait = false;
+                                                try {
+                                                    outputSurface.awaitNewImage();
+                                                } catch (Exception e) {
+                                                    errorWait = true;
+                                                    FileLog.e("tmessages", e);
+                                                }
+                                                if (!errorWait) {
+                                                    if (Build.VERSION.SDK_INT >= 18) {
+                                                        outputSurface.drawImage(false);
+                                                        inputSurface.setPresentationTime(info.presentationTimeUs * 1000);
+                                                        inputSurface.swapBuffers();
+                                                    } else {
+                                                        int inputBufIndex = encoder.dequeueInputBuffer(TIMEOUT_USEC);
+                                                        if (inputBufIndex >= 0) {
+                                                            outputSurface.drawImage(true);
+                                                            ByteBuffer rgbBuf = outputSurface.getFrame();
+                                                            ByteBuffer yuvBuf = encoderInputBuffers[inputBufIndex];
+                                                            yuvBuf.clear();
+                                                            Utilities.convertVideoFrame(rgbBuf, yuvBuf, colorFormat, resultWidth, resultHeight, padding, swapUV);
+                                                            encoder.queueInputBuffer(inputBufIndex, 0, bufferSize, info.presentationTimeUs, 0);
+                                                        } else {
+                                                            FileLog.e("tmessages", "input buffer not available");
+                                                        }
+                                                    }
+                                                }
+                                            }
+                                            if ((info.flags & MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0) {
+                                                decoderOutputAvailable = false;
+                                                FileLog.e("tmessages", "decoder stream end");
+                                                if (Build.VERSION.SDK_INT >= 18) {
+                                                    encoder.signalEndOfInputStream();
+                                                } else {
+                                                    int inputBufIndex = encoder.dequeueInputBuffer(TIMEOUT_USEC);
+                                                    if (inputBufIndex >= 0) {
+                                                        encoder.queueInputBuffer(inputBufIndex, 0, 1, info.presentationTimeUs, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
+                                                    }
+                                                }
+                                            }
+                                        }
+                                    }
+                                }
+                            }
+                            if (videoTime != -1) {
+                                videoStartTime = videoTime;
+                            }
+                        } catch (Exception e) {
+                            FileLog.e("tmessages", e);
+                            error = true;
+                        }
+
+                        extractor.unselectTrack(videoIndex);
+
+                        if (outputSurface != null) {
+                            outputSurface.release();
+                            outputSurface = null;
+                        }
+                        if (inputSurface != null) {
+                            inputSurface.release();
+                            inputSurface = null;
+                        }
+                        if (decoder != null) {
+                            decoder.stop();
+                            decoder.release();
+                            decoder = null;
+                        }
+                        if (encoder != null) {
+                            encoder.stop();
+                            encoder.release();
+                            encoder = null;
+                        }
+
+                        checkConversionCanceled();
+                    }
+                } else {
+                    long videoTime = readAndWriteTrack(messageObject, extractor, mediaMuxer, info, startTime, endTime, cacheFile, false);
+                    if (videoTime != -1) {
+                        videoStartTime = videoTime;
+                    }
+                }
+                if (!error) {
+                    readAndWriteTrack(messageObject, extractor, mediaMuxer, info, videoStartTime, endTime, cacheFile, true);
+                }
+            } catch (Exception e) {
+                error = true;
+                FileLog.e("tmessages", e);
+            } finally {
+                if (extractor != null) {
+                    extractor.release();
+                    extractor = null;
+                }
+                if (mediaMuxer != null) {
+                    try {
+                        mediaMuxer.finishMovie(false);
+                    } catch (Exception e) {
+                        FileLog.e("tmessages", e);
+                    }
+                    mediaMuxer = null;
+                }
+                FileLog.e("tmessages", "time = " + (System.currentTimeMillis() - time));
+            }
+        } else {
+            return false;
+        }
+        didWriteData(messageObject, cacheFile, true, error);
+        return true;
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/MessageObject.java b/TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
index 64e0ca4a3..8e860eb13 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
@@ -437,7 +437,7 @@ public String getFileName() {
         } else if (messageOwner.media instanceof TLRPC.TL_messageMediaPhoto) {
             ArrayList<TLRPC.PhotoSize> sizes = messageOwner.media.photo.sizes;
             if (sizes.size() > 0) {
-                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, 800, 800);
+                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     return FileLoader.getAttachFileName(sizeFull);
                 }
@@ -643,4 +643,16 @@ public long getDialogId() {
             }
         }
     }
+
+    public boolean isSending() {
+        return messageOwner.send_state == MESSAGE_SEND_STATE_SENDING;
+    }
+
+    public boolean isSendError() {
+        return messageOwner.send_state == MESSAGE_SEND_STATE_SEND_ERROR;
+    }
+
+    public boolean isSent() {
+        return messageOwner.send_state == MESSAGE_SEND_STATE_SENT;
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/MessagesController.java b/TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
index 807d89099..1860c1d36 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
@@ -1645,37 +1645,6 @@ public int compare(TLRPC.TL_dialog tl_dialog, TLRPC.TL_dialog tl_dialog2) {
         });
     }
 
-    public TLRPC.TL_photo generatePhotoSizes(String path, Uri imageUri) {
-        long time = System.currentTimeMillis();
-        Bitmap bitmap = ImageLoader.loadBitmap(path, imageUri, 800, 800);
-        ArrayList<TLRPC.PhotoSize> sizes = new ArrayList<TLRPC.PhotoSize>();
-        TLRPC.PhotoSize size = ImageLoader.scaleAndSaveImage(bitmap, 90, 90, 55, true);
-        if (size != null) {
-            size.type = "s";
-            sizes.add(size);
-        }
-        size = ImageLoader.scaleAndSaveImage(bitmap, 800, 800, 80, false);
-        if (size != null) {
-            size.type = "x";
-            sizes.add(size);
-        }
-        if (bitmap != null) {
-            bitmap.recycle();
-        }
-        if (sizes.isEmpty()) {
-            return null;
-        } else {
-            UserConfig.saveConfig(false);
-            TLRPC.TL_photo photo = new TLRPC.TL_photo();
-            photo.user_id = UserConfig.getClientUserId();
-            photo.date = ConnectionsManager.getInstance().getCurrentTime();
-            photo.sizes = sizes;
-            photo.caption = "";
-            photo.geo = new TLRPC.TL_geoPointEmpty();
-            return photo;
-        }
-    }
-
     public void markDialogAsRead(final long dialog_id, final int max_id, final int max_positive_id, final int offset, final int max_date, final boolean was, final boolean popup) {
         int lower_part = (int)dialog_id;
         int high_id = (int)(dialog_id >> 32);
@@ -2450,7 +2419,7 @@ public void run() {
                                         public void run() {
                                             for (HashMap.Entry<Integer, Integer> entry : corrected.entrySet()) {
                                                 Integer oldId = entry.getKey();
-                                                SendMessagesHelper.getInstance().setMessageSent(oldId);
+                                                SendMessagesHelper.getInstance().processSentMessage(oldId);
                                                 Integer newId = entry.getValue();
                                                 NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageReceivedByServer, oldId, newId, null);
                                             }
@@ -3464,9 +3433,9 @@ protected void updateInterfaceWithMessages(final long uid, final ArrayList<Messa
             } else {
                 MessageObject currentDialogMessage = dialogMessage.get(dialog.top_message);
                 if (currentDialogMessage != null) {
-                    if (currentDialogMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING && lastMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    if (currentDialogMessage.isSending() && lastMessage.isSending()) {
                         change = true;
-                    } else if (dialog.last_message_date < lastMessage.messageOwner.date || dialog.last_message_date == lastMessage.messageOwner.date && lastMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    } else if (dialog.last_message_date < lastMessage.messageOwner.date || dialog.last_message_date == lastMessage.messageOwner.date && lastMessage.isSending()) {
                         change = true;
                     }
                 } else {
diff --git a/TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java b/TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
index 17e2008e7..07b0e37d2 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
@@ -2384,12 +2384,24 @@ public void run() {
         }
     }
 
-    public void removeFromDownloadQueue(final long id, final int type) {
+    public void removeFromDownloadQueue(final long id, final int type, final boolean move) {
         storageQueue.postRunnable(new Runnable() {
             @Override
             public void run() {
                 try {
-                    database.executeFast(String.format(Locale.US, "DELETE FROM download_queue WHERE uid = %d AND type = %d", id, type)).stepThis().dispose();
+                    if (move) {
+                        int minDate = -1;
+                        SQLiteCursor cursor = database.queryFinalized(String.format(Locale.US, "SELECT min(date) FROM download_queue WHERE type = %d", type));
+                        if (cursor.next()) {
+                            minDate = cursor.intValue(0);
+                        }
+                        cursor.dispose();
+                        if (minDate != -1) {
+                            database.executeFast(String.format(Locale.US, "UPDATE download_queue SET date = %d WHERE uid = %d AND type = %d", minDate - 1, id, type)).stepThis().dispose();
+                        }
+                    } else {
+                        database.executeFast(String.format(Locale.US, "DELETE FROM download_queue WHERE uid = %d AND type = %d", id, type)).stepThis().dispose();
+                    }
                 } catch (Exception e) {
                     FileLog.e("tmessages", e);
                 }
@@ -2588,7 +2600,7 @@ private void putMessagesInternal(final ArrayList<TLRPC.Message> messages, final
                             }
                         } else if (message.media instanceof TLRPC.TL_messageMediaPhoto) {
                             if ((downloadMask & MediaController.AUTODOWNLOAD_MASK_PHOTO) != 0) {
-                                TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.media.photo.sizes, 800, 800);
+                                TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.media.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                                 if (photoSize != null) {
                                     id = message.media.photo.id;
                                     type = MediaController.AUTODOWNLOAD_MASK_PHOTO;
diff --git a/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java b/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
index 26a3083b0..87298e130 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
@@ -39,6 +39,8 @@
     public static final int pushMessagesUpdated = 27;
     public static final int blockedUsersDidLoaded = 28;
     public static final int openedChatChanged = 29;
+    public static final int hideEmojiKeyboard = 30;
+    public static final int stopEncodingService = 31;
 
     public static final int wallpapersDidLoaded = 171;
     public static final int closeOtherAppActivities = 702;
@@ -52,6 +54,9 @@
     public static final int FileLoadProgressChanged = 10003;
     public static final int FileDidLoaded = 10004;
     public static final int FileDidFailedLoad = 10005;
+    public static final int FilePreparingStarted = 10006;
+    public static final int FileNewChunkAvailable = 10007;
+    public static final int FilePreparingFailed = 10008;
 
     public final static int audioProgressDidChanged = 50001;
     public final static int audioDidReset = 50002;
diff --git a/TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java b/TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
index 10e7c3b61..cc3327a4f 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
@@ -393,7 +393,8 @@ private void showOrUpdateNotification(boolean notifyAboutLast) {
             String lastMessageFull = null;
             if (pushMessages.size() == 1) {
                 String message = lastMessageFull = getStringForMessage(pushMessages.get(0), false);
-                lastMessage = getStringForMessage(pushMessages.get(0), true);
+                //lastMessage = getStringForMessage(pushMessages.get(0), true);
+                lastMessage = lastMessageFull;
                 if (message == null) {
                     return;
                 }
@@ -418,7 +419,8 @@ private void showOrUpdateNotification(boolean notifyAboutLast) {
                     }
                     if (i == 0) {
                         lastMessageFull = message;
-                        lastMessage = getStringForMessage(pushMessages.get(i), true);
+                        //lastMessage = getStringForMessage(pushMessages.get(i), true);
+                        lastMessage = lastMessageFull;
                     }
                     if (pushDialogs.size() == 1) {
                         if (replace) {
@@ -444,6 +446,9 @@ private void showOrUpdateNotification(boolean notifyAboutLast) {
 
             if (!notifyDisabled) {
                 if (ApplicationLoader.mainInterfacePaused || inAppPreview) {
+                    if (lastMessage.length() > 100) {
+                        lastMessage = lastMessage.substring(0, 100).replace("\n", " ").trim() + "...";
+                    }
                     mBuilder.setTicker(lastMessage);
                 }
                 if (choosenSoundPath != null && !choosenSoundPath.equals("NoSound")) {
diff --git a/TMessagesProj/src/main/java/org/telegram/android/SendMessagesHelper.java b/TMessagesProj/src/main/java/org/telegram/android/SendMessagesHelper.java
index a41b9e6e9..b65e69944 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/SendMessagesHelper.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/SendMessagesHelper.java
@@ -8,6 +8,9 @@
 
 package org.telegram.android;
 
+import android.graphics.Bitmap;
+import android.net.Uri;
+
 import org.telegram.messenger.BuffersStorage;
 import org.telegram.messenger.ByteBufferDesc;
 import org.telegram.messenger.ConnectionsManager;
@@ -60,7 +63,9 @@ public static SendMessagesHelper getInstance() {
     public SendMessagesHelper() {
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileDidUpload);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileDidFailUpload);
-
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.FilePreparingStarted);
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileNewChunkAvailable);
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.FilePreparingFailed);
     }
 
     public void cleanUp() {
@@ -72,10 +77,6 @@ public void setCurrentChatInfo(TLRPC.ChatParticipants info) {
         currentChatInfo = info;
     }
 
-    public void setMessageSent(Integer id) {
-
-    }
-
     @Override
     public void didReceivedNotification(int id, Object... args) {
         if (id == NotificationCenter.FileDidUpload) {
@@ -102,19 +103,27 @@ public void run() {
                                     media.file = file;
                                     performSendMessageRequest(message.sendRequest, message.obj, message.originalPath);
                                 } else if (message.type == 1) {
-                                    if (media.thumb == null) {
-                                        media.thumb = file;
-                                        performSendDelayedMessage(message);
-                                    } else {
+                                    if (media.file == null) {
                                         media.file = file;
+                                        if (media.thumb == null && message.location != null) {
+                                            performSendDelayedMessage(message);
+                                        } else {
+                                            performSendMessageRequest(message.sendRequest, message.obj, message.originalPath);
+                                        }
+                                    } else {
+                                        media.thumb = file;
                                         performSendMessageRequest(message.sendRequest, message.obj, message.originalPath);
                                     }
                                 } else if (message.type == 2) {
-                                    if (media.thumb == null && message.location != null) {
-                                        media.thumb = file;
-                                        performSendDelayedMessage(message);
-                                    } else {
+                                    if (media.file == null) {
                                         media.file = file;
+                                        if (media.thumb == null && message.location != null) {
+                                            performSendDelayedMessage(message);
+                                        } else {
+                                            performSendMessageRequest(message.sendRequest, message.obj, message.originalPath);
+                                        }
+                                    } else {
+                                        media.thumb = file;
                                         performSendMessageRequest(message.sendRequest, message.obj, message.originalPath);
                                     }
                                 } else if (message.type == 3) {
@@ -163,6 +172,74 @@ public void run() {
                     }
                 }
             });
+        } else if (id == NotificationCenter.FilePreparingStarted) {
+            MessageObject messageObject = (MessageObject)args[0];
+            String finalPath = (String)args[1];
+
+            ArrayList<DelayedMessage> arr = delayedMessages.get(messageObject.messageOwner.attachPath);
+            if (arr != null) {
+                for (int a = 0; a < arr.size(); a++) {
+                    DelayedMessage message = arr.get(a);
+                    if (message.obj == messageObject) {
+                        message.videoLocation.videoEditedInfo = null;
+                        performSendDelayedMessage(message);
+                        arr.remove(a);
+                        a--;
+                        break;
+                    }
+                }
+                if (arr.isEmpty()) {
+                    delayedMessages.remove(messageObject.messageOwner.attachPath);
+                }
+            }
+        } else if (id == NotificationCenter.FileNewChunkAvailable) {
+            MessageObject messageObject = (MessageObject)args[0];
+            String finalPath = (String)args[1];
+            long finalSize = (Long)args[2];
+            boolean isEncrypted = ((int)messageObject.getDialogId()) == 0;
+            FileLoader.getInstance().checkUploadNewDataAvailable(finalPath, isEncrypted, finalSize);
+            if (finalSize != 0) {
+                ArrayList<DelayedMessage> arr = delayedMessages.get(messageObject.messageOwner.attachPath);
+                if (arr != null) {
+                    for (DelayedMessage message : arr) {
+                        if (message.obj == messageObject) {
+                            message.obj.messageOwner.videoEditedInfo = null;
+                            message.obj.messageOwner.message = "-1";
+                            message.obj.messageOwner.media.video.size = (int)finalSize;
+
+                            ArrayList<TLRPC.Message> messages = new ArrayList<TLRPC.Message>();
+                            messages.add(message.obj.messageOwner);
+                            MessagesStorage.getInstance().putMessages(messages, false, true, false, 0);
+                            break;
+                        }
+                    }
+                    if (arr.isEmpty()) {
+                        delayedMessages.remove(messageObject.messageOwner.attachPath);
+                    }
+                }
+            }
+        } else if (id == NotificationCenter.FilePreparingFailed) {
+            MessageObject messageObject = (MessageObject)args[0];
+            String finalPath = (String)args[1];
+            stopVideoService(messageObject.messageOwner.attachPath);
+
+            ArrayList<DelayedMessage> arr = delayedMessages.get(finalPath);
+            if (arr != null) {
+                for (int a = 0; a < arr.size(); a++) {
+                    DelayedMessage message = arr.get(a);
+                    if (message.obj == messageObject) {
+                        MessagesStorage.getInstance().markMessageAsSendError(message.obj.messageOwner.id);
+                        message.obj.messageOwner.send_state = MessageObject.MESSAGE_SEND_STATE_SEND_ERROR;
+                        arr.remove(a);
+                        a--;
+                        NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageSendError, message.obj.messageOwner.id);
+                        processSentMessage(message.obj.messageOwner.id);
+                    }
+                }
+                if (arr.isEmpty()) {
+                    delayedMessages.remove(finalPath);
+                }
+            }
         }
     }
 
@@ -175,6 +252,7 @@ public void cancelSendingMessage(MessageObject object) {
                 DelayedMessage message = messages.get(a);
                 if (message.obj.messageOwner.id == object.messageOwner.id) {
                     messages.remove(a);
+                    MediaController.getInstance().cancelVideoConvert(message.obj);
                     if (messages.size() == 0) {
                         keyToRemvoe = entry.getKey();
                         if (message.sendEncryptedRequest != null) {
@@ -187,6 +265,7 @@ public void cancelSendingMessage(MessageObject object) {
         }
         if (keyToRemvoe != null) {
             FileLoader.getInstance().cancelUploadFile(keyToRemvoe, enc);
+            stopVideoService(keyToRemvoe);
         }
         ArrayList<Integer> messages = new ArrayList<Integer>();
         messages.add(object.messageOwner.id);
@@ -204,7 +283,7 @@ public boolean retrySendMessage(MessageObject messageObject, boolean unsent) {
         return true;
     }
 
-    private void processSentMessage(int id) {
+    public void processSentMessage(int id) {
         int prevSize = unsentMessages.size();
         unsentMessages.remove(id);
         if (prevSize != 0 && unsentMessages.size() == 0) {
@@ -220,14 +299,13 @@ public void processForwardFromMyName(MessageObject messageObject, long did) {
             if (messageObject.messageOwner.media.photo instanceof TLRPC.TL_photo) {
                 sendMessage((TLRPC.TL_photo) messageObject.messageOwner.media.photo, null, did);
             } else if (messageObject.messageOwner.media.audio instanceof TLRPC.TL_audio) {
-                messageObject.messageOwner.media.audio.path = messageObject.messageOwner.attachPath;
-                sendMessage((TLRPC.TL_audio) messageObject.messageOwner.media.audio, did);
+                sendMessage((TLRPC.TL_audio) messageObject.messageOwner.media.audio, messageObject.messageOwner.attachPath, did);
             } else if (messageObject.messageOwner.media.video instanceof TLRPC.TL_video) {
-                messageObject.messageOwner.media.video.path = messageObject.messageOwner.attachPath;
-                sendMessage((TLRPC.TL_video) messageObject.messageOwner.media.video, null, did);
+                TLRPC.TL_video video = (TLRPC.TL_video) messageObject.messageOwner.media.video;
+                video.videoEditedInfo = messageObject.messageOwner.videoEditedInfo;
+                sendMessage(video, null, messageObject.messageOwner.attachPath, did);
             } else if (messageObject.messageOwner.media.document instanceof TLRPC.TL_document) {
-                messageObject.messageOwner.media.document.path = messageObject.messageOwner.attachPath;
-                sendMessage((TLRPC.TL_document) messageObject.messageOwner.media.document, null, did);
+                sendMessage((TLRPC.TL_document) messageObject.messageOwner.media.document, null, messageObject.messageOwner.attachPath, did);
             } else if (messageObject.messageOwner.media.geo instanceof TLRPC.TL_geoPoint) {
                 sendMessage(messageObject.messageOwner.media.geo.lat, messageObject.messageOwner.media.geo._long, did);
             } else if (messageObject.messageOwner.media.phone_number != null) {
@@ -248,42 +326,42 @@ public void processForwardFromMyName(MessageObject messageObject, long did) {
     }
 
     public void sendMessage(TLRPC.User user, long peer) {
-        sendMessage(null, 0, 0, null, null, null, user, null, null, null, peer, false);
+        sendMessage(null, 0, 0, null, null, null, user, null, null, null, peer, false, null);
     }
 
     public void sendMessage(MessageObject message) {
-        sendMessage(null, 0, 0, null, null, message, null, null, null, null, message.getDialogId(), true);
+        sendMessage(null, 0, 0, null, null, message, null, null, null, null, message.getDialogId(), true, message.messageOwner.attachPath);
     }
 
     public void sendMessage(MessageObject message, long peer) {
-        sendMessage(null, 0, 0, null, null, message, null, null, null, null, peer, false);
+        sendMessage(null, 0, 0, null, null, message, null, null, null, null, peer, false, message.messageOwner.attachPath);
     }
 
-    public void sendMessage(TLRPC.TL_document document, String originalPath, long peer) {
-        sendMessage(null, 0, 0, null, null, null, null, document, null, originalPath, peer, false);
+    public void sendMessage(TLRPC.TL_document document, String originalPath, String path, long peer) {
+        sendMessage(null, 0, 0, null, null, null, null, document, null, originalPath, peer, false, path);
     }
 
     public void sendMessage(String message, long peer) {
-        sendMessage(message, 0, 0, null, null, null, null, null, null, null, peer, false);
+        sendMessage(message, 0, 0, null, null, null, null, null, null, null, peer, false, null);
     }
 
     public void sendMessage(double lat, double lon, long peer) {
-        sendMessage(null, lat, lon, null, null, null, null, null, null, null, peer, false);
+        sendMessage(null, lat, lon, null, null, null, null, null, null, null, peer, false, null);
     }
 
     public void sendMessage(TLRPC.TL_photo photo, String originalPath, long peer) {
-        sendMessage(null, 0, 0, photo, null, null, null, null, null, originalPath, peer, false);
+        sendMessage(null, 0, 0, photo, null, null, null, null, null, originalPath, peer, false, null);
     }
 
-    public void sendMessage(TLRPC.TL_video video, String originalPath, long peer) {
-        sendMessage(null, 0, 0, null, video, null, null, null, null, originalPath, peer, false);
+    public void sendMessage(TLRPC.TL_video video, String originalPath, String path, long peer) {
+        sendMessage(null, 0, 0, null, video, null, null, null, null, originalPath, peer, false, path);
     }
 
-    public void sendMessage(TLRPC.TL_audio audio, long peer) {
-        sendMessage(null, 0, 0, null, null, null, null, null, audio, null, peer, false);
+    public void sendMessage(TLRPC.TL_audio audio, String path, long peer) {
+        sendMessage(null, 0, 0, null, null, null, null, null, audio, null, peer, false, path);
     }
 
-    private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo photo, TLRPC.TL_video video, MessageObject msgObj, TLRPC.User user, TLRPC.TL_document document, TLRPC.TL_audio audio, String originalPath, long peer, boolean retry) {
+    private int sendMessage(String message, double lat, double lon, TLRPC.TL_photo photo, TLRPC.TL_video video, MessageObject msgObj, TLRPC.User user, TLRPC.TL_document document, TLRPC.TL_audio audio, String originalPath, long peer, boolean retry, String path) {
         TLRPC.Message newMsg = null;
         int type = -1;
         if (retry) {
@@ -313,7 +391,7 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                 } else {
                     type = 3;
                     video = (TLRPC.TL_video) newMsg.media.video;
-                    video.path = newMsg.attachPath;
+                    video.videoEditedInfo = newMsg.videoEditedInfo;
                 }
             } else if (msgObj.type == 12 || msgObj.type == 13) {
                 user = new TLRPC.TL_userRequest();
@@ -324,11 +402,9 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                 type = 6;
             } else if (msgObj.type == 8 || msgObj.type == 9) {
                 document = (TLRPC.TL_document) newMsg.media.document;
-                document.path = newMsg.attachPath;
                 type = 7;
             } else if (msgObj.type == 2) {
                 audio = (TLRPC.TL_audio) newMsg.media.audio;
-                audio.path = newMsg.attachPath;
                 type = 8;
             }
         } else {
@@ -357,9 +433,14 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                 newMsg = new TLRPC.TL_message();
                 newMsg.media = new TLRPC.TL_messageMediaVideo();
                 newMsg.media.video = video;
+                newMsg.videoEditedInfo = video.videoEditedInfo;
                 type = 3;
-                newMsg.message = "-1";
-                newMsg.attachPath = video.path;
+                if (video.videoEditedInfo == null) {
+                    newMsg.message = "-1";
+                } else {
+                    newMsg.message = video.videoEditedInfo.getString();
+                }
+                newMsg.attachPath = path;
             } else if (msgObj != null) {
                 newMsg = new TLRPC.TL_messageForwarded();
                 if (msgObj.messageOwner instanceof TLRPC.TL_messageForwarded) {
@@ -394,14 +475,14 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                 newMsg.media.document = document;
                 type = 7;
                 newMsg.message = "-1";
-                newMsg.attachPath = document.path;
+                newMsg.attachPath = path;
             } else if (audio != null) {
                 newMsg = new TLRPC.TL_message();
                 newMsg.media = new TLRPC.TL_messageMediaAudio();
                 newMsg.media.audio = audio;
                 type = 8;
                 newMsg.message = "-1";
-                newMsg.attachPath = audio.path;
+                newMsg.attachPath = path;
             }
             newMsg.local_id = newMsg.id = UserConfig.getNewMessageId();
             newMsg.from_id = UserConfig.getClientUserId();
@@ -423,7 +504,7 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
             if (high_id == 1) {
                 if (currentChatInfo == null) {
                     processSentMessage(newMsg.id);
-                    return;
+                    return 0;
                 }
                 sendToPeers = new ArrayList<TLRPC.InputUser>();
                 for (TLRPC.TL_chatParticipant participant : currentChatInfo.participants) {
@@ -448,7 +529,7 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                     TLRPC.User sendToUser = MessagesController.getInstance().getUser(lower_id);
                     if (sendToUser == null) {
                         processSentMessage(newMsg.id);
-                        return;
+                        return 0;
                     }
                     if (sendToUser instanceof TLRPC.TL_userForeign || sendToUser instanceof TLRPC.TL_userRequest) {
                         sendToPeer = new TLRPC.TL_inputPeerForeign();
@@ -534,7 +615,11 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
                         }
                     } else if (type == 3) {
                         if (video.access_hash == 0) {
-                            inputMedia = new TLRPC.TL_inputMediaUploadedThumbVideo();
+                            if (video.thumb.location != null) {
+                                inputMedia = new TLRPC.TL_inputMediaUploadedThumbVideo();
+                            } else {
+                                inputMedia = new TLRPC.TL_inputMediaUploadedVideo();
+                            }
                             inputMedia.duration = video.duration;
                             inputMedia.w = video.w;
                             inputMedia.h = video.h;
@@ -782,7 +867,9 @@ private void sendMessage(String message, double lat, double lon, TLRPC.TL_photo
             newMsgObj.messageOwner.send_state = MessageObject.MESSAGE_SEND_STATE_SEND_ERROR;
             NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageSendError, newMsgObj.messageOwner.id);
             processSentMessage(newMsgObj.messageOwner.id);
+            return 0;
         }
+        return newMsg != null ? newMsg.id : 0;
     }
 
     private void performSendDelayedMessage(final DelayedMessage message) {
@@ -795,63 +882,78 @@ private void performSendDelayedMessage(final DelayedMessage message) {
                 FileLoader.getInstance().uploadFile(location, true, true);
             }
         } else if (message.type == 1) {
-            if (message.sendRequest != null) {
-                TLRPC.InputMedia media = null;
-                if (message.sendRequest instanceof TLRPC.TL_messages_sendMedia) {
-                    media = ((TLRPC.TL_messages_sendMedia)message.sendRequest).media;
-                } else if (message.sendRequest instanceof TLRPC.TL_messages_sendBroadcast) {
-                    media = ((TLRPC.TL_messages_sendBroadcast)message.sendRequest).media;
+            if (message.videoLocation.videoEditedInfo != null) {
+                String location = message.obj.messageOwner.attachPath;
+                if (location == null) {
+                    location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.videoLocation.id + ".mp4";
                 }
-                if (media.thumb == null) {
-                    String location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.location.volume_id + "_" + message.location.local_id + ".jpg";
-                    putToDelayedMessages(location, message);
-                    FileLoader.getInstance().uploadFile(location, false, true);
+                putToDelayedMessages(location, message);
+                MediaController.getInstance().scheduleVideoConvert(message.obj);
+            } else {
+                if (message.sendRequest != null) {
+                    TLRPC.InputMedia media = null;
+                    if (message.sendRequest instanceof TLRPC.TL_messages_sendMedia) {
+                        media = ((TLRPC.TL_messages_sendMedia) message.sendRequest).media;
+                    } else if (message.sendRequest instanceof TLRPC.TL_messages_sendBroadcast) {
+                        media = ((TLRPC.TL_messages_sendBroadcast) message.sendRequest).media;
+                    }
+                    if (media.file == null) {
+                        String location = message.obj.messageOwner.attachPath;
+                        if (location == null) {
+                            location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.videoLocation.id + ".mp4";
+                        }
+                        putToDelayedMessages(location, message);
+                        if (message.obj.messageOwner.videoEditedInfo != null) {
+                            FileLoader.getInstance().uploadFile(location, false, false, message.videoLocation.size);
+                        } else {
+                            FileLoader.getInstance().uploadFile(location, false, false);
+                        }
+                    } else {
+                        String location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.location.volume_id + "_" + message.location.local_id + ".jpg";
+                        putToDelayedMessages(location, message);
+                        FileLoader.getInstance().uploadFile(location, false, true);
+                    }
                 } else {
-                    String location = message.videoLocation.path;
+                    String location = message.obj.messageOwner.attachPath;
                     if (location == null) {
                         location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.videoLocation.id + ".mp4";
                     }
                     putToDelayedMessages(location, message);
-                    if (message.videoLocation.estimatedSize) {
-                        FileLoader.getInstance().uploadFile(location, false, false, message.videoLocation.size);
+                    if (message.obj.messageOwner.videoEditedInfo != null) {
+                        FileLoader.getInstance().uploadFile(location, true, false, message.videoLocation.size);
                     } else {
-                        FileLoader.getInstance().uploadFile(location, false, false);
+                        FileLoader.getInstance().uploadFile(location, true, false);
                     }
                 }
-            } else {
-                String location = message.videoLocation.path;
-                if (location == null) {
-                    location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.videoLocation.id + ".mp4";
-                }
-                putToDelayedMessages(location, message);
-                if (message.videoLocation.estimatedSize) {
-                    FileLoader.getInstance().uploadFile(location, true, false, message.videoLocation.size);
-                } else {
-                    FileLoader.getInstance().uploadFile(location, true, false);
-                }
             }
         } else if (message.type == 2) {
             TLRPC.InputMedia media = null;
-            if (message.sendRequest instanceof TLRPC.TL_messages_sendMedia) {
-                media = ((TLRPC.TL_messages_sendMedia)message.sendRequest).media;
-            } else if (message.sendRequest instanceof TLRPC.TL_messages_sendBroadcast) {
-                media = ((TLRPC.TL_messages_sendBroadcast)message.sendRequest).media;
-            }
-            if (message.sendRequest != null && media.thumb == null && message.location != null) {
-                String location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.location.volume_id + "_" + message.location.local_id + ".jpg";
-                putToDelayedMessages(location, message);
-                FileLoader.getInstance().uploadFile(location, false, true);
+            if (message.sendRequest != null) {
+                if (message.sendRequest instanceof TLRPC.TL_messages_sendMedia) {
+                    media = ((TLRPC.TL_messages_sendMedia) message.sendRequest).media;
+                } else if (message.sendRequest instanceof TLRPC.TL_messages_sendBroadcast) {
+                    media = ((TLRPC.TL_messages_sendBroadcast) message.sendRequest).media;
+                }
+                if (media.file == null) {
+                    String location = message.obj.messageOwner.attachPath;
+                    putToDelayedMessages(location, message);
+                    if (message.sendRequest != null) {
+                        FileLoader.getInstance().uploadFile(location, false, false);
+                    } else {
+                        FileLoader.getInstance().uploadFile(location, true, false);
+                    }
+                } else if (media.thumb == null && message.location != null) {
+                    String location = FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE) + "/" + message.location.volume_id + "_" + message.location.local_id + ".jpg";
+                    putToDelayedMessages(location, message);
+                    FileLoader.getInstance().uploadFile(location, false, true);
+                }
             } else {
-                String location = message.documentLocation.path;
+                String location = message.obj.messageOwner.attachPath;
                 putToDelayedMessages(location, message);
-                if (message.sendRequest != null) {
-                    FileLoader.getInstance().uploadFile(location, false, false);
-                } else {
-                    FileLoader.getInstance().uploadFile(location, true, false);
-                }
+                FileLoader.getInstance().uploadFile(location, true, false);
             }
         } else if (message.type == 3) {
-            String location = message.audioLocation.path;
+            String location = message.obj.messageOwner.attachPath;
             putToDelayedMessages(location, message);
             if (message.sendRequest != null) {
                 FileLoader.getInstance().uploadFile(location, false, true);
@@ -861,6 +963,20 @@ private void performSendDelayedMessage(final DelayedMessage message) {
         }
     }
 
+    private void stopVideoService(final String path) {
+        MessagesStorage.getInstance().storageQueue.postRunnable(new Runnable() {
+            @Override
+            public void run() {
+                AndroidUtilities.RunOnUIThread(new Runnable() {
+                    @Override
+                    public void run() {
+                        NotificationCenter.getInstance().postNotificationName(NotificationCenter.stopEncodingService, path);
+                    }
+                });
+            }
+        });
+    }
+
     private void performSendMessageRequest(final TLObject req, final MessageObject newMsgObj, final String originalPath) {
         ConnectionsManager.getInstance().performRpc(req, new RPCRequest.RPCRequestDelegate() {
             @Override
@@ -869,6 +985,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                     final int oldId = newMsgObj.messageOwner.id;
                     final boolean isBroadcast = req instanceof TLRPC.TL_messages_sendBroadcast;
                     final ArrayList<TLRPC.Message> sentMessages = new ArrayList<TLRPC.Message>();
+                    final String attachPath = newMsgObj.messageOwner.attachPath;
 
                     if (response instanceof TLRPC.messages_SentMessage) {
                         TLRPC.messages_SentMessage res = (TLRPC.messages_SentMessage) response;
@@ -921,6 +1038,9 @@ public void run() {
                                     processSentMessage(oldId);
                                 }
                             });
+                            if (newMsgObj.messageOwner.media instanceof TLRPC.TL_messageMediaVideo) {
+                                stopVideoService(attachPath);
+                            }
                         }
                     });
                 } else {
@@ -931,6 +1051,9 @@ public void run() {
                             newMsgObj.messageOwner.send_state = MessageObject.MESSAGE_SEND_STATE_SEND_ERROR;
                             NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageSendError, newMsgObj.messageOwner.id);
                             processSentMessage(newMsgObj.messageOwner.id);
+                            if (newMsgObj.messageOwner.media instanceof TLRPC.TL_messageMediaVideo) {
+                                stopVideoService(newMsgObj.messageOwner.attachPath);
+                            }
                         }
                     });
                 }
@@ -1012,6 +1135,7 @@ private void performSendEncryptedRequest(final TLRPC.DecryptedMessage req, final
             public void run(TLObject response, TLRPC.TL_error error) {
                 if (newMsgObj != null) {
                     if (error == null) {
+                        final String attachPath = newMsgObj.messageOwner.attachPath;
                         final TLRPC.messages_SentEncryptedMessage res = (TLRPC.messages_SentEncryptedMessage) response;
                         newMsgObj.messageOwner.date = res.date;
                         if (res.file instanceof TLRPC.TL_encryptedFile) {
@@ -1027,6 +1151,9 @@ public void run() {
                                         newMsgObj.messageOwner.send_state = MessageObject.MESSAGE_SEND_STATE_SENT;
                                         NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageReceivedByServer, newMsgObj.messageOwner.id, newMsgObj.messageOwner.id, newMsgObj);
                                         processSentMessage(newMsgObj.messageOwner.id);
+                                        if (newMsgObj.messageOwner.media instanceof TLRPC.TL_messageMediaVideo) {
+                                            stopVideoService(attachPath);
+                                        }
                                     }
                                 });
                             }
@@ -1039,6 +1166,9 @@ public void run() {
                                 newMsgObj.messageOwner.send_state = MessageObject.MESSAGE_SEND_STATE_SEND_ERROR;
                                 NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageSendError, newMsgObj.messageOwner.id);
                                 processSentMessage(newMsgObj.messageOwner.id);
+                                if (newMsgObj.messageOwner.media instanceof TLRPC.TL_messageMediaVideo) {
+                                    stopVideoService(newMsgObj.messageOwner.attachPath);
+                                }
                             }
                         });
                     }
@@ -1097,11 +1227,21 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                         size2.location = size.location;
                     }
                 }
+
                 sentMessage.message = newMsg.message;
-                sentMessage.attachPath = newMsg.attachPath;
                 newMsg.media.video.dc_id = sentMessage.media.video.dc_id;
                 newMsg.media.video.id = sentMessage.media.video.id;
                 newMsg.media.video.access_hash = sentMessage.media.video.access_hash;
+
+                if (newMsg.attachPath != null && newMsg.attachPath.startsWith(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE).getAbsolutePath())) {
+                    File cacheFile = new File(newMsg.attachPath);
+                    File cacheFile2 = FileLoader.getPathToAttach(newMsg.media.video);
+                    if (!cacheFile.renameTo(cacheFile2)) {
+                        sentMessage.attachPath = newMsg.attachPath;
+                    }
+                } else {
+                    sentMessage.attachPath = newMsg.attachPath;
+                }
             } else if (sentMessage.media instanceof TLRPC.TL_messageMediaDocument && sentMessage.media.document != null && newMsg.media instanceof TLRPC.TL_messageMediaDocument && newMsg.media.document != null) {
                 MessagesStorage.getInstance().putSentFile(originalPath, sentMessage.media.document, 1);
 
@@ -1118,37 +1258,39 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                         size2.location = size.location;
                     }
                 }
+
+                newMsg.media.document.dc_id = sentMessage.media.document.dc_id;
+                newMsg.media.document.id = sentMessage.media.document.id;
+                newMsg.media.document.access_hash = sentMessage.media.document.access_hash;
+
                 if (newMsg.attachPath != null && newMsg.attachPath.startsWith(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE).getAbsolutePath())) {
                     File cacheFile = new File(newMsg.attachPath);
                     File cacheFile2 = FileLoader.getPathToAttach(sentMessage.media.document);
-                    boolean result = cacheFile.renameTo(cacheFile2);
-                    if (result) {
-                        newMsg.attachPath = null;
-                    } else {
+                    if (!cacheFile.renameTo(cacheFile2)) {
                         sentMessage.attachPath = newMsg.attachPath;
                         sentMessage.message = newMsg.message;
+                    } else {
+                        newMsg.attachPath = "";
                     }
                 } else {
                     sentMessage.attachPath = newMsg.attachPath;
                     sentMessage.message = newMsg.message;
                 }
-                newMsg.media.document.dc_id = sentMessage.media.document.dc_id;
-                newMsg.media.document.id = sentMessage.media.document.id;
-                newMsg.media.document.access_hash = sentMessage.media.document.access_hash;
             } else if (sentMessage.media instanceof TLRPC.TL_messageMediaAudio && sentMessage.media.audio != null && newMsg.media instanceof TLRPC.TL_messageMediaAudio && newMsg.media.audio != null) {
                 sentMessage.message = newMsg.message;
-                sentMessage.attachPath = newMsg.attachPath;
 
                 String fileName = newMsg.media.audio.dc_id + "_" + newMsg.media.audio.id + ".ogg";
+                newMsg.media.audio.dc_id = sentMessage.media.audio.dc_id;
+                newMsg.media.audio.id = sentMessage.media.audio.id;
+                newMsg.media.audio.access_hash = sentMessage.media.audio.access_hash;
                 String fileName2 = sentMessage.media.audio.dc_id + "_" + sentMessage.media.audio.id + ".ogg";
                 if (!fileName.equals(fileName2)) {
                     File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
                     File cacheFile2 = FileLoader.getPathToAttach(sentMessage.media.audio);
-                    cacheFile.renameTo(cacheFile2);
+                    if (!cacheFile.renameTo(cacheFile2)) {
+                        sentMessage.attachPath = newMsg.attachPath;
+                    }
                 }
-                newMsg.media.audio.dc_id = sentMessage.media.audio.dc_id;
-                newMsg.media.audio.id = sentMessage.media.audio.id;
-                newMsg.media.audio.access_hash = sentMessage.media.audio.access_hash;
             }
         } else if (file != null) {
             if (newMsg.media instanceof TLRPC.TL_messageMediaPhoto && newMsg.media.photo != null) {
@@ -1164,7 +1306,7 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                 String fileName2 = size.location.volume_id + "_" + size.location.local_id;
                 File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName + ".jpg");
                 File cacheFile2 = FileLoader.getPathToAttach(size);
-                boolean result = cacheFile.renameTo(cacheFile2);
+                cacheFile.renameTo(cacheFile2);
                 ImageLoader.getInstance().replaceImageInCache(fileName, fileName2);
                 ArrayList<TLRPC.Message> arr = new ArrayList<TLRPC.Message>();
                 arr.add(newMsg);
@@ -1187,8 +1329,16 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                 newMsg.media.video.access_hash = file.access_hash;
                 newMsg.media.video.key = decryptedMessage.media.key;
                 newMsg.media.video.iv = decryptedMessage.media.iv;
-                newMsg.media.video.path = video.path;
                 newMsg.media.video.mime_type = video.mime_type;
+
+                if (newMsg.attachPath != null && newMsg.attachPath.startsWith(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE).getAbsolutePath())) {
+                    File cacheFile = new File(newMsg.attachPath);
+                    File cacheFile2 = FileLoader.getPathToAttach(newMsg.media.video);
+                    if (cacheFile.renameTo(cacheFile2)) {
+                        newMsg.attachPath = "";
+                    }
+                }
+
                 ArrayList<TLRPC.Message> arr = new ArrayList<TLRPC.Message>();
                 arr.add(newMsg);
                 MessagesStorage.getInstance().putMessages(arr, false, true, false, 0);
@@ -1206,14 +1356,15 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                 newMsg.media.document.size = file.size;
                 newMsg.media.document.key = decryptedMessage.media.key;
                 newMsg.media.document.iv = decryptedMessage.media.iv;
-                newMsg.media.document.path = document.path;
                 newMsg.media.document.thumb = document.thumb;
                 newMsg.media.document.dc_id = file.dc_id;
 
-                if (document.path != null && document.path.startsWith(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE).getAbsolutePath())) {
-                    File cacheFile = new File(document.path);
+                if (newMsg.attachPath != null && newMsg.attachPath.startsWith(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE).getAbsolutePath())) {
+                    File cacheFile = new File(newMsg.attachPath);
                     File cacheFile2 = FileLoader.getPathToAttach(newMsg.media.document);
-                    cacheFile.renameTo(cacheFile2);
+                    if (cacheFile.renameTo(cacheFile2)) {
+                        newMsg.attachPath = "";
+                    }
                 }
 
                 ArrayList<TLRPC.Message> arr = new ArrayList<TLRPC.Message>();
@@ -1233,7 +1384,6 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                 newMsg.media.audio.dc_id = file.dc_id;
                 newMsg.media.audio.key = decryptedMessage.media.key;
                 newMsg.media.audio.iv = decryptedMessage.media.iv;
-                newMsg.media.audio.path = audio.path;
                 newMsg.media.audio.mime_type = audio.mime_type;
 
                 String fileName = audio.dc_id + "_" + audio.id + ".ogg";
@@ -1241,7 +1391,9 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                 if (!fileName.equals(fileName2)) {
                     File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
                     File cacheFile2 = FileLoader.getPathToAttach(newMsg.media.audio);
-                    cacheFile.renameTo(cacheFile2);
+                    if (cacheFile.renameTo(cacheFile2)) {
+                        newMsg.attachPath = "";
+                    }
                 }
 
                 ArrayList<TLRPC.Message> arr = new ArrayList<TLRPC.Message>();
@@ -1399,4 +1551,39 @@ public void run() {
             }
         });
     }
+
+    public TLRPC.TL_photo generatePhotoSizes(String path, Uri imageUri) {
+        long time = System.currentTimeMillis();
+        Bitmap bitmap = ImageLoader.loadBitmap(path, imageUri, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+        ArrayList<TLRPC.PhotoSize> sizes = new ArrayList<TLRPC.PhotoSize>();
+        TLRPC.PhotoSize size = ImageLoader.scaleAndSaveImage(bitmap, 90, 90, 55, true);
+        if (size != null) {
+            size.type = "s";
+            sizes.add(size);
+        }
+        size = ImageLoader.scaleAndSaveImage(bitmap, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize(), 80, false);
+        if (size != null) {
+            if (AndroidUtilities.getPhotoSize() == 800) {
+                size.type = "x";
+            } else {
+                size.type = "y";
+            }
+            sizes.add(size);
+        }
+        if (bitmap != null) {
+            bitmap.recycle();
+        }
+        if (sizes.isEmpty()) {
+            return null;
+        } else {
+            UserConfig.saveConfig(false);
+            TLRPC.TL_photo photo = new TLRPC.TL_photo();
+            photo.user_id = UserConfig.getClientUserId();
+            photo.date = ConnectionsManager.getInstance().getCurrentTime();
+            photo.sizes = sizes;
+            photo.caption = "";
+            photo.geo = new TLRPC.TL_geoPointEmpty();
+            return photo;
+        }
+    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/android/VideoEncodingService.java b/TMessagesProj/src/main/java/org/telegram/android/VideoEncodingService.java
new file mode 100644
index 000000000..173570535
--- /dev/null
+++ b/TMessagesProj/src/main/java/org/telegram/android/VideoEncodingService.java
@@ -0,0 +1,84 @@
+/*
+ * This is the source code of Telegram for Android v. 1.7.x.
+ * It is licensed under GNU GPL v. 2 or later.
+ * You should have received a copy of the license in this archive (see LICENSE).
+ *
+ * Copyright Nikolai Kudashov, 2013-2014.
+ */
+
+package org.telegram.android;
+
+import android.app.Service;
+import android.content.Intent;
+import android.os.IBinder;
+import android.support.v4.app.NotificationCompat;
+import android.support.v4.app.NotificationManagerCompat;
+
+import org.telegram.messenger.FileLog;
+import org.telegram.messenger.R;
+import org.telegram.ui.ApplicationLoader;
+
+public class VideoEncodingService extends Service implements NotificationCenter.NotificationCenterDelegate {
+
+    private NotificationCompat.Builder builder = null;
+    private String path = null;
+    private int currentProgress = 0;
+
+    public VideoEncodingService() {
+        super();
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileUploadProgressChanged);
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.stopEncodingService);
+    }
+
+    public IBinder onBind(Intent arg2) {
+        return null;
+    }
+
+    public void onDestroy() {
+        stopForeground(true);
+        NotificationCenter.getInstance().removeObserver(this, NotificationCenter.FileUploadProgressChanged);
+        NotificationCenter.getInstance().removeObserver(this, NotificationCenter.stopEncodingService);
+        FileLog.e("tmessages", "destroy video service");
+    }
+
+    @Override
+    public void didReceivedNotification(int id, Object... args) {
+        if (id == NotificationCenter.FileUploadProgressChanged) {
+            String fileName = (String)args[0];
+            if (path.equals(fileName)) {
+                Float progress = (Float) args[1];
+                Boolean enc = (Boolean) args[2];
+                currentProgress = (int)(progress * 100);
+                builder.setProgress(100, currentProgress, currentProgress == 0);
+                NotificationManagerCompat.from(ApplicationLoader.applicationContext).notify(4, builder.build());
+            }
+        } else if (id == NotificationCenter.stopEncodingService) {
+            String filepath = (String)args[0];
+            if (filepath == null || filepath.equals(path)) {
+                stopSelf();
+            }
+        }
+    }
+
+    public int onStartCommand(Intent intent, int flags, int startId) {
+        path = intent.getStringExtra("path");
+        if (path == null) {
+            stopSelf();
+            return Service.START_NOT_STICKY;
+        }
+        FileLog.e("tmessages", "start video service");
+        if (builder == null) {
+            builder = new NotificationCompat.Builder(ApplicationLoader.applicationContext);
+            builder.setSmallIcon(android.R.drawable.stat_sys_upload);
+            builder.setWhen(System.currentTimeMillis());
+            builder.setContentTitle(LocaleController.getString("AppName", R.string.AppName));
+            builder.setTicker(LocaleController.getString("SendingVideo", R.string.SendingVideo));
+            builder.setContentText(LocaleController.getString("SendingVideo", R.string.SendingVideo));
+        }
+        currentProgress = 0;
+        builder.setProgress(100, currentProgress, currentProgress == 0);
+        startForeground(4, builder.build());
+        NotificationManagerCompat.from(ApplicationLoader.applicationContext).notify(4, builder.build());
+        return Service.START_NOT_STICKY;
+    }
+}
diff --git a/TMessagesProj/src/main/java/org/telegram/android/video/OutputSurface.java b/TMessagesProj/src/main/java/org/telegram/android/video/OutputSurface.java
index d01b7225a..c3e2d5fde 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/video/OutputSurface.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/video/OutputSurface.java
@@ -46,14 +46,16 @@
     private TextureRenderer mTextureRender;
     private int mWidth;
     private int mHeight;
+    private int rotateRender = 0;
     private ByteBuffer mPixelBuf;
 
-    public OutputSurface(int width, int height) {
+    public OutputSurface(int width, int height, int rotate) {
         if (width <= 0 || height <= 0) {
             throw new IllegalArgumentException();
         }
         mWidth = width;
         mHeight = height;
+        rotateRender = rotate;
         mPixelBuf = ByteBuffer.allocateDirect(mWidth * mHeight * 4);
         mPixelBuf.order(ByteOrder.LITTLE_ENDIAN);
         eglSetup(width, height);
@@ -66,7 +68,7 @@ public OutputSurface() {
     }
 
     private void setup() {
-        mTextureRender = new TextureRenderer();
+        mTextureRender = new TextureRenderer(rotateRender);
         mTextureRender.surfaceCreated();
         mSurfaceTexture = new SurfaceTexture(mTextureRender.getTextureId());
         mSurfaceTexture.setOnFrameAvailableListener(this);
diff --git a/TMessagesProj/src/main/java/org/telegram/android/video/TextureRenderer.java b/TMessagesProj/src/main/java/org/telegram/android/video/TextureRenderer.java
index 550ced58c..9b29f40c1 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/video/TextureRenderer.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/video/TextureRenderer.java
@@ -69,8 +69,10 @@
     private int muSTMatrixHandle;
     private int maPositionHandle;
     private int maTextureHandle;
+    private int rotationAngle = 0;
 
-    public TextureRenderer() {
+    public TextureRenderer(int rotation) {
+        rotationAngle = rotation;
         mTriangleVertices = ByteBuffer.allocateDirect(mTriangleVerticesData.length * FLOAT_SIZE_BYTES).order(ByteOrder.nativeOrder()).asFloatBuffer();
         mTriangleVertices.put(mTriangleVerticesData).position(0);
         Matrix.setIdentityM(mSTMatrix, 0);
@@ -147,6 +149,9 @@ public void surfaceCreated() {
         checkGlError("glTexParameter");
 
         Matrix.setIdentityM(mMVPMatrix, 0);
+        if (rotationAngle != 0) {
+            Matrix.rotateM(mMVPMatrix, 0, rotationAngle, 0, 0, 1);
+        }
     }
 
     public void changeFragmentShader(String fragmentShader) {
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java b/TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
index e87e5d089..375934581 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
@@ -1116,6 +1116,30 @@ private void processRequestQueue(int requestClass, int _datacenterId) {
                 }
 
                 request.retryCount++;
+
+                if ((request.flags & RPCRequest.RPCRequestClassDownloadMedia) != 0) {
+                    int retryMax = 10;
+                    if ((request.flags & RPCRequest.RPCRequestClassForceDownload) == 0) {
+                        if (request.wait) {
+                            retryMax = 1;
+                        } else {
+                            retryMax = 3;
+                        }
+                    }
+                    if (request.retryCount >= retryMax) {
+                        FileLog.e("tmessages", "timed out " + request.rawRequest);
+                        TLRPC.TL_error error = new TLRPC.TL_error();
+                        error.code = -123;
+                        error.text = "RETRY_LIMIT";
+                        if (request.completionBlock != null) {
+                            request.completionBlock.run(null, error);
+                        }
+                        runningRequests.remove(i);
+                        i--;
+                        continue;
+                    }
+                }
+
                 NetworkMessage networkMessage = new NetworkMessage();
                 networkMessage.protoMessage = new TLRPC.TL_protoMessage();
 
@@ -2081,6 +2105,7 @@ void processMessage(TLObject message, long messageId, int messageSeqNo, long mes
                                         waitTime = Math.min(30, waitTime);
 
                                         discardResponse = true;
+                                        request.wait = true;
                                         request.runningMinStartTime = (int)(System.currentTimeMillis() / 1000 + waitTime);
                                         request.confirmed = false;
                                     }
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java b/TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java
index 583466a0a..364e21be2 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java
@@ -52,10 +52,11 @@
     private RandomAccessFile fiv;
     private File storePath = null;
     private File tempPath = null;
+    private boolean isForceRequest = false;
 
     public static interface FileLoadOperationDelegate {
         public abstract void didFinishLoadingFile(FileLoadOperation operation, File finalFile, File tempFile);
-        public abstract void didFailedLoadingFile(FileLoadOperation operation, boolean canceled);
+        public abstract void didFailedLoadingFile(FileLoadOperation operation, int state);
         public abstract void didChangedLoadProgress(FileLoadOperation operation, float progress);
     }
 
@@ -146,6 +147,14 @@ public FileLoadOperation(TLRPC.Document documentLocation) {
         }
     }
 
+    public void setForceRequest(boolean forceRequest) {
+        isForceRequest = forceRequest;
+    }
+
+    public boolean isForceRequest() {
+        return isForceRequest;
+    }
+
     public void setPaths(File store, File temp) {
         storePath = store;
         tempPath = temp;
@@ -160,7 +169,7 @@ public void start() {
             Utilities.stageQueue.postRunnable(new Runnable() {
                 @Override
                 public void run() {
-                    delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                    delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                 }
             });
             return;
@@ -180,7 +189,7 @@ public void run() {
                 Utilities.stageQueue.postRunnable(new Runnable() {
                     @Override
                     public void run() {
-                        delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                        delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                     }
                 });
                 return;
@@ -234,7 +243,7 @@ public void run() {
                 Utilities.stageQueue.postRunnable(new Runnable() {
                     @Override
                     public void run() {
-                        delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                        delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                     }
                 });
                 return;
@@ -246,7 +255,7 @@ public void run() {
                         try {
                             onFinishLoadingFile();
                         } catch (Exception e) {
-                            delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                            delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                         }
                     } else {
                         startDownloadRequest();
@@ -257,7 +266,7 @@ public void run() {
             try {
                 onFinishLoadingFile();
             } catch (Exception e) {
-                delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
             }
         }
     }
@@ -276,7 +285,7 @@ public void run() {
                         ConnectionsManager.getInstance().cancelRpc(requestInfo.requestToken, true, true);
                     }
                 }
-                delegate.didFailedLoadingFile(FileLoadOperation.this, true);
+                delegate.didFailedLoadingFile(FileLoadOperation.this, 1);
             }
         });
     }
@@ -374,7 +383,7 @@ private void processRequestResult(RequestInfo requestInfo, TLRPC.TL_error error)
                 }
             } catch (Exception e) {
                 cleanup();
-                delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                 FileLog.e("tmessages", e);
             }
         } else {
@@ -390,7 +399,7 @@ private void processRequestResult(RequestInfo requestInfo, TLRPC.TL_error error)
                 }
                 if (val == null) {
                     cleanup();
-                    delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                    delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                 } else {
                     datacenter_id = val;
                     nextDownloadOffset = 0;
@@ -403,18 +412,21 @@ private void processRequestResult(RequestInfo requestInfo, TLRPC.TL_error error)
                     } catch (Exception e) {
                         FileLog.e("tmessages", e);
                         cleanup();
-                        delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                        delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                     }
                 } else {
                     cleanup();
-                    delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                    delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
                 }
+            } else if (error.text.contains("RETRY_LIMIT")) {
+                cleanup();
+                delegate.didFailedLoadingFile(FileLoadOperation.this, 2);
             } else {
                 if (location != null) {
                     FileLog.e("tmessages", "" + location + " id = " + location.id + " access_hash = " + location.access_hash + " volume_id = " + location.local_id + " secret = " + location.secret);
                 }
                 cleanup();
-                delegate.didFailedLoadingFile(FileLoadOperation.this, false);
+                delegate.didFailedLoadingFile(FileLoadOperation.this, 0);
             }
         }
     }
@@ -448,7 +460,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                     requestInfo.response = (TLRPC.TL_upload_file) response;
                     processRequestResult(requestInfo, error);
                 }
-            }, null, true, RPCRequest.RPCRequestClassDownloadMedia, datacenter_id, isLast);
+            }, null, true, RPCRequest.RPCRequestClassDownloadMedia | (isForceRequest ? RPCRequest.RPCRequestClassForceDownload : 0), datacenter_id, isLast);
         }
     }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java b/TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
index cb9880140..615fbc8d8 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
@@ -8,6 +8,8 @@
 
 package org.telegram.messenger;
 
+import org.telegram.android.AndroidUtilities;
+
 import java.io.File;
 import java.util.ArrayList;
 import java.util.HashMap;
@@ -22,7 +24,7 @@
         public abstract void fileDidUploaded(String location, TLRPC.InputFile inputFile, TLRPC.InputEncryptedFile inputEncryptedFile);
         public abstract void fileDidFailedUpload(String location, boolean isEncrypted);
         public abstract void fileDidLoaded(String location, File finalFile, File tempFile);
-        public abstract void fileDidFailedLoad(String location, boolean canceled);
+        public abstract void fileDidFailedLoad(String location, int state);
         public abstract void fileLoadProgressChanged(String location, float progress);
     }
 
@@ -75,7 +77,14 @@ public void setMediaDirs(HashMap<Integer, File> dirs) {
     public File getDirectory(int type) {
         File dir = mediaDirs.get(type);
         if (dir == null && type != MEDIA_DIR_CACHE) {
-            return mediaDirs.get(MEDIA_DIR_CACHE);
+            dir = mediaDirs.get(MEDIA_DIR_CACHE);
+        }
+        try {
+            if (!dir.isDirectory()) {
+                dir.mkdirs();
+            }
+        } catch (Exception e) {
+            //don't promt
         }
         return dir;
     }
@@ -342,16 +351,16 @@ public void run() {
         return result[0];
     }
 
-    public void loadFile(TLRPC.Video video) {
-        loadFile(video, null, null, null, 0, false, video != null && video.key != null);
+    public void loadFile(TLRPC.Video video, boolean force) {
+        loadFile(video, null, null, null, 0, force, video != null && video.key != null);
     }
 
     public void loadFile(TLRPC.PhotoSize photo, boolean cacheOnly) {
         loadFile(null, null, null, photo.location, photo.size, false, cacheOnly || (photo != null && photo.size == 0 || photo.location.key != null));
     }
 
-    public void loadFile(TLRPC.Document document) {
-        loadFile(null, document, null, null, 0, false, document != null && document.key != null);
+    public void loadFile(TLRPC.Document document, boolean force) {
+        loadFile(null, document, null, null, 0, force, document != null && document.key != null);
     }
 
     public void loadFile(TLRPC.Audio audio, boolean force) {
@@ -397,6 +406,7 @@ public void run() {
                             if (index != -1) {
                                 downloadQueue.remove(index);
                                 downloadQueue.add(0, operation);
+                                operation.setForceRequest(true);
                             }
                         }
                     }
@@ -437,80 +447,12 @@ public void didFinishLoadingFile(FileLoadOperation operation, File finalFile, Fi
                         if (delegate != null) {
                             delegate.fileDidLoaded(arg1, finalFile, tempFile);
                         }
-                        fileLoaderQueue.postRunnable(new Runnable() {
-                            @Override
-                            public void run() {
-                                loadOperationPaths.remove(arg1);
-                                if (audio != null) {
-                                    currentAudioLoadOperationsCount--;
-                                    if (currentAudioLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = audioLoadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentAudioLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                } else if (location != null) {
-                                    currentPhotoLoadOperationsCount--;
-                                    if (currentPhotoLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = photoLoadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentPhotoLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                } else {
-                                    currentLoadOperationsCount--;
-                                    if (currentLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = loadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                }
-                            }
-                        });
-                        fileProgresses.remove(arg1);
+                        checkDownloadQueue(audio, location, arg1);
                     }
 
                     @Override
-                    public void didFailedLoadingFile(FileLoadOperation operation, boolean canceled) {
-                        fileLoaderQueue.postRunnable(new Runnable() {
-                            @Override
-                            public void run() {
-                                loadOperationPaths.remove(arg1);
-                                if (audio != null) {
-                                    currentAudioLoadOperationsCount--;
-                                    if (currentAudioLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = audioLoadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentAudioLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                } else if (location != null) {
-                                    currentPhotoLoadOperationsCount--;
-                                    if (currentPhotoLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = photoLoadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentPhotoLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                } else {
-                                    currentLoadOperationsCount--;
-                                    if (currentLoadOperationsCount < 2) {
-                                        FileLoadOperation operation = loadOperationQueue.poll();
-                                        if (operation != null) {
-                                            currentLoadOperationsCount++;
-                                            operation.start();
-                                        }
-                                    }
-                                }
-                            }
-                        });
-                        fileProgresses.remove(arg1);
+                    public void didFailedLoadingFile(FileLoadOperation operation, int canceled) {
+                        checkDownloadQueue(audio, location, arg1);
                         if (delegate != null) {
                             delegate.fileDidFailedLoad(arg1, canceled);
                         }
@@ -524,8 +466,9 @@ public void didChangedLoadProgress(FileLoadOperation operation, float progress)
                         }
                     }
                 });
+                int maxCount = force ? 3 : 1;
                 if (audio != null) {
-                    if (currentAudioLoadOperationsCount < 2) {
+                    if (currentAudioLoadOperationsCount < maxCount) {
                         currentAudioLoadOperationsCount++;
                         operation.start();
                     } else {
@@ -536,7 +479,7 @@ public void didChangedLoadProgress(FileLoadOperation operation, float progress)
                         }
                     }
                 } else if (location != null) {
-                    if (currentPhotoLoadOperationsCount < 2) {
+                    if (currentPhotoLoadOperationsCount < maxCount) {
                         currentPhotoLoadOperationsCount++;
                         operation.start();
                     } else {
@@ -547,7 +490,7 @@ public void didChangedLoadProgress(FileLoadOperation operation, float progress)
                         }
                     }
                 } else {
-                    if (currentLoadOperationsCount < 2) {
+                    if (currentLoadOperationsCount < maxCount) {
                         currentLoadOperationsCount++;
                         operation.start();
                     } else {
@@ -562,6 +505,57 @@ public void didChangedLoadProgress(FileLoadOperation operation, float progress)
         });
     }
 
+    private void checkDownloadQueue(final TLRPC.Audio audio, final TLRPC.FileLocation location, final String arg1) {
+        fileLoaderQueue.postRunnable(new Runnable() {
+            @Override
+            public void run() {
+                loadOperationPaths.remove(arg1);
+                FileLoadOperation operation = null;
+                if (audio != null) {
+                    currentAudioLoadOperationsCount--;
+                    if (!audioLoadOperationQueue.isEmpty()) {
+                        operation = audioLoadOperationQueue.get(0);
+                        int maxCount = operation.isForceRequest() ? 3 : 1;
+                        if (currentAudioLoadOperationsCount < maxCount) {
+                            operation = audioLoadOperationQueue.poll();
+                            if (operation != null) {
+                                currentAudioLoadOperationsCount++;
+                                operation.start();
+                            }
+                        }
+                    }
+                } else if (location != null) {
+                    currentPhotoLoadOperationsCount--;
+                    if (!photoLoadOperationQueue.isEmpty()) {
+                        operation = photoLoadOperationQueue.get(0);
+                        int maxCount = operation.isForceRequest() ? 3 : 1;
+                        if (currentPhotoLoadOperationsCount < maxCount) {
+                            operation = photoLoadOperationQueue.poll();
+                            if (operation != null) {
+                                currentPhotoLoadOperationsCount++;
+                                operation.start();
+                            }
+                        }
+                    }
+                } else {
+                    currentLoadOperationsCount--;
+                    if (!loadOperationQueue.isEmpty()) {
+                        operation = loadOperationQueue.get(0);
+                        int maxCount = operation.isForceRequest() ? 3 : 1;
+                        if (currentLoadOperationsCount < maxCount) {
+                            operation = loadOperationQueue.poll();
+                            if (operation != null) {
+                                currentLoadOperationsCount++;
+                                operation.start();
+                            }
+                        }
+                    }
+                }
+            }
+        });
+        fileProgresses.remove(arg1);
+    }
+
     public void setDelegate(FileLoaderDelegate delegate) {
         this.delegate = delegate;
     }
@@ -579,7 +573,7 @@ public static File getPathToMessage(TLRPC.Message message) {
         } else if (message.media instanceof TLRPC.TL_messageMediaPhoto) {
             ArrayList<TLRPC.PhotoSize> sizes = message.media.photo.sizes;
             if (sizes.size() > 0) {
-                TLRPC.PhotoSize sizeFull = getClosestPhotoSizeWithSize(sizes, 800, 800);
+                TLRPC.PhotoSize sizeFull = getClosestPhotoSizeWithSize(sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     return getPathToAttach(sizeFull);
                 }
@@ -588,6 +582,16 @@ public static File getPathToMessage(TLRPC.Message message) {
         return new File("");
     }
 
+    public static File getExistPathToAttach(TLObject attach) {
+        File path = getInstance().getDirectory(MEDIA_DIR_CACHE);
+        String fileName = getAttachFileName(attach);
+        File attachPath = new File(path, fileName);
+        if (attachPath.exists()) {
+            return attachPath;
+        }
+        return getPathToAttach(attach);
+    }
+
     public static File getPathToAttach(TLObject attach) {
         File dir = null;
         if (attach instanceof TLRPC.Video) {
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java b/TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java
index c78587bb1..96e6c7d68 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java
@@ -42,8 +42,10 @@
     private boolean isBigFile = false;
     private String fileKey;
     private int estimatedSize = 0;
-    FileInputStream stream;
-    MessageDigest mdEnc = null;
+    private int uploadStartTime = 0;
+    private FileInputStream stream;
+    private MessageDigest mdEnc = null;
+    private boolean started = false;
 
     public static interface FileUploadOperationDelegate {
         public abstract void didFinishUploadingFile(FileUploadOperation operation, TLRPC.InputFile inputFile, TLRPC.InputEncryptedFile inputEncryptedFile);
@@ -93,14 +95,18 @@ private void cleanup() {
                 remove(fileKey + "_ivc").commit();
     }
 
-    public void checkNewDataAvailable(final long finalSize) {
+    protected void checkNewDataAvailable(final long finalSize) {
         Utilities.stageQueue.postRunnable(new Runnable() {
             @Override
             public void run() {
-                if (finalSize != 0) {
+                if (estimatedSize != 0 && finalSize != 0) {
                     estimatedSize = 0;
                     totalFileSize = finalSize;
                     totalPartsCount = (int) Math.ceil((float) totalFileSize / (float) uploadChunkSize);
+                    if (started) {
+                        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("uploadinfo", Activity.MODE_PRIVATE);
+                        storeFileUploadInfo(preferences);
+                    }
                 }
                 if (requestToken == 0) {
                     startUploadRequest();
@@ -109,6 +115,20 @@ public void run() {
         });
     }
 
+    private void storeFileUploadInfo(SharedPreferences preferences) {
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putInt(fileKey + "_time", uploadStartTime);
+        editor.putLong(fileKey + "_size", totalFileSize);
+        editor.putLong(fileKey + "_id", currentFileId);
+        editor.remove(fileKey + "_uploaded");
+        if (isEncrypted) {
+            editor.putString(fileKey + "_iv", Utilities.bytesToHex(iv));
+            editor.putString(fileKey + "_ivc", Utilities.bytesToHex(ivChange));
+            editor.putString(fileKey + "_key", Utilities.bytesToHex(key));
+        }
+        editor.commit();
+    }
+
     private void startUploadRequest() {
         if (state != 1) {
             return;
@@ -117,6 +137,7 @@ private void startUploadRequest() {
         TLObject finalRequest;
 
         try {
+            started = true;
             if (stream == null) {
                 File cacheFile = new File(uploadingFilePath);
                 stream = new FileInputStream(cacheFile);
@@ -151,7 +172,7 @@ private void startUploadRequest() {
                 fileKey = Utilities.MD5(uploadingFilePath + (isEncrypted ? "enc" : ""));
                 SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("uploadinfo", Activity.MODE_PRIVATE);
                 long fileSize = preferences.getLong(fileKey + "_size", 0);
-                int currentTime = (int)(System.currentTimeMillis() / 1000);
+                uploadStartTime = (int)(System.currentTimeMillis() / 1000);
                 boolean rewrite = false;
                 if (estimatedSize == 0 && fileSize == totalFileSize) {
                     currentFileId = preferences.getLong(fileKey + "_id", 0);
@@ -170,9 +191,9 @@ private void startUploadRequest() {
                         }
                     }
                     if (!rewrite && date != 0) {
-                        if (isBigFile && date < currentTime - 60 * 60 * 24) {
+                        if (isBigFile && date < uploadStartTime - 60 * 60 * 24) {
                             date = 0;
-                        } else if (!isBigFile && date < currentTime - 60 * 60 * 1.5f) {
+                        } else if (!isBigFile && date < uploadStartTime - 60 * 60 * 1.5f) {
                             date = 0;
                         }
                         if (date != 0) {
@@ -235,17 +256,7 @@ private void startUploadRequest() {
                     }
                     currentFileId = Utilities.random.nextLong();
                     if (estimatedSize == 0) {
-                        SharedPreferences.Editor editor = preferences.edit();
-                        editor.putInt(fileKey + "_time", currentTime);
-                        editor.putLong(fileKey + "_size", totalFileSize);
-                        editor.putLong(fileKey + "_id", currentFileId);
-                        editor.remove(fileKey + "_uploaded");
-                        if (isEncrypted) {
-                            editor.putString(fileKey + "_iv", Utilities.bytesToHex(iv));
-                            editor.putString(fileKey + "_ivc", Utilities.bytesToHex(ivChange));
-                            editor.putString(fileKey + "_key", Utilities.bytesToHex(key));
-                        }
-                        editor.commit();
+                        storeFileUploadInfo(preferences);
                     }
                 }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java b/TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
index 35ef4d115..84fa468cb 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
@@ -27,6 +27,7 @@
     public static int RPCRequestClassPush = 64;
     public static int RPCRequestClassWithoutLogin = 128;
     public static int RPCRequestClassTryDifferentDc = 256;
+    public static int RPCRequestClassForceDownload = 512;
 
     static int RPCRequestClassTransportMask = (RPCRequestClassGeneric | RPCRequestClassDownloadMedia | RPCRequestClassUploadMedia);
 
@@ -35,6 +36,7 @@
 
     int serverFailureCount;
     int flags;
+    boolean wait = false;
     protected int retryCount = 0;
     protected int lastResendTime = 0;
     protected boolean completed = false;
diff --git a/TMessagesProj/src/main/java/org/telegram/messenger/TLRPC.java b/TMessagesProj/src/main/java/org/telegram/messenger/TLRPC.java
index e5417040e..3f08baa4a 100644
--- a/TMessagesProj/src/main/java/org/telegram/messenger/TLRPC.java
+++ b/TMessagesProj/src/main/java/org/telegram/messenger/TLRPC.java
@@ -9,6 +9,7 @@
 package org.telegram.messenger;
 
 import java.util.ArrayList;
+import java.util.Locale;
 
 @SuppressWarnings("unchecked")
 public class TLRPC {
@@ -8539,6 +8540,7 @@ public void serializeToStream(AbsSerializedData stream) {
         public int local_id = 0;
         public long dialog_id;
         public int ttl;
+        public VideoEditedInfo videoEditedInfo = null;
     }
 
     public static class TL_messageForwarded extends Message {
@@ -8559,9 +8561,13 @@ public void readParams(AbsSerializedData stream) {
             if (id < 0) {
                 fwd_msg_id = stream.readInt32();
             }
-            if (id < 0 || (media != null && !(media instanceof TL_messageMediaEmpty) && message != null && message.length() != 0 && message.equals("-1"))) {
+            if (id < 0 || (media != null && !(media instanceof TL_messageMediaEmpty) && message != null && message.length() != 0 && message.startsWith("-1"))) {
                 attachPath = stream.readString();
             }
+            if (id < 0 && message.length() > 6 && media instanceof TL_messageMediaVideo) {
+                videoEditedInfo = new VideoEditedInfo();
+                videoEditedInfo.parseString(message);
+            }
         }
 
         public void serializeToStream(AbsSerializedData stream) {
@@ -8595,9 +8601,13 @@ public void readParams(AbsSerializedData stream) {
             date = stream.readInt32();
             message = stream.readString();
             media = (MessageMedia)TLClassStore.Instance().TLdeserialize(stream, stream.readInt32());
-            if (id < 0 || (media != null && !(media instanceof TL_messageMediaEmpty) && message != null && message.length() != 0 && message.equals("-1"))) {
+            if (id < 0 || (media != null && !(media instanceof TL_messageMediaEmpty) && message != null && message.length() != 0 && message.startsWith("-1"))) {
                 attachPath = stream.readString();
             }
+            if (id < 0 && message.length() > 6 && media instanceof TL_messageMediaVideo) {
+                videoEditedInfo = new VideoEditedInfo();
+                videoEditedInfo.parseString(message);
+            }
         }
 
         public void serializeToStream(AbsSerializedData stream) {
@@ -8954,6 +8964,46 @@ public void serializeToStream(AbsSerializedData stream) {
         }
     }
 
+    public static class VideoEditedInfo {
+        public long startTime;
+        public long endTime;
+        public int rotationValue;
+        public int originalWidth;
+        public int originalHeight;
+        public int resultWidth;
+        public int resultHeight;
+        public int bitrate;
+        public String originalPath;
+
+        public String getString() {
+            return String.format(Locale.US, "-1_%d_%d_%d_%d_%d_%d_%d_%d_%s", startTime, endTime, rotationValue, originalWidth, originalHeight, bitrate, resultWidth, resultHeight, originalPath);
+        }
+
+        public void parseString(String string) {
+            if (string.length() < 6) {
+                return;
+            }
+            String args[] = string.split("_");
+            if (args.length >= 10) {
+                startTime = Long.parseLong(args[1]);
+                endTime = Long.parseLong(args[2]);
+                rotationValue = Integer.parseInt(args[3]);
+                originalWidth = Integer.parseInt(args[4]);
+                originalHeight = Integer.parseInt(args[5]);
+                bitrate = Integer.parseInt(args[6]);
+                resultWidth = Integer.parseInt(args[7]);
+                resultHeight = Integer.parseInt(args[8]);
+                for (int a = 9; a < args.length; a++) {
+                    if (originalPath == null) {
+                        originalPath = args[a];
+                    } else {
+                        originalPath += "_" + args[a];
+                    }
+                }
+            }
+        }
+    }
+
     public static class Video extends TLObject {
         public long id;
         public long access_hash;
@@ -8967,10 +9017,9 @@ public void serializeToStream(AbsSerializedData stream) {
         public int dc_id;
         public int w;
         public int h;
-        public String path;
         public byte[] key;
         public byte[] iv;
-        public boolean estimatedSize;
+        public VideoEditedInfo videoEditedInfo = null;
     }
 
     public static class Document extends TLObject {
@@ -8983,7 +9032,6 @@ public void serializeToStream(AbsSerializedData stream) {
         public int size;
         public PhotoSize thumb;
         public int dc_id;
-        public String path;
         public byte[] key;
         public byte[] iv;
     }
@@ -8997,7 +9045,6 @@ public void serializeToStream(AbsSerializedData stream) {
         public String mime_type;
         public int size;
         public int dc_id;
-        public String path;
         public byte[] key;
         public byte[] iv;
     }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
index 700a43bc6..480fd97dd 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
@@ -564,17 +564,17 @@ protected void onDraw(Canvas canvas) {
                 boolean drawError = false;
                 boolean isBroadcast = (int)(currentMessageObject.getDialogId() >> 32) == 1;
 
-                if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                if (currentMessageObject.isSending()) {
                     drawCheck1 = false;
                     drawCheck2 = false;
                     drawClock = true;
                     drawError = false;
-                } else if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                } else if (currentMessageObject.isSendError()) {
                     drawCheck1 = false;
                     drawCheck2 = false;
                     drawClock = false;
                     drawError = true;
-                } else if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                } else if (currentMessageObject.isSent()) {
                     if (!currentMessageObject.isUnread()) {
                         drawCheck1 = true;
                         drawCheck2 = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
index f8085efa6..2c436381f 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
@@ -54,8 +54,8 @@
     private static Drawable videoIconDrawable;
     private static Drawable docMenuInDrawable;
     private static Drawable docMenuOutDrawable;
-    private static Drawable[] buttonStatesDrawables = new Drawable[4];
-    private static Drawable[][] buttonStatesDrawablesDoc = new Drawable[2][2];
+    private static Drawable[] buttonStatesDrawables = new Drawable[5];
+    private static Drawable[][] buttonStatesDrawablesDoc = new Drawable[3][2];
     private static TextPaint infoPaint;
     private static MessageObject lastDownloadedGifMessage = null;
     private static TextPaint namePaint;
@@ -118,10 +118,13 @@ public ChatMediaCell(Context context) {
             buttonStatesDrawables[1] = getResources().getDrawable(R.drawable.photocancel);
             buttonStatesDrawables[2] = getResources().getDrawable(R.drawable.photogif);
             buttonStatesDrawables[3] = getResources().getDrawable(R.drawable.playvideo);
+            buttonStatesDrawables[4] = getResources().getDrawable(R.drawable.photopause);
             buttonStatesDrawablesDoc[0][0] = getResources().getDrawable(R.drawable.docload_b);
             buttonStatesDrawablesDoc[1][0] = getResources().getDrawable(R.drawable.doccancel_b);
+            buttonStatesDrawablesDoc[2][0] = getResources().getDrawable(R.drawable.docpause_b);
             buttonStatesDrawablesDoc[0][1] = getResources().getDrawable(R.drawable.docload_g);
             buttonStatesDrawablesDoc[1][1] = getResources().getDrawable(R.drawable.doccancel_g);
+            buttonStatesDrawablesDoc[2][1] = getResources().getDrawable(R.drawable.docpause_g);
             videoIconDrawable = getResources().getDrawable(R.drawable.ic_video);
             docMenuInDrawable = getResources().getDrawable(R.drawable.doc_actions_b);
             docMenuOutDrawable = getResources().getDrawable(R.drawable.doc_actions_g);
@@ -176,7 +179,7 @@ public boolean onTouchEvent(MotionEvent event) {
         float y = event.getY();
 
         boolean result = false;
-        int side = AndroidUtilities.dp(44);
+        int side = AndroidUtilities.dp(48);
         if (event.getAction() == MotionEvent.ACTION_DOWN) {
             if (delegate == null || delegate.canPerformActions()) {
                 if (buttonState != -1 && x >= buttonX && x <= buttonX + side && y >= buttonY && y <= buttonY + side) {
@@ -315,17 +318,17 @@ private void didPressedButton() {
                     photoImage.setImage(currentPhotoObject.photoOwner.location, currentPhotoFilter, currentMessageObject.isOut() ? placeholderOutDrawable : placeholderInDrawable, currentPhotoObject.photoOwner.size);
                 }
             } else if (currentMessageObject.type == 8 || currentMessageObject.type == 9) {
-                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.document);
+                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.document, true);
                 lastDownloadedGifMessage = currentMessageObject;
             } else if (currentMessageObject.type == 3) {
-                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.video);
+                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.video, true);
             }
             progressVisible = true;
             startAnimation();
             buttonState = 1;
             invalidate();
         } else if (buttonState == 1) {
-            if (currentMessageObject.isOut() && currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+            if (currentMessageObject.isOut() && currentMessageObject.isSending()) {
                 if (delegate != null) {
                     delegate.didPressedCancelSendButton(this);
                 }
@@ -495,7 +498,7 @@ public void setMessageObject(MessageObject messageObject) {
                 photoWidth = AndroidUtilities.dp(86);
                 photoHeight = AndroidUtilities.dp(86);
                 backgroundWidth = photoWidth + Math.max(nameWidth, infoWidth) + AndroidUtilities.dp(68);
-                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, 800, 800);
+                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (currentPhotoObject != null) {
                     if (currentPhotoObject.image != null) {
                         photoImage.setImageBitmap(currentPhotoObject.image);
@@ -523,14 +526,14 @@ public void setMessageObject(MessageObject messageObject) {
                 }
                 photoHeight = photoWidth + AndroidUtilities.dp(100);
 
-                if (photoWidth > 800) {
-                    photoWidth = 800;
+                if (photoWidth > AndroidUtilities.getPhotoSize()) {
+                    photoWidth = AndroidUtilities.getPhotoSize();
                 }
-                if (photoHeight > 800) {
-                    photoHeight = 800;
+                if (photoHeight > AndroidUtilities.getPhotoSize()) {
+                    photoHeight = AndroidUtilities.getPhotoSize();
                 }
 
-                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, 800, 800);
+                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (currentPhotoObject != null) {
                     boolean noSize = false;
                     if (currentMessageObject.type == 3 || currentMessageObject.type == 8) {
@@ -538,6 +541,10 @@ public void setMessageObject(MessageObject messageObject) {
                     }
                     float scale = (float) currentPhotoObject.photoOwner.w / (float) photoWidth;
 
+                    if (!noSize && currentPhotoObject.photoOwner.size == 0) {
+                        currentPhotoObject.photoOwner.size = -1;
+                    }
+
                     int w = (int) (currentPhotoObject.photoOwner.w / scale);
                     int h = (int) (currentPhotoObject.photoOwner.h / scale);
                     if (w == 0) {
@@ -642,7 +649,7 @@ public void updateButtonState() {
         if (fileName == null) {
             return;
         }
-        if (currentMessageObject.isOut() && currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+        if (currentMessageObject.isOut() && currentMessageObject.isSending()) {
             if (currentMessageObject.messageOwner.attachPath != null) {
                 MediaController.getInstance().addLoadingFileObserver(currentMessageObject.messageOwner.attachPath, this);
                 progressVisible = true;
@@ -735,7 +742,7 @@ private void setProgress(float value, boolean animated) {
     }
 
     private void invalidateProgress() {
-        int offset = AndroidUtilities.dp(1);
+        int offset = AndroidUtilities.dp(2);
         invalidate((int)progressRect.left - offset, (int)progressRect.top - offset, (int)progressRect.right + offset * 2, (int)progressRect.bottom + offset * 2);
     }
 
@@ -768,10 +775,10 @@ protected void onLayout(boolean changed, int left, int top, int right, int botto
             }
         }
         photoImage.setImageCoords(x, AndroidUtilities.dp(7), photoWidth, photoHeight);
-        int size = AndroidUtilities.dp(44);
+        int size = AndroidUtilities.dp(48);
         buttonX = (int)(x + (photoWidth - size) / 2.0f);
         buttonY = (int)(AndroidUtilities.dp(7) + (photoHeight - size) / 2.0f);
-        progressRect.set(buttonX + AndroidUtilities.dp(1), buttonY + AndroidUtilities.dp(1), buttonX + AndroidUtilities.dp(43), buttonY + AndroidUtilities.dp(43));
+        progressRect.set(buttonX + AndroidUtilities.dp(1), buttonY + AndroidUtilities.dp(1), buttonX + AndroidUtilities.dp(47), buttonY + AndroidUtilities.dp(47));
     }
 
     @Override
@@ -809,7 +816,7 @@ protected void onAfterBackgroundDraw(Canvas canvas) {
 
                 if (buttonState == -1) {
                     Drawable drawable = currentMessageObject.isOut() ? placeholderDocOutDrawable : placeholderDocInDrawable;
-                    setDrawableBounds(drawable, photoImage.getImageX() + AndroidUtilities.dp(27), photoImage.getImageY() + AndroidUtilities.dp(27));
+                    setDrawableBounds(drawable, photoImage.getImageX() + AndroidUtilities.dp(19), photoImage.getImageY() + AndroidUtilities.dp(19));
                     drawable.draw(canvas);
                 }
                 if (currentMessageObject.isOut()) {
@@ -828,9 +835,17 @@ protected void onAfterBackgroundDraw(Canvas canvas) {
         if (buttonState >= 0 && buttonState < 4) {
             Drawable currentButtonDrawable = null;
             if (currentMessageObject.type == 9 && !imageDrawn) {
-                currentButtonDrawable = buttonStatesDrawablesDoc[buttonState][currentMessageObject.isOut() ? 1 : 0];
+                if (buttonState == 1 && !currentMessageObject.isSending()) {
+                    currentButtonDrawable = buttonStatesDrawablesDoc[2][currentMessageObject.isOut() ? 1 : 0];
+                } else {
+                    currentButtonDrawable = buttonStatesDrawablesDoc[buttonState][currentMessageObject.isOut() ? 1 : 0];
+                }
             } else {
-                currentButtonDrawable = buttonStatesDrawables[buttonState];
+                if (buttonState == 1 && !currentMessageObject.isSending()) {
+                    currentButtonDrawable = buttonStatesDrawables[4];
+                } else {
+                    currentButtonDrawable = buttonStatesDrawables[buttonState];
+                }
             }
             setDrawableBounds(currentButtonDrawable, buttonX, buttonY);
             currentButtonDrawable.draw(canvas);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
index d4ae34ae2..ef6f19191 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
@@ -528,18 +528,18 @@ public void build(int width, int height) {
                 }
 
                 if (message.isFromMe() && message.isOut()) {
-                    if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    if (message.isSending()) {
                         drawCheck1 = false;
                         drawCheck2 = false;
                         drawClock = true;
                         drawError = false;
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                    } else if (message.isSendError()) {
                         drawCheck1 = false;
                         drawCheck2 = false;
                         drawClock = false;
                         drawError = true;
                         drawCount = false;
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                    } else if (message.isSent()) {
                         if (!message.isUnread()) {
                             drawCheck1 = true;
                             drawCheck2 = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
index bb03b8cb7..3254e0b8e 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
@@ -21,6 +21,7 @@
 import android.graphics.Bitmap;
 import android.graphics.Rect;
 import android.graphics.drawable.Drawable;
+import android.media.MediaMetadataRetriever;
 import android.media.MediaPlayer;
 import android.media.ThumbnailUtils;
 import android.net.Uri;
@@ -101,9 +102,7 @@
     private boolean userBlocked = false;
 
     private View topPanel;
-    private View secretChatPlaceholder;
     private View progressView;
-    private TextView emptyView;
     private View bottomOverlay;
     private ChatAdapter chatAdapter;
     private ChatActivityEnterView chatActivityEnterView;
@@ -114,6 +113,7 @@
     private TextView bottomOverlayChatText;
     private View bottomOverlayChat;
     private TypingDotsDrawable typingDotsDrawable;
+    private View emptyViewContainer;
 
     private TextView bottomOverlayText;
 
@@ -169,6 +169,8 @@
     private long chatEnterTime = 0;
     private long chatLeaveTime = 0;
 
+    private String startVideoEdit = null;
+
     private final static int copy = 1;
     private final static int quoteforward = 12;
     private final static int forward = 2;
@@ -345,6 +347,7 @@ public void needSendTyping() {
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.audioDidReset);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.screenshotTook);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.blockedUsersDidLoaded);
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.FileNewChunkAvailable);
 
         super.onFragmentCreate();
 
@@ -355,7 +358,7 @@ public void needSendTyping() {
         }
 
         if (AndroidUtilities.isTablet()) {
-            NotificationCenter.getInstance().postNotificationName(NotificationCenter.openedChatChanged, dialog_id);
+            NotificationCenter.getInstance().postNotificationName(NotificationCenter.openedChatChanged, dialog_id, false);
         }
 
         typingDotsDrawable = new TypingDotsDrawable();
@@ -389,8 +392,9 @@ public void onFragmentDestroy() {
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.audioDidReset);
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.screenshotTook);
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.blockedUsersDidLoaded);
+        NotificationCenter.getInstance().removeObserver(this, NotificationCenter.FileNewChunkAvailable);
         if (AndroidUtilities.isTablet()) {
-            NotificationCenter.getInstance().postNotificationName(NotificationCenter.openedChatChanged, (long)0);
+            NotificationCenter.getInstance().postNotificationName(NotificationCenter.openedChatChanged, dialog_id, true);
         }
         if (currentEncryptedChat != null) {
             MediaController.getInstance().stopMediaObserver();
@@ -425,7 +429,7 @@ public void onItemClick(int id) {
                                 takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(image));
                                 currentPicturePath = image.getAbsolutePath();
                             }
-                            getParentActivity().startActivityForResult(takePictureIntent, 0);
+                            startActivityForResult(takePictureIntent, 0);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }
@@ -442,7 +446,7 @@ public void onItemClick(int id) {
                             Intent takeVideoIntent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);
                             File video = Utilities.generateVideoPath();
                             if (video != null) {
-                                if (android.os.Build.VERSION.SDK_INT > 16) {
+                                if (Build.VERSION.SDK_INT >= 18) {
                                     takeVideoIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(video));
                                 }
                                 takeVideoIntent.putExtra(MediaStore.EXTRA_SIZE_LIMIT, (long) (1024 * 1024 * 1000));
@@ -451,7 +455,7 @@ public void onItemClick(int id) {
                             Intent chooserIntent = Intent.createChooser(pickIntent, "");
                             chooserIntent.putExtra(Intent.EXTRA_INITIAL_INTENTS, new Intent[]{takeVideoIntent});
 
-                            getParentActivity().startActivityForResult(chooserIntent, 2);
+                            startActivityForResult(chooserIntent, 2);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }
@@ -511,7 +515,7 @@ public void onItemClick(int id) {
                             }
                         }
                         if (str.length() != 0) {
-                            if (android.os.Build.VERSION.SDK_INT < 11) {
+                            if (Build.VERSION.SDK_INT < 11) {
                                 android.text.ClipboardManager clipboard = (android.text.ClipboardManager) ApplicationLoader.applicationContext.getSystemService(Context.CLIPBOARD_SERVICE);
                                 clipboard.setText(str);
                             } else {
@@ -631,7 +635,15 @@ public boolean onTouch(View v, MotionEvent event) {
             fragmentView = inflater.inflate(R.layout.chat_layout, container, false);
 
             View contentView = fragmentView.findViewById(R.id.chat_layout);
-            emptyView = (TextView)fragmentView.findViewById(R.id.searchEmptyView);
+            TextView emptyView = (TextView) fragmentView.findViewById(R.id.searchEmptyView);
+            emptyViewContainer = fragmentView.findViewById(R.id.empty_view);
+            emptyViewContainer.setVisibility(View.GONE);
+            emptyViewContainer.setOnTouchListener(new View.OnTouchListener() {
+                @Override
+                public boolean onTouch(View v, MotionEvent event) {
+                    return true;
+                }
+            });
             emptyView.setText(LocaleController.getString("NoMessages", R.string.NoMessages));
             chatListView = (LayoutListView)fragmentView.findViewById(R.id.chat_list_view);
             chatListView.setAdapter(chatAdapter = new ChatAdapter(getParentActivity()));
@@ -688,7 +700,9 @@ public boolean onTouch(View v, MotionEvent event) {
             }
 
             if (currentEncryptedChat != null) {
-                secretChatPlaceholder = contentView.findViewById(R.id.secret_placeholder);
+                emptyView.setVisibility(View.GONE);
+                View secretChatPlaceholder = contentView.findViewById(R.id.secret_placeholder);
+                secretChatPlaceholder.setVisibility(View.VISIBLE);
                 if (isCustomTheme) {
                     secretChatPlaceholder.setBackgroundResource(R.drawable.system_black);
                 } else {
@@ -799,11 +813,7 @@ public void onScroll(AbsListView absListView, int firstVisibleItem, int visibleI
                 chatListView.setEmptyView(null);
             } else {
                 progressView.setVisibility(View.GONE);
-                if (currentEncryptedChat == null) {
-                    chatListView.setEmptyView(emptyView);
-                } else {
-                    chatListView.setEmptyView(secretChatPlaceholder);
-                }
+                chatListView.setEmptyView(emptyViewContainer);
             }
 
             pagedownButton.setOnClickListener(new View.OnClickListener() {
@@ -898,7 +908,7 @@ private void showPagedownButton(boolean show, boolean animated) {
         }
         if (show) {
             if (pagedownButton.getVisibility() == View.GONE) {
-                if (android.os.Build.VERSION.SDK_INT > 13 && animated) {
+                if (Build.VERSION.SDK_INT > 13 && animated) {
                     pagedownButton.setVisibility(View.VISIBLE);
                     pagedownButton.setAlpha(0);
                     pagedownButton.animate().alpha(1).setDuration(200).setListener(null).start();
@@ -908,7 +918,7 @@ private void showPagedownButton(boolean show, boolean animated) {
             }
         } else {
             if (pagedownButton.getVisibility() == View.VISIBLE) {
-                if (android.os.Build.VERSION.SDK_INT > 13 && animated) {
+                if (Build.VERSION.SDK_INT > 13 && animated) {
                     pagedownButton.animate().alpha(0).setDuration(200).setListener(new Animator.AnimatorListener() {
                         @Override
                         public void onAnimationStart(Animator animation) {
@@ -1081,9 +1091,9 @@ private void updateOnlineCount() {
 
     private int getMessageType(MessageObject messageObject) {
         if (currentEncryptedChat == null) {
-            boolean isBroadcastError = isBraodcast && messageObject.messageOwner.id <= 0 && messageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR;
+            boolean isBroadcastError = isBraodcast && messageObject.messageOwner.id <= 0 && messageObject.isSendError();
             if (!isBraodcast && messageObject.messageOwner.id <= 0 && messageObject.isOut() || isBroadcastError) {
-                if (messageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                if (messageObject.isSendError()) {
                     if (!(messageObject.messageOwner.media instanceof TLRPC.TL_messageMediaEmpty)) {
                         return 0;
                     } else {
@@ -1137,13 +1147,13 @@ private int getMessageType(MessageObject messageObject) {
         } else {
             if (messageObject.type == 6) {
                 return -1;
-            } else if (messageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+            } else if (messageObject.isSendError()) {
                 if (!(messageObject.messageOwner.media instanceof TLRPC.TL_messageMediaEmpty)) {
                     return 0;
                 } else {
                     return 6;
                 }
-            } else if (messageObject.type == 10 || messageObject.type == 11 || messageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+            } else if (messageObject.type == 10 || messageObject.type == 11 || messageObject.isSending()) {
                 if (messageObject.messageOwner.id == 0) {
                     return -1;
                 }
@@ -1252,6 +1262,9 @@ private void updateSubtitle() {
         }
 
         CharSequence printString = MessagesController.getInstance().printingStrings.get(dialog_id);
+        if (printString != null) {
+            printString = TextUtils.replace(printString, new String[]{"..."}, new String[]{""});
+        }
         if (printString == null || printString.length() == 0) {
             lastPrintString = null;
             setTypingAnimation(false);
@@ -1364,14 +1377,20 @@ public void onActivityResultFragment(int requestCode, int resultCode, Intent dat
                     }
                     currentPicturePath = null;
                 }
-                if(android.os.Build.VERSION.SDK_INT >= 16) {
-                    Bundle args = new Bundle();
-                    args.putString("videoPath", videoPath);
-                    VideoEditorActivity fragment = new VideoEditorActivity(args);
-                    fragment.setDelegate(this);
-                    presentFragment(fragment);
+                if(Build.VERSION.SDK_INT >= 16) {
+                    if (paused) {
+                        startVideoEdit = videoPath;
+                    } else {
+                        Bundle args = new Bundle();
+                        args.putString("videoPath", videoPath);
+                        VideoEditorActivity fragment = new VideoEditorActivity(args);
+                        fragment.setDelegate(this);
+                        if (!presentFragment(fragment, false, true)) {
+                            processSendingVideo(videoPath, 0, 0, 0, 0, null);
+                        }
+                    }
                 } else {
-                    processSendingVideo(videoPath, null, 0, 0, 0, 0);
+                    processSendingVideo(videoPath, 0, 0, 0, 0, null);
                 }
             } else if (requestCode == 21) {
                 if (data == null || data.getData() == null) {
@@ -1394,13 +1413,18 @@ public void onActivityResultFragment(int requestCode, int resultCode, Intent dat
     }
 
     @Override
-    public void didStartVideoConverting(String videoPath, String originalPath, long esimatedSize, int duration, int width, int height) {
-        processSendingVideo(videoPath, originalPath, esimatedSize, duration, width, height);
-    }
-
-    @Override
-    public void didAppenedVideoData(String videoPath, long finalSize) {
-        FileLoader.getInstance().checkUploadNewDataAvailable(videoPath, currentEncryptedChat != null, finalSize);
+    public void didFinishEditVideo(String videoPath, long startTime, long endTime, int resultWidth, int resultHeight, int rotationValue, int originalWidth, int originalHeight, int bitrate, long estimatedSize, long estimatedDuration) {
+        TLRPC.VideoEditedInfo videoEditedInfo = new TLRPC.VideoEditedInfo();
+        videoEditedInfo.startTime = startTime;
+        videoEditedInfo.endTime = endTime;
+        videoEditedInfo.rotationValue = rotationValue;
+        videoEditedInfo.originalWidth = originalWidth;
+        videoEditedInfo.originalHeight = originalHeight;
+        videoEditedInfo.bitrate = bitrate;
+        videoEditedInfo.resultWidth = resultWidth;
+        videoEditedInfo.resultHeight = resultHeight;
+        videoEditedInfo.originalPath = videoPath;
+        processSendingVideo(videoPath, estimatedSize, estimatedDuration, resultWidth, resultHeight, videoEditedInfo);
     }
 
     private void showAttachmentError() {
@@ -1505,7 +1529,7 @@ public void run() {
                             photo = (TLRPC.TL_photo)MessagesStorage.getInstance().getSentFile(Utilities.getPath(uri), currentEncryptedChat == null ? 0 : 3);
                         }
                         if (photo == null) {
-                            photo = MessagesController.getInstance().generatePhotoSizes(path, uri);
+                            photo = SendMessagesHelper.getInstance().generatePhotoSizes(path, uri);
                         }
                         if (photo != null) {
                             final String originalPathFinal = originalPath;
@@ -1534,7 +1558,7 @@ public void run() {
         }).start();
     }
 
-    private void processSendingDocumentInternal(String path, String originalPath) {
+    private void processSendingDocumentInternal(final String path, String originalPath) {
         if (path == null || path.length() == 0) {
             return;
         }
@@ -1595,14 +1619,13 @@ private void processSendingDocumentInternal(String path, String originalPath) {
                 document.thumb.type = "s";
             }
         }
-        document.path = path;
 
         final TLRPC.TL_document documentFinal = document;
         final String originalPathFinal = originalPath;
         AndroidUtilities.RunOnUIThread(new Runnable() {
             @Override
             public void run() {
-                SendMessagesHelper.getInstance().sendMessage(documentFinal, originalPathFinal, dialog_id);
+                SendMessagesHelper.getInstance().sendMessage(documentFinal, originalPathFinal, path, dialog_id);
                 if (chatListView != null) {
                     chatListView.setSelectionFromTop(messages.size() - 1, -100000 - chatListView.getPaddingTop());
                 }
@@ -1638,72 +1661,92 @@ public void run() {
         }).start();
     }
 
-    public void processSendingVideo(final String videoPath, final String originalFile, final long estimatedSize, final int duration, final int width, final int height) {
+    public void processSendingVideo(final String videoPath, final long estimatedSize, final long duration, final int width, final int height, final TLRPC.VideoEditedInfo videoEditedInfo) {
         if (videoPath == null || videoPath.length() == 0) {
             return;
         }
         new Thread(new Runnable() {
             @Override
             public void run() {
-                String originalPath = null;
-                if (originalFile != null) {
-                    originalPath = originalFile;
-                } else {
-                    originalPath = videoPath;
-                }
+                String path = videoPath;
+                String originalPath = videoPath;
                 File temp = new File(originalPath);
                 originalPath += temp.length() + "_" + temp.lastModified();
-                TLRPC.TL_video video = null;// (TLRPC.TL_video)MessagesStorage.getInstance().getSentFile(originalPath, currentEncryptedChat == null ? 2 : 5);
+                if (videoEditedInfo != null) {
+                    originalPath += duration + "_" + videoEditedInfo.startTime + "_" + videoEditedInfo.endTime;
+                }
+                TLRPC.TL_video video = (TLRPC.TL_video)MessagesStorage.getInstance().getSentFile(originalPath, currentEncryptedChat == null ? 2 : 5);
                 if (video == null) {
-                    Bitmap thumb = null;
-                    if (originalFile != null) {
-                        thumb = ThumbnailUtils.createVideoThumbnail(originalFile, MediaStore.Video.Thumbnails.MINI_KIND);
-                    } else {
-                        thumb = ThumbnailUtils.createVideoThumbnail(videoPath, MediaStore.Video.Thumbnails.MINI_KIND);
-                    }
+                    Bitmap thumb = ThumbnailUtils.createVideoThumbnail(videoPath, MediaStore.Video.Thumbnails.MINI_KIND);
                     TLRPC.PhotoSize size = ImageLoader.scaleAndSaveImage(thumb, 90, 90, 55, currentEncryptedChat != null);
-                    if (size == null) {
-                        return;
-                    }
-                    size.type = "s";
                     video = new TLRPC.TL_video();
                     video.thumb = size;
+                    if (video.thumb == null) {
+                        video.thumb = new TLRPC.TL_photoSizeEmpty();
+                    } else {
+                        video.thumb.type = "s";
+                    }
                     video.caption = "";
                     video.mime_type = "video/mp4";
                     video.id = 0;
-                    if (estimatedSize != 0) {
+                    UserConfig.saveConfig(false);
+
+                    if (videoEditedInfo != null) {
+                        video.duration = (int)(duration / 1000);
+                        if (videoEditedInfo.rotationValue == 90 || videoEditedInfo.rotationValue == 270) {
+                            video.w = height;
+                            video.h = width;
+                        } else {
+                            video.w = width;
+                            video.h = height;
+                        }
                         video.size = (int)estimatedSize;
+                        video.videoEditedInfo = videoEditedInfo;
+                        String fileName = Integer.MIN_VALUE + "_" + UserConfig.lastLocalId + ".mp4";
+                        UserConfig.lastLocalId--;
+                        File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
+                        UserConfig.saveConfig(false);
+                        path = cacheFile.getAbsolutePath();
                     } else {
                         if (temp != null && temp.exists()) {
                             video.size = (int) temp.length();
                         }
-                    }
-                    UserConfig.saveConfig(false);
-
-                    if (duration != 0) {
-                        video.duration = duration / 1000;
-                        video.w = width;
-                        video.h = height;
-                        video.estimatedSize = true;
-                    } else {
-                        MediaPlayer mp = MediaPlayer.create(ApplicationLoader.applicationContext, Uri.fromFile(new File(videoPath)));
-                        if (mp == null) {
-                            return;
+                        if (Build.VERSION.SDK_INT >= 14) {
+                            MediaMetadataRetriever mediaMetadataRetriever = new MediaMetadataRetriever();
+                            mediaMetadataRetriever.setDataSource(videoPath);
+                            String width = mediaMetadataRetriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_VIDEO_WIDTH);
+                            if (width != null) {
+                                video.w = Integer.parseInt(width);
+                            }
+                            String height = mediaMetadataRetriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_VIDEO_HEIGHT);
+                            if (height != null) {
+                                video.h = Integer.parseInt(height);
+                            }
+                            String duration = mediaMetadataRetriever.extractMetadata(MediaMetadataRetriever.METADATA_KEY_DURATION);
+                            if (duration != null) {
+                                video.duration = (int) Math.ceil(Long.parseLong(duration) / 1000.0f);
+                            }
+                            mediaMetadataRetriever.release();
+                        } else {
+                            MediaPlayer mp = MediaPlayer.create(ApplicationLoader.applicationContext, Uri.fromFile(new File(videoPath)));
+                            if (mp == null) {
+                                return;
+                            }
+                            video.duration = (int) Math.ceil(mp.getDuration() / 1000.0f);
+                            video.w = mp.getVideoWidth();
+                            video.h = mp.getVideoHeight();
+                            mp.release();
                         }
-                        video.duration = (int) Math.ceil(mp.getDuration() / 1000.0f);
-                        video.w = mp.getVideoWidth();
-                        video.h = mp.getVideoHeight();
-                        mp.release();
                     }
                 }
-                video.path = videoPath;
 
                 final TLRPC.TL_video videoFinal = video;
                 final String originalPathFinal = originalPath;
+                final String finalPath = path;
                 AndroidUtilities.RunOnUIThread(new Runnable() {
                     @Override
                     public void run() {
-                        SendMessagesHelper.getInstance().sendMessage(videoFinal, originalPathFinal, dialog_id);
+                        SendMessagesHelper.getInstance().sendMessage(videoFinal, originalPathFinal, finalPath, dialog_id);
                         if (chatListView != null) {
                             chatListView.setSelectionFromTop(messages.size() - 1, -100000 - chatListView.getPaddingTop());
                         }
@@ -1928,11 +1971,7 @@ public void run() {
 
                         if (first) {
                             if (chatListView.getEmptyView() == null) {
-                                if (currentEncryptedChat == null) {
-                                    chatListView.setEmptyView(emptyView);
-                                } else {
-                                    chatListView.setEmptyView(secretChatPlaceholder);
-                                }
+                                chatListView.setEmptyView(emptyViewContainer);
                             }
                         }
                     } else {
@@ -1998,7 +2037,7 @@ public void run() {
                         if (currentEncryptedChat != null && obj.messageOwner.action != null && obj.messageOwner.action instanceof TLRPC.TL_messageActionTTLChange && timerButton != null) {
                             timerButton.setTime(obj.messageOwner.action.ttl);
                         }
-                        if (obj.isOut() && obj.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                        if (obj.isOut() && obj.isSending()) {
                             scrollToLastMessage();
                             return;
                         }
@@ -2139,7 +2178,14 @@ public void run() {
                 }
             }
         } else if (id == NotificationCenter.closeChats) {
-            removeSelfFromStack();
+            if (args != null && args.length > 0) {
+                long did = (Long)args[0];
+                if (did == dialog_id) {
+                    finishFragment();
+                }
+            } else {
+                removeSelfFromStack();
+            }
         } else if (id == NotificationCenter.messagesRead) {
             ArrayList<Integer> markAsReadMessages = (ArrayList<Integer>)args[0];
             boolean updated = false;
@@ -2295,11 +2341,7 @@ public void run() {
             messagesByDays.clear();
             messagesDict.clear();
             progressView.setVisibility(View.GONE);
-            if (currentEncryptedChat == null) {
-                chatListView.setEmptyView(emptyView);
-            } else {
-                chatListView.setEmptyView(secretChatPlaceholder);
-            }
+            chatListView.setEmptyView(emptyViewContainer);
             if (currentEncryptedChat == null) {
                 maxMessageId = Integer.MAX_VALUE;
                 minMessageId = Integer.MIN_VALUE;
@@ -2323,6 +2365,16 @@ public void run() {
                     updateBottomOverlay();
                 }
             }
+        } else if (id == NotificationCenter.FileNewChunkAvailable) {
+            MessageObject messageObject = (MessageObject)args[0];
+            long finalSize = (Long)args[2];
+            if (finalSize != 0 && dialog_id == messageObject.getDialogId()) {
+                MessageObject currentObject = messagesDict.get(messageObject.messageOwner.id);
+                if (currentObject != null) {
+                    currentObject.messageOwner.media.video.size = (int)finalSize;
+                    updateVisibleRows();
+                }
+            }
         }
     }
 
@@ -2485,6 +2537,22 @@ public void onResume() {
             chatEnterTime = System.currentTimeMillis();
             chatLeaveTime = 0;
         }
+
+        if (startVideoEdit != null) {
+            AndroidUtilities.RunOnUIThread(new Runnable() {
+                @Override
+                public void run() {
+                    Bundle args = new Bundle();
+                    args.putString("videoPath", startVideoEdit);
+                    VideoEditorActivity fragment = new VideoEditorActivity(args);
+                    fragment.setDelegate(ChatActivity.this);
+                    if (!presentFragment(fragment, false, true)) {
+                        processSendingVideo(startVideoEdit, 0, 0, 0, 0, null);
+                    }
+                    startVideoEdit = null;
+                }
+            });
+        }
     }
 
     @Override
@@ -2508,7 +2576,7 @@ public void startPhotoSelectActivity() {
         try {
             Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
             photoPickerIntent.setType("image/*");
-            getParentActivity().startActivityForResult(photoPickerIntent, 1);
+            startActivityForResult(photoPickerIntent, 1);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
@@ -2533,7 +2601,9 @@ private void setTypingAnimation(boolean start) {
             }
         } else {
             actionBarLayer.setSubTitleIcon(0, null, 0);
-            typingDotsDrawable.stop();
+            if (typingDotsDrawable != null) {
+                typingDotsDrawable.stop();
+            }
         }
     }
 
@@ -2851,7 +2921,7 @@ private void processSelectedOption(int option) {
             fragment.setDelegate(this);
             presentFragment(fragment);
         } else if (option == 3) {
-            if(android.os.Build.VERSION.SDK_INT < 11) {
+            if(Build.VERSION.SDK_INT < 11) {
                 android.text.ClipboardManager clipboard = (android.text.ClipboardManager)ApplicationLoader.applicationContext.getSystemService(Context.CLIPBOARD_SERVICE);
                 clipboard.setText(selectedObject.messageText);
             } else {
@@ -2861,12 +2931,16 @@ private void processSelectedOption(int option) {
             }
         } else if (option == 4) {
             String fileName = selectedObject.getFileName();
+            String path = selectedObject.messageOwner.attachPath;
+            if (path == null || path.length() == 0) {
+                path = FileLoader.getPathToMessage(selectedObject.messageOwner).toString();
+            }
             if (selectedObject.type == 3) {
-                MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 1, null);
+                MediaController.saveFile(path, getParentActivity(), 1, null);
             } else if (selectedObject.type == 1) {
-                MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 0, null);
+                MediaController.saveFile(path, getParentActivity(), 0, null);
             } else if (selectedObject.type == 8 || selectedObject.type == 9) {
-                MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 2, selectedObject.messageOwner.media.document.file_name);
+                MediaController.saveFile(path, getParentActivity(), 2, selectedObject.messageOwner.media.document.file_name);
             }
         } else if (option == 5) {
             File locFile = null;
@@ -2955,7 +3029,7 @@ public void startDocumentSelectActivity() {
         try {
             Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
             photoPickerIntent.setType("*/*");
-            getParentActivity().startActivityForResult(photoPickerIntent, 21);
+            startActivityForResult(photoPickerIntent, 21);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
@@ -3006,7 +3080,9 @@ public void didSelectDialog(MessagesActivity activity, long did, boolean param)
                     }
                     presentFragment(new ChatActivity(args), true);
                     forwardSelectedMessages(did, param);
-                    removeSelfFromStack();
+                    if (!AndroidUtilities.isTablet()) {
+                        removeSelfFromStack();
+                    }
                 } else {
                     activity.finishFragment();
                 }
@@ -3015,6 +3091,9 @@ public void didSelectDialog(MessagesActivity activity, long did, boolean param)
                 forwardSelectedMessages(did, param);
                 chatListView.setSelectionFromTop(messages.size() - 1, -100000 - chatListView.getPaddingTop());
                 scrollToTopOnResume = true;
+                if (AndroidUtilities.isTablet()) {
+                    actionBarLayer.hideActionMode();
+                }
             }
         }
     }
@@ -3366,10 +3445,10 @@ public boolean canPerformActions() {
                         @Override
                         public void didPressedImage(ChatMediaCell cell) {
                             MessageObject message = cell.getMessageObject();
-                            if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                            if (message.isSendError()) {
                                 createMenu(cell, false);
                                 return;
-                            } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                            } else if (message.isSending()) {
                                 return;
                             }
                             if (message.type == 1) {
@@ -3619,17 +3698,17 @@ public void update() {
 
             if (message.isFromMe()) {
                 if (halfCheckImage != null) {
-                    if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    if (message.isSending()) {
                         checkImage.setVisibility(View.INVISIBLE);
                         halfCheckImage.setImageResource(R.drawable.msg_clock);
                         halfCheckImage.setVisibility(View.VISIBLE);
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                    } else if (message.isSendError()) {
                         halfCheckImage.setVisibility(View.VISIBLE);
                         halfCheckImage.setImageResource(R.drawable.msg_warning);
                         if (checkImage != null) {
                             checkImage.setVisibility(View.INVISIBLE);
                         }
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                    } else if (message.isSent()) {
                         if (!message.messageOwner.unread) {
                             halfCheckImage.setVisibility(View.VISIBLE);
                             checkImage.setVisibility(View.VISIBLE);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
index 2b4834da5..1545a3e73 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
@@ -629,7 +629,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     count = info.participants.size();
                 }
 
-                if (count != 0 && onlineCount > 0) {
+                if (count != 0 && onlineCount > 1) {
                     onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%d %s</font>", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.getString("Online", R.string.Online))));
                 } else {
                     onlineText.setText(LocaleController.formatPluralString("Members", count));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
index 784963d5e..d97f49816 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
@@ -80,7 +80,7 @@ public void onReceive(Context arg0, Intent intent) {
             Runnable r = new Runnable() {
                 public void run() {
                     try {
-                        if (currentDir == null){
+                        if (currentDir == null) {
                             listRoots();
                         } else {
                             listFiles(currentDir);
@@ -159,13 +159,22 @@ public void onItemClick(int id) {
                 public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                     ListItem item = items.get(i);
                     File file = item.file;
-                    if (file.isDirectory()) {
+                    if (file == null) {
+                        HistoryEntry he = history.remove(history.size() - 1);
+                        actionBarLayer.setTitle(he.title);
+                        if (he.dir != null) {
+                            listFiles(he.dir);
+                        } else {
+                            listRoots();
+                        }
+                        listView.setSelectionFromTop(he.scrollItem, he.scrollOffset);
+                    } else if (file.isDirectory()) {
                         HistoryEntry he = new HistoryEntry();
                         he.scrollItem = listView.getFirstVisiblePosition();
                         he.scrollOffset = listView.getChildAt(0).getTop();
                         he.dir = currentDir;
                         he.title = actionBarLayer.getTitle().toString();
-                        if (!listFiles(file)){
+                        if (!listFiles(file)) {
                             return;
                         }
                         history.add(he);
@@ -212,7 +221,7 @@ public void onResume() {
 
     @Override
     public boolean onBackPressed() {
-        if (history.size() > 0){
+        if (history.size() > 0) {
             HistoryEntry he = history.remove(history.size() - 1);
             actionBarLayer.setTitle(he.title);
             if (he.dir != null) {
@@ -240,7 +249,7 @@ private boolean listFiles(File dir) {
                     currentDir = dir;
                     items.clear();
                     String state = Environment.getExternalStorageState();
-                    if (Environment.MEDIA_SHARED.equals(state)){
+                    if (Environment.MEDIA_SHARED.equals(state)) {
                         emptyView.setText(LocaleController.getString("UsbActive", R.string.UsbActive));
                     } else {
                         emptyView.setText(LocaleController.getString("NotMounted", R.string.NotMounted));
@@ -273,6 +282,15 @@ public int compare(File lhs, File rhs) {
                     return lhs.isDirectory() ? -1 : 1;
                 }
                 return lhs.getName().compareToIgnoreCase(rhs.getName());
+                /*long lm = lhs.lastModified();
+                long rm = lhs.lastModified();
+                if (lm == rm) {
+                    return 0;
+                } else if (lm > rm) {
+                    return -1;
+                } else {
+                    return 1;
+                }*/
             }
         });
         for (File file : files) {
@@ -296,6 +314,12 @@ public int compare(File lhs, File rhs) {
             }
             items.add(item);
         }
+        ListItem item = new ListItem();
+        item.title = "..";
+        item.subtitle = "";
+        item.icon = R.drawable.ic_directory;
+        item.file = null;
+        items.add(0, item);
         listAdapter.notifyDataSetChanged();
         return true;
     }
@@ -374,10 +398,25 @@ private void listRoots() {
         fs.icon = R.drawable.ic_directory;
         fs.file = new File("/");
         items.add(fs);
+
+        try {
+            File telegramPath = new File(Environment.getExternalStorageDirectory(), LocaleController.getString("AppName", R.string.AppName));
+            if (telegramPath.exists()) {
+                fs = new ListItem();
+                fs.title = LocaleController.getString("AppName", R.string.AppName);
+                fs.subtitle = telegramPath.toString();
+                fs.icon = R.drawable.ic_directory;
+                fs.file = telegramPath;
+                items.add(fs);
+            }
+        } catch (Exception e) {
+            FileLog.e("tmessages", e);
+        }
+
         listAdapter.notifyDataSetChanged();
     }
 
-    private String getRootSubtitle(String path){
+    private String getRootSubtitle(String path) {
         StatFs stat = new StatFs(path);
         long total = (long)stat.getBlockCount() * (long)stat.getBlockSize();
         long free = (long)stat.getAvailableBlocks() * (long)stat.getBlockSize();
@@ -409,11 +448,11 @@ public long getItemId(int position) {
             return 0;
         }
 
-        public int getViewTypeCount(){
+        public int getViewTypeCount() {
             return 2;
         }
 
-        public int getItemViewType(int pos){
+        public int getItemViewType(int pos) {
             return items.get(pos).subtitle.length() > 0 ? 0 : 1;
         }
 
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
index a67f2c0e0..2802b1b59 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
@@ -115,7 +115,35 @@ protected void onCreate(Bundle savedInstanceState) {
             shadowTablet.setOnTouchListener(new View.OnTouchListener() {
                 @Override
                 public boolean onTouch(View v, MotionEvent event) {
-                    return true;
+                    if (!actionBarLayout.fragmentsStack.isEmpty() && event.getAction() == MotionEvent.ACTION_UP) {
+                        float x = event.getX();
+                        float y = event.getY();
+                        int location[] = new int[2];
+                        layersActionBarLayout.getLocationOnScreen(location);
+                        int viewX = location[0];
+                        int viewY = location[1];
+
+                        if (x > viewX && x < viewX + layersActionBarLayout.getWidth() && y > viewY && y < viewY + layersActionBarLayout.getHeight()) {
+                            return false;
+                        } else {
+                            if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                                for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                                    layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                                    a--;
+                                }
+                                layersActionBarLayout.closeLastFragment(true);
+                            }
+                            return true;
+                        }
+                    }
+                    return false;
+                }
+            });
+
+            shadowTablet.setOnClickListener(new View.OnClickListener() {
+                @Override
+                public void onClick(View v) {
+
                 }
             });
 
@@ -514,7 +542,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
                 Bundle args = new Bundle();
                 args.putInt("user_id", push_user_id);
                 ChatActivity fragment = new ChatActivity(args);
-                if (actionBarLayout.presentFragment(fragment, false, true)) {
+                if (actionBarLayout.presentFragment(fragment, false, true, true)) {
                     pushOpened = true;
                 }
             }
@@ -522,14 +550,14 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
             Bundle args = new Bundle();
             args.putInt("chat_id", push_chat_id);
             ChatActivity fragment = new ChatActivity(args);
-            if (actionBarLayout.presentFragment(fragment, false, true)) {
+            if (actionBarLayout.presentFragment(fragment, false, true, true)) {
                 pushOpened = true;
             }
         } else if (push_enc_id != 0) {
             Bundle args = new Bundle();
             args.putInt("enc_id", push_enc_id);
             ChatActivity fragment = new ChatActivity(args);
-            if (actionBarLayout.presentFragment(fragment, false, true)) {
+            if (actionBarLayout.presentFragment(fragment, false, true, true)) {
                 pushOpened = true;
             }
         } else if (showDialogsList) {
@@ -541,28 +569,42 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
             isNew = false;
         }
         if (videoPath != null || photoPathsArray != null || sendingText != null || documentsPathsArray != null || contactsToSend != null) {
-            NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats);
+            if (!AndroidUtilities.isTablet()) {
+                NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats);
+            }
             Bundle args = new Bundle();
             args.putBoolean("onlySelect", true);
             args.putString("selectAlertString", LocaleController.getString("SendMessagesTo", R.string.SendMessagesTo));
             MessagesActivity fragment = new MessagesActivity(args);
             fragment.setDelegate(this);
-            actionBarLayout.presentFragment(fragment, false, true);
+            actionBarLayout.presentFragment(fragment, false, true, true);
             pushOpened = true;
             if (PhotoViewer.getInstance().isVisible()) {
-                PhotoViewer.getInstance().closePhoto(true);
+                PhotoViewer.getInstance().closePhoto(false);
             }
         }
         if (open_settings != 0) {
-            actionBarLayout.presentFragment(new SettingsActivity(), false, true);
+            actionBarLayout.presentFragment(new SettingsActivity(), false, true, true);
             pushOpened = true;
         }
         if (!pushOpened && !isNew) {
-            if (actionBarLayout.fragmentsStack.isEmpty()) {
-                if (!UserConfig.isClientActivated()) {
-                    actionBarLayout.addFragmentToStack(new LoginActivity());
+            if (AndroidUtilities.isTablet()) {
+                if (UserConfig.isClientActivated()) {
+                    if (actionBarLayout.fragmentsStack.isEmpty()) {
+                        actionBarLayout.addFragmentToStack(new MessagesActivity(null));
+                    }
                 } else {
-                    actionBarLayout.addFragmentToStack(new MessagesActivity(null));
+                    if (layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        layersActionBarLayout.addFragmentToStack(new LoginActivity());
+                    }
+                }
+            } else {
+                if (actionBarLayout.fragmentsStack.isEmpty()) {
+                    if (!UserConfig.isClientActivated()) {
+                        actionBarLayout.addFragmentToStack(new LoginActivity());
+                    } else {
+                        actionBarLayout.addFragmentToStack(new MessagesActivity(null));
+                    }
                 }
             }
             actionBarLayout.showLastFragment();
@@ -589,7 +631,9 @@ public void didSelectDialog(MessagesActivity messageFragment, long dialog_id, bo
 
             Bundle args = new Bundle();
             args.putBoolean("scrollToTopOnResume", true);
-            NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats);
+            if (!AndroidUtilities.isTablet()) {
+                NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats);
+            }
             if (lower_part != 0) {
                 if (high_id == 1) {
                     args.putInt("chat_id", lower_part);
@@ -604,22 +648,40 @@ public void didSelectDialog(MessagesActivity messageFragment, long dialog_id, bo
                 args.putInt("enc_id", high_id);
             }
             ChatActivity fragment = new ChatActivity(args);
-            actionBarLayout.presentFragment(fragment, true);
+
             if (videoPath != null) {
-                fragment.processSendingVideo(videoPath, null, 0, 0, 0, 0);
-            }
-            if (sendingText != null) {
-                fragment.processSendingText(sendingText);
-            }
-            if (photoPathsArray != null) {
-                fragment.processSendingPhotos(null, photoPathsArray);
-            }
-            if (documentsPathsArray != null) {
-                fragment.processSendingDocuments(documentsPathsArray, documentsOriginalPathsArray);
-            }
-            if (contactsToSend != null && !contactsToSend.isEmpty()) {
-                for (TLRPC.User user : contactsToSend) {
-                    SendMessagesHelper.getInstance().sendMessage(user, dialog_id);
+                if(android.os.Build.VERSION.SDK_INT >= 16) {
+                    if (AndroidUtilities.isTablet()) {
+                        actionBarLayout.presentFragment(fragment, false, true, true);
+                    }
+
+                    Bundle args2 = new Bundle();
+                    args2.putString("videoPath", videoPath);
+                    VideoEditorActivity fragment2 = new VideoEditorActivity(args2);
+                    fragment2.setDelegate(fragment);
+                    presentFragment(fragment2, true, true);
+                    if (!AndroidUtilities.isTablet()) {
+                        actionBarLayout.addFragmentToStack(fragment, actionBarLayout.fragmentsStack.size() - 1);
+                    }
+                } else {
+                    actionBarLayout.presentFragment(fragment, true);
+                    fragment.processSendingVideo(videoPath, 0, 0, 0, 0, null);
+                }
+            } else {
+                actionBarLayout.presentFragment(fragment, true);
+                if (sendingText != null) {
+                    fragment.processSendingText(sendingText);
+                }
+                if (photoPathsArray != null) {
+                    fragment.processSendingPhotos(null, photoPathsArray);
+                }
+                if (documentsPathsArray != null) {
+                    fragment.processSendingDocuments(documentsPathsArray, documentsOriginalPathsArray);
+                }
+                if (contactsToSend != null && !contactsToSend.isEmpty()) {
+                    for (TLRPC.User user : contactsToSend) {
+                        SendMessagesHelper.getInstance().sendMessage(user, dialog_id);
+                    }
                 }
             }
 
@@ -647,7 +709,7 @@ public void presentFragment(BaseFragment fragment) {
     }
 
     public boolean presentFragment(final BaseFragment fragment, final boolean removeLast, boolean forceWithoutAnimation) {
-        return actionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation);
+        return actionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation, true);
     }
 
     public void needLayout() {
@@ -680,18 +742,18 @@ public void needLayout() {
                 relativeLayoutParams.leftMargin = leftWidth;
                 buttonLayoutTablet.setLayoutParams(relativeLayoutParams);
 
-                if (AndroidUtilities.isSmallTablet() && mainFragmentsStack.size() == 2) {
-                    BaseFragment chatFragment = mainFragmentsStack.get(1);
-                    mainFragmentsStack.remove(1);
+                if (AndroidUtilities.isSmallTablet() && actionBarLayout.fragmentsStack.size() == 2) {
+                    BaseFragment chatFragment = actionBarLayout.fragmentsStack.get(1);
+                    actionBarLayout.fragmentsStack.remove(1);
                     actionBarLayout.showLastFragment();
-                    rightFragmentsStack.add(chatFragment);
+                    rightActionBarLayout.fragmentsStack.add(chatFragment);
                     rightActionBarLayout.showLastFragment();
                 }
 
-                rightActionBarLayout.setVisibility(rightFragmentsStack.isEmpty() ? View.GONE : View.VISIBLE);
-                buttonLayoutTablet.setVisibility(!mainFragmentsStack.isEmpty() && rightFragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
-                backgroundTablet.setVisibility(rightFragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
-                shadowTabletSide.setVisibility(!mainFragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
+                rightActionBarLayout.setVisibility(rightActionBarLayout.fragmentsStack.isEmpty() ? View.GONE : View.VISIBLE);
+                buttonLayoutTablet.setVisibility(!actionBarLayout.fragmentsStack.isEmpty() && rightActionBarLayout.fragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
+                backgroundTablet.setVisibility(rightActionBarLayout.fragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
+                shadowTabletSide.setVisibility(!actionBarLayout.fragmentsStack.isEmpty() ? View.VISIBLE : View.GONE);
             } else {
                 tabletFullSize = true;
 
@@ -702,13 +764,13 @@ public void needLayout() {
 
                 shadowTabletSide.setVisibility(View.GONE);
                 rightActionBarLayout.setVisibility(View.GONE);
-                backgroundTablet.setVisibility(View.GONE);
+                backgroundTablet.setVisibility(!actionBarLayout.fragmentsStack.isEmpty() ? View.GONE : View.VISIBLE);
                 buttonLayoutTablet.setVisibility(View.GONE);
 
-                if (rightFragmentsStack.size() == 1) {
-                    BaseFragment chatFragment = rightFragmentsStack.get(0);
-                    rightFragmentsStack.remove(0);
-                    actionBarLayout.presentFragment(chatFragment, false, true);
+                if (rightActionBarLayout.fragmentsStack.size() == 1) {
+                    BaseFragment chatFragment = rightActionBarLayout.fragmentsStack.get(0);
+                    rightActionBarLayout.fragmentsStack.remove(0);
+                    actionBarLayout.presentFragment(chatFragment, false, true, false);
                 }
             }
         }
@@ -716,15 +778,16 @@ public void needLayout() {
 
     public void fixLayout() {
         if (AndroidUtilities.isTablet()) {
-            final ViewTreeObserver obs = actionBarLayout.getViewTreeObserver();
-            obs.addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
+            actionBarLayout.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
                 @Override
                 public void onGlobalLayout() {
                     needLayout();
-                    if (Build.VERSION.SDK_INT < 16) {
-                        obs.removeGlobalOnLayoutListener(this);
-                    } else {
-                        obs.removeOnGlobalLayoutListener(this);
+                    if (actionBarLayout != null) {
+                        if (Build.VERSION.SDK_INT < 16) {
+                            actionBarLayout.getViewTreeObserver().removeGlobalOnLayoutListener(this);
+                        } else {
+                            actionBarLayout.getViewTreeObserver().removeOnGlobalLayoutListener(this);
+                        }
                     }
                 }
             });
@@ -831,8 +894,22 @@ public void didReceivedNotification(int id, Object... args) {
     protected void onSaveInstanceState(Bundle outState) {
         try {
             super.onSaveInstanceState(outState);
-            if (!actionBarLayout.fragmentsStack.isEmpty()) {
-                BaseFragment lastFragment = actionBarLayout.fragmentsStack.get(actionBarLayout.fragmentsStack.size() - 1);
+            BaseFragment lastFragment = null;
+            if (AndroidUtilities.isTablet()) {
+                if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                    lastFragment = layersActionBarLayout.fragmentsStack.get(layersActionBarLayout.fragmentsStack.size() - 1);
+                } else if (!rightActionBarLayout.fragmentsStack.isEmpty()) {
+                    lastFragment = rightActionBarLayout.fragmentsStack.get(rightActionBarLayout.fragmentsStack.size() - 1);
+                } else if (!actionBarLayout.fragmentsStack.isEmpty()) {
+                    lastFragment = actionBarLayout.fragmentsStack.get(actionBarLayout.fragmentsStack.size() - 1);
+                }
+            } else {
+                if (!actionBarLayout.fragmentsStack.isEmpty()) {
+                    lastFragment = actionBarLayout.fragmentsStack.get(actionBarLayout.fragmentsStack.size() - 1);
+                }
+            }
+
+            if (lastFragment != null) {
                 Bundle args = lastFragment.getArguments();
                 if (lastFragment instanceof ChatActivity && args != null) {
                     outState.putBundle("args", args);
@@ -943,35 +1020,56 @@ public boolean needPresentFragment(BaseFragment fragment, boolean removeLast, bo
                 MessagesActivity messagesActivity = (MessagesActivity)fragment;
                 if (messagesActivity.getDelegate() == null && layout != actionBarLayout) {
                     actionBarLayout.removeAllFragments();
-                    actionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation);
+                    actionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation, false);
                     layersActionBarLayout.removeAllFragments();
                     layersActionBarLayout.setVisibility(View.GONE);
                     if (!tabletFullSize) {
                         shadowTabletSide.setVisibility(View.VISIBLE);
-                        if (rightFragmentsStack.isEmpty()) {
+                        if (rightActionBarLayout.fragmentsStack.isEmpty()) {
                             buttonLayoutTablet.setVisibility(View.VISIBLE);
                             backgroundTablet.setVisibility(View.VISIBLE);
                         }
                     }
                     return false;
                 }
-            } else if (fragment instanceof ChatActivity) {
+            }
+            if (fragment instanceof ChatActivity) {
                 if (!tabletFullSize && layout != rightActionBarLayout) {
                     rightActionBarLayout.setVisibility(View.VISIBLE);
                     buttonLayoutTablet.setVisibility(View.GONE);
                     backgroundTablet.setVisibility(View.GONE);
                     rightActionBarLayout.removeAllFragments();
-                    rightActionBarLayout.presentFragment(fragment, removeLast, true);
-                    if (removeLast) {
-                        layout.closeLastFragment(true);
+                    rightActionBarLayout.presentFragment(fragment, removeLast, true, false);
+                    if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                            layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                            a--;
+                        }
+                        layersActionBarLayout.closeLastFragment(!forceWithoutAnimation);
                     }
                     return false;
                 } else if (tabletFullSize && layout != actionBarLayout) {
-                    actionBarLayout.presentFragment(fragment, false, forceWithoutAnimation);
-                    if (removeLast) {
-                        layout.closeLastFragment(true);
+                    actionBarLayout.presentFragment(fragment, actionBarLayout.fragmentsStack.size() > 1, forceWithoutAnimation, false);
+                    if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                            layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                            a--;
+                        }
+                        layersActionBarLayout.closeLastFragment(!forceWithoutAnimation);
                     }
                     return false;
+                } else {
+                    if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                            layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                            a--;
+                        }
+                        layersActionBarLayout.closeLastFragment(!forceWithoutAnimation);
+                    }
+                    if (actionBarLayout.fragmentsStack.size() > 1) {
+                        actionBarLayout.presentFragment(fragment, actionBarLayout.fragmentsStack.size() > 1, forceWithoutAnimation, false);
+                        return false;
+                    }
                 }
             } else if (layout != layersActionBarLayout) {
                 layersActionBarLayout.setVisibility(View.VISIBLE);
@@ -983,7 +1081,7 @@ public boolean needPresentFragment(BaseFragment fragment, boolean removeLast, bo
                 } else {
                     shadowTablet.setBackgroundColor(0x7F000000);
                 }
-                layersActionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation);
+                layersActionBarLayout.presentFragment(fragment, removeLast, forceWithoutAnimation, false);
                 return false;
             }
             return true;
@@ -1004,7 +1102,7 @@ public boolean needAddFragmentToStack(BaseFragment fragment, ActionBarLayout lay
                     layersActionBarLayout.setVisibility(View.GONE);
                     if (!tabletFullSize) {
                         shadowTabletSide.setVisibility(View.VISIBLE);
-                        if (rightFragmentsStack.isEmpty()) {
+                        if (rightActionBarLayout.fragmentsStack.isEmpty()) {
                             buttonLayoutTablet.setVisibility(View.VISIBLE);
                             backgroundTablet.setVisibility(View.VISIBLE);
                         }
@@ -1018,9 +1116,23 @@ public boolean needAddFragmentToStack(BaseFragment fragment, ActionBarLayout lay
                     backgroundTablet.setVisibility(View.GONE);
                     rightActionBarLayout.removeAllFragments();
                     rightActionBarLayout.addFragmentToStack(fragment);
+                    if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                            layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                            a--;
+                        }
+                        layersActionBarLayout.closeLastFragment(true);
+                    }
                     return false;
                 } else if (tabletFullSize && layout != actionBarLayout) {
                     actionBarLayout.addFragmentToStack(fragment);
+                    if (!layersActionBarLayout.fragmentsStack.isEmpty()) {
+                        for (int a = 0; a < layersActionBarLayout.fragmentsStack.size() - 1; a++) {
+                            layersActionBarLayout.removeFragmentFromStack(layersActionBarLayout.fragmentsStack.get(0));
+                            a--;
+                        }
+                        layersActionBarLayout.closeLastFragment(true);
+                    }
                     return false;
                 }
             } else if (layout != layersActionBarLayout) {
@@ -1054,6 +1166,10 @@ public boolean needCloseLastFragment(ActionBarLayout layout) {
                     buttonLayoutTablet.setVisibility(View.VISIBLE);
                     backgroundTablet.setVisibility(View.VISIBLE);
                 }
+            } else if (layout == layersActionBarLayout && actionBarLayout.fragmentsStack.isEmpty()) {
+                onFinish();
+                finish();
+                return false;
             }
         } else {
             if (layout.fragmentsStack.size() <= 1) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
index 16de820dd..552f17527 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
@@ -366,6 +366,9 @@ public void onClick(DialogInterface dialog, int which) {
                                         public void onClick(DialogInterface dialogInterface, int i) {
                                             MessagesController.getInstance().deleteUserFromChat((int) -selectedDialog, MessagesController.getInstance().getUser(UserConfig.getClientUserId()), null);
                                             MessagesController.getInstance().deleteDialog(selectedDialog, 0, false);
+                                            if (AndroidUtilities.isTablet()) {
+                                                NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats, selectedDialog);
+                                            }
                                         }
                                     });
                                     builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
@@ -387,6 +390,9 @@ public void onClick(DialogInterface dialog, int which) {
                                         @Override
                                         public void onClick(DialogInterface dialogInterface, int i) {
                                             MessagesController.getInstance().deleteDialog(selectedDialog, 0, false);
+                                            if (AndroidUtilities.isTablet()) {
+                                                NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats, selectedDialog);
+                                            }
                                         }
                                     });
                                     builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
@@ -486,7 +492,15 @@ public void didReceivedNotification(int id, Object... args) {
             updateVisibleRows(0);
         } else if (id == NotificationCenter.openedChatChanged) {
             if (!serverOnly && AndroidUtilities.isTablet()) {
-                openedDialogId = (Long)args[0];
+                boolean close = (Boolean)args[1];
+                long dialog_id = (Long)args[0];
+                if (close) {
+                    if (dialog_id == openedDialogId) {
+                        openedDialogId = 0;
+                    }
+                } else {
+                    openedDialogId = dialog_id;
+                }
                 updateVisibleRows(0);
             }
         }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
index 91c0b1beb..d65194d49 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
@@ -288,6 +288,7 @@ public PhotoCropActivity(Bundle args) {
 
     @Override
     public boolean onFragmentCreate() {
+        swipeBackEnabled = false;
         String photoPath = getArguments().getString("photoPath");
         Uri photoUri = getArguments().getParcelable("photoUri");
         if (photoPath == null && photoUri == null) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
index 15c7a5811..09f3e673a 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
@@ -509,10 +509,16 @@ public void onItemClick(int id) {
                 if (id == -1) {
                     closePhoto(true);
                 } else if (id == gallery_menu_save) {
-                    if (currentFileName == null) {
-                        return;
+                    File f = null;
+                    if (currentMessageObject != null) {
+                        f = FileLoader.getPathToMessage(currentMessageObject.messageOwner);
+                    } else if (currentFileLocation != null) {
+                        f = FileLoader.getPathToAttach(currentFileLocation);
+                    }
+
+                    if (f != null && f.exists()) {
+                        MediaController.saveFile(f.toString(), parentActivity, currentFileName.endsWith("mp4") ? 1 : 0, null);
                     }
-                    MediaController.saveFile(currentFileName, null, parentActivity, currentFileName.endsWith("mp4") ? 1 : 0, null);
                 } else if (id == gallery_menu_showall) {
                     if (opennedFromMedia) {
                         closePhoto(true);
@@ -645,7 +651,7 @@ public void onClick(View v) {
                         return;
                     }
                     MessageObject obj = imagesArr.get(currentIndex);
-                    if (obj.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                    if (obj.isSent()) {
                         ArrayList<Integer> arr = new ArrayList<Integer>();
                         arr.add(obj.messageOwner.id);
                         MessagesController.getInstance().deleteMessages(arr, null, null);
@@ -945,7 +951,7 @@ private String getFileName(int index, TLRPC.InputFileLocation fileLocation) {
                 if (message.messageOwner.action instanceof TLRPC.TL_messageActionUserUpdatedPhoto) {
                     return message.messageOwner.action.newUserPhoto.photo_big;
                 } else {
-                    TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.action.photo.sizes, 800, 800);
+                    TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.action.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                     if (sizeFull != null) {
                         size[0] = sizeFull.size;
                         if (size[0] == 0) {
@@ -957,7 +963,7 @@ private String getFileName(int index, TLRPC.InputFileLocation fileLocation) {
                     }
                 }
             } else if (message.messageOwner.media instanceof TLRPC.TL_messageMediaPhoto && message.messageOwner.media.photo != null) {
-                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, 800, 800);
+                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     size[0] = sizeFull.size;
                     if (size[0] == 0) {
@@ -1008,7 +1014,7 @@ private String getFileName(int index, TLRPC.InputFileLocation fileLocation) {
                     location.secret = sizeFull.secret;
                     return location;
                 } else {
-                    TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.action.photo.sizes, 800, 800);
+                    TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.action.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                     if (sizeFull != null) {
                         TLRPC.TL_inputFileLocation location = new TLRPC.TL_inputFileLocation();
                         location.local_id = sizeFull.location.local_id;
@@ -1019,7 +1025,7 @@ private String getFileName(int index, TLRPC.InputFileLocation fileLocation) {
                     }
                 }
             } else if (message.messageOwner.media instanceof TLRPC.TL_messageMediaPhoto) {
-                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, 800, 800);
+                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     TLRPC.TL_inputFileLocation location = new TLRPC.TL_inputFileLocation();
                     location.local_id = sizeFull.location.local_id;
@@ -1061,7 +1067,7 @@ private void updateActionOverlays() {
             return;
         }
         if (currentFileName.endsWith("mp4")) {
-            if (currentMessageObject.messageOwner.send_state != MessageObject.MESSAGE_SEND_STATE_SENDING && currentMessageObject.messageOwner.send_state != MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+            if (!currentMessageObject.isSending() && !currentMessageObject.isSendError()) {
                 currentOverlay.setVisibility(View.VISIBLE);
                 boolean load = false;
                 if (currentMessageObject.messageOwner.attachPath != null && currentMessageObject.messageOwner.attachPath.length() != 0) {
@@ -1370,7 +1376,7 @@ private void setIndexToImage(ImageReceiver imageReceiver, int index) {
                 if (currentThumb != null && imageReceiver == centerImage) {
                     placeHolder = currentThumb;
                 }
-                int size = (int)(800 / AndroidUtilities.density);
+                int size = (int)(AndroidUtilities.getPhotoSize() / AndroidUtilities.density);
                 imageReceiver.setImage(photoEntry.path, String.format(Locale.US, "%d_%d", size, size), placeHolder != null ? new BitmapDrawable(null, placeHolder) : null);
             } else {
                 imageReceiver.setImageBitmap((Bitmap) null);
@@ -1393,7 +1399,7 @@ private void setIndexToImage(ImageReceiver imageReceiver, int index) {
                         if (currentThumb != null && imageReceiver == centerImage) {
                             placeHolder = currentThumb;
                         }
-                        imageReceiver.setImage(fileLocation, null, placeHolder != null ? new BitmapDrawable(null, placeHolder) : null, size[0]);
+                        imageReceiver.setImage(fileLocation, null, placeHolder != null ? new BitmapDrawable(null, placeHolder) : null, 0);
                     } else {
                         imageReceiver.setImageBitmap(parentActivity.getResources().getDrawable(R.drawable.photoview_placeholder));
                     }
@@ -1405,6 +1411,9 @@ private void setIndexToImage(ImageReceiver imageReceiver, int index) {
                     if (currentThumb != null && imageReceiver == centerImage) {
                         placeHolder = currentThumb;
                     }
+                    if (size[0] == 0) {
+                        size[0] = -1;
+                    }
                     imageReceiver.setImage(fileLocation, null, placeHolder != null ? new BitmapDrawable(null, placeHolder) : null, size[0]);
                 }
             } else {
@@ -2306,7 +2315,7 @@ private void onActionClick(View view) {
         }
         if (loadFile) {
             if (!FileLoader.getInstance().isLoadingFile(currentFileName)) {
-                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.video);
+                FileLoader.getInstance().loadFile(currentMessageObject.messageOwner.media.video, true);
             } else {
                 FileLoader.getInstance().cancelLoadFile(currentMessageObject.messageOwner.media.video);
             }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
index 00432144d..c21aea9dc 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
@@ -445,7 +445,7 @@ public void onClick(View v) {
             TextView messageText = (TextView)view.findViewById(R.id.message_text);
             BackupImageView imageView = (BackupImageView) view.findViewById(R.id.message_image);
             imageView.imageReceiver.setAspectFit(true);
-            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, 800, 800);
+            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
             boolean photoSet = false;
             if (currentPhotoObject != null) {
                 boolean photoExist = true;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
index a635e53b1..2a6ff7931 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
@@ -183,7 +183,7 @@ public void onClick(DialogInterface dialog, int which) {
                             }
 
                             tmpIntent.putExtra(RingtoneManager.EXTRA_RINGTONE_EXISTING_URI, currentSound);
-                            getParentActivity().startActivityForResult(tmpIntent, 12);
+                            startActivityForResult(tmpIntent, 12);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
index 54a70125c..b3d3954b7 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
@@ -92,6 +92,7 @@
     private int mobileDownloadRow;
     private int wifiDownloadRow;
     private int roamingDownloadRow;
+    private int saveToGalleryRow;
     private int telegramFaqRow;
     private int languageRow;
     private int versionRow;
@@ -190,6 +191,7 @@ public void run() {
         mobileDownloadRow = rowCount++;
         wifiDownloadRow = rowCount++;
         roamingDownloadRow = rowCount++;
+        saveToGalleryRow = rowCount++;
         messagesSectionRow = rowCount++;
         textSizeRow = rowCount++;
         sendByEnterRow = rowCount++;
@@ -336,6 +338,11 @@ public void onClick(DialogInterface dialogInterface, int i) {
                         if (listView != null) {
                             listView.invalidateViews();
                         }
+                    } else if (i == saveToGalleryRow) {
+                        MediaController.getInstance().toggleSaveToGallery();
+                        if (listView != null) {
+                            listView.invalidateViews();
+                        }
                     } else if (i == terminateSessionsRow) {
                         if (getParentActivity() == null) {
                             return;
@@ -728,7 +735,7 @@ public boolean isEnabled(int i) {
             return i == textSizeRow || i == enableAnimationsRow || i == blockedRow || i == notificationRow || i == backgroundRow ||
                     i == askQuestionRow || i == sendLogsRow || i == sendByEnterRow || i == terminateSessionsRow || i == wifiDownloadRow ||
                     i == mobileDownloadRow || i == clearLogsRow || i == roamingDownloadRow || i == languageRow || i == enableMarkdownRow ||
-                    i == switchBackendButtonRow || i == telegramFaqRow || i == contactsSortRow || i == contactsReimportRow;
+                    i == switchBackendButtonRow || i == telegramFaqRow || i == contactsSortRow || i == contactsReimportRow || i == saveToGalleryRow;
         }
 
         @Override
@@ -941,18 +948,15 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     } else {
                         checkButton.setImageResource(R.drawable.btn_check_off);
                     }
+                } else if (i == saveToGalleryRow) {
+                    textView.setText(LocaleController.getString("SaveToGallerySettings", R.string.SaveToGallerySettings));
+                    divider.setVisibility(View.INVISIBLE);
+                    if (MediaController.getInstance().canSaveToGallery()) {
+                        checkButton.setImageResource(R.drawable.btn_check_on);
+                    } else {
+                        checkButton.setImageResource(R.drawable.btn_check_off);
+                    }
                 }
-//                if (i == 7) {
-//                    textView.setText(LocaleController.getString(R.string.SaveIncomingPhotos));
-//                    divider.setVisibility(View.INVISIBLE);
-//
-//                    ImageView checkButton = (ImageView)view.findViewById(R.id.settings_row_check_button);
-//                    if (UserConfig.saveIncomingPhotos) {
-//                        checkButton.setImageResource(R.drawable.btn_check_on);
-//                    } else {
-//                        checkButton.setImageResource(R.drawable.btn_check_off);
-//                    }
-//                }
             } else if (type == 4) {
                 if (view == null) {
                     LayoutInflater li = (LayoutInflater)mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
@@ -1052,7 +1056,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     mask = MediaController.getInstance().wifiDownloadMask;
                 } else if (i == roamingDownloadRow) {
                     textView.setText(LocaleController.getString("WhenRoaming", R.string.WhenRoaming));
-                    divider.setVisibility(View.GONE);
+                    divider.setVisibility(View.VISIBLE);
                     mask = MediaController.getInstance().roamingDownloadMask;
                 }
                 String text = "";
@@ -1093,7 +1097,7 @@ public int getItemViewType(int i) {
                 return 1;
             } else if (i == textSizeRow || i == languageRow || i == contactsSortRow) {
                 return 5;
-            } else if (i == enableAnimationsRow || i == sendByEnterRow ||i == enableMarkdownRow) {
+            } else if (i == enableAnimationsRow || i == sendByEnterRow ||i == enableMarkdownRow || i == saveToGalleryRow) {
                 return 3;
             } else if (i == numberRow || i == notificationRow || i == blockedRow || i == backgroundRow || i == askQuestionRow || i == sendLogsRow || i == terminateSessionsRow || i == clearLogsRow || i == switchBackendButtonRow || i == telegramFaqRow || i == contactsReimportRow) {
                 return 2;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
index 1cdeaac83..7d7c41aec 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
@@ -200,7 +200,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, final int i, long
                                 }
                             }
                             tmpIntent.putExtra(RingtoneManager.EXTRA_RINGTONE_EXISTING_URI, currentSound);
-                            getParentActivity().startActivityForResult(tmpIntent, i);
+                            startActivityForResult(tmpIntent, i);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
index 56a426b92..4ea34064e 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
@@ -184,11 +184,11 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                             takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(image));
                                             currentPicturePath = image.getAbsolutePath();
                                         }
-                                        getParentActivity().startActivityForResult(takePictureIntent, 10);
+                                        startActivityForResult(takePictureIntent, 10);
                                     } else if (i == 1) {
                                         Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
                                         photoPickerIntent.setType("image/*");
-                                        getParentActivity().startActivityForResult(photoPickerIntent, 11);
+                                        startActivityForResult(photoPickerIntent, 11);
                                     }
                                 } catch (Exception e) {
                                     FileLog.e("tmessages", e);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
index 9d74a6839..dd536e5a9 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
@@ -9,13 +9,10 @@
 package org.telegram.ui;
 
 import android.annotation.TargetApi;
+import android.app.Activity;
+import android.content.SharedPreferences;
 import android.content.res.Configuration;
 import android.graphics.SurfaceTexture;
-import android.media.MediaCodec;
-import android.media.MediaCodecInfo;
-import android.media.MediaCodecList;
-import android.media.MediaExtractor;
-import android.media.MediaFormat;
 import android.media.MediaPlayer;
 import android.os.Build;
 import android.os.Bundle;
@@ -26,37 +23,26 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.ViewTreeObserver;
+import android.widget.CheckBox;
+import android.widget.CompoundButton;
 import android.widget.FrameLayout;
 import android.widget.ImageView;
 import android.widget.TextView;
 
 import com.coremedia.iso.IsoFile;
 import com.coremedia.iso.boxes.Box;
-import com.coremedia.iso.boxes.Container;
 import com.coremedia.iso.boxes.MediaBox;
 import com.coremedia.iso.boxes.MediaHeaderBox;
 import com.coremedia.iso.boxes.SampleSizeBox;
 import com.coremedia.iso.boxes.TrackBox;
 import com.coremedia.iso.boxes.TrackHeaderBox;
-import com.coremedia.iso.boxes.h264.AvcConfigurationBox;
-import com.googlecode.mp4parser.authoring.Movie;
-import com.googlecode.mp4parser.authoring.Track;
-import com.googlecode.mp4parser.authoring.builder.DefaultMp4Builder;
-import com.googlecode.mp4parser.authoring.container.mp4.MovieCreator;
-import com.googlecode.mp4parser.authoring.tracks.CroppedTrack;
 import com.googlecode.mp4parser.util.Matrix;
 import com.googlecode.mp4parser.util.Path;
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
-import org.telegram.android.video.InputSurface;
-import org.telegram.android.video.MP4Builder;
-import org.telegram.android.video.Mp4Movie;
-import org.telegram.android.video.OutputSurface;
-import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.R;
-import org.telegram.messenger.UserConfig;
 import org.telegram.messenger.Utilities;
 import org.telegram.ui.Views.ActionBar.ActionBarLayer;
 import org.telegram.ui.Views.ActionBar.ActionBarMenu;
@@ -65,26 +51,11 @@
 import org.telegram.ui.Views.VideoTimelineView;
 
 import java.io.File;
-import java.io.FileOutputStream;
-import java.nio.ByteBuffer;
-import java.nio.channels.FileChannel;
-import java.util.Arrays;
-import java.util.LinkedList;
 import java.util.List;
 
 @TargetApi(16)
 public class VideoEditorActivity extends BaseFragment implements TextureView.SurfaceTextureListener {
 
-    private final static int OMX_TI_COLOR_FormatYUV420PackedSemiPlanar = 0x7F000100;
-    private final static int OMX_QCOM_COLOR_FormatYVU420SemiPlanar = 0x7FA30C00;
-    private final static int OMX_QCOM_COLOR_FormatYUV420PackedSemiPlanar64x32Tile2m8ka = 0x7FA30C03;
-    private final static int OMX_SEC_COLOR_FormatNV12Tiled = 0x7FC00002;
-    private final static int OMX_QCOM_COLOR_FormatYUV420PackedSemiPlanar32m = 0x7FA30C04;
-    private final static String MIME_TYPE = "video/avc";
-
-    private final static int PROCESSOR_TYPE_OTHER = 0;
-    private final static int PROCESSOR_TYPE_QCOM = 1;
-
     private MediaPlayer videoPlayer = null;
     private VideoTimelineView videoTimelineView = null;
     private View videoContainerView = null;
@@ -95,14 +66,16 @@
     private VideoSeekBarView videoSeekBarView = null;
     private TextureView textureView = null;
     private View controlView = null;
+    private CheckBox compressVideo = null;
+    private boolean playerPrepared = false;
 
     private String videoPath = null;
     private float lastProgress = 0;
     private boolean needSeek = false;
     private VideoEditorActivityDelegate delegate;
 
-    private boolean firstWrite = true;
-    //MediaMetadataRetriever TODO
+    private final Object sync = new Object();
+    private Thread thread = null;
 
     private int rotationValue = 0;
     private int originalWidth = 0;
@@ -117,20 +90,33 @@
     private int videoFramesSize = 0;
     private int estimatedSize = 0;
     private long esimatedDuration = 0;
+    private long originalSize = 0;
 
     public interface VideoEditorActivityDelegate {
-        public abstract void didStartVideoConverting(String videoPath, String originalPath, long estimatedSize, int duration, int width, int height);
-        public abstract void didAppenedVideoData(String videoPath, long finalSize);
+        public abstract void didFinishEditVideo(String videoPath, long startTime, long endTime, int resultWidth, int resultHeight, int rotationValue, int originalWidth, int originalHeight, int bitrate, long estimatedSize, long estimatedDuration);
     }
 
     private Runnable progressRunnable = new Runnable() {
         @Override
         public void run() {
-            while (videoPlayer != null && videoPlayer.isPlaying()) {
+            boolean playerCheck = false;
+
+            while (true) {
+                synchronized (sync) {
+                    try {
+                        playerCheck = videoPlayer != null && videoPlayer.isPlaying();
+                    } catch (Exception e) {
+                        playerCheck = false;
+                        FileLog.e("tmessages", e);
+                    }
+                }
+                if (!playerCheck) {
+                    break;
+                }
                 AndroidUtilities.RunOnUIThread(new Runnable() {
                     @Override
                     public void run() {
-                        if (videoPlayer.isPlaying()) {
+                        if (videoPlayer != null && videoPlayer.isPlaying()) {
                             float startTime = videoTimelineView.getLeftProgress() * videoDuration;
                             float endTime = videoTimelineView.getRightProgress() * videoDuration;
                             if (startTime == endTime) {
@@ -160,6 +146,9 @@ public void run() {
                     FileLog.e("tmessages", e);
                 }
             }
+            synchronized (sync) {
+                thread = null;
+            }
         }
     };
 
@@ -185,6 +174,21 @@ public void run() {
                 });
             }
         });
+        videoPlayer.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {
+            @Override
+            public void onPrepared(MediaPlayer mp) {
+                playerPrepared = true;
+                videoPlayer.seekTo((int) (videoTimelineView.getLeftProgress() * videoDuration));
+            }
+        });
+        try {
+            videoPlayer.setDataSource(videoPath);
+            videoPlayer.prepareAsync();
+        } catch (Exception e) {
+            FileLog.e("tmessages", e);
+            return false;
+        }
+
         return super.onFragmentCreate();
     }
 
@@ -193,6 +197,15 @@ public void onFragmentDestroy() {
         if (videoTimelineView != null) {
             videoTimelineView.destroy();
         }
+        if (videoPlayer != null) {
+            try {
+                videoPlayer.stop();
+                videoPlayer.release();
+                videoPlayer = null;
+            } catch (Exception e) {
+                FileLog.e("tmessages", e);
+            }
+        }
         super.onFragmentDestroy();
     }
 
@@ -209,21 +222,25 @@ public void onItemClick(int id) {
                     if (id == -1) {
                         finishFragment();
                     } else if (id == 1) {
-                        if (videoPlayer != null) {
-                            try {
-                                videoPlayer.stop();
-                                videoPlayer.release();
-                                videoPlayer = null;
-                            } catch (Exception e) {
-                                FileLog.e("tmessages", e);
+                        synchronized (sync) {
+                            if (videoPlayer != null) {
+                                try {
+                                    videoPlayer.stop();
+                                    videoPlayer.release();
+                                    videoPlayer = null;
+                                } catch (Exception e) {
+                                    FileLog.e("tmessages", e);
+                                }
                             }
                         }
-                        try {
-                            //startConvert();
-                            VideoEditWrapper.runTest(VideoEditorActivity.this);
-                        } catch (Exception e) {
-                            FileLog.e("tmessages", e);
+                        if (delegate != null) {
+                            if (compressVideo.getVisibility() == View.VISIBLE && !compressVideo.isChecked()) {
+                                delegate.didFinishEditVideo(videoPath, startTime, endTime, originalWidth, originalHeight, rotationValue, originalWidth, originalHeight, bitrate, estimatedSize, esimatedDuration);
+                            } else {
+                                delegate.didFinishEditVideo(videoPath, startTime, endTime, resultWidth, resultHeight, rotationValue, originalWidth, originalHeight, bitrate, estimatedSize, esimatedDuration);
+                            }
                         }
+                        finishFragment();
                     }
                 }
             });
@@ -240,6 +257,21 @@ public void onItemClick(int id) {
             videoContainerView = fragmentView.findViewById(R.id.video_container);
             textContainerView = fragmentView.findViewById(R.id.info_container);
             controlView = fragmentView.findViewById(R.id.control_layout);
+            compressVideo = (CheckBox) fragmentView.findViewById(R.id.compress_video);
+            compressVideo.setText(LocaleController.getString("CompressVideo", R.string.CompressVideo));
+            SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
+            compressVideo.setVisibility(originalHeight != resultHeight || originalWidth != resultWidth ? View.VISIBLE : View.GONE);
+            compressVideo.setChecked(preferences.getBoolean("compress_video", true));
+            compressVideo.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
+                @Override
+                public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
+                    SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
+                    SharedPreferences.Editor editor = preferences.edit();
+                    editor.putBoolean("compress_video", isChecked);
+                    editor.commit();
+                    updateVideoEditedInfo();
+                }
+            });
             TextView titleTextView = (TextView) fragmentView.findViewById(R.id.original_title);
             titleTextView.setText(LocaleController.getString("OriginalVideo", R.string.OriginalVideo));
             titleTextView = (TextView) fragmentView.findViewById(R.id.edited_title);
@@ -250,7 +282,7 @@ public void onItemClick(int id) {
             videoTimelineView.setDelegate(new VideoTimelineView.VideoTimelineViewDelegate() {
                 @Override
                 public void onLeftProgressChanged(float progress) {
-                    if (videoPlayer == null) {
+                    if (videoPlayer == null || !playerPrepared) {
                         return;
                     }
                     try {
@@ -270,7 +302,7 @@ public void onLeftProgressChanged(float progress) {
 
                 @Override
                 public void onRifhtProgressChanged(float progress) {
-                    if (videoPlayer == null) {
+                    if (videoPlayer == null || !playerPrepared) {
                         return;
                     }
                     try {
@@ -293,13 +325,19 @@ public void onRifhtProgressChanged(float progress) {
             videoSeekBarView.delegate = new VideoSeekBarView.SeekBarDelegate() {
                 @Override
                 public void onSeekBarDrag(float progress) {
-                    if (videoPlayer == null) {
+                    if (progress < videoTimelineView.getLeftProgress()) {
+                        progress = videoTimelineView.getLeftProgress();
+                        videoSeekBarView.setProgress(progress);
+                    } else if (progress > videoTimelineView.getRightProgress()) {
+                        progress = videoTimelineView.getRightProgress();
+                        videoSeekBarView.setProgress(progress);
+                    }
+                    if (videoPlayer == null || !playerPrepared) {
                         return;
                     }
                     if (videoPlayer.isPlaying()) {
                         try {
-                            float prog = videoTimelineView.getLeftProgress() + (videoTimelineView.getRightProgress() - videoTimelineView.getLeft()) * progress;
-                            videoPlayer.seekTo((int) (videoDuration * prog));
+                            videoPlayer.seekTo((int) (videoDuration * progress));
                             lastProgress = progress;
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
@@ -333,10 +371,25 @@ public void onClick(View v) {
         return fragmentView;
     }
 
+    private void setPlayerSurface() {
+        if (textureView == null || !textureView.isAvailable() || videoPlayer == null) {
+            return;
+        }
+        try {
+            Surface s = new Surface(textureView.getSurfaceTexture());
+            videoPlayer.setSurface(s);
+            if (playerPrepared) {
+                videoPlayer.seekTo((int) (videoTimelineView.getLeftProgress() * videoDuration));
+            }
+        } catch (Exception e) {
+            FileLog.e("tmessages", e);
+        }
+    }
+
     @Override
     public void onResume() {
         super.onResume();
-        fixLayout();
+        fixLayoutInternal();
     }
 
     @Override
@@ -347,18 +400,7 @@ public void onConfigurationChanged(Configuration newConfig) {
 
     @Override
     public void onSurfaceTextureAvailable(SurfaceTexture surface, int width, int height) {
-        if (videoPlayer == null) {
-            return;
-        }
-        try {
-            Surface s = new Surface(surface);
-            videoPlayer.setSurface(s);
-            videoPlayer.setDataSource(videoPath);
-            videoPlayer.prepare();
-            videoPlayer.seekTo((int) (videoTimelineView.getLeftProgress() * videoDuration));
-        } catch (Exception e) {
-            FileLog.e("tmessages", e);
-        }
+        setPlayerSurface();
     }
 
     @Override
@@ -396,13 +438,13 @@ private void updateVideoOriginalInfo() {
         if (originalSizeTextView == null) {
             return;
         }
-        File file = new File(videoPath);
         int width = rotationValue == 90 || rotationValue == 270 ? originalHeight : originalWidth;
         int height = rotationValue == 90 || rotationValue == 270 ? originalWidth : originalHeight;
         String videoDimension = String.format("%dx%d", width, height);
-        int minutes = (int)(videoDuration / 1000 / 60);
-        int seconds = (int) Math.ceil(videoDuration / 1000) - minutes * 60;
-        String videoTimeSize = String.format("%d:%02d, %s", minutes, seconds, Utilities.formatFileSize(file.length()));
+        long duration = (long)Math.ceil(videoDuration);
+        int minutes = (int)(duration / 1000 / 60);
+        int seconds = (int) Math.ceil(duration / 1000) - minutes * 60;
+        String videoTimeSize = String.format("%d:%02d, %s", minutes, seconds, Utilities.formatFileSize(originalSize));
         originalSizeTextView.setText(String.format("%s, %s", videoDimension, videoTimeSize));
     }
 
@@ -410,12 +452,21 @@ private void updateVideoEditedInfo() {
         if (editedSizeTextView == null) {
             return;
         }
-        int width = rotationValue == 90 || rotationValue == 270 ? resultHeight : resultWidth;
-        int height = rotationValue == 90 || rotationValue == 270 ? resultWidth : resultHeight;
-        String videoDimension = String.format("%dx%d", width, height);
+        esimatedDuration = (long)Math.ceil((videoTimelineView.getRightProgress() - videoTimelineView.getLeftProgress()) * videoDuration);
+
+        int width = 0;
+        int height = 0;
+
+        if (compressVideo.getVisibility() == View.VISIBLE && !compressVideo.isChecked()) {
+            width = rotationValue == 90 || rotationValue == 270 ? originalHeight : originalWidth;
+            height = rotationValue == 90 || rotationValue == 270 ? originalWidth : originalHeight;
+            estimatedSize = (int)(originalSize * ((float)esimatedDuration / videoDuration));
+        } else {
+            width = rotationValue == 90 || rotationValue == 270 ? resultHeight : resultWidth;
+            height = rotationValue == 90 || rotationValue == 270 ? resultWidth : resultHeight;
+            estimatedSize = calculateEstimatedSize((float)esimatedDuration / videoDuration);
+        }
 
-        esimatedDuration = (long)Math.max(1000, (videoTimelineView.getRightProgress() - videoTimelineView.getLeftProgress()) * videoDuration);
-        estimatedSize = calculateEstimatedSize((float)esimatedDuration / videoDuration);
         if (videoTimelineView.getLeftProgress() == 0) {
             startTime = -1;
         } else {
@@ -427,6 +478,7 @@ private void updateVideoEditedInfo() {
             endTime = (long) (videoTimelineView.getRightProgress() * videoDuration) * 1000;
         }
 
+        String videoDimension = String.format("%dx%d", width, height);
         int minutes = (int)(esimatedDuration / 1000 / 60);
         int seconds = (int) Math.ceil(esimatedDuration / 1000) - minutes * 60;
         String videoTimeSize = String.format("%d:%02d, ~%s", minutes, seconds, Utilities.formatFileSize(estimatedSize));
@@ -452,14 +504,14 @@ private void fixVideoSize() {
         int height = 0;
         if (AndroidUtilities.isTablet()) {
             width = AndroidUtilities.dp(490);
-            height = viewHeight - AndroidUtilities.dp(276);
+            height = viewHeight - AndroidUtilities.dp(276 + (compressVideo.getVisibility() == View.VISIBLE ? 20 : 0));
         } else {
             if (getParentActivity().getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
                 width = AndroidUtilities.displaySize.x / 3 - AndroidUtilities.dp(24);
                 height = viewHeight - AndroidUtilities.dp(32);
             } else {
                 width = AndroidUtilities.displaySize.x;
-                height = viewHeight - AndroidUtilities.dp(276);
+                height = viewHeight - AndroidUtilities.dp(276 + (compressVideo.getVisibility() == View.VISIBLE ? 20 : 0));
             }
         }
 
@@ -477,76 +529,87 @@ private void fixVideoSize() {
             height = (int) (width / ar);
         }
 
-        FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)textureView.getLayoutParams();
-        layoutParams.width = width;
-        layoutParams.height = height;
-        layoutParams.leftMargin = 0;
-        layoutParams.topMargin = 0;
-        textureView.setLayoutParams(layoutParams);
+        if (textureView != null) {
+            FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) textureView.getLayoutParams();
+            layoutParams.width = width;
+            layoutParams.height = height;
+            layoutParams.leftMargin = 0;
+            layoutParams.topMargin = 0;
+            textureView.setLayoutParams(layoutParams);
+        }
+    }
+
+    private void fixLayoutInternal() {
+        if (!AndroidUtilities.isTablet() && getParentActivity().getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
+            FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) videoContainerView.getLayoutParams();
+            layoutParams.topMargin = AndroidUtilities.dp(16);
+            layoutParams.bottomMargin = AndroidUtilities.dp(16);
+            layoutParams.width = AndroidUtilities.displaySize.x / 3 - AndroidUtilities.dp(24);
+            layoutParams.leftMargin = AndroidUtilities.dp(16);
+            videoContainerView.setLayoutParams(layoutParams);
+
+            layoutParams = (FrameLayout.LayoutParams) controlView.getLayoutParams();
+            layoutParams.topMargin = AndroidUtilities.dp(16);
+            layoutParams.bottomMargin = 0;
+            layoutParams.width = AndroidUtilities.displaySize.x / 3 * 2 - AndroidUtilities.dp(32);
+            layoutParams.leftMargin = AndroidUtilities.displaySize.x / 3 + AndroidUtilities.dp(16);
+            layoutParams.gravity = Gravity.TOP;
+            controlView.setLayoutParams(layoutParams);
+
+            layoutParams = (FrameLayout.LayoutParams) textContainerView.getLayoutParams();
+            layoutParams.width = AndroidUtilities.displaySize.x / 3 * 2 - AndroidUtilities.dp(32);
+            layoutParams.leftMargin = AndroidUtilities.displaySize.x / 3 + AndroidUtilities.dp(16);
+            layoutParams.rightMargin = AndroidUtilities.dp(16);
+            layoutParams.bottomMargin = AndroidUtilities.dp(16);
+            textContainerView.setLayoutParams(layoutParams);
+        } else {
+            FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) videoContainerView.getLayoutParams();
+            layoutParams.topMargin = AndroidUtilities.dp(16);
+            layoutParams.bottomMargin = AndroidUtilities.dp(260 + (compressVideo.getVisibility() == View.VISIBLE ? 20 : 0));
+            layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
+            layoutParams.leftMargin = 0;
+            videoContainerView.setLayoutParams(layoutParams);
+
+            layoutParams = (FrameLayout.LayoutParams) controlView.getLayoutParams();
+            layoutParams.topMargin = 0;
+            layoutParams.leftMargin = 0;
+            layoutParams.bottomMargin = AndroidUtilities.dp(150 + (compressVideo.getVisibility() == View.VISIBLE ? 20 : 0));
+            layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
+            layoutParams.gravity = Gravity.BOTTOM;
+            controlView.setLayoutParams(layoutParams);
+
+            layoutParams = (FrameLayout.LayoutParams) textContainerView.getLayoutParams();
+            layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
+            layoutParams.leftMargin = AndroidUtilities.dp(16);
+            layoutParams.rightMargin = AndroidUtilities.dp(16);
+            layoutParams.bottomMargin = AndroidUtilities.dp(16);
+            textContainerView.setLayoutParams(layoutParams);
+        }
+        fixVideoSize();
+        videoTimelineView.clearFrames();
     }
 
     private void fixLayout() {
-        if (originalSizeTextView == null) {
+        if (fragmentView == null) {
             return;
         }
-        originalSizeTextView.getViewTreeObserver().addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener() {
+        fragmentView.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
             @Override
-            public boolean onPreDraw() {
-                originalSizeTextView.getViewTreeObserver().removeOnPreDrawListener(this);
-                if (!AndroidUtilities.isTablet() && getParentActivity().getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
-                    FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) videoContainerView.getLayoutParams();
-                    layoutParams.topMargin = AndroidUtilities.dp(16);
-                    layoutParams.bottomMargin = AndroidUtilities.dp(16);
-                    layoutParams.width = AndroidUtilities.displaySize.x / 3 - AndroidUtilities.dp(24);
-                    layoutParams.leftMargin = AndroidUtilities.dp(16);
-                    videoContainerView.setLayoutParams(layoutParams);
-
-                    layoutParams = (FrameLayout.LayoutParams) controlView.getLayoutParams();
-                    layoutParams.topMargin = AndroidUtilities.dp(16);
-                    layoutParams.bottomMargin = 0;
-                    layoutParams.width = AndroidUtilities.displaySize.x / 3 * 2 - AndroidUtilities.dp(32);
-                    layoutParams.leftMargin = AndroidUtilities.displaySize.x / 3 + AndroidUtilities.dp(16);
-                    layoutParams.gravity = Gravity.TOP;
-                    controlView.setLayoutParams(layoutParams);
-
-                    layoutParams = (FrameLayout.LayoutParams) textContainerView.getLayoutParams();
-                    layoutParams.width = AndroidUtilities.displaySize.x / 3 * 2 - AndroidUtilities.dp(32);
-                    layoutParams.leftMargin = AndroidUtilities.displaySize.x / 3 + AndroidUtilities.dp(16);
-                    layoutParams.rightMargin = AndroidUtilities.dp(16);
-                    layoutParams.bottomMargin = AndroidUtilities.dp(16);
-                    textContainerView.setLayoutParams(layoutParams);
-                } else {
-                    FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) videoContainerView.getLayoutParams();
-                    layoutParams.topMargin = AndroidUtilities.dp(16);
-                    layoutParams.bottomMargin = AndroidUtilities.dp(260);
-                    layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-                    layoutParams.leftMargin = 0;
-                    videoContainerView.setLayoutParams(layoutParams);
-
-                    layoutParams = (FrameLayout.LayoutParams) controlView.getLayoutParams();
-                    layoutParams.topMargin = 0;
-                    layoutParams.leftMargin = 0;
-                    layoutParams.bottomMargin = AndroidUtilities.dp(150);
-                    layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-                    layoutParams.gravity = Gravity.BOTTOM;
-                    controlView.setLayoutParams(layoutParams);
-
-                    layoutParams = (FrameLayout.LayoutParams) textContainerView.getLayoutParams();
-                    layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-                    layoutParams.leftMargin = AndroidUtilities.dp(16);
-                    layoutParams.rightMargin = AndroidUtilities.dp(16);
-                    layoutParams.bottomMargin = AndroidUtilities.dp(16);
-                    textContainerView.setLayoutParams(layoutParams);
+            public void onGlobalLayout() {
+                fixLayoutInternal();
+                if (fragmentView != null) {
+                    if (Build.VERSION.SDK_INT < 16) {
+                        fragmentView.getViewTreeObserver().removeGlobalOnLayoutListener(this);
+                    } else {
+                        fragmentView.getViewTreeObserver().removeOnGlobalLayoutListener(this);
+                    }
                 }
-                fixVideoSize();
-                videoTimelineView.clearFrames();
-                return false;
             }
         });
     }
 
     private void play() {
-        if (videoPlayer == null) {
+        if (videoPlayer == null || !playerPrepared) {
             return;
         }
         if (videoPlayer.isPlaying()) {
@@ -557,8 +620,7 @@ private void play() {
                 playButton.setImageDrawable(null);
                 lastProgress = 0;
                 if (needSeek) {
-                    float prog = videoTimelineView.getLeftProgress() + (videoTimelineView.getRightProgress() - videoTimelineView.getLeft()) * videoSeekBarView.getProgress();
-                    videoPlayer.seekTo((int) (videoDuration * prog));
+                    videoPlayer.seekTo((int) (videoDuration * videoSeekBarView.getProgress()));
                     needSeek = false;
                 }
                 videoPlayer.setOnSeekCompleteListener(new MediaPlayer.OnSeekCompleteListener() {
@@ -576,7 +638,12 @@ public void onSeekComplete(MediaPlayer mp) {
                     }
                 });
                 videoPlayer.start();
-                new Thread(progressRunnable).start();
+                synchronized (sync) {
+                    if (thread == null) {
+                        thread = new Thread(progressRunnable);
+                        thread.start();
+                    }
+                }
             } catch (Exception e) {
                 FileLog.e("tmessages", e);
             }
@@ -587,175 +654,31 @@ public void setDelegate(VideoEditorActivityDelegate delegate) {
         this.delegate = delegate;
     }
 
-    private int selectTrack(MediaExtractor extractor, boolean audio) {
-        int numTracks = extractor.getTrackCount();
-        for (int i = 0; i < numTracks; i++) {
-            MediaFormat format = extractor.getTrackFormat(i);
-            String mime = format.getString(MediaFormat.KEY_MIME);
-            if (audio) {
-                if (mime.startsWith("audio/")) {
-                    return i;
-                }
-            } else {
-                if (mime.startsWith("video/")) {
-                    return i;
-                }
-            }
-        }
-        return -5;
-    }
-
-    private static class VideoEditWrapper implements Runnable {
-        private VideoEditorActivity mTest;
-        private VideoEditWrapper(VideoEditorActivity test) {
-            mTest = test;
-        }
-
-        @Override
-        public void run() {
-            mTest.startConvert2();
-        }
-
-        public static void runTest(final VideoEditorActivity obj) {
-            new Thread(new Runnable() {
-                @Override
-                public void run() {
-                    try {
-                        VideoEditWrapper wrapper = new VideoEditWrapper(obj);
-                        Thread th = new Thread(wrapper, "encoder");
-                        th.start();
-                        th.join();
-                    } catch (Exception e) {
-                        FileLog.e("tmessages", e);
-                    }
-                }
-            }).start();
-        }
-    }
+    private boolean processOpenVideo() {
+        try {
+            File file = new File(videoPath);
+            originalSize = file.length();
 
-    private void didWriteData(final String videoPath, final long finalSize) {
-        AndroidUtilities.RunOnUIThread(new Runnable() {
-            @Override
-            public void run() {
-                if (firstWrite) {
-                    int width = rotationValue == 90 || rotationValue == 270 ? resultHeight : resultWidth;
-                    int height = rotationValue == 90 || rotationValue == 270 ? resultWidth : resultHeight;
-                    delegate.didStartVideoConverting(videoPath, VideoEditorActivity.this.videoPath, estimatedSize, (int)esimatedDuration, width, height);
-                    firstWrite = false;
-                    finishFragment();
-                } else {
-                    delegate.didAppenedVideoData(videoPath, finalSize);
-                }
-            }
-        });
-    }
+            IsoFile isoFile = new IsoFile(videoPath);
+            List<Box> boxes = Path.getPaths(isoFile, "/moov/trak/");
+            TrackHeaderBox trackHeaderBox = null;
+            boolean isAvc = true;
+            boolean isMp4A = true;
 
-    private static MediaCodecInfo selectCodec(String mimeType) {
-        int numCodecs = MediaCodecList.getCodecCount();
-        for (int i = 0; i < numCodecs; i++) {
-            MediaCodecInfo codecInfo = MediaCodecList.getCodecInfoAt(i);
-            if (!codecInfo.isEncoder()) {
-                continue;
-            }
-            String[] types = codecInfo.getSupportedTypes();
-            for (String type : types) {
-                if (type.equalsIgnoreCase(mimeType)) {
-                    return codecInfo;
-                }
+            Box boxTest = Path.getPath(isoFile, "/moov/trak/mdia/minf/stbl/stsd/mp4a/");
+            if (boxTest == null) {
+                isMp4A = false;
             }
-        }
-        return null;
-    }
 
-    private static boolean isRecognizedFormat(int colorFormat) {
-        switch (colorFormat) {
-            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Planar:
-            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420PackedPlanar:
-            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420SemiPlanar:
-            case MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420PackedSemiPlanar:
-            case MediaCodecInfo.CodecCapabilities.COLOR_TI_FormatYUV420PackedSemiPlanar:
-                return true;
-            default:
+            if (!isMp4A) {
                 return false;
-        }
-    }
-
-    private static int selectColorFormat(MediaCodecInfo codecInfo, String mimeType) {
-        MediaCodecInfo.CodecCapabilities capabilities = codecInfo.getCapabilitiesForType(mimeType);
-        for (int i = 0; i < capabilities.colorFormats.length; i++) {
-            int colorFormat = capabilities.colorFormats[i];
-            if (isRecognizedFormat(colorFormat)) {
-                return colorFormat;
             }
-        }
-        return 0;
-    }
 
-    private long readAndWriteTrack(MediaExtractor extractor, MP4Builder mediaMuxer, MediaCodec.BufferInfo info, long start, long end, File file, boolean isAudio) throws Exception {
-        int trackIndex = selectTrack(extractor, isAudio);
-        if (trackIndex >= 0) {
-            extractor.selectTrack(trackIndex);
-            MediaFormat trackFormat = extractor.getTrackFormat(trackIndex);
-            int muxerTrackIndex = mediaMuxer.addTrack(trackFormat, isAudio);
-            int maxBufferSize = trackFormat.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
-            boolean inputDone = false;
-            if (start > 0) {
-                extractor.seekTo(start, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
-            } else {
-                extractor.seekTo(0, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
-            }
-            ByteBuffer buffer = ByteBuffer.allocateDirect(maxBufferSize);
-            long startTime = -1;
-
-            while (!inputDone) {
-                boolean eof = false;
-                int index = extractor.getSampleTrackIndex();
-                if (index == trackIndex) {
-                    info.size = extractor.readSampleData(buffer, 0);
-
-                    if (info.size < 0) {
-                        info.size = 0;
-                        eof = true;
-                    } else {
-                        info.presentationTimeUs = extractor.getSampleTime();
-                        if (start > 0 && startTime == -1) {
-                            startTime = info.presentationTimeUs;
-                        }
-                        if (end < 0 || info.presentationTimeUs < end) {
-                            info.offset = 0;
-                            info.flags = extractor.getSampleFlags();
-                            if (!isAudio) {
-                                buffer.limit(info.offset + info.size);
-                                buffer.position(info.offset);
-                                buffer.putInt(info.size - 4);
-                            }
-                            if (mediaMuxer.writeSampleData(muxerTrackIndex, buffer, info)) {
-                                didWriteData(file.toString(), 0);
-                            }
-                            extractor.advance();
-                        } else {
-                            eof = true;
-                        }
-                    }
-                } else if (index == -1) {
-                    eof = true;
-                }
-                if (eof) {
-                    inputDone = true;
-                }
+            boxTest = Path.getPath(isoFile, "/moov/trak/mdia/minf/stbl/stsd/avc1/");
+            if (boxTest == null) {
+                isAvc = false;
             }
 
-            extractor.unselectTrack(trackIndex);
-            return startTime;
-        }
-        return -1;
-    }
-
-    private boolean processOpenVideo() {
-        try {
-            IsoFile isoFile = new IsoFile(videoPath);
-            List<Box> boxes = Path.getPaths(isoFile, "/moov/trak/");
-            TrackHeaderBox trackHeaderBox = null;
             for (Box box : boxes) {
                 TrackBox trackBox = (TrackBox)box;
                 int sampleSizes = 0;
@@ -767,7 +690,7 @@ private boolean processOpenVideo() {
                     for (long size : sampleSizeBox.getSampleSizes()) {
                         sampleSizes += size;
                     }
-                    videoDuration = mediaHeaderBox.getDuration() / mediaHeaderBox.getTimescale();
+                    videoDuration = (float)mediaHeaderBox.getDuration() / (float)mediaHeaderBox.getTimescale();
                     trackBitrate = (int)(sampleSizes * 8 / videoDuration);
                 } catch (Exception e) {
                     FileLog.e("tmessages", e);
@@ -804,10 +727,14 @@ private boolean processOpenVideo() {
                 resultWidth *= scale;
                 resultHeight *= scale;
                 if (bitrate != 0) {
-                    bitrate *= scale;
+                    bitrate *= Math.max(0.5f, scale);
                     videoFramesSize = (int)(bitrate / 8 * videoDuration);
                 }
             }
+
+            if (!isAvc && (resultWidth == originalWidth || resultHeight == originalHeight)) {
+                return false;
+            }
         } catch (Exception e) {
             FileLog.e("tmessages", e);
             return false;
@@ -826,444 +753,4 @@ private int calculateEstimatedSize(float timeDelta) {
         size += size / (32 * 1024) * 16;
         return size;
     }
-
-    private boolean startConvert2() {
-        File inputFile = new File(videoPath);
-        if (!inputFile.canRead()) {
-            return false;
-        }
-
-        firstWrite = true;
-        File cacheFile = null;
-        boolean error = false;
-        long videoStartTime = startTime;
-
-        long time = System.currentTimeMillis();
-
-        if (resultWidth != 0 && resultHeight != 0) {
-            MP4Builder mediaMuxer = null;
-            MediaExtractor extractor = null;
-
-            MediaCodec decoder = null;
-            MediaCodec encoder = null;
-            InputSurface inputSurface = null;
-            OutputSurface outputSurface = null;
-
-            try {
-                String fileName = Integer.MIN_VALUE + "_" + UserConfig.lastLocalId + ".mp4";
-                UserConfig.lastLocalId--;
-                cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
-                UserConfig.saveConfig(false);
-
-                MediaCodec.BufferInfo info = new MediaCodec.BufferInfo();
-                Mp4Movie movie = new Mp4Movie();
-                movie.setCacheFile(cacheFile);
-                movie.setRotation(rotationValue);
-                movie.setSize(resultWidth, resultHeight);
-                mediaMuxer = new MP4Builder().createMovie(movie);
-                extractor = new MediaExtractor();
-                extractor.setDataSource(inputFile.toString());
-
-                if (resultWidth != originalWidth || resultHeight != originalHeight) {
-                    int videoIndex = -5;
-                    videoIndex = selectTrack(extractor, false);
-                    if (videoIndex >= 0) {
-                        boolean outputDone = false;
-                        boolean inputDone = false;
-                        boolean decoderDone = false;
-                        int swapUV = 0;
-                        int videoTrackIndex = -5;
-                        long videoTime = -1;
-
-                        int colorFormat = 0;
-                        int processorType = PROCESSOR_TYPE_OTHER;
-                        if (Build.VERSION.SDK_INT < 18) {
-                            MediaCodecInfo codecInfo = selectCodec(MIME_TYPE);
-                            colorFormat = selectColorFormat(codecInfo, MIME_TYPE);
-                            if (codecInfo.getName().contains("OMX.qcom.")) {
-                                processorType = PROCESSOR_TYPE_QCOM;
-                                if (Build.VERSION.SDK_INT == 16) { //nokia, lge
-                                    swapUV = 1;
-                                }
-                            }
-                            FileLog.e("tmessages", "codec = " + codecInfo.getName());
-                        } else {
-                            colorFormat = MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface;
-                        }
-                        FileLog.e("tmessages", "colorFormat = " + colorFormat);
-
-                        int resultHeightAligned = resultHeight;
-                        int padding = 0;
-                        int bufferSize = resultWidth * resultHeight * 3 / 2;
-                        if (processorType == PROCESSOR_TYPE_OTHER) {
-                            if (resultHeight % 16 != 0) {
-                                resultHeightAligned += (16 - (resultHeight % 16));
-                                padding = resultWidth * (resultHeightAligned - resultHeight);
-                                bufferSize += padding * 5 / 4;
-                            }
-                        } else if (processorType == PROCESSOR_TYPE_QCOM) {
-                            if (!Build.MANUFACTURER.toLowerCase().equals("lge")) {
-                                int uvoffset = (resultWidth * resultHeight + 2047) & ~2047;
-                                padding = uvoffset - (resultWidth * resultHeight);
-                                bufferSize += padding;
-                            }
-                        }
-
-                        extractor.selectTrack(videoIndex);
-                        if (startTime > 0) {
-                            extractor.seekTo(startTime, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
-                        } else {
-                            extractor.seekTo(0, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
-                        }
-                        MediaFormat inputFormat = extractor.getTrackFormat(videoIndex);
-
-                        MediaFormat outputFormat = MediaFormat.createVideoFormat(MIME_TYPE, resultWidth, resultHeight);
-                        outputFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);
-                        outputFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate != 0 ? bitrate : 921600);
-                        outputFormat.setInteger(MediaFormat.KEY_FRAME_RATE, 25);
-                        outputFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 10);
-                        if (Build.VERSION.SDK_INT < 18) {
-                            outputFormat.setInteger("stride", resultWidth);
-                            outputFormat.setInteger("slice-height", resultHeightAligned);
-                        }
-
-                        encoder = MediaCodec.createEncoderByType(MIME_TYPE);
-                        encoder.configure(outputFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);
-                        if (Build.VERSION.SDK_INT >= 18) {
-                            inputSurface = new InputSurface(encoder.createInputSurface());
-                            inputSurface.makeCurrent();
-                        }
-                        encoder.start();
-
-                        decoder = MediaCodec.createDecoderByType(inputFormat.getString(MediaFormat.KEY_MIME));
-                        if (Build.VERSION.SDK_INT >= 18) {
-                            outputSurface = new OutputSurface();
-                        } else {
-                            outputSurface = new OutputSurface(resultWidth, resultHeight);
-                        }
-                        decoder.configure(inputFormat, outputSurface.getSurface(), null, 0);
-                        decoder.start();
-
-                        final int TIMEOUT_USEC = 2500;
-                        ByteBuffer[] decoderInputBuffers = decoder.getInputBuffers();
-                        ByteBuffer[] encoderOutputBuffers = encoder.getOutputBuffers();
-                        ByteBuffer[] encoderInputBuffers = null;
-                        if (Build.VERSION.SDK_INT < 18) {
-                            encoderInputBuffers = encoder.getInputBuffers();
-                        }
-
-                        while (!outputDone) {
-                            if (!inputDone) {
-                                boolean eof = false;
-                                int index = extractor.getSampleTrackIndex();
-                                if (index == videoIndex) {
-                                    int inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);
-                                    if (inputBufIndex >= 0) {
-                                        ByteBuffer inputBuf = decoderInputBuffers[inputBufIndex];
-                                        int chunkSize = extractor.readSampleData(inputBuf, 0);
-                                        if (chunkSize < 0) {
-                                            decoder.queueInputBuffer(inputBufIndex, 0, 0, 0L, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
-                                            inputDone = true;
-                                        } else {
-                                            decoder.queueInputBuffer(inputBufIndex, 0, chunkSize, extractor.getSampleTime(), 0);
-                                            extractor.advance();
-                                        }
-                                    }
-                                } else if (index == -1) {
-                                    eof = true;
-                                }
-                                if (eof) {
-                                    int inputBufIndex = decoder.dequeueInputBuffer(TIMEOUT_USEC);
-                                    if (inputBufIndex >= 0) {
-                                        decoder.queueInputBuffer(inputBufIndex, 0, 0, 0L, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
-                                        inputDone = true;
-                                    }
-                                }
-                            }
-
-                            boolean decoderOutputAvailable = !decoderDone;
-                            boolean encoderOutputAvailable = true;
-                            while (decoderOutputAvailable || encoderOutputAvailable) {
-                                int encoderStatus = encoder.dequeueOutputBuffer(info, TIMEOUT_USEC);
-                                if (encoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) {
-                                    encoderOutputAvailable = false;
-                                } else if (encoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) {
-                                    encoderOutputBuffers = encoder.getOutputBuffers();
-                                } else if (encoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) {
-                                    MediaFormat newFormat = encoder.getOutputFormat();
-                                    if (videoTrackIndex == -5) {
-                                        videoTrackIndex = mediaMuxer.addTrack(newFormat, false);
-                                    }
-                                } else if (encoderStatus < 0) {
-                                    throw new RuntimeException("unexpected result from encoder.dequeueOutputBuffer: " + encoderStatus);
-                                } else {
-                                    ByteBuffer encodedData = encoderOutputBuffers[encoderStatus];
-                                    if (encodedData == null) {
-                                        throw new RuntimeException("encoderOutputBuffer " + encoderStatus + " was null");
-                                    }
-                                    if (info.size > 1) {
-                                        if ((info.flags & MediaCodec.BUFFER_FLAG_CODEC_CONFIG) == 0) {
-                                            encodedData.limit(info.offset + info.size);
-                                            encodedData.position(info.offset);
-                                            encodedData.putInt(Integer.reverseBytes(info.size - 4));
-                                            if (mediaMuxer.writeSampleData(videoTrackIndex, encodedData, info)) {
-                                                didWriteData(cacheFile.toString(), 0);
-                                            }
-                                        } else if (videoTrackIndex == -5) {
-                                            byte[] csd = new byte[info.size];
-                                            encodedData.limit(info.offset + info.size);
-                                            encodedData.position(info.offset);
-                                            encodedData.get(csd);
-                                            ByteBuffer sps = null;
-                                            ByteBuffer pps = null;
-                                            for (int a = info.size - 1; a >= 0; a--) {
-                                                if (a > 3) {
-                                                    if (csd[a] == 1 && csd[a - 1] == 0 && csd[a - 2] == 0 && csd[a - 3] == 0) {
-                                                        sps = ByteBuffer.allocate(a - 3);
-                                                        pps = ByteBuffer.allocate(info.size - (a - 3));
-                                                        sps.put(csd, 0, a - 3).position(0);
-                                                        pps.put(csd, a - 3, info.size - (a - 3)).position(0);
-                                                        break;
-                                                    }
-                                                } else {
-                                                    break;
-                                                }
-                                            }
-
-                                            MediaFormat newFormat = MediaFormat.createVideoFormat(MIME_TYPE, resultWidth, resultHeight);
-                                            if (sps != null && pps != null) {
-                                                newFormat.setByteBuffer("csd-0", sps);
-                                                newFormat.setByteBuffer("csd-1", pps);
-                                            }
-                                            videoTrackIndex = mediaMuxer.addTrack(newFormat, false);
-                                        }
-                                    }
-                                    outputDone = (info.flags & MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0;
-                                    encoder.releaseOutputBuffer(encoderStatus, false);
-                                }
-                                if (encoderStatus != MediaCodec.INFO_TRY_AGAIN_LATER) {
-                                    continue;
-                                }
-
-                                if (!decoderDone) {
-                                    int decoderStatus = decoder.dequeueOutputBuffer(info, TIMEOUT_USEC);
-                                    if (decoderStatus == MediaCodec.INFO_TRY_AGAIN_LATER) {
-                                        decoderOutputAvailable = false;
-                                    } else if (decoderStatus == MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED) {
-
-                                    } else if (decoderStatus == MediaCodec.INFO_OUTPUT_FORMAT_CHANGED) {
-                                        MediaFormat newFormat = decoder.getOutputFormat();
-                                    } else if (decoderStatus < 0) {
-                                        throw new RuntimeException("unexpected result from decoder.dequeueOutputBuffer: " + decoderStatus);
-                                    } else {
-                                        boolean doRender = false;
-                                        if (Build.VERSION.SDK_INT >= 18) {
-                                            doRender = info.size != 0;
-                                        } else {
-                                            doRender = info.size != 0 || info.presentationTimeUs != 0;
-                                        }
-                                        if (endTime > 0 && info.presentationTimeUs >= endTime) {
-                                            inputDone = true;
-                                            decoderDone = true;
-                                            doRender = false;
-                                            info.flags |= MediaCodec.BUFFER_FLAG_END_OF_STREAM;
-                                        }
-                                        if (startTime > 0 && videoTime == -1) {
-                                            if (info.presentationTimeUs < startTime) {
-                                                doRender = false;
-                                                FileLog.e("tmessages", "drop frame startTime = " + startTime + " present time = " + info.presentationTimeUs);
-                                            } else {
-                                                videoTime = info.presentationTimeUs;
-                                            }
-                                        }
-                                        decoder.releaseOutputBuffer(decoderStatus, doRender);
-                                        if (doRender) {
-                                            boolean errorWait = false;
-                                            try {
-                                                outputSurface.awaitNewImage();
-                                            } catch (Exception e) {
-                                                errorWait = true;
-                                                FileLog.e("tmessages", e);
-                                            }
-                                            if (!errorWait) {
-                                                if (Build.VERSION.SDK_INT >= 18) {
-                                                    outputSurface.drawImage(false);
-                                                    inputSurface.setPresentationTime(info.presentationTimeUs * 1000);
-                                                    inputSurface.swapBuffers();
-                                                } else {
-                                                    int inputBufIndex = encoder.dequeueInputBuffer(TIMEOUT_USEC);
-                                                    if (inputBufIndex >= 0) {
-                                                        outputSurface.drawImage(true);
-                                                        ByteBuffer rgbBuf = outputSurface.getFrame();
-                                                        ByteBuffer yuvBuf = encoderInputBuffers[inputBufIndex];
-                                                        yuvBuf.clear();
-                                                        Utilities.convertVideoFrame(rgbBuf, yuvBuf, colorFormat, resultWidth, resultHeight, padding, swapUV);
-                                                        encoder.queueInputBuffer(inputBufIndex, 0, bufferSize, info.presentationTimeUs, 0);
-                                                    } else {
-                                                        FileLog.e("tmessages", "input buffer not available");
-                                                    }
-                                                }
-                                            }
-                                        }
-                                        if ((info.flags & MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0) {
-                                            decoderOutputAvailable = false;
-                                            FileLog.e("tmessages", "decoder stream end");
-                                            if (Build.VERSION.SDK_INT >= 18) {
-                                                encoder.signalEndOfInputStream();
-                                            } else {
-                                                int inputBufIndex = encoder.dequeueInputBuffer(TIMEOUT_USEC);
-                                                if (inputBufIndex >= 0) {
-                                                    encoder.queueInputBuffer(inputBufIndex, 0, 1, info.presentationTimeUs, MediaCodec.BUFFER_FLAG_END_OF_STREAM);
-                                                }
-                                            }
-                                        }
-                                    }
-                                }
-                            }
-                        }
-                        extractor.unselectTrack(videoIndex);
-                        if (videoTime != -1) {
-                            videoStartTime = videoTime;
-                        }
-                    }
-                } else {
-                    long videoTime = readAndWriteTrack(extractor, mediaMuxer, info, startTime, endTime, cacheFile, false);
-                    if (videoTime != -1) {
-                        videoStartTime = videoTime;
-                    }
-                }
-                readAndWriteTrack(extractor, mediaMuxer, info, videoStartTime, endTime, cacheFile, true);
-            } catch (Exception e) {
-                error = true;
-                FileLog.e("tmessages", e);
-            } finally {
-                if (extractor != null) {
-                    extractor.release();
-                    extractor = null;
-                }
-                if (outputSurface != null) {
-                    outputSurface.release();
-                    outputSurface = null;
-                }
-                if (inputSurface != null) {
-                    inputSurface.release();
-                    inputSurface = null;
-                }
-                if (decoder != null) {
-                    decoder.stop();
-                    decoder.release();
-                    decoder = null;
-                }
-                if (encoder != null) {
-                    encoder.stop();
-                    encoder.release();
-                    encoder = null;
-                }
-                if (mediaMuxer != null) {
-                    try {
-                        mediaMuxer.finishMovie(false);
-                    } catch (Exception e) {
-                        FileLog.e("tmessages", e);
-                    }
-                    mediaMuxer = null;
-                }
-                FileLog.e("tmessages", "time = " + (System.currentTimeMillis() - time));
-            }
-        } else {
-            return false;
-        }
-        if (!error && cacheFile != null) {
-            didWriteData(cacheFile.toString(), cacheFile.length());
-        }
-        return true;
-    }
-
-    private void startConvert() throws Exception {
-        IsoFile isoFile = new IsoFile(videoPath);
-        TrackBox trackBox = (TrackBox) Path.getPath(isoFile, "/moov/trak/mdia/minf/stbl/stsd/avc1/../../../../../");
-        AvcConfigurationBox avcConfigurationBox = (AvcConfigurationBox) Path.getPath(trackBox, "mdia/minf/stbl/stsd/avc1/avcC");
-        avcConfigurationBox.parseDetails();
-
-        Movie movie = MovieCreator.build(videoPath);
-
-        List<Track> tracks = movie.getTracks();
-        movie.setTracks(new LinkedList<Track>());
-
-        double startTime = 0;
-        double endTime = 0;
-
-        for (Track track : tracks) {
-            if (track.getSyncSamples() != null && track.getSyncSamples().length > 0) {
-                double duration = (double) track.getDuration() / (double) track.getTrackMetaData().getTimescale();
-                startTime = correctTimeToSyncSample(track, videoTimelineView.getLeftProgress() * duration, false);
-                endTime = videoTimelineView.getRightProgress() * duration;
-                break;
-            }
-        }
-
-        for (Track track : tracks) {
-            long currentSample = 0;
-            double currentTime = 0;
-            double lastTime = 0;
-            long startSample = 0;
-            long endSample = -1;
-
-            for (int i = 0; i < track.getSampleDurations().length; i++) {
-                long delta = track.getSampleDurations()[i];
-                if (currentTime > lastTime && currentTime <= startTime) {
-                    startSample = currentSample;
-                }
-                if (currentTime > lastTime && currentTime <= endTime) {
-                    endSample = currentSample;
-                }
-                lastTime = currentTime;
-                currentTime += (double) delta / (double) track.getTrackMetaData().getTimescale();
-                currentSample++;
-            }
-            movie.addTrack(new CroppedTrack(track, startSample, endSample));
-        }
-        Container out = new DefaultMp4Builder().build(movie);
-
-        String fileName = Integer.MIN_VALUE + "_" + UserConfig.lastLocalId + ".mp4";
-        UserConfig.lastLocalId--;
-        File cacheFile = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
-        UserConfig.saveConfig(false);
-
-        FileOutputStream fos = new FileOutputStream(cacheFile);
-        FileChannel fc = fos.getChannel();
-        out.writeContainer(fc);
-
-        fc.close();
-        fos.close();
-        if (delegate != null) {
-            //delegate.didFinishedVideoConverting(cacheFile.getAbsolutePath());
-            finishFragment();
-        }
-    }
-
-    private static double correctTimeToSyncSample(Track track, double cutHere, boolean next) {
-        double[] timeOfSyncSamples = new double[track.getSyncSamples().length];
-        long currentSample = 0;
-        double currentTime = 0;
-        for (int i = 0; i < track.getSampleDurations().length; i++) {
-            long delta = track.getSampleDurations()[i];
-            if (Arrays.binarySearch(track.getSyncSamples(), currentSample + 1) >= 0) {
-                timeOfSyncSamples[Arrays.binarySearch(track.getSyncSamples(), currentSample + 1)] = currentTime;
-            }
-            currentTime += (double) delta / (double) track.getTrackMetaData().getTimescale();
-            currentSample++;
-        }
-        double previous = 0;
-        for (double timeOfSyncSample : timeOfSyncSamples) {
-            if (timeOfSyncSample > cutHere) {
-                if (next) {
-                    return timeOfSyncSample;
-                } else {
-                    return previous;
-                }
-            }
-            previous = timeOfSyncSample;
-        }
-        return timeOfSyncSamples[timeOfSyncSamples.length - 1];
-    }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
index 54e6dfcdb..e4ce88d0c 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayout.java
@@ -31,6 +31,7 @@
 import android.widget.FrameLayout;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.android.NotificationCenter;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.R;
 
@@ -199,11 +200,11 @@ public void setDelegate(ActionBarLayoutDelegate delegate) {
     }
 
     private void onSlideAnimationEnd(boolean backAnimation) {
-        containerView.setX(0);
-        containerViewBack.setX(0);
+        containerView.setTranslationX(0);
+        containerViewBack.setTranslationX(0);
         actionBar.stopMoving(backAnimation);
         shadowView.setVisibility(View.INVISIBLE);
-        shadowView.setX(-AndroidUtilities.dp(2));
+        shadowView.setTranslationX(-AndroidUtilities.dp(2));
         if (!backAnimation) {
             BaseFragment lastFragment = fragmentsStack.get(fragmentsStack.size() - 1);
             lastFragment.onPause();
@@ -240,7 +241,7 @@ private void prepareForMoving(MotionEvent ev) {
         startedTracking = true;
         startedTrackingX = (int) ev.getX();
         shadowView.setVisibility(View.VISIBLE);
-        shadowView.setX(-AndroidUtilities.dp(2));
+        shadowView.setTranslationX(-AndroidUtilities.dp(2));
         containerViewBack.setVisibility(View.VISIBLE);
         beginTrackingSent = false;
 
@@ -297,8 +298,8 @@ public boolean onTouchEvent(MotionEvent ev) {
                         beginTrackingSent = true;
                     }
                     actionBar.moveActionBarByX(dx);
-                    containerView.setX(dx);
-                    shadowView.setX(dx - AndroidUtilities.dp(2));
+                    containerView.setTranslationX(dx);
+                    shadowView.setTranslationX(dx - AndroidUtilities.dp(2));
                 }
             } else if (ev != null && ev.getPointerId(0) == startedTrackingPointerId && (ev.getAction() == MotionEvent.ACTION_CANCEL || ev.getAction() == MotionEvent.ACTION_UP || ev.getAction() == MotionEvent.ACTION_POINTER_UP)) {
                 if (velocityTracker == null) {
@@ -417,8 +418,7 @@ public boolean checkTransitionAnimation() {
     }
 
     private void fixLayout() {
-        ViewTreeObserver obs = getViewTreeObserver();
-        obs.addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
+        getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
             @Override
             public void onGlobalLayout() {
                 needLayout();
@@ -488,19 +488,20 @@ private void presentFragmentInternalRemoveOld(boolean removeLast, final BaseFrag
     }
 
     public boolean presentFragment(BaseFragment fragment) {
-        return presentFragment(fragment, false, false);
+        return presentFragment(fragment, false, false, true);
     }
 
     public boolean presentFragment(BaseFragment fragment, boolean removeLast) {
-        return presentFragment(fragment, removeLast, false);
+        return presentFragment(fragment, removeLast, false, true);
     }
 
-    public boolean presentFragment(final BaseFragment fragment, final boolean removeLast, boolean forceWithoutAnimation) {
-        if (checkTransitionAnimation() || delegate != null && !delegate.needPresentFragment(fragment, removeLast, forceWithoutAnimation, this) || !fragment.onFragmentCreate()) {
+    public boolean presentFragment(final BaseFragment fragment, final boolean removeLast, boolean forceWithoutAnimation, boolean check) {
+        if (checkTransitionAnimation() || delegate != null && check && !delegate.needPresentFragment(fragment, removeLast, forceWithoutAnimation, this) || !fragment.onFragmentCreate()) {
             return false;
         }
         if (parentActivity.getCurrentFocus() != null) {
             AndroidUtilities.hideKeyboard(parentActivity.getCurrentFocus());
+            NotificationCenter.getInstance().postNotificationName(NotificationCenter.hideEmojiKeyboard);
         }
         boolean needAnimation = openAnimation != null && !forceWithoutAnimation && parentActivity.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE).getBoolean("view_animations", true);
         if (useAlphaAnimations && fragmentsStack.size() == 0 && alphaOpenAnimation == null) {
@@ -533,6 +534,9 @@ public boolean presentFragment(final BaseFragment fragment, final boolean remove
 
         if (!needAnimation) {
             presentFragmentInternalRemoveOld(removeLast, currentFragment);
+            if (backgroundView != null) {
+                backgroundView.setVisibility(VISIBLE);
+            }
         }
 
         if (needAnimation) {
@@ -563,11 +567,19 @@ public void run() {
     }
 
     public boolean addFragmentToStack(BaseFragment fragment) {
+        return addFragmentToStack(fragment, -1);
+    }
+
+    public boolean addFragmentToStack(BaseFragment fragment, int position) {
         if (delegate != null && !delegate.needAddFragmentToStack(fragment, this) || !fragment.onFragmentCreate()) {
             return false;
         }
         fragment.setParentLayout(this);
-        fragmentsStack.add(fragment);
+        if (position == -1) {
+            fragmentsStack.add(fragment);
+        } else {
+            fragmentsStack.add(position, fragment);
+        }
         return true;
     }
 
@@ -777,6 +789,9 @@ public void run() {
     }
 
     public void startActivityForResult(final Intent intent, final int requestCode) {
+        if (parentActivity == null) {
+            return;
+        }
         if (transitionAnimationInProgress) {
             if (onCloseAnimationEndRunnable != null) {
                 closeAnimation.cancel();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
index 579b11161..e5e68912d 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
@@ -31,6 +31,7 @@
 import android.widget.TextView;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.R;
 
 import java.lang.reflect.Field;
@@ -155,7 +156,7 @@ public void onDispatchKeyEvent(KeyEvent keyEvent) {
             delimeter.setBackgroundColor(0xffdcdcdc);
             popupLayout.addView(delimeter);
             LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)delimeter.getLayoutParams();
-            layoutParams.width = AndroidUtilities.dp(196);
+            layoutParams.width = LinearLayout.LayoutParams.MATCH_PARENT;
             layoutParams.height = AndroidUtilities.density >= 3 ? 2 : 1;
             delimeter.setLayoutParams(layoutParams);
             delimeter.setTag(100 + id);
@@ -163,7 +164,11 @@ public void onDispatchKeyEvent(KeyEvent keyEvent) {
         TextView textView = new TextView(getContext());
         textView.setTextColor(0xff000000);
         textView.setBackgroundResource(R.drawable.list_selector);
-        textView.setGravity(Gravity.CENTER_VERTICAL);
+        if (!LocaleController.isRTL) {
+            textView.setGravity(Gravity.CENTER_VERTICAL);
+        } else {
+            textView.setGravity(Gravity.CENTER_VERTICAL | Gravity.RIGHT);
+        }
         textView.setPadding(AndroidUtilities.dp(16), 0, AndroidUtilities.dp(16), 0);
         textView.setTextSize(18);
         textView.setMinWidth(AndroidUtilities.dp(196));
@@ -171,10 +176,17 @@ public void onDispatchKeyEvent(KeyEvent keyEvent) {
         textView.setText(text);
         if (icon != 0) {
             textView.setCompoundDrawablePadding(AndroidUtilities.dp(12));
-            textView.setCompoundDrawablesWithIntrinsicBounds(getResources().getDrawable(icon), null, null, null);
+            if (!LocaleController.isRTL) {
+                textView.setCompoundDrawablesWithIntrinsicBounds(getResources().getDrawable(icon), null, null, null);
+            } else {
+                textView.setCompoundDrawablesWithIntrinsicBounds(null, null, getResources().getDrawable(icon), null);
+            }
         }
         popupLayout.addView(textView);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)textView.getLayoutParams();
+        if (LocaleController.isRTL) {
+            layoutParams.gravity = Gravity.RIGHT;
+        }
         layoutParams.width = LinearLayout.LayoutParams.WRAP_CONTENT;
         layoutParams.height = AndroidUtilities.dp(48);
         textView.setLayoutParams(layoutParams);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
index 05e609b4d..c18ca4f9f 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
@@ -139,29 +139,29 @@ public void restoreSelfArgs(Bundle args) {
 
     }
 
-    public void presentFragment(BaseFragment fragment) {
-        if (parentLayout == null) {
-            return;
-        }
-        parentLayout.presentFragment(fragment);
+    public boolean presentFragment(BaseFragment fragment) {
+        return parentLayout != null && parentLayout.presentFragment(fragment);
     }
 
-    public void presentFragment(BaseFragment fragment, boolean removeLast) {
-        if (parentLayout == null) {
-            return;
-        }
-        parentLayout.presentFragment(fragment, removeLast);
+    public boolean presentFragment(BaseFragment fragment, boolean removeLast) {
+        return parentLayout != null && parentLayout.presentFragment(fragment, removeLast);
     }
 
-    public void presentFragment(BaseFragment fragment, boolean removeLast, boolean forceWithoutAnimation) {
-        if (parentLayout == null) {
-            return;
-        }
-        parentLayout.presentFragment(fragment, removeLast, forceWithoutAnimation);
+    public boolean presentFragment(BaseFragment fragment, boolean removeLast, boolean forceWithoutAnimation) {
+        return parentLayout != null && parentLayout.presentFragment(fragment, removeLast, forceWithoutAnimation, true);
     }
 
     public Activity getParentActivity() {
-        return parentLayout.parentActivity;
+        if (parentLayout != null) {
+            return parentLayout.parentActivity;
+        }
+        return null;
+    }
+
+    public void startActivityForResult(final Intent intent, final int requestCode) {
+        if (parentLayout != null) {
+            parentLayout.startActivityForResult(intent, requestCode);
+        }
     }
 
     public void showActionBar() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
index 276275e4a..1fe286753 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
@@ -61,7 +61,7 @@ public void openCamera() {
                 takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(image));
                 currentPicturePath = image.getAbsolutePath();
             }
-            parentFragment.getParentActivity().startActivityForResult(takePictureIntent, 13);
+            parentFragment.startActivityForResult(takePictureIntent, 13);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
@@ -69,9 +69,9 @@ public void openCamera() {
 
     public void openGallery() {
         try {
-            Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
+            Intent photoPickerIntent = new Intent(Intent.ACTION_GET_CONTENT);
             photoPickerIntent.setType("image/*");
-            parentFragment.getParentActivity().startActivityForResult(photoPickerIntent, 14);
+            parentFragment.startActivityForResult(photoPickerIntent, 14);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
index df0ca6c26..e0679ef8b 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
@@ -87,6 +87,7 @@ public ChatActivityEnterView() {
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.closeChats);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.audioDidSent);
         NotificationCenter.getInstance().addObserver(this, NotificationCenter.emojiDidLoaded);
+        NotificationCenter.getInstance().addObserver(this, NotificationCenter.hideEmojiKeyboard);
         SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
         sendByEnter = preferences.getBoolean("send_by_enter", false);
     }
@@ -99,6 +100,7 @@ public void onDestroy() {
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.closeChats);
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.audioDidSent);
         NotificationCenter.getInstance().removeObserver(this, NotificationCenter.emojiDidLoaded);
+        NotificationCenter.getInstance().removeObserver(this, NotificationCenter.hideEmojiKeyboard);
         if (mWakeLock != null) {
             try {
                 mWakeLock.release();
@@ -516,6 +518,15 @@ public void onEmojiSelected(String paramAnonymousString) {
             }
         });
         emojiPopup = new PopupWindow(emojiView);
+
+        /*Utry {
+            Method method = emojiPopup.getClass().getMethod("setWindowLayoutType", int.class);
+            if (method != null) {
+                method.invoke(emojiPopup, WindowManager.LayoutParams.LAST_SUB_WINDOW);
+            }
+        } catch (Exception e) {
+            //don't promt
+        }*/
     }
 
     public void setDelegate(ChatActivityEnterViewDelegate delegate) {
@@ -655,6 +666,8 @@ public void didReceivedNotification(int id, Object... args) {
             if (delegate != null) {
                 delegate.onMessageSend();
             }
+        } else if (id == NotificationCenter.hideEmojiKeyboard) {
+            hideEmojiPopup();
         }
     }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/EmojiView.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/EmojiView.java
index 73ceca0b5..3f84540a1 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/EmojiView.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/EmojiView.java
@@ -213,30 +213,26 @@ public EmojiGridAdapter(long[] arg2) {
         }
 
         public int getCount() {
-            return this.data.length;
+            return data.length;
         }
 
-        public Object getItem(int paramInt)
-        {
+        public Object getItem(int i) {
             return null;
         }
 
-        public long getItemId(int paramInt)
-        {
-            return this.data[paramInt];
+        public long getItemId(int i) {
+            return data[i];
         }
 
-        public View getView(int paramInt, View paramView, ViewGroup paramViewGroup) {
-            ImageView localObject;
-            if (paramView != null) {
-                localObject = (ImageView)paramView;
-            } else {
-                localObject = new ImageView(EmojiView.this.getContext()) {
+        public View getView(int i, View view, ViewGroup paramViewGroup) {
+            ImageView imageView = (ImageView)view;
+            if (imageView == null) {
+                imageView = new ImageView(EmojiView.this.getContext()) {
                     public void onMeasure(int paramAnonymousInt1, int paramAnonymousInt2) {
                         setMeasuredDimension(View.MeasureSpec.getSize(paramAnonymousInt1), View.MeasureSpec.getSize(paramAnonymousInt1));
                     }
                 };
-                localObject.setOnClickListener(new View.OnClickListener() {
+                imageView.setOnClickListener(new View.OnClickListener() {
                     public void onClick(View view) {
                         if (EmojiView.this.listener != null) {
                             EmojiView.this.listener.onEmojiSelected(EmojiView.this.convert((Long)view.getTag()));
@@ -244,13 +240,12 @@ public void onClick(View view) {
                         EmojiView.this.addToRecent((Long)view.getTag());
                     }
                 });
-                localObject.setBackgroundResource(R.drawable.list_selector);
-                localObject.setScaleType(ImageView.ScaleType.CENTER);
+                imageView.setBackgroundResource(R.drawable.list_selector);
+                imageView.setScaleType(ImageView.ScaleType.CENTER);
             }
-
-            localObject.setImageDrawable(Emoji.getEmojiBigDrawable(this.data[paramInt]));
-            localObject.setTag(this.data[paramInt]);
-            return localObject;
+            imageView.setImageDrawable(Emoji.getEmojiBigDrawable(data[i]));
+            imageView.setTag(data[i]);
+            return imageView;
         }
 
         @Override
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/PagerSlidingTabStrip.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/PagerSlidingTabStrip.java
index bf7cb0858..42b79cfbc 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/PagerSlidingTabStrip.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/PagerSlidingTabStrip.java
@@ -12,7 +12,6 @@
 
 import android.annotation.SuppressLint;
 import android.content.Context;
-import android.content.res.TypedArray;
 import android.graphics.Canvas;
 import android.graphics.Paint;
 import android.graphics.Paint.Style;
@@ -42,15 +41,7 @@
         public int getPageIconResId(int position);
     }
 
-    // @formatter:off
-    private static final int[] ATTRS = new int[] {
-            android.R.attr.textSize,
-            android.R.attr.textColor
-    };
-    // @formatter:on
-
     private LinearLayout.LayoutParams defaultTabLayoutParams;
-    private LinearLayout.LayoutParams expandedTabLayoutParams;
 
     private final PageListener pageListener = new PageListener();
     public OnPageChangeListener delegatePageListener;
@@ -66,8 +57,6 @@
     private Paint rectPaint;
     private Paint dividerPaint;
 
-    private boolean checkedTabWidths = false;
-
     private int indicatorColor = 0xFF666666;
     private int underlineColor = 0x1A000000;
     private int dividerColor = 0x1A000000;
@@ -122,33 +111,6 @@ public PagerSlidingTabStrip(Context context, AttributeSet attrs, int defStyle) {
         dividerWidth = (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dividerWidth, dm);
         tabTextSize = (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, tabTextSize, dm);
 
-        // get system attrs (android:textSize and android:textColor)
-
-        TypedArray a = context.obtainStyledAttributes(attrs, ATTRS);
-
-        tabTextSize = a.getDimensionPixelSize(0, tabTextSize);
-        tabTextColor = a.getColor(1, tabTextColor);
-
-        a.recycle();
-
-        // get custom attrs
-
-        a = context.obtainStyledAttributes(attrs, R.styleable.PagerSlidingTabStrip);
-
-        indicatorColor = a.getColor(R.styleable.PagerSlidingTabStrip_indicatorColor, indicatorColor);
-        underlineColor = a.getColor(R.styleable.PagerSlidingTabStrip_underlineColor, underlineColor);
-        dividerColor = a.getColor(R.styleable.PagerSlidingTabStrip_dividerColor, dividerColor);
-        indicatorHeight = a.getDimensionPixelSize(R.styleable.PagerSlidingTabStrip_indicatorHeight, indicatorHeight);
-        underlineHeight = a.getDimensionPixelSize(R.styleable.PagerSlidingTabStrip_underlineHeight, underlineHeight);
-        dividerPadding = a.getDimensionPixelSize(R.styleable.PagerSlidingTabStrip_dividerPadding1, dividerPadding);
-        tabPadding = a.getDimensionPixelSize(R.styleable.PagerSlidingTabStrip_tabPaddingLeftRight, tabPadding);
-        tabBackgroundResId = a.getResourceId(R.styleable.PagerSlidingTabStrip_tabBackground, tabBackgroundResId);
-        shouldExpand = a.getBoolean(R.styleable.PagerSlidingTabStrip_shouldExpand, shouldExpand);
-        scrollOffset = a.getDimensionPixelSize(R.styleable.PagerSlidingTabStrip_scrollOffset, scrollOffset);
-        textAllCaps = a.getBoolean(R.styleable.PagerSlidingTabStrip_textAllCaps1, textAllCaps);
-
-        a.recycle();
-
         rectPaint = new Paint();
         rectPaint.setAntiAlias(true);
         rectPaint.setStyle(Style.FILL);
@@ -158,7 +120,6 @@ public PagerSlidingTabStrip(Context context, AttributeSet attrs, int defStyle) {
         dividerPaint.setStrokeWidth(dividerWidth);
 
         defaultTabLayoutParams = new LinearLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT);
-        expandedTabLayoutParams = new LinearLayout.LayoutParams(0, LayoutParams.MATCH_PARENT, 1.0f);
 
         if (locale == null) {
             locale = getResources().getConfiguration().locale;
@@ -199,8 +160,6 @@ public void notifyDataSetChanged() {
 
         updateTabStyles();
 
-        checkedTabWidths = false;
-
         getViewTreeObserver().addOnGlobalLayoutListener(new OnGlobalLayoutListener() {
 
             @SuppressWarnings("deprecation")
@@ -296,7 +255,6 @@ private void updateTabStyles() {
                 }
             }
         }
-
     }
 
     @Override
@@ -312,7 +270,6 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
     }
 
     private void scrollToChild(int position, int offset) {
-
         if (tabCount == 0) {
             return;
         }
@@ -327,7 +284,6 @@ private void scrollToChild(int position, int offset) {
             lastScrollX = newScrollX;
             scrollTo(newScrollX, 0);
         }
-
     }
 
     @Override
@@ -615,5 +571,4 @@ public SavedState createFromParcel(Parcel in) {
             }
         };
     }
-
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/TypingDotsDrawable.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/TypingDotsDrawable.java
index b0069496e..ff9d59c4d 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/TypingDotsDrawable.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/TypingDotsDrawable.java
@@ -39,6 +39,9 @@ private void update() {
         long newTime = System.currentTimeMillis();
         long dt = newTime - lastUpdateTime;
         lastUpdateTime = newTime;
+        if (dt > 50) {
+            dt = 50;
+        }
 
         for (int a = 0; a < 3; a++) {
             elapsedTimes[a] += dt;
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/doc_blue.png b/TMessagesProj/src/main/res/drawable-hdpi/doc_blue.png
index 1c1b3cdfe..a6a72c978 100644
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/doc_blue.png and b/TMessagesProj/src/main/res/drawable-hdpi/doc_blue.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/doc_green.png b/TMessagesProj/src/main/res/drawable-hdpi/doc_green.png
index 68b721425..72180a744 100644
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/doc_green.png and b/TMessagesProj/src/main/res/drawable-hdpi/doc_green.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png b/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png
new file mode 100644
index 000000000..897ac3a3f
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png.png b/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png.png
deleted file mode 100644
index 5fe1295c2..000000000
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/doccancel_b.png.png and /dev/null differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/doccancel_g.png b/TMessagesProj/src/main/res/drawable-hdpi/doccancel_g.png
index 00716eef0..b53eebb55 100644
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/doccancel_g.png and b/TMessagesProj/src/main/res/drawable-hdpi/doccancel_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png b/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png
new file mode 100644
index 000000000..e27febd6a
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png.png b/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png.png
deleted file mode 100644
index a39c692e4..000000000
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/docload_b.png.png and /dev/null differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png b/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png
new file mode 100644
index 000000000..f93437c16
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png.png b/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png.png
deleted file mode 100644
index c8ac99dec..000000000
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/docload_g.png.png and /dev/null differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docpause_b.png b/TMessagesProj/src/main/res/drawable-hdpi/docpause_b.png
new file mode 100644
index 000000000..d7c483a02
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/docpause_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/docpause_g.png b/TMessagesProj/src/main/res/drawable-hdpi/docpause_g.png
new file mode 100644
index 000000000..35ca985fb
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/docpause_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/photocancel.png b/TMessagesProj/src/main/res/drawable-hdpi/photocancel.png
old mode 100755
new mode 100644
index bd41cc686..fb7572ece
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/photocancel.png and b/TMessagesProj/src/main/res/drawable-hdpi/photocancel.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/photogif.png b/TMessagesProj/src/main/res/drawable-hdpi/photogif.png
old mode 100755
new mode 100644
index 29f155b4a..0033e3db6
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/photogif.png and b/TMessagesProj/src/main/res/drawable-hdpi/photogif.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/photoload.png b/TMessagesProj/src/main/res/drawable-hdpi/photoload.png
old mode 100755
new mode 100644
index 20783e58b..2dbd58252
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/photoload.png and b/TMessagesProj/src/main/res/drawable-hdpi/photoload.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/photopause.png b/TMessagesProj/src/main/res/drawable-hdpi/photopause.png
new file mode 100644
index 000000000..ca0653d40
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-hdpi/photopause.png differ
diff --git a/TMessagesProj/src/main/res/drawable-hdpi/playvideo.png b/TMessagesProj/src/main/res/drawable-hdpi/playvideo.png
index 449d7ada3..1bead9ee9 100644
Binary files a/TMessagesProj/src/main/res/drawable-hdpi/playvideo.png and b/TMessagesProj/src/main/res/drawable-hdpi/playvideo.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/doc_blue.png b/TMessagesProj/src/main/res/drawable-ldpi/doc_blue.png
index e757044d7..91dffa55c 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/doc_blue.png and b/TMessagesProj/src/main/res/drawable-ldpi/doc_blue.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/doc_green.png b/TMessagesProj/src/main/res/drawable-ldpi/doc_green.png
index 5eef56f38..4cef2bc71 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/doc_green.png and b/TMessagesProj/src/main/res/drawable-ldpi/doc_green.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/doccancel_b.png b/TMessagesProj/src/main/res/drawable-ldpi/doccancel_b.png
index 7e3eafac5..fbaba5983 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/doccancel_b.png and b/TMessagesProj/src/main/res/drawable-ldpi/doccancel_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/doccancel_g.png b/TMessagesProj/src/main/res/drawable-ldpi/doccancel_g.png
index 608f103c5..c700483b1 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/doccancel_g.png and b/TMessagesProj/src/main/res/drawable-ldpi/doccancel_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/docload_b.png b/TMessagesProj/src/main/res/drawable-ldpi/docload_b.png
index 84b9884ad..129a045fa 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/docload_b.png and b/TMessagesProj/src/main/res/drawable-ldpi/docload_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/docload_g.png b/TMessagesProj/src/main/res/drawable-ldpi/docload_g.png
index 6c2a38b5c..1547d6694 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/docload_g.png and b/TMessagesProj/src/main/res/drawable-ldpi/docload_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/docpause_b.png b/TMessagesProj/src/main/res/drawable-ldpi/docpause_b.png
new file mode 100644
index 000000000..d57a51a58
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-ldpi/docpause_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/docpause_g.png b/TMessagesProj/src/main/res/drawable-ldpi/docpause_g.png
new file mode 100644
index 000000000..41dc34fab
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-ldpi/docpause_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/photocancel.png b/TMessagesProj/src/main/res/drawable-ldpi/photocancel.png
old mode 100755
new mode 100644
index 857a1202c..bce279ae8
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/photocancel.png and b/TMessagesProj/src/main/res/drawable-ldpi/photocancel.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/photogif.png b/TMessagesProj/src/main/res/drawable-ldpi/photogif.png
old mode 100755
new mode 100644
index 9599c4c35..0915f0e48
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/photogif.png and b/TMessagesProj/src/main/res/drawable-ldpi/photogif.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/photoload.png b/TMessagesProj/src/main/res/drawable-ldpi/photoload.png
old mode 100755
new mode 100644
index d08458bda..5c50b3de9
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/photoload.png and b/TMessagesProj/src/main/res/drawable-ldpi/photoload.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/photopause.png b/TMessagesProj/src/main/res/drawable-ldpi/photopause.png
new file mode 100644
index 000000000..1f95c38a7
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-ldpi/photopause.png differ
diff --git a/TMessagesProj/src/main/res/drawable-ldpi/playvideo.png b/TMessagesProj/src/main/res/drawable-ldpi/playvideo.png
index 8521b0d7d..d03cb384e 100644
Binary files a/TMessagesProj/src/main/res/drawable-ldpi/playvideo.png and b/TMessagesProj/src/main/res/drawable-ldpi/playvideo.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/doc_blue.png b/TMessagesProj/src/main/res/drawable-mdpi/doc_blue.png
index 3364e7377..153d689ba 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/doc_blue.png and b/TMessagesProj/src/main/res/drawable-mdpi/doc_blue.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/doc_green.png b/TMessagesProj/src/main/res/drawable-mdpi/doc_green.png
index 91549a4dd..3636a40ca 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/doc_green.png and b/TMessagesProj/src/main/res/drawable-mdpi/doc_green.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/doccancel_b.png b/TMessagesProj/src/main/res/drawable-mdpi/doccancel_b.png
index ee9762fdf..984b0f36f 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/doccancel_b.png and b/TMessagesProj/src/main/res/drawable-mdpi/doccancel_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/doccancel_g.png b/TMessagesProj/src/main/res/drawable-mdpi/doccancel_g.png
index 371d6a4c7..d33f5d0bd 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/doccancel_g.png and b/TMessagesProj/src/main/res/drawable-mdpi/doccancel_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/docload_b.png b/TMessagesProj/src/main/res/drawable-mdpi/docload_b.png
index fed5ef3e5..b6f8de393 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/docload_b.png and b/TMessagesProj/src/main/res/drawable-mdpi/docload_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/docload_g.png b/TMessagesProj/src/main/res/drawable-mdpi/docload_g.png
index 80620158b..bd998016d 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/docload_g.png and b/TMessagesProj/src/main/res/drawable-mdpi/docload_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/docpause_b.png b/TMessagesProj/src/main/res/drawable-mdpi/docpause_b.png
new file mode 100644
index 000000000..485fbaca9
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-mdpi/docpause_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/docpause_g.png b/TMessagesProj/src/main/res/drawable-mdpi/docpause_g.png
new file mode 100644
index 000000000..c909c00be
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-mdpi/docpause_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/photocancel.png b/TMessagesProj/src/main/res/drawable-mdpi/photocancel.png
old mode 100755
new mode 100644
index 59df84729..e3e7a3595
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/photocancel.png and b/TMessagesProj/src/main/res/drawable-mdpi/photocancel.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/photogif.png b/TMessagesProj/src/main/res/drawable-mdpi/photogif.png
old mode 100755
new mode 100644
index d91f0d319..1241d8f5a
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/photogif.png and b/TMessagesProj/src/main/res/drawable-mdpi/photogif.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/photoload.png b/TMessagesProj/src/main/res/drawable-mdpi/photoload.png
old mode 100755
new mode 100644
index b010df619..18b75497e
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/photoload.png and b/TMessagesProj/src/main/res/drawable-mdpi/photoload.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/photopause.png b/TMessagesProj/src/main/res/drawable-mdpi/photopause.png
new file mode 100644
index 000000000..e3051be70
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-mdpi/photopause.png differ
diff --git a/TMessagesProj/src/main/res/drawable-mdpi/playvideo.png b/TMessagesProj/src/main/res/drawable-mdpi/playvideo.png
index d1b0b4aac..e77608feb 100644
Binary files a/TMessagesProj/src/main/res/drawable-mdpi/playvideo.png and b/TMessagesProj/src/main/res/drawable-mdpi/playvideo.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/doc_blue.png b/TMessagesProj/src/main/res/drawable-xhdpi/doc_blue.png
index 459d5c979..835fec45e 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/doc_blue.png and b/TMessagesProj/src/main/res/drawable-xhdpi/doc_blue.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/doc_green.png b/TMessagesProj/src/main/res/drawable-xhdpi/doc_green.png
index 39b34fcd3..7c4fba30a 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/doc_green.png and b/TMessagesProj/src/main/res/drawable-xhdpi/doc_green.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_b.png b/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_b.png
index 932492f42..fefafdca4 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_b.png and b/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_g.png b/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_g.png
index 4b1ad66d6..d43a5fe19 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_g.png and b/TMessagesProj/src/main/res/drawable-xhdpi/doccancel_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/docload_b.png b/TMessagesProj/src/main/res/drawable-xhdpi/docload_b.png
index 7b8c18cc6..9a6d2f9af 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/docload_b.png and b/TMessagesProj/src/main/res/drawable-xhdpi/docload_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/docload_g.png b/TMessagesProj/src/main/res/drawable-xhdpi/docload_g.png
index 52d94e79f..c80fb6b0d 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/docload_g.png and b/TMessagesProj/src/main/res/drawable-xhdpi/docload_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/docpause_b.png b/TMessagesProj/src/main/res/drawable-xhdpi/docpause_b.png
new file mode 100644
index 000000000..b665d65b8
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xhdpi/docpause_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/docpause_g.png b/TMessagesProj/src/main/res/drawable-xhdpi/docpause_g.png
new file mode 100644
index 000000000..da750eba0
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xhdpi/docpause_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/photocancel.png b/TMessagesProj/src/main/res/drawable-xhdpi/photocancel.png
old mode 100755
new mode 100644
index a13c7ec2b..4dc4b06be
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/photocancel.png and b/TMessagesProj/src/main/res/drawable-xhdpi/photocancel.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/photogif.png b/TMessagesProj/src/main/res/drawable-xhdpi/photogif.png
old mode 100755
new mode 100644
index e6d7cd8c4..067b09c22
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/photogif.png and b/TMessagesProj/src/main/res/drawable-xhdpi/photogif.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/photoload.png b/TMessagesProj/src/main/res/drawable-xhdpi/photoload.png
old mode 100755
new mode 100644
index a72fe3e14..fb4eaec18
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/photoload.png and b/TMessagesProj/src/main/res/drawable-xhdpi/photoload.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/photopause.png b/TMessagesProj/src/main/res/drawable-xhdpi/photopause.png
new file mode 100644
index 000000000..8c6463d64
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xhdpi/photopause.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xhdpi/playvideo.png b/TMessagesProj/src/main/res/drawable-xhdpi/playvideo.png
index e13c056cf..d590b0f66 100644
Binary files a/TMessagesProj/src/main/res/drawable-xhdpi/playvideo.png and b/TMessagesProj/src/main/res/drawable-xhdpi/playvideo.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/doc_blue.png b/TMessagesProj/src/main/res/drawable-xxhdpi/doc_blue.png
index 5c8fc8d73..f8a4f5b75 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/doc_blue.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/doc_blue.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/doc_green.png b/TMessagesProj/src/main/res/drawable-xxhdpi/doc_green.png
index 8e08cbccc..e8bb7431b 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/doc_green.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/doc_green.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_b.png b/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_b.png
index 782b89422..fad332f1e 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_b.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_g.png b/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_g.png
index cd2f08dc1..c31c831eb 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_g.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/doccancel_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/docload_b.png b/TMessagesProj/src/main/res/drawable-xxhdpi/docload_b.png
index 05cae54b7..a54e9deac 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/docload_b.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/docload_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/docload_g.png b/TMessagesProj/src/main/res/drawable-xxhdpi/docload_g.png
index 4b44c5ef3..5da89c783 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/docload_g.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/docload_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_b.png b/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_b.png
new file mode 100644
index 000000000..370878820
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_b.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_g.png b/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_g.png
new file mode 100644
index 000000000..18dcd57d1
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/docpause_g.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/photocancel.png b/TMessagesProj/src/main/res/drawable-xxhdpi/photocancel.png
old mode 100755
new mode 100644
index 51c602e00..774066fe0
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/photocancel.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/photocancel.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/photogif.png b/TMessagesProj/src/main/res/drawable-xxhdpi/photogif.png
old mode 100755
new mode 100644
index 71c589122..efc3a64d2
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/photogif.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/photogif.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/photoload.png b/TMessagesProj/src/main/res/drawable-xxhdpi/photoload.png
old mode 100755
new mode 100644
index 4270d1c88..b720d6d37
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/photoload.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/photoload.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/photopause.png b/TMessagesProj/src/main/res/drawable-xxhdpi/photopause.png
new file mode 100644
index 000000000..62f9d3f8b
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/photopause.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/playvideo.png b/TMessagesProj/src/main/res/drawable-xxhdpi/playvideo.png
index 543ce17f0..c32d8f270 100644
Binary files a/TMessagesProj/src/main/res/drawable-xxhdpi/playvideo.png and b/TMessagesProj/src/main/res/drawable-xxhdpi/playvideo.png differ
diff --git a/TMessagesProj/src/main/res/drawable/bar_selector_style.xml b/TMessagesProj/src/main/res/drawable/bar_selector_style.xml
new file mode 100644
index 000000000..236178c0e
--- /dev/null
+++ b/TMessagesProj/src/main/res/drawable/bar_selector_style.xml
@@ -0,0 +1,19 @@
+<selector
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_pressed="true">
+        <shape android:shape="rectangle">
+            <solid android:color="#40a0bcdd" />
+        </shape>
+    </item>
+    <item android:state_focused="true">
+        <shape android:shape="rectangle">
+            <solid android:color="#40a0bcdd" />
+        </shape>
+    </item>
+    <item android:state_selected="true">
+        <shape android:shape="rectangle">
+            <solid android:color="#40a0bcdd" />
+        </shape>
+    </item>
+    <item android:drawable="@drawable/transparent" />
+</selector>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/layout-ar/launch_layout_tablet.xml b/TMessagesProj/src/main/res/layout-ar/launch_layout_tablet.xml
new file mode 100644
index 000000000..a86e2e185
--- /dev/null
+++ b/TMessagesProj/src/main/res/layout-ar/launch_layout_tablet.xml
@@ -0,0 +1,128 @@
+<!--
+  ~ This is the source code of Telegram for Android v. 1.7.x.
+  ~ It is licensed under GNU GPL v. 2 or later.
+  ~ You should have received a copy of the license in this archive (see LICENSE).
+  ~
+  ~ Copyright Nikolai Kudashov, 2013-2014.
+  -->
+
+<RelativeLayout
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:id="@+id/launch_layout">
+
+    <ImageView
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:src="@drawable/cats"
+        android:scaleType="centerCrop"
+        android:id="@+id/launch_background"/>
+
+    <LinearLayout
+        android:layout_width="320dp"
+        android:layout_height="wrap_content"
+        android:id="@+id/launch_button_layout"
+        android:layout_centerVertical="true"
+        android:orientation="vertical">
+
+        <LinearLayout
+            android:layout_width="308dp"
+            android:layout_height="wrap_content"
+            android:orientation="vertical"
+            android:background="@drawable/btnshadow"
+            android:layout_gravity="center">
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="60dp"
+                android:id="@+id/new_group_button"
+                android:textColor="#ff54759e"
+                android:gravity="center_vertical"
+                android:textSize="20dp"
+                android:paddingRight="17dp"
+                android:background="@drawable/launch_button_states"/>
+
+            <FrameLayout
+                android:layout_width="match_parent"
+                android:layout_height="1px"
+                android:background="#ffd6dee4"/>
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="60dp"
+                android:id="@+id/new_secret_button"
+                android:textColor="#ff54759e"
+                android:gravity="center_vertical"
+                android:textSize="20dp"
+                android:paddingRight="17dp"
+                android:background="@drawable/launch_button_states"/>
+
+            <FrameLayout
+                android:layout_width="match_parent"
+                android:layout_height="1px"
+                android:background="#ffd6dee4"/>
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="60dp"
+                android:id="@+id/new_broadcast_button"
+                android:textColor="#ff54759e"
+                android:gravity="center_vertical"
+                android:textSize="20dp"
+                android:paddingRight="17dp"
+                android:background="@drawable/launch_button_states"/>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="308dp"
+            android:layout_height="wrap_content"
+            android:orientation="vertical"
+            android:background="@drawable/btnshadow"
+            android:layout_gravity="center"
+            android:layout_marginTop="18dp">
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="60dp"
+                android:id="@+id/contacts_button"
+                android:textColor="#ff54759e"
+                android:gravity="center_vertical"
+                android:textSize="20dp"
+                android:paddingRight="17dp"
+                android:background="@drawable/launch_button_states"/>
+
+            <FrameLayout
+                android:layout_width="match_parent"
+                android:layout_height="1px"
+                android:background="#ffd6dee4"/>
+
+            <TextView
+                android:layout_width="match_parent"
+                android:layout_height="60dp"
+                android:id="@+id/settings_button"
+                android:textColor="#ff54759e"
+                android:gravity="center_vertical"
+                android:textSize="20dp"
+                android:paddingRight="17dp"
+                android:background="@drawable/launch_button_states"/>
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+    <FrameLayout
+        android:layout_height="match_parent"
+        android:layout_width="1dp"
+        android:background="#40295274"
+        android:id="@+id/shadow_tablet_side"/>
+
+    <FrameLayout
+        android:layout_height="match_parent"
+        android:layout_width="match_parent"
+        android:id="@+id/shadow_tablet"
+        android:background="#7F000000"
+        android:visibility="gone"/>
+
+</RelativeLayout>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/layout/chat_layout.xml b/TMessagesProj/src/main/res/layout/chat_layout.xml
index 0253fad0c..e9d9bbb11 100644
--- a/TMessagesProj/src/main/res/layout/chat_layout.xml
+++ b/TMessagesProj/src/main/res/layout/chat_layout.xml
@@ -7,7 +7,8 @@
     <org.telegram.ui.Views.FrameLayoutFixed
         android:layout_height="fill_parent"
         android:layout_width="fill_parent"
-        android:paddingBottom="48dp">
+        android:paddingBottom="48dp"
+        android:id="@+id/empty_view">
 
         <TextView
             android:layout_width="wrap_content"
@@ -20,7 +21,6 @@
             android:paddingRight="7dp"
             android:textSize="14dp"
             android:id="@+id/searchEmptyView"
-            android:visibility="gone"
             android:layout_gravity="center"/>
 
         <include
diff --git a/TMessagesProj/src/main/res/layout/launch_layout_tablet.xml b/TMessagesProj/src/main/res/layout/launch_layout_tablet.xml
index 47c514403..740ed46a2 100644
--- a/TMessagesProj/src/main/res/layout/launch_layout_tablet.xml
+++ b/TMessagesProj/src/main/res/layout/launch_layout_tablet.xml
@@ -33,8 +33,6 @@
                 android:gravity="center_vertical"
                 android:textSize="20dp"
                 android:paddingLeft="17dp"
-                android:paddingStart="17dp"
-                android:paddingEnd="17dp"
                 android:background="@drawable/launch_button_states"/>
 
             <FrameLayout
@@ -50,8 +48,6 @@
                 android:gravity="center_vertical"
                 android:textSize="20dp"
                 android:paddingLeft="17dp"
-                android:paddingStart="17dp"
-                android:paddingEnd="17dp"
                 android:background="@drawable/launch_button_states"/>
 
             <FrameLayout
@@ -67,8 +63,6 @@
                 android:gravity="center_vertical"
                 android:textSize="20dp"
                 android:paddingLeft="17dp"
-                android:paddingStart="17dp"
-                android:paddingEnd="17dp"
                 android:background="@drawable/launch_button_states"/>
 
         </LinearLayout>
@@ -89,8 +83,6 @@
                 android:gravity="center_vertical"
                 android:textSize="20dp"
                 android:paddingLeft="17dp"
-                android:paddingStart="17dp"
-                android:paddingEnd="17dp"
                 android:background="@drawable/launch_button_states"/>
 
             <FrameLayout
@@ -106,8 +98,6 @@
                 android:gravity="center_vertical"
                 android:textSize="20dp"
                 android:paddingLeft="17dp"
-                android:paddingStart="17dp"
-                android:paddingEnd="17dp"
                 android:background="@drawable/launch_button_states"/>
 
         </LinearLayout>
diff --git a/TMessagesProj/src/main/res/layout/video_editor_layout.xml b/TMessagesProj/src/main/res/layout/video_editor_layout.xml
index bd07b7f69..0eacd6abd 100644
--- a/TMessagesProj/src/main/res/layout/video_editor_layout.xml
+++ b/TMessagesProj/src/main/res/layout/video_editor_layout.xml
@@ -57,6 +57,8 @@
         android:layout_marginLeft="16dp"
         android:layout_marginRight="16dp"
         android:layout_marginBottom="16dp"
+        android:paddingTop="8dp"
+        android:paddingBottom="8dp"
         android:id="@+id/info_container"
         android:orientation="vertical">
     
@@ -65,8 +67,8 @@
             android:layout_height="wrap_content"
             android:textColor="#f0f0f0"
             android:textSize="15dp"
-            android:layout_marginTop="8dp"
             android:layout_marginLeft="13dp"
+            android:layout_marginRight="13dp"
             android:id="@+id/original_title"/>
 
         <TextView
@@ -75,6 +77,7 @@
             android:textColor="#bebebe"
             android:textSize="15dp"
             android:layout_marginLeft="13dp"
+            android:layout_marginRight="13dp"
             android:id="@+id/original_size"/>
 
         <TextView
@@ -84,6 +87,7 @@
             android:textSize="15dp"
             android:layout_marginTop="10dp"
             android:layout_marginLeft="13dp"
+            android:layout_marginRight="13dp"
             android:id="@+id/edited_title"/>
 
         <TextView
@@ -92,9 +96,19 @@
             android:textColor="#bebebe"
             android:textSize="15dp"
             android:layout_marginLeft="13dp"
-            android:layout_marginBottom="8dp"
+            android:layout_marginRight="13dp"
             android:id="@+id/edited_size"/>
 
+        <CheckBox
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:layout_marginLeft="8dp"
+            android:layout_marginRight="8dp"
+            android:layout_marginTop="6dp"
+            android:textColor="#f0f0f0"
+            android:textSize="15dp"
+            android:id="@+id/compress_video"/>
+
     </LinearLayout>
 
 </FrameLayout>
diff --git a/TMessagesProj/src/main/res/values-ar/strings.xml b/TMessagesProj/src/main/res/values-ar/strings.xml
index c15304dde..c9ffe3de8 100644
--- a/TMessagesProj/src/main/res/values-ar/strings.xml
+++ b/TMessagesProj/src/main/res/values-ar/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName"></string>
     <string name="LanguageNameInEnglish">Arabic</string>
     <string name="LanguageCode">ar</string>
-
     <!--signin view-->
     <string name="YourPhone">  </string>
     <string name="StartText">         </string>
     <string name="ChooseCountry"> </string>
     <string name="WrongCountry">  </string>
-
     <!--code enter view-->
     <string name="YourCode"> </string>
     <string name="SentSmsCode">         </string>
@@ -23,7 +20,6 @@
     <string name="Code"> </string>
     <string name="WrongNumber"> </string>
     <string name="DidNotGetTheCode">  </string>
-
     <!--signup view-->
     <string name="YourName"></string>
     <string name="RegisterText">    </string>
@@ -31,7 +27,6 @@
     <string name="FirstName"> </string>
     <string name="LastName"> </string>
     <string name="CancelRegistration"> </string>
-
     <!--chats view-->
     <string name="Chats"></string>
     <string name="Search"></string>
@@ -42,7 +37,7 @@
     <string name="Yesterday"></string>
     <string name="NoResult">  </string>
     <string name="NoChats">...   </string>
-    <string name="NoChatsHelp">   \n     \n    .</string>
+    <string name="NoChatsHelp">   \n     \n       .</string>
     <string name="WaitingForNetwork">  ...</string>
     <string name="Connecting"> ...</string>
     <string name="Updating"> ...</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat"> </string>
     <string name="HiddenName"> </string>
     <string name="SelectChat"> </string>
-
     <!--broadcasts-->
     <string name="BroadcastList">  </string>
     <string name="NewBroadcastList">   </string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">     </string>
     <string name="AddRecipient"> </string>
     <string name="KickFromBroadcast">    </string>
-
     <!--documents view-->
     <string name="SelectFile"> </string>
     <string name="FreeOfTotal"> %1$s  %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage"> </string>
     <string name="SystemRoot"> </string>
     <string name="SdCard"> </string>
-
     <!--chat view-->
     <string name="Invisible"></string>
     <string name="Typing">  </string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">  </string>
     <string name="ApplyLocalizationFile">  </string>
     <string name="UnsupportedAttachment">  </string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">   </string>
     <string name="EncryptedChatAccepted">   </string>
@@ -161,7 +152,6 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\n        %2$s\n\n: %3$s\n: %4$s\n\n                .\n\n,\n  </string>
     <string name="NotificationContactNewPhoto">%1$s    </string>
     <string name="Reply"></string>
-
     <!--contacts view-->
     <string name="SelectContact">  </string>
     <string name="NoContacts">    </string>
@@ -174,14 +164,12 @@
     <string name="LastSeen"> </string>
     <string name="LastSeenDate"> </string>
     <string name="InviteFriends">  </string>
-
     <!--group create view-->
     <string name="SendMessageTo">  ...</string>
     <string name="EnterGroupNamePlaceholder">  </string>
     <string name="GroupName"> </string>
     <string name="AllContacts">  </string>
     <string name="MembersCount">%1$d/%2$d </string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">  </string>
     <string name="SharedMedia">  </string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">  </string>
     <string name="Notifications"></string>
     <string name="KickFromGroup">  </string>
-
     <!--contact info view-->
     <string name="ShareContact"></string>
     <string name="AddContact"></string>
@@ -220,7 +207,6 @@
     <string name="ShortMessageLifetime1d"></string>
     <string name="ShortMessageLifetime1w"></string>
     <string name="EncryptionKeyDescription">          <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>       <![CDATA[<b>]]>%2$s<![CDATA[</b>]]>,   .<![CDATA[<br><br>]]>    telegram.org</string>
-
     <!--settings view-->
     <string name="ResetNotificationsText">    </string>
     <string name="TextSize">  </string>
@@ -291,11 +277,10 @@
     <string name="WhenConnectedOnWiFi">   </string>
     <string name="WhenRoaming">   </string>
     <string name="NoMediaAutoDownload">  </string>
-
+    <string name="SaveToGallerySettings">  </string>
     <!--media view-->
     <string name="NoMedia">   </string>
     <string name="CancelDownload"> </string>
-
     <!--map view-->
     <string name="MyLocation"></string>
     <string name="Map"></string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway"> </string>
     <string name="SendLocation"> </string>
     <string name="ShareLocation"> </string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">  </string>
     <string name="SaveToGallery">  </string>
@@ -313,12 +297,12 @@
     <string name="Gallery"></string>
     <string name="AllPhotos"> </string>
     <string name="NoPhotos">    </string>
-
     <!--edit video view-->
     <string name="EditVideo"> </string>
     <string name="OriginalVideo"> </string>
     <string name="EditedVideo">  </string>
-
+    <string name="SendingVideo">   ...</string>
+    <string name="CompressVideo">  </string>
     <!--button titles-->
     <string name="Next"></string>
     <string name="Back"></string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto"> </string>
     <string name="Set"></string>
     <string name="OK"></string>
-
     <!--messages-->
     <string name="ActionKickUser">un1  un2</string>
     <string name="ActionLeftUser">   un1</string>
@@ -359,7 +342,7 @@
     <string name="ActionYouCreateGroup">   </string>
     <string name="ActionKickUserYou">un1  </string>
     <string name="ActionAddUserYou">un1  </string>
-    <string name="UnsuppotedMedia">       .    :\nhttp://telegram.org/update</string>
+    <string name="UnsuppotedMedia">       .    : http://telegram.org/update</string>
     <string name="AttachPhoto"></string>
     <string name="AttachVideo"> </string>
     <string name="AttachLocation"></string>
@@ -369,7 +352,6 @@
     <string name="FromYou"></string>
     <string name="ActionTakeScreenshootYou">    !</string>
     <string name="ActionTakeScreenshoot">un1    !</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">   </string>
     <string name="CodeExpired">         </string>
@@ -398,7 +380,6 @@
     <string name="AreYouSureDeleteContact">         </string>
     <string name="AreYouSureSecretChat">        </string>
     <string name="ForwardFromMyName">   </string>
-
     <!--Intro view-->
     <string name="Page1Title"></string>
     <string name="Page2Title"></string>
@@ -407,15 +388,14 @@
     <string name="Page5Title"></string>
     <string name="Page6Title"> </string>
     <string name="Page7Title"></string>
-    <string name="Page1Message">      </string>
-    <string name="Page2Message"><![CDATA[<b></b>]]>        .</string>
+    <string name="Page1Message">    .<![CDATA[<br/>]]>    .</string>
+    <string name="Page2Message"><![CDATA[<b></b>]]>       .</string>
     <string name="Page3Message"><![CDATA[<b></b>]]>  .   .   .</string>
     <string name="Page4Message"><![CDATA[<b></b>]]>        .</string>
     <string name="Page5Message"><![CDATA[<b></b>]]>        .</string>
     <string name="Page6Message"><![CDATA[<b></b>]]>         .</string>
     <string name="Page7Message"><![CDATA[<b></b>]]>       </string>
     <string name="StartMessaging"> </string>
-
     <!--plurals-->
     <string name="Members_zero">  </string>
     <string name="Members_one">%1$d </string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few"> %1$d  </string>
     <string name="FromContacts_many"> %1$d  </string>
     <string name="FromContacts_other"> %1$d  </string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-de/strings.xml b/TMessagesProj/src/main/res/values-de/strings.xml
index 0c32ef1b9..148303008 100644
--- a/TMessagesProj/src/main/res/values-de/strings.xml
+++ b/TMessagesProj/src/main/res/values-de/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Deutsch</string>
     <string name="LanguageNameInEnglish">German</string>
     <string name="LanguageCode">de</string>
-
     <!--signin view-->
     <string name="YourPhone">Dein Telefon</string>
-    <string name="StartText">Bitte besttige deine Landesvorwahl und deine Telefonnummer.</string>
+    <string name="StartText">Bitte Landeskennzahl und\nTelefonnummer besttigen.</string>
     <string name="ChooseCountry">Whle ein Land</string>
     <string name="WrongCountry">Falsche Landesvorwahl</string>
-
     <!--code enter view-->
     <string name="YourCode">Dein Code</string>
     <string name="SentSmsCode">Wir haben dir eine SMS mit einem Aktivierungscode zugeschickt</string>
@@ -23,7 +20,6 @@
     <string name="Code">Code</string>
     <string name="WrongNumber">Falsche Nummer?</string>
     <string name="DidNotGetTheCode">Code nicht erhalten?</string>
-
     <!--signup view-->
     <string name="YourName">Dein Name</string>
     <string name="RegisterText">Gib deinen Vor- und Nachnamen ein</string>
@@ -31,7 +27,6 @@
     <string name="FirstName">Vorname (erforderlich)</string>
     <string name="LastName">Nachname (optional)</string>
     <string name="CancelRegistration">Registrierung abbrechen</string>
-
     <!--chats view-->
     <string name="Chats">Chats</string>
     <string name="Search">Suche</string>
@@ -42,7 +37,7 @@
     <string name="Yesterday">gestern</string>
     <string name="NoResult">Keine Ergebnisse</string>
     <string name="NoChats">Noch keine Chats</string>
-    <string name="NoChatsHelp">Beginne Telegram zu nutzen, indem du\neine neue Nachricht erstellst (rechte obere Ecke)\noder deine Kontakte aufrufst.</string>
+    <string name="NoChatsHelp">Tippe rechts oben fr deine erste\nChatnachricht, oder auf den Menknopf\num die restlichen Optionen zu ffnen.</string>
     <string name="WaitingForNetwork">Warte auf Netzwerk...</string>
     <string name="Connecting">Verbinde</string>
     <string name="Updating">Aktualisiere</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat">Lschen und beenden</string>
     <string name="HiddenName">Versteckter Name</string>
     <string name="SelectChat">Chat auswhlen</string>
-
     <!--broadcasts-->
     <string name="BroadcastList">Broadcast Liste</string>
     <string name="NewBroadcastList">Neue Broadcast Liste</string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">Du hast eine Broadcast Liste erstellt</string>
     <string name="AddRecipient">Empfnger hinzufgen</string>
     <string name="KickFromBroadcast">Aus Broadcast Liste entfernen</string>
-
     <!--documents view-->
     <string name="SelectFile">Datei auswhlen</string>
     <string name="FreeOfTotal">Freier Speicher: %1$s von %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage">Externer Speicher</string>
     <string name="SystemRoot">Systemverzeichnis</string>
     <string name="SdCard">SD-Karte</string>
-
     <!--chat view-->
     <string name="Invisible">unsichtbar</string>
     <string name="Typing">schreibt</string>
@@ -102,7 +94,7 @@
     <string name="TypeMessage">Nachricht verfassen</string>
     <string name="DOWNLOAD">Download</string>
     <string name="Selected">Ausgewhlt: %d</string>
-    <string name="ShareMyContactInfo">MEINE KONTAKTDATEN TEILEN</string>
+    <string name="ShareMyContactInfo">MEINE TELEFONNUMMER TEILEN</string>
     <string name="AddToContacts">ZU KONTAKTEN HINZUFGEN</string>
     <string name="EncryptedPlaceholderTitleIncoming">%s hat dich zu einem geheimen Chat eingeladen.</string>
     <string name="EncryptedPlaceholderTitleOutgoing">Du hast %s zu einem geheimen Chat eingeladen.</string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">In Downloads speichern</string>
     <string name="ApplyLocalizationFile">Sprachdatei benutzen</string>
     <string name="UnsupportedAttachment">Nicht untersttzte Datei</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Geheimen Chat angefordert</string>
     <string name="EncryptedChatAccepted">Geheimen Chat angenommen</string>
@@ -161,7 +152,6 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\nWir haben eine Anmeldung von einem neuen Gert am %2$s festgestellt.\n\nGert: %3$s\nStandort: %4$s\n\nWenn du das nicht selbst gewesen bist, melde alle anderen Sitzungen in den Telegram Einstellungen unverzglich ab.\n\nMit freundlichen Gren,\nDas Telegram Team</string>
     <string name="NotificationContactNewPhoto">%1$s hat das Profilbild gendert</string>
     <string name="Reply">Beantworten</string>
-
     <!--contacts view-->
     <string name="SelectContact">Kontakt auswhlen</string>
     <string name="NoContacts">Noch keine Kontakte</string>
@@ -174,14 +164,12 @@
     <string name="LastSeen">zul. online</string>
     <string name="LastSeenDate">zul. online</string>
     <string name="InviteFriends">Freunde einladen</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Sende Nachricht an</string>
     <string name="EnterGroupNamePlaceholder">Gruppenname</string>
     <string name="GroupName">Gruppenname</string>
     <string name="AllContacts">ALLE KONTAKTE</string>
     <string name="MembersCount">%1$d/%2$d Mitglieder</string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">GRUPPENNAMEN EINGEBEN</string>
     <string name="SharedMedia">Geteilte Medien</string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">Gruppe lschen und verlassen</string>
     <string name="Notifications">Mitteilungen</string>
     <string name="KickFromGroup">Aus der Gruppe entfernen</string>
-
     <!--contact info view-->
     <string name="ShareContact">Teilen</string>
     <string name="AddContact">Hinzufgen</string>
@@ -208,7 +195,7 @@
     <string name="PHONE">TELEFON</string>
     <string name="StartEncryptedChat">Geheimen Chat starten</string>
     <string name="CreateEncryptedChatError">Es ist ein Fehler aufgetreten.</string>
-    <string name="CreateEncryptedChatOutdatedError">Konnte keinen geheimen Chat mit %1$s starten.\n\n%2$s benutzt eine ltere Version von Telegram und muss diese erst aktualisieren.</string>
+    <string name="CreateEncryptedChatOutdatedError">Geheimer Chat konnte mit %1$s nicht gestartet werden.\n\n%2$s benutzt eine ltere Version von Telegram und muss diese erst aktualisieren.</string>
     <string name="SecretTitle">Geheimer Chat</string>
     <string name="EncryptionKey">Geheimer Schlssel</string>
     <string name="MessageLifetime">Selbstzerstrungs-Timer</string>
@@ -219,8 +206,7 @@
     <string name="ShortMessageLifetime1h">1 Std.</string>
     <string name="ShortMessageLifetime1d">1 Tag</string>
     <string name="ShortMessageLifetime1w">1 Woche</string>
-    <string name="EncryptionKeyDescription">Dieses Bild ist eine Visualisierung des geheimen Schlssels fr den geheimen Chat mit <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Wenn dieses Bild auf <![CDATA[<b>]]>%2$s\s<![CDATA[</b>]]> Telefon genau so aussieht, ist euer Chat zu 200%% sicher.<![CDATA[<br><br>]]>Erfahre mehr ber die Sicherheit auf telegram.org</string>
-
+    <string name="EncryptionKeyDescription">Das ist eine Darstellung des Schlssels fr den Geheimen Chat mit <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Wenn dieses Bild auf <![CDATA[<b>]]>%2$s\s<![CDATA[</b>]]>s Telefon genau so aussieht, ist euer Chat zu 200%% sicher.<![CDATA[<br><br>]]>Erfahre mehr auf telegram.org</string>
     <!--settings view-->
     <string name="ResetNotificationsText">Alle Einstellungen fr Mitteilungen zurcksetzen</string>
     <string name="TextSize">Textgre fr Nachrichten</string>
@@ -228,7 +214,7 @@
     <string name="EnableAnimations">Animationen aktivieren</string>
     <string name="EnableMarkdown">Enable Markdown</string>
     <string name="Unblock">Freigeben</string>
-    <string name="UnblockText">Tippe und halte einen Benutzer, um ihn freizugeben.</string>
+    <string name="UnblockText">Gedrckt halten um freizugeben.</string>
     <string name="NoBlocked">Keine blockierten Benutzer</string>
     <string name="YourPhoneNumber">DEINE TELEFONNUMMER</string>
     <string name="MessageNotifications">NACHRICHTEN</string>
@@ -284,18 +270,17 @@
     <string name="BadgeNumber">Kennzeichensymbol</string>
     <string name="Short">Kurz</string>
     <string name="Long">Lang</string>
-    <string name="SystemDefault">Systemstandard</string>
-    <string name="SettingsDefault">Standardeinstellungen</string>
-    <string name="AutomaticMediaDownload">AUTOMATISCHER DOWNLOAD VON MEDIEN</string>
+    <string name="SystemDefault">Systemvorgabe</string>
+    <string name="SettingsDefault">Telegramvorgabe</string>
+    <string name="AutomaticMediaDownload">AUTOMATISCHER MEDIENDOWNLOAD</string>
     <string name="WhenUsingMobileData">ber Mobilfunk</string>
     <string name="WhenConnectedOnWiFi">ber W-LAN</string>
     <string name="WhenRoaming">bei Roaming</string>
     <string name="NoMediaAutoDownload">kein automatischer Download</string>
-
+    <string name="SaveToGallerySettings">In der Galerie speichern</string>
     <!--media view-->
     <string name="NoMedia">Noch keine geteilten Medien vorhanden</string>
     <string name="CancelDownload">Download abbrechen</string>
-
     <!--map view-->
     <string name="MyLocation">Mein Standort</string>
     <string name="Map">Karte</string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway">km entfernt</string>
     <string name="SendLocation">Standort senden</string>
     <string name="ShareLocation">Teile Standort</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Zeige alle Medien</string>
     <string name="SaveToGallery">In der Galerie speichern</string>
@@ -313,12 +297,12 @@
     <string name="Gallery">Galerie</string>
     <string name="AllPhotos">Alle Fotos</string>
     <string name="NoPhotos">Noch keine Fotos</string>
-
     <!--edit video view-->
     <string name="EditVideo">Video bearbeiten</string>
     <string name="OriginalVideo">Originalvideo</string>
     <string name="EditedVideo">Bearbeitetes Video</string>
-
+    <string name="SendingVideo">Sende Video...</string>
+    <string name="CompressVideo">Video komprimieren</string>
     <!--button titles-->
     <string name="Next">Weiter</string>
     <string name="Back">Zurck</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto">Foto ffnen</string>
     <string name="Set">Whlen</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 hat un2 aus der Gruppe entfernt</string>
     <string name="ActionLeftUser">un1 hat die Gruppe verlassen</string>
@@ -369,7 +352,6 @@
     <string name="FromYou">Du</string>
     <string name="ActionTakeScreenshootYou">Du hast ein Bildschirmfoto gemacht!</string>
     <string name="ActionTakeScreenshoot">un1 hat ein Bildschirmfoto gemacht!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Ungltige Telefonnummer</string>
     <string name="CodeExpired">Code ist abgelaufen, bitte melde dich erneut an</string>
@@ -396,9 +378,8 @@
     <string name="AreYouSureBlockContact">Diesen Kontakt wirklich blockieren?</string>
     <string name="AreYouSureUnblockContact">Blockierung fr diesen Kontakt wirklich aufheben?</string>
     <string name="AreYouSureDeleteContact">Diesen Kontakt wirklich lschen?</string>
-    <string name="AreYouSureSecretChat">Wirklich einen geheimen Chat starten?</string>
+    <string name="AreYouSureSecretChat">Geheimen Chat starten?</string>
     <string name="ForwardFromMyName">mit meinem Namen weiterleiten</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Schnell</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Leistungsstark</string>
     <string name="Page6Title">Cloud-Basiert</string>
     <string name="Page7Title">Vertraulich</string>
-    <string name="Page1Message">Willkommen im Zeitalter der sicheren und schnellen Kommunikation.</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> stellt Nachrichten schneller zu als andere Anwendungen</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> ist fr immer kostenlos. Keine Werbung. Keine Abo-Gebhr.</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> schtzt deine Nachrichten vor Hacker-Angriffen</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> untersttzt unbegrenzt groe Chats und Mediendateien</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> lsst sich von verschiedenen Gerten gleichzeitig nutzen</string>
-    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]>-Nachrichten sind stark verschlsselt und knnen sich selbst zerstren</string>
+    <string name="Page1Message">Die <![CDATA[<b>schnellste</b>]]> Messaging App der Welt.<![CDATA[<br/><b>Kostenlos</b>]]> und <![CDATA[<b>sicher</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> stellt Nachrichten schneller<![CDATA[<br/>]]>zu als andere Anwendungen.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> ist fr immer kostenlos.<![CDATA[<br/>]]>Keine Werbung. Keine Abo-Gebhr.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> schtzt deine Nachrichten <![CDATA[<br/>]]>vor Hacker-Angriffen.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> untersttzt unbegrenzt groe <![CDATA[<br/>]]>Chats und Mediendateien.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> lsst sich von verschiedenen Gerten<![CDATA[<br/>]]>gleichzeitig nutzen.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]>-Nachrichten sind stark verschlsselt<![CDATA[<br/>]]>und knnen sich selbst zerstren.</string>
     <string name="StartMessaging">Jetzt beginnen</string>
-
     <!--plurals-->
     <string name="Members_zero">keine Mitglieder</string>
     <string name="Members_one">%1$d Mitglied</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">von %1$d Kontakten</string>
     <string name="FromContacts_many">von %1$d Kontakten</string>
     <string name="FromContacts_other">von %1$d Kontakten</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-es/strings.xml b/TMessagesProj/src/main/res/values-es/strings.xml
index 247db3cf9..bf8ba050a 100644
--- a/TMessagesProj/src/main/res/values-es/strings.xml
+++ b/TMessagesProj/src/main/res/values-es/strings.xml
@@ -4,45 +4,40 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Espaol</string>
     <string name="LanguageNameInEnglish">Spanish</string>
     <string name="LanguageCode">es</string>
-
     <!--signin view-->
     <string name="YourPhone">Tu telfono</string>
-    <string name="StartText">Por favor, confirma tu cdigo de pas\ne introduce tu nmero.</string>
+    <string name="StartText">Por favor, confirma tu cdigo de pas\ny pon tu nmero de telfono.</string>
     <string name="ChooseCountry">Elige un pas</string>
     <string name="WrongCountry">Cdigo de pas incorrecto</string>
-
     <!--code enter view-->
     <string name="YourCode">Tu cdigo</string>
-    <string name="SentSmsCode">Hemos enviado un SMS con un cdigo de activacin a tu telfono</string>
+    <string name="SentSmsCode">Enviamos un SMS con el cdigo de activacin al nmero</string>
     <string name="CallText">Te llamaremos en</string>
     <string name="Calling">Llamndote...</string>
     <string name="Code">Cdigo</string>
     <string name="WrongNumber">Nmero incorrecto?</string>
     <string name="DidNotGetTheCode">No recibiste el cdigo?</string>
-
     <!--signup view-->
     <string name="YourName">Tu nombre</string>
-    <string name="RegisterText">Ingresa tu nombre y apellidos</string>
+    <string name="RegisterText">Ingresa tu nombre y apellido</string>
     <!--<string name="RegisterText">Set up your name and picture</string>-->
     <string name="FirstName">Nombre (requerido)</string>
     <string name="LastName">Apellido (opcional)</string>
     <string name="CancelRegistration">Cancelar registro</string>
-
     <!--chats view-->
     <string name="Chats">Chats</string>
     <string name="Search">Buscar</string>
-    <string name="NewMessages">Nuevo mensaje</string>
+    <string name="NewMessages">Nuevos mensajes</string>
     <string name="Settings">Ajustes</string>
     <string name="Contacts">Contactos</string>
     <string name="NewGroup">Nuevo grupo</string>
     <string name="Yesterday">ayer</string>
     <string name="NoResult">Sin resultados</string>
-    <string name="NoChats">No tienes conversaciones todava...</string>
-    <string name="NoChatsHelp">Empieza a chatear presionando el\nbotn de Nuevo mensaje en la esquina superior\nderecha o ve a la seccin de Contactos.</string>
+    <string name="NoChats">An sin chats...</string>
+    <string name="NoChatsHelp">Enva mensajes pulsando el botn para\nredactar, en la parte superior derecha,\no pulsa el botn men para ms opciones.</string>
     <string name="WaitingForNetwork">Esperando red...</string>
     <string name="Connecting">Conectando...</string>
     <string name="Updating">Actualizando...</string>
@@ -51,50 +46,47 @@
     <string name="EncryptionRejected">Chat secreto cancelado</string>
     <string name="EncryptionProcessing">Intercambiando claves de cifrado...</string>
     <string name="EncryptedChatStartedOutgoing">%s se uni a tu chat secreto.</string>
-    <string name="EncryptedChatStartedIncoming">Te has unido al chat secreto.</string>
-    <string name="ClearHistory">Limpiar historial</string>
+    <string name="EncryptedChatStartedIncoming">Te uniste al chat secreto.</string>
+    <string name="ClearHistory">Borrar historial</string>
     <string name="DeleteChat">Eliminar y salir</string>
     <string name="HiddenName">Nombre oculto</string>
-    <string name="SelectChat">Selecciona el chat</string>
-
+    <string name="SelectChat">Elige el chat</string>
     <!--broadcasts-->
     <string name="BroadcastList">Lista de difusin</string>
-    <string name="NewBroadcastList">Nueva lista de difusin</string>
-    <string name="EnterListName">Ingresa el nombre de la lista</string>
+    <string name="NewBroadcastList">Nueva difusin</string>
+    <string name="EnterListName">Nombre de la lista</string>
     <string name="YouCreatedBroadcastList">Creaste una lista de difusin</string>
     <string name="AddRecipient">Aadir destinatario</string>
     <string name="KickFromBroadcast">Quitar de la lista de difusin</string>
-
     <!--documents view-->
-    <string name="SelectFile">Seleccionar archivo</string>
+    <string name="SelectFile">Elegir archivo</string>
     <string name="FreeOfTotal">%1$s de %2$s libres</string>
     <string name="UnknownError">Error desconocido</string>
     <string name="AccessError">Error de acceso</string>
-    <string name="NoFiles">No hay archivos an...</string>
-    <string name="FileUploadLimit">El tamao del archivo no debe superar los %1$s</string>
+    <string name="NoFiles">An sin archivos...</string>
+    <string name="FileUploadLimit">El archivo no debe superar los %1$s</string>
     <string name="NotMounted">Almacenamiento no montado</string>
     <string name="UsbActive">Transferencia USB activa</string>
     <string name="InternalStorage">Almacenamiento Interno</string>
     <string name="ExternalStorage">Almacenamiento Externo</string>
     <string name="SystemRoot">Raz del Sistema</string>
     <string name="SdCard">Tarjeta SD</string>
-
     <!--chat view-->
     <string name="Invisible">invisible</string>
-    <string name="Typing">escribiendo...</string>
+    <string name="Typing">escribe...</string>
     <string name="Attach">Adjuntar</string>
-    <string name="IsTyping">est escribiendo...</string>
-    <string name="AreTyping">estn escribiendo...</string>
-    <string name="GotAQuestion">Tienes una pregunta\nsobre Telegram?</string>
+    <string name="IsTyping">escribe...</string>
+    <string name="AreTyping">escriben...</string>
+    <string name="GotAQuestion">Tienes preguntas\nsobre Telegram?</string>
     <string name="ChatTakePhoto">Hacer foto</string>
     <string name="ChatGallery">Galera</string>
     <string name="ChatLocation">Ubicacin</string>
     <string name="ChatVideo">Vdeo</string>
     <string name="ChatDocument">Archivo</string>
-    <string name="NoMessages">No hay mensajes an...</string>
+    <string name="NoMessages">An sin mensajes...</string>
     <string name="ViewPhoto">Ver foto</string>
     <string name="ViewLocation">Ver ubicacin</string>
-    <string name="ViewVideo">Reproducir vdeo</string>
+    <string name="ViewVideo">Ver vdeo</string>
     <string name="ForwardedMessage">Mensaje reenviado</string>
     <string name="From">De</string>
     <string name="NoRecent">No hay recientes</string>
@@ -102,24 +94,23 @@
     <string name="TypeMessage">Escribe un mensaje</string>
     <string name="DOWNLOAD">Descargar</string>
     <string name="Selected">Seleccionado: %d</string>
-    <string name="ShareMyContactInfo">COMPARTIR MI INFORMACIN DE CONTACTO</string>
+    <string name="ShareMyContactInfo">COMPARTIR MI NMERO</string>
     <string name="AddToContacts">AADIR A CONTACTOS</string>
-    <string name="EncryptedPlaceholderTitleIncoming">%s te ha invitado a un chat secreto.</string>
-    <string name="EncryptedPlaceholderTitleOutgoing">Has invitado a %s a un chat secreto.</string>
+    <string name="EncryptedPlaceholderTitleIncoming">%s te invit a un chat secreto.</string>
+    <string name="EncryptedPlaceholderTitleOutgoing">Invitaste a %s a un chat secreto.</string>
     <string name="EncryptedDescriptionTitle">Los chats secretos:</string>
     <string name="EncryptedDescription1">Usan cifrado end-to-end</string>
     <string name="EncryptedDescription2">No dejan rastro en el servidor</string>
     <string name="EncryptedDescription3">Tienen autodestruccin de mensajes</string>
     <string name="EncryptedDescription4">No permiten reenvos de mensajes</string>
-    <string name="YouWereKicked">Te han expulsado de este grupo</string>
-    <string name="YouLeft">Has abandonado este grupo</string>
+    <string name="YouWereKicked">Te expulsaron de este grupo</string>
+    <string name="YouLeft">Dejaste este grupo</string>
     <string name="DeleteThisGroup">Eliminar este grupo</string>
-    <string name="DeleteThisChat">Eliminar esta conversacin</string>
+    <string name="DeleteThisChat">Eliminar este chat</string>
     <string name="SlideToCancel">DESLIZA PARA CANCELAR</string>
     <string name="SaveToDownloads">Guardar en descargas</string>
-    <string name="ApplyLocalizationFile">Aplicar archivo de traduccin</string>
+    <string name="ApplyLocalizationFile">Aplicar traduccin</string>
     <string name="UnsupportedAttachment">Adjunto no soportado</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Chat secreto solicitado</string>
     <string name="EncryptedChatAccepted">Chat secreto iniciado</string>
@@ -150,21 +141,20 @@
     <string name="NotificationMessageGroupMap">%1$s envi una ubicacin al grupo %2$s</string>
     <string name="NotificationMessageGroupDocument">%1$s envi un archivo al grupo %2$s</string>
     <string name="NotificationMessageGroupAudio">%1$s envi un audio al grupo %2$s</string>
-    <string name="NotificationInvitedToGroup">%1$s te ha invitado al grupo %2$s</string>
+    <string name="NotificationInvitedToGroup">%1$s te invit al grupo %2$s</string>
     <string name="NotificationEditedGroupName">%1$s cambi el nombre del grupo %2$s</string>
     <string name="NotificationEditedGroupPhoto">%1$s cambi la foto del grupo %2$s</string>
     <string name="NotificationGroupAddMember">%1$s invit a %3$s al grupo %2$s</string>
     <string name="NotificationGroupKickMember">%1$s expuls a %3$s del grupo %2$s</string>
-    <string name="NotificationGroupKickYou">%1$s te ha expulsado del grupo %2$s</string>
-    <string name="NotificationGroupLeftMember">%1$s abandon el grupo %2$s</string>
+    <string name="NotificationGroupKickYou">%1$s te expuls del grupo %2$s</string>
+    <string name="NotificationGroupLeftMember">%1$s dej el grupo %2$s</string>
     <string name="NotificationContactJoined">%1$s se uni a Telegram!</string>
-    <string name="NotificationUnrecognizedDevice">%1$s,\nHemos detectado un inicio de sesin en tu cuenta desde un nuevo dispositivo, el %2$s\n\nDispositivo: %3$s\nUbicacin: %4$s\n\nSi no eras t, puedes ir a Ajustes - Cerrar todas las otras sesiones.\n\nAtentamente,\nEl Equipo de Telegram</string>
+    <string name="NotificationUnrecognizedDevice">%1$s,\nDetectamos un inicio de sesin en tu cuenta desde un nuevo dispositivo, el %2$s\n\nDispositivo: %3$s\nUbicacin: %4$s\n\nSi no eras t, puedes ir a Ajustes - Cerrar todas las otras sesiones.\n\nAtentamente,\nEl equipo de Telegram</string>
     <string name="NotificationContactNewPhoto">%1$s actualiz su foto de perfil</string>
     <string name="Reply">Responder</string>
-
     <!--contacts view-->
-    <string name="SelectContact">Seleccionar contacto</string>
-    <string name="NoContacts">No hay contactos an</string>
+    <string name="SelectContact">Elegir contacto</string>
+    <string name="NoContacts">An sin contactos</string>
     <string name="InviteText">Oye, cambimonos a Telegram: http://telegram.org/dl2</string>
     <string name="TodayAt">hoy a las</string>
     <string name="YesterdayAt">ayer a las</string>
@@ -174,25 +164,22 @@
     <string name="LastSeen">lt. vez</string>
     <string name="LastSeenDate">lt. vez el</string>
     <string name="InviteFriends">Invitar a amigos</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Enviar mensaje a...</string>
-    <string name="EnterGroupNamePlaceholder">El nombre del grupo</string>
+    <string name="EnterGroupNamePlaceholder">Nombre del grupo</string>
     <string name="GroupName">Nombre del grupo</string>
     <string name="AllContacts">TODOS LOS CONTACTOS</string>
     <string name="MembersCount">%1$d/%2$d miembros</string>
-
     <!--group info view-->
-    <string name="EnterGroupNameTitle">INGRESA EL NOMBRE DEL GRUPO</string>
+    <string name="EnterGroupNameTitle">PON EL NOMBRE DEL GRUPO</string>
     <string name="SharedMedia">Fotos y vdeos</string>
     <string name="GroupInfo">Informacin </string>
     <string name="SHAREDMEDIA">FOTOS Y VDEOS</string>
     <string name="SETTINGS">AJUSTES</string>
     <string name="AddMember">Aadir miembro</string>
-    <string name="DeleteAndExit">Eliminar y salir del grupo</string>
+    <string name="DeleteAndExit">Eliminar y dejar el grupo</string>
     <string name="Notifications">Notificaciones</string>
     <string name="KickFromGroup">Expulsar del grupo</string>
-
     <!--contact info view-->
     <string name="ShareContact">Compartir</string>
     <string name="AddContact">Aadir</string>
@@ -204,32 +191,31 @@
     <string name="PhoneWork">TRABAJO</string>
     <string name="PhoneOther">OTRO</string>
     <string name="PhoneMain">PRINCIPAL</string>
-    <string name="ContactInfo">Informacin del contacto</string>
+    <string name="ContactInfo">Informacin</string>
     <string name="PHONE">TELFONO</string>
     <string name="StartEncryptedChat">Iniciar chat secreto</string>
     <string name="CreateEncryptedChatError">Ocurri un error.</string>
-    <string name="CreateEncryptedChatOutdatedError">No podemos crear un chat secreto con %1$s.\n\n%2$s est usando una versin antigua de Telegram y debe actualizarla primero.</string>
+    <string name="CreateEncryptedChatOutdatedError">No podemos crear un chat secreto con %1$s.\n\n%2$s est usando una versin antigua de Telegram y debe actualizarla.</string>
     <string name="SecretTitle">Chat secreto</string>
     <string name="EncryptionKey">Clave de cifrado</string>
     <string name="MessageLifetime">Autodestruccin</string>
-    <string name="ShortMessageLifetimeForever">Apagado</string>
+    <string name="ShortMessageLifetimeForever">Apagada</string>
     <string name="ShortMessageLifetime2s">2s</string>
     <string name="ShortMessageLifetime5s">5s</string>
     <string name="ShortMessageLifetime1m">1m</string>
     <string name="ShortMessageLifetime1h">1h</string>
     <string name="ShortMessageLifetime1d">1d</string>
-    <string name="ShortMessageLifetime1w">1sem</string>
-    <string name="EncryptionKeyDescription">Esta imagen es una visualizacin de la clave de cifrado para el chat secreto con <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Si esta imagen se visualiza de la misma manera en el telfono de <![CDATA[<b>]]>%2$s<![CDATA[</b>]]>, tu chat es seguro en un 200%%.<![CDATA[<br><br>]]>Aprende ms en telegram.org</string>
-
+    <string name="ShortMessageLifetime1w">1S</string>
+    <string name="EncryptionKeyDescription">Esta imagen es una visualizacin de la clave de cifrado para el chat secreto con <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Si esta imagen se ve igual en el telfono de <![CDATA[<b>]]>%2$s<![CDATA[</b>]]>, tu chat es seguro en un 200%%.<![CDATA[<br><br>]]>Aprende ms en telegram.org</string>
     <!--settings view-->
-    <string name="ResetNotificationsText">Restablecer todas las notificaciones</string>
+    <string name="ResetNotificationsText">Restablecer las notificaciones</string>
     <string name="TextSize">Tamao del texto</string>
     <string name="AskAQuestion">Hacer una pregunta</string>
     <string name="EnableAnimations">Activar animaciones</string>
     <string name="EnableMarkdown">Enable Markdown</string>
     <string name="Unblock">Desbloquear</string>
-    <string name="UnblockText">Mantn pulsado un usuario para desbloquearlo.</string>
-    <string name="NoBlocked">No hay usuarios bloqueados</string>
+    <string name="UnblockText">Para desbloquear, mantn pulsado sobre un usuario.</string>
+    <string name="NoBlocked">Sin usuarios bloqueados</string>
     <string name="YourPhoneNumber">TU NMERO DE TELFONO</string>
     <string name="MessageNotifications">NOTIFICACIONES DE MENSAJES</string>
     <string name="Alert">Alerta</string>
@@ -239,16 +225,16 @@
     <string name="InAppNotifications">NOTIFICACIONES EN LA APP</string>
     <string name="InAppSounds">Sonidos en la app</string>
     <string name="InAppVibrate">Vibracin en la app</string>
-    <string name="Vibrate">Vibracin</string>
+    <string name="Vibrate">Vibraciones</string>
     <string name="InAppPreview">Vista previa en la app</string>
     <string name="Reset">RESTABLECER</string>
-    <string name="ResetAllNotifications">Restablecer todas las notificaciones</string>
+    <string name="ResetAllNotifications">Restablecer las notificaciones</string>
     <string name="UndoAllCustom">Deshacer las notificaciones personalizadas para todos tus usuarios y grupos</string>
     <string name="NotificationsAndSounds">Notificaciones y sonidos</string>
     <string name="BlockedUsers">Usuarios bloqueados</string>
     <string name="SaveIncomingPhotos">Guardar fotos entrantes</string>
     <string name="LogOut">Cerrar sesin</string>
-    <string name="YourFirstNameAndLastName">TU NOMBRE Y APELLIDOS</string>
+    <string name="YourFirstNameAndLastName">TU NOMBRE Y APELLIDO</string>
     <string name="NoSound">Sin sonido</string>
     <string name="Default">Por defecto</string>
     <string name="Support">SOPORTE</string>
@@ -260,16 +246,16 @@
     <string name="ContactJoined">Un contacto se uni a Telegram</string>
     <string name="Pebble">PEBBLE</string>
     <string name="Language">Idioma</string>
-    <string name="AskAQuestionInfo">Por favor, ten en cuenta que el Soporte de Telegram est hecho por voluntarios. Intentamos responder lo antes posible, pero puede tomar un tiempo.<![CDATA[<br><br>]]>Por favor, echa un vistazo a las <![CDATA[<a href=http://telegram.org/faq/es>Preguntas Frecuentes de Telegram</a>]]>: tienen importantes <![CDATA[<a href=http://telegram.org/faq/es#solucin-de-problemas>soluciones a problemas</a>]]> y respuestas para la mayora de las preguntas.</string>
+    <string name="AskAQuestionInfo">Por favor, considera que el soporte de Telegram est hecho por voluntarios. Respondemos lo antes posible, pero puede tomar tiempo.<![CDATA[<br><br>]]>Si quieres, mira las <![CDATA[<a href=http://telegram.org/faq/es>preguntas frecuentes de Telegram</a>]]>: tienen <![CDATA[<a href=http://telegram.org/faq/es#solucin-de-problemas>soluciones a problemas</a>]]>, y respuestas para la mayora de las preguntas.</string>
     <string name="AskButton">Preguntar</string>
     <string name="TelegramFaq">Preguntas frecuentes</string>
     <string name="TelegramFaqUrl">https://telegram.org/faq/es</string>
     <string name="DeleteLocalization">Eliminar traduccin?</string>
     <string name="IncorrectLocalization">Archivo de traduccin incorrecto</string>
-    <string name="Enabled">Activado</string>
-    <string name="Disabled">Desactivado</string>
+    <string name="Enabled">Activadas</string>
+    <string name="Disabled">Desactivadas</string>
     <string name="NotificationsService">Servicio de notificaciones</string>
-    <string name="NotificationsServiceDisableInfo">Si los Servicios de Google Play son suficientes para que recibas las notificaciones, puedes desactivar el Servicio de notificaciones. Sin embargo, te recomendamos que lo dejes activo para mantener funcionando la aplicacin en segundo plano y recibir las notificaciones al instante.</string>
+    <string name="NotificationsServiceDisableInfo">Si tus notificaciones funcionan bien con los Servicios de Google Play, puedes desactivar el Servicio de notificaciones. Sin embargo, recomendamos que lo dejes activo para mantener la app en segundo plano y recibir notificaciones al instante.</string>
     <string name="SortBy">Ordenar por</string>
     <string name="ImportContacts">Importar contactos</string>
     <string name="WiFiOnly">Slo va Wi-Fi</string>
@@ -277,25 +263,24 @@
     <string name="SortLastName">Apellido</string>
     <string name="LedColor">Color del LED</string>
     <string name="PopupNotification">Notificaciones emergentes</string>
-    <string name="NoPopup">Sin notificacin emergente</string>
-    <string name="OnlyWhenScreenOn">Slo con pantalla encendida</string>
-    <string name="OnlyWhenScreenOff">Slo con pantalla apagada</string>
-    <string name="AlwaysShowPopup">Siempre mostrar notificacin emergente</string>
+    <string name="NoPopup">Desactivadas</string>
+    <string name="OnlyWhenScreenOn">Con pantalla encendida</string>
+    <string name="OnlyWhenScreenOff">Con pantalla apagada</string>
+    <string name="AlwaysShowPopup">Mostrar siempre </string>
     <string name="BadgeNumber">Globo en el cono</string>
     <string name="Short">Corto</string>
     <string name="Long">Largo</string>
-    <string name="SystemDefault">Por defecto del sistema</string>
-    <string name="SettingsDefault">Ajustes por defecto</string>
+    <string name="SystemDefault">Segn el sistema</string>
+    <string name="SettingsDefault">Segn Telegram</string>
     <string name="AutomaticMediaDownload">DESCARGA AUTOMTICA DE MULTIMEDIA</string>
     <string name="WhenUsingMobileData">Con uso de datos mviles</string>
     <string name="WhenConnectedOnWiFi">Con conexin a Wi-Fi</string>
     <string name="WhenRoaming">Con itinerancia de datos</string>
     <string name="NoMediaAutoDownload">Ningn contenido multimedia</string>
-
+    <string name="SaveToGallerySettings">Guardar en galera</string>
     <!--media view-->
-    <string name="NoMedia">No hay fotos ni vdeos compartidos an</string>
+    <string name="NoMedia">An no hay fotos ni vdeos</string>
     <string name="CancelDownload">Cancelar descarga</string>
-
     <!--map view-->
     <string name="MyLocation">Mi ubicacin</string>
     <string name="Map">Mapa</string>
@@ -305,20 +290,19 @@
     <string name="KMetersAway">km de distancia</string>
     <string name="SendLocation">Enviar ubicacin</string>
     <string name="ShareLocation">Compartir ubicacin</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Mostrar todas las fotos y vdeos</string>
     <string name="SaveToGallery">Guardar en galera</string>
     <string name="Of">%1$d de %2$d</string>
     <string name="Gallery">Galera</string>
-    <string name="AllPhotos">Todas</string>
-    <string name="NoPhotos">No hay fotos an</string>
-
+    <string name="AllPhotos">Todas las fotos</string>
+    <string name="NoPhotos">Sin fotos an</string>
     <!--edit video view-->
     <string name="EditVideo">Editar vdeo</string>
     <string name="OriginalVideo">Vdeo original</string>
     <string name="EditedVideo">Vdeo editado</string>
-
+    <string name="SendingVideo">Enviando vdeo...</string>
+    <string name="CompressVideo">Comprimir Vdeo</string>
     <!--button titles-->
     <string name="Next">Siguiente</string>
     <string name="Back">Atrs</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto">Abrir foto</string>
     <string name="Set">Establecer</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 expuls a un2</string>
     <string name="ActionLeftUser">un1 dej el grupo</string>
@@ -351,11 +334,11 @@
     <string name="ActionChangedTitle">un1 cambi el nombre del grupo a un2</string>
     <string name="ActionCreateGroup">un1 cre el grupo</string>
     <string name="ActionYouKickUser">Expulsaste a un2</string>
-    <string name="ActionYouLeftUser">Abandonaste el grupo</string>
+    <string name="ActionYouLeftUser">Dejaste el grupo</string>
     <string name="ActionYouAddUser">Aadiste a un2</string>
-    <string name="ActionYouRemovedPhoto">Quitaste la foto de grupo</string>
-    <string name="ActionYouChangedPhoto">Cambiaste la foto de grupo</string>
-    <string name="ActionYouChangedTitle">Cambiaste el nombre de grupo a un2</string>
+    <string name="ActionYouRemovedPhoto">Quitaste la foto del grupo</string>
+    <string name="ActionYouChangedPhoto">Cambiaste la foto del grupo</string>
+    <string name="ActionYouChangedTitle">Cambiaste el nombre del grupo a un2</string>
     <string name="ActionYouCreateGroup">Creaste el grupo</string>
     <string name="ActionKickUserYou">un1 te expuls</string>
     <string name="ActionAddUserYou">un1 te aadi</string>
@@ -369,11 +352,10 @@
     <string name="FromYou">T</string>
     <string name="ActionTakeScreenshootYou">Hiciste una captura de pantalla!</string>
     <string name="ActionTakeScreenshoot">un1 hizo una captura de pantalla!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Nmero de telfono invlido</string>
     <string name="CodeExpired">Cdigo expirado. Por favor, vuelve a iniciar sesin.</string>
-    <string name="FloodWait">Demasiados intentos. Por favor, prueba de nuevo ms tarde.</string>
+    <string name="FloodWait">Muchos intentos. Por favor, intntalo ms tarde.</string>
     <string name="InvalidCode">Cdigo invlido</string>
     <string name="InvalidFirstName">Nombre invlido</string>
     <string name="InvalidLastName">Apellido invlido</string>
@@ -392,13 +374,12 @@
     <string name="AreYouSureSessions">Quieres terminar todas las otras sesiones?</string>
     <string name="AreYouSureDeleteAndExit">Quieres eliminar y dejar el grupo?</string>
     <string name="AreYouSureDeleteThisChat">Quieres eliminar este chat?</string>
-    <string name="AreYouSureShareMyContactInfo">Quieres compartir tu informacin de contacto?</string>
+    <string name="AreYouSureShareMyContactInfo">Quieres compartir tu nmero?</string>
     <string name="AreYouSureBlockContact">Quieres bloquear este contacto?</string>
     <string name="AreYouSureUnblockContact">Quieres desbloquear este contacto?</string>
     <string name="AreYouSureDeleteContact">Quieres eliminar este contacto?</string>
     <string name="AreYouSureSecretChat">Quieres iniciar un chat secreto?</string>
     <string name="ForwardFromMyName">reenviar desde mi nombre</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Rpida</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Poderosa</string>
     <string name="Page6Title">Basada en la nube</string>
     <string name="Page7Title">Privada</string>
-    <string name="Page1Message">Bienvenidos a la era de la mensajera rpida y segura.</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> entrega mensajes ms rpido que<![CDATA[<br/>]]>cualquier otra aplicacin.</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> es gratis para siempre. Sin publicidad.<![CDATA[<br/>]]>Sin cuotas de suscripcin.</string>
+    <string name="Page1Message">La aplicacin de mensajera ms<![CDATA[<br/><b>veloz</b>]]> del mundo. Es <![CDATA[<b>gratis</b>]]> y <![CDATA[<b>segura</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> entrega mensajes ms<![CDATA[<br/>]]>rpido que cualquier otra aplicacin.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> es gratis para siempre.<![CDATA[<br/>]]>Sin publicidad ni suscripciones.</string>
     <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> mantiene tus mensajes<![CDATA[<br/>]]>a salvo del ataque de hackers.</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no tiene lmites en el tamao de tus<![CDATA[<br/>]]>chats y archivos.</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> te permite acceder a tus mensajes<![CDATA[<br/>]]>desde mltiples dispositivos.</string>
-    <string name="Page7Message">Los mensajes de <![CDATA[<b>Telegram</b>]]> estn fuertemente<![CDATA[<br/>]]>cifrados y se pueden autodestruir.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no tiene lmites en<![CDATA[<br/>]]>el tamao de tus chats y archivos.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> te permite acceder a tus<![CDATA[<br/>]]>mensajes desde mltiples dispositivos.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> posee mensajes fuertemente<![CDATA[<br/>]]>cifrados y se pueden autodestruir.</string>
     <string name="StartMessaging">Empieza a conversar</string>
-
     <!--plurals-->
     <string name="Members_zero">sin miembros</string>
     <string name="Members_one">%1$d miembro</string>
@@ -423,19 +403,19 @@
     <string name="Members_few">%1$d miembros</string>
     <string name="Members_many">%1$d miembros</string>
     <string name="Members_other">%1$d miembros</string>
-    <string name="AndMoreTyping_zero">y %1$d personas ms estn escribiendo</string>
-    <string name="AndMoreTyping_one">y %1$d personas ms estn escribiendo</string>
-    <string name="AndMoreTyping_two">y %1$d personas ms estn escribiendo</string>
-    <string name="AndMoreTyping_few">y %1$d personas ms estn escribiendo</string>
-    <string name="AndMoreTyping_many">y %1$d personas ms estn escribiendo</string>
-    <string name="AndMoreTyping_other">y %1$d personas ms estn escribiendo</string>
-    <string name="NewMessages_zero">no hay mensajes nuevos</string>
+    <string name="AndMoreTyping_zero">y %1$d personas ms escriben</string>
+    <string name="AndMoreTyping_one">y %1$d personas ms escriben</string>
+    <string name="AndMoreTyping_two">y %1$d personas ms escriben</string>
+    <string name="AndMoreTyping_few">y %1$d personas ms escriben</string>
+    <string name="AndMoreTyping_many">y %1$d personas ms escriben</string>
+    <string name="AndMoreTyping_other">y %1$d personas ms escriben</string>
+    <string name="NewMessages_zero">Sin mensajes nuevos</string>
     <string name="NewMessages_one">%1$d nuevo mensaje</string>
     <string name="NewMessages_two">%1$d nuevos mensajes</string>
     <string name="NewMessages_few">%1$d nuevos mensajes</string>
     <string name="NewMessages_many">%1$d nuevos mensajes</string>
     <string name="NewMessages_other">%1$d nuevos mensajes</string>
-    <string name="messages_zero">no hay mensajes</string>
+    <string name="messages_zero">Sin mensajes</string>
     <string name="messages_one">%1$d mensaje</string>
     <string name="messages_two">%1$d mensajes</string>
     <string name="messages_few">%1$d mensajes</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">de %1$d contactos</string>
     <string name="FromContacts_many">de %1$d contactos</string>
     <string name="FromContacts_other">de %1$d contactos</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-it/strings.xml b/TMessagesProj/src/main/res/values-it/strings.xml
index a104766bf..eb40f095b 100644
--- a/TMessagesProj/src/main/res/values-it/strings.xml
+++ b/TMessagesProj/src/main/res/values-it/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Italiano</string>
     <string name="LanguageNameInEnglish">Italian</string>
     <string name="LanguageCode">it</string>
-
     <!--signin view-->
     <string name="YourPhone">Il tuo telefono</string>
     <string name="StartText">Conferma il prefisso della tua nazione\ne inserisci il tuo numero di telefono.</string>
     <string name="ChooseCountry">Scegli una nazione</string>
     <string name="WrongCountry">Prefisso errato</string>
-
     <!--code enter view-->
     <string name="YourCode">Il tuo codice</string>
     <string name="SentSmsCode">Abbiamo inviato un SMS al tuo telefono con il codice di attivazione</string>
@@ -23,7 +20,6 @@
     <string name="Code">Codice</string>
     <string name="WrongNumber">Numero errato?</string>
     <string name="DidNotGetTheCode">Non hai ricevuto il codice?</string>
-
     <!--signup view-->
     <string name="YourName">Il tuo nome</string>
     <string name="RegisterText">Inserisci il tuo nome e cognome</string>
@@ -31,7 +27,6 @@
     <string name="FirstName">Nome (richiesto)</string>
     <string name="LastName">Cognome (facoltativo)</string>
     <string name="CancelRegistration">Annulla registrazione</string>
-
     <!--chats view-->
     <string name="Chats">Chat</string>
     <string name="Search">Cerca</string>
@@ -42,7 +37,7 @@
     <string name="Yesterday">ieri</string>
     <string name="NoResult">Nessun risultato</string>
     <string name="NoChats">Ancora nessuna chat</string>
-    <string name="NoChatsHelp">Inizia a inviare messaggi premendo il\npulsante di composizione nell\'angolo in alto\na destra o vai nella sezione contatti.</string>
+    <string name="NoChatsHelp">Inizia a messaggiare premendo il tasto\ncomponi nell\'angolo in alto a destra\no premi il tasto menu per pi opzioni.</string>
     <string name="WaitingForNetwork">In attesa della rete...</string>
     <string name="Connecting">Connessione in corso</string>
     <string name="Updating">Aggiornamento in corso</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat">Elimina ed esci</string>
     <string name="HiddenName">Nome nascosto</string>
     <string name="SelectChat">Seleziona chat</string>
-
     <!--broadcasts-->
     <string name="BroadcastList">Lista broadcast</string>
     <string name="NewBroadcastList">Nuova lista broadcast</string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">Hai creato una lista broadcast</string>
     <string name="AddRecipient">Aggiungi destinatario</string>
     <string name="KickFromBroadcast">Rimuovi dalla lista broadcast</string>
-
     <!--documents view-->
     <string name="SelectFile">Seleziona file</string>
     <string name="FreeOfTotal">Liberi %1$s di %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage">Archiviazione esterna</string>
     <string name="SystemRoot">Root di sistema</string>
     <string name="SdCard">Scheda SD</string>
-
     <!--chat view-->
     <string name="Invisible">invisibile</string>
     <string name="Typing">sta scrivendo</string>
@@ -102,14 +94,14 @@
     <string name="TypeMessage">Scrivi il messaggio</string>
     <string name="DOWNLOAD">Scarica</string>
     <string name="Selected">Selezionati: %d</string>
-    <string name="ShareMyContactInfo">CONDIVIDI LE MIE INFORMAZIONI DI CONTATTO</string>
+    <string name="ShareMyContactInfo">CONDIVIDI INFORMAZIONI CONTATTO</string>
     <string name="AddToContacts">AGGIUNGI AI CONTATTI</string>
     <string name="EncryptedPlaceholderTitleIncoming">%s ti ha mandato un invito a una chat segreta.</string>
     <string name="EncryptedPlaceholderTitleOutgoing">Hai invitato %s a entrare in una chat segreta.</string>
     <string name="EncryptedDescriptionTitle">Chat segrete:</string>
     <string name="EncryptedDescription1">Utilizzano la crittografia end-to-end</string>
     <string name="EncryptedDescription2">Non lasciano traccia sui nostri server</string>
-    <string name="EncryptedDescription3">Hanno un contatore di autodistruzione</string>
+    <string name="EncryptedDescription3">Hanno un timer di autodistruzione</string>
     <string name="EncryptedDescription4">Non permettono linoltro</string>
     <string name="YouWereKicked">Sei stato espulso da questo gruppo</string>
     <string name="YouLeft">Hai lasciato il gruppo</string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">Salva in download</string>
     <string name="ApplyLocalizationFile">Applica file di localizzazione</string>
     <string name="UnsupportedAttachment">Allegato non supportato</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Chat segreta richiesta</string>
     <string name="EncryptedChatAccepted">Chat segreta iniziata</string>
@@ -161,7 +152,6 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\nAbbiamo rilevato un accesso al tuo account da un nuovo dispositivo %2$s\n\nDispositivo: %3$s\nPosizione: %4$s\n\nSe non sei stato tu, puoi andare su Impostazioni - Termina tutte le sessioni.\n\nGrazie,\nil team di Telegram</string>
     <string name="NotificationContactNewPhoto">%1$s ha aggiornato la foto del profilo</string>
     <string name="Reply">Rispondi</string>
-
     <!--contacts view-->
     <string name="SelectContact">Seleziona contatto</string>
     <string name="NoContacts">Ancora nessun contatto</string>
@@ -174,14 +164,12 @@
     <string name="LastSeen">ultimo accesso</string>
     <string name="LastSeenDate">ultimo accesso</string>
     <string name="InviteFriends">Invita amici</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Invia messaggio a...</string>
     <string name="EnterGroupNamePlaceholder">Immetti il nome del gruppo</string>
     <string name="GroupName">Nome gruppo</string>
     <string name="AllContacts">TUTTI I CONTATTI</string>
     <string name="MembersCount">%1$d/%2$d membri</string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">INSERISCI IL NOME DEL GRUPPO</string>
     <string name="SharedMedia">Media condivisi</string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">Elimina e lascia il gruppo</string>
     <string name="Notifications">Notifiche</string>
     <string name="KickFromGroup">Rimuovi dal gruppo</string>
-
     <!--contact info view-->
     <string name="ShareContact">Condividi</string>
     <string name="AddContact">Aggiungi</string>
@@ -220,7 +207,6 @@
     <string name="ShortMessageLifetime1d">1g</string>
     <string name="ShortMessageLifetime1w">1sett</string>
     <string name="EncryptionKeyDescription">Questa immagine  una visualizzazione della chiave di cifratura per questa chat segreta con <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Se questa immagine  uguale sul telefono di <![CDATA[<b>]]>%2$s<![CDATA[</b>]]>, la chat  sicura al 200%%.<![CDATA[<br><br>]]>Per saperne di pi, visita Telegram.org</string>
-
     <!--settings view-->
     <string name="ResetNotificationsText">Ripristina tutte le impostazioni di notifica predefinite</string>
     <string name="TextSize">Dimensione testo messaggi</string>
@@ -291,11 +277,10 @@
     <string name="WhenConnectedOnWiFi">Quando si utilizza il Wi-Fi</string>
     <string name="WhenRoaming">In roaming</string>
     <string name="NoMediaAutoDownload">Nessun media</string>
-
+    <string name="SaveToGallerySettings">Salva nella galleria</string>
     <!--media view-->
     <string name="NoMedia">Nessun media condiviso</string>
     <string name="CancelDownload">Annulla scaricamento</string>
-
     <!--map view-->
     <string name="MyLocation">La mia posizione</string>
     <string name="Map">Mappa</string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway">km di distanza</string>
     <string name="SendLocation">Invia posizione</string>
     <string name="ShareLocation">Condividi posizione</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Mostra tutti i file media</string>
     <string name="SaveToGallery">Salva nella galleria</string>
@@ -313,12 +297,12 @@
     <string name="Gallery">Galleria</string>
     <string name="AllPhotos">Tutte le foto</string>
     <string name="NoPhotos">Ancora nessuna foto</string>
-
     <!--edit video view-->
     <string name="EditVideo">Modifica video</string>
     <string name="OriginalVideo">Video originale</string>
     <string name="EditedVideo">Video modificato</string>
-
+    <string name="SendingVideo">Inviando il video...</string>
+    <string name="CompressVideo">Comprimi Video</string>
     <!--button titles-->
     <string name="Next">Avanti</string>
     <string name="Back">Indietro</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto">Apri foto</string>
     <string name="Set">Imposta</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 ha rimosso un2</string>
     <string name="ActionLeftUser">un1 ha lasciato il gruppo</string>
@@ -359,7 +342,7 @@
     <string name="ActionYouCreateGroup">Hai creato il gruppo</string>
     <string name="ActionKickUserYou">un1 ti ha rimosso</string>
     <string name="ActionAddUserYou">un1 ti ha aggiunto</string>
-    <string name="UnsuppotedMedia">Questo messaggio non  supportato sulla tua versione di Telegram. Aggiorna l\'applicazione per\nvisualizzarlo: http://telegram.org/update</string>
+    <string name="UnsuppotedMedia">Questo messaggio non  supportato sulla tua versione di Telegram. Aggiorna l\'applicazione per visualizzarlo: http://telegram.org/update</string>
     <string name="AttachPhoto">Foto</string>
     <string name="AttachVideo">Video</string>
     <string name="AttachLocation">Posizione</string>
@@ -369,7 +352,6 @@
     <string name="FromYou">Tu</string>
     <string name="ActionTakeScreenshootYou">Hai catturato la schermata!</string>
     <string name="ActionTakeScreenshoot">un1 ha catturato la schermata!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Numero di telefono non valido</string>
     <string name="CodeExpired">Codice scaduto, effettua di nuovo l\'accesso</string>
@@ -398,7 +380,6 @@
     <string name="AreYouSureDeleteContact">Eliminare questo contatto?</string>
     <string name="AreYouSureSecretChat">Iniziare una chat segreta?</string>
     <string name="ForwardFromMyName">inoltra dal mio nome</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Veloce</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Potente</string>
     <string name="Page6Title">Basato sul cloud</string>
     <string name="Page7Title">Privato</string>
-    <string name="Page1Message">Benvenuto nell\'era della messaggistica veloce e sicura</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> consegna i messaggi pi velocemente di qualsiasi altra applicazione</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]>  gratuita per sempre. Nessuna pubblicit. Nessun costo di abbonamento</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> tiene al sicuro i tuoi messaggi dagli attacchi degli hacker</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> non ha limiti sulle dimensioni dei tuoi file multimediali e delle chat</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> ti consente di accedere ai messaggi da pi dispositivi</string>
-    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> cifra in maniera sicura i messaggi e pu far s che si autodistruggano</string>
+    <string name="Page1Message">L\'app di messaggi <![CDATA[<b>pi veloce</b>]]>al mondo.<![CDATA[<br/>]]> <![CDATA[<b>gratuita</b>]]> e <![CDATA[<b>sicura</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> consegna i messaggi pi<![CDATA[<br/>]]>velocemente di qualsiasi altra app.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> sar sempre gratuito.<![CDATA[<br/>]]>Nessuna pubblicit. Nessun abbonamento.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> protegge i tuoi messaggi<![CDATA[<br/>]]>dagli attacchi degli hacker.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> non ha limiti sulle dimensioni<![CDATA[<br/>]]>dei tuoi file multimediali e delle chat.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> ti consente di accedere<![CDATA[<br/>]]>ai messaggi da pi dispositivi.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> cifra in maniera sicura i messaggi<![CDATA[<br/>]]>e pu far s che si autodistruggano.</string>
     <string name="StartMessaging">Inizia a inviare messaggi</string>
-
     <!--plurals-->
     <string name="Members_zero">nessun membro</string>
     <string name="Members_one">%1$d membro</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">da %1$d contatti</string>
     <string name="FromContacts_many">da %1$d contatti</string>
     <string name="FromContacts_other">da %1$d contatti</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-nl/strings.xml b/TMessagesProj/src/main/res/values-nl/strings.xml
index b6d1e68e0..de47b75eb 100644
--- a/TMessagesProj/src/main/res/values-nl/strings.xml
+++ b/TMessagesProj/src/main/res/values-nl/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Nederlands</string>
     <string name="LanguageNameInEnglish">Dutch</string>
     <string name="LanguageCode">nl</string>
-
     <!--signin view-->
     <string name="YourPhone">Je telefoon</string>
     <string name="StartText">Bevestig je landcode\nen voer je telefoonnummer in.</string>
     <string name="ChooseCountry">Kies een land</string>
     <string name="WrongCountry">Onjuist landcode</string>
-
     <!--code enter view-->
     <string name="YourCode">Je code</string>
     <string name="SentSmsCode">We hebben een sms met een activatiecode verzonden naar je telefoon</string>
@@ -23,7 +20,6 @@
     <string name="Code">Code</string>
     <string name="WrongNumber">Verkeerd nummer?</string>
     <string name="DidNotGetTheCode">Geen code ontvangen?</string>
-
     <!--signup view-->
     <string name="YourName">Je naam</string>
     <string name="RegisterText">Voer je voor- en achternaam in</string>
@@ -31,7 +27,6 @@
     <string name="FirstName">Voornaam (verplicht)</string>
     <string name="LastName">Achternaam (optioneel)</string>
     <string name="CancelRegistration">Registratie annuleren</string>
-
     <!--chats view-->
     <string name="Chats">Gesprekken</string>
     <string name="Search">Zoeken</string>
@@ -42,7 +37,7 @@
     <string name="Yesterday">gisteren</string>
     <string name="NoResult">Geen resultaten</string>
     <string name="NoChats">Nog geen gesprekken</string>
-    <string name="NoChatsHelp">Tik op de opstelknop rechtsbovenin\nom een gesprek te beginnen\nof ga naar de contactenlijst.</string>
+    <string name="NoChatsHelp">Begin een gesprek door op de\nopstellen-knop rechtsboven te drukken\nof druk op de menuknop voor meer opties.</string>
     <string name="WaitingForNetwork">Wachten op netwerk</string>
     <string name="Connecting">Verbinden</string>
     <string name="Updating">Bijwerken</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat">Verwijderen en verlaten</string>
     <string name="HiddenName">Verborgen naam</string>
     <string name="SelectChat">Kies een gesprek</string>
-
     <!--broadcasts-->
     <string name="BroadcastList">Verzendlijst</string>
     <string name="NewBroadcastList">Nieuwe verzendlijst</string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">Je hebt een verzendlijst gemaakt</string>
     <string name="AddRecipient">Ontvanger toevoegen</string>
     <string name="KickFromBroadcast">Verwijder van verzendlijst</string>
-
     <!--documents view-->
     <string name="SelectFile">Kies een bestand</string>
     <string name="FreeOfTotal">Vrij: %1$s van %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage">Externe opslag</string>
     <string name="SystemRoot">Systeemmap</string>
     <string name="SdCard">SD-kaart</string>
-
     <!--chat view-->
     <string name="Invisible">onzichtbaar</string>
     <string name="Typing">aan het typen</string>
@@ -108,7 +100,7 @@
     <string name="EncryptedPlaceholderTitleOutgoing">Je hebt %s uitgenodigd voor een geheime chat.</string>
     <string name="EncryptedDescriptionTitle">Geheime chat functies:</string>
     <string name="EncryptedDescription1">End-to-end encryptie</string>
-    <string name="EncryptedDescription2">Ontraceerbaar via onze servers</string>
+    <string name="EncryptedDescription2">Geen serveropslag</string>
     <string name="EncryptedDescription3">Zelfvernietigingstimers</string>
     <string name="EncryptedDescription4">Doorstuurbescherming</string>
     <string name="YouWereKicked">Je bent verwijderd uit deze groep</string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">Opslaan in Downloads</string>
     <string name="ApplyLocalizationFile">Vertaling toepassen</string>
     <string name="UnsupportedAttachment">Bestandstype niet ondersteund</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Geheime chat aangevraagd</string>
     <string name="EncryptedChatAccepted">Geheime chat gestart</string>
@@ -161,7 +152,6 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\nEr is op je account ingelogd vanaf een nieuw apparaat op %2$s\n\nApparaat: %3$s\nLocatie: %4$s\n\nAls jij dit niet was, kun je alle sessies beindigen via Instellingen  Beindig alle andere sessies.\n\nBedankt,\nHet Telegram-team</string>
     <string name="NotificationContactNewPhoto">%1$s heeft zijn/haar profielfoto gewijzigd</string>
     <string name="Reply">Antwoord</string>
-
     <!--contacts view-->
     <string name="SelectContact">Kies een contact</string>
     <string name="NoContacts">Nog geen contacten</string>
@@ -171,17 +161,15 @@
     <string name="OtherAt">om</string>
     <string name="Online">online</string>
     <string name="Offline">offline</string>
-    <string name="LastSeen">laatst gez.:</string>
-    <string name="LastSeenDate">laatst gez.:</string>
+    <string name="LastSeen">gezien</string>
+    <string name="LastSeenDate">gezien</string>
     <string name="InviteFriends">Vrienden uitnodigen</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Bericht verzenden naar</string>
     <string name="EnterGroupNamePlaceholder">Groepsnaam...</string>
     <string name="GroupName">Groepsnaam</string>
     <string name="AllContacts">ALLE CONTACTEN</string>
     <string name="MembersCount">%1$d/%2$d deelnemers</string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">GROEPSNAAM INSTELLEN</string>
     <string name="SharedMedia">Gedeelde media</string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">Groep verwijderen en verlaten</string>
     <string name="Notifications">Meldingen</string>
     <string name="KickFromGroup">Verwijderen uit groep</string>
-
     <!--contact info view-->
     <string name="ShareContact">Delen</string>
     <string name="AddContact">Toevoegen</string>
@@ -220,7 +207,6 @@
     <string name="ShortMessageLifetime1d">1d</string>
     <string name="ShortMessageLifetime1w">1w</string>
     <string name="EncryptionKeyDescription">Dit is een weergave van de encryptiesleutel voor deze geheime chat met <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Als deze afbeelding er bij <![CDATA[<b>]]>%2$s<![CDATA[</b>]]> hetzelfde uitziet, is jullie gesprek 200%% beveiligd.<![CDATA[<br><br>]]>Lees meer op telegram.org.</string>
-
     <!--settings view-->
     <string name="ResetNotificationsText">Alle meldingsinstellingen herstellen</string>
     <string name="TextSize">Tekstgrootte berichten</string>
@@ -243,7 +229,7 @@
     <string name="InAppPreview">Voorvertoningen</string>
     <string name="Reset">RESETTEN</string>
     <string name="ResetAllNotifications">Alle meldingen resetten</string>
-    <string name="UndoAllCustom">Alle aangepaste meldingsinstellingen ongedaan maken voor alle contacten en groepen.</string>
+    <string name="UndoAllCustom">Aangepaste meldingsinstellingen wissen voor contacten en groepen.</string>
     <string name="NotificationsAndSounds">Meldingen en geluiden</string>
     <string name="BlockedUsers">Geblokkeerde gebruikers</string>
     <string name="SaveIncomingPhotos">Inkomende foto\'s opslaan</string>
@@ -260,7 +246,7 @@
     <string name="ContactJoined">Contact lid van Telegram</string>
     <string name="Pebble">PEBBLE</string>
     <string name="Language">Taal</string>
-    <string name="AskAQuestionInfo">Houd er rekening mee dat de ondersteuning van Telegram door vrijwilligers wordt gedaan. We doen ons best om zo snel mogelijk te antwoorden, maar het kan even even duren.<![CDATA[<br><br>]]>Bekijk ook de <![CDATA[<a href=\"http://telegram.org/faq#general\">veelgestelde vragen</a>]]>: hier staan de antwoorden op de meeste vragen en belangrijke tips voor <![CDATA[<a href=\"http://telegram.org/faq#troubleshooting\">het oplossen van problemen</a>]]>.</string>
+    <string name="AskAQuestionInfo">De ondersteuning van Telegram wordt gedaan door vrijwilligers.<![CDATA[<br>]]>We doen ons best om zo snel mogelijk te antwoorden.<![CDATA[<br><br>]]>Bekijk ook de <![CDATA[<a href=\"http://telegram.org/faq#general\">veelgestelde vragen</a>]]>. Hier staan de antwoorden op de meeste vragen en belangrijke tips voor <![CDATA[<a href=\"http://telegram.org/faq#troubleshooting\">het oplossen van problemen</a>]]>.</string>
     <string name="AskButton">Vraag een vrijwilliger</string>
     <string name="TelegramFaq">Veelgestelde vragen</string>
     <string name="TelegramFaqUrl">https://telegram.org/faq</string>
@@ -291,11 +277,10 @@
     <string name="WhenConnectedOnWiFi">Bij Wi-Fi-verbinding</string>
     <string name="WhenRoaming">Bij roaming</string>
     <string name="NoMediaAutoDownload">Geen media</string>
-
+    <string name="SaveToGallerySettings">Opslaan in galerij</string>
     <!--media view-->
     <string name="NoMedia">Nog geen media gedeeld</string>
     <string name="CancelDownload">Downloaden annuleren</string>
-
     <!--map view-->
     <string name="MyLocation">Mijn locatie</string>
     <string name="Map">Kaart</string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway">km hiervandaan</string>
     <string name="SendLocation">Locatie verzenden</string>
     <string name="ShareLocation">Locatie delen</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Alle media weergeven</string>
     <string name="SaveToGallery">Opslaan in galerij</string>
@@ -313,12 +297,12 @@
     <string name="Gallery">Galerij</string>
     <string name="AllPhotos">Alle foto\'s</string>
     <string name="NoPhotos">Nog geen foto\'s</string>
-
     <!--edit video view-->
     <string name="EditVideo">Video bewerken</string>
     <string name="OriginalVideo">Originele video</string>
     <string name="EditedVideo">Bewerkte video</string>
-
+    <string name="SendingVideo">Video versturen...</string>
+    <string name="CompressVideo">Video comprimeren</string>
     <!--button titles-->
     <string name="Next">Volgende</string>
     <string name="Back">Vorige</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto">Foto openen</string>
     <string name="Set">Instellen</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 heeft un2 verwijderd</string>
     <string name="ActionLeftUser">un1 heeft de groep verlaten</string>
@@ -369,7 +352,6 @@
     <string name="FromYou">Jij</string>
     <string name="ActionTakeScreenshootYou">Je hebt een schermafbeelding gemaakt!</string>
     <string name="ActionTakeScreenshoot">un1 maakte een schermafbeeling!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Ongeldig telefoonnummer</string>
     <string name="CodeExpired">Code verlopen. Log opnieuw in.</string>
@@ -389,7 +371,7 @@
     <string name="DeleteChatQuestion">Dit gesprek verwijderen?</string>
     <string name="SendMessagesTo">Berichten naar %1$s verzenden?</string>
     <string name="AreYouSureLogout">Weet je zeker dat je wilt uitloggen?</string>
-    <string name="AreYouSureSessions">Weet je zeker dat je alle andere sessies wilt beindigen?</string>
+    <string name="AreYouSureSessions">Alle apparaten behalve het huidige apparaat uitloggen?</string>
     <string name="AreYouSureDeleteAndExit">Weet je zeker dat je alles wilt verwijderen en de groep wilt verlaten?</string>
     <string name="AreYouSureDeleteThisChat">Weet je zeker dat je dit gesprek wilt verwijderen?</string>
     <string name="AreYouSureShareMyContactInfo">Weet je zeker dat je je contactinformatie wilt delen?</string>
@@ -398,7 +380,6 @@
     <string name="AreYouSureDeleteContact">Weet je zeker dat je deze contactpersoon wilt verwijderen?</string>
     <string name="AreYouSureSecretChat">Weet je zeker dat je een geheime chat wilt starten?</string>
     <string name="ForwardFromMyName">doorsturen via mijn eigen naam</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Snel</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Krachtig</string>
     <string name="Page6Title">In de cloud</string>
     <string name="Page7Title">Priv</string>
-    <string name="Page1Message">\'s Werelds <![CDATA[<b>snelste</b>]]> berichtendienst.<![CDATA[<br/>]]>Het is <![CDATA[<b>veilig</b>]]> en  <![CDATA[<b>gratis</b>]]>.</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> bezorgt berichten<![CDATA[<br/>]]>sneller dan elke andere applicatie.</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> is altijd gratis. <![CDATA[<br/>]]>Geen advertenties.<![CDATA[<br/>]]>Geen abonnementskosten.</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> beveiligt je berichten<![CDATA[<br/>]]>tegen aanvallen van hackers.</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> beperkt je niet<![CDATA[<br/>]]>in de grootte van je media of gesprekken.</string>
+    <string name="Page1Message">\'s Werelds <![CDATA[<b>snelste</b>]]> berichtendienst.<![CDATA[<br/>]]>Het is <![CDATA[<b>gratis</b>]]> en <![CDATA[<b>veilig</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> bezorgt berichten sneller dan<![CDATA[<br/>]]>elke andere applicatie.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> is altijd gratis. Geen advertenties.<![CDATA[<br/>]]>Geen abonnementskosten.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> beveiligd je berichten<![CDATA[<br/>]]>tegen aanvallen van hackers.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> beperkt je niet in de grootte van<![CDATA[<br/>]]>je media of gesprekken.</string>
     <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> biedt toegang tot je berichten<![CDATA[<br/>]]>vanaf meerdere apparaten.</string>
-    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> berichten zijn sterk versleuteld<![CDATA[<br/>]]>en kunnen zichzelf vernietigen</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> berichten zijn sterk versleuteld<![CDATA[<br/>]]>en kunnen zichzelf vernietigen.</string>
     <string name="StartMessaging">Begin met chatten</string>
-
     <!--plurals-->
     <string name="Members_zero">geen deelnemers</string>
     <string name="Members_one">%1$d deelnemer</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">van %1$d contactpersonen</string>
     <string name="FromContacts_many">van %1$d contactpersonen</string>
     <string name="FromContacts_other">van %1$d contactpersonen</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
index e57c0f3ba..2845a3c6b 100644
--- a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Portugus (Brasil)</string>
     <string name="LanguageNameInEnglish">Portuguese (Brazil)</string>
     <string name="LanguageCode">pt_BR</string>
-
     <!--signin view-->
     <string name="YourPhone">Seu nmero</string>
     <string name="StartText">Por favor confirme o cdigo do seu pas\ne digite o nmero do seu telefone.</string>
     <string name="ChooseCountry">Escolha um pas</string>
     <string name="WrongCountry">Cdigo do pas incorreto</string>
-
     <!--code enter view-->
     <string name="YourCode">Seu cdigo</string>
     <string name="SentSmsCode">Enviamos uma SMS com um cdigo de ativao para o seu telefone</string>
@@ -23,7 +20,6 @@
     <string name="Code">Cdigo</string>
     <string name="WrongNumber">Nmero incorreto?</string>
     <string name="DidNotGetTheCode">No recebeu o cdigo?</string>
-
     <!--signup view-->
     <string name="YourName">Seu nome</string>
     <string name="RegisterText">Configure seu nome e sobrenome</string>
@@ -31,7 +27,6 @@
     <string name="FirstName">Nome (obrigatrio)</string>
     <string name="LastName">Sobrenome (opcional)</string>
     <string name="CancelRegistration">Cancelar registro</string>
-
     <!--chats view-->
     <string name="Chats">Conversas</string>
     <string name="Search">Busca</string>
@@ -42,7 +37,7 @@
     <string name="Yesterday">ontem</string>
     <string name="NoResult">Nenhum resultado</string>
     <string name="NoChats">Ainda no h conversas...</string>
-    <string name="NoChatsHelp">Comece a conversar pressionando o\nboto \'Nova Mensagem\' no canto superior direito\nou v para a seo \'Contatos\'</string>
+    <string name="NoChatsHelp">Comece a conversar pressionando o\nboto \'Nova Mensagem\' no canto superior direito\nou v para a seo \'Contatos\'.</string>
     <string name="WaitingForNetwork">Aguardando rede...</string>
     <string name="Connecting">Conectando...</string>
     <string name="Updating">Atualizando...</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat">Apagar e sair</string>
     <string name="HiddenName">Nome oculto</string>
     <string name="SelectChat">Selecione uma Conversa</string>
-
     <!--broadcasts-->
     <string name="BroadcastList">Lista de Broadcast</string>
     <string name="NewBroadcastList">Nova Lista de Broadcast</string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">Voc criou uma lista de broadcast</string>
     <string name="AddRecipient">Adicionar destinatrio</string>
     <string name="KickFromBroadcast">Remover da lista de broadcast</string>
-
     <!--documents view-->
     <string name="SelectFile">Selecione um Arquivo</string>
     <string name="FreeOfTotal">Disponvel %1$s de %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage">Armazenamento Externo</string>
     <string name="SystemRoot">Administrador do Sistema</string>
     <string name="SdCard">Carto SD</string>
-
     <!--chat view-->
     <string name="Invisible">invisvel</string>
     <string name="Typing">escrevendo...</string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">Salvar em downloads</string>
     <string name="ApplyLocalizationFile">Aplicar arquivo de localizao</string>
     <string name="UnsupportedAttachment">Anexo no suportado</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Conversa secreta solicitada</string>
     <string name="EncryptedChatAccepted">Conversa secreta iniciada</string>
@@ -161,27 +152,24 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\nNs detectamos um login na sua conta de um novo dispositivo %2$s\n\nDispositivo: %3$s\nLocalizao: %4$s\nSe no foi voc, voc pode ir em Configuraes - Terminar todas as sesses.\n\nAtenciosamente,\nTime do Telegram</string>
     <string name="NotificationContactNewPhoto">%1$s atualizou a foto do perfil</string>
     <string name="Reply">Responder</string>
-
     <!--contacts view-->
     <string name="SelectContact">Selecionar Contato</string>
     <string name="NoContacts">Ainda no h contatos</string>
     <string name="InviteText">Ei, vamos mudar para o Telegram: http://telegram.org/dl2</string>
-    <string name="TodayAt">hoje (s)</string>
-    <string name="YesterdayAt">ontem (s)</string>
-    <string name="OtherAt">em</string>
+    <string name="TodayAt">hoje s</string>
+    <string name="YesterdayAt">ontem s</string>
+    <string name="OtherAt">s</string>
     <string name="Online">online</string>
     <string name="Offline">offline</string>
-    <string name="LastSeen">visto pela ltima vez</string>
-    <string name="LastSeenDate">visto pela ltima vez</string>
+    <string name="LastSeen">visto</string>
+    <string name="LastSeenDate">visto</string>
     <string name="InviteFriends">Convidar Amigos</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Enviar mensagem para...</string>
     <string name="EnterGroupNamePlaceholder">Digite o nome do grupo</string>
     <string name="GroupName">Nome do grupo</string>
     <string name="AllContacts">TODOS OS CONTATOS</string>
     <string name="MembersCount">%1$d/%2$d membros</string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">DIGITE O NOME DO GRUPO</string>
     <string name="SharedMedia">Mdia compartilhada</string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">Apagar e sair do grupo</string>
     <string name="Notifications">Notificaes</string>
     <string name="KickFromGroup">Remover do grupo</string>
-
     <!--contact info view-->
     <string name="ShareContact">Compartilhar</string>
     <string name="AddContact">Adicionar</string>
@@ -219,8 +206,7 @@
     <string name="ShortMessageLifetime1h">1h</string>
     <string name="ShortMessageLifetime1d">1d</string>
     <string name="ShortMessageLifetime1w">1 sem.</string>
-    <string name="EncryptionKeyDescription">Esta imagem  uma visualizao da chave criptogrfica para esta conversa secreta com <![CDATA[<b>]]>%1$s.<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Se esta imagem aparecer da mesma forma no telefone de <![CDATA[<b>]]>%2$s\'s<![CDATA[</b>]]>, sua conversa  200%% segura.<![CDATA[<br><br>]]>Saiba mais em telegram.org</string>
-
+    <string name="EncryptionKeyDescription">Esta imagem  uma visualizao da chave criptogrfica para esta conversa secreta com <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Se esta imagem aparecer da mesma forma no telefone de <![CDATA[<b>]]>%2$s\'s<![CDATA[</b>]]>, sua conversa  200%% segura.<![CDATA[<br><br>]]>Saiba mais em telegram.org</string>
     <!--settings view-->
     <string name="ResetNotificationsText">Restaurar todas as configuraes de notificao</string>
     <string name="TextSize">Tamanho do texto nas mensagens</string>
@@ -291,11 +277,10 @@
     <string name="WhenConnectedOnWiFi">Quando conectado em Wi-Fi</string>
     <string name="WhenRoaming">Quando em roaming</string>
     <string name="NoMediaAutoDownload">Sem mdia</string>
-
+    <string name="SaveToGallerySettings">Salvar na galeria</string>
     <!--media view-->
     <string name="NoMedia">Ainda no h mdia compartilhada</string>
     <string name="CancelDownload">Cancelar Download</string>
-
     <!--map view-->
     <string name="MyLocation">Minha localizao</string>
     <string name="Map">Mapa</string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway">km de distncia</string>
     <string name="SendLocation">Enviar Localizao</string>
     <string name="ShareLocation">Compartilhar Localizao</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Mostrar todas as mdias</string>
     <string name="SaveToGallery">Salvar na galeria</string>
@@ -313,12 +297,12 @@
     <string name="Gallery">Galeria</string>
     <string name="AllPhotos">Todas as Fotos</string>
     <string name="NoPhotos">Ainda no h fotos</string>
-
     <!--edit video view-->
     <string name="EditVideo">Editar Vdeo</string>
     <string name="OriginalVideo">Vdeo Original</string>
     <string name="EditedVideo">Vdeo Editado</string>
-
+    <string name="SendingVideo">Enviando vdeo...</string>
+    <string name="CompressVideo">Compactar Vdeo</string>
     <!--button titles-->
     <string name="Next">Prximo</string>
     <string name="Back">Voltar</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto"> Abrir foto</string>
     <string name="Set">Aplicar</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 removeu un2</string>
     <string name="ActionLeftUser">un1 saiu do grupo</string>
@@ -369,7 +352,6 @@
     <string name="FromYou">Voc</string>
     <string name="ActionTakeScreenshootYou">Voc realizou uma captura da tela!</string>
     <string name="ActionTakeScreenshoot">un1 realizou uma captura da tela!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Nmero de telefone invlido</string>
     <string name="CodeExpired">O cdigo expirou. Por favor, identifique-se novamente.</string>
@@ -398,7 +380,6 @@
     <string name="AreYouSureDeleteContact">Voc tem certeza que deseja deletar este contato?</string>
     <string name="AreYouSureSecretChat">Voc tem certeza que deseja comear uma conversa secreta?</string>
     <string name="ForwardFromMyName">encaminhar pelo meu nome</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Rpido</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Poderoso</string>
     <string name="Page6Title">Baseado na nuvem</string>
     <string name="Page7Title">Privado</string>
-    <string name="Page1Message">Bem-vindo  era das mensagens<![CDATA[<br/>]]> rpidas e seguras</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> envia mensagens mais rapidamente do que qualquer outro aplicativo</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> ser gratuito para sempre. Sem propagandas. Sem mensalidades</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> mantm suas mensagens seguras contra ataques de hackers</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no tem limites para o tamanho de suas mdias e conversas</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> permite que voc acesse suas mensagens a partir de vrios dispositivos</string>
-    <string name="Page7Message">As mensagens do <![CDATA[<b>Telegram</b>]]> so fortemente criptografadase podem se autodestruir</string>
+    <string name="Page1Message">O mais <![CDATA[<b>rpido</b>]]> aplicativo de mensagem do<![CDATA[<br/>]]>mundo.  <![CDATA[<b>gratuito</b>]]> e <![CDATA[<b>seguro</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> envia mensagens mais rpido que<![CDATA[<br/>]]>qualquer outro aplicativo.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]>  grtis para sempre. <![CDATA[<br/>]]>Sem propagandas. Sem taxas.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> mantm suas mensagens seguras<![CDATA[<br/>]]>contra ataques de hackers.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no possui limites no tamanho<![CDATA[<br/>]]>de seus arquivos e conversas.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> permite voc acessar suas<![CDATA[<br/>]]> mensagens de mltiplos dispositivos.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> possui mensagens fortemente<![CDATA[<br/>]]>encriptadas e podem se auto-destruir.</string>
     <string name="StartMessaging">Comece a conversar</string>
-
     <!--plurals-->
     <string name="Members_zero">sem membros</string>
     <string name="Members_one">%1$d membro</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">de %1$d contatos</string>
     <string name="FromContacts_many">de %1$d contatos</string>
     <string name="FromContacts_other">de %1$d contatos</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
index 7e1c76a6b..e6cc8f14c 100644
--- a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
@@ -4,324 +4,308 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">Portugus (Portugal)</string>
     <string name="LanguageNameInEnglish">Portuguese (Portugal)</string>
     <string name="LanguageCode">pt_PT</string>
-
     <!--signin view-->
-    <string name="YourPhone">O seu telefone</string>
-    <string name="StartText">Confirme o cdigo do seu pas\ne introduza o seu nmero de telefone.</string>
+    <string name="YourPhone">Seu nmero</string>
+    <string name="StartText">Por favor confirme o cdigo do seu pas\ne digite o nmero do seu telefone.</string>
     <string name="ChooseCountry">Escolha um pas</string>
-    <string name="WrongCountry">Cdigo de pas incorreto</string>
-
+    <string name="WrongCountry">Cdigo do pas incorreto</string>
     <!--code enter view-->
-    <string name="YourCode">O seu cdigo</string>
-    <string name="SentSmsCode">Acabamos de enviar ao seu telefone uma SMS com um cdigo de ativao</string>
-    <string name="CallText">Vamos ligar para voc em</string>
-    <string name="Calling">A ligar...</string>
+    <string name="YourCode">Seu cdigo</string>
+    <string name="SentSmsCode">Enviamos uma SMS com um cdigo de ativao para o seu telefone</string>
+    <string name="CallText">Vamos te ligar em</string>
+    <string name="Calling">Estamos te ligando...</string>
     <string name="Code">Cdigo</string>
     <string name="WrongNumber">Nmero incorreto?</string>
-    <string name="DidNotGetTheCode">Didn\'t get the code?</string>
-
+    <string name="DidNotGetTheCode">No recebeu o cdigo?</string>
     <!--signup view-->
-    <string name="YourName">O seu nome</string>
-    <string name="RegisterText">Indique o seu nome e apelidos</string>
+    <string name="YourName">Seu nome</string>
+    <string name="RegisterText">Configure seu nome e sobrenome</string>
     <!--<string name="RegisterText">Set up your name and picture</string>-->
     <string name="FirstName">Nome (obrigatrio)</string>
-    <string name="LastName">Apelidos (opcional)</string>
-    <string name="CancelRegistration">Cancelar o registo</string>
-
+    <string name="LastName">Sobrenome (opcional)</string>
+    <string name="CancelRegistration">Cancelar registro</string>
     <!--chats view-->
-    <string name="Chats">Chats</string>
-    <string name="Search">Pesquisar</string>
+    <string name="Chats">Conversas</string>
+    <string name="Search">Busca</string>
     <string name="NewMessages">Novas mensagens</string>
-    <string name="Settings">Definies</string>
-    <string name="Contacts">Contactos</string>
-    <string name="NewGroup">Novo grupo</string>
+    <string name="Settings">Configuraes</string>
+    <string name="Contacts">Contatos</string>
+    <string name="NewGroup">Novo Grupo</string>
     <string name="Yesterday">ontem</string>
-    <string name="NoResult">Sem resultados</string>
-    <string name="NoChats">Ainda no h chats...</string>
-    <string name="NoChatsHelp">Comece a enviar mensagens premindo\no boto Novas mensagens do canto superior direito\nou v para a seco de Contactos.</string>
-    <string name="WaitingForNetwork"> espera da rede...</string>
-    <string name="Connecting">A conectar...</string>
-    <string name="Updating">A atualizar...</string>
-    <string name="NewSecretChat">Novo chat secreto</string>
-    <string name="AwaitingEncryption"> espera de que %s se conecte...</string>
-    <string name="EncryptionRejected">Chat secreto cancelado</string>
-    <string name="EncryptionProcessing">A trocar chaves de encriptao...</string>
-    <string name="EncryptedChatStartedOutgoing">%s entrou no seu chat secreto.</string>
-    <string name="EncryptedChatStartedIncoming">Acaba de entrar no chat secreto.</string>
+    <string name="NoResult">Nenhum resultado</string>
+    <string name="NoChats">Ainda no h conversas...</string>
+    <string name="NoChatsHelp">Comece a conversar pressionando o\nboto \'Nova Mensagem\' no canto superior direito\nou v para a seo \'Contatos\'.</string>
+    <string name="WaitingForNetwork">Aguardando rede...</string>
+    <string name="Connecting">Conectando...</string>
+    <string name="Updating">Atualizando...</string>
+    <string name="NewSecretChat">Nova Conversa Secreta</string>
+    <string name="AwaitingEncryption">Esperando %s se conectar...</string>
+    <string name="EncryptionRejected">Conversa secreta cancelada</string>
+    <string name="EncryptionProcessing">Trocando chaves de criptografia...</string>
+    <string name="EncryptedChatStartedOutgoing">%s entrou na conversa secreta</string>
+    <string name="EncryptedChatStartedIncoming">Voc entrou na conversa secreta</string>
     <string name="ClearHistory">Limpar histrico</string>
-    <string name="DeleteChat">Eliminar e sair</string>
+    <string name="DeleteChat">Apagar e sair</string>
     <string name="HiddenName">Nome oculto</string>
-    <string name="SelectChat">Selecionar chat</string>
-
+    <string name="SelectChat">Selecione uma Conversa</string>
     <!--broadcasts-->
-    <string name="BroadcastList">Broadcast List</string>
-    <string name="NewBroadcastList">New Broadcast List</string>
-    <string name="EnterListName">Enter list name</string>
-    <string name="YouCreatedBroadcastList">You created a broadcast list</string>
-    <string name="AddRecipient">Add Recipient</string>
-    <string name="KickFromBroadcast">Remove from broadcast list</string>
-
+    <string name="BroadcastList">Lista de Broadcast</string>
+    <string name="NewBroadcastList">Nova Lista de Broadcast</string>
+    <string name="EnterListName">Digite o nome da lista</string>
+    <string name="YouCreatedBroadcastList">Voc criou uma lista de broadcast</string>
+    <string name="AddRecipient">Adicionar destinatrio</string>
+    <string name="KickFromBroadcast">Remover da lista de broadcast</string>
     <!--documents view-->
-    <string name="SelectFile">Selecionar ficheiro</string>
-    <string name="FreeOfTotal">%1$s de %2$s livres</string>
+    <string name="SelectFile">Selecione um Arquivo</string>
+    <string name="FreeOfTotal">Disponvel %1$s de %2$s</string>
     <string name="UnknownError">Erro desconhecido</string>
     <string name="AccessError">Erro de acesso</string>
-    <string name="NoFiles">Ainda no h ficheiros...</string>
-    <string name="FileUploadLimit">O tamanho do ficheiro no pode ser maior de %1$s</string>
-    <string name="NotMounted">Armazenamento sem montar</string>
+    <string name="NoFiles">Ainda no h arquivos</string>
+    <string name="FileUploadLimit">Tamanho do arquivo no deve ser maior que %1$s</string>
+    <string name="NotMounted">Armazenamento no est montado</string>
     <string name="UsbActive">Transferncia USB ativa</string>
-    <string name="InternalStorage">Armazenamento interno</string>
-    <string name="ExternalStorage">Armazenamento externo</string>
-    <string name="SystemRoot">Raiz do sistema</string>
+    <string name="InternalStorage">Armazenamento Interno</string>
+    <string name="ExternalStorage">Armazenamento Externo</string>
+    <string name="SystemRoot">Administrador do Sistema</string>
     <string name="SdCard">Carto SD</string>
-
     <!--chat view-->
     <string name="Invisible">invisvel</string>
-    <string name="Typing">a escrever...</string>
+    <string name="Typing">escrevendo...</string>
     <string name="Attach">Anexar</string>
-    <string name="IsTyping">est a escrever...</string>
-    <string name="AreTyping">esto a escrever...</string>
-    <string name="GotAQuestion">Tem alguma pergunta\nacerca do Telegram?</string>
-    <string name="ChatTakePhoto">Tirar uma foto</string>
+    <string name="IsTyping">est escrevendo...</string>
+    <string name="AreTyping">esto escrevendo...</string>
+    <string name="GotAQuestion">Tem alguma dvida\nsobre o Telegram?</string>
+    <string name="ChatTakePhoto">Tirar foto</string>
     <string name="ChatGallery">Galeria</string>
     <string name="ChatLocation">Localizao</string>
     <string name="ChatVideo">Vdeo</string>
     <string name="ChatDocument">Documento</string>
-    <string name="NoMessages">Ainda no h mensagens...</string>
-    <string name="ViewPhoto">Ver foto</string>
-    <string name="ViewLocation">Ver localizao</string>
-    <string name="ViewVideo">Reproduzir vdeo</string>
-    <string name="ForwardedMessage">Mensagem reencaminhada</string>
+    <string name="NoMessages">Ainda no h mensagens aqui...</string>
+    <string name="ViewPhoto">Ver Foto</string>
+    <string name="ViewLocation">Ver Localizao</string>
+    <string name="ViewVideo">Tocar Vdeo</string>
+    <string name="ForwardedMessage">Mensagem encaminhada</string>
     <string name="From">De</string>
-    <string name="NoRecent">No h recentes</string>
+    <string name="NoRecent">Nada recente</string>
     <string name="Message">Mensagem</string>
     <string name="TypeMessage">Escrever mensagem</string>
-    <string name="DOWNLOAD">Transferir</string>
+    <string name="DOWNLOAD">Baixar</string>
     <string name="Selected">%d selecionado</string>
-    <string name="ShareMyContactInfo">PARTILHAR A MINHA INFORMAO DE CONTACTO</string>
-    <string name="AddToContacts">ADICIONAR AOS CONTACTOS</string>
-    <string name="EncryptedPlaceholderTitleIncoming">%s convidou-o a um chat secreto.</string>
-    <string name="EncryptedPlaceholderTitleOutgoing">Convidou %s para um chat secreto.</string>
-    <string name="EncryptedDescriptionTitle">Os chats secretos:</string>
-    <string name="EncryptedDescription1">Utilizam encriptao ponto a ponto</string>
-    <string name="EncryptedDescription2">No deixam rasto nos nossos servidores</string>
-    <string name="EncryptedDescription3">Tm temporizador para a autodestruio das mensagens</string>
-    <string name="EncryptedDescription4">No permitem o reencaminhamento</string>
-    <string name="YouWereKicked">Foi removido do grupo</string>
-    <string name="YouLeft">Deixou este grupo</string>
-    <string name="DeleteThisGroup">Eliminar este grupo</string>
-    <string name="DeleteThisChat">Eliminar este chat</string>
-    <string name="SlideToCancel">DESLIZAR PARA CANCELAR</string>
-    <string name="SaveToDownloads">Guardar nas transferncias</string>
-    <string name="ApplyLocalizationFile">Aplicar o ficheiro de localizao</string>
-    <string name="UnsupportedAttachment">Unsupported attachment</string>
-
+    <string name="ShareMyContactInfo">COMPARTILHAR MINHAS INFORMAES DE CONTATO</string>
+    <string name="AddToContacts">ADICIONAR AOS CONTATOS</string>
+    <string name="EncryptedPlaceholderTitleIncoming">%s convidou voc para uma conversa secreta.</string>
+    <string name="EncryptedPlaceholderTitleOutgoing">Voc convidou %s para uma conversa secreta.</string>
+    <string name="EncryptedDescriptionTitle">Diferenas dos Chats Secretos:</string>
+    <string name="EncryptedDescription1">Criptografia de ponta-a-ponta</string>
+    <string name="EncryptedDescription2">Sem rastros nos servidores</string>
+    <string name="EncryptedDescription3">Timer de autodestruio</string>
+    <string name="EncryptedDescription4">Encaminhamento desativado</string>
+    <string name="YouWereKicked">Voc foi removido deste grupo</string>
+    <string name="YouLeft">Voc saiu deste grupo</string>
+    <string name="DeleteThisGroup">Apagar este grupo</string>
+    <string name="DeleteThisChat">Apagar esta conversa</string>
+    <string name="SlideToCancel">DESLIZE PARA CANCELAR</string>
+    <string name="SaveToDownloads">Salvar em downloads</string>
+    <string name="ApplyLocalizationFile">Aplicar arquivo de localizao</string>
+    <string name="UnsupportedAttachment">Anexo no suportado</string>
     <!--notification-->
-    <string name="EncryptedChatRequested">Chat secreto pedido</string>
-    <string name="EncryptedChatAccepted">Chat secreto iniciado</string>
-    <string name="MessageLifetimeChanged">%1$s ativou a autodestruio em %2$s</string>
-    <string name="MessageLifetimeChangedOutgoing">Ativou a autodestruio em %1$s</string>
-    <string name="MessageLifetimeRemoved">%1$s desativou a autodestruio</string>
-    <string name="MessageLifetimeYouRemoved">Desativou a autodestruio</string>
+    <string name="EncryptedChatRequested">Conversa secreta solicitada</string>
+    <string name="EncryptedChatAccepted">Conversa secreta iniciada</string>
+    <string name="MessageLifetimeChanged">%1$s estabeleceu o tempo de autodestruio para %2$s </string>
+    <string name="MessageLifetimeChangedOutgoing">Voc estabeleceu o tempo de autodestruio para %1$s</string>
+    <string name="MessageLifetimeRemoved">%1$s desativou o temporizador de autodestruio</string>
+    <string name="MessageLifetimeYouRemoved">Voc desativou o temporizador de autodestruio</string>
     <string name="MessageLifetime2s">2 segundos</string>
     <string name="MessageLifetime5s">5 segundos</string>
     <string name="MessageLifetime1m">1 minuto</string>
     <string name="MessageLifetime1h">1 hora</string>
     <string name="MessageLifetime1d">1 dia</string>
     <string name="MessageLifetime1w">1 semana</string>
-    <string name="YouHaveNewMessage">Tem uma nova mensagem</string>
+    <string name="YouHaveNewMessage">Voc tem uma nova mensagem</string>
     <string name="NotificationMessageText">%1$s: %2$s</string>
-    <string name="NotificationMessageNoText">%1$s enviou uma mensagem</string>
-    <string name="NotificationMessagePhoto">%1$s enviou uma foto</string>
-    <string name="NotificationMessageVideo">%1$s enviou um vdeo</string>
-    <string name="NotificationMessageContact">%1$s partilhou um contacto</string>
+    <string name="NotificationMessageNoText">%1$s te enviou uma mensagem</string>
+    <string name="NotificationMessagePhoto">%1$s te enviou uma foto</string>
+    <string name="NotificationMessageVideo">%1$s te enviou um vdeo</string>
+    <string name="NotificationMessageContact">%1$s compartilhou um contato com voc</string>
     <string name="NotificationMessageMap">%1$s enviou uma localizao</string>
-    <string name="NotificationMessageDocument">%1$s enviou um documento</string>
-    <string name="NotificationMessageAudio">%1$s enviou um udio</string>
+    <string name="NotificationMessageDocument">%1$s te enviou um documento</string>
+    <string name="NotificationMessageAudio">%1$s te enviou um udio</string>
     <string name="NotificationMessageGroupText">%1$s @ %2$s: %3$s</string>
     <string name="NotificationMessageGroupNoText">%1$s enviou uma mensagem para o grupo %2$s</string>
     <string name="NotificationMessageGroupPhoto">%1$s enviou uma foto para o grupo %2$s</string>
     <string name="NotificationMessageGroupVideo">%1$s enviou um vdeo para o grupo %2$s</string>
-    <string name="NotificationMessageGroupContact">%1$s partilhou um contacto no grupo %2$s</string>
+    <string name="NotificationMessageGroupContact">%1$s compartilhou um contato para o grupo %2$s</string>
     <string name="NotificationMessageGroupMap">%1$s enviou uma localizao para o grupo %2$s</string>
     <string name="NotificationMessageGroupDocument">%1$s enviou um documento para o grupo %2$s</string>
-    <string name="NotificationMessageGroupAudio">%1$senviou um udio para o grupo %2$s</string>
-    <string name="NotificationInvitedToGroup">%1$s convidou-o ao grupo %2$s</string>
-    <string name="NotificationEditedGroupName">%1$s renomeou o grupo %2$s</string>
-    <string name="NotificationEditedGroupPhoto">%1$s alterou a foto do grupo %2$s</string>
-    <string name="NotificationGroupAddMember">%1$s convidou %3$s ao grupo %2$s</string>
+    <string name="NotificationMessageGroupAudio">%1$s enviou um udio para o grupo %2$s</string>
+    <string name="NotificationInvitedToGroup">%1$s convidou voc para o grupo %2$s</string>
+    <string name="NotificationEditedGroupName">%1$s editou o nome do grupo %2$s</string>
+    <string name="NotificationEditedGroupPhoto">%1$s editou a foto do grupo %2$s</string>
+    <string name="NotificationGroupAddMember">%1$s convidou %3$s para o grupo %2$s</string>
     <string name="NotificationGroupKickMember">%1$s removeu %3$s do grupo %2$s</string>
-    <string name="NotificationGroupKickYou">%1$s removeu-o do grupo %2$s</string>
-    <string name="NotificationGroupLeftMember">%1$s deixou o grupo %2$s</string>
-    <string name="NotificationContactJoined">%1$s aderiu ao Telegram!</string>
-    <string name="NotificationUnrecognizedDevice">%1$s,\nDetetmos um acesso  sua conta a partir de um novo dispositivo o dia %2$s\n\nDispositivo: %3$s\nLocalizao: %4$s\n\nSe no foi voc, pode ir a Definies - Terminar todas as sesses.\n\nObrigado,\nA equipa do Telegram</string>
-    <string name="NotificationContactNewPhoto">%1$s atualizou a sua foto de perfil</string>
-    <string name="Reply">Reply</string>
-
+    <string name="NotificationGroupKickYou">%1$s removeu voc do grupo %2$s</string>
+    <string name="NotificationGroupLeftMember">%1$s saiu do grupo %2$s</string>
+    <string name="NotificationContactJoined">%1$s entrou para o Telegram!</string>
+    <string name="NotificationUnrecognizedDevice">%1$s,\nNs detectamos um login na sua conta de um novo dispositivo %2$s\n\nDispositivo: %3$s\nLocalizao: %4$s\nSe no foi voc, voc pode ir em Configuraes - Terminar todas as sesses.\n\nAtenciosamente,\nTime do Telegram</string>
+    <string name="NotificationContactNewPhoto">%1$s atualizou a foto do perfil</string>
+    <string name="Reply">Responder</string>
     <!--contacts view-->
-    <string name="SelectContact">Selecionar contacto</string>
-    <string name="NoContacts">Ainda no h contactos</string>
+    <string name="SelectContact">Selecionar Contato</string>
+    <string name="NoContacts">Ainda no h contatos</string>
     <string name="InviteText">Ei, vamos mudar para o Telegram: http://telegram.org/dl2</string>
     <string name="TodayAt">hoje s</string>
     <string name="YesterdayAt">ontem s</string>
     <string name="OtherAt">s</string>
-    <string name="Online">conectado</string>
-    <string name="Offline">desconectado</string>
-    <string name="LastSeen">ltima visualizao</string>
-    <string name="LastSeenDate">ltima visualizao</string>
-    <string name="InviteFriends">Convidar amigos</string>
-
+    <string name="Online">online</string>
+    <string name="Offline">offline</string>
+    <string name="LastSeen">visto</string>
+    <string name="LastSeenDate">visto</string>
+    <string name="InviteFriends">Convidar Amigos</string>
     <!--group create view-->
     <string name="SendMessageTo">Enviar mensagem para...</string>
-    <string name="EnterGroupNamePlaceholder">Introduza o nome do grupo</string>
+    <string name="EnterGroupNamePlaceholder">Digite o nome do grupo</string>
     <string name="GroupName">Nome do grupo</string>
-    <string name="AllContacts">TODOS OS CONTACTOS</string>
-    <string name="MembersCount">%1$d/%2$d members</string>
-
+    <string name="AllContacts">TODOS OS CONTATOS</string>
+    <string name="MembersCount">%1$d/%2$d membros</string>
     <!--group info view-->
-    <string name="EnterGroupNameTitle">INTRODUZA O NOME DO GRUPO</string>
-    <string name="SharedMedia">Multimdia partilhado</string>
-    <string name="GroupInfo">Informao do grupo</string>
-    <string name="SHAREDMEDIA">MULTIMDIA PARTILHADO</string>
-    <string name="SETTINGS">DEFINIES</string>
+    <string name="EnterGroupNameTitle">DIGITE O NOME DO GRUPO</string>
+    <string name="SharedMedia">Mdia compartilhada</string>
+    <string name="GroupInfo">Informaes do Grupo</string>
+    <string name="SHAREDMEDIA">MDIA COMPARTILHADA</string>
+    <string name="SETTINGS">CONFIGURAES</string>
     <string name="AddMember">Adicionar membro</string>
-    <string name="DeleteAndExit">Eliminar e sair do grupo</string>
+    <string name="DeleteAndExit">Apagar e sair do grupo</string>
     <string name="Notifications">Notificaes</string>
     <string name="KickFromGroup">Remover do grupo</string>
-
     <!--contact info view-->
-    <string name="ShareContact">Partilhar</string>
+    <string name="ShareContact">Compartilhar</string>
     <string name="AddContact">Adicionar</string>
     <string name="BlockContact">Bloquear</string>
     <string name="EditContact">Editar</string>
-    <string name="DeleteContact">Eliminar</string>
+    <string name="DeleteContact">Apagar</string>
     <string name="PhoneHome">CASA</string>
-    <string name="PhoneMobile">TELEMVEL</string>
+    <string name="PhoneMobile">CELULAR</string>
     <string name="PhoneWork">TRABALHO</string>
     <string name="PhoneOther">OUTRO</string>
     <string name="PhoneMain">PRINCIPAL</string>
-    <string name="ContactInfo">Informao de contacto</string>
+    <string name="ContactInfo">Informaes do Contato</string>
     <string name="PHONE">TELEFONE</string>
-    <string name="StartEncryptedChat">Iniciar chat secreto</string>
+    <string name="StartEncryptedChat">Iniciar Conversa Secreta</string>
     <string name="CreateEncryptedChatError">Ocorreu um erro.</string>
-    <string name="CreateEncryptedChatOutdatedError">No  possvel criar um chat secreto com %1$s.\n\n%2$s est a utilizar uma verso anterior do Telegram e primeiro precisa atualiz-lo.</string>
-    <string name="SecretTitle">Chat secreto</string>
-    <string name="EncryptionKey">Chave de encriptao</string>
-    <string name="MessageLifetime">Autodestruio</string>
-    <string name="ShortMessageLifetimeForever">Desligado</string>
+    <string name="CreateEncryptedChatOutdatedError">No  possvel criar uma conversa secreta com %1$s.\n\n%2$s est usando uma verso antiga do Telegram e precisa ser atualizada.</string>
+    <string name="SecretTitle">Conversa Secreta</string>
+    <string name="EncryptionKey">Chave criptogrfica</string>
+    <string name="MessageLifetime">Tempo de autodestruio</string>
+    <string name="ShortMessageLifetimeForever">Desativado</string>
     <string name="ShortMessageLifetime2s">2s</string>
     <string name="ShortMessageLifetime5s">5s</string>
     <string name="ShortMessageLifetime1m">1m</string>
     <string name="ShortMessageLifetime1h">1h</string>
     <string name="ShortMessageLifetime1d">1d</string>
-    <string name="ShortMessageLifetime1w">1sem</string>
-    <string name="EncryptionKeyDescription">Esta imagem  uma visualizao da chave de encriptao deste chat secreto com <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Se esta imagem for a mesma que a do telefone de <![CDATA[<b>]]>%2$s<![CDATA[</b>]]>, o seu chat  200%% seguro.<![CDATA[<br><br>]]>Mais informao em telegram.org</string>
-
+    <string name="ShortMessageLifetime1w">1 sem.</string>
+    <string name="EncryptionKeyDescription">Esta imagem  uma visualizao da chave criptogrfica para esta conversa secreta com <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>Se esta imagem aparecer da mesma forma no telefone de <![CDATA[<b>]]>%2$s\'s<![CDATA[</b>]]>, sua conversa  200%% segura.<![CDATA[<br><br>]]>Saiba mais em telegram.org</string>
     <!--settings view-->
-    <string name="ResetNotificationsText">Repor todas as notificaes ao valor predefinido</string>
-    <string name="TextSize">Tamanho do texto das mensagens</string>
+    <string name="ResetNotificationsText">Restaurar todas as configuraes de notificao</string>
+    <string name="TextSize">Tamanho do texto nas mensagens</string>
     <string name="AskAQuestion">Fazer uma pergunta</string>
-    <string name="EnableAnimations">Ativar animaes</string>
+    <string name="EnableAnimations">Permitir animaes</string>
     <string name="EnableMarkdown">Enable Markdown</string>
     <string name="Unblock">Desbloquear</string>
-    <string name="UnblockText">Toque sem soltar num utilizador para desbloquear.</string>
-    <string name="NoBlocked">Ainda no h utilizadores bloqueados</string>
-    <string name="YourPhoneNumber">O SEU NMERO DE TELEFONE</string>
+    <string name="UnblockText">Toque e segure no usurio para desbloquear</string>
+    <string name="NoBlocked">Nenhum usurio bloqueado</string>
+    <string name="YourPhoneNumber">SEU NMERO DE TELEFONE</string>
     <string name="MessageNotifications">NOTIFICAES DE MENSAGENS</string>
     <string name="Alert">Alerta</string>
-    <string name="MessagePreview">Pr-visualizao da mensagem</string>
-    <string name="GroupNotifications">NOTIFICAES DE GRUPO</string>
+    <string name="MessagePreview">Visualizao de Mensagem</string>
+    <string name="GroupNotifications">NOTIFICAES DO GRUPO</string>
     <string name="Sound">Som</string>
-    <string name="InAppNotifications">NOTIFICAES NA APLICAO</string>
-    <string name="InAppSounds">Sons na aplicao</string>
-    <string name="InAppVibrate">Vibrar na aplicao</string>
+    <string name="InAppNotifications">NOTIFICAES NO APLICATIVO</string>
+    <string name="InAppSounds">Sons no Aplicativo</string>
+    <string name="InAppVibrate">Vibrao no Aplicativo</string>
     <string name="Vibrate">Vibrar</string>
-    <string name="InAppPreview">Pr-visualizao na aplicao</string>
-    <string name="Reset">REPOR</string>
-    <string name="ResetAllNotifications">Repor todas as notificaes</string>
-    <string name="UndoAllCustom">Desfazer as definies personalizadas de notificao para todos os contactos e grupos</string>
-    <string name="NotificationsAndSounds">Notificaes e sons</string>
-    <string name="BlockedUsers">Utilizadores bloqueados</string>
-    <string name="SaveIncomingPhotos">Guardar fotos recebidas</string>
-    <string name="LogOut">Terminar sesso</string>
-    <string name="YourFirstNameAndLastName">O SEU NOME E APELIDOS</string>
+    <string name="InAppPreview">Visualizao no Aplicativo</string>
+    <string name="Reset">LIMPAR</string>
+    <string name="ResetAllNotifications">Limpar todas as notificaes</string>
+    <string name="UndoAllCustom">Desfazer todas as configuraes de notificao para todos os seus contatos e grupos</string>
+    <string name="NotificationsAndSounds">Notificaes e Sons</string>
+    <string name="BlockedUsers">Usurios bloqueados</string>
+    <string name="SaveIncomingPhotos">Salvar fotos recebidas</string>
+    <string name="LogOut">Sair</string>
+    <string name="YourFirstNameAndLastName">SEU NOME E SOBRENOME</string>
     <string name="NoSound">Sem som</string>
-    <string name="Default">Predefinido</string>
+    <string name="Default">Padro</string>
     <string name="Support">SUPORTE</string>
-    <string name="ChatBackground">Fundo do chat</string>
+    <string name="ChatBackground">Papel de parede</string>
     <string name="MessagesSettings">MENSAGENS</string>
-    <string name="SendByEnter">Enviar com Enter</string>
+    <string name="SendByEnter">Enviar usando \'Enter\'</string>
     <string name="TerminateAllSessions">Terminar todas as outras sesses</string>
     <string name="Events">EVENTOS</string>
-    <string name="ContactJoined">Contactos que aderem ao Telegram</string>
+    <string name="ContactJoined">Contato entrou para o Telegram</string>
     <string name="Pebble">PEBBLE</string>
-    <string name="Language">Lngua</string>
-    <string name="AskAQuestionInfo">Tenha em conta que o suporte do Telegram est realizado por voluntrios. Tentaremos responder o mais rpido possvel, mas pode demorar um bocado.<![CDATA[<br><br>]]>D uma vista de olhos ao <![CDATA[<a href="http://telegram.org/faq#general">FAQ do Telegram</a>]]>: ali encontrar  respostas s perguntas mais habituais e dicas importantes para a <![CDATA[<a href="http://telegram.org/faq#troubleshooting">resoluo de problemas</a>]]>.</string>
+    <string name="Language">Idioma</string>
+    <string name="AskAQuestionInfo">Por favor compreenda que o Suporte do Telegram  feito por voluntrios. Tentamos responder o mais rpido possvel, mas pode demorar um pouco. <![CDATA[<br><br>]]>Por favor acesse o <![CDATA[<a href=\"http://telegram.org/faq#general\">FAQ do Telegram</a>]]>: temos respostas para algumas questes, assim como dicas importantes  <![CDATA[<a href=\"http://telegram.org/faq#troubleshooting\">resoluo de problemas</a>]]>.</string>
     <string name="AskButton">Pergunte a um voluntrio</string>
     <string name="TelegramFaq">FAQ do Telegram</string>
     <string name="TelegramFaqUrl">https://telegram.org/faq</string>
-    <string name="DeleteLocalization">Eliminar localizao?</string>
-    <string name="IncorrectLocalization">Ficheiro de localizao incorreto</string>
+    <string name="DeleteLocalization">Apagar localizao?</string>
+    <string name="IncorrectLocalization">Arquivo de localizao incorreto</string>
     <string name="Enabled">Ativado</string>
     <string name="Disabled">Desativado</string>
-    <string name="NotificationsService">Servio de notificaes</string>
-    <string name="NotificationsServiceDisableInfo">Pode desativar o servio de notificaes caso o google play services seja suficiente para receber as suas notificaes. No entanto, recomendamos deix-lo ativado para manter a aplicao a se executar no segundo plano e receber notificaes instantneas.</string>
-    <string name="SortBy">Ordenar por</string>
-    <string name="ImportContacts">Importar contactos</string>
-    <string name="WiFiOnly">Unicamente com WiFi</string>
-    <string name="SortFirstName">Nome</string>
-    <string name="SortLastName">Apelidos</string>
-    <string name="LedColor">LED Color</string>
-    <string name="PopupNotification">Popup Notification</string>
-    <string name="NoPopup">No popup</string>
-    <string name="OnlyWhenScreenOn">Only when screen "on"</string>
-    <string name="OnlyWhenScreenOff">Only when screen "off"</string>
-    <string name="AlwaysShowPopup">Always show popup</string>
-    <string name="BadgeNumber">Badge Number</string>
-    <string name="Short">Short</string>
-    <string name="Long">Long</string>
-    <string name="SystemDefault">System default</string>
-    <string name="SettingsDefault">Settings default</string>
-    <string name="AutomaticMediaDownload">AUTOMATIC MEDIA DOWNLOAD</string>
-    <string name="WhenUsingMobileData">When using mobile data</string>
-    <string name="WhenConnectedOnWiFi">When connected on Wi-Fi</string>
-    <string name="WhenRoaming">When roaming</string>
-    <string name="NoMediaAutoDownload">No media</string>
-
+    <string name="NotificationsService">Servio de Notificaes</string>
+    <string name="NotificationsServiceDisableInfo">Se o servio de notificao do  Google Play for suficiente para voc, voc pode desativar o \"Servio de Notificaes\". Porm, recomendamos deix-lo ativo para manter o aplicativo executando em segundo plano e receber notificaes instantaneamente.</string>
+    <string name="SortBy">Ordenar Por</string>
+    <string name="ImportContacts">Importar Contatos</string>
+    <string name="WiFiOnly">Apenas por WiFi</string>
+    <string name="SortFirstName">Primeiro nome</string>
+    <string name="SortLastName">Sobrenome</string>
+    <string name="LedColor">Cor do LED</string>
+    <string name="PopupNotification">Notificaes Pop-up</string>
+    <string name="NoPopup">Sem pop-up</string>
+    <string name="OnlyWhenScreenOn">Somente com a tela ligada</string>
+    <string name="OnlyWhenScreenOff">Somente com a tela desligada</string>
+    <string name="AlwaysShowPopup">Sempre mostrar pop-up</string>
+    <string name="BadgeNumber">Contador de medalhas</string>
+    <string name="Short">Curta</string>
+    <string name="Long">Longa</string>
+    <string name="SystemDefault">Padro do sistema</string>
+    <string name="SettingsDefault">Configuraes padro</string>
+    <string name="AutomaticMediaDownload">DOWNLOAD AUTOMTICO DE MDIA</string>
+    <string name="WhenUsingMobileData">Ao usar dados mveis</string>
+    <string name="WhenConnectedOnWiFi">Quando conectado em Wi-Fi</string>
+    <string name="WhenRoaming">Quando em roaming</string>
+    <string name="NoMediaAutoDownload">Sem mdia</string>
+    <string name="SaveToGallerySettings">Salvar na galeria</string>
     <!--media view-->
-    <string name="NoMedia">Ainda no h multimdia partilhado</string>
-    <string name="CancelDownload">Cancelar transferncia</string>
-
+    <string name="NoMedia">Ainda no h mdia compartilhada</string>
+    <string name="CancelDownload">Cancelar Download</string>
     <!--map view-->
-    <string name="MyLocation">A minha localizao</string>
+    <string name="MyLocation">Minha localizao</string>
     <string name="Map">Mapa</string>
     <string name="Satellite">Satlite</string>
     <string name="Hybrid">Hbrido</string>
     <string name="MetersAway">m de distncia</string>
     <string name="KMetersAway">km de distncia</string>
-    <string name="SendLocation">Enviar localizao</string>
-    <string name="ShareLocation">Partilhar localizao</string>
-
+    <string name="SendLocation">Enviar Localizao</string>
+    <string name="ShareLocation">Compartilhar Localizao</string>
     <!--photo gallery view-->
-    <string name="ShowAllMedia">Mostrar todo o multimdia</string>
-    <string name="SaveToGallery">Guardar na galeria</string>
+    <string name="ShowAllMedia">Mostrar todas as mdias</string>
+    <string name="SaveToGallery">Salvar na galeria</string>
     <string name="Of">%1$d de %2$d</string>
     <string name="Gallery">Galeria</string>
-    <string name="AllPhotos">Todas as fotos</string>
+    <string name="AllPhotos">Todas as Fotos</string>
     <string name="NoPhotos">Ainda no h fotos</string>
-
     <!--edit video view-->
-    <string name="EditVideo">Edit Video</string>
-    <string name="OriginalVideo">Original Video</string>
-    <string name="EditedVideo">Edited Video</string>
-
+    <string name="EditVideo">Editar Vdeo</string>
+    <string name="OriginalVideo">Vdeo Original</string>
+    <string name="EditedVideo">Vdeo Editado</string>
+    <string name="SendingVideo">Enviando vdeo...</string>
+    <string name="CompressVideo">Compactar Vdeo</string>
     <!--button titles-->
-    <string name="Next">Seguinte</string>
-    <string name="Back">Anterior</string>
+    <string name="Next">Prximo</string>
+    <string name="Back">Voltar</string>
     <string name="Done">Concludo</string>
     <string name="Open">Abrir</string>
     <string name="Cancel">Cancelar</string>
@@ -330,128 +314,118 @@
     <string name="Send">Enviar</string>
     <string name="Call">Ligar</string>
     <string name="Copy">Copiar</string>
-    <string name="Delete">Eliminar</string>
-    <string name="Forward">Reencaminhar</string>
+    <string name="Delete">Apagar</string>
+    <string name="Forward">Encaminhar</string>
     <string name="QuoteForward">Quote and Forward</string>
-    <string name="Share">Share</string>
-    <string name="Retry">Repetir</string>
-    <string name="FromCamera">Da cmara</string>
-    <string name="FromGalley">Da galeria</string>
-    <string name="DeletePhoto">Eliminar foto</string>
-    <string name="OpenPhoto">Abrir foto</string>
-    <string name="Set">Definir</string>
+    <string name="Retry">Tentar novamente</string>
+    <string name="FromCamera">Cmera</string>
+    <string name="FromGalley">Galeria</string>
+    <string name="DeletePhoto">Apagar foto</string>
+    <string name="OpenPhoto"> Abrir foto</string>
+    <string name="Set">Aplicar</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 removeu un2</string>
-    <string name="ActionLeftUser">un1 deixou o grupo</string>
+    <string name="ActionLeftUser">un1 saiu do grupo</string>
     <string name="ActionAddUser">un1 adicionou un2</string>
-    <string name="ActionRemovedPhoto">un1 removeu a foto do grupo</string>
-    <string name="ActionChangedPhoto">un1 alterou a foto do grupo</string>
-    <string name="ActionChangedTitle">un1 renomeou o grupo para un2</string>
+    <string name="ActionRemovedPhoto">un1 removeu foto do grupo</string>
+    <string name="ActionChangedPhoto">un1 mudou a foto do grupo</string>
+    <string name="ActionChangedTitle">un1 mudou o nome do grupo para un2</string>
     <string name="ActionCreateGroup">un1 criou o grupo</string>
-    <string name="ActionYouKickUser">Removeu un2</string>
-    <string name="ActionYouLeftUser">Deixou o grupo</string>
-    <string name="ActionYouAddUser">Adicionou un2</string>
-    <string name="ActionYouRemovedPhoto">Removeu a foto do grupo</string>
-    <string name="ActionYouChangedPhoto">Alterou a foto do grupo</string>
-    <string name="ActionYouChangedTitle">Renomeou o grupo para un2</string>
-    <string name="ActionYouCreateGroup">Criou o grupo</string>
-    <string name="ActionKickUserYou">un1 removeu-o</string>
-    <string name="ActionAddUserYou">un1 adicionou-o</string>
-    <string name="UnsuppotedMedia">A sua verso do Telegram no suporta este tipo de mensagem. Atualize a aplicao para visualiz-la: http://telegram.org/update</string>
+    <string name="ActionYouKickUser">Voc removeu un2</string>
+    <string name="ActionYouLeftUser">Voc saiu do grupo</string>
+    <string name="ActionYouAddUser">Voc adicionou un2</string>
+    <string name="ActionYouRemovedPhoto">Voc removeu a foto do grupo</string>
+    <string name="ActionYouChangedPhoto">Voc mudou a foto do grupo</string>
+    <string name="ActionYouChangedTitle">Voc mudou o nome do grupo para un2</string>
+    <string name="ActionYouCreateGroup">Voc criou o grupo</string>
+    <string name="ActionKickUserYou">un1 removeu voc</string>
+    <string name="ActionAddUserYou">un1 adicionou voc</string>
+    <string name="UnsuppotedMedia">Esta mensagem no  suportada na sua verso do Telegram. Para visualiza-la atualize seu aplicativo em http://telegram.org/update</string>
     <string name="AttachPhoto">Foto</string>
     <string name="AttachVideo">Vdeo</string>
     <string name="AttachLocation">Localizao</string>
-    <string name="AttachContact">Contacto</string>
+    <string name="AttachContact">Contato</string>
     <string name="AttachDocument">Documento</string>
     <string name="AttachAudio">udio</string>
     <string name="FromYou">Voc</string>
-    <string name="ActionTakeScreenshootYou">Efetuou uma captura de ecr</string>
-    <string name="ActionTakeScreenshoot">un1 efetuou uma captura de ecr</string>
-
+    <string name="ActionTakeScreenshootYou">Voc realizou uma captura da tela!</string>
+    <string name="ActionTakeScreenshoot">un1 realizou uma captura da tela!</string>
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Nmero de telefone invlido</string>
-    <string name="CodeExpired">O cdigo expirou. Inicie sesso novamente</string>
-    <string name="FloodWait">Demasiadas tentativas. Volte tentar mais tarde</string>
+    <string name="CodeExpired">O cdigo expirou. Por favor, identifique-se novamente.</string>
+    <string name="FloodWait">Muitas tentativas. Por favor, tente novamente mais tarde.</string>
     <string name="InvalidCode">Cdigo invlido</string>
     <string name="InvalidFirstName">Nome invlido</string>
-    <string name="InvalidLastName">Apelido invlido</string>
-    <string name="Loading">A carregar...</string>
-    <string name="NoPlayerInstalled">No tem nenhum reprodutor de vdeo. Para continuar, instale algum</string>
-    <string name="NoMailInstalled">Please send an email to sms@telegram.org and explain your problem.</string>
-    <string name="NoHandleAppInstalled">No tem nenhuma aplicao que controle o tipo de MIME \'%1$s\'. Para continuar, instale alguma</string>
-    <string name="InviteUser">Este utilizador ainda no tem o Telegram. Quer enviar um convite?</string>
-    <string name="AreYouSure">Tem a certeza?</string>
-    <string name="AddContactQ">Adicionar contacto?</string>
-    <string name="AddToTheGroup">Add %1$s to the group?\n\nNumber of last messages to forward:</string>
-    <string name="ForwardMessagesTo">Reencaminhar mensagens para %1$s?</string>
-    <string name="DeleteChatQuestion">Eliminar este chat?</string>
-    <string name="SendMessagesTo">Send messages to %1$s?</string>
-    <string name="AreYouSureLogout">Are you sure you want to logout?</string>
-    <string name="AreYouSureSessions">Are you sure you want to terminate all other sessions?</string>
-    <string name="AreYouSureDeleteAndExit">Are you sure you want to delete and leave group?</string>
-    <string name="AreYouSureDeleteThisChat">Are you sure you want to delete this chat?</string>
-    <string name="AreYouSureShareMyContactInfo">Are you sure that you want to share your contact info?</string>
-    <string name="AreYouSureBlockContact">Are you sure you want to block this contact?</string>
-    <string name="AreYouSureUnblockContact">Are you sure you want to unblock this contact?</string>
-    <string name="AreYouSureDeleteContact">Are you sure you want to delete this contact?</string>
-    <string name="AreYouSureSecretChat">Are you sure you want to start secret chat?</string>
-    <string name="ForwardFromMyName">forward from my name</string>
-
+    <string name="InvalidLastName">Sobrenome invlido</string>
+    <string name="Loading">Carregando...</string>
+    <string name="NoPlayerInstalled">Voc no possui um reprodutor de vdeo, instale um para continuar</string>
+    <string name="NoMailInstalled">Por favor, envie um email para sms@telegram.org e conte-nos sobre seu problema.</string>
+    <string name="NoHandleAppInstalled">Voc no possui um aplicativo que suporte o tipo de arquivo \'%1$s\', por favor instale um para continuar</string>
+    <string name="InviteUser">Este usurio ainda no possui Telegram, deseja enviar um convite?</string>
+    <string name="AreYouSure">Voc tem certeza?</string>
+    <string name="AddContactQ">Adicionar contato?</string>
+    <string name="AddToTheGroup">Adicionar %1$s para o grupo?\n\nNmero de ltimas mensagens para encaminhar:</string>
+    <string name="ForwardMessagesTo">Encaminhar mensagem para %1$s?</string>
+    <string name="DeleteChatQuestion">Apagar esta conversa?</string>
+    <string name="SendMessagesTo">Enviar mensagens para %1$s?</string>
+    <string name="AreYouSureLogout">Voc tem certeza que deseja sair?</string>
+    <string name="AreYouSureSessions">Voc tem certeza que deseja terminar todas as outras sesses?</string>
+    <string name="AreYouSureDeleteAndExit">Voc tem certeza que deseja deletar e sair do grupo?</string>
+    <string name="AreYouSureDeleteThisChat">Voc tem certeza que deseja deletar esta conversa?</string>
+    <string name="AreYouSureShareMyContactInfo">Voc tem certeza que deseja compartilhar suas informaes de contato?</string>
+    <string name="AreYouSureBlockContact">Voc tem certeza que deseja bloquear este contato?</string>
+    <string name="AreYouSureUnblockContact">Voc tem certeza que deseja desbloquear este contato?</string>
+    <string name="AreYouSureDeleteContact">Voc tem certeza que deseja deletar este contato?</string>
+    <string name="AreYouSureSecretChat">Voc tem certeza que deseja comear uma conversa secreta?</string>
+    <string name="ForwardFromMyName">encaminhar pelo meu nome</string>
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Rpido</string>
-    <string name="Page3Title">Grtis</string>
+    <string name="Page3Title">Gratuito</string>
     <string name="Page4Title">Seguro</string>
-    <string name="Page5Title">Potente</string>
+    <string name="Page5Title">Poderoso</string>
     <string name="Page6Title">Baseado na nuvem</string>
     <string name="Page7Title">Privado</string>
-    <string name="Page1Message">Bem-vindo  era das mensagens rpidas e seguras</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> entrega mensagens mais rpido do que<![CDATA[<br/>]]>qualquer outra aplicao</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]>  grtis para sempre. Sem anncios.<![CDATA[<br/>]]>Sem taxas de subscrio</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> mantm as suas mensagens a salvo<![CDATA[<br/>]]>de ataques de hackers</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no tem limite de tamanho para<![CDATA[<br/>]]>os seus chats e ficheiros multimdia</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> permite aceder s mensagens<![CDATA[<br/>]]>a partir de mltiplos dispositivos</string>
-    <string name="Page7Message">As mensagens do <![CDATA[<b>Telegram</b>]]> esto fortemente encriptadas<![CDATA[<br/>]]>e podem ser autodestrudas</string>
+    <string name="Page1Message">O mais <![CDATA[<b>rpido</b>]]> aplicativo de mensagem do<![CDATA[<br/>]]>mundo.  <![CDATA[<b>gratuito</b>]]> e <![CDATA[<b>seguro</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> envia mensagens mais rpido que<![CDATA[<br/>]]>qualquer outro aplicativo.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]>  grtis para sempre. <![CDATA[<br/>]]>Sem propagandas. Sem taxas.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> mantm suas mensagens seguras<![CDATA[<br/>]]>contra ataques de hackers.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> no possui limites no tamanho<![CDATA[<br/>]]>de seus arquivos e conversas.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> permite voc acessar suas<![CDATA[<br/>]]> mensagens de mltiplos dispositivos.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> possui mensagens fortemente<![CDATA[<br/>]]>encriptadas e podem se auto-destruir.</string>
     <string name="StartMessaging">Comece a conversar</string>
-
     <!--plurals-->
-    <string name="Members_zero">no members</string>
-    <string name="Members_one">%1$d member</string>
-    <string name="Members_two">%1$d members</string>
-    <string name="Members_few">%1$d members</string>
-    <string name="Members_many">%1$d members</string>
-    <string name="Members_other">%1$d members</string>
-
-    <string name="AndMoreTyping_zero">and %1$d more people are typing</string>
-    <string name="AndMoreTyping_one">and %1$d more people are typing</string>
-    <string name="AndMoreTyping_two">and %1$d more people are typing</string>
-    <string name="AndMoreTyping_few">and %1$d more people are typing</string>
-    <string name="AndMoreTyping_many">and %1$d more people are typing</string>
-    <string name="AndMoreTyping_other">and %1$d more people are typing</string>
-
-    <string name="NewMessages_zero">no new messages</string>
-    <string name="NewMessages_one">%1$d new message</string>
-    <string name="NewMessages_two">%1$d new messages</string>
-    <string name="NewMessages_few">%1$d new messages</string>
-    <string name="NewMessages_many">%1$d new messages</string>
-    <string name="NewMessages_other">%1$d new messages</string>
-
-    <string name="messages_zero">no messages</string>
-    <string name="messages_one">%1$d message</string>
-    <string name="messages_two">%1$d messages</string>
-    <string name="messages_few">%1$d messages</string>
-    <string name="messages_many">%1$d messages</string>
-    <string name="messages_other">%1$d messages</string>
-
-    <string name="FromContacts_zero">from no contacts</string>
-    <string name="FromContacts_one">from %1$d contact</string>
-    <string name="FromContacts_two">from %1$d contacts</string>
-    <string name="FromContacts_few">from %1$d contacts</string>
-    <string name="FromContacts_many">from %1$d contacts</string>
-    <string name="FromContacts_other">from %1$d contacts</string>
-
+    <string name="Members_zero">sem membros</string>
+    <string name="Members_one">%1$d membro</string>
+    <string name="Members_two">%1$d membros</string>
+    <string name="Members_few">%1$d membros</string>
+    <string name="Members_many">%1$d membros</string>
+    <string name="Members_other">%1$d membros</string>
+    <string name="AndMoreTyping_zero">e mais %1$d pessoas esto escrevendo</string>
+    <string name="AndMoreTyping_one">e mais %1$d pessoa est escrevendo</string>
+    <string name="AndMoreTyping_two">e mais %1$d pessoas esto escrevendo</string>
+    <string name="AndMoreTyping_few">e mais %1$d pessoas esto escrevendo</string>
+    <string name="AndMoreTyping_many">e mais %1$d pessoas esto escrevendo</string>
+    <string name="AndMoreTyping_other">e mais %1$d pessoas esto escrevendo</string>
+    <string name="NewMessages_zero">sem novas mensagens</string>
+    <string name="NewMessages_one">%1$d nova mensagem</string>
+    <string name="NewMessages_two">%1$d novas mensagens</string>
+    <string name="NewMessages_few">%1$d novas mensagens</string>
+    <string name="NewMessages_many">%1$d novas mensagens</string>
+    <string name="NewMessages_other">%1$d novas mensagens</string>
+    <string name="messages_zero">sem mensagens</string>
+    <string name="messages_one">%1$d mensagem</string>
+    <string name="messages_two">%1$d mensagens</string>
+    <string name="messages_few">%1$d mensagens</string>
+    <string name="messages_many">%1$d mensagens</string>
+    <string name="messages_other">%1$d mensagens</string>
+    <string name="FromContacts_zero">de nenhum contato</string>
+    <string name="FromContacts_one">de %1$d contato</string>
+    <string name="FromContacts_two">de %1$d contatos</string>
+    <string name="FromContacts_few">de %1$d contatos</string>
+    <string name="FromContacts_many">de %1$d contatos</string>
+    <string name="FromContacts_other">de %1$d contatos</string>
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values/attrs.xml b/TMessagesProj/src/main/res/values/attrs.xml
deleted file mode 100755
index ff6bf60df..000000000
--- a/TMessagesProj/src/main/res/values/attrs.xml
+++ /dev/null
@@ -1,18 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<resources>
-
-    <declare-styleable name="PagerSlidingTabStrip">
-        <attr name="indicatorColor" format="color" />
-        <attr name="underlineColor" format="color" />
-        <attr name="dividerColor" format="color" />
-        <attr name="indicatorHeight" format="dimension" />
-        <attr name="underlineHeight" format="dimension" />
-        <attr name="dividerPadding1" format="dimension" />
-        <attr name="tabPaddingLeftRight" format="dimension" />
-        <attr name="scrollOffset" format="dimension" />
-        <attr name="tabBackground" format="reference" />
-        <attr name="shouldExpand" format="boolean" />
-        <attr name="textAllCaps1" format="boolean" />
-    </declare-styleable>
-
-</resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values/strings.xml b/TMessagesProj/src/main/res/values/strings.xml
index 5ed449f2b..b6c2da0d2 100644
--- a/TMessagesProj/src/main/res/values/strings.xml
+++ b/TMessagesProj/src/main/res/values/strings.xml
@@ -4,17 +4,14 @@
 
 <resources>
     <string name="AppName">Telegram</string>
-
     <string name="LanguageName">English</string>
     <string name="LanguageNameInEnglish">English</string>
     <string name="LanguageCode">en</string>
-
     <!--signin view-->
     <string name="YourPhone">Your phone</string>
     <string name="StartText">Please confirm your country code\nand enter your phone number.</string>
     <string name="ChooseCountry">Choose a country</string>
     <string name="WrongCountry">Wrong country code</string>
-
     <!--code enter view-->
     <string name="YourCode">Your code</string>
     <string name="SentSmsCode">We\'ve sent an SMS with an activation code to your phone</string>
@@ -23,7 +20,6 @@
     <string name="Code">Code</string>
     <string name="WrongNumber">Wrong number?</string>
     <string name="DidNotGetTheCode">Didn\'t get the code?</string>
-
     <!--signup view-->
     <string name="YourName">Your name</string>
     <string name="RegisterText">Set up your first and last name</string>
@@ -31,7 +27,6 @@
     <string name="FirstName">First name (required)</string>
     <string name="LastName">Last name (optional)</string>
     <string name="CancelRegistration">Cancel registration</string>
-
     <!--chats view-->
     <string name="Chats">Chats</string>
     <string name="Search">Search</string>
@@ -42,7 +37,7 @@
     <string name="Yesterday">yesterday</string>
     <string name="NoResult">No results</string>
     <string name="NoChats">No chats yet...</string>
-    <string name="NoChatsHelp">Start messaging by pressing the\ncompose button in the top right corner\nor go to the Contacts section.</string>
+    <string name="NoChatsHelp">Start messaging by pressing the\ncompose button in the top right corner\nor tap the menu button for more options.</string>
     <string name="WaitingForNetwork">Waiting for network...</string>
     <string name="Connecting">Connecting...</string>
     <string name="Updating">Updating...</string>
@@ -56,7 +51,6 @@
     <string name="DeleteChat">Delete and exit</string>
     <string name="HiddenName">Hidden Name</string>
     <string name="SelectChat">Select Chat</string>
-
     <!--broadcasts-->
     <string name="BroadcastList">Broadcast List</string>
     <string name="NewBroadcastList">New Broadcast List</string>
@@ -64,7 +58,6 @@
     <string name="YouCreatedBroadcastList">You created a broadcast list</string>
     <string name="AddRecipient">Add Recipient</string>
     <string name="KickFromBroadcast">Remove from broadcast list</string>
-
     <!--documents view-->
     <string name="SelectFile">Select File</string>
     <string name="FreeOfTotal">Free %1$s of %2$s</string>
@@ -78,7 +71,6 @@
     <string name="ExternalStorage">External Storage</string>
     <string name="SystemRoot">System Root</string>
     <string name="SdCard">SD Card</string>
-
     <!--chat view-->
     <string name="Invisible">invisible</string>
     <string name="Typing">typing...</string>
@@ -119,7 +111,6 @@
     <string name="SaveToDownloads">Save to downloads</string>
     <string name="ApplyLocalizationFile">Apply localization file</string>
     <string name="UnsupportedAttachment">Unsupported attachment</string>
-
     <!--notification-->
     <string name="EncryptedChatRequested">Secret chat requested</string>
     <string name="EncryptedChatAccepted">Secret chat started</string>
@@ -161,7 +152,6 @@
     <string name="NotificationUnrecognizedDevice">%1$s,\nWe detected a login into your account from a new device on %2$s\n\nDevice: %3$s\nLocation: %4$s\n\nIf this wasn\'t you, you can go to Settings - Terminate all sessions.\n\nSincerely,\nThe Telegram Team</string>
     <string name="NotificationContactNewPhoto">%1$s updated profile photo</string>
     <string name="Reply">Reply</string>
-
     <!--contacts view-->
     <string name="SelectContact">Select Contact</string>
     <string name="NoContacts">No contacts yet</string>
@@ -174,14 +164,12 @@
     <string name="LastSeen">last seen</string>
     <string name="LastSeenDate">last seen</string>
     <string name="InviteFriends">Invite Friends</string>
-
     <!--group create view-->
     <string name="SendMessageTo">Send message to...</string>
     <string name="EnterGroupNamePlaceholder">Enter group name</string>
     <string name="GroupName">Group name</string>
     <string name="AllContacts">ALL CONTACTS</string>
     <string name="MembersCount">%1$d/%2$d members</string>
-
     <!--group info view-->
     <string name="EnterGroupNameTitle">ENTER GROUP NAME</string>
     <string name="SharedMedia">Shared Media</string>
@@ -192,7 +180,6 @@
     <string name="DeleteAndExit">Delete and leave group</string>
     <string name="Notifications">Notifications</string>
     <string name="KickFromGroup">Remove from group</string>
-
     <!--contact info view-->
     <string name="ShareContact">Share</string>
     <string name="AddContact">Add</string>
@@ -220,7 +207,6 @@
     <string name="ShortMessageLifetime1d">1d</string>
     <string name="ShortMessageLifetime1w">1w</string>
     <string name="EncryptionKeyDescription">This image is a visualization of the encryption key for this secret chat with <![CDATA[<b>]]>%1$s<![CDATA[</b>]]>.<![CDATA[<br><br>]]>If this image looks the same on <![CDATA[<b>]]>%2$s\'s<![CDATA[</b>]]> phone, your chat is 200%% secure.<![CDATA[<br><br>]]>Learn more at telegram.org</string>
-
     <!--settings view-->
     <string name="ResetNotificationsText">Reset all notification settings to default</string>
     <string name="TextSize">Messages Text Size</string>
@@ -260,7 +246,7 @@
     <string name="ContactJoined">Contact joined Telegram</string>
     <string name="Pebble">PEBBLE</string>
     <string name="Language">Language</string>
-    <string name="AskAQuestionInfo">Please note that Telegram Support is done by volunteers. We try to respond as quickly as possible, but it may take a while.<![CDATA[<br><br>]]>Please take a look at the <![CDATA[<a href="http://telegram.org/faq#general">Telegram FAQ</a>]]>: it has answers to most questions and important tips for <![CDATA[<a href="http://telegram.org/faq#troubleshooting">troubleshooting</a>]]>.</string>
+    <string name="AskAQuestionInfo">Please note that Telegram Support is done by volunteers. We try to respond as quickly as possible, but it may take a while.<![CDATA[<br><br>]]>Please take a look at the <![CDATA[<a href=\"http://telegram.org/faq#general\">Telegram FAQ</a>]]>: it has answers to most questions and important tips for <![CDATA[<a href=\"http://telegram.org/faq#troubleshooting\">troubleshooting</a>]]>.</string>
     <string name="AskButton">Ask a volunteer</string>
     <string name="TelegramFaq">Telegram FAQ</string>
     <string name="TelegramFaqUrl">https://telegram.org/faq</string>
@@ -278,8 +264,8 @@
     <string name="LedColor">LED Color</string>
     <string name="PopupNotification">Popup Notifications</string>
     <string name="NoPopup">No popup</string>
-    <string name="OnlyWhenScreenOn">Only when screen "on"</string>
-    <string name="OnlyWhenScreenOff">Only when screen "off"</string>
+    <string name="OnlyWhenScreenOn">Only when screen \"on\"</string>
+    <string name="OnlyWhenScreenOff">Only when screen \"off\"</string>
     <string name="AlwaysShowPopup">Always show popup</string>
     <string name="BadgeNumber">Badge Counter</string>
     <string name="Short">Short</string>
@@ -291,11 +277,10 @@
     <string name="WhenConnectedOnWiFi">When connected on Wi-Fi</string>
     <string name="WhenRoaming">When roaming</string>
     <string name="NoMediaAutoDownload">No media</string>
-
+    <string name="SaveToGallerySettings">Save to gallery</string>
     <!--media view-->
     <string name="NoMedia">No shared media yet</string>
     <string name="CancelDownload">Cancel Download</string>
-
     <!--map view-->
     <string name="MyLocation">My location</string>
     <string name="Map">Map</string>
@@ -305,7 +290,6 @@
     <string name="KMetersAway">km away</string>
     <string name="SendLocation">Send Location</string>
     <string name="ShareLocation">Share Location</string>
-
     <!--photo gallery view-->
     <string name="ShowAllMedia">Show all media</string>
     <string name="SaveToGallery">Save to gallery</string>
@@ -313,12 +297,12 @@
     <string name="Gallery">Gallery</string>
     <string name="AllPhotos">All Photos</string>
     <string name="NoPhotos">No photos yet</string>
-
     <!--edit video view-->
     <string name="EditVideo">Edit Video</string>
     <string name="OriginalVideo">Original Video</string>
     <string name="EditedVideo">Edited Video</string>
-
+    <string name="SendingVideo">Sending video...</string>
+    <string name="CompressVideo">Compress Video</string>
     <!--button titles-->
     <string name="Next">Next</string>
     <string name="Back">Back</string>
@@ -341,7 +325,6 @@
     <string name="OpenPhoto">Open photo</string>
     <string name="Set">Set</string>
     <string name="OK">OK</string>
-
     <!--messages-->
     <string name="ActionKickUser">un1 removed un2</string>
     <string name="ActionLeftUser">un1 left group</string>
@@ -369,7 +352,6 @@
     <string name="FromYou">You</string>
     <string name="ActionTakeScreenshootYou">You took a screenshot!</string>
     <string name="ActionTakeScreenshoot">un1 took a screenshot!</string>
-
     <!--Alert messages-->
     <string name="InvalidPhoneNumber">Invalid phone number</string>
     <string name="CodeExpired">Code expired, please login again</string>
@@ -398,7 +380,6 @@
     <string name="AreYouSureDeleteContact">Are you sure you want to delete this contact?</string>
     <string name="AreYouSureSecretChat">Are you sure you want to start a secret chat?</string>
     <string name="ForwardFromMyName">forward from my name</string>
-
     <!--Intro view-->
     <string name="Page1Title">Telegram</string>
     <string name="Page2Title">Fast</string>
@@ -407,15 +388,14 @@
     <string name="Page5Title">Powerful</string>
     <string name="Page6Title">Cloud-Based</string>
     <string name="Page7Title">Private</string>
-    <string name="Page1Message">Welcome to the era of fast and secure messaging</string>
-    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> delivers messages faster than<![CDATA[<br/>]]>any other application</string>
-    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> is free forever. No ads.<![CDATA[<br/>]]>No subscription fees</string>
-    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> keeps your messages safe<![CDATA[<br/>]]>from hacker attacks</string>
-    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> has no limits on the size of<![CDATA[<br/>]]>your media and chats</string>
-    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> lets you access your messages<![CDATA[<br/>]]>from multiple devices</string>
-    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> messages are heavily encrypted<![CDATA[<br/>]]>and can self-destruct</string>
+    <string name="Page1Message">The world\'s <![CDATA[<b>fastest</b>]]> messaging app.<![CDATA[<br/>]]>It is <![CDATA[<b>free</b>]]> and <![CDATA[<b>secure</b>]]>.</string>
+    <string name="Page2Message"><![CDATA[<b>Telegram</b>]]> delivers messages faster than<![CDATA[<br/>]]>any other application.</string>
+    <string name="Page3Message"><![CDATA[<b>Telegram</b>]]> is free forever. No ads.<![CDATA[<br/>]]>No subscription fees.</string>
+    <string name="Page4Message"><![CDATA[<b>Telegram</b>]]> keeps your messages safe<![CDATA[<br/>]]>from hacker attacks.</string>
+    <string name="Page5Message"><![CDATA[<b>Telegram</b>]]> has no limits on the size of<![CDATA[<br/>]]>your media and chats.</string>
+    <string name="Page6Message"><![CDATA[<b>Telegram</b>]]> lets you access your messages<![CDATA[<br/>]]>from multiple devices.</string>
+    <string name="Page7Message"><![CDATA[<b>Telegram</b>]]> messages are heavily encrypted<![CDATA[<br/>]]>and can self-destruct.</string>
     <string name="StartMessaging">Start Messaging</string>
-
     <!--plurals-->
     <string name="Members_zero">no members</string>
     <string name="Members_one">%1$d member</string>
@@ -447,7 +427,6 @@
     <string name="FromContacts_few">from %1$d contacts</string>
     <string name="FromContacts_many">from %1$d contacts</string>
     <string name="FromContacts_other">from %1$d contacts</string>
-
     <!--Don't change this! Not for localization!-->
     <string name="CacheTag">CACHE_TAG</string>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values/styles.xml b/TMessagesProj/src/main/res/values/styles.xml
index 247018e30..a6dcf0b96 100644
--- a/TMessagesProj/src/main/res/values/styles.xml
+++ b/TMessagesProj/src/main/res/values/styles.xml
@@ -21,7 +21,7 @@
         <item name="android:listViewStyle">@style/Theme.TMessages.ListView</item>
         <item name="android:listChoiceBackgroundIndicator">@drawable/list_selector</item>
         <item name="android:editTextStyle">@style/Theme.TMessages.EditText</item>
-        <item name="android:actionBarItemBackground">@drawable/bar_selector</item>
+        <item name="android:actionBarItemBackground">@drawable/bar_selector_style</item>
     </style>
 
     <style name="Theme.TMessages.PopupNotification" parent="Theme.TMessages">
