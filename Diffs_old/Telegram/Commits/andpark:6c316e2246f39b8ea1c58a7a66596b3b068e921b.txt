diff --git a/TMessagesProj/build.gradle b/TMessagesProj/build.gradle
index 1c6c40522..c8c128a30 100644
--- a/TMessagesProj/build.gradle
+++ b/TMessagesProj/build.gradle
@@ -26,7 +26,6 @@ dependencies {
 android {
     compileSdkVersion 21
     buildToolsVersion '21.1.1'
-
     signingConfigs {
         debug {
             storeFile file("config/debug.keystore")
@@ -39,7 +38,6 @@ android {
             keyPassword RELEASE_KEY_PASSWORD
         }
     }
-
     buildTypes {
         debug {
             debuggable true
@@ -59,28 +57,31 @@ android {
             signingConfig signingConfigs.release
         }
     }
-
     sourceSets.main {
         jniLibs.srcDir 'libs'
         jni.srcDirs = [] //disable automatic ndk-build call
     }
-
     sourceSets.debug {
         manifest.srcFile 'config/debug/AndroidManifest.xml'
     }
-
     sourceSets.release {
         manifest.srcFile 'config/release/AndroidManifest.xml'
     }
-
     sourceSets.foss {
         manifest.srcFile 'config/foss/AndroidManifest.xml'
     }
-
+    lintOptions {
+        checkReleaseBuilds false
+        // Or, if you prefer, you can continue to check for errors in release builds,
+        // but continue the build even when errors are found:
+        abortOnError false
+    }
     defaultConfig {
         minSdkVersion 11
         targetSdkVersion 21
-        versionCode 7
-        versionName "1.2"
+        versionCode 8
+        versionName '1.3'
+    }
+    productFlavors {
     }
 }
diff --git a/TMessagesProj/src/main/AndroidManifest.xml b/TMessagesProj/src/main/AndroidManifest.xml
index f4f35734b..3989427f3 100644
--- a/TMessagesProj/src/main/AndroidManifest.xml
+++ b/TMessagesProj/src/main/AndroidManifest.xml
@@ -1,25 +1,40 @@
 <?xml version="1.0" encoding="utf-8"?>
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
     package="org.telegram.messenger.phonethemeshop"
-    android:installLocation="auto">
+    android:installLocation="auto" >
 
     <permission android:name="com.teamjihu.theme.telegram.v1" />
     <permission android:name="com.teamjihu.emoticon.telegram.v2" />
 
-    <supports-screens android:anyDensity="true"
-        android:smallScreens="true"
-        android:normalScreens="true"
+    <supports-screens
+        android:anyDensity="true"
         android:largeScreens="true"
+        android:normalScreens="true"
         android:resizeable="true"
-        android:xlargeScreens="true"/>
-
-    <uses-feature android:glEsVersion="0x00020000" android:required="true"/>
-    <uses-feature android:name="android.hardware.telephony" android:required="false" />
-    <uses-feature android:name="android.hardware.camera.autofocus" android:required="false" />
-    <uses-feature android:name="android.hardware.camera" android:required="false" />
-    <uses-feature android:name="android.hardware.wifi" android:required="false" />
-    <uses-feature android:name="android.hardware.screen.PORTRAIT" android:required="false" />
-    <uses-feature android:name="android.hardware.microphone" android:required="false" />
+        android:smallScreens="true"
+        android:xlargeScreens="true" />
+
+    <uses-feature
+        android:glEsVersion="0x00020000"
+        android:required="true" />
+    <uses-feature
+        android:name="android.hardware.telephony"
+        android:required="false" />
+    <uses-feature
+        android:name="android.hardware.camera.autofocus"
+        android:required="false" />
+    <uses-feature
+        android:name="android.hardware.camera"
+        android:required="false" />
+    <uses-feature
+        android:name="android.hardware.wifi"
+        android:required="false" />
+    <uses-feature
+        android:name="android.hardware.screen.PORTRAIT"
+        android:required="false" />
+    <uses-feature
+        android:name="android.hardware.microphone"
+        android:required="false" />
 
     <uses-permission android:name="android.permission.INTERNET" />
     <uses-permission android:name="android.permission.RECORD_AUDIO" />
@@ -27,145 +42,200 @@
     <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
     <uses-permission android:name="android.permission.RECEIVE_SMS" />
     <uses-permission android:name="android.permission.WAKE_LOCK" />
-    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
-    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
+    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
+    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
     <uses-permission android:name="android.permission.CAMERA" />
     <uses-permission android:name="android.permission.GET_ACCOUNTS" />
     <uses-permission android:name="android.permission.READ_CONTACTS" />
     <uses-permission android:name="android.permission.WRITE_CONTACTS" />
-    <uses-permission android:name="android.permission.MANAGE_ACCOUNTS"/>
-    <uses-permission android:name="android.permission.READ_PROFILE"/>
-    <uses-permission android:name="android.permission.WRITE_SYNC_SETTINGS"/>
-    <uses-permission android:name="android.permission.READ_SYNC_SETTINGS"/>
-    <uses-permission android:name="android.permission.AUTHENTICATE_ACCOUNTS"/>
+    <uses-permission android:name="android.permission.MANAGE_ACCOUNTS" />
+    <uses-permission android:name="android.permission.READ_PROFILE" />
+    <uses-permission android:name="android.permission.WRITE_SYNC_SETTINGS" />
+    <uses-permission android:name="android.permission.READ_SYNC_SETTINGS" />
+    <uses-permission android:name="android.permission.AUTHENTICATE_ACCOUNTS" />
     <uses-permission android:name="android.permission.VIBRATE" />
     <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
     <uses-permission android:name="android.permission.READ_PHONE_STATE" />
     <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
 
     <permission android:name="org.telegram.messenger.phonethemeshop.permission.MAPS_RECEIVE" />
-    <uses-permission android:name="com.google.android.providers.gsf.permission.READ_GSERVICES"/>
+
+    <uses-permission android:name="com.google.android.providers.gsf.permission.READ_GSERVICES" />
     <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
     <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
 
-
     <application
+        android:name="org.telegram.ui.ApplicationLoader"
         android:allowBackup="false"
+        android:hardwareAccelerated="true"
         android:icon="@drawable/ic_launcher"
         android:label="@string/AppName"
-        android:theme="@style/Theme.TMessages.Start"
-        android:name="org.telegram.ui.ApplicationLoader"
-        android:hardwareAccelerated="true"
-        android:largeHeap="true">
-
+        android:largeHeap="true"
+        android:theme="@style/Theme.TMessages.Start" >
         <activity
             android:name="org.telegram.ui.LaunchActivity"
-            android:windowSoftInputMode="adjustPan"
+            android:configChanges="keyboard|keyboardHidden|orientation|screenSize"
             android:hardwareAccelerated="true"
             android:launchMode="singleTask"
-            android:configChanges="keyboard|keyboardHidden|orientation|screenSize">
+            android:windowSoftInputMode="adjustPan" >
             <intent-filter>
                 <action android:name="android.intent.action.MAIN" />
+
                 <category android:name="android.intent.category.LAUNCHER" />
                 <category android:name="android.intent.category.MULTIWINDOW_LAUNCHER" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="image/*"/>
+                <action android:name="android.intent.action.SEND" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="image/*" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="video/*"/>
+                <action android:name="android.intent.action.SEND" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="video/*" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND_MULTIPLE"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="image/*"/>
+                <action android:name="android.intent.action.SEND_MULTIPLE" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="image/*" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="text/plain"/>
+                <action android:name="android.intent.action.SEND" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="text/plain" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="*/*"/>
+                <action android:name="android.intent.action.SEND" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="*/*" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.SEND_MULTIPLE"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="*/*"/>
+                <action android:name="android.intent.action.SEND_MULTIPLE" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="*/*" />
             </intent-filter>
             <intent-filter>
-                <action android:name="android.intent.action.VIEW"/>
-                <category android:name="android.intent.category.DEFAULT"/>
-                <data android:mimeType="vnd.android.cursor.item/vnd.org.telegram.messenger.android.profile"/>
+                <action android:name="android.intent.action.VIEW" />
+
+                <category android:name="android.intent.category.DEFAULT" />
+
+                <data android:mimeType="vnd.android.cursor.item/vnd.org.telegram.messenger.android.profile" />
             </intent-filter>
         </activity>
         <activity
             android:name="org.telegram.ui.IntroActivity"
-            android:configChanges="keyboard|keyboardHidden|orientation|screenSize">
+            android:configChanges="keyboard|keyboardHidden|orientation|screenSize" >
         </activity>
         <activity
             android:name="org.telegram.ui.PopupNotificationActivity"
             android:configChanges="keyboard|keyboardHidden|navigation|orientation|screenLayout|uiMode|screenSize|smallestScreenSize"
             android:excludeFromRecents="true"
             android:launchMode="singleTask"
-            android:windowSoftInputMode="adjustResize|stateHidden"
             android:taskAffinity=""
-            android:theme="@style/Theme.TMessages.PopupNotification">
+            android:theme="@style/Theme.TMessages.PopupNotification"
+            android:windowSoftInputMode="adjustResize|stateHidden" >
         </activity>
 
-        <receiver android:name="org.telegram.android.SmsListener">
+        <receiver android:name="org.telegram.android.SmsListener" >
             <intent-filter>
                 <action android:name="android.provider.Telephony.SMS_RECEIVED" />
             </intent-filter>
         </receiver>
 
-        <service android:name="org.telegram.android.AuthenticatorService"
-            android:exported="true">
+        <service
+            android:name="org.telegram.android.AuthenticatorService"
+            android:exported="true" >
             <intent-filter>
-                <action android:name="android.accounts.AccountAuthenticator"/>
+                <action android:name="android.accounts.AccountAuthenticator" />
             </intent-filter>
-            <meta-data android:name="android.accounts.AccountAuthenticator"
-                android:resource="@xml/auth"/>
-        </service>
 
-        <service android:name="org.telegram.android.ContactsSyncAdapterService"
-            android:exported="true">
+            <meta-data
+                android:name="android.accounts.AccountAuthenticator"
+                android:resource="@xml/auth" />
+        </service>
+        <service
+            android:name="org.telegram.android.ContactsSyncAdapterService"
+            android:exported="true" >
             <intent-filter>
                 <action android:name="android.content.SyncAdapter" />
             </intent-filter>
-            <meta-data android:name="android.content.SyncAdapter"
+
+            <meta-data
+                android:name="android.content.SyncAdapter"
                 android:resource="@xml/sync_contacts" />
-            <meta-data android:name="android.provider.CONTACTS_STRUCTURE"
+            <meta-data
+                android:name="android.provider.CONTACTS_STRUCTURE"
                 android:resource="@xml/contacts" />
         </service>
-
-        <service android:name="org.telegram.android.NotificationsService" android:enabled="true"/>
-        <service android:name="org.telegram.android.NotificationRepeat" android:exported="false"/>
-        <service android:name="org.telegram.android.VideoEncodingService" android:enabled="true"/>
-
-        <receiver android:name="org.telegram.android.AppStartReceiver" android:enabled="true">
+        <service
+            android:name="org.telegram.android.NotificationsService"
+            android:enabled="true" />
+        <service
+            android:name="org.telegram.android.NotificationRepeat"
+            android:exported="false" />
+        <service
+            android:name="org.telegram.android.VideoEncodingService"
+            android:enabled="true" />
+
+        <receiver
+            android:name="org.telegram.android.AppStartReceiver"
+            android:enabled="true" >
             <intent-filter>
                 <action android:name="org.telegram.start" />
                 <action android:name="android.intent.action.BOOT_COMPLETED" />
             </intent-filter>
         </receiver>
+        <receiver
+            android:name="org.telegram.android.WearReplyReceiver"
+            android:enabled="true" />
+
+        <uses-library
+            android:name="com.sec.android.app.multiwindow"
+            android:required="false" />
+
+        <meta-data
+            android:name="com.sec.android.support.multiwindow"
+            android:value="true" />
+        <meta-data
+            android:name="com.sec.android.multiwindow.DEFAULT_SIZE_W"
+            android:value="632dp" />
+        <meta-data
+            android:name="com.sec.android.multiwindow.DEFAULT_SIZE_H"
+            android:value="598dp" />
+        <meta-data
+            android:name="com.sec.android.multiwindow.MINIMUM_SIZE_W"
+            android:value="632dp" />
+        <meta-data
+            android:name="com.sec.android.multiwindow.MINIMUM_SIZE_H"
+            android:value="598dp" />
+        <meta-data
+            android:name="com.google.android.maps.v2.API_KEY"
+            android:value="@string/googleMapKey" />
 
-        <receiver android:name="org.telegram.android.WearReplyReceiver" android:enabled="true"/>
-
-        <uses-library android:name="com.sec.android.app.multiwindow" android:required="false" />
-        <meta-data android:name="com.sec.android.support.multiwindow" android:value="true" />
-        <meta-data android:name="com.sec.android.multiwindow.DEFAULT_SIZE_W" android:value="632dp" />
-        <meta-data android:name="com.sec.android.multiwindow.DEFAULT_SIZE_H" android:value="598dp" />
-        <meta-data android:name="com.sec.android.multiwindow.MINIMUM_SIZE_W" android:value="632dp" />
-        <meta-data android:name="com.sec.android.multiwindow.MINIMUM_SIZE_H" android:value="598dp" />
-
-        <meta-data android:name="com.google.android.maps.v2.API_KEY" android:value="@string/googleMapKey"/>
+        <activity
+            android:name="org.telegram.ui.LockActivity"
+            android:label="@string/title_activity_lock" >
+        </activity>
+        <activity
+            android:name="org.telegram.ui.LockSettingActivity"
+            android:label="@string/title_activity_lock_setting" >
+        </activity>
+        <activity
+            android:name="org.telegram.ui.LockChangePasswordActivity"
+            android:label="@string/title_activity_lock_change_password" >
+        </activity>
     </application>
 
 </manifest>
diff --git a/TMessagesProj/src/main/java/com/teamjihu/LockManager.java b/TMessagesProj/src/main/java/com/teamjihu/LockManager.java
new file mode 100644
index 000000000..7dfd6196c
--- /dev/null
+++ b/TMessagesProj/src/main/java/com/teamjihu/LockManager.java
@@ -0,0 +1,82 @@
+package com.teamjihu;
+
+import android.app.Activity;
+import android.content.SharedPreferences;
+
+import org.telegram.ui.ApplicationLoader;
+
+/**
+ * Created by OOO on 2014-11-29.
+ */
+public class LockManager {
+
+    public static boolean isLocked() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        return preferences.getBoolean("isLocked", false);
+    }
+
+    public static void OnOffToggle() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("isLocked", !isLocked());
+        editor.commit();
+    }
+
+    public static void On() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("isLocked", true);
+        editor.commit();
+    }
+
+    public static void Off() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("isLocked", false);
+        editor.commit();
+    }
+
+    public static boolean isOpened() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        return preferences.getBoolean("isOpened", false);
+    }
+
+    public static void Lock() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("isOpened", false);
+        editor.commit();
+    }
+
+    public static void Unlock() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putBoolean("isOpened", true);
+        editor.commit();
+    }
+
+    private static String getPassword() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        return preferences.getString("password", "0000");
+    }
+
+    public static boolean isCorrectPassword( String password ) {
+        return ( password.equals( getPassword() )) ? true : false;
+    }
+
+    public static void ChangePassword( String password ) {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Locks", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putString("password", password);
+        editor.commit();
+    }
+
+    public static void AllPopupOff() {
+        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Notifications", Activity.MODE_PRIVATE);
+        SharedPreferences.Editor editor = preferences.edit();
+        editor.putInt("popupAll", 0);
+        editor.putInt("popupGroup", 0);
+        editor.commit();
+    }
+
+}
diff --git a/TMessagesProj/src/main/java/org/telegram/android/MediaController.java b/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
index 56179d16d..e1523ab87 100644
--- a/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
+++ b/TMessagesProj/src/main/java/org/telegram/android/MediaController.java
@@ -167,6 +167,7 @@ public PhotoEntry(int bucketId, int imageId, long dateTaken, String path, int or
     public int mobileDataDownloadMask = 0;
     public int wifiDownloadMask = 0;
     public int roamingDownloadMask = 0;
+    public int selectThemeMask = 0;
     private int lastCheckMask = 0;
     private ArrayList<DownloadObject> photoDownloadQueue = new ArrayList<DownloadObject>();
     private ArrayList<DownloadObject> audioDownloadQueue = new ArrayList<DownloadObject>();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBar.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBar.java
index 470fb14e6..da64a0ce1 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBar.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBar.java
@@ -21,6 +21,8 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.phonethemeshop.R;
 
@@ -50,14 +52,18 @@ public boolean canOpenMenu() {
     private boolean showingOverlayTitle;
 
     protected boolean isSearchFieldVisible;
-    protected int itemsBackgroundResourceId;
+    protected int itemsBackgroundResourceId = -1;
+    protected String itemsBackgroundStr = null;
     private boolean isBackOverlayVisible;
     protected BaseFragment parentFragment;
     public ActionBarMenuOnItemClick actionBarMenuOnItemClick;
     private int extraHeight;
 
+    private ThemeManager themeManager;
+
     public ActionBar(Context context) {
         super(context);
+        themeManager = new ThemeManager(context);
         titleFrameLayout = new FrameLayout(context);
         addView(titleFrameLayout);
         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)titleFrameLayout.getLayoutParams();
@@ -185,7 +191,10 @@ private void createBackButtonImage() {
         backButtonImageView = new ImageView(getContext());
         titleFrameLayout.addView(backButtonImageView);
         backButtonImageView.setScaleType(ImageView.ScaleType.CENTER);
-        backButtonImageView.setBackgroundResource(itemsBackgroundResourceId);
+        if ( itemsBackgroundResourceId == -1 )
+            themeManager.setBackgroundDrawable(backButtonImageView, themeManager.getDrawable(itemsBackgroundStr, false));
+        else
+            backButtonImageView.setBackgroundResource(itemsBackgroundResourceId);
         backButtonImageView.setOnClickListener(new OnClickListener() {
             @Override
             public void onClick(View v) {
@@ -221,7 +230,8 @@ private void createSubtitleTextView() {
         subTitleTextView = new TextView(getContext());
         titleFrameLayout.addView(subTitleTextView);
         subTitleTextView.setGravity(Gravity.LEFT);
-        subTitleTextView.setTextColor(0xffd7e8f7);
+        //subTitleTextView.setTextColor(0xffd7e8f7);
+        subTitleTextView.setTextColor(themeManager.getColor("subtitle"));
         subTitleTextView.setSingleLine(true);
         subTitleTextView.setLines(1);
         subTitleTextView.setMaxLines(1);
@@ -265,7 +275,8 @@ private void createTitleTextView() {
         titleTextView.setMaxLines(1);
         titleTextView.setEllipsize(TextUtils.TruncateAt.END);
         titleFrameLayout.addView(titleTextView);
-        titleTextView.setTextColor(0xffffffff);
+        //titleTextView.setTextColor(0xffffffff);
+        titleTextView.setTextColor(themeManager.getColor("title"));
         titleTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"));
     }
 
@@ -485,6 +496,13 @@ public void setItemsBackground(int resourceId) {
         }
     }
 
+    public void setItemsBackground(String str) {
+        itemsBackgroundStr = str;
+        if (backButtonImageView != null) {
+            themeManager.setBackgroundDrawable(backButtonImageView, themeManager.getDrawable(itemsBackgroundStr, false));
+        }
+    }
+
     @Override
     public boolean onTouchEvent(MotionEvent event) {
         super.onTouchEvent(event);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
index d7f38e23a..4254dca33 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
@@ -200,6 +200,8 @@ public void onResume() {
         }
         if (!fragmentsStack.isEmpty()) {
             BaseFragment lastFragment = fragmentsStack.get(fragmentsStack.size() - 1);
+            //if ( lastFragment.getClass().getSimpleName().trim().equals("LockActivity") )
+            //    closeLastFragment(false);
             lastFragment.onResume();
         }
     }
@@ -386,6 +388,10 @@ public boolean onTouchEvent(MotionEvent ev) {
                         setInnerTranslationX(dx);
                     }
                 } else if (ev != null && ev.getPointerId(0) == startedTrackingPointerId && (ev.getAction() == MotionEvent.ACTION_CANCEL || ev.getAction() == MotionEvent.ACTION_UP || ev.getAction() == MotionEvent.ACTION_POINTER_UP)) {
+                    BaseFragment currentFragment = fragmentsStack.get(fragmentsStack.size() - 1);
+                    if (!currentFragment.swipeBackEnabled) {
+                        return false;
+                    }
                     if (velocityTracker == null) {
                         velocityTracker = VelocityTracker.obtain();
                     }
@@ -542,6 +548,10 @@ public boolean presentFragment(BaseFragment fragment, boolean removeLast) {
         return presentFragment(fragment, removeLast, false, true);
     }
 
+    public boolean presentFragment(BaseFragment fragment, boolean removeLast, boolean forceWithoutAnimation ){
+        return presentFragment(fragment, removeLast, forceWithoutAnimation, true);
+    }
+
     public boolean presentFragment(final BaseFragment fragment, final boolean removeLast, boolean forceWithoutAnimation, boolean check) {
         if (checkTransitionAnimation() || delegate != null && check && !delegate.needPresentFragment(fragment, removeLast, forceWithoutAnimation, this) || !fragment.onFragmentCreate()) {
             return false;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
index a2f860971..6a2386a75 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
@@ -16,7 +16,6 @@
 import android.widget.FrameLayout;
 import android.widget.ImageView;
 import android.widget.LinearLayout;
-import android.graphics.drawable.Drawable;
 
 import com.teamjihu.ThemeManager;
 
@@ -55,7 +54,10 @@ public View addItemResource(int id, int resourceId) {
         addView(view);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)view.getLayoutParams();
         layoutParams.height = FrameLayout.LayoutParams.FILL_PARENT;
-        view.setBackgroundResource(parentActionBar.itemsBackgroundResourceId);
+        if ( parentActionBar.itemsBackgroundResourceId == -1 )
+            themeManager.setBackgroundDrawable(view, themeManager.getDrawable(parentActionBar.itemsBackgroundStr, false));
+        else
+            view.setBackgroundResource(parentActionBar.itemsBackgroundResourceId);
         view.setLayoutParams(layoutParams);
         view.setOnClickListener(new OnClickListener() {
             @Override
@@ -67,19 +69,32 @@ public void onClick(View view) {
     }
 
     public ActionBarMenuItem addItem(int id, Drawable drawable) {
-        return addItem(id, 0, parentActionBar.itemsBackgroundResourceId, drawable, AndroidUtilities.dp(48));
+        if ( parentActionBar.itemsBackgroundResourceId == -1 )
+            return addItem(id, 0, parentActionBar.itemsBackgroundStr, drawable, AndroidUtilities.dp(48));
+        else
+            return addItem(id, 0, parentActionBar.itemsBackgroundResourceId, drawable, AndroidUtilities.dp(48));
     }
 
     public ActionBarMenuItem addItem(int id, int icon) {
-        return addItem(id, icon, parentActionBar.itemsBackgroundResourceId);
+        if ( parentActionBar.itemsBackgroundResourceId == -1 )
+            return addItem(id, icon, parentActionBar.itemsBackgroundStr);
+        else
+            return addItem(id, icon, parentActionBar.itemsBackgroundResourceId);
     }
 
     public ActionBarMenuItem addItem(int id, int icon, int backgroundResource) {
         return addItem(id, icon, backgroundResource, null, AndroidUtilities.dp(48));
     }
 
+    public ActionBarMenuItem addItem(int id, int icon, String backgroundStr) {
+        return addItem(id, icon, backgroundStr, null, AndroidUtilities.dp(48));
+    }
+
     public ActionBarMenuItem addItemWithWidth(int id, int icon, int width) {
-        return addItem(id, icon, parentActionBar.itemsBackgroundResourceId, null, width);
+        if ( parentActionBar.itemsBackgroundResourceId == -1 )
+            return addItem(id, icon, parentActionBar.itemsBackgroundStr, null, width);
+        else
+            return addItem(id, icon, parentActionBar.itemsBackgroundResourceId, null, width);
     }
 
     public ActionBarMenuItem addItem(int id, int icon, int backgroundResource, Drawable drawable, int width) {
@@ -114,6 +129,38 @@ public void onClick(View view) {
         return menuItem;
     }
 
+    public ActionBarMenuItem addItem(int id, int icon, String backgroundStr, Drawable drawable, int width) {
+        ActionBarMenuItem menuItem = new ActionBarMenuItem(getContext(), this, backgroundStr);
+        menuItem.setTag(id);
+        menuItem.setScaleType(ImageView.ScaleType.CENTER);
+        if (drawable != null) {
+            menuItem.setImageDrawable(drawable);
+        } else {
+            menuItem.setImageResource(icon);
+        }
+        addView(menuItem);
+        LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)menuItem.getLayoutParams();
+        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = width;
+        menuItem.setLayoutParams(layoutParams);
+        menuItem.setOnClickListener(new OnClickListener() {
+            @Override
+            public void onClick(View view) {
+                ActionBarMenuItem item = (ActionBarMenuItem)view;
+                if (item.hasSubMenu()) {
+                    if (parentActionBar.actionBarMenuOnItemClick.canOpenMenu()) {
+                        item.toggleSubMenu();
+                    }
+                } else if (item.isSearchField()) {
+                    parentActionBar.onSearchFieldVisibilityChanged(item.toggleSearch());
+                } else {
+                    onItemClick((Integer)view.getTag());
+                }
+            }
+        });
+        return menuItem;
+    }
+
     public void hideAllPopupMenus() {
         for (int a = 0; a < getChildCount(); a++) {
             View view = getChildAt(a);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenuItem.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenuItem.java
index ac6143d1b..a47c8371c 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenuItem.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenuItem.java
@@ -30,6 +30,8 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.phonethemeshop.R;
@@ -57,13 +59,28 @@
     private boolean showFromBottom;
     private int menuHeight = AndroidUtilities.dp(16);
 
+    private ThemeManager themeManager;
+
     public ActionBarMenuItem(Context context, ActionBarMenu menu, int background) {
 
         super(context);
+        themeManager = new ThemeManager(context);
         setBackgroundResource(background);
         parentMenu = menu;
     }
 
+    public ActionBarMenuItem(Context context, ActionBarMenu menu, String backgroundStr) {
+        super(context);
+        themeManager = new ThemeManager(context);
+
+        if(android.os.Build.VERSION.SDK_INT < android.os.Build.VERSION_CODES.JELLY_BEAN)
+            setBackgroundDrawable(themeManager.getDrawable(backgroundStr, false));
+        else
+            setBackground(themeManager.getDrawable(backgroundStr, false));
+
+        parentMenu = menu;
+    }
+
     @Override
     public boolean onTouchEvent(MotionEvent event) {
         if (event.getActionMasked() == MotionEvent.ACTION_DOWN) {
@@ -394,7 +411,7 @@ public ActionBarMenuItem setIsSearchField(boolean value) {
         if (value && searchField == null) {
             searchField = new EditText(getContext());
             searchField.setTextSize(18);
-            searchField.setTextColor(0xffffffff);
+            searchField.setTextColor(themeManager.getColor("title"));
             //searchField.setTextColor(themeManager.getColor("title"));
             searchField.setSingleLine(true);
             searchField.setBackgroundResource(R.drawable.search_light_states);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
index 21fd67910..80cace5b7 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
@@ -21,7 +21,6 @@
 
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.phonethemeshop.R;
 
 public class BaseFragment {
     private boolean isFinished = false;
@@ -82,8 +81,7 @@ protected void setParentLayout(ActionBarLayout layout) {
 
                 actionBar = new ActionBar(parentLayout.getContext());
                 actionBar.parentFragment = this;
-                actionBar.setBackgroundResource(R.color.header);
-                actionBar.setItemsBackground(R.drawable.bar_selector);
+                actionBar.setItemsBackground("bar_selector");
                 themeManager.setBackgroundDrawable(actionBar, themeManager.getDrawable("bg_actionbar", false));
             }
         }
@@ -120,7 +118,6 @@ public void onFragmentDestroy() {
     }
 
     public void onResume() {
-
     }
 
     public void onPause() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Adapters/DrawerLayoutAdapter.java b/TMessagesProj/src/main/java/org/telegram/ui/Adapters/DrawerLayoutAdapter.java
index c4fea10e9..bd684b3e0 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Adapters/DrawerLayoutAdapter.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Adapters/DrawerLayoutAdapter.java
@@ -37,12 +37,12 @@ public boolean areAllItemsEnabled() {
 
     @Override
     public boolean isEnabled(int i) {
-        return !(i == 0 || i == 1 || i == 5);
+        return !(i == 0 || i == 1 || i == 6);
     }
 
     @Override
     public int getCount() {
-        return UserConfig.isClientActivated() ? 10 : 0;
+        return UserConfig.isClientActivated() ? 11 : 0;
     }
 
     @Override
@@ -87,14 +87,16 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                 actionCell.setTextAndIcon(LocaleController.getString("NewSecretChat", R.string.NewSecretChat), R.drawable.menu_secret);
             } else if (i == 4) {
                 actionCell.setTextAndIcon(LocaleController.getString("NewBroadcastList", R.string.NewBroadcastList), R.drawable.menu_broadcast);
-            } else if (i == 6) {
-                actionCell.setTextAndIcon(LocaleController.getString("Contacts", R.string.Contacts), R.drawable.menu_contacts);
+            } else if (i == 5) {
+                actionCell.setTextAndIcon(LocaleController.getString("SelectTheme", R.string.SelectTheme), R.drawable.menu_theme);
             } else if (i == 7) {
-                actionCell.setTextAndIcon(LocaleController.getString("InviteFriends", R.string.InviteFriends), R.drawable.menu_invite);
+                actionCell.setTextAndIcon(LocaleController.getString("Contacts", R.string.Contacts), R.drawable.menu_contacts);
             } else if (i == 8) {
-                actionCell.setTextAndIcon(LocaleController.getString("Settings", R.string.Settings), R.drawable.menu_settings);
+                actionCell.setTextAndIcon(LocaleController.getString("InviteFriends", R.string.InviteFriends), R.drawable.menu_invite);
             } else if (i == 9) {
-                actionCell.setTextAndIcon(LocaleController.getString("TelegramFaq", R.string.TelegramFaq), R.drawable.menu_help);
+                actionCell.setTextAndIcon(LocaleController.getString("Settings", R.string.Settings), R.drawable.menu_settings);
+            } else if (i == 10) {
+                actionCell.setTextAndIcon(LocaleController.getString("EvaluateApp", R.string.EvaluateApp), R.drawable.menu_evaluate);
             }
         }
 
@@ -107,7 +109,7 @@ public int getItemViewType(int i) {
             return 0;
         } else if (i == 1) {
             return 1;
-        } else if (i == 5) {
+        } else if (i == 6) {
             return 2;
         }
         return 3;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DrawerProfileCell.java b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DrawerProfileCell.java
index d9f5199fb..efd3b8b09 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Cells/DrawerProfileCell.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Cells/DrawerProfileCell.java
@@ -9,12 +9,15 @@
 package org.telegram.ui.Cells;
 
 import android.content.Context;
+import android.graphics.drawable.Drawable;
 import android.os.Build;
 import android.util.TypedValue;
 import android.view.Gravity;
 import android.widget.FrameLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
@@ -22,15 +25,20 @@
 import org.telegram.ui.Views.AvatarDrawable;
 import org.telegram.ui.Views.BackupImageView;
 
+
 public class DrawerProfileCell extends FrameLayout {
 
     private BackupImageView avatarImageView;
     private TextView nameTextView;
     private TextView phoneTextView;
 
+    private ThemeManager themeManager;
+
     public DrawerProfileCell(Context context) {
         super(context);
-        setBackgroundColor(0xff4c84b5);
+        themeManager = new ThemeManager(context);
+        //setBackgroundColor(0xff4c84b5);
+        themeManager.setBackgroundDrawable(this, themeManager.getDrawable("bg_actionbar", false));
 
         avatarImageView = new BackupImageView(context);
         avatarImageView.imageReceiver.setRoundRadius(AndroidUtilities.dp(32));
@@ -44,7 +52,7 @@ public DrawerProfileCell(Context context) {
         avatarImageView.setLayoutParams(layoutParams);
 
         nameTextView = new TextView(context);
-        nameTextView.setTextColor(0xffffffff);
+        nameTextView.setTextColor(themeManager.getColor("title"));
         nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15);
         nameTextView.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"));
         nameTextView.setLines(1);
@@ -62,7 +70,7 @@ public DrawerProfileCell(Context context) {
         nameTextView.setLayoutParams(layoutParams);
 
         phoneTextView = new TextView(context);
-        phoneTextView.setTextColor(0xffc2e5ff);
+        phoneTextView.setTextColor(themeManager.getColor("subtitle"));
         phoneTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13);
         phoneTextView.setLines(1);
         phoneTextView.setMaxLines(1);
@@ -99,7 +107,11 @@ public void setUser(TLRPC.User user) {
         nameTextView.setText(ContactsController.formatName(user.first_name, user.last_name));
         phoneTextView.setText(PhoneFormat.getInstance().format("+" + user.phone));
         AvatarDrawable avatarDrawable = new AvatarDrawable(user);
-        avatarDrawable.setColor(0xff5c98cd);
+        Drawable bg = themeManager.getDrawable("bg_pressed_actionbar_btn", true);
+        if ( bg == null )
+            avatarDrawable.setColor(0xff5c98cd);
+        else
+            avatarDrawable.setDrawable(bg);
         avatarImageView.setImage(photo, "50_50", avatarDrawable);
     }
 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChangeChatNameActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChangeChatNameActivity.java
index 30d474962..715230f4e 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChangeChatNameActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChangeChatNameActivity.java
@@ -24,10 +24,12 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
-import org.telegram.messenger.TLRPC;
 import org.telegram.android.MessagesController;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.phonethemeshop.R;
 import org.telegram.ui.ActionBar.ActionBar;
 import org.telegram.ui.ActionBar.ActionBarMenu;
@@ -42,6 +44,8 @@
 
     private final static int done_button = 1;
 
+    private ThemeManager themeManager;
+
     public ChangeChatNameActivity(Bundle args) {
         super(args);
     }
@@ -56,8 +60,8 @@ public boolean onFragmentCreate() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("EditName", R.string.EditName));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChangeNameActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChangeNameActivity.java
index b3c9e98fe..ad4920286 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChangeNameActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChangeNameActivity.java
@@ -23,6 +23,8 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLObject;
@@ -46,10 +48,13 @@
 
     private final static int done_button = 1;
 
+    private ThemeManager themeManager;
+
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("EditName", R.string.EditName));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChangeUsernameActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChangeUsernameActivity.java
index 1c390bcdd..587f97ec9 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChangeUsernameActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChangeUsernameActivity.java
@@ -29,6 +29,8 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.android.MessagesController;
@@ -59,10 +61,13 @@
 
     private final static int done_button = 1;
 
+    private ThemeManager themeManager;
+
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("Username", R.string.Username));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
index 91b00efd8..a04acd9e8 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
@@ -17,9 +17,7 @@
 import android.content.pm.ApplicationInfo;
 import android.content.pm.PackageManager;
 import android.content.res.Configuration;
-import android.graphics.Bitmap;
 import android.graphics.Rect;
-import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Build;
@@ -67,6 +65,10 @@
 import org.telegram.messenger.UserConfig;
 import org.telegram.messenger.Utilities;
 import org.telegram.messenger.phonethemeshop.R;
+import org.telegram.ui.ActionBar.ActionBar;
+import org.telegram.ui.ActionBar.ActionBarMenu;
+import org.telegram.ui.ActionBar.ActionBarMenuItem;
+import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.Adapters.BaseFragmentAdapter;
 import org.telegram.ui.AnimationCompat.AnimatorListenerAdapterProxy;
 import org.telegram.ui.AnimationCompat.AnimatorSetProxy;
@@ -78,11 +80,7 @@
 import org.telegram.ui.Cells.ChatContactCell;
 import org.telegram.ui.Cells.ChatMediaCell;
 import org.telegram.ui.Cells.ChatMessageCell;
-import org.telegram.ui.ActionBar.ActionBar;
-import org.telegram.ui.ActionBar.ActionBarMenu;
-import org.telegram.ui.ActionBar.ActionBarMenuItem;
 import org.telegram.ui.Views.AvatarDrawable;
-import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.Views.BackupImageView;
 import org.telegram.ui.Views.ChatActivityEnterView;
 import org.telegram.ui.Views.FrameLayoutFixed;
@@ -114,8 +112,6 @@
     private ZzalListView zzalListView;
     private View timeItem2;
     private TimerDrawable timerDrawable;
-    private ActionBarMenuItem menuItem;
-    private ActionBarMenuItem attachItem;
     private ActionBarMenuItem headerItem;
     private TextView addContactItem;
     private LayoutListView chatListView;
@@ -379,9 +375,6 @@ public void needSendTyping() {
 
             @Override
             public void onAttachButtonHidden() {
-                if (attachItem != null) {
-                    attachItem.setVisibility(View.VISIBLE);
-                }
                 if (headerItem != null) {
                     headerItem.setVisibility(View.INVISIBLE);
                 }
@@ -389,9 +382,6 @@ public void onAttachButtonHidden() {
 
             @Override
             public void onAttachButtonShow() {
-                if (attachItem != null) {
-                    attachItem.setVisibility(View.INVISIBLE);
-                }
                 if (headerItem != null) {
                     headerItem.setVisibility(View.VISIBLE);
                 }
@@ -759,7 +749,8 @@ public void run() {
             });
 
             avatarContainer = new FrameLayoutFixed(getParentActivity());
-            avatarContainer.setBackgroundResource(R.drawable.bar_selector);
+            //avatarContainer.setBackgroundResource(R.drawable.bar_selector);
+            themeManager.setBackgroundDrawable(avatarContainer, themeManager.getDrawable("bar_selector", false));
             avatarContainer.setPadding(AndroidUtilities.dp(8), 0, AndroidUtilities.dp(8), 0);
             actionBar.addView(avatarContainer);
             FrameLayout.LayoutParams layoutParams2 = (FrameLayout.LayoutParams) avatarContainer.getLayoutParams();
@@ -838,7 +829,7 @@ public void onClick(View v) {
             }
 
             nameTextView = new TextView(getParentActivity());
-            nameTextView.setTextColor(0xffffffff);
+            nameTextView.setTextColor(themeManager.getColor("title"));
             nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18);
             nameTextView.setLines(1);
             nameTextView.setMaxLines(1);
@@ -856,7 +847,7 @@ public void onClick(View v) {
             nameTextView.setLayoutParams(layoutParams2);
 
             onlineTextView = new TextView(getParentActivity());
-            onlineTextView.setTextColor(0xffd7e8f7);
+            onlineTextView.setTextColor(themeManager.getColor("subtitle"));
             onlineTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14);
             onlineTextView.setLines(1);
             onlineTextView.setMaxLines(1);
@@ -882,7 +873,7 @@ public void onClick(View v) {
 
             ActionBarMenu menu = actionBar.createMenu();
 
-            headerItem = menu.addItem(0, R.drawable.ic_ab_other);
+            headerItem = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             if (currentUser != null) {
                 addContactItem = headerItem.addSubItem(share_contact, "", 0);
             }
@@ -899,6 +890,10 @@ public void onClick(View v) {
             LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams) headerItem.getLayoutParams();
             layoutParams.rightMargin = AndroidUtilities.dp(-48);
             headerItem.setLayoutParams(layoutParams);
+            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.JELLY_BEAN)
+                headerItem.setImageAlpha(0);
+            else
+                headerItem.setAlpha(0);
             
             SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Notifications", Activity.MODE_PRIVATE);
             int noti = preferences.getInt("notify2_" + dialog_id, 1);
@@ -907,35 +902,13 @@ public void onClick(View v) {
             else
                 menu.addItem(noti_toggle, themeManager.getDrawable("ic_noti_on", false));
 
-            //ActionBarMenuItem item = menu.addItem(chat_menu_attach, R.drawable.ic_ab_attach);
             ActionBarMenuItem item = menu.addItem(1, themeManager.getDrawable("ic_ab_attach", false));
-//            item.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), R.drawable.ic_attach_photo);
-//            item.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery), R.drawable.ic_attach_gallery);
-//            item.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), R.drawable.ic_attach_video);
-//            item.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), R.drawable.ic_ab_doc);
-//            item.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), R.drawable.ic_attach_location);
             item.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), themeManager.getDrawable("ic_attach_photo", false));
             item.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery),themeManager.getDrawable("ic_attach_gallery", false));
             item.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), themeManager.getDrawable("ic_attach_video", false));
             item.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), themeManager.getDrawable("ic_ab_doc", false));
             item.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), themeManager.getDrawable("ic_attach_location", false));
 
-            attachItem = menu.addItem(chat_menu_attach, R.drawable.ic_ab_other);
-            attachItem.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), R.drawable.ic_attach_photo);
-            attachItem.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery), R.drawable.ic_attach_gallery);
-            attachItem.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), R.drawable.ic_attach_video);
-            attachItem.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), R.drawable.ic_ab_doc);
-            attachItem.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), R.drawable.ic_attach_location);
-            attachItem.setVisibility(View.INVISIBLE);
-
-            menuItem = menu.addItem(chat_menu_attach, R.drawable.ic_ab_attach);
-            menuItem.addSubItem(attach_photo, LocaleController.getString("ChatTakePhoto", R.string.ChatTakePhoto), R.drawable.ic_attach_photo);
-            menuItem.addSubItem(attach_gallery, LocaleController.getString("ChatGallery", R.string.ChatGallery), R.drawable.ic_attach_gallery);
-            menuItem.addSubItem(attach_video, LocaleController.getString("ChatVideo", R.string.ChatVideo), R.drawable.ic_attach_video);
-            menuItem.addSubItem(attach_document, LocaleController.getString("ChatDocument", R.string.ChatDocument), R.drawable.ic_ab_doc);
-            menuItem.addSubItem(attach_location, LocaleController.getString("ChatLocation", R.string.ChatLocation), R.drawable.ic_attach_location);
-            menuItem.setShowFromBottom(true);
-            menuItem.setBackgroundDrawable(null);
 
             actionModeViews.clear();
 
@@ -1010,10 +983,10 @@ public boolean onTouch(View v, MotionEvent event) {
             } else {
                 chatListView.setCacheColorHint(0);
                 try {
-                    if (ApplicationLoader.cachedWallpaper != null) {
+                    if ( false ) { //ApplicationLoader.cachedWallpaper != null) {
                         isCustomTheme = selectedBackground != 1000001;
                         ((SizeNotifierRelativeLayout) contentView).setBackgroundImage(ApplicationLoader.cachedWallpaper);
-                    } else {
+                    } else {    //always get background_hd, not use ApplicationLoader.cachedWallpaper
                         if (selectedBackground == 1000001) {
                         //((SizeNotifierRelativeLayout) contentView).setBackgroundImage(R.drawable.background_hd);
                             ((SizeNotifierRelativeLayout) contentView).setBackgroundImage(themeManager.getDrawable("background_hd", false));
@@ -1278,7 +1251,6 @@ public void onClick(DialogInterface dialogInterface, int i) {
 
             chatActivityEnterView.setContainerView(getParentActivity(), fragmentView, ChatActivity.this);
             zzalListView.setContainerView(getParentActivity(), fragmentView, ChatActivity.this);
-            chatActivityEnterView.addToAttachLayout(menuItem);
 
             if (currentEncryptedChat != null) {
                 emptyView.setVisibility(View.INVISIBLE);
@@ -1445,9 +1417,6 @@ private void checkActionBarMenu() {
                 currentChat != null && (currentChat instanceof TLRPC.TL_chatForbidden || currentChat.left) ||
                 currentUser != null && (currentUser instanceof TLRPC.TL_userDeleted || currentUser instanceof TLRPC.TL_userEmpty)) {
 
-            if (menuItem != null) {
-                menuItem.setVisibility(View.GONE);
-            }
             if (timeItem != null) {
                 timeItem.setVisibility(View.GONE);
             }
@@ -1455,9 +1424,6 @@ private void checkActionBarMenu() {
                 timeItem2.setVisibility(View.GONE);
             }
         } else {
-            if (menuItem != null) {
-                menuItem.setVisibility(View.VISIBLE);
-            }
             if (timeItem != null) {
                 timeItem.setVisibility(View.VISIBLE);
             }
@@ -1705,6 +1671,7 @@ private void updateSubtitle() {
                 if (lastStatus == null || lastPrintString != null || lastStatus != null && !lastStatus.equals(newStatus)) {
                     lastStatus = newStatus;
                     onlineTextView.setText(newStatus);
+                    onlineTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 10);
                 }
             }
             lastPrintString = null;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
index 0769033da..e1939bacb 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
@@ -10,9 +10,6 @@
 
 import android.app.Activity;
 import android.content.SharedPreferences;
-import android.graphics.Bitmap;
-import android.graphics.drawable.BitmapDrawable;
-import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.text.InputType;
 import android.text.TextUtils;
@@ -32,19 +29,19 @@
 
 import com.teamjihu.ThemeManager;
 
-import org.telegram.android.AndroidUtilities;
 import org.telegram.PhoneFormat.PhoneFormat;
+import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.LocaleController;
-import org.telegram.messenger.TLRPC;
 import org.telegram.android.MessagesController;
 import org.telegram.android.NotificationCenter;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.phonethemeshop.R;
 import org.telegram.ui.ActionBar.ActionBar;
 import org.telegram.ui.ActionBar.ActionBarMenu;
+import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.Views.AvatarDrawable;
 import org.telegram.ui.Views.BackupImageView;
-import org.telegram.ui.ActionBar.BaseFragment;
 
 public class ContactAddActivity extends BaseFragment implements NotificationCenter.NotificationCenterDelegate {
 
@@ -87,7 +84,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             themeManager = new ThemeManager(getParentActivity());
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             if (addContact) {
                 actionBar.setTitle(LocaleController.getString("AddContactTitle", R.string.AddContactTitle));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LastSeenActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LastSeenActivity.java
index be9809ca5..8b3d82cb7 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LastSeenActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LastSeenActivity.java
@@ -27,6 +27,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.LocaleController;
@@ -70,6 +72,8 @@
 
     private final static int done_button = 1;
 
+    private ThemeManager themeManager;
+
     private static class LinkMovementMethodMy extends LinkMovementMethod {
         @Override
         public boolean onTouchEvent(TextView widget, Spannable buffer, MotionEvent event) {
@@ -100,7 +104,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("PrivacyLastSeen", R.string.PrivacyLastSeen));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LastSeenUsersActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LastSeenUsersActivity.java
index 94fbe176e..63a079bad 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LastSeenUsersActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LastSeenUsersActivity.java
@@ -23,6 +23,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.LocaleController;
 import org.telegram.android.MessagesController;
@@ -55,6 +57,8 @@
 
     private final static int block_user = 1;
 
+    private ThemeManager themeManager;
+
     public LastSeenUsersActivity(ArrayList<Integer> users, boolean always) {
         super();
         uidArray = users;
@@ -77,7 +81,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             if (isAlwaysShare) {
                 actionBar.setTitle(LocaleController.getString("AlwaysShareWithTitle", R.string.AlwaysShareWithTitle));
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
index 9501ff0c3..aede80b11 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
@@ -9,7 +9,10 @@
 package org.telegram.ui;
 
 import android.app.Activity;
+import android.app.AlertDialog;
 import android.content.ContentResolver;
+import android.content.Context;
+import android.content.DialogInterface;
 import android.content.Intent;
 import android.content.SharedPreferences;
 import android.content.pm.PackageInfo;
@@ -20,6 +23,7 @@
 import android.net.Uri;
 import android.os.Build;
 import android.os.Bundle;
+import android.os.Handler;
 import android.os.Parcelable;
 import android.provider.ContactsContract;
 import android.view.ActionMode;
@@ -38,22 +42,24 @@
 import android.widget.RelativeLayout;
 import android.widget.Toast;
 
-import org.telegram.android.AndroidUtilities;
+import com.teamjihu.LockManager;
+
 import org.telegram.PhoneFormat.PhoneFormat;
+import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
+import org.telegram.android.LocaleController;
+import org.telegram.android.NotificationCenter;
 import org.telegram.android.SendMessagesHelper;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
-import org.telegram.android.LocaleController;
-import org.telegram.android.NotificationCenter;
-import org.telegram.messenger.phonethemeshop.R;
 import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.UserConfig;
 import org.telegram.messenger.Utilities;
-import org.telegram.ui.Adapters.DrawerLayoutAdapter;
+import org.telegram.messenger.phonethemeshop.R;
 import org.telegram.ui.ActionBar.ActionBarLayout;
 import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.ActionBar.DrawerLayoutContainer;
+import org.telegram.ui.Adapters.DrawerLayoutAdapter;
 
 import java.io.BufferedReader;
 import java.io.InputStream;
@@ -61,11 +67,6 @@
 import java.util.ArrayList;
 import java.util.Map;
 
-import android.os.Handler;
-import android.app.AlertDialog;
-import android.content.DialogInterface;
-import android.content.Context;
-
 public class LaunchActivity extends Activity implements ActionBarLayout.ActionBarLayoutDelegate, NotificationCenter.NotificationCenterDelegate, MessagesActivity.MessagesActivityDelegate {
     private boolean finished;
     private String videoPath;
@@ -268,10 +269,13 @@ public void onItemClick(AdapterView<?> parent, View view, int position, long id)
                     args.putBoolean("broadcast", true);
                     presentFragment(new GroupCreateActivity(args));
                     drawerLayoutContainer.closeDrawer(false);
-                } else if (position == 6) {
-                    presentFragment(new ContactsActivity(null));
+                } else if (position == 5) {
+                    presentFragment(new SettingsThemeActivity());
                     drawerLayoutContainer.closeDrawer(false);
                 } else if (position == 7) {
+                    presentFragment(new ContactsActivity(null));
+                    drawerLayoutContainer.closeDrawer(false);
+                } else if (position == 8) {
                     try {
                         Intent intent = new Intent(Intent.ACTION_SEND);
                         intent.setType("text/plain");
@@ -281,16 +285,11 @@ public void onItemClick(AdapterView<?> parent, View view, int position, long id)
                         FileLog.e("tmessages", e);
                     }
                     drawerLayoutContainer.closeDrawer(false);
-                } else if (position == 8) {
+                } else if (position == 9) {
                     presentFragment(new SettingsActivity());
                     drawerLayoutContainer.closeDrawer(false);
-                } else if (position == 9) {
-                    try {
-                        Intent pickIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(LocaleController.getString("TelegramFaqUrl", R.string.TelegramFaqUrl)));
-                        startActivity(pickIntent);
-                    } catch (Exception e) {
-                        FileLog.e("tmessages", e);
-                    }
+                } else if (position == 10) {
+                    startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse("market://details?id=org.telegram.messenger.phonethemeshop")));
                     drawerLayoutContainer.closeDrawer(false);
                 }
             }
@@ -981,6 +980,24 @@ public void onClick(DialogInterface dialog, int which) {
                 }
             }, 2000);
         }
+
+        if ( LockManager.isLocked() ) {
+            BaseFragment lastFragment = null;
+            if (AndroidUtilities.isTablet()) {
+                if ( !layersActionBarLayout.fragmentsStack.isEmpty() )
+                    lastFragment = layersActionBarLayout.fragmentsStack.get(layersActionBarLayout.fragmentsStack.size() - 1);
+            } else {
+                if ( !actionBarLayout.fragmentsStack.isEmpty() )
+                    lastFragment = actionBarLayout.fragmentsStack.get(actionBarLayout.fragmentsStack.size() - 1);
+            }
+            if ( lastFragment == null || !lastFragment.getClass().getSimpleName().trim().equals("LockActivity")) {
+                if (drawerLayoutContainer.isDrawerOpened())
+                    drawerLayoutContainer.closeDrawer(true);
+                LockManager.Lock();
+                presentFragment(new LockActivity());
+            } else if (AndroidUtilities.isTablet())
+                layersActionBarLayout.setVisibility(View.VISIBLE);
+        }
     }
 
     @Override
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LockActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LockActivity.java
new file mode 100644
index 000000000..453ea397f
--- /dev/null
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LockActivity.java
@@ -0,0 +1,139 @@
+package org.telegram.ui;
+
+import android.content.Context;
+import android.os.Handler;
+import android.os.Vibrator;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewGroup;
+import android.widget.ImageView;
+import android.widget.TextView;
+
+import com.teamjihu.LockManager;
+import com.teamjihu.ThemeManager;
+
+import org.telegram.android.LocaleController;
+import org.telegram.messenger.phonethemeshop.R;
+import org.telegram.ui.ActionBar.BaseFragment;
+
+import java.util.Timer;
+import java.util.TimerTask;
+
+public class LockActivity extends BaseFragment {
+    private ThemeManager themeManager;
+    private LayoutInflater INFLATER;
+    private TextView txtPasswordComment;
+    private ImageView[] imgCircles = new ImageView[4];
+    private String inputPassword = "";
+    private boolean fromSettingFragment = false;
+
+    public LockActivity() {}
+
+    public LockActivity(boolean _fromSettingFragment) {
+        fromSettingFragment = _fromSettingFragment;
+    }
+
+    @Override
+    public View createView(LayoutInflater inflater, ViewGroup container) {
+        INFLATER = inflater;
+        if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setVisibility(View.GONE);
+            this.swipeBackEnabled = false;
+
+            fragmentView = inflater.inflate(R.layout.lock_layout, container, false);
+
+            txtPasswordComment = (TextView)fragmentView.findViewById(R.id.txtPasswordComment);
+            imgCircles[0] = (ImageView)fragmentView.findViewById(R.id.lock_circle1);
+            imgCircles[1] = (ImageView)fragmentView.findViewById(R.id.lock_circle2);
+            imgCircles[2] = (ImageView)fragmentView.findViewById(R.id.lock_circle3);
+            imgCircles[3] = (ImageView)fragmentView.findViewById(R.id.lock_circle4);
+
+            fragmentView.findViewById(R.id.lock_btn_number1).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number2).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number3).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number4).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number5).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number6).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number7).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number8).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number9).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number0).setOnClickListener(lockBtnNumberOnClickListener);
+
+            fragmentView.findViewById(R.id.lock_btn_del).setOnClickListener(lockBtnDelOnClickListener);
+        } else {
+            ViewGroup parent = (ViewGroup)fragmentView.getParent();
+            if (parent != null) {
+                parent.removeView(fragmentView);
+            }
+        }
+
+        return fragmentView;
+    }
+
+    private void fillCircle( int strLen ) {
+        for ( int i = 0; i < imgCircles.length; i++ ) {
+            if ( i < strLen )
+                imgCircles[i].setImageResource(R.drawable.ic_lock_circle_on);
+            else
+                imgCircles[i].setImageResource(R.drawable.ic_lock_circle_off);
+        }
+    }
+
+    View.OnClickListener lockBtnNumberOnClickListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View view) {
+            if ( inputPassword.length() < 4 ) {
+                inputPassword += view.getTag().toString();
+                fillCircle(inputPassword.length());
+                if (inputPassword.length() == 4) {
+                    final Handler handler = new Handler();
+                    Timer t = new Timer();
+                    t.schedule(new TimerTask() {
+                        public void run() {
+                            handler.post(new Runnable() {
+                                public void run() {
+                                    if (LockManager.isCorrectPassword(inputPassword)) {
+                                        inputPassword = "";
+                                        LockManager.Unlock();
+                                        if ( fromSettingFragment )
+                                            presentFragment(new LockSettingActivity(), true);
+                                        else
+                                            LockActivity.this.finishFragment(false);
+                                    } else {
+                                        inputPassword = "";
+                                        fillCircle(inputPassword.length());
+                                        txtPasswordComment.setText(LocaleController.getString("incorrect_password", R.string.incorrect_password));
+                                        Vibrator vibe = (Vibrator) getParentActivity().getApplicationContext().getSystemService(Context.VIBRATOR_SERVICE);
+                                        vibe.vibrate(500);
+                                    }
+                                }
+                            });
+                        }
+                    }, 300);
+                }
+            }
+        }
+    };
+
+    View.OnClickListener lockBtnDelOnClickListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View view) {
+            if ( inputPassword.length() > 0  && inputPassword.length() < 4) {
+                inputPassword = inputPassword.substring(0, inputPassword.length() - 1);
+                fillCircle(inputPassword.length());
+            }
+        }
+    };
+
+    @Override
+    public void onResume() {
+        fillCircle(inputPassword.length());
+    }
+
+    @Override
+    public boolean onBackPressed() {
+        getParentActivity().finish();
+        return false;
+    }
+}
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LockChangePasswordActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LockChangePasswordActivity.java
new file mode 100644
index 000000000..6f731e616
--- /dev/null
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LockChangePasswordActivity.java
@@ -0,0 +1,138 @@
+package org.telegram.ui;
+
+import android.content.Context;
+import android.os.Handler;
+import android.os.Vibrator;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewGroup;
+import android.widget.ImageView;
+import android.widget.TextView;
+
+import com.teamjihu.LockManager;
+import com.teamjihu.ThemeManager;
+
+import org.telegram.android.LocaleController;
+import org.telegram.messenger.phonethemeshop.R;
+import org.telegram.ui.ActionBar.BaseFragment;
+
+import java.util.Timer;
+import java.util.TimerTask;
+
+public class LockChangePasswordActivity extends BaseFragment {
+    private ThemeManager themeManager;
+    private LayoutInflater INFLATER;
+    private TextView txtPasswordComment;
+    private ImageView[] imgCircles = new ImageView[4];
+    private String inputPassword = "";
+    private String inputPasswordConfirm = "";
+    private boolean fromSettingFragment = false;
+    private LockSettingActivity lockSettingActivity;
+
+    public LockChangePasswordActivity() {}
+
+    public LockChangePasswordActivity( LockSettingActivity _lockSettingActivity ) {
+        lockSettingActivity = _lockSettingActivity;
+    }
+
+    @Override
+    public View createView(LayoutInflater inflater, ViewGroup container) {
+        INFLATER = inflater;
+        if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setVisibility(View.GONE);
+            this.swipeBackEnabled = false;
+
+            fragmentView = inflater.inflate(R.layout.lock_change_password_layout, container, false);
+
+            txtPasswordComment = (TextView)fragmentView.findViewById(R.id.txtPasswordComment);
+            imgCircles[0] = (ImageView)fragmentView.findViewById(R.id.lock_circle1);
+            imgCircles[1] = (ImageView)fragmentView.findViewById(R.id.lock_circle2);
+            imgCircles[2] = (ImageView)fragmentView.findViewById(R.id.lock_circle3);
+            imgCircles[3] = (ImageView)fragmentView.findViewById(R.id.lock_circle4);
+
+            fragmentView.findViewById(R.id.lock_btn_number1).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number2).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number3).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number4).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number5).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number6).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number7).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number8).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number9).setOnClickListener(lockBtnNumberOnClickListener);
+            fragmentView.findViewById(R.id.lock_btn_number0).setOnClickListener(lockBtnNumberOnClickListener);
+
+            fragmentView.findViewById(R.id.lock_btn_del).setOnClickListener(lockBtnDelOnClickListener);
+        } else {
+            ViewGroup parent = (ViewGroup)fragmentView.getParent();
+            if (parent != null) {
+                parent.removeView(fragmentView);
+            }
+        }
+
+        return fragmentView;
+    }
+
+    private void fillCircle( int strLen ) {
+        for ( int i = 0; i < imgCircles.length; i++ ) {
+            if ( i < strLen )
+                imgCircles[i].setImageResource(R.drawable.ic_lock_circle_on);
+            else
+                imgCircles[i].setImageResource(R.drawable.ic_lock_circle_off);
+        }
+    }
+
+    View.OnClickListener lockBtnNumberOnClickListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View view) {
+            if ( inputPassword.length() < 4 ) {
+                inputPassword += view.getTag().toString();
+                fillCircle(inputPassword.length());
+                if (inputPassword.length() == 4) {
+                    final Handler handler = new Handler();
+                    Timer t = new Timer();
+                    t.schedule(new TimerTask() {
+                        public void run() {
+                            handler.post(new Runnable() {
+                                public void run() {
+                                    if (inputPasswordConfirm.equals("")) {
+                                        inputPasswordConfirm = inputPassword;
+                                        inputPassword = "";
+                                        fillCircle(inputPassword.length());
+                                        txtPasswordComment.setText(LocaleController.getString("input_password_to_confirm", R.string.input_password_to_confirm));
+                                    } else if ( !inputPassword.equals(inputPasswordConfirm) ) {
+                                        inputPasswordConfirm = "";
+                                        inputPassword = "";
+                                        fillCircle(inputPassword.length());
+                                        txtPasswordComment.setText(LocaleController.getString("input_password_again", R.string.input_password_again));
+                                        Vibrator vibe = (Vibrator) getParentActivity().getApplicationContext().getSystemService(Context.VIBRATOR_SERVICE);
+                                        vibe.vibrate(500);
+                                    } else {
+                                        lockSettingActivity.checkBox.setChecked( true );
+                                        LockManager.ChangePassword(inputPassword);
+                                        LockManager.On();
+
+                                        //popup off
+                                        LockManager.AllPopupOff();
+
+                                        LockChangePasswordActivity.this.finishFragment(false);
+                                    }
+                                }
+                            });
+                        }
+                    }, 300);
+                }
+            }
+        }
+    };
+
+    View.OnClickListener lockBtnDelOnClickListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View view) {
+            if ( inputPassword.length() > 0  && inputPassword.length() < 4) {
+                inputPassword = inputPassword.substring(0, inputPassword.length() - 1);
+                fillCircle(inputPassword.length());
+            }
+        }
+    };
+}
\ No newline at end of file
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LockSettingActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LockSettingActivity.java
new file mode 100644
index 000000000..b2f3faf5e
--- /dev/null
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LockSettingActivity.java
@@ -0,0 +1,98 @@
+package org.telegram.ui;
+
+import android.view.Gravity;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewGroup;
+import android.widget.FrameLayout;
+import android.widget.TextView;
+
+import com.teamjihu.LockManager;
+import com.teamjihu.ThemeManager;
+
+import org.telegram.android.AndroidUtilities;
+import org.telegram.android.LocaleController;
+import org.telegram.messenger.phonethemeshop.R;
+import org.telegram.ui.ActionBar.ActionBar;
+import org.telegram.ui.ActionBar.BaseFragment;
+import org.telegram.ui.Views.Switch;
+
+public class LockSettingActivity extends BaseFragment {
+    private ThemeManager themeManager;
+    private LayoutInflater INFLATER;
+    private FrameLayout turnOnLockRow;
+    private TextView turnOnLock;
+    private FrameLayout changeLockPasswordRow;
+    private TextView changeLockPassword;
+    private TextView txtLockSettingComment;
+    public Switch checkBox;
+
+    @Override
+    public View createView(LayoutInflater inflater, ViewGroup container) {
+        INFLATER = inflater;
+        if (fragmentView == null) {
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
+            actionBar.setTitle(LocaleController.getString("PasswordLock", R.string.PasswordLock));
+            actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
+                @Override
+                public void onItemClick(int id) {
+                    if (id == -1) {
+                        finishFragment();
+                    }
+                }
+            });
+
+            fragmentView = inflater.inflate(R.layout.lock_setting_activity, container, false);
+
+            turnOnLockRow = (FrameLayout)fragmentView.findViewById(R.id.turnOnLockRow);
+            turnOnLockRow.setOnClickListener( new View.OnClickListener() {
+                @Override
+                public void onClick(View view) {
+                    if ( LockManager.isLocked() ) {
+                        LockManager.Off();
+                        checkBox.setChecked(LockManager.isLocked());
+                    } else {
+                        presentFragment(new LockChangePasswordActivity(LockSettingActivity.this));
+                    }
+                }
+            });
+            changeLockPasswordRow = (FrameLayout)fragmentView.findViewById(R.id.changeLockPasswordRow);
+            changeLockPasswordRow.setOnClickListener( new View.OnClickListener() {
+                @Override
+                public void onClick(View view) {
+                    if ( LockManager.isLocked() )
+                        presentFragment(new LockChangePasswordActivity(LockSettingActivity.this));
+                }
+            });
+            turnOnLock = (TextView)fragmentView.findViewById(R.id.turnOnLock);
+            turnOnLock.setText(LocaleController.getString("TurnOnLock", R.string.TurnOnLock));
+            changeLockPassword = (TextView)fragmentView.findViewById(R.id.changeLockPassword);
+            changeLockPassword.setText(LocaleController.getString("ChangeLockPassword", R.string.ChangeLockPassword));
+            txtLockSettingComment = (TextView)fragmentView.findViewById(R.id.txtLockSettingComment);
+            txtLockSettingComment.setText(LocaleController.getString("use_password_cannot_popup", R.string.use_password_cannot_popup));
+
+            checkBox = new Switch(getParentActivity());
+            checkBox.setDuplicateParentStateEnabled(false);
+            checkBox.setFocusable(false);
+            checkBox.setFocusableInTouchMode(false);
+            checkBox.setClickable(false);
+            ((FrameLayout) fragmentView.findViewById(R.id.turnOnLockRow)).addView(checkBox);
+            FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) checkBox.getLayoutParams();
+            layoutParams.width = FrameLayout.LayoutParams.WRAP_CONTENT;
+            layoutParams.height = FrameLayout.LayoutParams.WRAP_CONTENT;
+            layoutParams.rightMargin = AndroidUtilities.dp(15);
+            layoutParams.gravity = (LocaleController.isRTL ? Gravity.LEFT : Gravity.RIGHT) | Gravity.CENTER_VERTICAL;
+            checkBox.setLayoutParams(layoutParams);
+
+            checkBox.setChecked(LockManager.isLocked());
+        } else {
+            ViewGroup parent = (ViewGroup)fragmentView.getParent();
+            if (parent != null) {
+                parent.removeView(fragmentView);
+            }
+        }
+
+        return fragmentView;
+    }
+}
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
index 0144130d3..3d3788bf4 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
@@ -639,6 +639,9 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
             layoutParams.height = AndroidUtilities.dp(36);
             layoutParams.rightMargin = AndroidUtilities.dp(24);
             phoneField.setLayoutParams(layoutParams);
+
+            phoneField.setText(getPhoneNumber());
+
             phoneField.addTextChangedListener(new TextWatcher() {
                 @Override
                 public void beforeTextChanged(CharSequence s, int start, int count, int after) {
@@ -771,6 +774,19 @@ public int compare(String lhs, String rhs) {
             }
         }
 
+        private String getPhoneNumber() {
+            String phoneNumber = "";
+            TelephonyManager systemService = (TelephonyManager)getContext().getSystemService(getContext().TELEPHONY_SERVICE);
+            phoneNumber = systemService.getLine1Number();
+
+            if ( phoneNumber != null && phoneNumber.length() >= 10 )
+                phoneNumber = phoneNumber.substring(phoneNumber.length() - 10, phoneNumber.length());
+            else
+                phoneNumber = "";
+
+            return phoneNumber;
+        }
+
         public void selectCountry(String name) {
             int index = countriesArray.indexOf(name);
             if (index != -1) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
index 773b38016..291f6d3c9 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
@@ -235,6 +235,7 @@ public void onItemClick(int id) {
             searchWas = false;
 
             fragmentView = inflater.inflate(R.layout.messages_list, container, false);
+            themeManager.setBackgroundDrawable(fragmentView, themeManager.getDrawable("bg_msglistcontainer", false));
 
             dialogsAdapter = new DialogsAdapter(getParentActivity(), serverOnly);
             if (AndroidUtilities.isTablet() && openedDialogId != 0) {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/NotificationsSettingsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/NotificationsSettingsActivity.java
index ada393102..584aa5c4f 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/NotificationsSettingsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/NotificationsSettingsActivity.java
@@ -27,6 +27,7 @@
 import android.widget.ListView;
 import android.widget.Toast;
 
+import com.teamjihu.LockManager;
 import com.teamjihu.ThemeManager;
 
 import org.telegram.android.AndroidUtilities;
@@ -405,12 +406,19 @@ public void onClick(DialogInterface dialog, int which) {
                     } else if (i == messagePopupNotificationRow || i == groupPopupNotificationRow) {
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
                         builder.setTitle(LocaleController.getString("PopupNotification", R.string.PopupNotification));
-                        builder.setItems(new CharSequence[] {
-                                LocaleController.getString("NoPopup", R.string.NoPopup),
-                                LocaleController.getString("OnlyWhenScreenOn", R.string.OnlyWhenScreenOn),
-                                LocaleController.getString("OnlyWhenScreenOff", R.string.OnlyWhenScreenOff),
-                                LocaleController.getString("AlwaysShowPopup", R.string.AlwaysShowPopup)
-                        }, new DialogInterface.OnClickListener() {
+                        CharSequence[] popupMenus;
+                        if (LockManager.isLocked())
+                            popupMenus = new CharSequence[]{
+                                    LocaleController.getString("NoPopup", R.string.NoPopup)
+                            };
+                        else
+                            popupMenus = new CharSequence[]{
+                                    LocaleController.getString("NoPopup", R.string.NoPopup),
+                                    LocaleController.getString("OnlyWhenScreenOn", R.string.OnlyWhenScreenOn),
+                                    LocaleController.getString("OnlyWhenScreenOff", R.string.OnlyWhenScreenOff),
+                                    LocaleController.getString("AlwaysShowPopup", R.string.AlwaysShowPopup)
+                            };
+                        builder.setItems(popupMenus, new DialogInterface.OnClickListener() {
                             @Override
                             public void onClick(DialogInterface dialog, int which) {
                                 SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Notifications", Activity.MODE_PRIVATE);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
index 38d35d45e..b347fad8c 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
@@ -203,9 +203,10 @@ public void onAttachButtonShow() {
 
         actionBar = new ActionBar(this);
         actionBar.setOccupyStatusBar(false);
+        //actionBar.setBackgroundResource(R.color.header);
+        themeManager.setBackgroundDrawable(actionBar, themeManager.getDrawable("bg_actionbar", false));
+        actionBar.setItemsBackground("bar_selector");
         actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
-        actionBar.setBackgroundResource(R.color.header);
-        actionBar.setItemsBackground(R.drawable.bar_selector);
         popupContainer.addView(actionBar);
         ViewGroup.LayoutParams layoutParams = actionBar.getLayoutParams();
         layoutParams.width = ViewGroup.LayoutParams.MATCH_PARENT;
@@ -218,6 +219,7 @@ public void onAttachButtonShow() {
 
         View view = menu.addItemResource(2, R.layout.popup_count_layout);
         countText = (TextView) view.findViewById(R.id.count_text);
+        countText.setTextColor(themeManager.getColor("subtitle"));
 
         avatarContainer = new FrameLayoutFixed(this);
         avatarContainer.setBackgroundResource(R.drawable.bar_selector);
@@ -242,7 +244,7 @@ public void onAttachButtonShow() {
         avatarImageView.setLayoutParams(layoutParams2);
 
         nameTextView = new TextView(this);
-        nameTextView.setTextColor(0xffffffff);
+        nameTextView.setTextColor(themeManager.getColor("title"));
         nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18);
         nameTextView.setLines(1);
         nameTextView.setMaxLines(1);
@@ -260,7 +262,7 @@ public void onAttachButtonShow() {
         nameTextView.setLayoutParams(layoutParams2);
 
         onlineTextView = new TextView(this);
-        onlineTextView.setTextColor(0xffd7e8f7);
+        onlineTextView.setTextColor(themeManager.getColor("subtitle"));
         onlineTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14);
         onlineTextView.setLines(1);
         onlineTextView.setMaxLines(1);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java
index 756ab6382..aa702de6a 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java
@@ -21,6 +21,8 @@
 import android.widget.ListView;
 import android.widget.Toast;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
 import org.telegram.android.LocaleController;
@@ -58,6 +60,8 @@
     private int deleteAccountDetailRow;
     private int rowCount;
 
+    private ThemeManager themeManager;
+
     @Override
     public boolean onFragmentCreate() {
         super.onFragmentCreate();
@@ -90,7 +94,8 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("PrivacySettings", R.string.PrivacySettings));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
index 54d9bd5b5..67e496920 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
@@ -31,6 +31,8 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.ThemeManager;
+
 import org.telegram.PhoneFormat.PhoneFormat;
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.ContactsController;
@@ -120,6 +122,8 @@
     private int membersEndRow;
     private int rowCount = 0;
 
+    private ThemeManager themeManager;
+
     public ProfileActivity(Bundle args) {
         super(args);
     }
@@ -219,9 +223,10 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBar.setBackgroundColor(AvatarDrawable.getProfileBackColorForId(user_id != 0 ? 5 : chat_id));
-            actionBar.setItemsBackground(AvatarDrawable.getButtonColorForId(user_id != 0 ? 5 : chat_id));
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            themeManager = new ThemeManager(getParentActivity());
+            //actionBar.setBackgroundColor(AvatarDrawable.getProfileBackColorForId(user_id != 0 ? 5 : chat_id));
+            //actionBar.setItemsBackground(AvatarDrawable.getButtonColorForId(user_id != 0 ? 5 : chat_id));
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setExtraHeight(AndroidUtilities.dp(88), false);
             if (AndroidUtilities.isTablet()) {
                 actionBar.setOccupyStatusBar(false);
@@ -371,7 +376,7 @@ public void onClick(View v) {
             });
 
             nameTextView = new TextView(getParentActivity());
-            nameTextView.setTextColor(0xffffffff);
+            nameTextView.setTextColor(themeManager.getColor("title"));
             nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20);
             nameTextView.setLines(1);
             nameTextView.setMaxLines(1);
@@ -1108,7 +1113,7 @@ private void createActionBarMenu() {
                 if (user == null) {
                     return;
                 }
-                ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+                ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
                 if (user.phone != null && user.phone.length() != 0) {
                     item.addSubItem(add_contact, LocaleController.getString("AddContact", R.string.AddContact), 0);
                     item.addSubItem(share_contact, LocaleController.getString("ShareContact", R.string.ShareContact), 0);
@@ -1117,14 +1122,14 @@ private void createActionBarMenu() {
                     item.addSubItem(block_contact, !userBlocked ? LocaleController.getString("BlockContact", R.string.BlockContact) : LocaleController.getString("Unblock", R.string.Unblock), 0);
                 }
             } else {
-                ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+                ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
                 item.addSubItem(share_contact, LocaleController.getString("ShareContact", R.string.ShareContact), 0);
                 item.addSubItem(block_contact, !userBlocked ? LocaleController.getString("BlockContact", R.string.BlockContact) : LocaleController.getString("Unblock", R.string.Unblock), 0);
                 item.addSubItem(edit_contact, LocaleController.getString("EditContact", R.string.EditContact), 0);
                 item.addSubItem(delete_contact, LocaleController.getString("DeleteContact", R.string.DeleteContact), 0);
             }
         } else if (chat_id != 0) {
-            ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             if (chat_id > 0) {
                 item.addSubItem(add_member, LocaleController.getString("AddMember", R.string.AddMember), 0);
                 item.addSubItem(edit_name, LocaleController.getString("EditName", R.string.EditName), 0);
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
index 0c44097f2..1111c0fcb 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
@@ -17,6 +17,7 @@
 import android.content.SharedPreferences;
 import android.content.pm.PackageInfo;
 import android.content.res.Configuration;
+import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Bundle;
 import android.text.Spannable;
@@ -37,6 +38,7 @@
 import android.widget.ListView;
 import android.widget.TextView;
 
+import com.teamjihu.LockManager;
 import com.teamjihu.ThemeManager;
 
 import org.telegram.PhoneFormat.PhoneFormat;
@@ -126,6 +128,7 @@
     private int contactsSortRow;
     private int selectThemeRow;
     private int manageEmoticonRow;
+    private int lockRow;
     private int rowCount;
 
     private final static int edit_name = 1;
@@ -219,6 +222,7 @@ public void run() {
         selectThemeRow = rowCount++;
         manageEmoticonRow = rowCount++;
         notificationRow = rowCount++;
+        lockRow = rowCount++;
         privacyRow = rowCount++;
         backgroundRow = rowCount++;
         languageRow = rowCount++;
@@ -235,7 +239,7 @@ public void run() {
         sendByEnterRow = rowCount++;
         supportSectionRow = rowCount++;
         supportSectionRow2 = rowCount++;
-        askQuestionRow = rowCount++;
+        /*askQuestionRow = rowCount++;*/
         telegramFaqRow = rowCount++;
         if (BuildVars.DEBUG_VERSION) {
             sendLogsRow = rowCount++;
@@ -269,8 +273,10 @@ public boolean needAddActionBar() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             themeManager = new ThemeManager(getParentActivity());
-            actionBar.setBackgroundColor(AvatarDrawable.getProfileBackColorForId(5));
-            actionBar.setItemsBackground(AvatarDrawable.getButtonColorForId(5));
+            //actionBar.setBackgroundColor(AvatarDrawable.getProfileBackColorForId(5));
+            //themeManager.setBackgroundDrawable(actionBar, themeManager.getDrawable("bg_actionBar", false));
+            //actionBar.setItemsBackground(AvatarDrawable.getButtonColorForId(5));
+            //actionBar.setItemsBackground("bar_selector");
             actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setExtraHeight(AndroidUtilities.dp(88), false);
             if (AndroidUtilities.isTablet()) {
@@ -311,7 +317,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                 }
             });
             ActionBarMenu menu = actionBar.createMenu();
-            ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
+            ActionBarMenuItem item = menu.addItem(0, themeManager.getDrawable("ic_ab_other", false));
             item.addSubItem(edit_name, LocaleController.getString("EditName", R.string.EditName), 0);
             item.addSubItem(logout, LocaleController.getString("LogOut", R.string.LogOut), 0);
 
@@ -344,7 +350,7 @@ public void onClick(View v) {
             });
 
             nameTextView = new TextView(getParentActivity());
-            nameTextView.setTextColor(0xffffffff);
+            nameTextView.setTextColor(themeManager.getColor("title"));
             nameTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20);
             nameTextView.setLines(1);
             nameTextView.setMaxLines(1);
@@ -363,7 +369,7 @@ public void onClick(View v) {
             nameTextView.setLayoutParams(layoutParams);
 
             onlineTextView = new TextView(getParentActivity());
-            onlineTextView.setTextColor(AvatarDrawable.getProfileTextColorForId(5));
+            onlineTextView.setTextColor(themeManager.getColor("subtitle"));
             onlineTextView.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14);
             onlineTextView.setLines(1);
             onlineTextView.setMaxLines(1);
@@ -479,6 +485,11 @@ else if (i == sendLogsRow) {
                         }
                     } else if (i == privacyRow) {
                         presentFragment(new PrivacySettingsActivity());
+                    } else if (i == lockRow) {
+                        if ( LockManager.isLocked() )
+                            presentFragment(new LockActivity(true));
+                        else
+                            presentFragment(new LockSettingActivity());
                     } else if (i == languageRow) {
                         presentFragment(new LanguageSelectActivity());
                     } else if (i == switchBackendButtonRow) {
@@ -511,7 +522,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                         }
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
                         builder.setTitle(LocaleController.getString("SortBy", R.string.SortBy));
-                        builder.setItems(new CharSequence[] {
+                        builder.setItems(new CharSequence[]{
                                 LocaleController.getString("Default", R.string.Default),
                                 LocaleController.getString("SortFirstName", R.string.SortFirstName),
                                 LocaleController.getString("SortLastName", R.string.SortLastName)
@@ -953,7 +964,11 @@ private void updateUserData() {
             photoBig = user.photo.photo_big;
         }
         AvatarDrawable avatarDrawable = new AvatarDrawable(user, true);
-        avatarDrawable.setColor(0xff5c98cd);
+        Drawable bg = themeManager.getDrawable("bg_pressed_actionbar_btn", true);
+        if ( bg == null )
+            avatarDrawable.setColor(0xff5c98cd);
+        else
+            avatarDrawable.setDrawable(bg);
         avatarImage.setImage(photo, "50_50", avatarDrawable);
         avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
 
@@ -1005,7 +1020,7 @@ public boolean isEnabled(int i) {
                     /*i == askQuestionRow ||*/ i == sendLogsRow || i == sendByEnterRow || i == privacyRow || i == wifiDownloadRow ||
                     i == mobileDownloadRow || i == clearLogsRow || i == roamingDownloadRow || i == languageRow || i == usernameRow ||
                     i == switchBackendButtonRow || i == telegramFaqRow || i == contactsSortRow || i == contactsReimportRow || i == saveToGalleryRow || i == selectThemeRow ||
-                    i == manageEmoticonRow;
+                    i == manageEmoticonRow || i == lockRow;
         }
 
         @Override
@@ -1062,6 +1077,11 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                     textCell.setTextAndValue(LocaleController.getString("TextSize", R.string.TextSize), String.format("%d", size), true);
                 } else if (i == languageRow) {
                     textCell.setTextAndValue(LocaleController.getString("Language", R.string.Language), LocaleController.getCurrentLanguageName(), true);
+                } else if(i == selectThemeRow) {
+                    textCell.setTextAndValue(LocaleController.getString("SelectTheme", R.string.SelectTheme), themeManager.getCurrentThemeName(), true);
+                } else if(i == lockRow) {
+                    String onoff = (LockManager.isLocked()) ? "ON" : "OFF";
+                    textCell.setTextAndValue(LocaleController.getString("PasswordLock", R.string.PasswordLock), onoff, true);
                 } else if (i == contactsSortRow) {
                     String value;
                     SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
@@ -1144,7 +1164,7 @@ else if (i == privacyRow) {
                 }
                 TextDetailSettingsCell textCell = (TextDetailSettingsCell) view;
 
-                if (i == mobileDownloadRow || i == wifiDownloadRow || i == roamingDownloadRow) {
+                if (i == mobileDownloadRow || i == wifiDownloadRow || i == roamingDownloadRow ) {
                     int mask = 0;
                     String value;
                     String text = "";
@@ -1155,11 +1175,6 @@ else if (i == privacyRow) {
                     } else if (i == wifiDownloadRow) {
                         value = LocaleController.getString("WhenConnectedOnWiFi", R.string.WhenConnectedOnWiFi);
                         mask = MediaController.getInstance().wifiDownloadMask;
-                    } else if(i == selectThemeRow) {
-                        //textView.setText();
-                        text = LocaleController.getString("SelectTheme", R.string.SelectTheme);
-                        //divider.setVisibility(View.VISIBLE);
-                        value = themeManager.getCurrentThemeName();
                     } else {
                         value = LocaleController.getString("WhenRoaming", R.string.WhenRoaming);
                         mask = MediaController.getInstance().roamingDownloadMask;
@@ -1220,11 +1235,13 @@ public int getItemViewType(int i) {
                 return 1;
             } else if (i == enableAnimationsRow || i == sendByEnterRow || i == saveToGalleryRow) {
                 return 3;
-            } else if (i == notificationRow || i == backgroundRow /*|| i == askQuestionRow*/ || i == sendLogsRow || i == privacyRow || i == clearLogsRow || i == switchBackendButtonRow || i == telegramFaqRow || i == contactsReimportRow || i == textSizeRow || i == languageRow || i == contactsSortRow) {
+            } else if (i == notificationRow || i == backgroundRow /*|| i == askQuestionRow*/ || i == sendLogsRow || i == privacyRow || i == clearLogsRow ||
+                    i == switchBackendButtonRow || i == telegramFaqRow || i == contactsReimportRow || i == textSizeRow || i == languageRow ||
+                    i == contactsSortRow || i == selectThemeRow || i == lockRow) {
                 return 2;
             } else if (i == versionRow) {
                 return 5;
-            } else if (i == wifiDownloadRow || i == mobileDownloadRow || i == roamingDownloadRow || i == numberRow || i == usernameRow || i == selectThemeRow) {
+            } else if (i == wifiDownloadRow || i == mobileDownloadRow || i == roamingDownloadRow || i == numberRow || i == usernameRow) {
                 return 6;
             } else if (i == settingsSectionRow2 || i == messagesSectionRow2 || i == supportSectionRow2 || i == numberSectionRow || i == mediaDownloadSection2) {
                 return 4;
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
index 2af87953d..8457a5229 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/SettingsThemeActivity.java
@@ -7,6 +7,7 @@
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Bundle;
+import android.view.Gravity;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -20,11 +21,13 @@
 
 import com.teamjihu.ThemeManager;
 
+import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.phonethemeshop.R;
 import org.telegram.ui.ActionBar.ActionBar;
 import org.telegram.ui.ActionBar.BaseFragment;
 import org.telegram.ui.Cells.ChatBaseCell;
+import org.telegram.ui.Views.Switch;
 
 import java.util.ArrayList;
 import java.util.List;
@@ -134,8 +137,6 @@ public void onItemClick(AdapterView<?> parent, View view, int pos, long id) {
 
             if ( !currentThemePkg.equals(b.getString("themePkg")) ) {
                 themeManager.applyTheme(b.getString("themePkg"));
-                ImageView btnCheck = (ImageView)selectedThemeItem.findViewById(R.id.settings_row_check_button);
-                //btnCheck.setImageResource(R.drawable.btn_check_on);
 
                 currentThemePkg = b.getString("themePkg");
             }
@@ -178,8 +179,34 @@ else if(position >= _themeItems.size())
             if ( item != null ) {
                 ImageView iconView = (ImageView)convertView.findViewById(R.id.theme_icon);
                 TextView themeName = (TextView)convertView.findViewById(R.id.theme_name);
-                ImageView btnCheck = (ImageView)convertView.findViewById(R.id.settings_row_check_button);
                 ImageView btnDelete = (ImageView)convertView.findViewById(R.id.settings_row_delete_button);
+
+                Switch checkBox;
+                boolean hasCheckBox = false;
+                int checkBoxIndex = 0;
+                for ( int i = 0; i < ((FrameLayout)convertView).getChildCount(); i++ ) {
+                    if ( ((FrameLayout)convertView).getChildAt(i) instanceof Switch ) {
+                        checkBoxIndex = i;
+                        hasCheckBox = true;
+                    }
+                }
+
+                if ( !hasCheckBox ) {
+                    checkBox = new Switch(getContext());
+                    checkBox.setDuplicateParentStateEnabled(false);
+                    checkBox.setFocusable(false);
+                    checkBox.setFocusableInTouchMode(false);
+                    checkBox.setClickable(false);
+                    ((FrameLayout) convertView).addView(checkBox);
+                    FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) checkBox.getLayoutParams();
+                    layoutParams.width = FrameLayout.LayoutParams.WRAP_CONTENT;
+                    layoutParams.height = FrameLayout.LayoutParams.WRAP_CONTENT;
+                    layoutParams.rightMargin = AndroidUtilities.dp(48);
+                    layoutParams.gravity = (LocaleController.isRTL ? Gravity.LEFT : Gravity.RIGHT) | Gravity.CENTER_VERTICAL;
+                    checkBox.setLayoutParams(layoutParams);
+                } else
+                    checkBox = (Switch)((FrameLayout)convertView).getChildAt(checkBoxIndex);
+
                 btnDelete.setTag(item);
 
                 if ( icon == null )
@@ -190,10 +217,10 @@ else if(position >= _themeItems.size())
                 if ( themeName != null ) {
                     themeName.setText(item.getString("themeName"));
                     if ( currentThemePkg.equals(item.getString("themePkg")) ) {
-//                        btnCheck.setImageResource(R.drawable.btn_check_on);
+                        setChecked(checkBox, true);
                         prevSelectedThemePkg = item.getString("themePkg");
                     } else {
-//                        btnCheck.setImageResource(R.drawable.btn_check_off);
+                        setChecked(checkBox, false);
                     }
 
                     if ( item.getString("themeName").equals(getParentActivity().getString(R.string.theme_title)) ) {
@@ -231,6 +258,11 @@ public void onClick(View view) {
         }
     }
 
+
+    public void setChecked(Switch checkBox, boolean checked) {
+        checkBox.setChecked(checked);
+    }
+
     @Override
     public void onActivityResultFragment(int index, int resultCode, Intent data) {
         getThemeList();
@@ -248,7 +280,7 @@ public void onFragmentDestroy() {
         super.onFragmentDestroy();
 
         if ( !currentThemePkg.equals(prevThemePkg) ) {
-            ChatBaseCell chatBaseCell = new ChatBaseCell(getParentActivity(), true);
+            ChatBaseCell chatBaseCell = new ChatBaseCell(getParentActivity(), true);    //init talk balloon(ex : msg_out_selected.9.png)
             Intent i = getParentActivity().getBaseContext().getPackageManager().getLaunchIntentForPackage(getParentActivity().getBaseContext().getPackageName());
             i.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK);
             getParentActivity().finish();
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
index 55ad78256..f9bc2690d 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
@@ -8,10 +8,12 @@
 
 package org.telegram.ui.Views;
 
+import android.graphics.Bitmap;
 import android.graphics.Canvas;
 import android.graphics.ColorFilter;
 import android.graphics.Paint;
 import android.graphics.Rect;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.text.Layout;
 import android.text.StaticLayout;
@@ -148,6 +150,11 @@ public void setColor(int value) {
         color = value;
     }
 
+    public void setDrawable(Drawable value) {
+        Bitmap bitmap = ((BitmapDrawable)value).getBitmap();
+        color = bitmap.getPixel(0, 0);
+    }
+
     public void setInfo(int id, String firstName, String lastName, boolean isBroadcast) {
         if (isProfile) {
             color = arrColorsProfiles[getColorIndex(id)];
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java b/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
index bc04788ac..236180026 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
@@ -29,8 +29,8 @@
 import android.widget.FrameLayout;
 import android.widget.ImageButton;
 import android.widget.ImageView;
+import android.widget.LinearLayout;
 import android.widget.PopupWindow;
-import android.widget.RelativeLayout;
 import android.widget.TextView;
 
 import com.teamjihu.ThemeManager;
@@ -68,7 +68,7 @@
     private ImageView emojiButton;
     private EmojiView emojiView;
     private TextView recordTimeText;
-    private ImageButton zzalButton;
+    private ImageButton zzalButton = null;
     private ImageButton audioSendButton;
     private View recordPanel;
     private View slideText;
@@ -144,8 +144,8 @@ public void setContainerView(Activity activity, View containerView, ChatActivity
         sizeNotifierRelativeLayout = (SizeNotifierRelativeLayout) containerView.findViewById(R.id.chat_layout);
         sizeNotifierRelativeLayout.delegate = this;
 
-//        RelativeLayout chatComposePanel = (RelativeLayout)containerView.findViewById(R.id.chat_compose_panel);
-//        themeManager.setBackgroundDrawable(chatComposePanel, themeManager.getDrawable("compose_panel", false));
+        LinearLayout chatComposePanel = (LinearLayout)containerView.findViewById(R.id.chat_compose_panel);
+        themeManager.setBackgroundDrawable(chatComposePanel, themeManager.getDrawable("compose_panel", false));
 
         messsageEditText = (EditText) containerView.findViewById(R.id.chat_text_edit);
         messsageEditText.setHint(LocaleController.getString("TypeMessage", R.string.TypeMessage));
@@ -159,6 +159,10 @@ public void setContainerView(Activity activity, View containerView, ChatActivity
         }
 
         if ( chatActivity != null ) {
+            FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) messsageEditText.getLayoutParams();
+            layoutParams.rightMargin = AndroidUtilities.dp(50);
+            messsageEditText.setLayoutParams(layoutParams);
+
             zzalButton = (ImageButton) containerView.findViewById(R.id.chat_zzal_button);
             zzalButton.setImageDrawable(themeManager.getDrawable("ic_zzal", false));
 
@@ -427,7 +431,10 @@ public void onAnimationEnd(Object animation) {
 
                         if (messsageEditText != null) {
                             FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) messsageEditText.getLayoutParams();
-                            layoutParams.rightMargin = AndroidUtilities.dp(0);
+                            if ( zzalButton == null )
+                                layoutParams.rightMargin = AndroidUtilities.dp(0);
+                            else
+                                layoutParams.rightMargin = AndroidUtilities.dp(50);
                             messsageEditText.setLayoutParams(layoutParams);
                         }
 
@@ -476,7 +483,10 @@ public void onAnimationEnd(Object animation) {
                         attachButton.clearAnimation();
 
                         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams) messsageEditText.getLayoutParams();
-                        layoutParams.rightMargin = AndroidUtilities.dp(0);
+                        if ( zzalButton == null )
+                            layoutParams.rightMargin = AndroidUtilities.dp(0);
+                        else
+                            layoutParams.rightMargin = AndroidUtilities.dp(50);
                         messsageEditText.setLayoutParams(layoutParams);
                     }
                 }
diff --git a/TMessagesProj/src/main/java/org/telegram/ui/WallpapersActivity.java b/TMessagesProj/src/main/java/org/telegram/ui/WallpapersActivity.java
index 3f03b59aa..bc7d9b85f 100644
--- a/TMessagesProj/src/main/java/org/telegram/ui/WallpapersActivity.java
+++ b/TMessagesProj/src/main/java/org/telegram/ui/WallpapersActivity.java
@@ -106,7 +106,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             themeManager = new ThemeManager(getParentActivity());
-            actionBar.setBackButtonImage(R.drawable.ic_ab_back);
+            actionBar.setBackButtonDrawable(themeManager.getDrawable("ic_ab_back", false));
             actionBar.setAllowOverlayTitle(true);
             actionBar.setTitle(LocaleController.getString("ChatBackground", R.string.ChatBackground));
             actionBar.setActionBarMenuOnItemClick(new ActionBar.ActionBarMenuOnItemClick() {
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_off.png b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_off.png
new file mode 100644
index 000000000..70172a1f4
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_off.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_on.png b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_on.png
new file mode 100644
index 000000000..bedcb6ddb
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_circle_on.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_del.png b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_del.png
new file mode 100644
index 000000000..a85f58708
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/ic_lock_del.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/menu_evaluate.png b/TMessagesProj/src/main/res/drawable-xxhdpi/menu_evaluate.png
new file mode 100644
index 000000000..40cd45fac
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/menu_evaluate.png differ
diff --git a/TMessagesProj/src/main/res/drawable-xxhdpi/menu_theme.png b/TMessagesProj/src/main/res/drawable-xxhdpi/menu_theme.png
new file mode 100644
index 000000000..05da231f3
Binary files /dev/null and b/TMessagesProj/src/main/res/drawable-xxhdpi/menu_theme.png differ
diff --git a/TMessagesProj/src/main/res/drawable/btn_lock_number.xml b/TMessagesProj/src/main/res/drawable/btn_lock_number.xml
new file mode 100644
index 000000000..33c7477f3
--- /dev/null
+++ b/TMessagesProj/src/main/res/drawable/btn_lock_number.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_pressed="true" android:drawable="@color/header" />
+    <item android:state_focused="true" android:drawable="@color/header"/>
+    <item android:drawable="@android:color/transparent"/>
+
+</selector>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/layout/chat_layout.xml b/TMessagesProj/src/main/res/layout/chat_layout.xml
index b7a9a261f..0d3754e8c 100644
--- a/TMessagesProj/src/main/res/layout/chat_layout.xml
+++ b/TMessagesProj/src/main/res/layout/chat_layout.xml
@@ -84,7 +84,6 @@
         android:focusable="true"
         android:focusableInTouchMode="true"
         android:id="@+id/chat_compose_panel"
-        android:background="@drawable/compose_panel"
         android:orientation="horizontal">
 
         <org.telegram.ui.Views.FrameLayoutFixed
@@ -103,15 +102,6 @@
                 android:layout_gravity="bottom"
                 android:id="@+id/chat_smile_button"/>
 
-            <ImageButton
-                android:layout_width="40dp"
-                android:layout_height="40dp"
-                android:layout_marginTop="2dp"
-                android:scaleType="centerInside"
-                android:layout_centerVertical="true"
-                android:id="@+id/chat_zzal_button"
-                android:background="@drawable/btn_zzal_bg"/>
-
 
             <EditText
                 android:layout_width="match_parent"
@@ -139,14 +129,24 @@
                 android:layout_marginTop="2dp"
                 android:id="@+id/chat_attach_button"
                 android:enabled="false"
-                android:layout_gravity="bottom|right"/>
+                android:layout_gravity="bottom|right"
+                android:visibility="gone"/>
+
+            <ImageButton
+                android:id="@+id/chat_zzal_button"
+                android:layout_width="48dp"
+                android:layout_height="48dp"
+                android:layout_marginTop="2dp"
+                android:enabled="false"
+                android:layout_gravity="bottom|right"
+                android:background="@drawable/btn_zzal_bg"/>
 
             <org.telegram.ui.Views.FrameLayoutFixed
                 android:layout_height="48dp"
                 android:layout_width="fill_parent"
                 android:layout_marginTop="2dp"
                 android:layout_gravity="bottom"
-                android:background="#ffffff"
+                android:background="#ffffffff"
                 android:id="@+id/record_panel"
                 android:visibility="gone">
 
@@ -221,7 +221,7 @@
                 android:enabled="false"
                 android:src="@drawable/mic_button_states"
                 android:paddingRight="4dp"
-                android:background="@android:color/white"/>
+                android:background="@android:color/transparent"/>
 
             <ImageButton
                 android:layout_width="48dp"
diff --git a/TMessagesProj/src/main/res/layout/lock_change_password_layout.xml b/TMessagesProj/src/main/res/layout/lock_change_password_layout.xml
new file mode 100644
index 000000000..8e25e18b5
--- /dev/null
+++ b/TMessagesProj/src/main/res/layout/lock_change_password_layout.xml
@@ -0,0 +1,337 @@
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools" android:layout_width="match_parent"
+    android:layout_height="match_parent" android:paddingLeft="@dimen/activity_horizontal_margin"
+    android:paddingRight="@dimen/activity_horizontal_margin"
+    android:paddingTop="@dimen/activity_vertical_margin"
+    android:paddingBottom="@dimen/activity_vertical_margin"
+    tools:context="org.telegram.ui.LockChangePasswordActivity">
+
+    <LinearLayout
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:orientation="vertical"
+        android:weightSum="7">
+
+        <TextView
+            android:id="@+id/txtPassword"
+            android:layout_width="wrap_content"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_gravity="center_horizontal"
+            android:gravity="bottom"
+            android:textSize="30dp"
+            android:textColor="#ff000000"
+            android:text="@string/password"/>
+
+        <TextView
+            android:id="@+id/txtPasswordComment"
+            android:layout_width="wrap_content"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_gravity="center"
+            android:gravity="center"
+            android:textSize="15dp"
+            android:textColor="#ff333333"
+            android:text="@string/input_password"/>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_marginLeft="20dp"
+            android:layout_marginRight="20dp"
+            android:orientation="horizontal"
+            android:weightSum="4">
+
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle1"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle2"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle3"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle4"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number1"
+                android:tag="1"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="1"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number2"
+                android:tag="2"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="2"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number3"
+                android:tag="3"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="3"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number4"
+                android:tag="4"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="4"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number5"
+                android:tag="5"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="5"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number6"
+                android:tag="6"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="6"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number7"
+                android:tag="7"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="7"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number8"
+                android:tag="8"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="8"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number9"
+                android:tag="9"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="9"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1">
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number0"
+                android:tag="0"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="0"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_del"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <ImageView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:src="@drawable/ic_lock_del"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+</RelativeLayout>
diff --git a/TMessagesProj/src/main/res/layout/lock_layout.xml b/TMessagesProj/src/main/res/layout/lock_layout.xml
new file mode 100644
index 000000000..ad48e601d
--- /dev/null
+++ b/TMessagesProj/src/main/res/layout/lock_layout.xml
@@ -0,0 +1,337 @@
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools" android:layout_width="match_parent"
+    android:layout_height="match_parent" android:paddingLeft="@dimen/activity_horizontal_margin"
+    android:paddingRight="@dimen/activity_horizontal_margin"
+    android:paddingTop="@dimen/activity_vertical_margin"
+    android:paddingBottom="@dimen/activity_vertical_margin"
+    tools:context="org.telegram.ui.LockActivity">
+
+    <LinearLayout
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:orientation="vertical"
+        android:weightSum="7">
+
+        <TextView
+            android:id="@+id/txtPassword"
+            android:layout_width="wrap_content"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_gravity="center_horizontal"
+            android:gravity="bottom"
+            android:textSize="30dp"
+            android:textColor="#ff000000"
+            android:text="@string/password"/>
+
+        <TextView
+            android:id="@+id/txtPasswordComment"
+            android:layout_width="wrap_content"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_gravity="center"
+            android:gravity="center"
+            android:textSize="15dp"
+            android:textColor="#ff333333"
+            android:text="@string/input_password"/>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:layout_marginLeft="20dp"
+            android:layout_marginRight="20dp"
+            android:orientation="horizontal"
+            android:weightSum="4">
+
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle1"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle2"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle3"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:gravity="center_horizontal"
+                android:layout_weight="1">
+                <ImageView
+                    android:id="@+id/lock_circle4"
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:src="@drawable/ic_lock_circle_off"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number1"
+                android:tag="1"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="1"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number2"
+                android:tag="2"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="2"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number3"
+                android:tag="3"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="3"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number4"
+                android:tag="4"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="4"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number5"
+                android:tag="5"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="5"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number6"
+                android:tag="6"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="6"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:id="@+id/lock_btn_number7"
+                android:tag="7"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="7"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number8"
+                android:tag="8"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="8"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number9"
+                android:tag="9"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="9"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:orientation="horizontal"
+            android:weightSum="3">
+
+            <LinearLayout
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1">
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_number0"
+                android:tag="0"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <TextView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:text="0"
+                    android:textSize="40dp"
+                    android:textColor="#ff000000"/>
+            </LinearLayout>
+            <LinearLayout
+                android:id="@+id/lock_btn_del"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center"
+                android:gravity="center"
+                android:layout_weight="1"
+                android:clickable="true"
+                android:background="@drawable/btn_lock_number">
+                <ImageView
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center"
+                    android:src="@drawable/ic_lock_del"/>
+            </LinearLayout>
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+</RelativeLayout>
diff --git a/TMessagesProj/src/main/res/layout/lock_setting_activity.xml b/TMessagesProj/src/main/res/layout/lock_setting_activity.xml
new file mode 100644
index 000000000..9c377b681
--- /dev/null
+++ b/TMessagesProj/src/main/res/layout/lock_setting_activity.xml
@@ -0,0 +1,66 @@
+<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:orientation="vertical"
+    tools:context="org.telegram.ui.LockSettingActivity">
+
+    <FrameLayout
+        android:id="@+id/turnOnLockRow"
+        android:layout_width="match_parent"
+        android:layout_height="60dp"
+        android:background="@drawable/list_selector">
+
+        <TextView
+            android:id="@+id/turnOnLock"
+            android:textSize="17dp"
+            android:textColor="#333333"
+            android:layout_width="wrap_content"
+            android:layout_height="fill_parent"
+            android:layout_marginLeft="15dp"
+            android:layout_marginRight="70dp"
+            android:gravity="center_vertical"
+            android:layout_gravity="top"/>
+
+        <View
+            android:background="@color/divider"
+            android:layout_width="fill_parent"
+            android:layout_height="1px"
+            android:layout_gravity="bottom"/>
+
+    </FrameLayout>
+
+    <FrameLayout
+        android:id="@+id/changeLockPasswordRow"
+        android:layout_width="match_parent"
+        android:layout_height="60dp"
+        android:background="@drawable/list_selector">
+
+        <TextView
+            android:id="@+id/changeLockPassword"
+            android:textSize="17dp"
+            android:textColor="#333333"
+            android:layout_width="wrap_content"
+            android:layout_height="fill_parent"
+            android:layout_marginLeft="15dp"
+            android:layout_marginRight="70dp"
+            android:gravity="center_vertical"
+            android:layout_gravity="top"/>
+
+        <View
+            android:background="@color/divider"
+            android:layout_width="fill_parent"
+            android:layout_height="1px"
+            android:layout_gravity="bottom"/>
+
+    </FrameLayout>
+    <TextView
+        android:id="@+id/txtLockSettingComment"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:layout_marginLeft="15dp"
+        android:layout_marginTop="10dp"
+        android:textSize="12dp"
+        android:textColor="@color/gray"/>
+
+</LinearLayout>
diff --git a/TMessagesProj/src/main/res/layout/popup_count_layout.xml b/TMessagesProj/src/main/res/layout/popup_count_layout.xml
index 1593006af..0243768b7 100644
--- a/TMessagesProj/src/main/res/layout/popup_count_layout.xml
+++ b/TMessagesProj/src/main/res/layout/popup_count_layout.xml
@@ -8,7 +8,6 @@
         android:layout_height="fill_parent"
         android:layout_width="56dp"
         android:id="@+id/count_text"
-        android:textColor="#ffd7e8f7"
         android:textSize="14dp"
         android:gravity="center"
         android:layout_centerInParent="true"/>
diff --git a/TMessagesProj/src/main/res/layout/popup_notification_layout.xml b/TMessagesProj/src/main/res/layout/popup_notification_layout.xml
index 12ade2adc..e18626e55 100644
--- a/TMessagesProj/src/main/res/layout/popup_notification_layout.xml
+++ b/TMessagesProj/src/main/res/layout/popup_notification_layout.xml
@@ -35,7 +35,6 @@
                     android:layout_weight="1">
 
                     <ImageView
-                        android:src="@drawable/ic_msg_panel_smiles"
                         android:layout_width="48dp"
                         android:layout_height="48dp"
                         android:layout_marginTop="2dp"
diff --git a/TMessagesProj/src/main/res/layout/theme_item.xml b/TMessagesProj/src/main/res/layout/theme_item.xml
index 11683fa9a..7c33a5b94 100644
--- a/TMessagesProj/src/main/res/layout/theme_item.xml
+++ b/TMessagesProj/src/main/res/layout/theme_item.xml
@@ -22,15 +22,6 @@
         android:gravity="center_vertical"
         android:layout_gravity="top"/>
 
-    <ImageView
-        android:layout_gravity="center_vertical|right"
-        android:id="@+id/settings_row_check_button"
-        android:duplicateParentState="false"
-        android:layout_width="wrap_content"
-        android:layout_height="wrap_content"
-        android:layout_marginRight="48dp" />
-        <!-- android:src="@drawable/btn_check_off"/> -->
-
     <ImageView
         android:layout_gravity="center_vertical|right"
         android:id="@+id/settings_row_delete_button"
diff --git a/TMessagesProj/src/main/res/menu/menu_lock.xml b/TMessagesProj/src/main/res/menu/menu_lock.xml
new file mode 100644
index 000000000..b2d0f2a19
--- /dev/null
+++ b/TMessagesProj/src/main/res/menu/menu_lock.xml
@@ -0,0 +1,5 @@
+<menu xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools" tools:context="org.telegram.ui.LockActivity">
+    <item android:id="@+id/action_settings" android:title="@string/action_settings"
+        android:orderInCategory="100" android:showAsAction="never" />
+</menu>
diff --git a/TMessagesProj/src/main/res/menu/menu_lock_change_password.xml b/TMessagesProj/src/main/res/menu/menu_lock_change_password.xml
new file mode 100644
index 000000000..fa322a58c
--- /dev/null
+++ b/TMessagesProj/src/main/res/menu/menu_lock_change_password.xml
@@ -0,0 +1,6 @@
+<menu xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    tools:context="org.telegram.ui.LockChangePasswordActivity">
+    <item android:id="@+id/action_settings" android:title="@string/action_settings"
+        android:orderInCategory="100" android:showAsAction="never" />
+</menu>
diff --git a/TMessagesProj/src/main/res/menu/menu_lock_setting.xml b/TMessagesProj/src/main/res/menu/menu_lock_setting.xml
new file mode 100644
index 000000000..09a6d04ee
--- /dev/null
+++ b/TMessagesProj/src/main/res/menu/menu_lock_setting.xml
@@ -0,0 +1,6 @@
+<menu xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    tools:context="org.telegram.ui.LockSettingActivity">
+    <item android:id="@+id/action_settings" android:title="@string/action_settings"
+        android:orderInCategory="100" android:showAsAction="never" />
+</menu>
diff --git a/TMessagesProj/src/main/res/values-ar/strings.xml b/TMessagesProj/src/main/res/values-ar/strings.xml
index b42a1204a..5ab5728e4 100644
--- a/TMessagesProj/src/main/res/values-ar/strings.xml
+++ b/TMessagesProj/src/main/res/values-ar/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">  </string>
     <string name="NoContacts">    </string>
-    <string name="InviteText">http://telegram.org/dl2 !   : </string>
+    <string name="InviteText">https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop !   : </string>
     <string name="TodayAt"> </string>
     <string name="YesterdayAt"> </string>
     <string name="Online"></string>
diff --git a/TMessagesProj/src/main/res/values-de/strings.xml b/TMessagesProj/src/main/res/values-de/strings.xml
index 04aa57a83..f32722a2e 100644
--- a/TMessagesProj/src/main/res/values-de/strings.xml
+++ b/TMessagesProj/src/main/res/values-de/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Kontakt auswhlen</string>
     <string name="NoContacts">Noch keine Kontakte</string>
-    <string name="InviteText">Hey, lass uns zu Telegram wechseln: http://telegram.org/dl2</string>
+    <string name="InviteText">Hey, lass uns zu Themegram wechseln: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">heute um</string>
     <string name="YesterdayAt">gestern um</string>
     <string name="Online">online</string>
diff --git a/TMessagesProj/src/main/res/values-es/strings.xml b/TMessagesProj/src/main/res/values-es/strings.xml
index 2f4b1ca5f..ca76e41e7 100644
--- a/TMessagesProj/src/main/res/values-es/strings.xml
+++ b/TMessagesProj/src/main/res/values-es/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Elegir contacto</string>
     <string name="NoContacts">An sin contactos</string>
-    <string name="InviteText">Oye, cambimonos a Telegram: http://telegram.org/dl2</string>
+    <string name="InviteText">Oye, cambimonos a Themegram: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">hoy a las</string>
     <string name="YesterdayAt">ayer a las</string>
     <string name="Online">en lnea</string>
diff --git a/TMessagesProj/src/main/res/values-it/strings.xml b/TMessagesProj/src/main/res/values-it/strings.xml
index 421a1c6ff..830fdc994 100644
--- a/TMessagesProj/src/main/res/values-it/strings.xml
+++ b/TMessagesProj/src/main/res/values-it/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Seleziona contatto</string>
     <string name="NoContacts">Ancora nessun contatto</string>
-    <string name="InviteText">Ehi,  il momento di passare a Telegram: http://telegram.org/dl2</string>
+    <string name="InviteText">Ehi,  il momento di passare a Themegram: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">oggi alle</string>
     <string name="YesterdayAt">ieri alle</string>
     <string name="Online">in linea</string>
diff --git a/TMessagesProj/src/main/res/values-ko/strings.xml b/TMessagesProj/src/main/res/values-ko/strings.xml
index 47b35c5ec..4e47fba73 100644
--- a/TMessagesProj/src/main/res/values-ko/strings.xml
+++ b/TMessagesProj/src/main/res/values-ko/strings.xml
@@ -151,7 +151,7 @@
     <!--contacts view-->
     <string name="SelectContact"> </string>
     <string name="NoContacts"> </string>
-    <string name="InviteText"> ! http://telegram.org/dl2</string>
+    <string name="InviteText"> ! https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt"></string>
     <string name="YesterdayAt"></string>
     <string name="Online"></string>
@@ -248,6 +248,7 @@
     <string name="AskAQuestionInfo">     .         .<![CDATA[<br><br>]]>  <![CDATA[<a href=\"http://telegram.org/faq/ko#g\"></a>]]>  \'<![CDATA[<a href=\"http://telegram.org/faq/ko#a\">  </a>]]>\'  .</string>
     <string name="AskButton"></string>
     <string name="TelegramFaq">  </string>
+    <string name="EvaluateApp"> </string>
     <string name="TelegramFaqUrl">https://telegram.org/faq/ko</string>
     <string name="DeleteLocalization"> ?</string>
     <string name="IncorrectLocalization">   .</string>
@@ -286,6 +287,9 @@
     <string name="SelectTheme"> </string>
     <string name="ManageEmoticon"> </string>
     <string name="moreTheme">  </string>
+    <string name="PasswordLock"></string>
+    <string name="TurnOnLock"> </string>
+    <string name="ChangeLockPassword"></string>
     <!--media view-->
     <string name="NoMedia">  </string>
     <!--map view-->
@@ -536,4 +540,13 @@
     <string name="recommend_to_delete_origianl_telegram">        .    ?</string>
     <string name="yes"></string>
     <string name="no"></string>
+
+    <!-- default lock -->
+    <string name="use_password_cannot_popup">* ,    .</string>
+    <string name="password"></string>
+    <string name="input_password"> .</string>
+    <string name="incorrect_password">  .</string>
+    <string name="input_password_to_confirm">     .</string>
+    <string name="input_password_again">   .</string>
+
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values-nl/strings.xml b/TMessagesProj/src/main/res/values-nl/strings.xml
index 37a238a2a..e3f96ffd0 100644
--- a/TMessagesProj/src/main/res/values-nl/strings.xml
+++ b/TMessagesProj/src/main/res/values-nl/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Kies een contact</string>
     <string name="NoContacts">Nog geen contacten</string>
-    <string name="InviteText">Hey! Zullen we overstappen op Telegram? http://telegram.org/dl2</string>
+    <string name="InviteText">Hey! Zullen we overstappen op Themegram? https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">vandaag om</string>
     <string name="YesterdayAt">gisteren om</string>
     <string name="Online">online</string>
diff --git a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
index 3804be3b3..59923c36d 100644
--- a/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rBR/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Selecionar Contato</string>
     <string name="NoContacts">Ainda no h contatos</string>
-    <string name="InviteText">Ei, vamos mudar para o Telegram: http://telegram.org/dl2</string>
+    <string name="InviteText">Ei, vamos mudar para o Themegram: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">hoje s</string>
     <string name="YesterdayAt">ontem s</string>
     <string name="Online">online</string>
diff --git a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
index 3aa9c8253..633ec3f15 100644
--- a/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
+++ b/TMessagesProj/src/main/res/values-pt-rPT/strings.xml
@@ -146,7 +146,7 @@
     <!--contacts view-->
     <string name="SelectContact">Selecionar Contato</string>
     <string name="NoContacts">Ainda no h contatos</string>
-    <string name="InviteText">Ei, vamos mudar para o Telegram: http://telegram.org/dl2</string>
+    <string name="InviteText">Ei, vamos mudar para o Themegram: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">hoje s</string>
     <string name="YesterdayAt">ontem s</string>
     <string name="Online">online</string>
diff --git a/TMessagesProj/src/main/res/values/colors.xml b/TMessagesProj/src/main/res/values/colors.xml
index 3612cf076..0292d6a45 100755
--- a/TMessagesProj/src/main/res/values/colors.xml
+++ b/TMessagesProj/src/main/res/values/colors.xml
@@ -6,4 +6,6 @@
 
     <color name="title">#ffffffff</color>
     <color name="subtitle">#ffd7e8f7</color>
+
+    <color name="gray">#909090</color>
 </resources>
\ No newline at end of file
diff --git a/TMessagesProj/src/main/res/values/dimens.xml b/TMessagesProj/src/main/res/values/dimens.xml
new file mode 100644
index 000000000..47c822467
--- /dev/null
+++ b/TMessagesProj/src/main/res/values/dimens.xml
@@ -0,0 +1,5 @@
+<resources>
+    <!-- Default screen margins, per the Android Design guidelines. -->
+    <dimen name="activity_horizontal_margin">16dp</dimen>
+    <dimen name="activity_vertical_margin">16dp</dimen>
+</resources>
diff --git a/TMessagesProj/src/main/res/values/strings.xml b/TMessagesProj/src/main/res/values/strings.xml
index 45a00062c..fe7a58c02 100644
--- a/TMessagesProj/src/main/res/values/strings.xml
+++ b/TMessagesProj/src/main/res/values/strings.xml
@@ -1,10 +1,9 @@
 <?xml version="1.0" encoding="utf-8"?>
-
 <resources>
 
     <!-- theme name -->
     <string name="theme_title">Default Theme</string>
-    <!--emoticon name-->
+    <!-- emoticon name -->
     <string name="emoticon_title">Default Emoticon</string>
     <!--  -->
     <string name="AppName">Telegram for PhoneThemeShop</string>
@@ -53,7 +52,6 @@
     <string name="DeleteChatUser">Delete chat</string>
     <string name="HiddenName">Deleted Account</string>
     <string name="SelectChat">Select Chat</string>
-
     <string name="PhotoTip">Tap and hold to view</string>
     <string name="CompatibilityChat">%1$s is using an older version of Telegram, so secret photos will be shown in compatibility mode.\n\nOnce %2$s updates Telegram, photos with timers for 1 minute or less will start working in \'Tap and hold to view\' mode, and you will be notified whenever the other party takes a screenshot.</string>
     <string name="SearchMessages">MESSAGES</string>
@@ -151,7 +149,7 @@
     <!-- contacts view -->
     <string name="SelectContact">Select Contact</string>
     <string name="NoContacts">No contacts yet</string>
-    <string name="InviteText">Hey, let\'s switch to Telegram: http://telegram.org/dl2</string>
+    <string name="InviteText">Hey, let\'s switch to Themegram: https://play.google.com/store/apps/details?id=org.telegram.messenger.phonethemeshop</string>
     <string name="TodayAt">today at</string>
     <string name="YesterdayAt">yesterday at</string>
     <string name="Online">online</string>
@@ -197,7 +195,7 @@
     <string name="NumberUnknown">Unknown</string>
     <string name="Info">Info</string>
     <string name="Phone">Phone</string>
-    <!--usernames-->
+    <!-- usernames -->
     <string name="Username">Username</string>
     <string name="UsernamePlaceholder">Your Username</string>
     <string name="UsernameInUse">Sorry, this username is already taken.</string>
@@ -248,6 +246,7 @@
     <string name="AskAQuestionInfo">Please note that Telegram Support is done by volunteers. We try to respond as quickly as possible, but it may take a while.<![CDATA[<br><br>]]>Please take a look at the <![CDATA[<a href=\"http://telegram.org/faq#general\">Telegram FAQ</a>]]>: it has answers to most questions and important tips for <![CDATA[<a href=\"http://telegram.org/faq#troubleshooting\">troubleshooting</a>]]>.</string>
     <string name="AskButton">Ask a volunteer</string>
     <string name="TelegramFaq">Telegram FAQ</string>
+    <string name="EvaluateApp">Evaluate Themegram</string>
     <string name="TelegramFaqUrl">https://telegram.org/faq</string>
     <string name="DeleteLocalization">Delete localization?</string>
     <string name="IncorrectLocalization">Incorrect localization file</string>
@@ -286,6 +285,9 @@
     <string name="SelectTheme">Select Theme</string>
     <string name="ManageEmoticon">Manage Emoticon</string>
     <string name="moreTheme">download theme</string>
+    <string name="PasswordLock">Password Lock</string>
+    <string name="TurnOnLock">Turn on password lock</string>
+    <string name="ChangeLockPassword">Change Password</string>
     <!-- media view -->
     <string name="NoMedia">No shared media yet</string>
     <!-- map view -->
@@ -304,7 +306,7 @@
     <string name="AllPhotos">All Photos</string>
     <string name="NoPhotos">No photos yet</string>
     <string name="PleaseDownload">Please download media first</string>
-    <!--privacy settings-->
+    <!-- privacy settings -->
     <string name="PrivacySettings">Privacy and Security</string>
     <string name="PrivacyTitle">Privacy</string>
     <string name="PrivacyLastSeen">Last Seen</string>
@@ -530,22 +532,31 @@
     <string name="formatterDay24H">HH:mm</string>
     <string name="formatterDay12H">h:mm a</string>
     <string name="formatDateAtTime">%1$s at %2$s</string>
-    <!--theme-->
-    <string name="usingTheme"> .</string>
+    <!-- theme -->
+    <string name="usingTheme">The theme you are using</string>
     <!-- Don't change this! Not for localization! -->
     <string name="CacheTag">CACHE_TAG</string>
     <string name="title_activity_magic_app_restart">MagicAppRestart</string>
     <string name="hello_world">Hello world!</string>
     <string name="action_settings">Settings</string>
-
     <string name="recommend_to_delete_origianl_telegram">It is highly recommended to delete the original telegram app. Would you like to delete it?</string>
     <string name="yes">Yes</string>
     <string name="no">No</string>
 
-
-    <!--default emoticon-->
+    <!-- default emoticon -->
     <string name="col">4</string>
     <string name="row">4</string>
     <string name="total">16</string>
+    <string name="title_activity_lock">LockActivity</string>
+
+    <!-- default lock -->
+    <string name="use_password_cannot_popup">*If you use the password lock, you can\'t use popup notification</string>
+    <string name="password">PASSWORD</string>
+    <string name="input_password">Please enter your password</string>
+    <string name="incorrect_password">incorrect password</string>
+    <string name="input_password_to_confirm">Please enter your password to confirm</string>
+    <string name="title_activity_lock_setting">LockSettingActivity</string>
+    <string name="title_activity_lock_change_password">LockChangePasswordActivity</string>
+    <string name="input_password_again">Please enter your password again</string>
 
 </resources>
\ No newline at end of file
diff --git a/build.gradle b/build.gradle
index 495c5038e..f7a7ae7e2 100644
--- a/build.gradle
+++ b/build.gradle
@@ -1 +1 @@
-// Top-level build file where you can add configuration options common to all sub-projects/modules.
+// Top-level build file where you can add configuration options common to all sub-projects/modules.
\ No newline at end of file
diff --git a/gradle/wrapper/gradle-wrapper.properties b/gradle/wrapper/gradle-wrapper.properties
index f703ec03b..65ff7ff04 100644
--- a/gradle/wrapper/gradle-wrapper.properties
+++ b/gradle/wrapper/gradle-wrapper.properties
@@ -1,6 +1,6 @@
-#Mon Nov 03 14:19:12 MSK 2014
+#Thu Nov 27 14:01:12 KST 2014
 distributionBase=GRADLE_USER_HOME
 distributionPath=wrapper/dists
 zipStoreBase=GRADLE_USER_HOME
 zipStorePath=wrapper/dists
-distributionUrl=https\://services.gradle.org/distributions/gradle-2.1-all.zip
+distributionUrl=https\://services.gradle.org/distributions/gradle-2.2.1-all.zip
