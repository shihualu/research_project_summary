diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index d95203c129..2d06450a4a 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -1,7 +1,7 @@
 Submit a new issue only if you are sure it is a missing feature or a bug. Otherwise discuss the topic on the 
 [mailing list](http://graphhopper.com/#developers) first.
 
-We love pull requests. Here's a quick guide:
+## We love pull requests. Here's a quick guide:
 
 1. [Fork the repo](https://help.github.com/articles/fork-a-repo), optionally create a feature branch
 
@@ -15,8 +15,12 @@ a test!
 
 5. Push to your fork and [submit a pull request](https://help.github.com/articles/using-pull-requests)
 
+## License Agreement
 
-Syntax:
+For contributions like pull requests, bug fixes and translations please read and sign 
+the <a href="http://www.clahub.com/agreements/graphhopper/graphhopper">GraphHopper License Agreement</a>. 
+
+## Syntax:
 
 * Tell this your IDE or just use NetBeans which picks the format from pom.xml. E.g. no tabs - use 4 spaces instead!!
 * Follow the conventions you see used in the source already.
diff --git a/CONTRIBUTORS.md b/CONTRIBUTORS.md
index 830e7aba02..e7fdd2bdb5 100644
--- a/CONTRIBUTORS.md
+++ b/CONTRIBUTORS.md
@@ -1,13 +1,17 @@
 [Members](https://github.com/graphhopper?tab=members) and [Contributors](https://github.com/graphhopper/graphhopper/contributors)
 
  * agouge, discussion and API refactoring
+ * b3nn0, Android improvements
  * daisy1754, fixed usage of graphhopper.sh script
+ * dardin88, instructions improved
+ * lmar, improved instructions information
  * fredao, translations
  * jansonhanson, general host config
+ * JohannesPelzer, improved GPX information
  * karussell, lead developer
- * khuebner, pushes turn instructions forward
+ * khuebner, pushes turn instructions forward 
  * lmar, improved instructions
  * NopMap, massive improvements regarding OSM, parsing and encoding, route relations
  * ocampana, initial implementation for instructions
- * ratrun, route relations and bike handling
+ * ratrun, route relations, GPX information and bike handling
  * rodo, more descriptions
\ No newline at end of file
diff --git a/README.md b/README.md
index c51da1c8d9..071ec834fa 100644
--- a/README.md
+++ b/README.md
@@ -1,4 +1,6 @@
-# GraphHopper [![Build Status](https://secure.travis-ci.org/graphhopper/graphhopper.png?branch=master)](http://travis-ci.org/graphhopper/graphhopper)
+# GraphHopper Route Planner
+
+[![Build Status](https://secure.travis-ci.org/graphhopper/graphhopper.png?branch=master)](http://travis-ci.org/graphhopper/graphhopper)
 
 GraphHopper is a fast and memory efficient Java road routing engine released under Apache License 2.0.
 It is tuned towards road networks with OpenStreetMap data but can be useful for public transport problems as well.
diff --git a/android/.classpath b/android/.classpath
index 194cfe2d8c..497def70c6 100644
--- a/android/.classpath
+++ b/android/.classpath
@@ -9,5 +9,6 @@
 	<classpathentry exported="true" kind="con" path="com.android.ide.eclipse.adt.LIBRARIES"/>
 	<classpathentry kind="src" path="src"/>
 	<classpathentry kind="src" path="gen"/>
+	<classpathentry exported="true" kind="con" path="com.android.ide.eclipse.adt.DEPENDENCIES"/>
 	<classpathentry kind="output" path="bin/classes"/>
 </classpath>
diff --git a/android/.project b/android/.project
index 7ce2f2637d..9f2869b63c 100644
--- a/android/.project
+++ b/android/.project
@@ -25,14 +25,8 @@
 			<arguments>
 			</arguments>
 		</buildCommand>
-		<buildCommand>
-			<name>org.eclipse.m2e.core.maven2Builder</name>
-			<arguments>
-			</arguments>
-		</buildCommand>
 	</buildSpec>
 	<natures>
-		<nature>org.eclipse.m2e.core.maven2Nature</nature>
 		<nature>com.android.ide.eclipse.adt.AndroidNature</nature>
 		<nature>org.eclipse.jdt.core.javanature</nature>
 	</natures>
diff --git a/android/AndroidManifest.xml b/android/AndroidManifest.xml
index ad4cf4c96f..4908215b43 100644
--- a/android/AndroidManifest.xml
+++ b/android/AndroidManifest.xml
@@ -3,17 +3,16 @@
           android:versionCode="1"
           android:versionName="0.1" >
 
-    <!-- mapsforge cache  -->
+    <!-- mapsforge cache and saving maps -->
     <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
     
     <!-- necessary to easily download maps via wifi -->
     <uses-permission android:name="android.permission.INTERNET" />
-    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /> 
-    
+    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />    
 
     <uses-sdk
         android:minSdkVersion="8"
-        android:targetSdkVersion="17" />
+        android:targetSdkVersion="19" />
 
     <application
         android:allowBackup="true"
diff --git a/android/libs/mapsforge-0.3.1-SNAPSHOT.jar b/android/libs/mapsforge-0.3.1-SNAPSHOT.jar
deleted file mode 100644
index 94313b4332..0000000000
Binary files a/android/libs/mapsforge-0.3.1-SNAPSHOT.jar and /dev/null differ
diff --git a/android/libs/mapsforge-core-0.4.0-SNAPSHOT.jar b/android/libs/mapsforge-core-0.4.0-SNAPSHOT.jar
new file mode 100644
index 0000000000..75765118b6
Binary files /dev/null and b/android/libs/mapsforge-core-0.4.0-SNAPSHOT.jar differ
diff --git a/android/libs/mapsforge-map-0.4.0-SNAPSHOT.jar b/android/libs/mapsforge-map-0.4.0-SNAPSHOT.jar
new file mode 100644
index 0000000000..3ace39569f
Binary files /dev/null and b/android/libs/mapsforge-map-0.4.0-SNAPSHOT.jar differ
diff --git a/android/libs/mapsforge-map-android-0.4.0-SNAPSHOT.jar b/android/libs/mapsforge-map-android-0.4.0-SNAPSHOT.jar
new file mode 100644
index 0000000000..d8044b0b0f
Binary files /dev/null and b/android/libs/mapsforge-map-android-0.4.0-SNAPSHOT.jar differ
diff --git a/android/libs/mapsforge-map-reader-0.4.0-SNAPSHOT.jar b/android/libs/mapsforge-map-reader-0.4.0-SNAPSHOT.jar
new file mode 100644
index 0000000000..cce15f7fee
Binary files /dev/null and b/android/libs/mapsforge-map-reader-0.4.0-SNAPSHOT.jar differ
diff --git a/android/pom.xml b/android/pom.xml
index 7dac89ca38..d3b6d99bb8 100644
--- a/android/pom.xml
+++ b/android/pom.xml
@@ -17,7 +17,8 @@
         <artifactId>graphhopper-parent</artifactId>    	
         <version>0.3-SNAPSHOT</version>
     </parent>
-    <properties>        
+    <properties>
+        <mapsforge.version>0.3-0.4.0-SNAPSHOT</mapsforge.version>
         <!-- do not put the properties here as it differs from dev to dev <android.sdk.path>/home/peterk/Programme/android-sdk-linux_x86</android.sdk.path>
         instead use your IDE to set it up or specify android sdk via command line
         using -Dandroid.sdk.path=... or by setting environment variable ANDROID_HOME
@@ -56,17 +57,32 @@
           
         <!-- see scripts/maven-install-mapsforge.sh !
             if we would use system dep it doesn't work (classnotfound). See also script for more infos.
-        -->              
+        -->          
         <dependency>
             <groupId>com.graphhopper</groupId>            
-            <artifactId>mapsforge-gh</artifactId>
-            <version>0.3-0.3.1-SNAPSHOT</version>
+            <artifactId>mapsforge-core</artifactId>
+            <version>${mapsforge.version}</version>
+        </dependency>    
+        <dependency>
+            <groupId>com.graphhopper</groupId>            
+            <artifactId>mapsforge-map</artifactId>
+            <version>${mapsforge.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>com.graphhopper</groupId>            
+            <artifactId>mapsforge-map-android</artifactId>
+            <version>${mapsforge.version}</version>
+        </dependency>        
+        <dependency>
+            <groupId>com.graphhopper</groupId>            
+            <artifactId>mapsforge-map-reader</artifactId>
+            <version>${mapsforge.version}</version>
         </dependency>
         
         <dependency>
             <groupId>org.slf4j</groupId>
             <artifactId>slf4j-android</artifactId>
-            <version>1.6.1-RC1</version>
+            <version>1.7.7</version>
         </dependency>        
 
         <!-- Make sure this is above (!) the android dependencies -->
@@ -112,7 +128,7 @@
                 <!-- See http://code.google.com/p/maven-android-plugin/ -->
                 <groupId>com.jayway.maven.plugins.android.generation2</groupId>
                 <artifactId>android-maven-plugin</artifactId>
-                <version>3.6.0</version>
+                <version>3.8.2</version>
                 <extensions>true</extensions>
                 <configuration>
                     <sdk>
diff --git a/android/project.properties b/android/project.properties
index b7c2081d56..4ab125693c 100644
--- a/android/project.properties
+++ b/android/project.properties
@@ -11,4 +11,4 @@
 #proguard.config=${sdk.dir}/tools/proguard/proguard-android.txt:proguard-project.txt
 
 # Project target.
-target=android-10
+target=android-19
diff --git a/android/scripts/maven-install-mapsforge.sh b/android/scripts/maven-install-mapsforge.sh
index 3ba883fbbe..c396e286e0 100755
--- a/android/scripts/maven-install-mapsforge.sh
+++ b/android/scripts/maven-install-mapsforge.sh
@@ -7,10 +7,14 @@
 # if we would do it via normal maven dependency management we run into strange things which I was not able to fix
 # http://stackoverflow.com/a/8315600/194609
 
-MAPSFORGE=`ls ./libs/mapsforge*.jar`
-echo "installing file: $MAPSFORGE"
-ARGS="-DgroupId=com.graphhopper -DartifactId=mapsforge-gh -Dversion=0.3-0.3.1-SNAPSHOT -Dpackaging=jar -Dfile=$MAPSFORGE"
-    
-$MAVEN_HOME/bin/mvn install:install-file $ARGS
+# MAVEN_HOME/bin/mvn
+MVN=mvn
+VERSION=0.4.0-SNAPSHOT
+libs="map map-android map-reader core"
 
-# $MAVEN_HOME/bin/mvn -DperformRelease=true -DskipTests=true -Dpgp.secretkey=keyring:id=54EA4B68 deploy:deploy-file $ARGS
\ No newline at end of file
+for lib in $libs; do
+  FILE=$(ls ./libs/mapsforge-$lib-$VERSION.jar)
+  echo "installing file: $FILE"
+  ARGS="-DgroupId=com.graphhopper -DartifactId=mapsforge-$lib -Dversion=0.3-0.4.0-SNAPSHOT -Dpackaging=jar -Dfile=$FILE"
+  $MVN install:install-file $ARGS
+done
diff --git a/android/src/com/graphhopper/android/MainActivity.java b/android/src/com/graphhopper/android/MainActivity.java
index 3ea67cb001..6107002d22 100644
--- a/android/src/com/graphhopper/android/MainActivity.java
+++ b/android/src/com/graphhopper/android/MainActivity.java
@@ -7,21 +7,26 @@
 import java.util.Map;
 import java.util.TreeMap;
 
-import org.mapsforge.android.maps.MapActivity;
-import org.mapsforge.android.maps.MapView;
-import org.mapsforge.android.maps.Projection;
-import org.mapsforge.android.maps.overlay.ListOverlay;
-import org.mapsforge.android.maps.overlay.Marker;
-import org.mapsforge.android.maps.overlay.PolygonalChain;
-import org.mapsforge.android.maps.overlay.Polyline;
-import org.mapsforge.core.model.GeoPoint;
-import org.mapsforge.map.reader.header.FileOpenResult;
-
+import org.mapsforge.core.graphics.Bitmap;
+import org.mapsforge.core.graphics.Paint;
+import org.mapsforge.core.graphics.Style;
+import org.mapsforge.core.model.LatLong;
+import org.mapsforge.core.model.MapPosition;
+import org.mapsforge.core.model.Point;
+import org.mapsforge.map.android.graphics.AndroidGraphicFactory;
+import org.mapsforge.map.android.util.AndroidUtil;
+import org.mapsforge.map.android.view.MapView;
+import org.mapsforge.map.layer.Layers;
+import org.mapsforge.map.layer.cache.TileCache;
+import org.mapsforge.map.layer.overlay.Marker;
+import org.mapsforge.map.layer.overlay.Polyline;
+import org.mapsforge.map.layer.renderer.TileRendererLayer;
+import org.mapsforge.map.rendertheme.InternalRenderTheme;
+
+import android.app.Activity;
 import android.app.ProgressDialog;
 import android.content.Intent;
 import android.graphics.Color;
-import android.graphics.DashPathEffect;
-import android.graphics.Paint;
 import android.graphics.Path;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
@@ -30,11 +35,8 @@
 import android.os.Bundle;
 import android.os.Environment;
 import android.util.Log;
-import android.view.GestureDetector;
-import android.view.GestureDetector.SimpleOnGestureListener;
 import android.view.Menu;
 import android.view.MenuItem;
-import android.view.MotionEvent;
 import android.view.View;
 import android.view.View.OnClickListener;
 import android.view.Window;
@@ -56,17 +58,16 @@
 import com.graphhopper.util.ProgressListener;
 import com.graphhopper.util.StopWatch;
 
-public class MainActivity extends MapActivity
+public class MainActivity extends Activity
 {
     private MapView mapView;
     private GraphHopperAPI hopper;
-    private GeoPoint start;
-    private GeoPoint end;
+    private LatLong start;
+    private LatLong end;
     private Spinner localSpinner;
     private Button localButton;
     private Spinner remoteSpinner;
     private Button remoteButton;
-    private ListOverlay pathOverlay = new ListOverlay();
     private volatile boolean prepareInProgress = false;
     private volatile boolean shortestPathRunning = false;
     private String currentArea = "berlin";
@@ -74,56 +75,50 @@
     private String prefixURL = fileListURL;
     private String downloadURL;
     private File mapsFolder;
-    private String mapFile;
-    private SimpleOnGestureListener gestureListener = new SimpleOnGestureListener()
+    private TileCache tileCache;
+
+    protected boolean onMapTap( LatLong tapLatLong, Point layerXY, Point tapXY )
     {
-        // why does this fail? public boolean onDoubleTap(MotionEvent e) {};
-        public boolean onSingleTapConfirmed( MotionEvent motionEvent )
+        if (!isReady())
+            return false;
+
+        if (shortestPathRunning)
         {
-            if (!initFiles(currentArea))
-            {
-                return false;
-            }
+            logUser("Calculation still in progress");
+            return false;
+        }
+        Layers layers = mapView.getLayerManager().getLayers();
 
-            if (shortestPathRunning)
+        if (start != null && end == null)
+        {
+            end = tapLatLong;
+            shortestPathRunning = true;
+            Marker marker = createMarker(tapLatLong, R.drawable.flag_red);
+            if (marker != null)
             {
-                logUser("Calculation still in progress");
-                return false;
+                layers.add(marker);
             }
-            float x = motionEvent.getX();
-            float y = motionEvent.getY();
-            Projection p = mapView.getProjection();
-            GeoPoint tmpPoint = p.fromPixels((int) x, (int) y);
 
-            if (start != null && end == null)
+            calcPath(start.latitude, start.longitude, end.latitude,
+                    end.longitude);
+        } else
+        {
+            start = tapLatLong;
+            end = null;
+            // remove all layers but the first one, which is the map
+            while (layers.size() > 1)
             {
-                end = tmpPoint;
-                shortestPathRunning = true;
-                Marker marker = createMarker(tmpPoint, R.drawable.flag_red);
-                if (marker != null)
-                {
-                    pathOverlay.getOverlayItems().add(marker);
-                    mapView.redraw();
-                }
+                layers.remove(1);
+            }
 
-                calcPath(start.latitude, start.longitude, end.latitude,
-                        end.longitude);
-            } else
+            Marker marker = createMarker(start, R.drawable.flag_green);
+            if (marker != null)
             {
-                start = tmpPoint;
-                end = null;
-                pathOverlay.getOverlayItems().clear();
-                Marker marker = createMarker(start, R.drawable.flag_green);
-                if (marker != null)
-                {
-                    pathOverlay.getOverlayItems().add(marker);
-                    mapView.redraw();
-                }
+                layers.add(marker);
             }
-            return true;
         }
-    };
-    private GestureDetector gestureDetector = new GestureDetector(gestureListener);
+        return true;
+    }
 
     @Override
     protected void onCreate( Bundle savedInstanceState )
@@ -131,28 +126,25 @@ protected void onCreate( Bundle savedInstanceState )
         requestWindowFeature(Window.FEATURE_NO_TITLE);
         super.onCreate(savedInstanceState);
         setContentView(R.layout.main);
-        mapView = new MapView(this)
-        {
-            @Override
-            public boolean onTouchEvent( MotionEvent event )
-            {
-                if (gestureDetector.onTouchEvent(event))
-                {
-                    return true;
-                }
-                return super.onTouchEvent(event);
-            }
-        };
+        AndroidGraphicFactory.createInstance(getApplication());
+
+        mapView = new MapView(this);
         mapView.setClickable(true);
         mapView.setBuiltInZoomControls(true);
 
+        tileCache = AndroidUtil.createTileCache(this, getClass().getSimpleName(), mapView.getModel().displayModel.getTileSize(),
+                1f, mapView.getModel().frameBufferModel.getOverdrawFactor());
+
         final EditText input = new EditText(this);
         input.setText(currentArea);
         boolean greaterOrEqKitkat = Build.VERSION.SDK_INT >= 19;
         if (greaterOrEqKitkat)
         {
-            if (Environment.getExternalStorageState() != Environment.MEDIA_MOUNTED)
-                throw new IllegalStateException("media is not mounted or not readable");
+            if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED))
+            {
+                logUser("GraphHopper is not usable without an external storage!");
+                return;
+            }
             mapsFolder = new File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
                     "/graphhopper/maps/");
         } else
@@ -174,7 +166,7 @@ public boolean onTouchEvent( MotionEvent event )
         chooseAreaFromLocal();
     }
 
-    private boolean initFiles( String area )
+    boolean isReady()
     {
         // only return true if already loaded
         if (hopper != null)
@@ -185,10 +177,15 @@ private boolean initFiles( String area )
             logUser("Preparation still in progress");
             return false;
         }
+        log("Prepare finished but hopper not ready. This happens when there was an error while loading the files");
+        return false;
+    }
+
+    private void initFiles( String area )
+    {
         prepareInProgress = true;
         currentArea = area;
         downloadingFiles();
-        return false;
     }
 
     private void chooseAreaFromLocal()
@@ -230,7 +227,8 @@ private void chooseAreaFromRemote()
             protected List<String> saveDoInBackground( Void... params )
                     throws Exception
             {
-                String[] lines = new Downloader("GraphHopper Android").downloadAsString(fileListURL).split("\n");
+                String[] lines = new Downloader("GraphHopper Android").
+                        downloadAsString(fileListURL).split("\n");
                 List<String> res = new ArrayList<String>();
                 for (String str : lines)
                 {
@@ -240,10 +238,8 @@ private void chooseAreaFromRemote()
                         index += 6;
                         int lastIndex = str.indexOf(".ghz", index);
                         if (lastIndex >= 0)
-                        {
                             res.add(prefixURL + str.substring(index, lastIndex)
                                     + ".ghz");
-                        }
                     }
                 }
 
@@ -255,16 +251,14 @@ protected void onPostExecute( List<String> nameList )
             {
                 if (hasError())
                 {
-                    logUser("To get downloadable areas restart when connected to internet. "
-                            + "Problem while fetching remote area list: "
+                    logUser("Are you connected to the internet? Problem while fetching remote area list: "
                             + getErrorMessage());
                     return;
                 }
                 MySpinnerListener spinnerListener = new MySpinnerListener()
                 {
                     @Override
-                    public void onSelect( String selectedArea,
-                            String selectedFile )
+                    public void onSelect( String selectedArea, String selectedFile )
                     {
                         if (selectedFile == null
                                 || new File(mapsFolder, selectedArea + ".ghz")
@@ -329,9 +323,10 @@ public void onClick( View v )
 
     void downloadingFiles()
     {
-        if (downloadURL == null)
+        final File areaFolder = new File(mapsFolder, currentArea + "-gh");
+        if (downloadURL == null || areaFolder.exists())
         {
-            loadMap();
+            loadMap(areaFolder);
             return;
         }
 
@@ -348,7 +343,7 @@ protected Object saveDoInBackground( Void... _ignore )
                     throws Exception
             {
                 String localFolder = Helper.pruneFileEnd(AndroidHelper.getFileName(downloadURL));
-                localFolder = mapsFolder + localFolder + "-gh";
+                localFolder = new File(mapsFolder, localFolder + "-gh").getAbsolutePath();
                 log("downloading & unzipping " + downloadURL + " to " + localFolder);
                 new Downloader("GraphHopper Android").downloadAndUnzip(downloadURL, localFolder,
                         new ProgressListener()
@@ -378,27 +373,35 @@ protected void onPostExecute( Object _ignore )
                     logUser(str);
                 } else
                 {
-                    loadMap();
+                    loadMap(areaFolder);
                 }
             }
         }.execute();
     }
 
-    void loadMap()
+    void loadMap( File areaFolder )
     {
         logUser("loading map");
-        mapFile = mapsFolder + currentArea + "-gh/" + currentArea + ".map";
-        FileOpenResult fileOpenResult = mapView.setMapFile(new File(mapFile));
-        if (!fileOpenResult.isSuccess())
-        {
-            logUser(fileOpenResult.getErrorMessage());
-            finishPrepare();
-            return;
-        }
+        File mapFile = new File(areaFolder, currentArea + ".map");
+
+        mapView.getLayerManager().getLayers().clear();
+
+        TileRendererLayer tileRendererLayer = new TileRendererLayer(tileCache, mapView.getModel().mapViewPosition,
+                true, AndroidGraphicFactory.INSTANCE)
+                {
+                    @Override
+                    public boolean onTap( LatLong tapLatLong, Point layerXY, Point tapXY )
+                    {
+                        return onMapTap(tapLatLong, layerXY, tapXY);
+                    }
+                };
+        tileRendererLayer.setMapFile(mapFile);
+        tileRendererLayer.setTextScale(1.5f);
+        tileRendererLayer.setXmlRenderTheme(InternalRenderTheme.OSMARENDER);
+        mapView.getModel().mapViewPosition.setMapPosition(new MapPosition(tileRendererLayer.getMapDatabase().getMapFileInfo().boundingBox.getCenterPoint(), (byte) 15));
+        mapView.getLayerManager().getLayers().add(tileRendererLayer);
+
         setContentView(mapView);
-        // TODO sometimes the center is wrong
-        mapView.getOverlays().clear();
-        mapView.getOverlays().add(pathOverlay);
         loadGraphStorage();
     }
 
@@ -411,7 +414,7 @@ protected Path saveDoInBackground( Void... v ) throws Exception
             {
                 GraphHopper tmpHopp = new GraphHopper().forMobile();
                 tmpHopp.setCHShortcuts("fastest");
-                tmpHopp.load(mapsFolder + currentArea);
+                tmpHopp.load(new File(mapsFolder, currentArea).getAbsolutePath());
                 log("found graph " + tmpHopp.getGraph().toString() + ", nodes:" + tmpHopp.getGraph().getNodes());
                 hopper = tmpHopp;
                 return null;
@@ -440,31 +443,34 @@ private void finishPrepare()
 
     private Polyline createPolyline( GHResponse response )
     {
-        int points = response.getPoints().getSize();
-        List<GeoPoint> geoPoints = new ArrayList<GeoPoint>(points);
+        Paint paintStroke = AndroidGraphicFactory.INSTANCE.createPaint();
+        paintStroke.setStyle(Style.STROKE);
+        paintStroke.setColor(Color.BLUE);
+        paintStroke.setDashPathEffect(new float[]
+        {
+            25, 15
+        });
+        paintStroke.setStrokeWidth(8);
+
+        // TODO: new mapsforge version wants an mapsforge-paint, not an android paint.
+        // This doesn't seem to support transparceny
+        //paintStroke.setAlpha(128);
+        Polyline line = new Polyline((org.mapsforge.core.graphics.Paint) paintStroke, AndroidGraphicFactory.INSTANCE);
+        List<LatLong> geoPoints = line.getLatLongs();
         PointList tmp = response.getPoints();
         for (int i = 0; i < response.getPoints().getSize(); i++)
         {
-            geoPoints.add(new GeoPoint(tmp.getLatitude(i), tmp.getLongitude(i)));
+            geoPoints.add(new LatLong(tmp.getLatitude(i), tmp.getLongitude(i)));
         }
-        PolygonalChain polygonalChain = new PolygonalChain(geoPoints);
-        Paint paintStroke = new Paint(Paint.ANTI_ALIAS_FLAG);
-        paintStroke.setStyle(Paint.Style.STROKE);
-        paintStroke.setColor(Color.BLUE);
-        paintStroke.setAlpha(128);
-        paintStroke.setStrokeWidth(8);
-        paintStroke.setPathEffect(new DashPathEffect(new float[]
-        {
-            25, 15
-        }, 0));
 
-        return new Polyline(polygonalChain, paintStroke);
+        return line;
     }
 
-    private Marker createMarker( GeoPoint p, int resource )
+    private Marker createMarker( LatLong p, int resource )
     {
         Drawable drawable = getResources().getDrawable(resource);
-        return new Marker(p, Marker.boundCenterBottom(drawable));
+        Bitmap bitmap = AndroidGraphicFactory.convertToBitmap(drawable);
+        return new Marker(p, bitmap, -bitmap.getHeight(), -bitmap.getWidth() / 2);
     }
 
     public void calcPath( final double fromLat, final double fromLon,
@@ -499,8 +505,8 @@ protected void onPostExecute( GHResponse resp )
                     logUser("the route is " + (int) (resp.getDistance() / 100) / 10f
                             + "km long, time:" + resp.getMillis() / 60000f + "min, debug:" + time);
 
-                    pathOverlay.getOverlayItems().add(createPolyline(resp));
-                    mapView.redraw();
+                    mapView.getLayerManager().getLayers().add(createPolyline(resp));
+                    //mapView.redraw();
                 } else
                 {
                     logUser("Error:" + resp.getErrors());
diff --git a/config-example.properties b/config-example.properties
index 4fa91a635e..bae22d556d 100644
--- a/config-example.properties
+++ b/config-example.properties
@@ -23,13 +23,22 @@ prepare.chShortcuts=fastest
 # increase from 1 to 5, to reduce way geometry e.g. for android
 osmreader.wayPointMaxDistance=1
 
-# possible options: CAR,FOOT,BIKE,MTB,RACINGBIKE (comma separated)
-# when using two or three option together remeber to set "prepare.chShortcuts=no" above
-osmreader.acceptWay=CAR
+# possible options: car,foot,bike,mtb,racingbike (comma separated)
+# when using two or three option together remeber to set "prepare.chShortcuts=no" above.
+# There is also a new option bike2 which takes elevation data into account (like up-hill is slower than down-hill)
+# and requires enabling graph.elevation.provider below, see #169
+osmreader.acceptWay=car
 
 # if you want to reduce storage size and you don't need instructions for a path uncomment this
 # osmreader.instructions=false
 
+# To populate your graph with elevation data use SRTM, default is noop
+# graph.elevation.provider=srtm
+# default location for cache is used /tmp/srtm
+# graph.elevation.cachedir=./srtmprovider/
+# If you have a slow disk or plenty of RAM change the default MMAP to
+# graph.elevation.dataaccess=RAM_STORE
+
 ### default algorithm can be overwritten via the URL parameter &algorithm=<algo>
 ### if you use fast routing you have to use dijkstrabi (bidirectional dijkstra)
 #web.defaultAlgorithm=astarbi
diff --git a/core/files/N43E007hgt.zip b/core/files/N43E007hgt.zip
new file mode 100644
index 0000000000..e9e8bc8863
Binary files /dev/null and b/core/files/N43E007hgt.zip differ
diff --git a/core/files/N49E011hgt.zip b/core/files/N49E011hgt.zip
new file mode 100644
index 0000000000..0ffd881667
Binary files /dev/null and b/core/files/N49E011hgt.zip differ
diff --git a/core/files/N55W003hgt.zip b/core/files/N55W003hgt.zip
new file mode 100644
index 0000000000..265f900068
Binary files /dev/null and b/core/files/N55W003hgt.zip differ
diff --git a/core/files/N55W004hgt.zip b/core/files/N55W004hgt.zip
new file mode 100644
index 0000000000..3073befc2f
Binary files /dev/null and b/core/files/N55W004hgt.zip differ
diff --git a/core/files/S29W072hgt.zip b/core/files/S29W072hgt.zip
new file mode 100644
index 0000000000..fb536a1de7
Binary files /dev/null and b/core/files/S29W072hgt.zip differ
diff --git a/core/files/changelog.txt b/core/files/changelog.txt
index d6be490d3c..4841c5e7dc 100644
--- a/core/files/changelog.txt
+++ b/core/files/changelog.txt
@@ -1,4 +1,12 @@
 0.3.0
+    removed isBoth from AbstractFlagEncoder, moved canBeOverwritten and associated test to PrepareEncoder
+    removed unused directory.rename
+    refactor edge.copyProperties into copyPropertiesTo to have similar semantics as Graph.copyTo
+    calcWeight now contains reverse boolean to calculate correct direction dependent weight
+    completely different web API response format. see docs/web
+    swapDirections is renamed to reverseFlags (EncodingManager and FlagEncoders)
+    edgeState.detach has now a reverse parameter, just use false to get previous results
+    web api: buildDate contains now timezone, algoType is replaced with weighting
     dijkstraNative is now dijkstraNativebi
     fixed #151
     calcWeight now contains reverse boolean to calculate correct direction dependent weight
@@ -8,8 +16,7 @@
     the instructions of the web response does not contain times (string) but instead millis (long)
     PrepareContractionHierarchies.setPeriodicUpdates is now in percentage not in absolute counts
     improved bike routing #132, #138, #139, #150
-    gpx export via API, HTTP (route?type=gpx) and web interface is possible: #113, #136, #141
-    breaking: The web response, Path.time and GHResponse.time change to milliseconds and 'long' (instead of seconds and double)
+    gpx export via API, HTTP (route?type=gpx) and web interface is possible: #113, #136, #141   
 
 0.2.0
 23 Nov 2013
diff --git a/core/files/circle-bug.osm.gz b/core/files/circle-bug.osm.gz
new file mode 100644
index 0000000000..b78469536b
Binary files /dev/null and b/core/files/circle-bug.osm.gz differ
diff --git a/core/files/licenses/D3-LICENSE.txt b/core/files/licenses/D3-LICENSE.txt
new file mode 100644
index 0000000000..fb7d95d70b
--- /dev/null
+++ b/core/files/licenses/D3-LICENSE.txt
@@ -0,0 +1,26 @@
+Copyright (c) 2014, Michael Bostock
+All rights reserved.
+
+Redistribution and use in source and binary forms, with or without
+modification, are permitted provided that the following conditions are met:
+
+* Redistributions of source code must retain the above copyright notice, this
+  list of conditions and the following disclaimer.
+
+* Redistributions in binary form must reproduce the above copyright notice,
+  this list of conditions and the following disclaimer in the documentation
+  and/or other materials provided with the distribution.
+
+* The name Michael Bostock may not be used to endorse or promote products
+  derived from this software without specific prior written permission.
+
+THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
+AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
+DISCLAIMED. IN NO EVENT SHALL MICHAEL BOSTOCK BE LIABLE FOR ANY DIRECT,
+INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
+OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
+NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
+EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
diff --git a/core/nbactions.xml b/core/nbactions.xml
index 4b39e8a0be..742874c4cc 100644
--- a/core/nbactions.xml
+++ b/core/nbactions.xml
@@ -18,7 +18,7 @@
         </goals>
         <properties>
             <exec.classpathScope>runtime</exec.classpathScope>
-            <exec.args>-classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=./files/moscow.osm.gz</exec.args>
+            <exec.args>-classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=./files/monaco.osm.gz</exec.args>
             <exec.executable>java</exec.executable>
         </properties>
     </action>
@@ -30,7 +30,7 @@
         </goals>
         <properties>
             <exec.classpathScope>runtime</exec.classpathScope>
-            <exec.args>-Xdebug -Xrunjdwp:transport=dt_socket,server=n,address=${jpda.address} -classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=./files/moscow.osm.gz</exec.args>
+            <exec.args>-Xdebug -Xrunjdwp:transport=dt_socket,server=n,address=${jpda.address} -classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=./files/monaco.osm.gz</exec.args>
             <jpda.listen>true</jpda.listen>
             <exec.executable>java</exec.executable>
         </properties>
@@ -42,7 +42,7 @@
             <goal>org.codehaus.mojo:exec-maven-plugin:1.1.1:exec</goal>
         </goals>
         <properties>
-            <exec.args>-classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=../extract.osm</exec.args>
+            <exec.args>-classpath %classpath com.graphhopper.GraphHopper config=../config.properties osmreader.osm=./files/monaco.osm.gz</exec.args>
             <profiler.action>profile</profiler.action>
             <exec.executable>${profiler.java}</exec.executable>
         </properties>
diff --git a/core/pom.xml b/core/pom.xml
index d6bcbbbe3c..e1dd80cb75 100644
--- a/core/pom.xml
+++ b/core/pom.xml
@@ -20,7 +20,7 @@
         
     <properties>  
         <netbeans.hint.license>apache20</netbeans.hint.license>        
-        <maven.build.timestamp.format>yyyy-MM-dd'T'HH:mm</maven.build.timestamp.format>        
+        <maven.build.timestamp.format>yyyy-MM-dd'T'HH:mm:ssZ</maven.build.timestamp.format>        
         <builddate>${maven.build.timestamp}</builddate>        
     </properties>
     <licenses>
diff --git a/core/src/main/java/com/graphhopper/GHRequest.java b/core/src/main/java/com/graphhopper/GHRequest.java
index f2d487549e..2770c3513d 100644
--- a/core/src/main/java/com/graphhopper/GHRequest.java
+++ b/core/src/main/java/com/graphhopper/GHRequest.java
@@ -18,25 +18,33 @@
 package com.graphhopper;
 
 import com.graphhopper.util.shapes.GHPlace;
+import java.util.ArrayList;
 import java.util.HashMap;
+import java.util.List;
 import java.util.Map;
 
 /**
  * GraphHopper request wrapper to simplify requesting GraphHopper.
  * <p/>
  * @author Peter Karich
+ * @author ratrun
  */
 public class GHRequest
 {
     private String algo = "dijkstrabi";
-    private GHPlace from;
-    private GHPlace to;
-    private Map<String, Object> hints = new HashMap<String, Object>(5);
+    private List<GHPlace> places = new ArrayList<GHPlace>(5);
+    private final Map<String, Object> hints = new HashMap<String, Object>(5);
     private String vehicle = "CAR";
-    private String weighting = "shortest";
+    private String weighting = "fastest";
+    private boolean possibleToAdd = false;
+
+    public GHRequest()
+    {
+        possibleToAdd = true;
+    }
 
     /**
-     * Calculate the path from specified startPoint (fromLat, fromLon) to endPoint (toLat, toLon).
+     * Calculate the path from specified startPlace (fromLat, fromLon) to endPlace (toLat, toLon).
      */
     public GHRequest( double fromLat, double fromLon, double toLat, double toLon )
     {
@@ -44,31 +52,39 @@ public GHRequest( double fromLat, double fromLon, double toLat, double toLon )
     }
 
     /**
-     * Calculate the path from specified startPoint to endPoint.
+     * Calculate the path from specified startPlace to endPlace.
      */
-    public GHRequest( GHPlace startPoint, GHPlace endPoint )
+    public GHRequest( GHPlace startPlace, GHPlace endPlace )
     {
-        this.from = startPoint;
-        this.to = endPoint;
+        if (startPlace == null)
+            throw new IllegalStateException("'from' cannot be null");
+
+        if (endPlace == null)
+            throw new IllegalStateException("'to' cannot be null");
+        places.add(startPlace);
+        places.add(endPlace);
     }
 
-    public void check()
+    public GHRequest( List<GHPlace> places )
     {
-        if (from == null)
-            throw new IllegalStateException("the 'from' point needs to be initialized but was null");
-
-        if (to == null)
-            throw new IllegalStateException("the 'to' point needs to be initialized but was null");
+        this.places = places;
     }
 
-    public GHPlace getFrom()
+    public GHRequest addPlace( GHPlace place )
     {
-        return from;
+        if (place == null)
+            throw new IllegalArgumentException("place cannot be null");
+        if (!possibleToAdd)
+            throw new IllegalStateException("Please call empty constructor if you intent to use "
+                    + "more than two places via addPlace method.");
+
+        places.add(place);
+        return this;
     }
 
-    public GHPlace getTo()
+    public List<GHPlace> getPlaces()
     {
-        return to;
+        return places;
     }
 
     /**
@@ -102,13 +118,30 @@ public GHRequest putHint( String key, Object value )
         if (obj == null)
             return defaultValue;
 
+        if (defaultValue != null && defaultValue instanceof Number)
+        {
+            // what a monster! see #173
+            if (defaultValue instanceof Double)
+                return (T) (Double) ((Number) obj).doubleValue();
+            if (defaultValue instanceof Long)
+                return (T) (Long) ((Number) obj).longValue();
+        }
+
         return (T) obj;
     }
 
     @Override
     public String toString()
     {
-        return from + " " + to + " (" + algo + ")";
+        String res = "";
+        for (GHPlace place : places)
+        {
+            if (res.isEmpty())
+                res = place.toString();
+            else
+                res += "; " + place.toString();
+        }
+        return res + "(" + algo + ")";
     }
 
     /**
diff --git a/core/src/main/java/com/graphhopper/GHResponse.java b/core/src/main/java/com/graphhopper/GHResponse.java
index 2693acfe55..f45cab8e7f 100644
--- a/core/src/main/java/com/graphhopper/GHResponse.java
+++ b/core/src/main/java/com/graphhopper/GHResponse.java
@@ -49,6 +49,11 @@ public GHResponse setPoints( PointList points )
         return this;
     }
 
+    /**
+     * This method returns all points on the path. Keep in mind that calculating the distance from
+     * these point might yield different results compared to getDistance as points could have been
+     * simplified on import or after querying.
+     */
     public PointList getPoints()
     {
         return list;
@@ -61,6 +66,9 @@ public GHResponse setDistance( double distance )
     }
 
     /**
+     * This method returns the distance of the path. Always prefer this method over
+     * getPoints().calcDistance
+     * <p>
      * @return distance in meter
      */
     public double getDistance()
@@ -158,10 +166,10 @@ public String toString()
         String str = "found:" + isFound() + ", nodes:" + list.getSize() + ": " + list.toString();
         if (!instructions.isEmpty())
             str += ", " + instructions.toString();
-        
-        if (!errors.isEmpty())            
+
+        if (!errors.isEmpty())
             str += ", " + errors.toString();
-        
+
         return str;
     }
 
diff --git a/core/src/main/java/com/graphhopper/GraphHopper.java b/core/src/main/java/com/graphhopper/GraphHopper.java
index c9dfb00ed8..94adba94de 100644
--- a/core/src/main/java/com/graphhopper/GraphHopper.java
+++ b/core/src/main/java/com/graphhopper/GraphHopper.java
@@ -17,7 +17,10 @@
  */
 package com.graphhopper;
 
+import com.graphhopper.reader.DataReader;
 import com.graphhopper.reader.OSMReader;
+import com.graphhopper.reader.dem.ElevationProvider;
+import com.graphhopper.reader.dem.SRTMProvider;
 import com.graphhopper.routing.Path;
 import com.graphhopper.routing.RoutingAlgorithm;
 import com.graphhopper.routing.ch.PrepareContractionHierarchies;
@@ -25,15 +28,20 @@
 import com.graphhopper.storage.*;
 import com.graphhopper.storage.index.*;
 import com.graphhopper.util.*;
+import com.graphhopper.util.shapes.GHPlace;
 
 import java.io.File;
 import java.io.IOException;
+import java.text.SimpleDateFormat;
+import java.util.ArrayList;
+import java.util.Date;
+import java.util.List;
 
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
 /**
- * Main wrapper of the offline API for a simple and efficient usage.
+ * Easy to use access point to configure import and (offline) routing.
  * <p/>
  * @see GraphHopperAPI
  * @author Peter Karich
@@ -54,12 +62,13 @@ public static void main( String[] strs ) throws Exception
     // for graph:
     private GraphStorage graph;
     private String ghLocation = "";
-    private DAType dataAccessType = DAType.RAM;
+    private DAType dataAccessType = DAType.RAM_STORE;
     private boolean sortGraph = false;
     boolean removeZipped = true;
-    // for routing:
+    private int dimension = 2;
+    // for routing
     private boolean simplifyRequest = true;
-    // for index:
+    // for index
     private LocationIndex locationIndex;
     private int preciseIndexResolution = 500;
     private boolean searchRegion = true;
@@ -74,10 +83,9 @@ public static void main( String[] strs ) throws Exception
     private int lazyUpdates = 10;
     private int neighborUpdates = 20;
     private double logMessages = 20;
-    // for OSM import:
+    // for OSM import
     private String osmFile;
     private EncodingManager encodingManager;
-    private long expectedCapacity = 100;
     private double wayPointMaxDistance = 1;
     private int workerThreads = -1;
     private int defaultSegmentSize = -1;
@@ -85,6 +93,7 @@ public static void main( String[] strs ) throws Exception
     private boolean enableInstructions = true;
     private boolean calcPoints = true;
     private boolean fullyLoaded = false;
+    private ElevationProvider eleProvider = ElevationProvider.NOOP;
 
     public GraphHopper()
     {
@@ -117,6 +126,38 @@ public EncodingManager getEncodingManager()
         return encodingManager;
     }
 
+    public GraphHopper setElevationProvider( ElevationProvider eleProvider )
+    {
+        if (eleProvider == null || eleProvider == ElevationProvider.NOOP)
+            set3D(false);
+        else
+            set3D(true);
+        this.eleProvider = eleProvider;
+        return this;
+    }
+
+    /**
+     * Threads for data reading.
+     */
+    protected int getWorkerThreads()
+    {
+        return workerThreads;
+    }
+
+    /**
+     * Return maximum distance (in meter) to reduce points via douglas peucker while OSM import.
+     */
+    protected double getWayPointMaxDistance()
+    {
+        return wayPointMaxDistance;
+    }
+
+    public GraphHopper setWayPointMaxDistance( double wayPointMaxDistance )
+    {
+        this.wayPointMaxDistance = wayPointMaxDistance;
+        return this;
+    }
+
     /**
      * Configures the underlying storage to be used on a well equipped server.
      */
@@ -166,6 +207,8 @@ public GraphHopper setPreciseIndexResolution( int precision )
      * This method call results in an in-memory graph. Specify storeOnFlush to true if you want that
      * existing data will be loaded FROM disc and all in-memory data will be flushed TO disc after
      * flush is called e.g. while OSM import.
+     * <p>
+     * @param storeOnFlush true by default
      */
     public GraphHopper setInMemory( boolean storeOnFlush )
     {
@@ -241,6 +284,26 @@ public boolean isCHEnabled()
         return chEnabled;
     }
 
+    /**
+     * @return true if storing and fetching elevation data is enabled. Default is false
+     */
+    public boolean is3D()
+    {
+        return dimension == 3;
+    }
+
+    /**
+     * Enable storing and fetching elevation data. Default is false
+     */
+    public GraphHopper set3D( boolean is3D )
+    {
+        if (is3D)
+            this.dimension = 3;
+        else
+            this.dimension = 2;
+        return this;
+    }
+
     /**
      * @return if import of turn restrictions is enabled
      */
@@ -331,7 +394,7 @@ public String getOSMFile()
      * <p>
      * @throws IllegalStateException if graph is not instantiated.
      */
-    public Graph getGraph()
+    public GraphStorage getGraph()
     {
         if (graph == null)
             throw new IllegalStateException("Graph not initialized");
@@ -377,7 +440,7 @@ public GraphHopper setSortGraph( boolean sortGraph )
      */
     protected CmdArgs mergeArgsFromConfig( CmdArgs args ) throws IOException
     {
-        if (!Helper.isEmpty(args.get("config", "")))
+        if (Helper.isEmpty(args.get("config", "")))
         {
             CmdArgs tmp = CmdArgs.readFromConfig(args.get("config", ""), "graphhopper.config");
             tmp.merge(args);
@@ -409,25 +472,11 @@ public GraphHopper init( CmdArgs args ) throws IOException
 
         // graph
         setGraphHopperLocation(graphHopperFolder);
-        expectedCapacity = args.getLong("graph.expectedCapacity", expectedCapacity);
         defaultSegmentSize = args.getInt("graph.dataaccess.segmentSize", defaultSegmentSize);
-        String dataAccess = args.get("graph.dataaccess", "RAM_STORE").toUpperCase();
-        if (dataAccess.contains("MMAP"))
-        {
-            setMemoryMapped();
-        } else if (dataAccess.contains("UNSAFE"))
-        {
-            setUnsafeMemory();
-        } else
-        {
-            if (dataAccess.contains("RAM_STORE"))
-                setInMemory(true);
-            else
-                setInMemory(false);
-        }
+        dimension = args.getInt("graph.dimension", dimension);
 
-        if (dataAccess.contains("SYNC"))
-            dataAccessType = new DAType(dataAccessType, true);
+        String graphDATypeStr = args.get("graph.dataaccess", "RAM_STORE");
+        dataAccessType = DAType.fromString(graphDATypeStr);
 
         sortGraph = args.getBool("graph.doSort", sortGraph);
         removeZipped = args.getBool("graph.removeZipped", removeZipped);
@@ -456,6 +505,23 @@ public GraphHopper init( CmdArgs args ) throws IOException
         workerThreads = args.getInt("osmreader.workerThreads", workerThreads);
         enableInstructions = args.getBool("osmreader.instructions", enableInstructions);
 
+        // elevation
+        String eleProviderStr = args.get("graph.elevation.provider", "noop").toLowerCase();
+        String cacheDirStr = args.get("graph.elevation.cachedir", "");
+        String baseURL = args.get("graph.elevation.baseurl", "");
+        DAType elevationDAType = DAType.fromString(args.get("graph.elevation.dataaccess", "MMAP"));
+        ElevationProvider tmpProvider = ElevationProvider.NOOP;
+        if (eleProviderStr.equalsIgnoreCase("srtm"))
+            tmpProvider = new SRTMProvider();
+        // later:
+//        else if(eleProviderStr.startsWith("cgiar:"))        
+//            eleProvider = new CGIARProvider().setCacheDir(new File());        
+
+        tmpProvider.setCacheDir(new File(cacheDirStr));
+        tmpProvider.setBaseURL(baseURL);
+        tmpProvider.setInMemory(elevationDAType.isInMemory());
+        setElevationProvider(tmpProvider);
+
         // index
         preciseIndexResolution = args.getInt("index.highResolution", preciseIndexResolution);
         return this;
@@ -476,9 +542,6 @@ public GraphHopper importOrLoad()
     {
         if (!load(ghLocation))
         {
-            if (osmFile == null)
-                throw new IllegalStateException("Couldn't load from existing folder: " + ghLocation
-                        + " but also cannot import from OSM file as it wasn't specified!");
             printInfo();
             process(ghLocation);
         } else
@@ -496,7 +559,8 @@ private GraphHopper process( String graphHopperLocation )
         setGraphHopperLocation(graphHopperLocation);
         try
         {
-            importOSM();
+            importData();
+            graph.getProperties().put("osmreader.import.date", formatDateTime(new Date()));
         } catch (IOException ex)
         {
             throw new RuntimeException("Cannot parse OSM file " + getOSMFile(), ex);
@@ -508,23 +572,44 @@ private GraphHopper process( String graphHopperLocation )
         return this;
     }
 
-    protected OSMReader importOSM() throws IOException
+    protected DataReader importData() throws IOException
     {
         if (graph == null)
             throw new IllegalStateException("Load graph before importing OSM data");
 
         if (osmFile == null)
-            throw new IllegalArgumentException("No OSM file specified");
+            throw new IllegalStateException("Couldn't load from existing folder: " + ghLocation
+                    + " but also cannot import from OSM file as it wasn't specified!");
 
-        File osmTmpFile = new File(osmFile);
-        logger.info("start creating graph from " + osmFile);
-        OSMReader reader = new OSMReader(graph, expectedCapacity).setWorkerThreads(workerThreads).setEncodingManager(encodingManager)
-                .setWayPointMaxDistance(wayPointMaxDistance).setEnableInstructions(enableInstructions);
+        if (encodingManager == null)
+            throw new IllegalStateException("Missing encoding manager");
+
+        encodingManager.setEnableInstructions(enableInstructions);
+        DataReader reader = createReader(graph);
         logger.info("using " + graph.toString() + ", memory:" + Helper.getMemInfo());
-        reader.doOSM2Graph(osmTmpFile);
+        reader.readGraph();
         return reader;
     }
 
+    protected DataReader createReader( GraphStorage tmpGraph )
+    {
+        return initOSMReader(new OSMReader(tmpGraph));
+    }
+
+    protected OSMReader initOSMReader( OSMReader reader )
+    {
+        if (osmFile == null)
+            throw new IllegalArgumentException("No OSM file specified");
+
+        logger.info("start creating graph from " + osmFile);
+        File osmTmpFile = new File(osmFile);
+        return reader.setOSMFile(osmTmpFile).
+                setElevationProvider(eleProvider).
+                setWorkerThreads(workerThreads).
+                setEncodingManager(encodingManager).
+                setWayPointMaxDistance(wayPointMaxDistance);
+    }
+
     /**
      * Opens existing graph.
      * <p/>
@@ -570,16 +655,16 @@ public boolean load( String graphHopperFolder )
         GHDirectory dir = new GHDirectory(ghLocation, dataAccessType);
 
         if (chEnabled)
-            graph = new LevelGraphStorage(dir, encodingManager);
+            graph = new LevelGraphStorage(dir, encodingManager, is3D());
         else if (turnCosts)
-            graph = new GraphHopperStorage(dir, encodingManager, new TurnCostStorage());
+            graph = new GraphHopperStorage(dir, encodingManager, is3D(), new TurnCostStorage());
         else
-            graph = new GraphHopperStorage(dir, encodingManager);
+            graph = new GraphHopperStorage(dir, encodingManager, is3D());
 
         graph.setSegmentSize(defaultSegmentSize);
         if (!graph.loadExisting())
             return false;
-        
+
         postProcessing();
         fullyLoaded = true;
         return true;
@@ -630,13 +715,10 @@ protected Weighting createWeighting( String weighting, FlagEncoder encoder )
     @Override
     public GHResponse route( GHRequest request )
     {
-        request.check();
         if (graph == null || !fullyLoaded)
             throw new IllegalStateException("Call load or importOrLoad before routing");
 
-        StopWatch sw = new StopWatch().start();
         GHResponse rsp = new GHResponse();
-
         if (!encodingManager.supports(request.getVehicle()))
         {
             rsp.addError(new IllegalArgumentException("Vehicle " + request.getVehicle() + " unsupported. Supported are: "
@@ -644,80 +726,91 @@ public GHResponse route( GHRequest request )
             return rsp;
         }
 
+        List<GHPlace> places = request.getPlaces();
+        if (places.size() < 2)
+        {
+            rsp.addError(new IllegalStateException("At least 2 points has to be specified, but was:" + places.size()));
+            return rsp;
+        }
+
         FlagEncoder encoder = encodingManager.getEncoder(request.getVehicle());
         EdgeFilter edgeFilter = new DefaultEdgeFilter(encoder);
-        QueryResult fromRes = locationIndex.findClosest(request.getFrom().lat, request.getFrom().lon, edgeFilter);
-        QueryResult toRes = locationIndex.findClosest(request.getTo().lat, request.getTo().lon, edgeFilter);
-
-        String debug = "idLookup:" + sw.stop().getSeconds() + "s";
-
+        GHPlace startPlace = request.getPlaces().get(0);
+        StopWatch sw = new StopWatch().start();
+        QueryResult fromRes = locationIndex.findClosest(startPlace.lat, startPlace.lon, edgeFilter);
+        sw.stop();
         if (!fromRes.isValid())
-            rsp.addError(new IllegalArgumentException("Cannot find point 1: " + request.getFrom()));
-
-        if (!toRes.isValid())
-            rsp.addError(new IllegalArgumentException("Cannot find point 2: " + request.getTo()));
+            rsp.addError(new IllegalArgumentException("Cannot find point 0: " + startPlace));
 
-        sw = new StopWatch().start();
-        RoutingAlgorithm algo = null;
-        if (chEnabled)
+        List<Path> paths = new ArrayList<Path>(places.size() - 1);
+        String debug = "";
+        for (int placeIndex = 1; placeIndex < request.getPlaces().size(); placeIndex++)
         {
-            if (prepare == null)
-                throw new IllegalStateException(
-                        "Preparation object is null. CH-preparation wasn't done or did you forgot to call disableCHShortcuts()?");
-
-            if (request.getAlgorithm().equals("dijkstrabi"))
+            GHPlace place = request.getPlaces().get(placeIndex);
+            sw.start();
+            QueryResult toRes = locationIndex.findClosest(place.lat, place.lon, edgeFilter);
+            debug += "[" + placeIndex + "]";
+            debug += ", idLookup:" + sw.stop().getSeconds() + "s";
+            if (!toRes.isValid())
+                rsp.addError(new IllegalArgumentException("Cannot find point " + placeIndex + ": " + place));
+
+            if (rsp.hasErrors())
+                return rsp;
+
+            sw = new StopWatch().start();
+            RoutingAlgorithm algo = null;
+            if (chEnabled)
+            {
+                if (prepare == null)
+                    throw new IllegalStateException("Preparation object is null. CH-preparation wasn't done or did you "
+                            + "forgot to call disableCHShortcuts()?");
+
+                if (request.getAlgorithm().equals("dijkstrabi"))
+                    algo = prepare.createAlgo();
+                else if (request.getAlgorithm().equals("astarbi"))
+                    algo = ((PrepareContractionHierarchies) prepare).createAStar();
+                else
+                {
+                    rsp.addError(new IllegalStateException(
+                            "Only dijkstrabi and astarbi is supported for LevelGraph (using contraction hierarchies)!"));
+                    return rsp;
+                }
+            } else
+            {
+                Weighting weighting = createWeighting(request.getWeighting(), encoder);
+                prepare = NoOpAlgorithmPreparation.createAlgoPrepare(graph, request.getAlgorithm(), encoder, weighting);
                 algo = prepare.createAlgo();
-            else if (request.getAlgorithm().equals("astarbi"))
-                algo = ((PrepareContractionHierarchies) prepare).createAStar();
-            else
-                rsp.addError(new IllegalStateException(
-                        "Only dijkstrabi and astarbi is supported for LevelGraph (using contraction hierarchies)!"));
-
-        } else
-        {
-            Weighting weighting = createWeighting(request.getWeighting(), encoder);
-            prepare = NoOpAlgorithmPreparation.createAlgoPrepare(graph, request.getAlgorithm(), encoder, weighting);
-            algo = prepare.createAlgo();
-        }
-
-        if (rsp.hasErrors())
-            return rsp;
+            }
 
-        debug += ", algoInit:" + sw.stop().getSeconds() + "s";
-        sw = new StopWatch().start();
+            debug += ", algoInit:" + sw.stop().getSeconds() + "s";
+            sw = new StopWatch().start();
 
-        Path path = algo.calcPath(fromRes, toRes);
-        debug += ", " + algo.getName() + "-routing:" + sw.stop().getSeconds() + "s, " + path.getDebugInfo();
+            Path path = algo.calcPath(fromRes, toRes);
+            if (path.getMillis() < 0)
+                throw new RuntimeException("Time was negative. Please report as bug and include:" + request);
+                
+            paths.add(path);
+            debug += ", " + algo.getName() + "-routing:" + sw.stop().getSeconds() + "s, " + path.getDebugInfo();
+            fromRes = toRes;
+        }
 
+        enableInstructions = request.getHint("instructions", enableInstructions);
         calcPoints = request.getHint("calcPoints", calcPoints);
-        if (calcPoints)
-        {
-            PointList points = path.calcPoints();
-            rsp.setFound(points.getSize() > 1);
-            simplifyRequest = request.getHint("simplifyRequest", simplifyRequest);
-            if (simplifyRequest)
-            {
-                sw = new StopWatch().start();
-                int orig = points.getSize();
-                double minPathPrecision = request.getHint("douglas.minprecision", 1d);
-                if (minPathPrecision > 0)
-                    new DouglasPeucker().setMaxDistance(minPathPrecision).simplify(points);
+        simplifyRequest = request.getHint("simplifyRequest", simplifyRequest);
+        double minPathPrecision = request.getHint("douglas.minprecision", 1d);
+        DouglasPeucker peucker = new DouglasPeucker().setMaxDistance(minPathPrecision);
+        rsp.setDebugInfo(debug);
 
-                debug += ", simplify (" + orig + "->" + points.getSize() + "):" + sw.stop().getSeconds() + "s";
-            }
-            rsp.setPoints(points);
+        if (places.size() - 1 != paths.size())
+            throw new RuntimeException("There should be exactly one more places than paths. places:" + places.size() + ", paths:" + paths.size());
 
-            enableInstructions = request.getHint("instructions", enableInstructions);
-            if (enableInstructions)
-            {
-                sw = new StopWatch().start();
-                rsp.setInstructions(path.calcInstructions());
-                debug += ", instructions:" + sw.stop().getSeconds() + "s";
-            }
-        } else
-            rsp.setFound(path.isFound());
-
-        return rsp.setDistance(path.getDistance()).setMillis(path.getMillis()).setDebugInfo(debug);
+        new PathMerger().
+                setCalcPoints(calcPoints).
+                setDouglasPeucker(peucker).
+                setEnableInstructions(enableInstructions).
+                setSimplifyRequest(simplifyRequest && minPathPrecision > 0).
+                doWork(rsp, paths);
+        return rsp;
     }
 
     protected LocationIndex createLocationIndex( Directory dir )
@@ -792,6 +885,7 @@ protected void prepare()
 
             logger.info("calling prepare.doWork ... (" + Helper.getMemInfo() + ")");
             prepare.doWork();
+            graph.getProperties().put("prepare.date", formatDateTime(new Date()));
         }
         graph.getProperties().put("prepare.done", tmpPrepare);
     }
@@ -834,4 +928,11 @@ protected void ensureNotLoaded()
         if (fullyLoaded)
             throw new IllegalStateException("No configuration changes are possible after loading the graph");
     }
+
+    // make sure this is identical to buildDate used in pom.xml
+    // <maven.build.timestamp.format>yyyy-MM-dd'T'HH:mm:ssZ</maven.build.timestamp.format>
+    private String formatDateTime( Date date )
+    {
+        return new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ").format(date);
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/GraphHopperAPI.java b/core/src/main/java/com/graphhopper/GraphHopperAPI.java
index 338f86506f..5f81b8344f 100644
--- a/core/src/main/java/com/graphhopper/GraphHopperAPI.java
+++ b/core/src/main/java/com/graphhopper/GraphHopperAPI.java
@@ -24,12 +24,12 @@
  * <pre>
  *
  * // init offline graph
- * GraphHopperAPI gh = new GraphHopper().setInMemory(true, true);
+ * GraphHopperAPI gh = new GraphHopper().setInMemory(true);
  * gh.load("graph-hopper-folder");
  *
  * // init online service
  * GraphHopperAPI gh = new GraphHopperWeb();
- * gh.load("http://your-graphhopper-service.com/api");
+ * gh.load("http://your-graphhopper-service.com");
  *
  * gh.algorithm("astar");
  * GHResponse ph = gh.route(new GHRequest(new GHPoint(fromLat, fromLon), new GHPoint(toLat, toLon)));
@@ -54,7 +54,7 @@
     boolean load( String urlOrFile );
 
     /**
-     * Calculates the path from specified request with startPoint to endPoint.
+     * Calculates the path from specified request visiting the specified locations.
      * <p/>
      * @return the response with the route and possible errors
      */
diff --git a/core/src/main/java/com/graphhopper/coll/IntDoubleBinHeap.java b/core/src/main/java/com/graphhopper/coll/IntDoubleBinHeap.java
index 523a8a22d8..76ec7291cf 100644
--- a/core/src/main/java/com/graphhopper/coll/IntDoubleBinHeap.java
+++ b/core/src/main/java/com/graphhopper/coll/IntDoubleBinHeap.java
@@ -51,10 +51,11 @@ public int getSize()
         return size;
     }
 
-    public int size() {
+    public int size()
+    {
         return size;
     }
-    
+
     @Override
     public boolean isEmpty()
     {
diff --git a/core/src/main/java/com/graphhopper/geohash/KeyAlgo.java b/core/src/main/java/com/graphhopper/geohash/KeyAlgo.java
index c4045989e1..c25281b989 100644
--- a/core/src/main/java/com/graphhopper/geohash/KeyAlgo.java
+++ b/core/src/main/java/com/graphhopper/geohash/KeyAlgo.java
@@ -20,21 +20,22 @@
 import com.graphhopper.util.shapes.CoordTrig;
 
 /**
- * Defines the mapping between a one dimensional 'number' and a point (lat, lon)
- * which is limited to a defined bounds.
+ * Defines the mapping between a one dimensional 'number' and a point (lat, lon) which is limited to
+ * a defined bounds.
  * <p/>
  * @author Peter Karich
  */
-public interface KeyAlgo {
+public interface KeyAlgo
+{
 
     /**
      * Sets the bounds of the underlying key algorithm.
      */
-    KeyAlgo setBounds(double minLonInit, double maxLonInit, double minLatInit, double maxLatInit);
+    KeyAlgo setBounds( double minLonInit, double maxLonInit, double minLatInit, double maxLatInit );
 
-    long encode(CoordTrig coord);
+    long encode( CoordTrig coord );
 
-    long encode(double lat, double lon);
+    long encode( double lat, double lon );
 
-    void decode(long spatialKey, CoordTrig latLon);
+    void decode( long spatialKey, CoordTrig latLon );
 }
diff --git a/core/src/main/java/com/graphhopper/geohash/LinearKeyAlgo.java b/core/src/main/java/com/graphhopper/geohash/LinearKeyAlgo.java
index 32e1d36ff6..11c58733b5 100644
--- a/core/src/main/java/com/graphhopper/geohash/LinearKeyAlgo.java
+++ b/core/src/main/java/com/graphhopper/geohash/LinearKeyAlgo.java
@@ -87,8 +87,8 @@ public final long encode( double lat, double lon )
         lat = Math.min(Math.max(lat, bounds.minLat), bounds.maxLat);
         lon = Math.min(Math.max(lon, bounds.minLon), bounds.maxLon);
         // introduce a minor correction to round to lower grid entry!
-        int latIndex = (int) ((lat - bounds.minLat) / latDelta * C);
-        int lonIndex = (int) ((lon - bounds.minLon) / lonDelta * C);
+        long latIndex = (long) ((lat - bounds.minLat) / latDelta * C);
+        long lonIndex = (long) ((lon - bounds.minLon) / lonDelta * C);
         return latIndex * lonUnits + lonIndex;
     }
 
@@ -105,4 +105,14 @@ public final void decode( long linearKey, CoordTrig latLon )
         latLon.lat = lat + latDelta / 2;
         latLon.lon = lon + lonDelta / 2;
     }
+
+    public double getLatDelta()
+    {
+        return latDelta;
+    }
+
+    public double getLonDelta()
+    {
+        return lonDelta;
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/trees/CoordResolver.java b/core/src/main/java/com/graphhopper/reader/DataReader.java
similarity index 51%
rename from core/src/main/java/com/graphhopper/trees/CoordResolver.java
rename to core/src/main/java/com/graphhopper/reader/DataReader.java
index 37ebd8051c..d820a2ab7f 100644
--- a/core/src/main/java/com/graphhopper/trees/CoordResolver.java
+++ b/core/src/main/java/com/graphhopper/reader/DataReader.java
@@ -1,29 +1,30 @@
 /*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
  *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
  *       http://www.apache.org/licenses/LICENSE-2.0
- * 
+ *
  *  Unless required by applicable law or agreed to in writing, software
  *  distributed under the License is distributed on an "AS IS" BASIS,
  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  *  See the License for the specific language governing permissions and
  *  limitations under the License.
  */
-package com.graphhopper.trees;
+package com.graphhopper.reader;
 
-import com.graphhopper.util.shapes.CoordTrig;
-import java.util.Collection;
+import java.io.IOException;
 
 /**
  * @author Peter Karich
  */
-public interface CoordResolver<T>
+public interface DataReader
 {
-    void add( Collection<CoordTrig<T>> coll, int edgeId );
+
+    void readGraph() throws IOException;
 }
diff --git a/core/src/main/java/com/graphhopper/reader/OSMElement.java b/core/src/main/java/com/graphhopper/reader/OSMElement.java
index 80688dd43c..a943eec8cb 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMElement.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMElement.java
@@ -22,34 +22,23 @@
 import javax.xml.stream.XMLStreamReader;
 import java.util.HashMap;
 import java.util.Map;
+import java.util.Map.Entry;
 import java.util.Set;
 
 /**
  * Base class for all OSM objects
  * <p/>
  * @author Nop
+ * @author Peter
  */
 public abstract class OSMElement
 {
     public static final int NODE = 0;
     public static final int WAY = 1;
     public static final int RELATION = 2;
-    protected final int type;
-    protected final long id;
-    protected Map<String, String> tags;
-    protected Map<String, Object> iProperties;
-
-    public OSMElement( long id, int type, XMLStreamReader parser )
-    {
-        this.type = type;
-        this.id = id;
-    }
-
-    public OSMElement( long id, int type, Map<String, String> tags )
-    {
-        this(id, type);
-        this.tags = tags;
-    }
+    private final int type;
+    private final long id;
+    private final Map<String, Object> properties = new HashMap<String, Object>(5);
 
     protected OSMElement( long id, int type )
     {
@@ -62,15 +51,6 @@ public long getId()
         return id;
     }
 
-    public void copyTags( OSMElement input )
-    {
-        if (input.hasTags())
-        {
-            tags = new HashMap<String, String>();
-            tags.putAll(input.getTags());
-        }
-    }
-
     protected void readTags( XMLStreamReader parser ) throws XMLStreamException
     {
         int event = parser.getEventType();
@@ -83,15 +63,7 @@ protected void readTags( XMLStreamReader parser ) throws XMLStreamException
                 String value = parser.getAttributeValue(null, "v");
                 // ignore tags with empty values
                 if (value != null && value.length() > 0)
-                {
-                    // create map only if needed
-                    if (tags == null)
-                    {
-                        tags = new HashMap<String, String>();
-                    }
-
-                    tags.put(key, value);
-                }
+                    setTag(key, value);
             }
 
             event = parser.nextTag();
@@ -100,13 +72,11 @@ protected void readTags( XMLStreamReader parser ) throws XMLStreamException
 
     protected String tagsToString()
     {
-        if (tags == null)
-        {
+        if (properties.isEmpty())
             return "<empty>";
-        }
 
         StringBuilder tagTxt = new StringBuilder();
-        for (Map.Entry<String, String> entry : tags.entrySet())
+        for (Map.Entry<String, Object> entry : properties.entrySet())
         {
             tagTxt.append(entry.getKey());
             tagTxt.append("=");
@@ -116,47 +86,51 @@ protected String tagsToString()
         return tagTxt.toString();
     }
 
-    public Map<String, String> getTags()
+    protected Map<String, Object> getTags()
     {
-        return tags;
+        return properties;
     }
 
-    public void replaceTags( HashMap<String, String> newTags )
+    public void setTags( Map<String, String> newTags )
     {
-        tags = newTags;
+        properties.clear();
+        if (newTags != null)
+            for (Entry<String, String> e : newTags.entrySet())
+            {
+                setTag(e.getKey(), e.getValue());
+            }
     }
 
     public boolean hasTags()
     {
-        return tags != null && !tags.isEmpty();
+        return !properties.isEmpty();
     }
 
     public String getTag( String name )
     {
-        if (tags == null)
-            return null;
-
-        return tags.get(name);
+        return (String) properties.get(name);
     }
 
-    public void setTag( String name, String value )
+    @SuppressWarnings("unchecked")
+    public <T> T getTag( String key, T defaultValue )
     {
-        if (tags == null)
-            tags = new HashMap<String, String>();
+        T val = (T) properties.get(key);
+        if (val == null)
+            return defaultValue;
+        return val;
+    }
 
-        tags.put(name, value);
+    public void setTag( String name, Object value )
+    {
+        properties.put(name, value);
     }
 
     /**
      * Chaeck that the object has a given tag with a given value.
      */
-    public boolean hasTag( String key, String value )
+    public boolean hasTag( String key, Object value )
     {
-        if (tags == null)
-            return false;
-
-        String val = tags.get(key);
-        return value.equals(val);
+        return value.equals(properties.get(key));
     }
 
     /**
@@ -165,10 +139,7 @@ public boolean hasTag( String key, String value )
      */
     public boolean hasTag( String key, String... values )
     {
-        if (tags == null)
-            return false;
-
-        String osmValue = tags.get(key);
+        Object osmValue = properties.get(key);
         if (osmValue == null)
             return false;
 
@@ -189,11 +160,7 @@ public boolean hasTag( String key, String... values )
      */
     public final boolean hasTag( String key, Set<String> values )
     {
-        if (tags == null)
-            return false;
-
-        String osmValue = tags.get(key);
-        return osmValue != null && values.contains(osmValue);
+        return values.contains(properties.get(key));
     }
 
     /**
@@ -202,53 +169,22 @@ public final boolean hasTag( String key, Set<String> values )
      */
     public boolean hasTag( String[] keyList, Set<String> values )
     {
-        if (tags == null)
-            return false;
-
-        for (int i = 0; i < keyList.length; i++)
+        for (String key : keyList)
         {
-            String osmValue = tags.get(keyList[i]);
-            if (osmValue != null && values.contains(osmValue))
+            if (values.contains(properties.get(key)))
                 return true;
         }
         return false;
     }
 
-    public void setInternalTag( String key, Object value )
-    {
-        if (iProperties == null)
-            iProperties = new HashMap<String, Object>();
-
-        iProperties.put(key, value);
-    }
-
-    public boolean hasInternalTag( String key )
-    {
-        if (iProperties == null)
-            return false;
-        return iProperties.containsKey(key);
-    }
-
-    @SuppressWarnings("unchecked")
-    public <T> T getInternalTag( String key, T defaultValue )
-    {
-        if (iProperties == null)
-            return defaultValue;
-        T val = (T) iProperties.get(key);
-        if (val == null)
-            return defaultValue;
-        return val;
-    }
-
     public void removeTag( String name )
     {
-        if (tags != null)
-            tags.remove(name);
+        properties.remove(name);
     }
 
     public void clearTags()
     {
-        tags = null;
+        properties.clear();
     }
 
     public int getType()
diff --git a/core/src/main/java/com/graphhopper/reader/OSMInputFile.java b/core/src/main/java/com/graphhopper/reader/OSMInputFile.java
index a3cb041a35..03549347dc 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMInputFile.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMInputFile.java
@@ -192,18 +192,18 @@ private OSMElement getNextXML() throws XMLStreamException
                         if ("node".equals(name))
                         {
                             id = Long.parseLong(parser.getAttributeValue(null, "id"));
-                            return new OSMNode(id, parser);
+                            return OSMNode.create(id, parser);
                         }
                         break;
 
                     case 'w':
                     {
                         id = Long.parseLong(parser.getAttributeValue(null, "id"));
-                        return new OSMWay(id, parser);
+                        return OSMWay.create(id, parser);
                     }
                     case 'r':
                         id = Long.parseLong(parser.getAttributeValue(null, "id"));
-                        return new OSMRelation(id, parser);
+                        return OSMRelation.create(id, parser);
                 }
             }
             event = parser.next();
diff --git a/core/src/main/java/com/graphhopper/reader/OSMNode.java b/core/src/main/java/com/graphhopper/reader/OSMNode.java
index f990e7c6e9..d8153cbea4 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMNode.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMNode.java
@@ -17,9 +17,9 @@
  */
 package com.graphhopper.reader;
 
+import com.graphhopper.util.PointAccess;
 import javax.xml.stream.XMLStreamException;
 import javax.xml.stream.XMLStreamReader;
-import java.util.Map;
 
 /**
  * Represents an OSM Node
@@ -28,26 +28,28 @@
  */
 public class OSMNode extends OSMElement
 {
-    private double lat;
-    private double lon;
+    private final double lat;
+    private final double lon;
 
-    public OSMNode( long id, XMLStreamReader parser ) throws XMLStreamException
+    public static OSMNode create( long id, XMLStreamReader parser ) throws XMLStreamException
     {
-        super(id, NODE, parser);
-
-        // read location
-        lat = Double.parseDouble(parser.getAttributeValue(null, "lat"));
-        lon = Double.parseDouble(parser.getAttributeValue(null, "lon"));
+        OSMNode node = new OSMNode(id,
+                Double.parseDouble(parser.getAttributeValue(null, "lat")),
+                Double.parseDouble(parser.getAttributeValue(null, "lon")));
 
         parser.nextTag();
-        readTags(parser);
+        node.readTags(parser);
+        return node;
     }
 
-    public OSMNode( long id, Map<String, String> tags, double lat, double lon )
+    public OSMNode( long id, PointAccess pointAccess, int accessId )
     {
-        super(id, NODE, tags);
-        this.lat = lat;
-        this.lon = lon;
+        super(id, NODE);
+
+        this.lat = pointAccess.getLatitude(accessId);
+        this.lon = pointAccess.getLongitude(accessId);
+        if (pointAccess.is3D())
+            setTag("ele", pointAccess.getElevation(accessId));
     }
 
     public OSMNode( long id, double lat, double lon )
@@ -68,27 +70,57 @@ public double getLon()
         return lon;
     }
 
+    public double getEle()
+    {
+        Object ele = getTags().get("ele");
+        if (ele == null)
+            return Double.NaN;
+        return (Double) ele;
+    }
+
     @Override
-    public String toString()
+    public void setTag( String name, Object value )
     {
-        if (tags == null)
+        if ("ele".equals(name))
         {
-            return "Node (" + id + ")";
-        } else
+            if (value == null)
+                value = null;
+            else if (value instanceof String)
+            {
+                String str = (String) value;
+                str = str.trim().replaceAll("\\,", ".");
+                if (str.isEmpty())
+                    value = null;
+                else
+                    try
+                    {
+                        value = Double.parseDouble(str);
+                    } catch (NumberFormatException ex)
+                    {
+                        return;
+                    }
+            } else
+                // force cast
+                value = ((Number) value).doubleValue();
+        }
+        super.setTag(name, value);
+    }
+
+    @Override
+    public String toString()
+    {
+        StringBuilder txt = new StringBuilder();
+        txt.append("Node: ");
+        txt.append(getId());
+        txt.append(" lat=");
+        txt.append(getLat());
+        txt.append(" lon=");
+        txt.append(getLon());
+        if (!getTags().isEmpty())
         {
-//            return "Node (" + id + ", " + tags.size() + " tags)";
-            StringBuilder txt = new StringBuilder();
-            txt.append("Node: ");
-            txt.append(id);
-            txt.append(" lat=");
-            txt.append(lat);
-            txt.append(" lon=");
-            txt.append(lon);
             txt.append("\n");
             txt.append(tagsToString());
-            return txt.toString();
         }
-
-        //return "Node at " + lat + ", " + lon;
+        return txt.toString();
     }
 }
diff --git a/core/src/main/java/com/graphhopper/reader/OSMReader.java b/core/src/main/java/com/graphhopper/reader/OSMReader.java
index 991bca2792..b00983edbc 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMReader.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMReader.java
@@ -41,14 +41,11 @@
 import com.graphhopper.coll.GHLongIntBTree;
 import com.graphhopper.coll.LongIntMap;
 import com.graphhopper.reader.OSMTurnRelation.TurnCostTableEntry;
+import com.graphhopper.reader.dem.ElevationProvider;
 import com.graphhopper.routing.util.EncodingManager;
-import com.graphhopper.storage.DataAccess;
-import com.graphhopper.storage.Directory;
-import com.graphhopper.storage.ExtendedStorage;
-import com.graphhopper.storage.GraphHopperStorage;
-import com.graphhopper.storage.GraphStorage;
-import com.graphhopper.storage.TurnCostStorage;
+import com.graphhopper.storage.*;
 import com.graphhopper.util.DistanceCalc;
+import com.graphhopper.util.DistanceCalc3D;
 import com.graphhopper.util.DistanceCalcEarth;
 import com.graphhopper.util.DouglasPeucker;
 import com.graphhopper.util.EdgeIteratorState;
@@ -80,7 +77,7 @@
  * <p/>
  * @author Peter Karich
  */
-public class OSMReader
+public class OSMReader implements DataReader
 {
     protected static final int EMPTY = -1;
     // pillar node is >= 3
@@ -91,12 +88,10 @@
     private long locations;
     private long skippedLocations;
     private final GraphStorage graphStorage;
+    private final NodeAccess nodeAccess;
     private EncodingManager encodingManager = null;
     private int workerThreads = -1;
-    private boolean enableInstructions = true;
-    protected final Directory dir;
     protected long zeroCounter = 0;
-    protected final long expectedNodes;
     // Using the correct Map<Long, Integer> is hard. We need a memory efficient and fast solution for big data sets!
     //
     // very slow: new SparseLongLongArray
@@ -109,40 +104,43 @@
     private LongIntMap osmNodeIdToInternalNodeMap;
     private TLongLongHashMap osmNodeIdToNodeFlagsMap;
     private TLongLongHashMap osmWayIdToRouteWeightMap;
-    private TLongHashSet osmIdStoreRequiredSet; //stores osm ids used by relations to identify which edge ids needs to be mapped later
+    // stores osm ids used by relations to identify which edge ids needs to be mapped later
+    private TLongHashSet osmIdStoreRequiredSet = new TLongHashSet();
+    ; 
     private TIntLongMap edgeIdToOsmidMap;
     private final TLongList barrierNodeIDs = new TLongArrayList();
-    protected DataAccess pillarLats;
-    protected DataAccess pillarLons;
+    protected PillarInfo pillarInfo;
     private final DistanceCalc distCalc = new DistanceCalcEarth();
+    private final DistanceCalc3D distCalc3D = new DistanceCalc3D();
     private final DouglasPeucker simplifyAlgo = new DouglasPeucker();
     private int nextTowerId = 0;
     private int nextPillarId = 0;
     // negative but increasing to avoid clash with custom created OSM files
     private long newUniqueOSMId = -Long.MAX_VALUE;
+    private ElevationProvider eleProvider = ElevationProvider.NOOP;
     private boolean exitOnlyPillarNodeException = true;
+    private File osmFile;
 
-    public OSMReader( GraphStorage storage, long expectedCap )
+    public OSMReader( GraphStorage storage )
     {
         this.graphStorage = storage;
-        this.expectedNodes = expectedCap;
+        this.nodeAccess = graphStorage.getNodeAccess();
 
         osmNodeIdToInternalNodeMap = new GHLongIntBTree(200);
         osmNodeIdToNodeFlagsMap = new TLongLongHashMap(200, .5f, 0, 0);
         osmWayIdToRouteWeightMap = new TLongLongHashMap(200, .5f, 0, 0);
-
-        dir = graphStorage.getDirectory();
-        pillarLats = dir.find("tmpLatitudes");
-        pillarLons = dir.find("tmpLongitudes");
-        pillarLats.create(Math.max(expectedCap, 100));
-        pillarLons.create(Math.max(expectedCap, 100));
+        pillarInfo = new PillarInfo(nodeAccess.is3D(), graphStorage.getDirectory());
     }
 
-    public void doOSM2Graph( File osmFile ) throws IOException
+    @Override
+    public void readGraph() throws IOException
     {
         if (encodingManager == null)
             throw new IllegalStateException("Encoding manager was not set.");
 
+        if (osmFile == null)
+            throw new IllegalStateException("No OSM file specified");
+
         if (!osmFile.exists())
             throw new IllegalStateException("Your specified OSM file does not exist:" + osmFile.getAbsolutePath());
 
@@ -198,14 +196,10 @@ void preProcess( File osmFile )
                 {
                     final OSMRelation relation = (OSMRelation) item;
                     if (!relation.isMetaRelation() && relation.hasTag("type", "route"))
-                    {
                         prepareWaysWithRelationInfo(relation);
-                    }
 
                     if (relation.hasTag("type", "restriction"))
-                    {
                         prepareRestrictionRelation(relation);
-                    }
 
                     if (++tmpRelationCounter % 50000 == 0)
                     {
@@ -236,9 +230,6 @@ private void prepareRestrictionRelation( OSMRelation relation )
 
     private TLongSet getOsmIdStoreRequiredSet()
     {
-        if (osmIdStoreRequiredSet == null)
-            osmIdStoreRequiredSet = new TLongHashSet();
-
         return osmIdStoreRequiredSet;
     }
 
@@ -355,6 +346,7 @@ void processWay( OSMWay way )
 
         long relationFlags = getRelFlagsMap().get(way.getId());
 
+        // TODO move this after we have created the edge and know the coordinates => encodingManager.applyWayTags
         // estimate length of the track e.g. for ferry speed calculation
         TLongList osmNodeIds = way.getNodes();
         if (osmNodeIds.size() > 1)
@@ -366,8 +358,8 @@ void processWay( OSMWay way )
             if (!Double.isNaN(firstLat) && !Double.isNaN(firstLon) && !Double.isNaN(lastLat) && !Double.isNaN(lastLon))
             {
                 double estimatedDist = distCalc.calcDist(firstLat, firstLon, lastLat, lastLon);
-                way.setInternalTag("estimated_distance", estimatedDist);
-                way.setInternalTag("estimated_center", new GHPoint((firstLat + lastLat) / 2, (firstLon + lastLon) / 2));
+                way.setTag("estimated_distance", estimatedDist);
+                way.setTag("estimated_center", new GHPoint((firstLat + lastLat) / 2, (firstLon + lastLon) / 2));
             }
         }
 
@@ -438,28 +430,10 @@ void processWay( OSMWay way )
             // no barriers - simply add the whole way
             createdEdges.addAll(addOSMWay(way.getNodes(), wayFlags, wayOsmId));
         }
-        if (enableInstructions)
-        {
-            // String wayInfo = encodingManager.getWayInfo(way);
-            // http://wiki.openstreetmap.org/wiki/Key:name
-            String name = fixWayName(way.getTag("name"));
-            // http://wiki.openstreetmap.org/wiki/Key:ref
-            String refName = fixWayName(way.getTag("ref"));
-            if (!Helper.isEmpty(refName))
-            {
-                if (Helper.isEmpty(name))
-                {
-                    name = refName;
-                } else
-                {
-                    name += ", " + refName;
-                }
-            }
 
-            for (EdgeIteratorState iter : createdEdges)
-            {
-                iter.setName(name);
-            }
+        for (EdgeIteratorState edge : createdEdges)
+        {
+            encodingManager.applyWayTags(way, edge);
         }
     }
 
@@ -506,12 +480,12 @@ public int getInternalNodeIdOfOsmNode( long nodeOsmId )
         {
             // tower node
             id = -id - 3;
-            return graphStorage.getLatitude(id);
+            return nodeAccess.getLatitude(id);
         } else if (id > -TOWER_NODE)
         {
             // pillar node
             id = id - 3;
-            return pillarLats.getInt(id * 4L);
+            return pillarInfo.getLatitude(id);
         } else
             // e.g. if id is not handled from preparse (e.g. was ignored via isInBounds)
             return Double.NaN;
@@ -525,24 +499,17 @@ public int getInternalNodeIdOfOsmNode( long nodeOsmId )
         {
             // tower node
             id = -id - 3;
-            return graphStorage.getLongitude(id);
+            return nodeAccess.getLongitude(id);
         } else if (id > -TOWER_NODE)
         {
             // pillar node
             id = id - 3;
-            return pillarLons.getInt(id * 4L);
+            return pillarInfo.getLon(id);
         } else
             // e.g. if id is not handled from preparse (e.g. was ignored via isInBounds)
             return Double.NaN;
     }
 
-    static String fixWayName( String str )
-    {
-        if (str == null)
-            return "";
-        return str.replaceAll(";[ ]*", ", ");
-    }
-
     private void processNode( OSMNode node )
     {
         if (isInBounds(node))
@@ -552,7 +519,7 @@ private void processNode( OSMNode node )
             // analyze node tags for barriers
             if (node.hasTags())
             {
-                long nodeFlags = encodingManager.analyzeNodeTags(node);
+                long nodeFlags = encodingManager.handleNodeTags(node);
                 if (nodeFlags != 0)
                     getNodeFlagsMap().put(node.getId(), nodeFlags);
             }
@@ -572,22 +539,24 @@ boolean addNode( OSMNode node )
 
         double lat = node.getLat();
         double lon = node.getLon();
+        double ele = getElevation(node);
         if (nodeType == TOWER_NODE)
         {
-            addTowerNode(node.getId(), lat, lon);
+            addTowerNode(node.getId(), lat, lon, ele);
         } else if (nodeType == PILLAR_NODE)
         {
-            int tmp = nextPillarId * 4;
-            pillarLats.incCapacity(tmp + 4);
-            pillarLats.setInt(tmp, Helper.degreeToInt(lat));
-            pillarLons.incCapacity(tmp + 4);
-            pillarLons.setInt(tmp, Helper.degreeToInt(lon));
+            pillarInfo.setNode(nextPillarId, lat, lon, ele);
             getNodeMap().put(node.getId(), nextPillarId + 3);
             nextPillarId++;
         }
         return true;
     }
 
+    protected double getElevation( OSMNode node )
+    {
+        return eleProvider.getEle(node.getLat(), node.getLon());
+    }
+
     void prepareWaysWithRelationInfo( OSMRelation osmRelation )
     {
         // is there at least one tag interesting for the registed encoders?
@@ -604,7 +573,7 @@ void prepareWaysWithRelationInfo( OSMRelation osmRelation )
             long osmId = member.ref();
             long oldRelationFlags = getRelFlagsMap().get(osmId);
 
-            // Check if our new code is better comparated to the the last occured before            
+            // Check if our new relation data is better comparated to the the last one
             long newRelationFlags = encodingManager.handleRelationTags(osmRelation, oldRelationFlags);
             if (oldRelationFlags != newRelationFlags)
                 getRelFlagsMap().put(osmId, newRelationFlags);
@@ -628,9 +597,13 @@ void prepareHighwayNode( long osmId )
         }
     }
 
-    int addTowerNode( long osmId, double lat, double lon )
+    int addTowerNode( long osmId, double lat, double lon, double ele )
     {
-        graphStorage.setNode(nextTowerId, lat, lon);
+        if (nodeAccess.is3D())
+            nodeAccess.setNode(nextTowerId, lat, lon, ele);
+        else
+            nodeAccess.setNode(nextTowerId, lat, lon);
+
         int id = -(nextTowerId + 3);
         getNodeMap().put(osmId, id);
         nextTowerId++;
@@ -642,7 +615,7 @@ int addTowerNode( long osmId, double lat, double lon )
      */
     Collection<EdgeIteratorState> addOSMWay( TLongList osmNodeIds, long flags, long wayOsmId )
     {
-        PointList pointList = new PointList(osmNodeIds.size());
+        PointList pointList = new PointList(osmNodeIds.size(), nodeAccess.is3D());
         List<EdgeIteratorState> newEdges = new ArrayList<EdgeIteratorState>(5);
         int firstNode = -1;
         int lastIndex = osmNodeIds.size() - 1;
@@ -676,7 +649,7 @@ int addTowerNode( long osmId, double lat, double lon )
                             // TOWER node
                             newEdges.add(addEdge(firstNode, tmpNode, pointList, flags, wayOsmId));
                             pointList.clear();
-                            pointList.add(graphStorage.getLatitude(tmpNode), graphStorage.getLongitude(tmpNode));
+                            pointList.add(nodeAccess, tmpNode);
                         }
                         firstNode = tmpNode;
                         lastInBoundsPillarNode = -1;
@@ -703,12 +676,12 @@ int addTowerNode( long osmId, double lat, double lon )
                 {
                     // TOWER node
                     tmpNode = -tmpNode - 3;
-                    pointList.add(graphStorage.getLatitude(tmpNode), graphStorage.getLongitude(tmpNode));
+                    pointList.add(nodeAccess, tmpNode);
                     if (firstNode >= 0)
                     {
                         newEdges.add(addEdge(firstNode, tmpNode, pointList, flags, wayOsmId));
                         pointList.clear();
-                        pointList.add(graphStorage.getLatitude(tmpNode), graphStorage.getLongitude(tmpNode));
+                        pointList.add(nodeAccess, tmpNode);
                     }
                     firstNode = tmpNode;
                 }
@@ -724,31 +697,45 @@ int addTowerNode( long osmId, double lat, double lon )
 
     EdgeIteratorState addEdge( int fromIndex, int toIndex, PointList pointList, long flags, long wayOsmId )
     {
+        // sanity checks
         if (fromIndex < 0 || toIndex < 0)
             throw new AssertionError("to or from index is invalid for this edge " + fromIndex + "->" + toIndex + ", points:" + pointList);
+        if (pointList.getDimension() != nodeAccess.getDimension())
+            throw new AssertionError("Dimension does not match for pointList vs. nodeAccess " + pointList.getDimension() + " <-> " + nodeAccess.getDimension());
 
         double towerNodeDistance = 0;
         double prevLat = pointList.getLatitude(0);
         double prevLon = pointList.getLongitude(0);
-        double lat;
-        double lon;
-        PointList pillarNodes = new PointList(pointList.getSize() - 2);
+        double prevEle = pointList.is3D() ? pointList.getElevation(0) : Double.NaN;
+        double lat, lon, ele = Double.NaN;
+        PointList pillarNodes = new PointList(pointList.getSize() - 2, nodeAccess.is3D());
         int nodes = pointList.getSize();
         for (int i = 1; i < nodes; i++)
         {
-            // we could save some lines if we would use pointListIncludingTowerNodes.calculateDistance(distCalc);
+            // we could save some lines if we would use pointList.calculateDistance(distCalc);
             lat = pointList.getLatitude(i);
             lon = pointList.getLongitude(i);
-            towerNodeDistance += distCalc.calcDist(prevLat, prevLon, lat, lon);
+            if (pointList.is3D())
+            {
+                ele = pointList.getElevation(i);
+                towerNodeDistance += distCalc3D.calcDist(prevLat, prevLon, prevEle, lat, lon, ele);
+                prevEle = ele;
+            } else
+                towerNodeDistance += distCalc.calcDist(prevLat, prevLon, lat, lon);
             prevLat = lat;
             prevLon = lon;
             if (nodes > 2 && i < nodes - 1)
-                pillarNodes.add(lat, lon);
+            {
+                if (pillarNodes.is3D())
+                    pillarNodes.add(lat, lon, ele);
+                else
+                    pillarNodes.add(lat, lon);
+            }
         }
         if (towerNodeDistance == 0)
         {
             // As investigation shows often two paths should have crossed via one identical point 
-            // but end up in two very close points.
+            // but end up in two very release points.
             zeroCounter++;
             towerNodeDistance = 0.0001;
         }
@@ -777,38 +764,34 @@ private void storeOSMWayID( int edgeId, long osmWayID )
     private int handlePillarNode( int tmpNode, long osmId, PointList pointList, boolean convertToTowerNode )
     {
         tmpNode = tmpNode - 3;
-        int intlat = pillarLats.getInt(tmpNode * 4);
-        int intlon = pillarLons.getInt(tmpNode * 4);
-        if (intlat == Integer.MAX_VALUE || intlon == Integer.MAX_VALUE)
-        {
-            throw new RuntimeException("Conversion pillarNode to towerNode already happended!? " + "osmId:" + osmId + " pillarIndex:"
-                    + tmpNode);
-        }
-
-        double tmpLat = Helper.intToDegree(intlat);
-        double tmpLon = Helper.intToDegree(intlon);
+        double lat = pillarInfo.getLatitude(tmpNode);
+        double lon = pillarInfo.getLongitude(tmpNode);
+        double ele = pillarInfo.getElevation(tmpNode);
+        if (lat == Double.MAX_VALUE || lon == Double.MAX_VALUE)
+            throw new RuntimeException("Conversion pillarNode to towerNode already happended!? "
+                    + "osmId:" + osmId + " pillarIndex:" + tmpNode);
 
         if (convertToTowerNode)
         {
             // convert pillarNode type to towerNode, make pillar values invalid
-            pillarLons.setInt(tmpNode * 4, Integer.MAX_VALUE);
-            pillarLats.setInt(tmpNode * 4, Integer.MAX_VALUE);
-            tmpNode = addTowerNode(osmId, tmpLat, tmpLon);
+            pillarInfo.setNode(tmpNode, Double.MAX_VALUE, Double.MAX_VALUE, Double.MAX_VALUE);
+            tmpNode = addTowerNode(osmId, lat, lon, ele);
         } else
         {
-            pointList.add(tmpLat, tmpLon);
+            if (pointList.is3D())
+                pointList.add(lat, lon, ele);
+            else
+                pointList.add(lat, lon);
         }
 
-        return tmpNode;
+        return (int) tmpNode;
     }
 
     void finishedReading()
     {
         printInfo("way");
-        dir.remove(pillarLats);
-        dir.remove(pillarLons);
-        pillarLons = null;
-        pillarLats = null;
+        pillarInfo.clear();
+        eleProvider.release();
         osmNodeIdToInternalNodeMap = null;
         osmNodeIdToNodeFlagsMap = null;
         osmWayIdToRouteWeightMap = null;
@@ -826,15 +809,11 @@ long addBarrierNode( long nodeId )
         if (graphIndex < TOWER_NODE)
         {
             graphIndex = -graphIndex - 3;
-            newNode = new OSMNode(createNewNodeId(),
-                    graphStorage.getLatitude(graphIndex),
-                    graphStorage.getLongitude(graphIndex));
+            newNode = new OSMNode(createNewNodeId(), nodeAccess, graphIndex);
         } else
         {
             graphIndex = graphIndex - 3;
-            newNode = new OSMNode(createNewNodeId(),
-                    Helper.intToDegree(pillarLats.getInt(graphIndex * 4)),
-                    Helper.intToDegree(pillarLons.getInt(graphIndex * 4)));
+            newNode = new OSMNode(createNewNodeId(), pillarInfo, graphIndex);
         }
 
         final long id = newNode.getId();
@@ -869,7 +848,7 @@ private long createNewNodeId()
      */
     OSMTurnRelation createTurnRelation( OSMRelation relation )
     {
-        OSMTurnRelation.Type type = OSMTurnRelation.Type.getRestrictionType(relation.getTag("restriction"));
+        OSMTurnRelation.Type type = OSMTurnRelation.Type.getRestrictionType((String) relation.getTag("restriction"));
         if (type != OSMTurnRelation.Type.UNSUPPORTED)
         {
             long fromWayID = -1;
@@ -935,12 +914,6 @@ public OSMReader setEncodingManager( EncodingManager acceptWay )
         return this;
     }
 
-    public OSMReader setEnableInstructions( boolean enableInstructions )
-    {
-        this.enableInstructions = enableInstructions;
-        return this;
-    }
-
     public OSMReader setWayPointMaxDistance( double maxDist )
     {
         simplifyAlgo.setMaxDistance(maxDist);
@@ -953,6 +926,24 @@ public OSMReader setWorkerThreads( int numOfWorkers )
         return this;
     }
 
+    public OSMReader setElevationProvider( ElevationProvider eleProvider )
+    {
+        if (eleProvider == null)
+            throw new IllegalStateException("Use the NOOP elevation provider instead of null or don't call setElevationProvider");
+
+        if (!nodeAccess.is3D() && ElevationProvider.NOOP != eleProvider)
+            throw new IllegalStateException("Make sure you graph accepts 3D data");
+
+        this.eleProvider = eleProvider;
+        return this;
+    }
+
+    public OSMReader setOSMFile( File osmFile )
+    {
+        this.osmFile = osmFile;
+        return this;
+    }
+
     private void printInfo( String str )
     {
         LoggerFactory.getLogger(getClass()).info(
diff --git a/core/src/main/java/com/graphhopper/reader/OSMRelation.java b/core/src/main/java/com/graphhopper/reader/OSMRelation.java
index e417e47851..7b997fa2c4 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMRelation.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMRelation.java
@@ -21,7 +21,6 @@
 import javax.xml.stream.XMLStreamException;
 import javax.xml.stream.XMLStreamReader;
 import java.util.ArrayList;
-import java.util.Map;
 
 /**
  * Represents an OSM Relation
@@ -30,23 +29,21 @@
  */
 public class OSMRelation extends OSMElement
 {
-    protected ArrayList<Member> members;
+    protected final ArrayList<Member> members = new ArrayList<Member>(5);
 
-    public OSMRelation( long id, XMLStreamReader parser ) throws XMLStreamException
+    public static OSMRelation create( long id, XMLStreamReader parser ) throws XMLStreamException
     {
-        super(id, RELATION, parser);
-        members = new ArrayList<Member>();
+        OSMRelation rel = new OSMRelation(id);
 
         parser.nextTag();
-        readMembers(parser);
-        readTags(parser);
+        rel.readMembers(parser);
+        rel.readTags(parser);
+        return rel;
     }
 
-    public OSMRelation( long id, Map<String, String> tags )
+    public OSMRelation( long id )
     {
-        super(id, RELATION, tags);
-
-        members = new ArrayList<Member>();
+        super(id, RELATION);
     }
 
     protected void readMembers( XMLStreamReader parser ) throws XMLStreamException
@@ -67,7 +64,7 @@ protected void readMembers( XMLStreamReader parser ) throws XMLStreamException
     @Override
     public String toString()
     {
-        return "Relation (" + id + ", " + members.size() + " members)";
+        return "Relation (" + getId() + ", " + members.size() + " members)";
     }
 
     public ArrayList<Member> getMembers()
@@ -75,15 +72,6 @@ public String toString()
         return members;
     }
 
-    public void copyMembers( OSMRelation input )
-    {
-        members = new ArrayList<Member>();
-        for (int i = 0; i < input.members.size(); i++)
-        {
-            members.add(new Member(input.members.get(i)));
-        }
-    }
-
     public boolean isMetaRelation()
     {
         for (Member member : members)
diff --git a/core/src/main/java/com/graphhopper/reader/OSMWay.java b/core/src/main/java/com/graphhopper/reader/OSMWay.java
index 2c3ccee2d4..a4e0bfcee9 100644
--- a/core/src/main/java/com/graphhopper/reader/OSMWay.java
+++ b/core/src/main/java/com/graphhopper/reader/OSMWay.java
@@ -32,42 +32,23 @@
  */
 public class OSMWay extends OSMElement
 {
-    protected TLongList nodes;
+    protected final TLongList nodes = new TLongArrayList(5);
 
     /**
      * Constructor for XML Parser
-     * <p/>
-     * @param id
-     * @param parser
-     * @throws XMLStreamException
      */
-    public OSMWay( long id, XMLStreamReader parser ) throws XMLStreamException
+    public static OSMWay create( long id, XMLStreamReader parser ) throws XMLStreamException
     {
-        super(id, WAY, parser);
-        nodes = new TLongArrayList();
-
+        OSMWay way = new OSMWay(id);
         parser.nextTag();
-        readNodes(parser);
-        readTags(parser);
-    }
-
-    /**
-     * Constructor for PBF Parser
-     * <p/>
-     * @param id
-     * @param tags
-     */
-    public OSMWay( long id, Map<String, String> tags )
-    {
-        super(id, WAY, tags);
-
-        nodes = new TLongArrayList();
+        way.readNodes(parser);
+        way.readTags(parser);
+        return way;
     }
 
     public OSMWay( long id )
     {
         super(id, WAY);
-        nodes = new TLongArrayList();
     }
 
     protected void readNodes( XMLStreamReader parser ) throws XMLStreamException
@@ -94,6 +75,6 @@ public TLongList getNodes()
     @Override
     public String toString()
     {
-        return "Way (" + id + ", " + nodes.size() + " nodes)";
+        return "Way (" + getId() + ", " + nodes.size() + " nodes)";
     }
 }
diff --git a/core/src/main/java/com/graphhopper/reader/PillarInfo.java b/core/src/main/java/com/graphhopper/reader/PillarInfo.java
new file mode 100644
index 0000000000..00bdcbc28d
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/reader/PillarInfo.java
@@ -0,0 +1,133 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader;
+
+import com.graphhopper.storage.DataAccess;
+import com.graphhopper.storage.Directory;
+import com.graphhopper.util.Helper;
+import com.graphhopper.util.PointAccess;
+
+/**
+ * This class helps to store lat,lon,ele for every node parsed in OSMReader
+ * <p>
+ * @author Peter Karich
+ */
+public class PillarInfo implements PointAccess
+{
+    private final int LAT = 0 * 4, LON = 1 * 4, ELE = 2 * 4;
+    private final boolean enabled3D;
+    private final DataAccess da;
+    private final int rowSizeInBytes;
+    private final Directory dir;
+
+    public PillarInfo( boolean enabled3D, Directory dir )
+    {
+        this.enabled3D = enabled3D;
+        this.dir = dir;
+        this.da = dir.find("tmpPillarInfo").create(100);
+        this.rowSizeInBytes = getDimension() * 4;
+    }
+
+    @Override
+    public boolean is3D()
+    {
+        return enabled3D;
+    }
+
+    @Override
+    public int getDimension()
+    {
+        return enabled3D ? 3 : 2;
+    }
+
+    @Override
+    public void setNode( int id, double lat, double lon )
+    {
+//        if (is3D())
+//            throw new IllegalStateException("Can only be called if 3D is disabled");
+
+        _setNode(id, lat, lon, Double.NaN);
+    }
+
+    @Override
+    public void setNode( int id, double lat, double lon, double ele )
+    {
+//        if (!is3D())
+//            throw new IllegalStateException("Can only be called if 3D is enabled");
+        _setNode(id, lat, lon, ele);
+    }
+
+    private void _setNode( int id, double lat, double lon, double ele )
+    {
+        long tmp = (long) id * rowSizeInBytes;
+        da.incCapacity(tmp + rowSizeInBytes);
+        da.setInt(tmp + LAT, Helper.degreeToInt(lat));
+        da.setInt(tmp + LON, Helper.degreeToInt(lon));
+
+        if (is3D())
+            da.setInt(tmp + ELE, Helper.eleToInt(ele));
+    }
+
+    @Override
+    public double getLatitude( int id )
+    {
+        int intVal = da.getInt((long) id * rowSizeInBytes + LAT);
+        return Helper.intToDegree(intVal);
+    }
+
+    @Override
+    public double getLat( int id )
+    {
+        return getLatitude(id);
+    }
+
+    @Override
+    public double getLongitude( int id )
+    {
+        int intVal = da.getInt((long) id * rowSizeInBytes + LON);
+        return Helper.intToDegree(intVal);
+    }
+
+    @Override
+    public double getLon( int id )
+    {
+        return getLongitude(id);
+    }
+
+    @Override
+    public double getElevation( int id )
+    {
+        if (!is3D())
+            return Double.NaN;
+
+        int intVal = da.getInt((long) id * rowSizeInBytes + ELE);
+        return Helper.intToEle(intVal);
+    }
+
+    @Override
+    public double getEle( int id )
+    {
+        return getElevation(id);
+    }
+
+    public void clear()
+    {
+        dir.remove(da);
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/reader/dem/ElevationProvider.java b/core/src/main/java/com/graphhopper/reader/dem/ElevationProvider.java
new file mode 100644
index 0000000000..be431b6654
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/reader/dem/ElevationProvider.java
@@ -0,0 +1,86 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader.dem;
+
+import java.io.File;
+
+/**
+ * @author Peter Karich
+ */
+public interface ElevationProvider
+{
+    /**
+     * @return returns the hight in meter or Double.NaN if invalid
+     */
+    double getEle( double lat, double lon );
+
+    /**
+     * Specifies the service URL where to download the elevation data. An empty string should set it
+     * to the default URL.
+     */
+    ElevationProvider setBaseURL( String baseURL );
+
+    /**
+     * Specifies the directory where to temporarily store the elevation data after fetched from base
+     * URL.
+     */
+    ElevationProvider setCacheDir( File cacheDir );
+
+    /**
+     * Set to true if you have a small area and need high speed access.
+     */
+    ElevationProvider setInMemory( boolean b );
+
+    /**
+     * Release resources.
+     */
+    void release();
+
+    public final static ElevationProvider NOOP = new ElevationProvider()
+    {
+        @Override
+        public double getEle( double lat, double lon )
+        {
+            return Double.NaN;
+        }
+
+        @Override
+        public ElevationProvider setCacheDir( File cacheDir )
+        {
+            return this;
+        }
+
+        @Override
+        public ElevationProvider setBaseURL( String baseURL )
+        {
+            return this;
+        }
+
+        @Override
+        public ElevationProvider setInMemory( boolean b )
+        {
+            return this;
+        }
+
+        @Override
+        public void release()
+        {
+        }
+    };
+}
diff --git a/core/src/main/java/com/graphhopper/reader/dem/HeightTile.java b/core/src/main/java/com/graphhopper/reader/dem/HeightTile.java
new file mode 100644
index 0000000000..852c5f1684
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/reader/dem/HeightTile.java
@@ -0,0 +1,119 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader.dem;
+
+import com.graphhopper.storage.DataAccess;
+import java.awt.Color;
+import java.awt.Graphics;
+import java.awt.image.BufferedImage;
+import java.io.File;
+import java.io.IOException;
+import javax.imageio.ImageIO;
+
+/**
+ * One rectangle of height data from Shuttle Radar Topography Mission.
+ * <p>
+ * @author Peter Karich
+ */
+public class HeightTile
+{
+    private DataAccess heights;
+    private final int minLat;
+    private final int minLon;
+    private final int width;
+    private final double lowerBound;
+    private final double higherBound;
+
+    public HeightTile( int minLat, int minLon, int width, double precision )
+    {
+        this.minLat = minLat;
+        this.minLon = minLon;
+        this.width = width;
+
+        this.lowerBound = -1 / precision;
+        this.higherBound = 1 + 1 / precision;
+    }
+
+    void setHeights( DataAccess da )
+    {
+        this.heights = da;
+    }
+
+    public short getHeight( double lat, double lon )
+    {
+        double deltaLat = lat - minLat;
+        double deltaLon = lon - minLon;
+        if (deltaLat > higherBound || deltaLat < lowerBound)
+            throw new IllegalStateException("latitude not in boundary of this file:" + lat + "," + lon + ", this:" + this.toString());
+        if (deltaLon > higherBound || deltaLon < lowerBound)
+            throw new IllegalStateException("longitude not in boundary of this file:" + lat + "," + lon + ", this:" + this.toString());
+
+        // first row in the file is the northernmost one
+        // http://gis.stackexchange.com/a/43756/9006
+        int lonSimilar = (int) Math.round(width * deltaLon);
+        int latSimilar = width - (int) Math.round(width * deltaLat);
+        return heights.getShort(2 * (latSimilar * width + lonSimilar));
+    }
+
+    public void toImage( String imageFile ) throws IOException
+    {
+        ImageIO.write(makeARGB(), "PNG", new File(imageFile));
+    }
+
+    protected BufferedImage makeARGB()
+    {
+        int height = width;
+        BufferedImage argbImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
+        Graphics g = argbImage.getGraphics();
+        long len = heights.getCapacity() / 2;
+        for (int i = 0; i < len; i++)
+        {
+            int lonSimilar = i % width;
+            // no need for width - x as coordinate system for Graphics is already this way
+            int latSimilar = i / width;
+            int green = Math.abs(heights.getShort(i * 2));
+            int red = 0;
+            while (green > 255)
+            {
+                green = green / 10;
+                red += 50;
+            }
+            if (red > 255)
+                red = 255;
+            g.setColor(new Color(red, green, 122, 255));
+            g.drawLine(lonSimilar, latSimilar, lonSimilar, latSimilar);
+        }
+        g.dispose();
+        return argbImage;
+    }
+
+    public BufferedImage getImageFromArray( int[] pixels, int width )
+    {
+        int height = width;
+        BufferedImage tmpImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB_PRE);
+        tmpImage.setRGB(0, 0, width, height, pixels, 0, width);
+        return tmpImage;
+    }
+
+    @Override
+    public String toString()
+    {
+        return minLat + "," + minLon;
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/reader/dem/SRTMProvider.java b/core/src/main/java/com/graphhopper/reader/dem/SRTMProvider.java
new file mode 100644
index 0000000000..be9731f37a
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/reader/dem/SRTMProvider.java
@@ -0,0 +1,304 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader.dem;
+
+import com.graphhopper.storage.*;
+import com.graphhopper.util.BitUtil;
+import com.graphhopper.util.Downloader;
+import com.graphhopper.util.Helper;
+import gnu.trove.map.hash.TIntObjectHashMap;
+import java.io.*;
+import java.net.SocketTimeoutException;
+import java.util.zip.ZipInputStream;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+/**
+ * Elevation data from NASA (SRTM). Downloaded from http://dds.cr.usgs.gov/srtm/version2_1/SRTM3/
+ * <p>
+ * Important information about SRTM: the coordinates of the lower-left corner of tile N40W118 are 40
+ * degrees north latitude and 118 degrees west longitude. To be more exact, these coordinates refer
+ * to the geometric center of the lower left sample, which in the case of SRTM3 data will be about
+ * 90 meters in extent.
+ * <p>
+ * @author Peter Karich
+ */
+public class SRTMProvider implements ElevationProvider
+{
+    public static void main( String[] args ) throws IOException
+    {
+        new SRTMProvider().getEle(55, -161);
+    }
+
+    private static final BitUtil BIT_UTIL = BitUtil.BIG;
+    private final Logger logger = LoggerFactory.getLogger(getClass());
+    private final int WIDTH = 1201;
+    private Directory dir;
+    private DAType daType = DAType.MMAP;
+    private Downloader downloader = new Downloader("GraphHopper SRTMReader").setTimeout(10000);
+    private File cacheDir = new File("/tmp/srtm");
+    // use a map as an array is not quite useful if we want to hold only parts of the world
+    private final TIntObjectHashMap<HeightTile> cacheData = new TIntObjectHashMap<HeightTile>();
+    private final TIntObjectHashMap<String> areas = new TIntObjectHashMap<String>();
+    private final double precision = 1e7;
+    private final double invPrecision = 1 / precision;
+    // mirror: base = "http://mirror.ufs.ac.za/datasets/SRTM3/"
+    private String baseUrl = "http://dds.cr.usgs.gov/srtm/version2_1/SRTM3/";
+
+    public SRTMProvider()
+    {
+        // move to explicit calls?
+        init();
+    }
+
+    /**
+     * The URLs are a bit ugly and so we need to find out which area name a certain lat,lon
+     * coordinate has.
+     */
+    private SRTMProvider init()
+    {
+        try
+        {
+            String strs[] =
+            {
+                "Africa", "Australia", "Eurasia", "Islands", "North_America", "South_America"
+            };
+            for (String str : strs)
+            {
+                InputStream is = getClass().getResourceAsStream(str + "_names.txt.zip");
+                ZipInputStream zis = new ZipInputStream(is);
+                zis.getNextEntry();
+                for (String line : Helper.readFile(new InputStreamReader(zis, "UTF-8")))
+                {
+                    int lat = Integer.parseInt(line.substring(1, 3));
+                    if (line.substring(0, 1).charAt(0) == 'S')
+                        lat = -lat;
+
+                    int lon = Integer.parseInt(line.substring(4, 7));
+                    if (line.substring(3, 4).charAt(0) == 'W')
+                        lon = -lon;
+
+                    int intKey = calcIntKey(lat, lon);
+                    String key = areas.put(intKey, str);
+                    if (key != null)
+                        throw new IllegalStateException("do not overwrite existing! key " + intKey + " " + key + " vs. " + str);
+                }
+            }
+            return this;
+        } catch (Exception ex)
+        {
+            throw new IllegalStateException("Cannot load area names from classpath", ex);
+        }
+    }
+
+    // use int key instead of string for lower memory usage
+    private int calcIntKey( double lat, double lon )
+    {
+        // we could use LinearKeyAlgo but this is simpler as we only need integer precision:
+        return (down(lat) + 90) * 1000 + down(lon) + 180;
+    }
+
+    public void setDownloader( Downloader downloader )
+    {
+        this.downloader = downloader;
+    }
+
+    @Override
+    public ElevationProvider setCacheDir( File cacheDir )
+    {
+        if (cacheDir.exists() && !cacheDir.isDirectory())
+            throw new IllegalStateException("Cache path has to be a directory");
+
+        this.cacheDir = cacheDir;
+        return this;
+    }
+
+    @Override
+    public ElevationProvider setBaseURL( String baseUrl )
+    {
+        if (baseUrl.isEmpty())
+            return this;
+
+        this.baseUrl = baseUrl;
+        return this;
+    }
+
+    @Override
+    public ElevationProvider setInMemory( boolean inMem )
+    {
+        if (inMem)
+            daType = DAType.RAM;
+        else
+            daType = DAType.MMAP;
+        return this;
+    }
+
+    int down( double val )
+    {
+        int intVal = (int) val;
+        if (val >= 0 || intVal - val < invPrecision)
+            return intVal;
+        return intVal - 1;
+    }
+
+    String getFileString( double lat, double lon )
+    {
+        int intKey = calcIntKey(lat, lon);
+        String str = areas.get(intKey);
+        if (str == null)
+            return null;
+
+        int minLat = Math.abs(down(lat));
+        int minLon = Math.abs(down(lon));
+        str += "/";
+        if (lat >= 0)
+            str += "N";
+        else
+            str += "S";
+
+        if (minLat < 10)
+            str += "0";
+        str += minLat;
+
+        if (lon >= 0)
+            str += "E";
+        else
+            str += "W";
+
+        if (minLon < 10)
+            str += "0";
+        if (minLon < 100)
+            str += "0";
+        str += minLon;
+        return str;
+    }
+
+    @Override
+    public double getEle( double lat, double lon )
+    {
+        lat = (int) (lat * precision) / precision;
+        lon = (int) (lon * precision) / precision;
+        int intKey = calcIntKey(lat, lon);
+        HeightTile demProvider = cacheData.get(intKey);
+        if (demProvider == null)
+        {
+            if (!cacheDir.exists())
+                cacheDir.mkdirs();
+
+            String fileDetails = getFileString(lat, lon);
+            if (fileDetails == null)
+                return 0;
+
+            int minLat = down(lat);
+            int minLon = down(lon);
+            demProvider = new HeightTile(minLat, minLon, WIDTH, precision);
+            cacheData.put(intKey, demProvider);
+            try
+            {
+                String zippedURL = baseUrl + "/" + fileDetails + "hgt.zip";
+                File file = new File(cacheDir, new File(zippedURL).getName());
+                InputStream is;
+                // get zip file if not already in cacheDir - unzip later and in-memory only!
+                if (!file.exists())
+                {
+                    for (int i = 0; i < 3; i++)
+                    {
+                        try
+                        {
+                            downloader.downloadFile(zippedURL, file.getAbsolutePath());
+                            break;
+                        } catch (SocketTimeoutException ex)
+                        {
+                            // just try again after a little nap
+                            Thread.sleep(2000);
+                            continue;
+                        } catch (FileNotFoundException ex)
+                        {
+                            // now try different URL (with point!), necessary if mirror is used
+                            zippedURL = baseUrl + "/" + fileDetails + ".hgt.zip";
+                            continue;
+                        }
+                    }
+                }
+
+                is = new FileInputStream(file);
+                ZipInputStream zis = new ZipInputStream(is);
+                zis.getNextEntry();
+                BufferedInputStream buff = new BufferedInputStream(zis);
+                byte[] bytes = new byte[2 * WIDTH * WIDTH];
+                DataAccess heights = getDirectory().find("dem" + intKey);
+                heights.create(bytes.length);
+
+                demProvider.setHeights(heights);
+                int len;
+                while ((len = buff.read(bytes)) > 0)
+                {
+                    for (int bytePos = 0; bytePos < len; bytePos += 2)
+                    {
+                        short val = BIT_UTIL.toShort(bytes, bytePos);
+                        if (val < -1000 || val > 10000)
+                        {
+                            // TODO fill unassigned gaps with neighbor values -> flood fill algorithm !
+                            // -> calculate mean with an associated weight of how long the distance to the neighbor is
+//                            throw new IllegalStateException("Invalid height value " + val
+//                                    + ", y:" + bytePos / WIDTH + ", x:" + (WIDTH - bytePos % WIDTH));
+                            val = Short.MIN_VALUE;
+                        }
+
+                        heights.setShort(bytePos, val);
+                    }
+                }
+                // demProvider.toImage(file.getName() + ".png");
+            } catch (Exception ex)
+            {
+                throw new RuntimeException(ex);
+            }
+        }
+
+        short val = demProvider.getHeight(lat, lon);
+        if (val == Short.MIN_VALUE)
+            return Double.NaN;
+        return val;
+    }
+
+    @Override
+    public void release()
+    {
+        cacheData.clear();
+
+        // for memory mapped type we create temporary unpacked files which should be removed
+        if (dir != null)
+            dir.clear();
+    }
+
+    @Override
+    public String toString()
+    {
+        return "SRTM";
+    }
+
+    private Directory getDirectory()
+    {
+        if (dir != null)
+            return dir;
+
+        logger.info("SRTM Elevation Provider, from: " + baseUrl + ", to: " + cacheDir + ", as: " + daType);
+        return dir = new GHDirectory(cacheDir.getAbsolutePath(), daType);
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoder.java b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoder.java
index 45c3bec911..58ab2d598c 100644
--- a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoder.java
+++ b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoder.java
@@ -26,11 +26,11 @@
  */
 public class PbfBlobDecoder implements Runnable
 {
-    private static Logger log = LoggerFactory.getLogger(PbfBlobDecoder.class);
+    private static final Logger log = LoggerFactory.getLogger(PbfBlobDecoder.class);
     private final boolean checkData = false;
-    private String blobType;
-    private byte[] rawBlob;
-    private PbfBlobDecoderListener listener;
+    private final String blobType;
+    private final byte[] rawBlob;
+    private final PbfBlobDecoderListener listener;
     private List<OSMElement> decodedEntities;
 
     /**
@@ -158,8 +158,9 @@ private void processNodes( List<Osmformat.Node> nodes, PbfFieldDecoder fieldDeco
         {
             Map<String, String> tags = buildTags(node.getKeysList(), node.getValsList(), fieldDecoder);
 
-            OSMNode osmNode = new OSMNode(node.getId(), tags, fieldDecoder.decodeLatitude(node
+            OSMNode osmNode = new OSMNode(node.getId(), fieldDecoder.decodeLatitude(node
                     .getLat()), fieldDecoder.decodeLatitude(node.getLon()));
+            osmNode.setTags(tags);
 
             // Add the bound object to the results.
             decodedEntities.add(osmNode);
@@ -258,7 +259,8 @@ private void processNodes( Osmformat.DenseNodes nodes, PbfFieldDecoder fieldDeco
                 tags.put(fieldDecoder.decodeString(keyIndex), fieldDecoder.decodeString(valueIndex));
             }
 
-            OSMNode node = new OSMNode(nodeId, tags, ((double) latitude) / 10000000, ((double) longitude) / 10000000);
+            OSMNode node = new OSMNode(nodeId, ((double) latitude) / 10000000, ((double) longitude) / 10000000);
+            node.setTags(tags);
 
             // Add the bound object to the results.
             decodedEntities.add(node);
@@ -270,8 +272,8 @@ private void processWays( List<Osmformat.Way> ways, PbfFieldDecoder fieldDecoder
         for (Osmformat.Way way : ways)
         {
             Map<String, String> tags = buildTags(way.getKeysList(), way.getValsList(), fieldDecoder);
-
-            OSMWay osmWay = new OSMWay(way.getId(), tags);
+            OSMWay osmWay = new OSMWay(way.getId());
+            osmWay.setTags(tags);
 
             // Build up the list of way nodes for the way. The node ids are
             // delta encoded meaning that each id is stored as a delta against
@@ -346,7 +348,8 @@ private void processRelations( List<Osmformat.Relation> relations, PbfFieldDecod
         {
             Map<String, String> tags = buildTags(relation.getKeysList(), relation.getValsList(), fieldDecoder);
 
-            OSMRelation osmRelation = new OSMRelation(relation.getId(), tags);
+            OSMRelation osmRelation = new OSMRelation(relation.getId());
+            osmRelation.setTags(tags);
 
             buildRelationMembers(osmRelation, relation.getMemidsList(), relation.getRolesSidList(),
                     relation.getTypesList(), fieldDecoder);
@@ -405,7 +408,7 @@ public void run()
 
         } catch (RuntimeException e)
         {
-            listener.error();
+            listener.error(e);
         }
     }
 }
diff --git a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoderListener.java b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoderListener.java
index d5e0c418cb..cd4c6eca52 100644
--- a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoderListener.java
+++ b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobDecoderListener.java
@@ -22,5 +22,5 @@
     /**
      * Notifies the listener that an error occurred during processing.
      */
-    void error();
+    void error( Exception ex );
 }
diff --git a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobResult.java b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobResult.java
index 046de3ea2e..e119944e7e 100644
--- a/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobResult.java
+++ b/core/src/main/java/com/graphhopper/reader/pbf/PbfBlobResult.java
@@ -15,6 +15,7 @@
     private List<OSMElement> entities;
     private boolean complete;
     private boolean success;
+    private Exception ex;
 
     /**
      * Creates a new instance.
@@ -23,6 +24,7 @@ public PbfBlobResult()
     {
         complete = false;
         success = false;
+        ex = new RuntimeException("no success result stored");
     }
 
     /**
@@ -40,10 +42,11 @@ public void storeSuccessResult( List<OSMElement> decodedEntities )
     /**
      * Stores a failure result for a blob decoding operation.
      */
-    public void storeFailureResult()
+    public void storeFailureResult( Exception ex )
     {
         complete = true;
         success = false;
+        this.ex = ex;
     }
 
     /**
@@ -66,6 +69,11 @@ public boolean isSuccess()
         return success;
     }
 
+    public Exception getException()
+    {
+        return ex;
+    }
+
     /**
      * Gets the entities decoded from the blob. This is only valid after complete becomes true, and
      * if success is true.
diff --git a/core/src/main/java/com/graphhopper/reader/pbf/PbfDecoder.java b/core/src/main/java/com/graphhopper/reader/pbf/PbfDecoder.java
index 050a64d6de..421979704f 100644
--- a/core/src/main/java/com/graphhopper/reader/pbf/PbfDecoder.java
+++ b/core/src/main/java/com/graphhopper/reader/pbf/PbfDecoder.java
@@ -20,13 +20,13 @@
  */
 public class PbfDecoder implements Runnable
 {
-    private PbfStreamSplitter streamSplitter;
-    private ExecutorService executorService;
-    private int maxPendingBlobs;
-    private Sink sink;
-    private Lock lock;
-    private Condition dataWaitCondition;
-    private Queue<PbfBlobResult> blobResults;
+    private final PbfStreamSplitter streamSplitter;
+    private final ExecutorService executorService;
+    private final int maxPendingBlobs;
+    private final Sink sink;
+    private final Lock lock;
+    private final Condition dataWaitCondition;
+    private final Queue<PbfBlobResult> blobResults;
 
     /**
      * Creates a new instance.
@@ -92,7 +92,7 @@ private void sendResultsToSink( int targetQueueSize )
 
             if (!blobResult.isSuccess())
             {
-                throw new RuntimeException("A PBF decoding worker thread failed, aborting.");
+                throw new RuntimeException("A PBF decoding worker thread failed, aborting.", blobResult.getException());
             }
 
             // Send the processed entities to the sink. We can release the lock
@@ -130,13 +130,13 @@ private void processBlobs()
             PbfBlobDecoderListener decoderListener = new PbfBlobDecoderListener()
             {
                 @Override
-                public void error()
+                public void error( Exception ex )
                 {
                     lock.lock();
                     try
                     {
-                        System.out.println("ERROR: " + new Date());
-                        blobResult.storeFailureResult();
+                        // System.out.println("ERROR: " + new Date());
+                        blobResult.storeFailureResult(ex);
                         signalUpdate();
 
                     } finally
diff --git a/core/src/main/java/com/graphhopper/routing/AStar.java b/core/src/main/java/com/graphhopper/routing/AStar.java
index 728760b0a9..eb23dac775 100644
--- a/core/src/main/java/com/graphhopper/routing/AStar.java
+++ b/core/src/main/java/com/graphhopper/routing/AStar.java
@@ -75,8 +75,8 @@ protected void initCollections( int size )
     public Path calcPath( int from, int to )
     {
         checkAlreadyRun();
-        toLat = graph.getLatitude(to);
-        toLon = graph.getLongitude(to);
+        toLat = nodeAccess.getLatitude(to);
+        toLon = nodeAccess.getLongitude(to);
         to1 = to;
         currEdge = createEdgeEntry(from, 0);
         fromMap.put(from, currEdge);
@@ -89,7 +89,7 @@ private Path runAlgo()
         EdgeExplorer explorer = outEdgeExplorer;
         while (true)
         {
-            int currVertex = currEdge.endNode;
+            int currVertex = currEdge.adjNode;
             visitedCount++;
             if (finished())
                 break;
@@ -102,20 +102,20 @@ private Path runAlgo()
                 if (currEdge.edge == iter.getEdge())
                     continue;
 
-                int neighborNode = iter.getAdjNode();
+                int adjNode = iter.getAdjNode();
                 double alreadyVisitedWeight = weighting.calcWeight(iter, false) + currEdge.weightToCompare;
-                AStarEdge nEdge = fromMap.get(neighborNode);
+                AStarEdge nEdge = fromMap.get(adjNode);
                 if (nEdge == null || nEdge.weightToCompare > alreadyVisitedWeight)
                 {
-                    tmpLat = graph.getLatitude(neighborNode);
-                    tmpLon = graph.getLongitude(neighborNode);
+                    tmpLat = nodeAccess.getLatitude(adjNode);
+                    tmpLon = nodeAccess.getLongitude(adjNode);
                     currWeightToGoal = dist.calcDist(toLat, toLon, tmpLat, tmpLon);
                     currWeightToGoal = weighting.getMinWeight(currWeightToGoal);
                     distEstimation = alreadyVisitedWeight + currWeightToGoal;
                     if (nEdge == null)
                     {
-                        nEdge = new AStarEdge(iter.getEdge(), neighborNode, distEstimation, alreadyVisitedWeight);
-                        fromMap.put(neighborNode, nEdge);
+                        nEdge = new AStarEdge(iter.getEdge(), adjNode, distEstimation, alreadyVisitedWeight);
+                        fromMap.put(adjNode, nEdge);
                     } else
                     {
                         prioQueueOpenSet.remove(nEdge);
@@ -125,7 +125,7 @@ private Path runAlgo()
                     }
                     nEdge.parent = currEdge;
                     prioQueueOpenSet.add(nEdge);
-                    updateShortest(nEdge, neighborNode);
+                    updateShortest(nEdge, adjNode);
                 }
             }
 
@@ -155,7 +155,7 @@ protected AStarEdge createEdgeEntry( int node, double dist )
     @Override
     protected boolean finished()
     {
-        return currEdge.endNode == to1;
+        return currEdge.adjNode == to1;
     }
 
     @Override
@@ -170,9 +170,9 @@ public int getVisitedNodes()
         // but to compare distance we need it only from start:
         double weightToCompare;
 
-        public AStarEdge( int edgeId, int node, double weightForHeap, double weightToCompare )
+        public AStarEdge( int edgeId, int adjNode, double weightForHeap, double weightToCompare )
         {
-            super(edgeId, node, weightForHeap);
+            super(edgeId, adjNode, weightForHeap);
             // round makes distance smaller => heuristic should underestimate the distance!
             this.weightToCompare = (float) weightToCompare;
         }
diff --git a/core/src/main/java/com/graphhopper/routing/AStarBidirection.java b/core/src/main/java/com/graphhopper/routing/AStarBidirection.java
index 1bd9bfc651..13765624ba 100644
--- a/core/src/main/java/com/graphhopper/routing/AStarBidirection.java
+++ b/core/src/main/java/com/graphhopper/routing/AStarBidirection.java
@@ -131,7 +131,7 @@ public void initFrom( int from, double dist )
         currFrom = createEdgeEntry(from, dist);
         bestWeightMapFrom.put(from, currFrom);
         prioQueueOpenSetFrom.add(currFrom);
-        fromCoord = new GHPoint(graph.getLatitude(from), graph.getLongitude(from));
+        fromCoord = new GHPoint(nodeAccess.getLatitude(from), nodeAccess.getLongitude(from));
         if (currTo != null)
         {
             bestWeightMapOther = bestWeightMapTo;
@@ -145,7 +145,7 @@ public void initTo( int to, double dist )
         currTo = createEdgeEntry(to, dist);
         bestWeightMapTo.put(to, currTo);
         prioQueueOpenSetTo.add(currTo);
-        toCoord = new GHPoint(graph.getLatitude(to), graph.getLongitude(to));
+        toCoord = new GHPoint(nodeAccess.getLatitude(to), nodeAccess.getLongitude(to));
         if (currFrom != null)
         {
             bestWeightMapOther = bestWeightMapFrom;
@@ -216,7 +216,7 @@ private void fillEdges( AStarEdge currEdge, CoordTrig goal,
             TIntObjectMap<AStarEdge> shortestWeightMap, EdgeExplorer explorer, boolean reverse )
     {
 
-        int currNode = currEdge.endNode;
+        int currNode = currEdge.adjNode;
         EdgeIterator iter = explorer.setBaseNode(currNode);
         while (iter.next())
         {
@@ -225,22 +225,22 @@ private void fillEdges( AStarEdge currEdge, CoordTrig goal,
             if (currEdge.edge == iter.getEdge())
                 continue;
 
-            int neighborNode = iter.getAdjNode();
+            int adjNode = iter.getAdjNode();
             // TODO performance: check if the node is already existent in the opposite direction
             // then we could avoid the approximation as we already know the exact complete path!
             double alreadyVisitedWeight = weighting.calcWeight(iter, reverse) + currEdge.weightToCompare;
-            AStarEdge de = shortestWeightMap.get(neighborNode);
+            AStarEdge de = shortestWeightMap.get(adjNode);
             if (de == null || de.weightToCompare > alreadyVisitedWeight)
             {
-                double tmpLat = graph.getLatitude(neighborNode);
-                double tmpLon = graph.getLongitude(neighborNode);
+                double tmpLat = nodeAccess.getLatitude(adjNode);
+                double tmpLon = nodeAccess.getLongitude(adjNode);
                 double currWeightToGoal = dist.calcDist(goal.lat, goal.lon, tmpLat, tmpLon);
                 currWeightToGoal = weighting.getMinWeight(currWeightToGoal);
                 double estimationFullDist = alreadyVisitedWeight + currWeightToGoal;
                 if (de == null)
                 {
-                    de = new AStarEdge(iter.getEdge(), neighborNode, estimationFullDist, alreadyVisitedWeight);
-                    shortestWeightMap.put(neighborNode, de);
+                    de = new AStarEdge(iter.getEdge(), adjNode, estimationFullDist, alreadyVisitedWeight);
+                    shortestWeightMap.put(adjNode, de);
                 } else
                 {
                     prioQueueOpenSet.remove(de);
@@ -251,7 +251,7 @@ private void fillEdges( AStarEdge currEdge, CoordTrig goal,
 
                 de.parent = currEdge;
                 prioQueueOpenSet.add(de);
-                updateShortest(de, neighborNode);
+                updateShortest(de, adjNode);
             }
         }
     }
diff --git a/core/src/main/java/com/graphhopper/routing/AbstractRoutingAlgorithm.java b/core/src/main/java/com/graphhopper/routing/AbstractRoutingAlgorithm.java
index 68c9af74c9..b4f6c5b335 100644
--- a/core/src/main/java/com/graphhopper/routing/AbstractRoutingAlgorithm.java
+++ b/core/src/main/java/com/graphhopper/routing/AbstractRoutingAlgorithm.java
@@ -23,6 +23,7 @@
 import com.graphhopper.routing.util.Weighting;
 import com.graphhopper.storage.EdgeEntry;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.index.QueryResult;
 import com.graphhopper.util.EdgeExplorer;
 import com.graphhopper.util.EdgeIterator;
@@ -36,6 +37,7 @@
 {
     private EdgeFilter additionalEdgeFilter;
     protected Graph graph;
+    protected NodeAccess nodeAccess;
     protected EdgeExplorer inEdgeExplorer;
     protected EdgeExplorer outEdgeExplorer;
     protected final Weighting weighting;
@@ -61,6 +63,7 @@ public AbstractRoutingAlgorithm( Graph graph, FlagEncoder encoder, Weighting wei
     protected RoutingAlgorithm setGraph( Graph graph )
     {
         this.graph = graph;
+        this.nodeAccess = graph.getNodeAccess();
         outEdgeExplorer = graph.createEdgeExplorer(new DefaultEdgeFilter(flagEncoder, false, true));
         inEdgeExplorer = graph.createEdgeExplorer(new DefaultEdgeFilter(flagEncoder, true, false));
         return this;
diff --git a/core/src/main/java/com/graphhopper/routing/Dijkstra.java b/core/src/main/java/com/graphhopper/routing/Dijkstra.java
index 37bc466527..17d5d064cf 100644
--- a/core/src/main/java/com/graphhopper/routing/Dijkstra.java
+++ b/core/src/main/java/com/graphhopper/routing/Dijkstra.java
@@ -72,8 +72,8 @@ private Path runAlgo()
             if (finished())
                 break;
 
-            int neighborNode = currEdge.endNode;
-            EdgeIterator iter = explorer.setBaseNode(neighborNode);
+            int startNode = currEdge.adjNode;
+            EdgeIterator iter = explorer.setBaseNode(startNode);
             while (iter.next())
             {
                 if (!accept(iter))
@@ -82,15 +82,15 @@ private Path runAlgo()
                 if (currEdge.edge == iter.getEdge())
                     continue;
 
-                int tmpNode = iter.getAdjNode();
+                int adjNode = iter.getAdjNode();
                 double tmpWeight = weighting.calcWeight(iter, false) + currEdge.weight;
 
-                EdgeEntry nEdge = fromMap.get(tmpNode);
+                EdgeEntry nEdge = fromMap.get(adjNode);
                 if (nEdge == null)
                 {
-                    nEdge = new EdgeEntry(iter.getEdge(), tmpNode, tmpWeight);
+                    nEdge = new EdgeEntry(iter.getEdge(), adjNode, tmpWeight);
                     nEdge.parent = currEdge;
-                    fromMap.put(tmpNode, nEdge);
+                    fromMap.put(adjNode, nEdge);
                     fromHeap.add(nEdge);
                 } else if (nEdge.weight > tmpWeight)
                 {
@@ -101,7 +101,7 @@ private Path runAlgo()
                     fromHeap.add(nEdge);
                 }
 
-                updateShortest(nEdge, neighborNode);
+                updateShortest(nEdge, startNode);
             }
 
             if (fromHeap.isEmpty())
@@ -117,7 +117,7 @@ private Path runAlgo()
     @Override
     protected boolean finished()
     {
-        return currEdge.endNode == to;
+        return currEdge.adjNode == to;
     }
 
     @Override
diff --git a/core/src/main/java/com/graphhopper/routing/DijkstraBidirection.java b/core/src/main/java/com/graphhopper/routing/DijkstraBidirection.java
index 35d8f1308b..2d2e99bc09 100644
--- a/core/src/main/java/com/graphhopper/routing/DijkstraBidirection.java
+++ b/core/src/main/java/com/graphhopper/routing/DijkstraBidirection.java
@@ -132,7 +132,7 @@ protected boolean finished()
     }
 
     void fillEdges( int currNode, double currWeight, int currRef,
-            IntDoubleBinHeap openSet, EdgeWrapper wrapper, EdgeExplorer explorer, boolean reverse)
+            IntDoubleBinHeap openSet, EdgeWrapper wrapper, EdgeExplorer explorer, boolean reverse )
     {
         EdgeIterator iter = explorer.setBaseNode(currNode);
         while (iter.next())
diff --git a/core/src/main/java/com/graphhopper/routing/DijkstraBidirectionRef.java b/core/src/main/java/com/graphhopper/routing/DijkstraBidirectionRef.java
index d27695f89f..c62914e855 100644
--- a/core/src/main/java/com/graphhopper/routing/DijkstraBidirectionRef.java
+++ b/core/src/main/java/com/graphhopper/routing/DijkstraBidirectionRef.java
@@ -147,7 +147,7 @@ protected boolean finished()
     void fillEdges( EdgeEntry currEdge, PriorityQueue<EdgeEntry> prioQueue,
             TIntObjectMap<EdgeEntry> shortestWeightMap, EdgeExplorer explorer, boolean reverse )
     {
-        int currNode = currEdge.endNode;
+        int currNode = currEdge.adjNode;
         EdgeIterator iter = explorer.setBaseNode(currNode);
         while (iter.next())
         {
@@ -157,15 +157,15 @@ void fillEdges( EdgeEntry currEdge, PriorityQueue<EdgeEntry> prioQueue,
             if (currEdge.edge == iter.getEdge())
                 continue;
 
-            int neighborNode = iter.getAdjNode();
+            int adjNode = iter.getAdjNode();
             double tmpWeight = weighting.calcWeight(iter, reverse) + currEdge.weight;
 
-            EdgeEntry de = shortestWeightMap.get(neighborNode);
+            EdgeEntry de = shortestWeightMap.get(adjNode);
             if (de == null)
             {
-                de = new EdgeEntry(iter.getEdge(), neighborNode, tmpWeight);
+                de = new EdgeEntry(iter.getEdge(), adjNode, tmpWeight);
                 de.parent = currEdge;
-                shortestWeightMap.put(neighborNode, de);
+                shortestWeightMap.put(adjNode, de);
                 prioQueue.add(de);
             } else if (de.weight > tmpWeight)
             {
@@ -176,7 +176,7 @@ void fillEdges( EdgeEntry currEdge, PriorityQueue<EdgeEntry> prioQueue,
                 prioQueue.add(de);
             }
 
-            updateShortest(de, neighborNode);
+            updateShortest(de, adjNode);
         }
     }
 
diff --git a/core/src/main/java/com/graphhopper/routing/DijkstraOneToMany.java b/core/src/main/java/com/graphhopper/routing/DijkstraOneToMany.java
index 25da3ebf6d..b6acd5c0bd 100644
--- a/core/src/main/java/com/graphhopper/routing/DijkstraOneToMany.java
+++ b/core/src/main/java/com/graphhopper/routing/DijkstraOneToMany.java
@@ -94,6 +94,8 @@ public Path calcPath( int from, int to )
     public Path extractPath()
     {
         PathNative p = new PathNative(graph, flagEncoder, parents, edgeIds);
+        if (endNode >= 0)
+            p.setWeight(weights[endNode]);
         p.setFromNode(fromNode);
         if (endNode < 0)
             return p;
@@ -225,8 +227,8 @@ public String getName()
     public String getMemoryUsageAsString()
     {
         long len = weights.length;
-        return ((8L + 4L + 4L) * len 
-                + changedNodes.getCapacity() * 4L 
+        return ((8L + 4L + 4L) * len
+                + changedNodes.getCapacity() * 4L
                 + heap.getCapacity() * (4L + 4L)) / Helper.MB
                 + "MB";
     }
diff --git a/core/src/main/java/com/graphhopper/routing/Path.java b/core/src/main/java/com/graphhopper/routing/Path.java
index 715ac9a74b..0fedf4089a 100644
--- a/core/src/main/java/com/graphhopper/routing/Path.java
+++ b/core/src/main/java/com/graphhopper/routing/Path.java
@@ -20,6 +20,7 @@
 import com.graphhopper.routing.util.FlagEncoder;
 import com.graphhopper.storage.EdgeEntry;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.*;
 import gnu.trove.list.TIntList;
 import gnu.trove.list.array.TIntArrayList;
@@ -51,11 +52,13 @@
     private PointList cachedPoints;
     private InstructionList cachedWays;
     private double weight;
+    private NodeAccess nodeAccess;
 
     public Path( Graph graph, FlagEncoder encoder )
     {
         this.weight = Double.MAX_VALUE;
         this.graph = graph;
+        this.nodeAccess = graph.getNodeAccess();
         this.encoder = encoder;
         this.edgeIds = new TIntArrayList();
     }
@@ -67,7 +70,7 @@ public Path( Graph graph, FlagEncoder encoder )
     {
         this(p.graph, p.encoder);
         weight = p.weight;
-        edgeIds = new TIntArrayList(edgeIds);
+        edgeIds = new TIntArrayList(p.edgeIds);
         edgeEntry = p.edgeEntry;
     }
 
@@ -108,17 +111,6 @@ private int getFromNode()
         return fromNode;
     }
 
-    /**
-     * @return the last node of this Path.
-     */
-    private int getEndNode()
-    {
-        if (endNode < 0)
-            throw new IllegalStateException("Call extract() before retrieving endNode");
-
-        return endNode;
-    }
-
     public boolean isFound()
     {
         return found;
@@ -176,14 +168,14 @@ public Path extract()
     {
         extractSW.start();
         EdgeEntry goalEdge = edgeEntry;
-        setEndNode(goalEdge.endNode);
+        setEndNode(goalEdge.adjNode);
         while (EdgeIterator.Edge.isValid(goalEdge.edge))
         {
-            processEdge(goalEdge.edge, goalEdge.endNode);
+            processEdge(goalEdge.edge, goalEdge.adjNode);
             goalEdge = goalEdge.parent;
         }
 
-        setFromNode(goalEdge.endNode);
+        setFromNode(goalEdge.adjNode);
         reverseOrder();
         extractSW.stop();
         return setFound(true);
@@ -205,12 +197,12 @@ public String getDebugInfo()
     /**
      * Calls getDistance and adds the edgeId.
      */
-    protected void processEdge( int edgeId, int endNode )
+    protected void processEdge( int edgeId, int adjNode )
     {
-        EdgeIteratorState iter = graph.getEdgeProps(edgeId, endNode);
+        EdgeIteratorState iter = graph.getEdgeProps(edgeId, adjNode);
         double dist = iter.getDistance();
         distance += dist;
-        millis += calcMillis(dist, iter.getFlags());
+        millis += calcMillis(dist, iter.getFlags(), false);
         addEdge(edgeId);
     }
 
@@ -218,9 +210,18 @@ protected void processEdge( int edgeId, int endNode )
      * Calculates the time in millis for the specified distance in meter and speed (in km/h) via
      * flags.
      */
-    protected long calcMillis( double distance, long flags )
+    protected long calcMillis( double distance, long flags, boolean revert )
     {
-        return (long) (distance * 3600 / encoder.getSpeed(flags));
+        if (revert && !encoder.isBackward(flags)
+                || !revert && !encoder.isForward(flags))
+            throw new IllegalStateException("Calculating time should not require to read speed from edge in wrong direction. "
+                    + "Reverse:" + revert + ", fwd:" + encoder.isForward(flags) + ", bwd:" + encoder.isBackward(flags));
+
+        double speed = revert ? encoder.getReverseSpeed(flags) : encoder.getSpeed(flags);
+        if (Double.isInfinite(speed) || Double.isNaN(speed))
+            throw new IllegalStateException("Invalid speed stored in edge!");
+
+        return (long) (distance * 3600 / speed);
     }
 
     /**
@@ -299,19 +300,21 @@ public void next( EdgeIteratorState eb, int i )
     }
 
     /**
-     * @return the cached list of lat,lon for this path
+     * This method calculated a list of points for this path
+     * <p>
+     * @return this path its geometry (cached)
      */
     public PointList calcPoints()
     {
         if (cachedPoints != null)
             return cachedPoints;
 
-        cachedPoints = new PointList(edgeIds.size() + 1);
+        cachedPoints = new PointList(edgeIds.size() + 1, nodeAccess.is3D());
         if (edgeIds.isEmpty())
             return cachedPoints;
 
         int tmpNode = getFromNode();
-        cachedPoints.add(graph.getLatitude(tmpNode), graph.getLongitude(tmpNode));
+        cachedPoints.add(nodeAccess, tmpNode);
         forEveryEdge(new EdgeVisitor()
         {
             @Override
@@ -320,7 +323,7 @@ public void next( EdgeIteratorState eb, int index )
                 PointList pl = eb.fetchWayGeometry(2);
                 for (int j = 0; j < pl.getSize(); j++)
                 {
-                    cachedPoints.add(pl.getLatitude(j), pl.getLongitude(j));
+                    cachedPoints.add(pl, j);
                 }
             }
         });
@@ -362,23 +365,23 @@ public InstructionList calcInstructions()
              * considering orientation belonging to the interval
              * [ - pi + previousOrientation , + pi + previousOrientation ]
              */
-            private double prevLat = graph.getLatitude(tmpNode);
-            private double prevLon = graph.getLongitude(tmpNode);
+            private double prevLat = nodeAccess.getLatitude(tmpNode);
+            private double prevLon = nodeAccess.getLongitude(tmpNode);
             private double prevOrientation;
             private Instruction prevInstruction;
-            // we do not expose the pointlist in Instruction => no need for elevation
-            private PointList points = new PointList();
+            private PointList points = new PointList(10, nodeAccess.is3D());
             private String name = null;
-            private int pavementCode;
-            private int wayTypeCode;
+            private int pavementType;
+            private int wayType;
+            private final AngleCalc2D ac = new AngleCalc2D();
 
             @Override
             public void next( EdgeIteratorState edge, int index )
             {
                 // baseNode is the current node and adjNode is the next
                 int adjNode = edge.getAdjNode();
-                double adjLat = graph.getLatitude(adjNode);
-                double adjLon = graph.getLongitude(adjNode);
+                double adjLat = nodeAccess.getLatitude(adjNode);
+                double adjLon = nodeAccess.getLongitude(adjNode);
                 double latitude, longitude;
                 PointList wayGeo = edge.fetchWayGeometry(3);
                 if (wayGeo.getSize() <= 2)
@@ -392,83 +395,67 @@ public void next( EdgeIteratorState edge, int index )
 
                     // overwrite previous lat,lon
                     int baseNode = edge.getBaseNode();
-                    prevLat = graph.getLatitude(baseNode);
-                    prevLon = graph.getLongitude(baseNode);
+                    prevLat = nodeAccess.getLatitude(baseNode);
+                    prevLon = nodeAccess.getLongitude(baseNode);
                 }
 
-                double orientation = Math.atan2(latitude - prevLat, longitude - prevLon);
+                double orientation = ac.calcOrientation(prevLat, prevLon, latitude, longitude);
                 if (name == null)
                 {
                     // very first instruction
                     name = edge.getName();
-                    pavementCode = encoder.getPavementCode(edge.getFlags());
-                    wayTypeCode = encoder.getWayTypeCode(edge.getFlags());
-                    prevInstruction = new Instruction(Instruction.CONTINUE_ON_STREET, name, wayTypeCode, pavementCode, points);
+                    pavementType = encoder.getPavementType(edge.getFlags());
+                    wayType = encoder.getWayType(edge.getFlags());
+                    prevInstruction = new Instruction(Instruction.CONTINUE_ON_STREET, name, wayType, pavementType, points);
                     updatePointsAndInstruction(edge, wayGeo);
                     cachedWays.add(prevInstruction);
                 } else
                 {
-                    double tmpOrientation;
-                    if (prevOrientation >= 0)
-                    {
-                        if (orientation < -Math.PI + prevOrientation)
-                            tmpOrientation = orientation + 2 * Math.PI;
-                        else
-                            tmpOrientation = orientation;
-
-                    } else
-                    {
-                        if (orientation > +Math.PI + prevOrientation)
-                            tmpOrientation = orientation - 2 * Math.PI;
-                        else
-                            tmpOrientation = orientation;
-                    }
-
+                    double tmpOrientation = ac.alignOrientation(prevOrientation, orientation);
                     String tmpName = edge.getName();
-                    int tmpPavement = encoder.getPavementCode(edge.getFlags());
-                    int tmpWayType = encoder.getWayTypeCode(edge.getFlags());
+                    int tmpPavement = encoder.getPavementType(edge.getFlags());
+                    int tmpWayType = encoder.getWayType(edge.getFlags());
                     if ((!name.equals(tmpName))
-                            || (pavementCode != tmpPavement)
-                            || (wayTypeCode != tmpWayType))
+                            || (pavementType != tmpPavement)
+                            || (wayType != tmpWayType))
                     {
-                        // we do not expose the pointlist in Instruction => no need for elevation
-                        points = new PointList();
+                        points = new PointList(10, nodeAccess.is3D());
                         name = tmpName;
-                        pavementCode = tmpPavement;
-                        wayTypeCode = tmpWayType;
+                        pavementType = tmpPavement;
+                        wayType = tmpWayType;
                         double delta = Math.abs(tmpOrientation - prevOrientation);
-                        int indication;
+                        int sign;
                         if (delta < 0.2)
                         {
                             // 0.2 ~= 11
-                            indication = Instruction.CONTINUE_ON_STREET;
+                            sign = Instruction.CONTINUE_ON_STREET;
 
                         } else if (delta < 0.8)
                         {
                             // 0.8 ~= 40
                             if (tmpOrientation > prevOrientation)
-                                indication = Instruction.TURN_SLIGHT_LEFT;
+                                sign = Instruction.TURN_SLIGHT_LEFT;
                             else
-                                indication = Instruction.TURN_SLIGHT_RIGHT;
+                                sign = Instruction.TURN_SLIGHT_RIGHT;
 
                         } else if (delta < 1.8)
                         {
                             // 1.8 ~= 103
                             if (tmpOrientation > prevOrientation)
-                                indication = Instruction.TURN_LEFT;
+                                sign = Instruction.TURN_LEFT;
                             else
-                                indication = Instruction.TURN_RIGHT;
+                                sign = Instruction.TURN_RIGHT;
 
                         } else
                         {
                             if (tmpOrientation > prevOrientation)
-                                indication = Instruction.TURN_SHARP_LEFT;
+                                sign = Instruction.TURN_SHARP_LEFT;
                             else
-                                indication = Instruction.TURN_SHARP_RIGHT;
+                                sign = Instruction.TURN_SHARP_RIGHT;
 
                         }
 
-                        prevInstruction = new Instruction(indication, name, wayTypeCode, pavementCode, points);
+                        prevInstruction = new Instruction(sign, name, wayType, pavementType, points);
                         cachedWays.add(prevInstruction);
                     }
 
@@ -482,12 +469,14 @@ public void next( EdgeIteratorState edge, int index )
                 else
                 {
                     int beforeLast = wayGeo.getSize() - 2;
-                    prevOrientation = Math.atan2(adjLat - wayGeo.getLatitude(beforeLast), adjLon - wayGeo.getLongitude(beforeLast));
+                    prevOrientation = ac.calcOrientation(wayGeo.getLatitude(beforeLast), wayGeo.getLongitude(beforeLast),
+                            adjLat, adjLon);
                 }
 
                 boolean lastEdge = index == edgeIds.size() - 1;
                 if (lastEdge)
-                    cachedWays.add(new FinishInstruction(prevLat, prevLon));
+                    cachedWays.add(new FinishInstruction(adjLat, adjLon,
+                            nodeAccess.is3D() ? nodeAccess.getElevation(adjNode) : 0));
             }
 
             private void updatePointsAndInstruction( EdgeIteratorState edge, PointList pl )
@@ -496,20 +485,48 @@ private void updatePointsAndInstruction( EdgeIteratorState edge, PointList pl )
                 int len = pl.size() - 1;
                 for (int i = 0; i < len; i++)
                 {
-                    double lat = pl.getLatitude(i);
-                    double lon = pl.getLongitude(i);
-                    points.add(lat, lon);
+                    points.add(pl, i);
                 }
                 double newDist = edge.getDistance();
                 prevInstruction.setDistance(newDist + prevInstruction.getDistance());
                 long flags = edge.getFlags();
-                prevInstruction.setMillis(calcMillis(newDist, flags) + prevInstruction.getMillis());
+                prevInstruction.setTime(calcMillis(newDist, flags, false) + prevInstruction.getTime());
             }
         });
 
         return cachedWays;
     }
 
+    public Instruction findInstruction( double lat, double lon )
+    {
+        DistanceCalcEarth distanceCalc = new DistanceCalcEarth();
+
+        double distanceToPath = Double.MAX_VALUE;
+
+        int nextInstrNumber = 0;
+
+        // Search the closest edge to the point
+        for (int i = 0; i < cachedWays.getSize() - 1; i++)
+        {
+            double edgeNodeLat1 = cachedWays.get(i).getPoints().getLatitude(0);
+            double edgeNodeLon1 = cachedWays.get(i).getPoints().getLongitude(0);
+            int node2NOP = cachedWays.get(i + 1).getPoints().getSize();
+            double edgeNodeLat2 = cachedWays.get(i + 1).getPoints().getLatitude(node2NOP - 1);
+            double edgeNodeLon2 = cachedWays.get(i + 1).getPoints().getLongitude(node2NOP - 1);
+
+            //Calculate the distance from the point to the edge
+            double distanceToEdge = distanceCalc.calcNormalizedEdgeDistance(lat, lon, edgeNodeLat1, edgeNodeLon1, edgeNodeLat2, edgeNodeLon2);
+
+            if (distanceToEdge < distanceToPath)
+            {
+                distanceToPath = distanceToEdge;
+                nextInstrNumber = i + 1;
+            }
+        }
+
+        return cachedWays.get(nextInstrNumber);
+    }
+
     @Override
     public String toString()
     {
diff --git a/core/src/main/java/com/graphhopper/routing/PathBidir.java b/core/src/main/java/com/graphhopper/routing/PathBidir.java
index 9c6e42ab6e..39cb980c28 100644
--- a/core/src/main/java/com/graphhopper/routing/PathBidir.java
+++ b/core/src/main/java/com/graphhopper/routing/PathBidir.java
@@ -84,9 +84,9 @@ public Path extract()
             if (edgeId < 0)
                 break;
 
-            processEdge(edgeId, nodeTo);
             int tmpRef = edgeWTo.getParent(currRef);
             nodeTo = edgeWTo.getNode(tmpRef);
+            processEdge(edgeId, nodeTo);
             currRef = tmpRef;
         }
         setEndNode(nodeTo);
diff --git a/core/src/main/java/com/graphhopper/routing/PathBidirRef.java b/core/src/main/java/com/graphhopper/routing/PathBidirRef.java
index c61df2dcff..bd82715004 100644
--- a/core/src/main/java/com/graphhopper/routing/PathBidirRef.java
+++ b/core/src/main/java/com/graphhopper/routing/PathBidirRef.java
@@ -66,8 +66,8 @@ public Path extract()
         if (edgeEntry == null || edgeTo == null)
             return this;
 
-        int from = GHUtility.getToNode(graph, edgeEntry.edge, edgeEntry.endNode);
-        int to = GHUtility.getToNode(graph, edgeTo.edge, edgeTo.endNode);
+        int from = GHUtility.getToNode(graph, edgeEntry.edge, edgeEntry.adjNode);
+        int to = GHUtility.getToNode(graph, edgeTo.edge, edgeTo.adjNode);
         if (from != to)
             throw new IllegalStateException("Locations of the 'to'- and 'from'-Edge has to be the same." + toString());
 
@@ -82,20 +82,20 @@ public Path extract()
         EdgeEntry currEdge = edgeEntry;
         while (EdgeIterator.Edge.isValid(currEdge.edge))
         {
-            processEdge(currEdge.edge, currEdge.endNode);
+            processEdge(currEdge.edge, currEdge.adjNode);
             currEdge = currEdge.parent;
         }
-        setFromNode(currEdge.endNode);
+        setFromNode(currEdge.adjNode);
         reverseOrder();
         currEdge = edgeTo;
         int tmpEdge = currEdge.edge;
         while (EdgeIterator.Edge.isValid(tmpEdge))
         {
             currEdge = currEdge.parent;
-            processEdge(tmpEdge, currEdge.endNode);
+            processEdge(tmpEdge, currEdge.adjNode);
             tmpEdge = currEdge.edge;
         }
-        setEndNode(currEdge.endNode);
+        setEndNode(currEdge.adjNode);
         extractSW.stop();
         return setFound(true);
     }
diff --git a/core/src/main/java/com/graphhopper/routing/QueryGraph.java b/core/src/main/java/com/graphhopper/routing/QueryGraph.java
index ece974ef2a..57b0f12d48 100644
--- a/core/src/main/java/com/graphhopper/routing/QueryGraph.java
+++ b/core/src/main/java/com/graphhopper/routing/QueryGraph.java
@@ -20,10 +20,12 @@
 import com.graphhopper.routing.util.AllEdgesIterator;
 import com.graphhopper.routing.util.EdgeFilter;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.index.QueryResult;
 import com.graphhopper.util.*;
 import com.graphhopper.util.shapes.BBox;
 import com.graphhopper.util.shapes.GHPoint;
+import com.graphhopper.util.shapes.GHPoint3D;
 
 import gnu.trove.list.array.TIntArrayList;
 import gnu.trove.map.TIntObjectMap;
@@ -47,6 +49,7 @@
 public class QueryGraph implements Graph
 {
     private final Graph mainGraph;
+    private final NodeAccess mainNodeAccess;
     private final int mainNodes;
     private final int mainEdges;
     private List<QueryResult> queryResults;
@@ -66,6 +69,7 @@
     public QueryGraph( Graph graph )
     {
         mainGraph = graph;
+        mainNodeAccess = graph.getNodeAccess();
         mainNodes = graph.getNodes();
         mainEdges = graph.getAllEdges().getMaxId();
     }
@@ -80,7 +84,7 @@ public void lookup( List<QueryResult> resList )
             throw new IllegalStateException("Call lookup only once. Otherwise you'll have problems for queries sharing the same edge.");
 
         virtualEdges = new ArrayList<EdgeIteratorState>(resList.size() * 2);
-        virtualNodes = new PointList(resList.size());
+        virtualNodes = new PointList(resList.size(), mainNodeAccess.is3D());
         queryResults = new ArrayList<QueryResult>(resList.size());
 
         TIntObjectMap<List<QueryResult>> edge2res = new TIntObjectHashMap<List<QueryResult>>(resList.size());
@@ -96,32 +100,31 @@ public void lookup( List<QueryResult> resList )
 
             int base = closestEdge.getBaseNode();
 
-            // identical direction for all closest edges
-            // important to sort multiple results for the same edge by its wayIndex
-            if (base > closestEdge.getAdjNode())
+            // Force the identical direction for all closest edges. 
+            // It is important to sort multiple results for the same edge by its wayIndex
+            boolean doReverse = base > closestEdge.getAdjNode();
+            if (base == closestEdge.getAdjNode())
             {
-                EdgeIteratorState reverseEdge = mainGraph.getEdgeProps(closestEdge.getEdge(), base);
-                // #111 reverse edge can be null if real edges are disconnected while CH-prepare
-                if (reverseEdge != null)
-                {
-                    closestEdge = reverseEdge;
-                    PointList fullPL = reverseEdge.fetchWayGeometry(3);
-                    res.setClosestEdge(reverseEdge);
-                    if (res.getSnappedPosition() == QueryResult.Position.PILLAR)
-                        // ON pillar node                
-                        res.setWayIndex(fullPL.getSize() - res.getWayIndex() - 1);
-                    else
-                        // for case "OFF pillar node"
-                        res.setWayIndex(fullPL.getSize() - res.getWayIndex() - 2);
-
-                    if (res.getWayIndex() < 0)
-                        throw new IllegalStateException("Problem with wayIndex while reversing closest edge:" + closestEdge + ", " + res);
-                } else
-                {
-                    List<QueryResult> tmp = edge2res.get(closestEdge.getEdge());
-                    if (tmp != null && tmp.size() > 1)
-                        throw new IllegalStateException("No reverse edge can be created but multiple of them were found!? " + resList);
-                }
+                // check for special case #162 where adj == base and force direction via latitude comparison
+                PointList pl = closestEdge.fetchWayGeometry(0);
+                if (pl.size() > 1)
+                    doReverse = pl.getLatitude(0) > pl.getLatitude(pl.size() - 1);
+            }
+
+            if (doReverse)
+            {
+                closestEdge = closestEdge.detach(true);
+                PointList fullPL = closestEdge.fetchWayGeometry(3);
+                res.setClosestEdge(closestEdge);
+                if (res.getSnappedPosition() == QueryResult.Position.PILLAR)
+                    // ON pillar node                
+                    res.setWayIndex(fullPL.getSize() - res.getWayIndex() - 1);
+                else
+                    // for case "OFF pillar node"
+                    res.setWayIndex(fullPL.getSize() - res.getWayIndex() - 2);
+
+                if (res.getWayIndex() < 0)
+                    throw new IllegalStateException("Problem with wayIndex while reversing closest edge:" + closestEdge + ", " + res);
             }
 
             // find multiple results on same edge
@@ -147,7 +150,6 @@ public boolean execute( List<QueryResult> results )
                 EdgeIteratorState closestEdge = results.get(0).getClosestEdge();
                 final PointList fullPL = closestEdge.fetchWayGeometry(3);
                 int baseNode = closestEdge.getBaseNode();
-                final EdgeIteratorState reverseState = mainGraph.getEdgeProps(closestEdge.getEdge(), baseNode);
                 // sort results on the same edge by the wayIndex and if equal by distance to pillar node
                 Collections.sort(results, new Comparator<QueryResult>()
                 {
@@ -174,12 +176,9 @@ public int compare( QueryResult o1, QueryResult o2 )
                     }
                 });
 
-                GHPoint prevPoint = fullPL.toGHPoint(0);
+                GHPoint3D prevPoint = fullPL.toGHPoint(0);
                 int adjNode = closestEdge.getAdjNode();
-                long reverseFlags = 0;
-                // #111 avoid this
-                if (reverseState != null)
-                    reverseFlags = reverseState.getFlags();
+                long reverseFlags = closestEdge.detach(true).getFlags();
                 int prevWayIndex = 1;
                 int prevNodeId = baseNode;
                 int counter = 0;
@@ -193,12 +192,12 @@ public int compare( QueryResult o1, QueryResult o2 )
                         throw new IllegalStateException("Base nodes have to be identical but were not: " + closestEdge + " vs " + res.getClosestEdge());
 
                     queryResults.add(res);
-                    GHPoint currSnapped = res.getSnappedPoint();
-                    boolean onEdge = res.getSnappedPosition() == QueryResult.Position.EDGE;
+                    GHPoint3D currSnapped = res.getSnappedPoint();
                     createEdges(prevPoint, prevWayIndex,
                             res.getSnappedPoint(), res.getWayIndex(),
-                            onEdge, fullPL, closestEdge, prevNodeId, virtNodeId, reverseFlags);
-                    virtualNodes.add(currSnapped.lat, currSnapped.lon);
+                            fullPL, closestEdge, prevNodeId, virtNodeId, reverseFlags);
+
+                    virtualNodes.add(currSnapped.lat, currSnapped.lon, currSnapped.ele);
 
                     // add edges again to set adjacent edges for newVirtNodeId
                     if (counter > 0)
@@ -216,39 +215,37 @@ public int compare( QueryResult o1, QueryResult o2 )
                 }
 
                 // two edges between last result and adjacent node are still missing
-                createEdges(prevPoint, prevWayIndex, fullPL.toGHPoint(fullPL.getSize() - 1), fullPL.getSize() - 1,
-                        false, fullPL, closestEdge, virtNodeId - 1, adjNode, reverseFlags);
+                createEdges(prevPoint, prevWayIndex, fullPL.toGHPoint(fullPL.getSize() - 1), fullPL.getSize() - 2,
+                        fullPL, closestEdge, virtNodeId - 1, adjNode, reverseFlags);
 
                 return true;
             }
         });
     }
 
-    private void createEdges( GHPoint prevSnapped, int prevWayIndex, GHPoint currSnapped, int wayIndex,
-            boolean onEdge, PointList fullPL, EdgeIteratorState closestEdge,
-            int prevNodeId, int nodeId, long swappedFlags )
+    private void createEdges( GHPoint3D prevSnapped, int prevWayIndex, GHPoint3D currSnapped, int wayIndex,
+            PointList fullPL, EdgeIteratorState closestEdge,
+            int prevNodeId, int nodeId, long reverseFlags )
     {
         int max = wayIndex + 1;
-        PointList basePoints = new PointList(max - prevWayIndex + 1);
-        basePoints.add(prevSnapped.lat, prevSnapped.lon);
+        // basePoints must have at least the size of 2 to make sure fetchWayGeometry(3) returns at least 2
+        PointList basePoints = new PointList(max - prevWayIndex + 1, mainNodeAccess.is3D());
+        basePoints.add(prevSnapped.lat, prevSnapped.lon, prevSnapped.ele);
         for (int i = prevWayIndex; i < max; i++)
         {
-            basePoints.add(fullPL.getLatitude(i), fullPL.getLongitude(i));
+            basePoints.add(fullPL, i);
         }
-
-        if (onEdge)
-            basePoints.add(currSnapped.lat, currSnapped.lon);
+        basePoints.add(currSnapped.lat, currSnapped.lon, currSnapped.ele);
 
         PointList baseReversePoints = basePoints.clone(true);
         double baseDistance = basePoints.calcDistance(distCalc);
-
         int virtEdgeId = virtualEdges.size() + mainEdges;
 
         // edges between base and snapped point
         VirtualEdgeIState baseEdge = new VirtualEdgeIState(virtEdgeId + VE_BASE, prevNodeId, nodeId,
                 baseDistance, closestEdge.getFlags(), closestEdge.getName(), basePoints);
         VirtualEdgeIState baseReverseEdge = new VirtualEdgeIState(virtEdgeId + VE_BASE_REV, nodeId, prevNodeId,
-                baseDistance, swappedFlags, closestEdge.getName(), baseReversePoints);
+                baseDistance, reverseFlags, closestEdge.getName(), baseReversePoints);
 
         virtualEdges.add(baseEdge);
         virtualEdges.add(baseReverseEdge);
@@ -261,26 +258,93 @@ public int getNodes()
     }
 
     @Override
-    public double getLatitude( int nodeId )
+    public NodeAccess getNodeAccess()
     {
-        if (nodeId >= mainNodes)
-            return virtualNodes.getLatitude(nodeId - mainNodes);
-        return mainGraph.getLatitude(nodeId);
+        return nodeAccess;
     }
 
-    @Override
-    public double getLongitude( int nodeId )
+    private final NodeAccess nodeAccess = new NodeAccess()
     {
-        if (nodeId >= mainNodes)
-            return virtualNodes.getLongitude(nodeId - mainNodes);
-        return mainGraph.getLongitude(nodeId);
-    }
+        @Override
+        public boolean is3D()
+        {
+            return mainNodeAccess.is3D();
+        }
 
-    @Override
-    public int getAdditionalNodeField( int nodeId )
-    {
-        return mainGraph.getAdditionalNodeField(nodeId);
-    }
+        @Override
+        public int getDimension()
+        {
+            return mainNodeAccess.getDimension();
+        }
+
+        @Override
+        public double getLatitude( int nodeId )
+        {
+            if (nodeId >= mainNodes)
+                return virtualNodes.getLatitude(nodeId - mainNodes);
+            return mainNodeAccess.getLatitude(nodeId);
+        }
+
+        @Override
+        public double getLongitude( int nodeId )
+        {
+            if (nodeId >= mainNodes)
+                return virtualNodes.getLongitude(nodeId - mainNodes);
+            return mainNodeAccess.getLongitude(nodeId);
+        }
+
+        @Override
+        public double getElevation( int nodeId )
+        {
+            if (nodeId >= mainNodes)
+                return virtualNodes.getElevation(nodeId - mainNodes);
+            return mainNodeAccess.getElevation(nodeId);
+        }
+
+        @Override
+        public int getAdditionalNodeField( int nodeId )
+        {
+            if (nodeId >= mainNodes)
+                return 0;
+            return mainNodeAccess.getAdditionalNodeField(nodeId);
+        }
+
+        @Override
+        public void setNode( int nodeId, double lat, double lon )
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+
+        @Override
+        public void setNode( int nodeId, double lat, double lon, double ele )
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+
+        @Override
+        public void setAdditionalNodeField( int nodeId, int additionalValue )
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+
+        @Override
+        public double getLat( int nodeId )
+        {
+            return getLatitude(nodeId);
+        }
+
+        @Override
+        public double getLon( int nodeId )
+        {
+            return getLongitude(nodeId);
+        }
+
+        @Override
+        public double getEle( int nodeId )
+        {
+            return getElevation(nodeId);
+        }
+    };
 
     @Override
     public BBox getBounds()
@@ -423,7 +487,7 @@ void fillVirtualEdges( TIntObjectMap<VirtualEdgeIterator> node2Edge, int towerNo
         while (iter.next())
         {
             if (!ignoreEdges.contains(iter.getEdge()))
-                vIter.add(iter.detach());
+                vIter.add(iter.detach(false));
         }
     }
 
@@ -444,18 +508,6 @@ public AllEdgesIterator getAllEdges()
         throw new UnsupportedOperationException("Not supported yet.");
     }
 
-    @Override
-    public void setNode( int node, double lat, double lon )
-    {
-        throw exc();
-    }
-
-    @Override
-    public void setAdditionalNodeField( int nodeId, int additionalValue )
-    {
-        exc();
-    }
-
     @Override
     public EdgeIteratorState edge( int a, int b )
     {
@@ -520,8 +572,11 @@ public boolean next()
         }
 
         @Override
-        public EdgeIteratorState detach()
+        public EdgeIteratorState detach( boolean reverse )
         {
+            if (reverse)
+                throw new IllegalStateException("Not yet supported");
+
             return edges.get(current);
         }
 
@@ -610,9 +665,9 @@ public EdgeIteratorState setAdditionalField( int value )
         }
 
         @Override
-        public void copyProperties( EdgeIteratorState edge )
+        public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
-            edges.get(current).copyProperties(edge);
+            return edges.get(current).copyPropertiesTo(edge);
         }
 
         @Override
@@ -669,7 +724,7 @@ public void setSkippedEdges( int edge1, int edge2 )
         private final int adjNode;
 
         public VirtualEdgeIState( int edgeId, int baseNode, int adjNode,
-                double distance, long flags, String name, PointList pointList)
+                double distance, long flags, String name, PointList pointList )
         {
             this.edgeId = edgeId;
             this.baseNode = baseNode;
@@ -677,7 +732,7 @@ public VirtualEdgeIState( int edgeId, int baseNode, int adjNode,
             this.distance = distance;
             this.flags = flags;
             this.name = name;
-            this.pointList = pointList;            
+            this.pointList = pointList;
         }
 
         @Override
@@ -777,7 +832,7 @@ public boolean isShortcut()
         {
             return false;
         }
-        
+
         @Override
         public int getAdditionalField()
         {
@@ -803,7 +858,7 @@ public void setSkippedEdges( int edge1, int edge2 )
         }
 
         @Override
-        public EdgeIteratorState detach()
+        public EdgeIteratorState detach( boolean reverse )
         {
             throw new UnsupportedOperationException("Not supported.");
         }
@@ -815,7 +870,7 @@ public EdgeIteratorState setAdditionalField( int value )
         }
 
         @Override
-        public void copyProperties( EdgeIteratorState edge )
+        public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
             throw new UnsupportedOperationException("Not supported.");
         }
diff --git a/core/src/main/java/com/graphhopper/routing/ch/Path4CH.java b/core/src/main/java/com/graphhopper/routing/ch/Path4CH.java
index f94a6e82ae..54807733e7 100644
--- a/core/src/main/java/com/graphhopper/routing/ch/Path4CH.java
+++ b/core/src/main/java/com/graphhopper/routing/ch/Path4CH.java
@@ -43,14 +43,14 @@ protected void processEdge( int tmpEdge, int endNode )
         expandEdge((EdgeSkipIterState) graph.getEdgeProps(tmpEdge, endNode), false);
     }
 
-    private void expandEdge( EdgeSkipIterState mainEdgeState, boolean revert )
+    private void expandEdge( EdgeSkipIterState mainEdgeState, boolean reverse )
     {
         if (!mainEdgeState.isShortcut())
         {
             double dist = mainEdgeState.getDistance();
             distance += dist;
             long flags = mainEdgeState.getFlags();
-            millis += calcMillis(dist, flags);
+            millis += calcMillis(dist, flags, reverse);
             addEdge(mainEdgeState.getEdge());
             return;
         }
@@ -58,7 +58,7 @@ private void expandEdge( EdgeSkipIterState mainEdgeState, boolean revert )
         int skippedEdge1 = mainEdgeState.getSkippedEdge1();
         int skippedEdge2 = mainEdgeState.getSkippedEdge2();
         int from = mainEdgeState.getBaseNode(), to = mainEdgeState.getAdjNode();
-        if (revert)
+        if (reverse)
         {
             int tmp = from;
             from = to;
diff --git a/core/src/main/java/com/graphhopper/routing/ch/PreparationWeighting.java b/core/src/main/java/com/graphhopper/routing/ch/PreparationWeighting.java
index ff527d669b..79e06b5be9 100644
--- a/core/src/main/java/com/graphhopper/routing/ch/PreparationWeighting.java
+++ b/core/src/main/java/com/graphhopper/routing/ch/PreparationWeighting.java
@@ -46,7 +46,7 @@ public double getMinWeight( double distance )
     public double calcWeight( EdgeIteratorState edge, boolean reverse )
     {
         if (edge instanceof EdgeSkipIterState)
-        {            
+        {
             EdgeSkipIterState tmp = (EdgeSkipIterState) edge;
             if (tmp.isShortcut())
                 // if a shortcut is in both directions the weight is identical => no need for 'reverse'
diff --git a/core/src/main/java/com/graphhopper/routing/ch/PrepareContractionHierarchies.java b/core/src/main/java/com/graphhopper/routing/ch/PrepareContractionHierarchies.java
index c1a6a77ae3..0a52955fc7 100644
--- a/core/src/main/java/com/graphhopper/routing/ch/PrepareContractionHierarchies.java
+++ b/core/src/main/java/com/graphhopper/routing/ch/PrepareContractionHierarchies.java
@@ -34,6 +34,7 @@
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.LevelGraph;
 import com.graphhopper.storage.LevelGraphStorage;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.*;
 import java.util.*;
 import org.slf4j.Logger;
@@ -55,7 +56,7 @@
 {
     private final Logger logger = LoggerFactory.getLogger(getClass());
     private final PreparationWeighting prepareWeighting;
-    private final FlagEncoder prepareEncoder;
+    private final FlagEncoder prepareFlagEncoder;
     private EdgeSkipExplorer vehicleInExplorer;
     private EdgeSkipExplorer vehicleOutExplorer;
     private EdgeSkipExplorer vehicleAllExplorer;
@@ -66,9 +67,6 @@
     private GHTreeMapComposed sortedNodes;
     private int oldPriorities[];
     private final DataAccess originalEdges;
-    // shortcut is one direction, speed is only involved while recalculating the endNode weights - see prepareEdges
-    private final long scFwdDir;
-    private final long scBothDir;
     private final Map<Shortcut, Shortcut> shortcuts = new HashMap<Shortcut, Shortcut>();
     private IgnoreNodeFilter ignoreNodeFilter;
     private DijkstraOneToMany algo;
@@ -88,12 +86,11 @@
 
     public PrepareContractionHierarchies( FlagEncoder encoder, Weighting weighting )
     {
-        prepareEncoder = encoder;
-        scFwdDir = encoder.setAccess(0, true, false);
-        scBothDir = encoder.setAccess(0, true, true);
+        prepareFlagEncoder = encoder;
+        long scFwdDir = encoder.setAccess(0, true, false);
 
         // shortcuts store weight in flags where we assume bit 1 and 2 are used for access restriction
-        if ((scFwdDir & 0x1) == 0)
+        if ((scFwdDir & PrepareEncoder.getScFwdDir()) == 0)
             throw new IllegalArgumentException("Currently only one vehicle is supported if you enable CH. "
                     + "It seems that you have imported more than one.");
 
@@ -109,22 +106,6 @@ public PrepareContractionHierarchies setGraph( Graph g )
         return this;
     }
 
-    /**
-     * A long with only the two access bits enabled
-     */
-    long getScBothDir()
-    {
-        return scBothDir;
-    }
-
-    /**
-     * A long with only the forward access bit enabled
-     */
-    long getScFwdDir()
-    {
-        return scFwdDir;
-    }
-
     /**
      * The higher the values are the longer the preparation takes but the less shortcuts are
      * produced.
@@ -202,7 +183,7 @@ public void setInitialCollectionSize( int initialCollectionSize )
     public PrepareContractionHierarchies doWork()
     {
         checkGraph();
-        if (prepareEncoder == null)
+        if (prepareFlagEncoder == null)
             throw new IllegalStateException("No vehicle encoder set.");
 
         if (prepareWeighting == null)
@@ -224,9 +205,6 @@ public PrepareContractionHierarchies doWork()
 
     boolean prepareEdges()
     {
-        // In CH the setProperties (speed) are ignored as calculating the new setProperties for a shortcut is often not possible.
-        // Also several shortcuts would be necessary with the different modes (e.g. fastest and shortest)
-        // So calculate the weight and store this as weight, then use only weight instead of calcWeight
         EdgeIterator iter = g.getAllEdges();
         int c = 0;
         while (iter.next())
@@ -385,7 +363,7 @@ void contractNodes()
         logger.info("took:" + (int) allSW.stop().getSeconds()
                 + ", new shortcuts: " + newShortcuts
                 + ", " + prepareWeighting
-                + ", " + prepareEncoder
+                + ", " + prepareFlagEncoder
                 + ", removeHigher2LowerEdges:" + removesHigher2LowerEdges
                 + ", dijkstras:" + dijkstraCount
                 + ", t(dijk):" + (int) dijkstraSW.getSeconds()
@@ -483,18 +461,19 @@ public void foundShortcut( int u_fromNode, int w_toNode,
             // Hint: shortcuts are always one-way due to distinct level of every node but we don't
             // know yet the levels so we need to determine the correct direction or if both directions
             // minor improvement: if (shortcuts.containsKey(sc) 
-            // then two shortcuts with the same nodes (u<->n.endNode) exists => check current shortcut against both
+            // then two shortcuts with the same nodes (u<->n.adjNode) exists => check current shortcut against both
             Shortcut sc = new Shortcut(u_fromNode, w_toNode, existingDirectWeight, existingDistSum);
             if (shortcuts.containsKey(sc))
-            {
                 return;
-            } else
+
+            Shortcut tmpSc = new Shortcut(w_toNode, u_fromNode, existingDirectWeight, existingDistSum);
+            Shortcut tmpRetSc = shortcuts.get(tmpSc);
+            if (tmpRetSc != null)
             {
-                Shortcut tmpSc = new Shortcut(w_toNode, u_fromNode, existingDirectWeight, existingDistSum);
-                Shortcut tmpRetSc = shortcuts.get(tmpSc);
-                if (tmpRetSc != null)
+                // overwrite flags only if skipped edges are identical
+                if (tmpRetSc.skippedEdge2 == skippedEdge1 && tmpRetSc.skippedEdge1 == outgoingEdges.getEdge())
                 {
-                    tmpRetSc.flags = scBothDir;
+                    tmpRetSc.flags = PrepareEncoder.getScDirMask();
                     return;
                 }
             }
@@ -513,20 +492,20 @@ public void foundShortcut( int u_fromNode, int w_toNode,
     }
 
     /**
-     * Calculates the priority of endNode v without changing the graph. Warning: the calculated
+     * Calculates the priority of adjNode v without changing the graph. Warning: the calculated
      * priority must NOT depend on priority(v) and therefor findShortcuts should also not depend on
      * the priority(v). Otherwise updating the priority before contracting in contractNodes() could
      * lead to a slowishor even endless loop.
      */
     int calculatePriority( int v )
     {
-        // set of shortcuts that would be added if endNode v would be contracted next.
+        // set of shortcuts that would be added if adjNode v would be contracted next.
         findShortcuts(calcScHandler.setNode(v));
 
 //        System.out.println(v + "\t " + tmpShortcuts);
         // # huge influence: the bigger the less shortcuts gets created and the faster is the preparation
         //
-        // every endNode has an 'original edge' number associated. initially it is r=1
+        // every adjNode has an 'original edge' number associated. initially it is r=1
         // when a new shortcut is introduced then r of the associated edges is summed up:
         // r(u,w)=r(u,v)+r(v,w) now we can define
         // originalEdgesCount = (v) := sum_{ (u,w)  shortcuts(v) } of r(u, w)
@@ -553,7 +532,7 @@ int calculatePriority( int v )
         // # low influence: with it the shortcut creation is slightly faster
         //
         // |shortcuts(v)|  |{(u, v) | v uncontracted}|  |{(v, w) | v uncontracted}|        
-        // meanDegree is used instead of outDegree+inDegree as if one endNode is in both directions
+        // meanDegree is used instead of outDegree+inDegree as if one adjNode is in both directions
         // only one bucket memory is used. Additionally one shortcut could also stand for two directions.
         int edgeDifference = calcScHandler.shortcuts - degree;
 
@@ -597,6 +576,11 @@ void findShortcuts( ShortcutHandler sch )
                 // If we decrease the correct weight we only explore less and introduce more shortcuts.
                 // I.e. no change to accuracy is made.
                 double existingDirectWeight = v_u_weight + prepareWeighting.calcWeight(outgoingEdges, false);
+                if (Double.isNaN(existingDirectWeight))
+                    throw new IllegalStateException("Weighting should never return NaN values"
+                            + ", in:" + getCoords(incomingEdges, g) + ", out:" + getCoords(outgoingEdges, g)
+                            + ", dist:" + outgoingEdges.getDistance() + ", speed:" + prepareFlagEncoder.getSpeed(outgoingEdges.getFlags()));
+
                 if (existingDirectWeight >= Double.MAX_VALUE)
                     continue;
                 double existingDistSum = v_u_dist + outgoingEdges.getDistance();
@@ -629,7 +613,7 @@ void findShortcuts( ShortcutHandler sch )
     }
 
     /**
-     * Introduces the necessary shortcuts for endNode v in the graph.
+     * Introduces the necessary shortcuts for adjNode v in the graph.
      */
     int addShortcuts( int v )
     {
@@ -645,16 +629,27 @@ int addShortcuts( int v )
             while (iter.next())
             {
                 if (iter.isShortcut() && iter.getAdjNode() == sc.to
-                        && prepareEncoder.canBeOverwritten(iter.getFlags(), sc.flags))
+                        && PrepareEncoder.canBeOverwritten(iter.getFlags(), sc.flags))
                 {
                     if (sc.weight >= prepareWeighting.calcWeight(iter, false))
                         continue NEXT_SC;
 
-                    // note: flags overwrite weight => call them first
+                    if (iter.getEdge() == sc.skippedEdge1 || iter.getEdge() == sc.skippedEdge2)
+                    {
+                        throw new IllegalStateException("Shortcut cannot update itself! " + iter.getEdge()
+                                + ", skipEdge1:" + sc.skippedEdge1 + ", skipEdge2:" + sc.skippedEdge2
+                                + ", edge " + iter + ":" + getCoords(iter, g)
+                                + ", sc:" + sc
+                                + ", skippedEdge1: " + getCoords(g.getEdgeProps(sc.skippedEdge1, sc.from), g)
+                                + ", skippedEdge2: " + getCoords(g.getEdgeProps(sc.skippedEdge2, sc.to), g)
+                                + ", neighbors:" + GHUtility.getNeighbors(iter));
+                    }
+
+                    // note: flags overwrite weight => call first
                     iter.setFlags(sc.flags);
-                    iter.setSkippedEdges(sc.skippedEdge1, sc.skippedEdge2);
-                    iter.setDistance(sc.dist);
                     iter.setWeight(sc.weight);
+                    iter.setDistance(sc.dist);
+                    iter.setSkippedEdges(sc.skippedEdge1, sc.skippedEdge2);
                     setOrigEdgeCount(iter.getEdge(), sc.originalEdges);
                     updatedInGraph = true;
                     break;
@@ -664,7 +659,7 @@ int addShortcuts( int v )
             if (!updatedInGraph)
             {
                 EdgeSkipIterState edgeState = g.shortcut(sc.from, sc.to);
-                // note: flags overwrite weight => call them first
+                // note: flags overwrite weight => call first
                 edgeState.setFlags(sc.flags);
                 edgeState.setWeight(sc.weight);
                 edgeState.setDistance(sc.dist);
@@ -676,14 +671,23 @@ int addShortcuts( int v )
         return tmpNewShortcuts;
     }
 
+    String getCoords( EdgeIteratorState e, Graph g )
+    {
+        NodeAccess na = g.getNodeAccess();
+        int base = e.getBaseNode();
+        int adj = e.getAdjNode();
+        return base + "->" + adj + " (" + e.getEdge() + "); "
+                + na.getLat(base) + "," + na.getLon(base) + " -> " + na.getLat(adj) + "," + na.getLon(adj);
+    }
+
     PrepareContractionHierarchies initFromGraph()
     {
         checkGraph();
-        vehicleInExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareEncoder, true, false));
-        vehicleOutExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareEncoder, false, true));
-        vehicleAllExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareEncoder, true, true));
-        vehicleAllTmpExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareEncoder, true, true));
-        calcPrioAllExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareEncoder, true, true));
+        vehicleInExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareFlagEncoder, true, false));
+        vehicleOutExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareFlagEncoder, false, true));
+        vehicleAllExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareFlagEncoder, true, true));
+        vehicleAllTmpExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareFlagEncoder, true, true));
+        calcPrioAllExplorer = g.createEdgeExplorer(new DefaultEdgeFilter(prepareFlagEncoder, true, true));
         ignoreNodeFilter = new IgnoreNodeFilter(g);
         // Use an alternative to PriorityQueue as it has some advantages: 
         //   1. Gets automatically smaller if less entries are stored => less total RAM used (as Graph is increasing until the end)
@@ -691,7 +695,7 @@ PrepareContractionHierarchies initFromGraph()
         //   but we need additional priorities array to keep old value which is necessary for update method
         sortedNodes = new GHTreeMapComposed();
         oldPriorities = new int[g.getNodes()];
-        algo = new DijkstraOneToMany(g, prepareEncoder, prepareWeighting);
+        algo = new DijkstraOneToMany(g, prepareFlagEncoder, prepareWeighting);
         return this;
     }
 
@@ -719,7 +723,7 @@ public IgnoreNodeFilter setAvoidNode( int node )
         @Override
         public final boolean accept( EdgeIteratorState iter )
         {
-            // ignore if it is skipNode or a endNode already contracted
+            // ignore if it is skipNode or a adjNode already contracted
             int node = iter.getAdjNode();
             return avoidNode != node && graph.getLevel(node) == 0;
         }
@@ -745,7 +749,7 @@ public RoutingAlgorithm createAlgo()
     {
         checkGraph();
         // do not change weight within DijkstraBidirectionRef => so use ShortestWeighting
-        DijkstraBidirectionRef dijkstrabi = new DijkstraBidirectionRef(g, prepareEncoder, prepareWeighting)
+        DijkstraBidirectionRef dijkstrabi = new DijkstraBidirectionRef(g, prepareFlagEncoder, prepareWeighting)
         {
             @Override
             protected void initCollections( int nodes )
@@ -793,7 +797,7 @@ public String toString()
     public AStarBidirection createAStar()
     {
         checkGraph();
-        AStarBidirection astar = new AStarBidirection(g, prepareEncoder, prepareWeighting)
+        AStarBidirection astar = new AStarBidirection(g, prepareFlagEncoder, prepareWeighting)
         {
             @Override
             protected void initCollections( int nodes )
@@ -878,7 +882,7 @@ public int compareTo( PriorityNode o )
         double dist;
         double weight;
         int originalEdges;
-        long flags = scFwdDir;
+        long flags = PrepareEncoder.getScFwdDir();
 
         public Shortcut( int from, int to, double weight, double dist )
         {
@@ -914,9 +918,13 @@ public boolean equals( Object obj )
         @Override
         public String toString()
         {
-            if (flags == scBothDir)
-                return from + "<->" + to + ", weight:" + weight;
-            return from + "->" + to + ", weight:" + weight;
+            String str;
+            if (flags == PrepareEncoder.getScDirMask())
+                str = from + "<->";
+            else
+                str = from + "->";
+
+            return str + to + ", weight:" + weight + " (" + skippedEdge1 + "," + skippedEdge2 + ")";
         }
     }
 }
diff --git a/core/src/main/java/com/graphhopper/routing/ch/PrepareEncoder.java b/core/src/main/java/com/graphhopper/routing/ch/PrepareEncoder.java
new file mode 100644
index 0000000000..6aee636cba
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/routing/ch/PrepareEncoder.java
@@ -0,0 +1,61 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.routing.ch;
+
+/**
+ * The flags are stored differently for shortcuts: just a weight and the direction flags. Currently
+ * it is not allowed to store multiple vehicles.
+ * <p>
+ * @author Peter Karich
+ */
+public class PrepareEncoder
+{
+    // shortcut is one direction, speed is only involved while recalculating the adjNode weights
+    // see PrepareContractionHierarchies.prepareEdges
+    private static final long scFwdDir = 0x1;
+    private static final long scDirMask = 0x3;
+
+    public static final long getScDirMask()
+    {
+        return scDirMask;
+    }
+
+    public static final long getScFwdDir()
+    {
+        return scFwdDir;
+    }
+
+    /**
+     * Returns true if flags1 can be overwritten in the edge by flags2 without restricting or
+     * changing the directions of flags1.
+     * <p>
+     * @return true if flags2 is enabled in both directions or if both flags are pointing into the
+     * same direction.
+     */
+    //        \  flags2:
+    // flags1  \ -> | <- | <->
+    // ->         t | f  | t
+    // <-         f | t  | t
+    // <->        f | f  | t
+    public static final boolean canBeOverwritten( long flags1, long flags2 )
+    {
+        return (flags2 & scDirMask) == scDirMask
+                || (flags1 & scDirMask) == (flags2 & scDirMask);
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/routing/util/AbstractFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/AbstractFlagEncoder.java
index 3a23c80f52..56e85e4d56 100644
--- a/core/src/main/java/com/graphhopper/routing/util/AbstractFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/AbstractFlagEncoder.java
@@ -29,16 +29,13 @@
 import com.graphhopper.reader.OSMWay;
 import com.graphhopper.reader.OSMRelation;
 import com.graphhopper.reader.OSMTurnRelation.TurnCostTableEntry;
-import com.graphhopper.util.BitUtil;
-import com.graphhopper.util.DistanceCalcEarth;
-import com.graphhopper.util.EdgeExplorer;
-import com.graphhopper.util.Helper;
+import com.graphhopper.util.*;
 import java.util.Collections;
 
 /**
  * Abstract class which handles flag decoding and encoding. Every encoder should be registered to a
- * EncodingManager to be usable. Although the flag is of type long only the int-portition is
- * currently stored.
+ * EncodingManager to be usable. If you want the full long to be stored you need to enable this in
+ * the GraphHopperStorage.
  * <p/>
  * @author Peter Karich
  * @author Nop
@@ -119,7 +116,7 @@ public int defineWayBits( int index, int shift )
     {
         if (forwardBit != 0)
             throw new IllegalStateException("You must not register a FlagEncoder (" + toString() + ") twice!");
-        
+
         // define the first 2 speedBits in flags for routing
         forwardBit = 1 << shift;
         backwardBit = 2 << shift;
@@ -169,28 +166,32 @@ public int defineTurnBits( int index, int shift, int numberCostsBits )
     }
 
     /**
-     * Analyze the properties of a relation and create the routing flags for the second read step
+     * Analyze the properties of a relation and create the routing flags for the second read step.
+     * In the pre-parsing step this method will be called to determine the useful relation tags.
      * <p/>
      */
     public abstract long handleRelationTags( OSMRelation relation, long oldRelationFlags );
 
     /**
-     * Decide whether a way is routable for a given mode of travel
+     * Decide whether a way is routable for a given mode of travel. This skips some ways before
+     * handleWayTags is called.
      * <p/>
      * @return the encoded value to indicate if this encoder allows travel or not.
      */
     public abstract long acceptWay( OSMWay way );
 
     /**
-     * Analyze properties of a way and create the routing flags
+     * Analyze properties of a way and create the routing flags. This method is called in the second
+     * parsing step.
      */
     public abstract long handleWayTags( OSMWay way, long allowed, long relationFlags );
 
     /**
      * Parse tags on nodes. Node tags can add to speed (like traffic_signals) where the value is
-     * strict negative or blocks access (like a barrier), then the value is strict positive.
+     * strict negative or blocks access (like a barrier), then the value is strict positive.This
+     * method is called in the second parsing step.
      */
-    public long analyzeNodeTags( OSMNode node )
+    public long handleNodeTags( OSMNode node )
     {
         // movable barriers block if they are not marked as passable
         if (node.hasTag("barrier", potentialBarriers)
@@ -205,6 +206,9 @@ public long analyzeNodeTags( OSMNode node )
         return 0;
     }
 
+    /**
+     * This method is called after determining the node flags and way flags.
+     */
     public long applyNodeFlags( long wayFlags, long nodeFlags )
     {
         return nodeFlags | wayFlags;
@@ -222,34 +226,23 @@ public boolean isBackward( long flags )
         return (flags & backwardBit) != 0;
     }
 
-    public boolean isBoth( long flags )
-    {
-        return (flags & directionBitMask) == directionBitMask;
-    }
-
     @Override
-    public boolean canBeOverwritten( long flags1, long flags2 )
+    public int getPavementType( long flags )
     {
-        return isBoth(flags2) || (flags1 & directionBitMask) == (flags2 & directionBitMask);
-    }
-
-    @Override
-    public int getPavementCode( long flags )
-    {
-        return -1;
+        return 0;
     }
 
     @Override
-    public int getWayTypeCode( long flags )
+    public int getWayType( long flags )
     {
-        return -1;
+        return 0;
     }
 
     /**
      * Swapping directions means swapping bits which are dependent on the direction of an edge like
      * the access bits. But also direction dependent speed values should be swapped too.
      */
-    public long swapDirection( long flags )
+    public long reverseFlags( long flags )
     {
         long dir = flags & directionBitMask;
         if (dir == directionBitMask || dir == 0)
@@ -258,16 +251,6 @@ public long swapDirection( long flags )
         return flags ^ directionBitMask;
     }
 
-    @Override
-    public double getSpeed( long flags )
-    {
-        double speedVal = speedEncoder.getDoubleValue(flags);
-        if (speedVal < 0)
-            throw new IllegalStateException("Speed was negative!? " + speedVal);
-
-        return speedVal;
-    }
-
     /**
      * Sets default flags with specified access.
      */
@@ -287,13 +270,36 @@ public long setAccess( long flags, boolean forward, boolean backward )
     public long setSpeed( long flags, double speed )
     {
         if (speed < 0)
-            throw new IllegalArgumentException("Speed cannot be negative: " + speed + ", flags:" + BitUtil.LITTLE.toBitString(flags));
+            throw new IllegalArgumentException("Speed cannot be negative: " + speed
+                    + ", flags:" + BitUtil.LITTLE.toBitString(flags));
 
         if (speed > getMaxSpeed())
             speed = getMaxSpeed();
         return speedEncoder.setDoubleValue(flags, speed);
     }
 
+    @Override
+    public double getSpeed( long flags )
+    {
+        double speedVal = speedEncoder.getDoubleValue(flags);
+        if (speedVal < 0)
+            throw new IllegalStateException("Speed was negative!? " + speedVal);
+
+        return speedVal;
+    }
+
+    @Override
+    public long setReverseSpeed( long flags, double speed )
+    {
+        return setSpeed(flags, speed);
+    }
+
+    @Override
+    public double getReverseSpeed( long flags )
+    {
+        return getSpeed(flags);
+    }
+
     @Override
     public long setProperties( double speed, boolean forward, boolean backward )
     {
@@ -331,20 +337,13 @@ public boolean equals( Object obj )
         return this.toString().equals(other.toString());
     }
 
-    public String getWayInfo( OSMWay way )
-    {
-        return "";
-    }
-
     /**
      * @return the speed in km/h
      */
     protected static double parseSpeed( String str )
     {
         if (Helper.isEmpty(str))
-        {
-            return -1;
-        }
+            return -1;        
 
         try
         {
@@ -430,29 +429,37 @@ protected static int parseDuration( String str )
             }
         } catch (Exception ex)
         {
-            logger.error("Cannot parse " + str + " using 0 minutes");
+            logger.warn("Cannot parse " + str + " using 0 minutes");
         }
         return 0;
     }
 
+    /**
+     * Second parsing step. Invoked after splitting the edges. Currently used to offer a hook to
+     * calculate precise speed values based on elevation data stored in the specified edge.
+     */
+    public void applyWayTags( OSMWay way, EdgeIteratorState edge )
+    {
+    }
+
     /**
      * Special handling for ferry ways.
      */
-    protected long handleFerry( OSMWay way, double unknownSpeed, double shortTripsSpeed, double longTripsSpeed )
+    protected long handleFerryTags( OSMWay way, double unknownSpeed, double shortTripsSpeed, double longTripsSpeed )
     {
         // to hours
         double durationInHours = parseDuration(way.getTag("duration")) / 60d;
         if (durationInHours > 0)
             try
             {
-                Number estimatedLength = way.getInternalTag("estimated_distance", null);
+                Number estimatedLength = way.getTag("estimated_distance", null);
                 if (estimatedLength != null)
                 {
                     // to km
                     double val = estimatedLength.doubleValue() / 1000;
                     // If duration AND distance is available we can calculate the speed more precisely
                     // and set both speed to the same value. Factor 1.4 slower because of waiting time!
-                    shortTripsSpeed = (int) Math.round(val / durationInHours / 1.4);
+                    shortTripsSpeed = Math.round(val / durationInHours / 1.4);
                     if (shortTripsSpeed > getMaxSpeed())
                         shortTripsSpeed = getMaxSpeed();
                     longTripsSpeed = shortTripsSpeed;
diff --git a/core/src/main/java/com/graphhopper/routing/util/Bike2WeightFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/Bike2WeightFlagEncoder.java
new file mode 100644
index 0000000000..20b6dd7809
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/routing/util/Bike2WeightFlagEncoder.java
@@ -0,0 +1,201 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.routing.util;
+
+import com.graphhopper.reader.OSMWay;
+import com.graphhopper.util.BitUtil;
+import com.graphhopper.util.DistanceCalc3D;
+import com.graphhopper.util.EdgeIteratorState;
+import com.graphhopper.util.PointList;
+import static com.graphhopper.util.Helper.*;
+
+/**
+ * Stores two speed values into an edge to support avoiding too much incline
+ * <p>
+ * @author Peter Karich
+ */
+public class Bike2WeightFlagEncoder extends BikeFlagEncoder
+{
+    private final DistanceCalc3D distCalc = new DistanceCalc3D();
+    private EncodedDoubleValue reverseSpeed;
+
+    @Override
+    public int defineWayBits( int index, int shift )
+    {
+        shift = super.defineWayBits(index, shift);
+        reverseSpeed = new EncodedDoubleValue("Speed", shift, speedBits, speedFactor, getHighwaySpeed("cycleway"), 30);
+        shift += reverseSpeed.getBits();
+        return shift;
+    }
+
+    @Override
+    public double getReverseSpeed( long flags )
+    {
+        return reverseSpeed.getDoubleValue(flags);
+    }
+
+    @Override
+    public long setReverseSpeed( long flags, double speed )
+    {
+        if (speed < 0)
+            throw new IllegalArgumentException("Speed cannot be negative: " + speed + ", flags:" + BitUtil.LITTLE.toBitString(flags));
+
+        if (speed > getMaxSpeed())
+            speed = getMaxSpeed();
+
+        return reverseSpeed.setDoubleValue(flags, speed);
+    }
+
+    @Override
+    public long handleSpeed( OSMWay way, double speed, long encoded )
+    {
+        // handle oneways
+        if ((way.hasTag("oneway", oneways) || way.hasTag("junction", "roundabout"))
+                && !way.hasTag("oneway:bicycle", "no")
+                && !way.hasTag("cycleway", oppositeLanes))
+        {
+
+            if (way.hasTag("oneway", "-1"))
+            {
+                encoded |= backwardBit;
+                encoded = setReverseSpeed(encoded, speed);
+            } else
+            {
+                encoded |= forwardBit;
+                encoded = setSpeed(encoded, speed);
+            }
+        } else
+        {
+            encoded |= directionBitMask;
+            encoded = setSpeed(encoded, speed);
+            encoded = setReverseSpeed(encoded, speed);
+        }
+        return encoded;
+    }
+
+    @Override
+    public long flagsDefault( boolean forward, boolean backward )
+    {
+        long flags = super.flagsDefault(forward, backward);
+        if (backward)
+            return reverseSpeed.setDefaultValue(flags);
+
+        return flags;
+    }
+
+    @Override
+    public long setProperties( double speed, boolean forward, boolean backward )
+    {
+        long flags = super.setProperties(speed, forward, backward);
+        if (backward)
+            return setReverseSpeed(flags, speed);
+
+        return flags;
+    }
+
+    @Override
+    public long reverseFlags( long flags )
+    {
+        // swap access
+        flags = super.reverseFlags(flags);
+
+        // swap speeds 
+        double otherValue = reverseSpeed.getDoubleValue(flags);
+        flags = setReverseSpeed(flags, speedEncoder.getDoubleValue(flags));
+        return setSpeed(flags, otherValue);
+    }
+
+    @Override
+    public void applyWayTags( OSMWay way, EdgeIteratorState edge )
+    {
+        PointList pl = edge.fetchWayGeometry(3);
+        if (!pl.is3D())
+            throw new IllegalStateException("To support speed calculation based on elevation data it is necessary to enable import of it.");
+
+        long flags = edge.getFlags();
+
+        // TODO increase speed due to decline only if surface is okay
+        if (way.hasTag("highway", "steps"))
+        {
+            double speed = getHighwaySpeed("steps");
+            flags = setReverseSpeed(setSpeed(flags, speed), speed);
+        } else
+        {
+            double incEleSum = 0, incDist2DSum = 0;
+            double decEleSum = 0, decDist2DSum = 0;
+            double prevLat = pl.getLatitude(0), prevLon = pl.getLongitude(0), prevEle = pl.getElevation(0);
+            double fullDist2D = 0;
+            for (int i = 1; i < pl.size(); i++)
+            {
+                double lat = pl.getLatitude(i);
+                double lon = pl.getLongitude(i);
+                double ele = pl.getElevation(i);
+                double eleDelta = ele - prevEle;
+                double dist2D = distCalc.calcDist(prevLat, prevLon, lat, lon);
+                if (eleDelta > 0)
+                {
+                    incEleSum += eleDelta;
+                    incDist2DSum += dist2D;
+                } else
+                {
+                    decEleSum += -eleDelta;
+                    decDist2DSum += dist2D;
+                }
+                fullDist2D += dist2D;
+                prevLat = lat;
+                prevLon = lon;
+            }
+
+            // Calculate slop via tan(asin(height/distance)) but for rather smallish angles tan a=a and sin a=a.
+            // Then calculate a factor which decreases or increases the speed.
+            // Do this via a simple quadratic equation where y(0)=1 and y(0.3)=1/4 for incline and y(0.3)=2 for decline        
+            double fwdInc = incDist2DSum > 1 ? incEleSum / incDist2DSum : 0;
+            double fwdDec = decDist2DSum > 1 ? decEleSum / decDist2DSum : 0;
+            double restDist2D = fullDist2D - incDist2DSum - decDist2DSum;
+            double maxSpeed = getHighwaySpeed("cycleway");
+            if (isForward(flags))
+            {
+                double speed = getSpeed(flags);
+                // for decline use a maximum factor between 1 and 2
+                double fwdFaster = keepIn(11.1 * fwdDec * fwdDec + 1, 1, 2);
+                // for ascending use a minimum factor of 1/4 and 1
+                double fwdSlower = keepIn(-8.3 * fwdInc * fwdInc + 1, .25, 1);
+                // use weighted mean so that longer incline infuences speed more            
+                speed = speed * (fwdSlower * incDist2DSum + fwdFaster * decDist2DSum + 1 * restDist2D) / fullDist2D;
+                flags = this.setSpeed(flags, keepIn(speed, PUSHING_SECTION_SPEED, maxSpeed));
+            }
+
+            if (isBackward(flags))
+            {
+                double speedReverse = getReverseSpeed(flags);
+                double bwFaster = keepIn(11.1 * fwdInc * fwdInc + 1, 1, 2);
+                double bwSlower = keepIn(-8.3 * fwdDec * fwdDec + 1, 1 / 4, 1);
+                speedReverse = speedReverse * (bwFaster * incDist2DSum + bwSlower * decDist2DSum + 1 * restDist2D) / fullDist2D;
+                flags = this.setReverseSpeed(flags, keepIn(speedReverse, PUSHING_SECTION_SPEED, maxSpeed));
+            }
+        }
+        edge.setFlags(flags);
+    }
+
+    @Override
+    public String toString()
+    {
+        return "bike2";
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/routing/util/BikeFlagCommonEncoder.java b/core/src/main/java/com/graphhopper/routing/util/BikeFlagCommonEncoder.java
index eed19b00ec..724246997d 100644
--- a/core/src/main/java/com/graphhopper/routing/util/BikeFlagCommonEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/BikeFlagCommonEncoder.java
@@ -42,7 +42,7 @@
     private int unpavedBit = 0;
     // Pushing section heighways are parts where you need to get off your bike and push it (German: Schiebestrecke)
     private final HashSet<String> pushingSections = new HashSet<String>();
-    private final HashSet<String> oppositeLanes = new HashSet<String>();
+    protected final HashSet<String> oppositeLanes = new HashSet<String>();
     private final Set<String> unpavedSurfaceTags = new HashSet<String>();
     private final Map<String, Integer> trackTypeSpeed = new HashMap<String, Integer>();
     private final Map<String, Integer> surfaceSpeed = new HashMap<String, Integer>();
@@ -243,66 +243,12 @@ public long handleWayTags( OSMWay way, long allowed, long relationFlags )
                 speed = relationWeightCodeToSpeed(getSpeed(way), (int) relationCodeEncoder.getValue(relationFlags));
             }
 
-            // Make sure that we do not exceed the limits:
-            if (speed > speedEncoder.getMaxValue())
-                speed = speedEncoder.getMaxValue();
-            else if (speed < 0)
-                speed = 0;
-            encoded = setSpeed(0, speed);
-
-            // handle oneways
-            if ((way.hasTag("oneway", oneways) || way.hasTag("junction", "roundabout"))
-                    && !way.hasTag("oneway:bicycle", "no")
-                    && !way.hasTag("cycleway", oppositeLanes))
-            {
-
-                if (way.hasTag("oneway", "-1"))
-                {
-                    encoded |= backwardBit;
-                } else
-                {
-                    encoded |= forwardBit;
-                }
-            } else
-            {
-                encoded |= directionBitMask;
-            }
-
-            String highway = way.getTag("highway");
-
-            /*            
-             // mark safe ways or ways with cycle lanes
-             if (SAFE_HIGHWAY_TAGS.contains(highway) || way.hasTag("cycleway"))
-             {
-             encoded |= safeWayBit;
-             }
-             */
-            // mark unpaved bit
-            String surfaceTag = way.getTag("surface");
-            String trackType = way.getTag("tracktype");
-            if ("track".equals(highway) && trackType == null
-                    || ("track".equals(highway) && !"grade1".equals(trackType))
-                    || (surfaceTag == null && way.hasTag("highway", "path"))
-                    || unpavedSurfaceTags.contains(surfaceTag))
-            {
-                encoded |= unpavedBit;
-            }
-
-            // Populate bits at wayTypeMask with wayType            
-            WayType ourWayType = WayType.OTHER_SMALL_WAY;
-            if (way.hasTag("highway", pushingSections))
-                ourWayType = WayType.PUSHING_SECTION;
-            if ((way.hasTag("bicycle", intended) && way.hasTag("highway", pushingSections))
-                    || ("cycleway".equals(way.getTag("highway"))))
-                ourWayType = WayType.CYCLEWAY;
-            if (way.hasTag("highway", roadValues))
-                ourWayType = WayType.ROAD;
-
-            encoded = wayTypeEncoder.setValue(encoded, ourWayType.getValue());
+            encoded = handleSpeed(way, speed, 0);
+            encoded = handleBikeRelated(way, encoded);
 
         } else
         {
-            encoded = handleFerry(way,
+            encoded = handleFerryTags(way,
                     highwaySpeed.get("living_street"),
                     highwaySpeed.get("track"),
                     highwaySpeed.get("primary"));
@@ -312,13 +258,13 @@ else if (speed < 0)
     }
 
     @Override
-    public long analyzeNodeTags( OSMNode node )
+    public long handleNodeTags( OSMNode node )
     {
         // absolute barriers always block
         if (node.hasTag("barrier", absoluteBarriers))
             return directionBitMask;
 
-        return super.analyzeNodeTags(node);
+        return super.handleNodeTags(node);
     }
 
     int getSpeed( OSMWay way )
@@ -371,7 +317,7 @@ int getSpeed( OSMWay way )
     }
 
     @Override
-    public int getPavementCode( long flags )
+    public int getPavementType( long flags )
     {
         if ((flags & unpavedBit) != 0)
             return 1; // unpaved
@@ -380,11 +326,67 @@ public int getPavementCode( long flags )
     }
 
     @Override
-    public int getWayTypeCode( long flags )
+    public int getWayType( long flags )
     {
         return (int) wayTypeEncoder.getValue(flags);
     }
 
+    protected long handleBikeRelated( OSMWay way, long encoded )
+    {
+        String highway = way.getTag("highway");
+
+        /*            
+         // mark safe ways or ways with cycle lanes
+         if (SAFE_HIGHWAY_TAGS.contains(highway) || way.hasTag("cycleway"))
+         {
+         encoded |= safeWayBit;
+         }
+         */
+        // mark unpaved bit
+        String surfaceTag = way.getTag("surface");
+        String trackType = way.getTag("tracktype");
+        if ("track".equals(highway) && trackType == null
+                || ("track".equals(highway) && !"grade1".equals(trackType))
+                || (surfaceTag == null && way.hasTag("highway", "path"))
+                || unpavedSurfaceTags.contains(surfaceTag))
+        {
+            encoded |= unpavedBit;
+        }
+
+        // Populate bits at wayTypeMask with wayType            
+        WayType ourWayType = WayType.OTHER_SMALL_WAY;
+        if (way.hasTag("highway", pushingSections))
+            ourWayType = WayType.PUSHING_SECTION;
+        if ((way.hasTag("bicycle", intended) && way.hasTag("highway", pushingSections))
+                || ("cycleway".equals(way.getTag("highway"))))
+            ourWayType = WayType.CYCLEWAY;
+        if (way.hasTag("highway", roadValues))
+            ourWayType = WayType.ROAD;
+
+        return wayTypeEncoder.setValue(encoded, ourWayType.getValue());
+    }
+
+    protected long handleSpeed( OSMWay way, double speed, long encoded )
+    {
+        encoded = setSpeed(0, speed);
+
+        // handle oneways
+        if ((way.hasTag("oneway", oneways) || way.hasTag("junction", "roundabout"))
+                && !way.hasTag("oneway:bicycle", "no")
+                && !way.hasTag("cycleway", oppositeLanes))
+        {
+            if (way.hasTag("oneway", "-1"))
+                encoded |= backwardBit;
+            else
+                encoded |= forwardBit;
+
+        } else
+        {
+            encoded |= directionBitMask;
+        }
+        return encoded;
+    }
+
     public enum RelationMapCode
     {
         /* Inspired by http://wiki.openstreetmap.org/wiki/Class:bicycle
@@ -443,27 +445,32 @@ public int getValue()
 
     };
 
-    public void setTrackTypeSpeed( String tracktype, int speed )
+    protected void setTrackTypeSpeed( String tracktype, int speed )
     {
         trackTypeSpeed.put(tracktype, speed);
     }
 
-    public void setSurfaceSpeed( String surface, int speed )
+    protected void setSurfaceSpeed( String surface, int speed )
     {
         surfaceSpeed.put(surface, speed);
     }
 
-    public void setHighwaySpeed( String highway, int speed )
+    protected void setHighwaySpeed( String highway, int speed )
     {
         highwaySpeed.put(highway, speed);
     }
 
-    public void setCyclingNetworkPreference( String network, int code )
+    protected int getHighwaySpeed( String key )
+    {
+        return highwaySpeed.get(key);
+    }
+
+    protected void setCyclingNetworkPreference( String network, int code )
     {
         bikeNetworkToCode.put(network, code);
     }
 
-    public void setPushingSection( String highway )
+    protected void setPushingSection( String highway )
     {
         pushingSections.add(highway);
     }
diff --git a/core/src/main/java/com/graphhopper/routing/util/BikeFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/BikeFlagEncoder.java
index 963a17ecfa..d5a1fa75d2 100644
--- a/core/src/main/java/com/graphhopper/routing/util/BikeFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/BikeFlagEncoder.java
@@ -32,18 +32,18 @@
         setTrackTypeSpeed("grade4", 10);
         setTrackTypeSpeed("grade5", 8); // like sand/grass     
 
-        setSurfaceSpeed("paved", 20);        
+        setSurfaceSpeed("paved", 20);
         setSurfaceSpeed("asphalt", 20);
         setSurfaceSpeed("cobblestone", 10);
         setSurfaceSpeed("cobblestone:flattened", 10);
-        setSurfaceSpeed("sett",8);
+        setSurfaceSpeed("sett", 8);
         setSurfaceSpeed("concrete", 20);
         setSurfaceSpeed("concrete:lanes", 16);
         setSurfaceSpeed("concrete:plates", 16);
         setSurfaceSpeed("paving_stones", 10);
         setSurfaceSpeed("paving_stones:30", 10);
         setSurfaceSpeed("unpaved", 16);
-        setSurfaceSpeed("compacted",18);        
+        setSurfaceSpeed("compacted", 18);
         setSurfaceSpeed("dirt", 10);
         setSurfaceSpeed("earth", 10);
         setSurfaceSpeed("fine_gravel", 18);
diff --git a/core/src/main/java/com/graphhopper/routing/util/CarFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/CarFlagEncoder.java
index dfc630ced2..9e6ea6ddab 100644
--- a/core/src/main/java/com/graphhopper/routing/util/CarFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/CarFlagEncoder.java
@@ -39,6 +39,15 @@
  */
 public class CarFlagEncoder extends AbstractFlagEncoder
 {
+    protected final Map<String, Integer> trackTypeSpeedMap = new HashMap<String, Integer>();
+    protected final Set<String> badSurfaceSpeedMap = new HashSet<String>();
+    /**
+     * A map which associates string to speed. Get some impression:
+     * http://www.itoworld.com/map/124#fullscreen
+     * http://wiki.openstreetmap.org/wiki/OSM_tags_for_routing/Maxspeed
+     */
+    protected final Map<String, Integer> defaultSpeedMap = new HashMap<String, Integer>();
+
     /**
      * Should be only instantied via EncodingManager
      */
@@ -50,7 +59,10 @@ protected CarFlagEncoder()
     protected CarFlagEncoder( int speedBits, double speedFactor )
     {
         super(speedBits, speedFactor);
-        restrictions = new String[] { "motorcar", "motor_vehicle", "vehicle", "access" };
+        restrictions = new String[]
+        {
+            "motorcar", "motor_vehicle", "vehicle", "access"
+        };
         restrictedValues.add("private");
         restrictedValues.add("agricultural");
         restrictedValues.add("forestry");
@@ -70,6 +82,46 @@ protected CarFlagEncoder( int speedBits, double speedFactor )
         absoluteBarriers.add("turnstile");
         absoluteBarriers.add("cycle_barrier");
         absoluteBarriers.add("block");
+
+        trackTypeSpeedMap.put("grade1", 20); // paved
+        trackTypeSpeedMap.put("grade2", 15); // now unpaved - gravel mixed with ...
+        trackTypeSpeedMap.put("grade3", 10); // ... hard and soft materials
+        trackTypeSpeedMap.put("grade4", 5); // ... some hard or compressed materials
+        trackTypeSpeedMap.put("grade5", 5); // ... no hard materials. soil/sand/grass
+
+        badSurfaceSpeedMap.add("cobblestone");
+        badSurfaceSpeedMap.add("grass_paver");
+        badSurfaceSpeedMap.add("gravel");
+        badSurfaceSpeedMap.add("sand");
+        badSurfaceSpeedMap.add("paving_stones");
+        badSurfaceSpeedMap.add("dirt");
+        badSurfaceSpeedMap.add("ground");
+        badSurfaceSpeedMap.add("grass");
+
+        // autobahn
+        defaultSpeedMap.put("motorway", 100);
+        defaultSpeedMap.put("motorway_link", 70);
+        // bundesstrae
+        defaultSpeedMap.put("trunk", 70);
+        defaultSpeedMap.put("trunk_link", 65);
+        // linking bigger town
+        defaultSpeedMap.put("primary", 65);
+        defaultSpeedMap.put("primary_link", 60);
+        // linking towns + villages
+        defaultSpeedMap.put("secondary", 60);
+        defaultSpeedMap.put("secondary_link", 50);
+        // streets without middle line separation
+        defaultSpeedMap.put("tertiary", 50);
+        defaultSpeedMap.put("tertiary_link", 40);
+        defaultSpeedMap.put("unclassified", 30);
+        defaultSpeedMap.put("residential", 30);
+        // spielstrae
+        defaultSpeedMap.put("living_street", 5);
+        defaultSpeedMap.put("service", 20);
+        // unknown road
+        defaultSpeedMap.put("road", 20);
+        // forestry stuff
+        defaultSpeedMap.put("track", 15);
     }
 
     /**
@@ -80,14 +132,14 @@ public int defineWayBits( int index, int shift )
     {
         // first two bits are reserved for route handling in superclass
         shift = super.defineWayBits(index, shift);
-        speedEncoder = new EncodedDoubleValue("Speed", shift, speedBits, speedFactor, SPEED.get("secondary"), SPEED.get("motorway"));
+        speedEncoder = new EncodedDoubleValue("Speed", shift, speedBits, speedFactor, defaultSpeedMap.get("secondary"), defaultSpeedMap.get("motorway"));
         return shift + speedBits;
     }
 
     protected double getSpeed( OSMWay way )
     {
         String highwayValue = way.getTag("highway");
-        Integer speed = SPEED.get(highwayValue);
+        Integer speed = defaultSpeedMap.get(highwayValue);
         if (speed == null)
             throw new IllegalStateException("car, no speed found for:" + highwayValue);
 
@@ -96,7 +148,7 @@ protected double getSpeed( OSMWay way )
             String tt = way.getTag("tracktype");
             if (!Helper.isEmpty(tt))
             {
-                Integer tInt = TRACKTYPE_SPEED.get(tt);
+                Integer tInt = trackTypeSpeedMap.get(tt);
                 if (tInt != null)
                     speed = tInt;
             }
@@ -123,7 +175,7 @@ public long acceptWay( OSMWay way )
             return 0;
         }
 
-        if (!SPEED.containsKey(highwayValue))
+        if (!defaultSpeedMap.containsKey(highwayValue))
             return 0;
 
         if (way.hasTag("impassable", "yes") || way.hasTag("status", "impassable"))
@@ -167,8 +219,15 @@ public long handleWayTags( OSMWay way, long allowed, long relationCode )
                 // reduce speed limit to reflect average speed
                 speed = maxspeed * 0.9;
 
+            double maxSpeed = parseSpeed(way.getTag("maxspeed:forward"));
+            double backSpeed = parseSpeed(way.getTag("maxspeed:backward"));
+            if (maxSpeed >= 0)
+                speed = maxSpeed * 0.9;
+            if (backSpeed >= 0 && speed > backSpeed * 0.9)
+                speed = backSpeed * 0.9;
+
             // limit speed to max 30 km/h if bad surface
-            if (speed > 30 && way.hasTag("surface", BAD_SURFACE))
+            if (speed > 30 && way.hasTag("surface", badSurfaceSpeedMap))
                 speed = 30;
 
             encoded = setSpeed(0, speed);
@@ -184,7 +243,7 @@ public long handleWayTags( OSMWay way, long allowed, long relationCode )
 
         } else
         {
-            encoded = handleFerry(way, SPEED.get("living_street"), SPEED.get("service"), SPEED.get("residential"));
+            encoded = handleFerryTags(way, defaultSpeedMap.get("living_street"), defaultSpeedMap.get("service"), defaultSpeedMap.get("residential"));
             encoded |= directionBitMask;
         }
 
@@ -192,16 +251,15 @@ public long handleWayTags( OSMWay way, long allowed, long relationCode )
     }
 
     @Override
-    public long analyzeNodeTags( OSMNode node )
+    public long handleNodeTags( OSMNode node )
     {
         // absolute barriers always block
         if (node.hasTag("barrier", absoluteBarriers))
             return directionBitMask;
 
-        return super.analyzeNodeTags(node);
+        return super.handleNodeTags(node);
     }
 
-    @Override
     public String getWayInfo( OSMWay way )
     {
         String str = "";
@@ -238,81 +296,17 @@ public String getWayInfo( OSMWay way )
     @Override
     public Collection<TurnCostTableEntry> analyzeTurnRelation( OSMTurnRelation turnRelation, OSMReader osmReader )
     {
-        if(edgeOutExplorer == null || edgeInExplorer == null) {
+        if (edgeOutExplorer == null || edgeInExplorer == null)
+        {
             edgeOutExplorer = osmReader.getGraphStorage().createEdgeExplorer(new DefaultEdgeFilter(this, false, true));
             edgeInExplorer = osmReader.getGraphStorage().createEdgeExplorer(new DefaultEdgeFilter(this, true, false));
         }
         return turnRelation.getRestrictionAsEntries(this, edgeOutExplorer, edgeInExplorer, osmReader);
     }
 
-    @Override
-    public int getPavementCode( long flags )
-    {
-        return 0;
-    }
-
-    @Override
-    public int getWayTypeCode( long flags )
-    {
-        return 0;
-    }
-
     @Override
     public String toString()
     {
         return "car";
     }
-
-    private static final Map<String, Integer> TRACKTYPE_SPEED = new HashMap<String, Integer>();
-    protected static final Set<String> BAD_SURFACE = new HashSet<String>();
-    /**
-     * A map which associates string to speed. Get some impression:
-     * http://www.itoworld.com/map/124#fullscreen
-     * http://wiki.openstreetmap.org/wiki/OSM_tags_for_routing/Maxspeed
-     */
-    private static final Map<String, Integer> SPEED = new HashMap<String, Integer>();
-
-    static
-    {
-
-        TRACKTYPE_SPEED.put("grade1", 20); // paved
-        TRACKTYPE_SPEED.put("grade2", 15); // now unpaved - gravel mixed with ...
-        TRACKTYPE_SPEED.put("grade3", 10); // ... hard and soft materials
-        TRACKTYPE_SPEED.put("grade4", 5); // ... some hard or compressed materials
-        TRACKTYPE_SPEED.put("grade5", 5); // ... no hard materials. soil/sand/grass
-
-        BAD_SURFACE.add("cobblestone");
-        BAD_SURFACE.add("grass_paver");
-        BAD_SURFACE.add("gravel");
-        BAD_SURFACE.add("sand");
-        BAD_SURFACE.add("paving_stones");
-        BAD_SURFACE.add("dirt");
-        BAD_SURFACE.add("ground");
-        BAD_SURFACE.add("grass");
-
-        // autobahn
-        SPEED.put("motorway", 100);
-        SPEED.put("motorway_link", 70);
-        // bundesstrae
-        SPEED.put("trunk", 70);
-        SPEED.put("trunk_link", 65);
-        // linking bigger town
-        SPEED.put("primary", 65);
-        SPEED.put("primary_link", 60);
-        // linking towns + villages
-        SPEED.put("secondary", 60);
-        SPEED.put("secondary_link", 50);
-        // streets without middle line separation
-        SPEED.put("tertiary", 50);
-        SPEED.put("tertiary_link", 40);
-        SPEED.put("unclassified", 30);
-        SPEED.put("residential", 30);
-        // spielstrae
-        SPEED.put("living_street", 5);
-        SPEED.put("service", 20);
-        // unknown road
-        SPEED.put("road", 20);
-        // forestry stuff
-        SPEED.put("track", 15);
-    }
 }
diff --git a/core/src/main/java/com/graphhopper/routing/util/EdgeFilter.java b/core/src/main/java/com/graphhopper/routing/util/EdgeFilter.java
index 156e306fc7..8823be538b 100644
--- a/core/src/main/java/com/graphhopper/routing/util/EdgeFilter.java
+++ b/core/src/main/java/com/graphhopper/routing/util/EdgeFilter.java
@@ -30,7 +30,7 @@
      * @return true if the current edge should be processed and false otherwise.
      */
     boolean accept( EdgeIteratorState edgeIterState );
-    
+
     static final EdgeFilter ALL_EDGES = new EdgeFilter()
     {
         @Override
diff --git a/core/src/main/java/com/graphhopper/routing/util/EncodedDoubleValue.java b/core/src/main/java/com/graphhopper/routing/util/EncodedDoubleValue.java
index a425aa2b92..9011a9fed5 100644
--- a/core/src/main/java/com/graphhopper/routing/util/EncodedDoubleValue.java
+++ b/core/src/main/java/com/graphhopper/routing/util/EncodedDoubleValue.java
@@ -62,7 +62,7 @@ public long setDoubleValue( long flags, double value )
 
         // clear value bits
         flags &= ~mask;
-        
+
         // set value
         return flags | tmpValue;
     }
diff --git a/core/src/main/java/com/graphhopper/routing/util/EncodingManager.java b/core/src/main/java/com/graphhopper/routing/util/EncodingManager.java
index b22f112bfd..4fa7500307 100644
--- a/core/src/main/java/com/graphhopper/routing/util/EncodingManager.java
+++ b/core/src/main/java/com/graphhopper/routing/util/EncodingManager.java
@@ -32,6 +32,8 @@
 import com.graphhopper.reader.OSMTurnRelation;
 import com.graphhopper.reader.OSMTurnRelation.TurnCostTableEntry;
 import com.graphhopper.reader.OSMWay;
+import com.graphhopper.util.EdgeIteratorState;
+import com.graphhopper.util.Helper;
 import java.util.*;
 
 /**
@@ -45,6 +47,7 @@
 {
     public static final String CAR = "car";
     public static final String BIKE = "bike";
+    public static final String BIKE2 = "bike2";
     public static final String RACINGBIKE = "racingbike";
     public static final String MOUNTAINBIKE = "mtb";
     public static final String FOOT = "foot";
@@ -55,6 +58,7 @@
     {
         defaultEdgeFlagEncoders.put(CAR, CarFlagEncoder.class.getName());
         defaultEdgeFlagEncoders.put(BIKE, BikeFlagEncoder.class.getName());
+        defaultEdgeFlagEncoders.put(BIKE2, Bike2WeightFlagEncoder.class.getName());
         defaultEdgeFlagEncoders.put(RACINGBIKE, RacingBikeFlagEncoder.class.getName());
         defaultEdgeFlagEncoders.put(MOUNTAINBIKE, MountainBikeFlagEncoder.class.getName());
         defaultEdgeFlagEncoders.put(FOOT, FootFlagEncoder.class.getName());
@@ -70,6 +74,7 @@
     private final int bytesForFlags;
     private final int maxTurnFlagsBits;
     private final int maxTurnCost;
+    private boolean enableInstructions = true;
 
     /**
      * Instantiate manager with the given list of encoders. The manager knows the default encoders:
@@ -82,10 +87,15 @@ public EncodingManager( String flagEncodersStr )
     {
         this(flagEncodersStr, 4);
     }
-    
+
     public EncodingManager( String flagEncodersStr, int bytesForFlags )
     {
-        this(Arrays.asList(readFromEncoderString(defaultEdgeFlagEncoders, flagEncodersStr).toArray(new FlagEncoder[0])), bytesForFlags, 0);
+        this(flagEncodersStr, bytesForFlags, 0);
+    }
+
+    public EncodingManager( String flagEncodersStr, int bytesForFlags, int maxTurnCost )
+    {
+        this(Arrays.asList(readFromEncoderString(defaultEdgeFlagEncoders, flagEncodersStr).toArray(new FlagEncoder[0])), bytesForFlags, maxTurnCost);
     }
 
     /**
@@ -173,24 +183,27 @@ public int getBytesForFlags()
         return resultEncoders;
     }
 
+    private static final String ERR = "Encoders are requesting more than %s bits of %s flags. ";
+    private static final String WAY_ERR = "Decrease the number of vehicles or increase the flags to take long.";
+
     private void registerEncoder( AbstractFlagEncoder encoder )
     {
         int encoderCount = edgeEncoders.size();
         int usedBits = encoder.defineNodeBits(encoderCount, edgeEncoderNextBit);
         if (usedBits > bytesForFlags)
-            throw new IllegalArgumentException("Encoders are requesting more than " + bytesForFlags + " bits of node flags");
+            throw new IllegalArgumentException(String.format(ERR, bytesForFlags, "node"));
         encoder.setNodeBitMask(usedBits - nextNodeBit, nextNodeBit);
         nextNodeBit = usedBits;
 
         usedBits = encoder.defineWayBits(encoderCount, nextWayBit);
         if (usedBits > bytesForFlags)
-            throw new IllegalArgumentException("Encoders are requesting more than " + bytesForFlags + " bits of way flags");
+            throw new IllegalArgumentException(String.format(ERR, bytesForFlags, "way") + WAY_ERR);
         encoder.setWayBitMask(usedBits - nextWayBit, nextWayBit);
         nextWayBit = usedBits;
 
         usedBits = encoder.defineRelationBits(encoderCount, nextRelBit);
         if (usedBits > bytesForFlags)
-            throw new IllegalArgumentException("Encoders are requesting more than " + bytesForFlags + " bits of relation flags");
+            throw new IllegalArgumentException(String.format(ERR, bytesForFlags, "relation"));
         encoder.setRelBitMask(usedBits - nextRelBit, nextRelBit);
         nextRelBit = usedBits;
 
@@ -199,7 +212,7 @@ private void registerEncoder( AbstractFlagEncoder encoder )
         // turn flag bits are independent from edge encoder bits
         usedBits = encoder.defineTurnBits(encoderCount, nextTurnBit, determineRequiredBits(maxTurnCost));
         if (usedBits > maxTurnFlagsBits)
-            throw new IllegalArgumentException("Encoders are requesting more than " + maxTurnFlagsBits + " bits of turn flags");
+            throw new IllegalArgumentException(String.format(ERR, bytesForFlags, "turn"));
         nextTurnBit = usedBits;
 
         //everything okay, add encoder
@@ -221,11 +234,10 @@ public FlagEncoder getEncoder( String name )
 
     private FlagEncoder getEncoder( String name, boolean throwExc )
     {
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            if (name.equalsIgnoreCase(edgeEncoders.get(i).toString()))
-                return edgeEncoders.get(i);
+            if (name.equalsIgnoreCase(encoder.toString()))
+                return encoder;
         }
         if (throwExc)
             throw new IllegalArgumentException("Encoder for " + name + " not found.");
@@ -238,10 +250,9 @@ private FlagEncoder getEncoder( String name, boolean throwExc )
     public long acceptWay( OSMWay way )
     {
         long includeWay = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            includeWay |= edgeEncoders.get(i).acceptWay(way);
+            includeWay |= encoder.acceptWay(way);
         }
 
         return includeWay;
@@ -250,10 +261,9 @@ public long acceptWay( OSMWay way )
     public long handleRelationTags( OSMRelation relation, long oldRelationFlags )
     {
         long flags = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            flags |= edgeEncoders.get(i).handleRelationTags(relation, oldRelationFlags);
+            flags |= encoder.handleRelationTags(relation, oldRelationFlags);
         }
 
         return flags;
@@ -269,10 +279,8 @@ public long handleRelationTags( OSMRelation relation, long oldRelationFlags )
     public long handleWayTags( OSMWay way, long includeWay, long relationFlags )
     {
         long flags = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            AbstractFlagEncoder encoder = edgeEncoders.get(i);
             flags |= encoder.handleWayTags(way, includeWay, relationFlags & encoder.getRelBitMask());
         }
 
@@ -288,13 +296,12 @@ public int getVehicleCount()
     public String toString()
     {
         StringBuilder str = new StringBuilder();
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
             if (str.length() > 0)
                 str.append(",");
 
-            str.append(edgeEncoders.get(i).toString());
+            str.append(encoder.toString());
         }
 
         return str.toString();
@@ -303,15 +310,14 @@ public String toString()
     public String toDetailsString()
     {
         StringBuilder str = new StringBuilder();
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
             if (str.length() > 0)
                 str.append(",");
 
-            str.append(edgeEncoders.get(i).toString());
+            str.append(encoder.toString());
             str.append(":");
-            str.append(edgeEncoders.get(i).getClass().getName());
+            str.append(encoder.getClass().getName());
         }
 
         return str.toString();
@@ -331,23 +337,21 @@ public FlagEncoder getSingle()
     public long flagsDefault( boolean forward, boolean backward )
     {
         long flags = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            flags |= edgeEncoders.get(i).flagsDefault(forward, backward);
+            flags |= encoder.flagsDefault(forward, backward);
         }
         return flags;
     }
 
     /**
-     * Swap direction for all encoders
+     * Reverse flags, to do so all encoders are called.
      */
-    public long swapDirection( long flags )
+    public long reverseFlags( long flags )
     {
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            flags = edgeEncoders.get(i).swapDirection(flags);
+            flags = encoder.reverseFlags(flags);
         }
         return flags;
     }
@@ -364,13 +368,11 @@ public int hashCode()
     public boolean equals( Object obj )
     {
         if (obj == null)
-        {
             return false;
-        }
+
         if (getClass() != obj.getClass())
-        {
             return false;
-        }
+
         final EncodingManager other = (EncodingManager) obj;
         if (this.edgeEncoders != other.edgeEncoders && (this.edgeEncoders == null || !this.edgeEncoders.equals(other.edgeEncoders)))
         {
@@ -382,44 +384,25 @@ public boolean equals( Object obj )
     /**
      * Analyze tags on osm node. Store node tags (barriers etc) for later usage while parsing way.
      */
-    public long analyzeNodeTags( OSMNode node )
+    public long handleNodeTags( OSMNode node )
     {
         long flags = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            flags |= edgeEncoders.get(i).analyzeNodeTags(node);
+            flags |= encoder.handleNodeTags(node);
         }
 
         return flags;
     }
 
-    public String getWayInfo( OSMWay way )
-    {
-        String str = "";
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
-        {
-            String tmpWayInfo = edgeEncoders.get(i).getWayInfo(way);
-            if (tmpWayInfo.isEmpty())
-                continue;
-            if (!str.isEmpty())
-                str += ", ";
-            str += tmpWayInfo;
-        }
-        return str;
-    }
-
     /**
      * When parsing the ways we have the node flags as long variable encoded in analyzeNode.
      */
     public long applyNodeFlags( long wayFlags, long nodeFlags )
     {
         long flags = 0;
-        int encoderCount = edgeEncoders.size();
-        for (int i = 0; i < encoderCount; i++)
+        for (AbstractFlagEncoder encoder : edgeEncoders)
         {
-            AbstractFlagEncoder encoder = edgeEncoders.get(i);
             flags |= encoder.applyNodeFlags(wayFlags & encoder.getWayBitMask(), nodeFlags);
         }
 
@@ -461,4 +444,44 @@ private static int determineRequiredBits( int value )
 
         return entries.valueCollection();
     }
+
+    public EncodingManager setEnableInstructions( boolean enableInstructions )
+    {
+        this.enableInstructions = enableInstructions;
+        return this;
+    }
+
+    public void applyWayTags( OSMWay way, EdgeIteratorState edge )
+    {
+        // storing the road name does not yet depend on the flagEncoder so manage it directly
+        if (enableInstructions)
+        {
+            // String wayInfo = carFlagEncoder.getWayInfo(way);
+            // http://wiki.openstreetmap.org/wiki/Key:name
+            String name = fixWayName(way.getTag("name"));
+            // http://wiki.openstreetmap.org/wiki/Key:ref
+            String refName = fixWayName(way.getTag("ref"));
+            if (!Helper.isEmpty(refName))
+            {
+                if (Helper.isEmpty(name))
+                    name = refName;
+                else
+                    name += ", " + refName;
+            }
+
+            edge.setName(name);
+        }
+
+        for (AbstractFlagEncoder encoder : edgeEncoders)
+        {
+            encoder.applyWayTags(way, edge);
+        }
+    }
+
+    static String fixWayName( String str )
+    {
+        if (str == null)
+            return "";
+        return str.replaceAll(";[ ]*", ", ");
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/routing/util/FastestWeighting.java b/core/src/main/java/com/graphhopper/routing/util/FastestWeighting.java
index 1d2a8365af..a5c3909d50 100644
--- a/core/src/main/java/com/graphhopper/routing/util/FastestWeighting.java
+++ b/core/src/main/java/com/graphhopper/routing/util/FastestWeighting.java
@@ -44,7 +44,10 @@ public double getMinWeight( double distance )
     @Override
     public double calcWeight( EdgeIteratorState edge, boolean reverse )
     {
-        return edge.getDistance() / encoder.getSpeed(edge.getFlags());
+        double speed = reverse ? encoder.getReverseSpeed(edge.getFlags()) : encoder.getSpeed(edge.getFlags());
+        if (speed == 0)
+            return Double.POSITIVE_INFINITY;
+        return edge.getDistance() / speed;
     }
 
     @Override
diff --git a/core/src/main/java/com/graphhopper/routing/util/FlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/FlagEncoder.java
index 1194781102..6057d0bc20 100644
--- a/core/src/main/java/com/graphhopper/routing/util/FlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/FlagEncoder.java
@@ -26,14 +26,14 @@
 public interface FlagEncoder
 {
     /**
-     * @return the speed in km/h
+     * @return the maximum speed in km/h
      */
-    double getSpeed( long flags );
+    double getMaxSpeed();
 
     /**
-     * @return the maximum speed in km/h
+     * @return the speed in km/h for this direction, for backward direction use getReverseSpeed
      */
-    double getMaxSpeed();
+    double getSpeed( long flags );
 
     /**
      * Sets the speed in km/h.
@@ -42,6 +42,16 @@
      */
     long setSpeed( long flags, double speed );
 
+    /**
+     * @return the speed of the reverse direction in km/h
+     */
+    double getReverseSpeed( long flags );
+
+    /**
+     * Sets the reverse speed in the flags.
+     */
+    long setReverseSpeed( long flags, double speed );
+
     /**
      * Sets the access of the edge.
      * <p>
@@ -58,20 +68,17 @@
 
     boolean isForward( long flags );
 
-    boolean isBackward( long flags );
+    boolean isBackward( long flags );    
 
     /**
-     * Returns true if flags1 can be overwritten by flags2 without restricting or changing the
-     * directions of flags1.
+     * @return the number to identify a pavement of a road.
+     * @see InstructionList#getWayName
      */
-    //        \  flags2:
-    // flags1  \ -> | <- | <->
-    // ->         t | f  | t
-    // <-         f | t  | t
-    // <->        f | f  | t
-    boolean canBeOverwritten( long flags1, long flags2 );
+    int getPavementType( long flags );
 
-    int getPavementCode( long flags );
-
-    int getWayTypeCode( long flags );
+    /**
+     * @return the number to identify a pushing section, cycle way etc.
+     * @see InstructionList#getWayName
+     */
+    int getWayType( long flags );
 }
diff --git a/core/src/main/java/com/graphhopper/routing/util/FootFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/FootFlagEncoder.java
index 29b71c7769..f14cff77a5 100644
--- a/core/src/main/java/com/graphhopper/routing/util/FootFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/FootFlagEncoder.java
@@ -246,7 +246,7 @@ public long handleWayTags( OSMWay way, long allowed, long relationCode )
 
         } else
         {
-            encoded = handleFerry(way, SLOW, MEAN, FERRY);
+            encoded = handleFerryTags(way, SLOW, MEAN, FERRY);
             encoded |= directionBitMask;
         }
 
@@ -254,13 +254,13 @@ public long handleWayTags( OSMWay way, long allowed, long relationCode )
     }
 
     @Override
-    public int getPavementCode( long flags )
+    public int getPavementType( long flags )
     {
         return 0;
     }
 
     @Override
-    public int getWayTypeCode( long flags )
+    public int getWayType( long flags )
     {
         return 0;
     }
diff --git a/core/src/main/java/com/graphhopper/routing/util/MountainBikeFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/MountainBikeFlagEncoder.java
index 6672239140..ea8abfb323 100644
--- a/core/src/main/java/com/graphhopper/routing/util/MountainBikeFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/MountainBikeFlagEncoder.java
@@ -34,11 +34,11 @@
         setTrackTypeSpeed("grade4", 20);
         setTrackTypeSpeed("grade5", 20); // like sand/grass     
 
-        setSurfaceSpeed("paved", 12);        
+        setSurfaceSpeed("paved", 12);
         setSurfaceSpeed("asphalt", 12);
         setSurfaceSpeed("cobblestone", 10);
         setSurfaceSpeed("cobblestone:flattened", 10);
-        setSurfaceSpeed("sett",10);
+        setSurfaceSpeed("sett", 10);
         setSurfaceSpeed("concrete", 12);
         setSurfaceSpeed("concrete:lanes", 14);
         setSurfaceSpeed("concrete:plates", 14);
diff --git a/core/src/main/java/com/graphhopper/routing/util/RacingBikeFlagEncoder.java b/core/src/main/java/com/graphhopper/routing/util/RacingBikeFlagEncoder.java
index e2acf3d7c8..7abd5b9206 100644
--- a/core/src/main/java/com/graphhopper/routing/util/RacingBikeFlagEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/RacingBikeFlagEncoder.java
@@ -32,18 +32,18 @@
         setTrackTypeSpeed("grade4", PUSHING_SECTION_SPEED / 2);
         setTrackTypeSpeed("grade5", PUSHING_SECTION_SPEED / 2); // like sand/grass     
 
-        setSurfaceSpeed("paved", 20);        
+        setSurfaceSpeed("paved", 20);
         setSurfaceSpeed("asphalt", 20);
         setSurfaceSpeed("cobblestone", 10);
         setSurfaceSpeed("cobblestone:flattened", 10);
-        setSurfaceSpeed("sett",10);
+        setSurfaceSpeed("sett", 10);
         setSurfaceSpeed("concrete", 20);
         setSurfaceSpeed("concrete:lanes", 16);
         setSurfaceSpeed("concrete:plates", 16);
         setSurfaceSpeed("paving_stones", 10);
         setSurfaceSpeed("paving_stones:30", 10);
         setSurfaceSpeed("unpaved", PUSHING_SECTION_SPEED / 2);
-        setSurfaceSpeed("compacted",PUSHING_SECTION_SPEED / 2);
+        setSurfaceSpeed("compacted", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("dirt", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("earth", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("fine_gravel", PUSHING_SECTION_SPEED);
@@ -54,11 +54,11 @@
         setSurfaceSpeed("ice", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("metal", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("mud", PUSHING_SECTION_SPEED / 2);
-        setSurfaceSpeed("pebblestone", PUSHING_SECTION_SPEED );
+        setSurfaceSpeed("pebblestone", PUSHING_SECTION_SPEED);
         setSurfaceSpeed("salt", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("sand", PUSHING_SECTION_SPEED / 2);
         setSurfaceSpeed("wood", PUSHING_SECTION_SPEED / 2);
-        
+
         setHighwaySpeed("living_street", 15);
         setHighwaySpeed("steps", PUSHING_SECTION_SPEED / 2);
 
diff --git a/core/src/main/java/com/graphhopper/routing/util/RoutingAlgorithmSpecialAreaTests.java b/core/src/main/java/com/graphhopper/routing/util/RoutingAlgorithmSpecialAreaTests.java
index 4329949038..1ebe625b29 100644
--- a/core/src/main/java/com/graphhopper/routing/util/RoutingAlgorithmSpecialAreaTests.java
+++ b/core/src/main/java/com/graphhopper/routing/util/RoutingAlgorithmSpecialAreaTests.java
@@ -26,6 +26,7 @@
 import com.graphhopper.storage.LevelGraph;
 import com.graphhopper.util.StopWatch;
 import static com.graphhopper.routing.util.NoOpAlgorithmPreparation.*;
+import com.graphhopper.routing.util.TestAlgoCollector.OneRun;
 import com.graphhopper.storage.*;
 import com.graphhopper.storage.index.LocationIndexTreeSC;
 import java.util.ArrayList;
@@ -84,20 +85,20 @@ void testAlgos()
             LocationIndex currIdx = entry.getValue();
             int failed = testCollector.errors.size();
 
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(50.0314, 10.5105, ef), currIdx.findClosest(50.0303, 10.5070, ef), 570, 22);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(49.51451, 9.967346, ef), currIdx.findClosest(50.2920, 10.4650, ef), 107545, 1712);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(50.0780, 9.1570, ef), currIdx.findClosest(49.5860, 9.9750, ef), 91715, 1299);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(50.2800, 9.7190, ef), currIdx.findClosest(49.8960, 10.3890, ef), 76411, 1406);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(49.8020, 9.2470, ef), currIdx.findClosest(50.4940, 10.1970, ef), 125633, 2253);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(49.72449, 9.23482, ef), currIdx.findClosest(50.4140, 10.2750, ef), 137260.8, 2401);
-            testCollector.assertDistance(prepare.createAlgo(),
-                    currIdx.findClosest(50.1100, 10.7530, ef), currIdx.findClosest(49.6500, 10.3410, ef), 73530, 1462);
+            OneRun or = new OneRun(50.0314, 10.5105, 50.0303, 10.5070, 570, 22);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(49.51451, 9.967346, 50.2920, 10.4650, 107545, 1712);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(50.0780, 9.1570, 49.5860, 9.9750, 91715, 1299);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(50.2800, 9.7190, 49.8960, 10.3890, 76411, 1406);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(49.8020, 9.2470, 50.4940, 10.1970, 125633, 2253);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(49.72449, 9.23482, 50.4140, 10.2750, 137260.8, 2401);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
+            or = new OneRun(50.1100, 10.7530, 49.6500, 10.3410, 73530, 1462);
+            testCollector.assertDistance(prepare, or.getList(idx, ef), or);
 
             System.out.println("unterfranken " + prepare.createAlgo() + ": " + (testCollector.errors.size() - failed) + " failed");
         }
@@ -127,7 +128,8 @@ public ME( AlgorithmPreparation ap, LocationIndex idx )
 
         if (withCh)
         {
-            LevelGraph graphCH = (LevelGraph) ((GraphStorage) g).copyTo(new GraphBuilder(manager).levelGraphCreate());
+            LevelGraph graphCH = (LevelGraph) ((GraphStorage) g).copyTo(new GraphBuilder(manager).
+                    set3D(g.getNodeAccess().is3D()).levelGraphCreate());
             PrepareContractionHierarchies prepareCH = new PrepareContractionHierarchies(encoder, weighting).
                     setGraph(graphCH);
             prepareCH.doWork();
diff --git a/core/src/main/java/com/graphhopper/routing/util/TestAlgoCollector.java b/core/src/main/java/com/graphhopper/routing/util/TestAlgoCollector.java
index cf29bc9a1c..bfb062ff92 100644
--- a/core/src/main/java/com/graphhopper/routing/util/TestAlgoCollector.java
+++ b/core/src/main/java/com/graphhopper/routing/util/TestAlgoCollector.java
@@ -17,6 +17,7 @@
  */
 package com.graphhopper.routing.util;
 
+import com.graphhopper.GHResponse;
 import com.graphhopper.routing.Path;
 import com.graphhopper.routing.RoutingAlgorithm;
 import com.graphhopper.storage.Graph;
@@ -24,6 +25,7 @@
 import com.graphhopper.storage.index.QueryResult;
 import com.graphhopper.util.DistanceCalc;
 import com.graphhopper.util.DistanceCalcEarth;
+import com.graphhopper.util.PathMerger;
 import com.graphhopper.util.PointList;
 import com.graphhopper.util.shapes.GHPoint;
 import java.util.ArrayList;
@@ -43,39 +45,50 @@ public TestAlgoCollector( String name )
         this.name = name;
     }
 
-    public TestAlgoCollector assertDistance( RoutingAlgorithm algo,
-            QueryResult from, QueryResult to, double distance, int pointCount )
+    public TestAlgoCollector assertDistance( AlgorithmPreparation prepare, List<QueryResult> queryList, OneRun oneRun )
     {
-        Path path = algo.calcPath(from, to);
-        if (!path.isFound())
+        List<Path> viaPaths = new ArrayList<Path>();
+        for (int i = 0; i < queryList.size() - 1; i++)
         {
-            errors.add(algo + " returns no path! expected distance: " + distance
-                    + ", expected locations: " + pointCount + ". from:" + from + ", to:" + to);
+            Path path = prepare.createAlgo().calcPath(queryList.get(i), queryList.get(i + 1));
+            viaPaths.add(path);path.calcPoints().size();
+        }
+        PathMerger pathMerger = new PathMerger().
+                setCalcPoints(true).
+                setSimplifyRequest(false).
+                setEnableInstructions(true);
+        GHResponse rsp = new GHResponse();
+        pathMerger.doWork(rsp, viaPaths);
+
+        if (!rsp.isFound())
+        {
+            errors.add(prepare + " returns no path! expected distance: " + rsp.getDistance()
+                    + ", expected points: " + oneRun + ". " + queryList);
             return this;
         }
 
-        PointList pointList = path.calcPoints();
+        PointList pointList = rsp.getPoints();
         double tmpDist = pointList.calcDistance(distCalc);
-        if (Math.abs(path.getDistance() - tmpDist) > 5)
+        if (Math.abs(rsp.getDistance() - tmpDist) > 5)
         {
-            errors.add(algo + " path.getDistance was  " + path.getDistance()
-                    + "\t pointList.calcDistance was " + tmpDist + "\t (expected points " + pointCount
-                    + ", expected distance " + distance + ") from:" + from + ", to:" + to);
+            errors.add(prepare + " path.getDistance was  " + rsp.getDistance()
+                    + "\t pointList.calcDistance was " + tmpDist + "\t (expected points " + oneRun.getLocs()
+                    + ", expected distance " + oneRun.getDistance() + ") " + queryList);
         }
 
-        if (Math.abs(path.getDistance() - distance) > 4)
+        if (Math.abs(rsp.getDistance() - oneRun.getDistance()) > 4)
         {
-            errors.add(algo + " returns path not matching the expected distance of " + distance
-                    + "\t Returned was " + path.getDistance() + "\t (expected points " + pointCount
-                    + ", was " + pointList.getSize() + ") from:" + from + ", to:" + to);
+            errors.add(prepare + " returns path not matching the expected distance of " + oneRun.getDistance()
+                    + "\t Returned was " + rsp.getDistance() + "\t (expected points " + oneRun.getLocs()
+                    + ", was " + pointList.getSize() + ") " + queryList);
         }
 
         // There are real world instances where A-B-C is identical to A-C (in meter precision).
-        if (Math.abs(pointList.getSize() - pointCount) > 4)
+        if (Math.abs(pointList.getSize() - oneRun.getLocs()) > 4)
         {
-            errors.add(algo + " returns path not matching the expected points of " + pointCount
-                    + "\t Returned was " + pointList.getSize() + "\t (expected distance " + distance
-                    + ", was " + path.getDistance() + ") from:" + from + ", to:" + to);
+            errors.add(prepare + " returns path not matching the expected points of " + oneRun.getLocs()
+                    + "\t Returned was " + pointList.getSize() + "\t (expected distance " + oneRun.getDistance()
+                    + ", was " + rsp.getDistance() + ") " + queryList);
         }
         return this;
     }
@@ -122,4 +135,92 @@ void printSummary()
             System.out.println("SUCCESS for " + name + "!");
         }
     }
+
+    public static class OneRun
+    {
+        private final List<AssumptionPerPath> assumptions = new ArrayList<AssumptionPerPath>();
+
+        public OneRun()
+        {
+        }
+
+        public OneRun( double fromLat, double fromLon, double toLat, double toLon, double dist, int locs )
+        {
+            add(fromLat, fromLon, 0, 0);
+            add(toLat, toLon, dist, locs);
+        }
+
+        public OneRun add( double lat, double lon, double dist, int locs )
+        {
+            assumptions.add(new AssumptionPerPath(lat, lon, dist, locs));
+            return this;
+        }
+
+        public int getLocs()
+        {
+            int sum = 0;
+            for (AssumptionPerPath as : assumptions)
+            {
+                sum += as.locs;
+            }
+            return sum;
+        }
+
+        public void setLocs( int index, int locs )
+        {
+            assumptions.get(index).locs = locs;
+        }
+
+        public double getDistance()
+        {
+            double sum = 0;
+            for (AssumptionPerPath as : assumptions)
+            {
+                sum += as.distance;
+            }
+            return sum;
+        }
+
+        public void setDistance( int index, double dist )
+        {
+            assumptions.get(index).distance = dist;
+        }
+
+        public List<QueryResult> getList( LocationIndex idx, EdgeFilter edgeFilter )
+        {
+            List<QueryResult> qr = new ArrayList<QueryResult>();
+            for (AssumptionPerPath or : assumptions)
+            {
+                qr.add(idx.findClosest(or.lat, or.lon, edgeFilter));
+            }
+            return qr;
+        }
+
+        @Override
+        public String toString()
+        {
+            return assumptions.toString();
+        }
+    }
+
+    static class AssumptionPerPath
+    {
+        double lat, lon;
+        int locs;
+        double distance;
+
+        public AssumptionPerPath( double lat, double lon, double distance, int locs )
+        {
+            this.lat = lat;
+            this.lon = lon;
+            this.locs = locs;
+            this.distance = distance;
+        }
+
+        @Override
+        public String toString()
+        {
+            return lat + ", " + lon + ", locs:" + locs + ", dist:" + distance;
+        }
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/routing/util/TurnCostEncoder.java b/core/src/main/java/com/graphhopper/routing/util/TurnCostEncoder.java
index 8edb992b7a..aaff285288 100644
--- a/core/src/main/java/com/graphhopper/routing/util/TurnCostEncoder.java
+++ b/core/src/main/java/com/graphhopper/routing/util/TurnCostEncoder.java
@@ -17,7 +17,6 @@
  */
 package com.graphhopper.routing.util;
 
-
 /**
  * Encodes and decodes a turn restriction and turn costs within a integer flag
  * <p>
@@ -26,20 +25,20 @@
 public interface TurnCostEncoder
 {
     /**
-     * @return true, if, and only if it is encoded in flag 
+     * @return true, if, and only if it is encoded in flag
      */
     boolean isTurnRestricted( long flag );
 
     /**
-     * @return the costs in seconds encoded in flag 
+     * @return the costs in seconds encoded in flag
      */
     int getTurnCosts( long flag );
-    
+
     long getTurnFlags( boolean restriction, int costs );
 
     /**
-     * whether turn costs nor turn restrictions will be encoded by this
-     * encoder, should be used for pedestrians  
+     * whether turn costs nor turn restrictions will be encoded by this encoder, should be used for
+     * pedestrians
      */
     static class NoTurnCostsEncoder implements TurnCostEncoder
     {
@@ -64,7 +63,4 @@ public long getTurnFlags( boolean restriction, int costs )
 
     }
 
-    
-
-
 }
diff --git a/core/src/main/java/com/graphhopper/routing/util/Weighting.java b/core/src/main/java/com/graphhopper/routing/util/Weighting.java
index 7f2bc7c658..939b9f0b97 100644
--- a/core/src/main/java/com/graphhopper/routing/util/Weighting.java
+++ b/core/src/main/java/com/graphhopper/routing/util/Weighting.java
@@ -38,7 +38,7 @@
      * @param reverse if the specified edge is specified in reverse direction e.g. from the reverse
      * case of a bidirectional search.
      * @return the calculated weight with the specified velocity has to be in the range of 0 and
-     * +Infinity
+     * +Infinity. Make sure your method does not return NaN which can e.g. occur for 0/0.
      */
     double calcWeight( EdgeIteratorState edge, boolean reverse );
 }
diff --git a/core/src/main/java/com/graphhopper/storage/DAType.java b/core/src/main/java/com/graphhopper/storage/DAType.java
index e42340bce9..86ff0840d1 100644
--- a/core/src/main/java/com/graphhopper/storage/DAType.java
+++ b/core/src/main/java/com/graphhopper/storage/DAType.java
@@ -91,6 +91,9 @@ MemRef getMemRef()
         return memRef;
     }
 
+    /**
+     * @return true if data resides in the JVM heap.
+     */
     public boolean isInMemory()
     {
         return memRef == MemRef.HEAP;
@@ -147,6 +150,27 @@ else if (getMemRef() == MemRef.HEAP)
         return str;
     }
 
+    public static DAType fromString( String dataAccess )
+    {
+        dataAccess = dataAccess.toUpperCase();
+        DAType type;
+        if (dataAccess.contains("MMAP"))
+            type = DAType.MMAP;
+        else if (dataAccess.contains("UNSAFE"))
+            type = DAType.UNSAFE_STORE;
+        else
+        {
+            if (dataAccess.contains("RAM_STORE"))
+                type = DAType.RAM_STORE;
+            else
+                type = DAType.RAM;
+        }
+
+        if (dataAccess.contains("SYNC"))
+            type = new DAType(type, true);
+        return type;
+    }
+
     @Override
     public int hashCode()
     {
diff --git a/core/src/main/java/com/graphhopper/storage/DataAccess.java b/core/src/main/java/com/graphhopper/storage/DataAccess.java
index a24516e5c6..d400014f72 100644
--- a/core/src/main/java/com/graphhopper/storage/DataAccess.java
+++ b/core/src/main/java/com/graphhopper/storage/DataAccess.java
@@ -43,15 +43,25 @@
     void rename( String newName );
 
     /**
-     * Set 4 bytes at position 'index' to the specified value
+     * Set 4 bytes at position 'bytePos' to the specified value
      */
     void setInt( long bytePos, int value );
 
     /**
-     * Get 4 bytes from position 'index'
+     * Get 4 bytes from position 'bytePos'
      */
     int getInt( long bytePos );
 
+    /**
+     * Set 2 bytes at position 'index' to the specified value
+     */
+    void setShort( long bytePos, short value );
+
+    /**
+     * Get 2 bytes from position 'index'
+     */
+    short getShort( long bytePos );
+
     /**
      * Set bytes from position 'index' to the specified values
      */
diff --git a/core/src/main/java/com/graphhopper/storage/Directory.java b/core/src/main/java/com/graphhopper/storage/Directory.java
index 0443030a00..53cf760bd7 100644
--- a/core/src/main/java/com/graphhopper/storage/Directory.java
+++ b/core/src/main/java/com/graphhopper/storage/Directory.java
@@ -28,7 +28,6 @@
  */
 public interface Directory
 {
-
     /**
      * @return an id or location in the local filesystem.
      */
@@ -50,8 +49,7 @@
     /**
      * Renames the specified DataAccess object into one.
      */
-    DataAccess rename( DataAccess da, String newName );
-
+    // DataAccess rename( DataAccess da, String newName );
     /**
      * Removes the specified object from the directory.
      */
@@ -61,4 +59,9 @@
      * @return the default type of a newly created DataAccess object
      */
     DAType getDefaultType();
+
+    /**
+     * Removes all contained objects from the directory and releases its resources.
+     */
+    void clear();
 }
diff --git a/core/src/main/java/com/graphhopper/storage/Edge.java b/core/src/main/java/com/graphhopper/storage/Edge.java
index a3abb12c69..e4da0fef75 100644
--- a/core/src/main/java/com/graphhopper/storage/Edge.java
+++ b/core/src/main/java/com/graphhopper/storage/Edge.java
@@ -28,14 +28,14 @@
 public class Edge implements Comparable<Edge>
 {
     public int edge;
-    public int endNode;
+    public int adjNode;
     public double weight;
 
-    public Edge( int edgeId, int endNode, double distance )
+    public Edge( int edgeId, int adjNode, double weight )
     {
         this.edge = edgeId;
-        this.endNode = endNode;
-        this.weight = distance;
+        this.adjNode = adjNode;
+        this.weight = weight;
     }
 
     @Override
@@ -47,6 +47,6 @@ public int compareTo( Edge o )
     @Override
     public String toString()
     {
-        return endNode + " (" + edge + ") distance is " + weight;
+        return adjNode + " (" + edge + ") weight: " + weight;
     }
 }
diff --git a/core/src/main/java/com/graphhopper/storage/EdgeEntry.java b/core/src/main/java/com/graphhopper/storage/EdgeEntry.java
index 8353c6f425..e835cac4c7 100644
--- a/core/src/main/java/com/graphhopper/storage/EdgeEntry.java
+++ b/core/src/main/java/com/graphhopper/storage/EdgeEntry.java
@@ -26,15 +26,15 @@
 {
     public EdgeEntry parent;
 
-    public EdgeEntry( int edgeId, int endNode, double distance )
+    public EdgeEntry( int edgeId, int adjNode, double weight )
     {
-        super(edgeId, endNode, distance);
+        super(edgeId, adjNode, weight);
     }
 
     @Override
     public EdgeEntry clone()
     {
-        return new EdgeEntry(edge, endNode, weight);
+        return new EdgeEntry(edge, adjNode, weight);
     }
 
     public EdgeEntry cloneFull()
diff --git a/core/src/main/java/com/graphhopper/storage/GHDirectory.java b/core/src/main/java/com/graphhopper/storage/GHDirectory.java
index 525673680f..b3cc92601b 100644
--- a/core/src/main/java/com/graphhopper/storage/GHDirectory.java
+++ b/core/src/main/java/com/graphhopper/storage/GHDirectory.java
@@ -52,7 +52,7 @@ public GHDirectory( String _location, DAType defaultType )
             throw new RuntimeException("file '" + dir + "' exists but is not a directory");
 
         // set default access to integer based
-        // improves performance on server side, 10% faster for queries, 20% faster for preparation
+        // improves performance on server side, 10% faster for queries and preparation
         if (this.defaultType.isInMemory())
         {
             if (isStoring())
@@ -135,29 +135,48 @@ public DataAccess find( String name, DAType type )
     }
 
     @Override
-    public DataAccess rename( DataAccess da, String newName )
+    public void clear()
     {
-        String oldName = da.getName();
-        da.rename(newName);
-        removeByName(oldName);
-        map.put(newName, da);
-        return da;
+        // If there is at least one MMap DA then do not apply the cleanHack 
+        // for every single mmap DA as this is very slow if lots of DataAccess objects were collected 
+        // => forceClean == false
+
+        MMapDataAccess mmapDA = null;
+        for (DataAccess da : map.values())
+        {
+            if (da instanceof MMapDataAccess)
+                mmapDA = (MMapDataAccess) da;
+
+            removeDA(da, da.getName(), false);
+        }
+        if (mmapDA != null)
+            mmapDA.cleanHack();
+        map.clear();
     }
 
     @Override
     public void remove( DataAccess da )
     {
-        removeByName(da.getName());
+        removeFromMap(da.getName());
+        removeDA(da, da.getName(), true);
     }
 
-    void removeByName( String name )
+    void removeDA( DataAccess da, String name, boolean forceClean )
+    {
+        if (da instanceof MMapDataAccess)
+            ((MMapDataAccess) da).close(forceClean);
+        else
+            da.close();
+
+        if (da.getType().isStoring())
+            Helper.removeDir(new File(location + name));
+    }
+
+    void removeFromMap( String name )
     {
         DataAccess da = map.remove(name);
         if (da == null)
             throw new IllegalStateException("Couldn't remove dataAccess object:" + name);
-        da.close();
-        if (da.getType().isStoring())
-            Helper.removeDir(new File(location + name));
     }
 
     @Override
@@ -174,9 +193,7 @@ public boolean isStoring()
     protected void mkdirs()
     {
         if (isStoring())
-        {
             new File(location).mkdirs();
-        }
     }
 
     Collection<DataAccess> getAll()
diff --git a/core/src/main/java/com/graphhopper/storage/GHNodeAccess.java b/core/src/main/java/com/graphhopper/storage/GHNodeAccess.java
new file mode 100644
index 0000000000..63760d7f37
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/storage/GHNodeAccess.java
@@ -0,0 +1,156 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.storage;
+
+import com.graphhopper.util.Helper;
+
+/**
+ * A helper class for GraphHopperStorage for its node access.
+ * <p>
+ * @author Peter Karich
+ */
+class GHNodeAccess implements NodeAccess
+{
+    private final GraphHopperStorage that;
+    private final boolean enabled3D;
+
+    public GHNodeAccess( GraphHopperStorage that, boolean enabled3D )
+    {
+        this.that = that;
+        this.enabled3D = enabled3D;
+    }
+
+    @Override
+    public final void setNode( int nodeId, double lat, double lon )
+    {
+        setNode(nodeId, lat, lon, Double.NaN);
+    }
+
+    @Override
+    public final void setNode( int index, double lat, double lon, double ele )
+    {
+        that.ensureNodeIndex(index);
+        long tmp = (long) index * that.nodeEntryBytes;
+        that.nodes.setInt(tmp + that.N_LAT, Helper.degreeToInt(lat));
+        that.nodes.setInt(tmp + that.N_LON, Helper.degreeToInt(lon));
+
+        if (is3D())
+        {
+            // meter precision is sufficient for now
+            that.nodes.setInt(tmp + that.N_ELE, Helper.eleToInt(ele));
+            if (ele > that.bounds.maxEle)
+                that.bounds.maxEle = ele;
+
+            if (ele < that.bounds.minEle)
+                that.bounds.minEle = ele;
+        }
+
+        if (lat > that.bounds.maxLat)
+            that.bounds.maxLat = lat;
+
+        if (lat < that.bounds.minLat)
+            that.bounds.minLat = lat;
+
+        if (lon > that.bounds.maxLon)
+            that.bounds.maxLon = lon;
+
+        if (lon < that.bounds.minLon)
+            that.bounds.minLon = lon;
+
+        //set the default value for the additional field of this node
+        if (that.extStorage.isRequireNodeField())
+            that.nodes.setInt(tmp + that.N_ADDITIONAL, that.extStorage.getDefaultNodeFieldValue());
+    }
+
+    @Override
+    public final double getLatitude( int nodeId )
+    {
+        return Helper.intToDegree(that.nodes.getInt((long) nodeId * that.nodeEntryBytes + that.N_LAT));
+    }
+
+    @Override
+    public final double getLongitude( int nodeId )
+    {
+        return Helper.intToDegree(that.nodes.getInt((long) nodeId * that.nodeEntryBytes + that.N_LON));
+    }
+
+    @Override
+    public final double getElevation( int nodeId )
+    {
+        if (!enabled3D)
+            throw new IllegalStateException("Cannot access elevation - 3D is not enabled");
+
+        return Helper.intToEle(that.nodes.getInt((long) nodeId * that.nodeEntryBytes + that.N_ELE));
+    }
+
+    @Override
+    public final double getEle( int nodeId )
+    {
+        return getElevation(nodeId);
+    }
+
+    @Override
+    public final double getLat( int nodeId )
+    {
+        return getLatitude(nodeId);
+    }
+
+    @Override
+    public final double getLon( int nodeId )
+    {
+        return getLongitude(nodeId);
+    }
+
+    @Override
+    public final void setAdditionalNodeField( int index, int additionalValue )
+    {
+        if (that.extStorage.isRequireNodeField() && that.N_ADDITIONAL >= 0)
+        {
+            that.ensureNodeIndex(index);
+            long tmp = (long) index * that.nodeEntryBytes;
+            that.nodes.setInt(tmp + that.N_ADDITIONAL, additionalValue);
+        } else
+        {
+            throw new AssertionError("This graph does not provide an additional node field");
+        }
+    }
+
+    @Override
+    public final int getAdditionalNodeField( int index )
+    {
+        if (that.extStorage.isRequireNodeField() && that.N_ADDITIONAL >= 0)
+            return that.nodes.getInt((long) index * that.nodeEntryBytes + that.N_ADDITIONAL);
+        else
+            throw new AssertionError("This graph does not provide an additional node field");
+    }
+
+    @Override
+    public final boolean is3D()
+    {
+        return enabled3D;
+    }
+
+    @Override
+    public int getDimension()
+    {
+        if (enabled3D)
+            return 3;
+        return 2;
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/storage/Graph.java b/core/src/main/java/com/graphhopper/storage/Graph.java
index fa02f7a505..af0348cafa 100644
--- a/core/src/main/java/com/graphhopper/storage/Graph.java
+++ b/core/src/main/java/com/graphhopper/storage/Graph.java
@@ -37,35 +37,9 @@
     int getNodes();
 
     /**
-     * This method ensures that the node with the specified index exists and sets the lat+lon to the
-     * specified values. The index goes from 0 (inclusive) to nodes() (exclusive)
+     * Creates a node explorer to access node properties.
      */
-    void setNode( int node, double lat, double lon );
-
-    /**
-     * @return the latitude at the specified node index
-     */
-    double getLatitude( int nodeId );
-
-    /**
-     * @return the longitude at the specified node index
-     */
-    double getLongitude( int nodeId );
-
-    /**
-     * @return the additional value at the specified node index
-     * @throws AssertionError if, and only if, the extendedStorage does not require an additional
-     * node field
-     */
-    int getAdditionalNodeField( int nodeId );
-
-    /**
-     * Sets the additional value at the specified node index
-     * <p>
-     * @throws AssertionError if, and only if, the extendedStorage does not require an additional
-     * node field
-     */
-    void setAdditionalNodeField( int nodeId, int additionalValue );
+    NodeAccess getNodeAccess();
 
     /**
      * Returns the implicit bounds of this graph calculated from the lat,lon input of setNode
diff --git a/core/src/main/java/com/graphhopper/storage/GraphBuilder.java b/core/src/main/java/com/graphhopper/storage/GraphBuilder.java
index e525c975a8..c6f3f41950 100644
--- a/core/src/main/java/com/graphhopper/storage/GraphBuilder.java
+++ b/core/src/main/java/com/graphhopper/storage/GraphBuilder.java
@@ -31,6 +31,7 @@
     private boolean mmap;
     private boolean store;
     private boolean level;
+    private boolean is3D;
     private long byteCapacity = 100;
 
     public GraphBuilder( EncodingManager encodingManager )
@@ -73,6 +74,17 @@ public GraphBuilder setExpectedSize( byte cap )
         return this;
     }
 
+    public GraphBuilder set3D( boolean is3D )
+    {
+        this.is3D = is3D;
+        return this;
+    }
+
+    public boolean is3D()
+    {
+        return is3D;
+    }
+
     public LevelGraphStorage levelGraphBuild()
     {
         return (LevelGraphStorage) setLevelGraph(true).build();
@@ -95,20 +107,16 @@ GraphStorage build()
     {
         Directory dir;
         if (mmap)
-        {
             dir = new MMapDirectory(location);
-        } else
-        {
+        else
             dir = new RAMDirectory(location, store);
-        }
+
         GraphStorage graph;
         if (level)
-        {
-            graph = new LevelGraphStorage(dir, encodingManager);
-        } else
-        {
-            graph = new GraphHopperStorage(dir, encodingManager);
-        }
+            graph = new LevelGraphStorage(dir, encodingManager, is3D);
+        else
+            graph = new GraphHopperStorage(dir, encodingManager, is3D);
+
         return graph;
     }
 
diff --git a/core/src/main/java/com/graphhopper/storage/GraphHopperStorage.java b/core/src/main/java/com/graphhopper/storage/GraphHopperStorage.java
index d080616ebd..d17ac4382c 100644
--- a/core/src/main/java/com/graphhopper/storage/GraphHopperStorage.java
+++ b/core/src/main/java/com/graphhopper/storage/GraphHopperStorage.java
@@ -50,7 +50,7 @@
     // Road networks typically do not have nodes with plenty of edges!
     private static final int MAX_EDGES = 1000;
     // distance of around +-1000 000 meter are ok
-    private static final double INT_DIST_FACTOR = 1000f;
+    private static final double INT_DIST_FACTOR = 1000d;
     private final Directory dir;
     // edge memory layout:
     protected int E_NODEA, E_NODEB, E_LINKA, E_LINKB, E_DIST, E_FLAGS, E_GEO, E_NAME, E_ADDITIONAL;
@@ -58,23 +58,23 @@
      * Specifies how many entries (integers) are used per edge.
      */
     protected int edgeEntryBytes;
-    protected DataAccess edges;
+    protected final DataAccess edges;
     /**
      * interval [0,n)
      */
     protected int edgeCount;
     // node memory layout:
-    protected int N_EDGE_REF, N_LAT, N_LON, N_ADDITIONAL;
+    protected int N_EDGE_REF, N_LAT, N_LON, N_ELE, N_ADDITIONAL;
     /**
      * Specifies how many entries (integers) are used per node
      */
     protected int nodeEntryBytes;
-    protected DataAccess nodes;
+    protected final DataAccess nodes;
     /**
      * interval [0,n)
      */
     private int nodeCount;
-    private BBox bounds;
+    final BBox bounds;
     // remove markers are not yet persistent!
     private GHBitSet removedNodes;
     private int edgeEntryIndex, nodeEntryIndex;
@@ -85,23 +85,22 @@
     private boolean initialized = false;
     private EncodingManager encodingManager;
     private final NameIndex nameIndex;
-    protected final EdgeFilter allEdgesFilter;
     private final StorableProperties properties;
     private final BitUtil bitUtil;
     private boolean flagsSizeIsLong;
-    private final ExtendedStorage extStorage;
+    final ExtendedStorage extStorage;
+    private final NodeAccess nodeAccess;
 
-    public GraphHopperStorage( Directory dir, EncodingManager encodingManager )
+    public GraphHopperStorage( Directory dir, EncodingManager encodingManager, boolean enabledEle )
     {
-        this(dir, encodingManager, new ExtendedStorage.NoExtendedStorage());
+        this(dir, encodingManager, enabledEle, new ExtendedStorage.NoExtendedStorage());
     }
 
-    public GraphHopperStorage( Directory dir, EncodingManager encodingManager, ExtendedStorage extendedStorage )
+    public GraphHopperStorage( Directory dir, EncodingManager encodingManager, boolean enabled3D, ExtendedStorage extendedStorage )
     {
         // here encoding manager can be null e.g. if we want to load existing graph
         this.encodingManager = encodingManager;
         this.extStorage = extendedStorage;
-        this.allEdgesFilter = EdgeFilter.ALL_EDGES;
         this.dir = dir;
         this.bitUtil = BitUtil.get(dir.getByteOrder());
         this.nodes = dir.find("nodes");
@@ -110,6 +109,7 @@ public GraphHopperStorage( Directory dir, EncodingManager encodingManager, Exten
         this.nameIndex = new NameIndex(dir);
         this.properties = new StorableProperties(dir);
         this.bounds = BBox.INVERSE.clone();
+        this.nodeAccess = new GHNodeAccess(this, enabled3D);
         extendedStorage.init(this);
     }
 
@@ -119,7 +119,7 @@ void checkInit()
             throw new IllegalStateException("You cannot configure this GraphStorage "
                     + "after calling create or loadExisting. Calling one of the methods twice is also not allowed.");
     }
-    
+
     protected final int nextEdgeEntryIndex( int sizeInBytes )
     {
         int tmp = edgeEntryIndex;
@@ -127,7 +127,7 @@ protected final int nextEdgeEntryIndex( int sizeInBytes )
         return tmp;
     }
 
-    protected final int nextNodeEntryIndex(int sizeInBytes)
+    protected final int nextNodeEntryIndex( int sizeInBytes )
     {
         int tmp = nodeEntryIndex;
         nodeEntryIndex += 4;
@@ -177,13 +177,17 @@ public GraphStorage create( long byteCount )
         nameIndex.create(1000);
         properties.create(100);
         extStorage.create(initSize);
-        
+
         properties.put("osmreader.bytesForFlags", encodingManager.getBytesForFlags());
         properties.put("osmreader.acceptWay", encodingManager.toDetailsString());
+
+        properties.put("graph.byteOrder", dir.getByteOrder());
+        properties.put("graph.dimension", nodeAccess.getDimension());
         properties.putCurrentVersions();
-        initStorage();        
+        initStorage();
         // 0 stands for no separate geoRef
-        maxGeoRef = 4;        
+        maxGeoRef = 4;
+
         initNodeRefs(0, nodes.getCapacity());
         return this;
     }
@@ -195,24 +199,9 @@ public int getNodes()
     }
 
     @Override
-    public double getLatitude( int index )
-    {
-        return Helper.intToDegree(nodes.getInt((long) index * nodeEntryBytes + N_LAT));
-    }
-
-    @Override
-    public double getLongitude( int index )
-    {
-        return Helper.intToDegree(nodes.getInt((long) index * nodeEntryBytes + N_LON));
-    }
-
-    @Override
-    public int getAdditionalNodeField( int index )
+    public NodeAccess getNodeAccess()
     {
-        if (extStorage.isRequireNodeField() && N_ADDITIONAL >= 0)
-            return nodes.getInt((long) index * nodeEntryBytes + N_ADDITIONAL);
-        else
-            throw new AssertionError("This graph does not provide an additional node field");
+        return nodeAccess;
     }
 
     /**
@@ -252,57 +241,10 @@ public BBox getBounds()
         return bounds;
     }
 
-    @Override
-    public void setNode( int index, double lat, double lon )
-    {
-        ensureNodeIndex(index);
-        long tmp = (long) index * nodeEntryBytes;
-        nodes.setInt(tmp + N_LAT, Helper.degreeToInt(lat));
-        nodes.setInt(tmp + N_LON, Helper.degreeToInt(lon));
-        if (lat > bounds.maxLat)
-        {
-            bounds.maxLat = lat;
-        }
-        if (lat < bounds.minLat)
-        {
-            bounds.minLat = lat;
-        }
-        if (lon > bounds.maxLon)
-        {
-            bounds.maxLon = lon;
-        }
-        if (lon < bounds.minLon)
-        {
-            bounds.minLon = lon;
-        }
-
-        //set the default value for the additional field of this node
-        if (extStorage.isRequireNodeField())
-        {
-            nodes.setInt(tmp + N_ADDITIONAL, extStorage.getDefaultNodeFieldValue());
-        }
-    }
-
-    @Override
-    public void setAdditionalNodeField( int index, int additionalValue )
-    {
-        if (extStorage.isRequireNodeField() && N_ADDITIONAL >= 0)
-        {
-            ensureNodeIndex(index);
-            long tmp = (long) index * nodeEntryBytes;
-            nodes.setInt(tmp + N_ADDITIONAL, additionalValue);
-        } else
-        {
-            throw new AssertionError("This graph does not provide an additional node field");
-        }
-    }
-
     final void ensureNodeIndex( int nodeIndex )
     {
         if (!initialized)
-        {
             throw new AssertionError("The graph has not yet been initialized.");
-        }
 
         if (nodeIndex < nodeCount)
             return;
@@ -531,6 +473,8 @@ public StorableProperties getProperties()
         protected long edgePointer = -edgeEntryBytes;
         private final long maxEdges = (long) edgeCount * edgeEntryBytes;
         private int nodeA;
+        private int nodeB;
+        private boolean reverse = false;
 
         public AllEdgeIterator()
         {
@@ -549,6 +493,8 @@ public boolean next()
             {
                 edgePointer += edgeEntryBytes;
                 nodeA = edges.getInt(edgePointer + E_NODEA);
+                nodeB = edges.getInt(edgePointer + E_NODEB);
+                reverse = getBaseNode() > getAdjNode();
                 // some edges are deleted and have a negative node
             } while (nodeA == NO_NODE && edgePointer < maxEdges);
             return edgePointer < maxEdges;
@@ -563,7 +509,7 @@ public int getBaseNode()
         @Override
         public int getAdjNode()
         {
-            return edges.getInt(edgePointer + E_NODEB);
+            return nodeB;
         }
 
         @Override
@@ -582,7 +528,7 @@ public EdgeIteratorState setDistance( double dist )
         @Override
         public long getFlags()
         {
-            return GraphHopperStorage.this.getFlags(edgePointer, false);
+            return GraphHopperStorage.this.getFlags(edgePointer, reverse);
         }
 
         @Override
@@ -605,9 +551,9 @@ public EdgeIteratorState setFlags( long flags )
         }
 
         @Override
-        public void copyProperties( EdgeIteratorState edge )
+        public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
-            throw new UnsupportedOperationException("Not supported yet.");
+            return GraphHopperStorage.this.copyProperties(this, edge);
         }
 
         @Override
@@ -619,14 +565,15 @@ public int getEdge()
         @Override
         public EdgeIteratorState setWayGeometry( PointList pillarNodes )
         {
-            GraphHopperStorage.this.setWayGeometry(pillarNodes, edgePointer, getBaseNode() > getAdjNode());
+            GraphHopperStorage.this.setWayGeometry(pillarNodes, edgePointer, reverse);
             return this;
         }
 
         @Override
         public PointList fetchWayGeometry( int type )
         {
-            return GraphHopperStorage.this.fetchWayGeometry(edgePointer, getBaseNode() > getAdjNode(), type, getBaseNode(), getAdjNode());
+            return GraphHopperStorage.this.fetchWayGeometry(edgePointer, reverse,
+                    type, getBaseNode(), getAdjNode());
         }
 
         @Override
@@ -645,13 +592,20 @@ public EdgeIteratorState setName( String name )
         }
 
         @Override
-        public EdgeIteratorState detach()
+        public EdgeIteratorState detach( boolean reverseArg )
         {
             if (edgePointer < 0)
                 throw new IllegalStateException("call next before detaching");
             AllEdgeIterator iter = new AllEdgeIterator();
-            iter.edgePointer = edgePointer;
             iter.nodeA = nodeA;
+            iter.nodeB = nodeB;
+            iter.edgePointer = edgePointer;
+            if (reverseArg)
+            {
+                iter.reverse = !this.reverse;
+                iter.nodeA = nodeB;
+                iter.nodeB = nodeA;
+            }
             return iter;
         }
 
@@ -681,13 +635,14 @@ public EdgeIteratorState getEdgeProps( int edgeId, int adjNode )
         if (adjNode == nodeB || adjNode == Integer.MIN_VALUE)
         {
             edge = createSingleEdge(edgeId, nodeA);
-            edge.node = nodeB;
+            edge.reverse = false;
+            edge.adjNode = nodeB;
             return edge;
         } else if (adjNode == nodeA)
         {
             edge = createSingleEdge(edgeId, nodeB);
-            edge.node = nodeA;
-            edge.switchFlags = true;
+            edge.adjNode = nodeA;
+            edge.reverse = true;
             return edge;
         }
         // if edgeId exists but adjacent nodes do not match
@@ -699,7 +654,7 @@ protected SingleEdge createSingleEdge( int edgeId, int nodeId )
         return new SingleEdge(edgeId, nodeId);
     }
 
-    private long getFlags( long edgePointer, boolean swap )
+    private long getFlags( long edgePointer, boolean reverse )
     {
         int low = edges.getInt(edgePointer + E_FLAGS);
         long res = low;
@@ -708,15 +663,21 @@ private long getFlags( long edgePointer, boolean swap )
             int high = edges.getInt(edgePointer + E_FLAGS + 4);
             res = ((long) high << 32) | (low & 0xFFFFFFFFL);
         }
-        if (swap)
-            return encodingManager.swapDirection(res);
+        if (reverse)
+            return reverseFlags(edgePointer, res);
         return res;
     }
 
-    private void setFlags( long edgePointer, int nodeA, int nodeB, long flags )
+    long reverseFlags( long edgePointer, long flags )
+    {
+        return encodingManager.reverseFlags(flags);
+    }
+
+    private void setFlags( long edgePointer, boolean reverse, long flags )
     {
-        if (nodeA > nodeB)
-            flags = encodingManager.swapDirection(flags);
+        if (reverse)
+            flags = reverseFlags(edgePointer, flags);
+
         if (flagsSizeIsLong)
         {
             edges.setInt(edgePointer + E_FLAGS, (int) (flags & 0xFFFFFFFFL));
@@ -727,8 +688,6 @@ private void setFlags( long edgePointer, int nodeA, int nodeB, long flags )
 
     protected class SingleEdge extends EdgeIterable
     {
-        protected boolean switchFlags;
-
         public SingleEdge( int edgeId, int nodeId )
         {
             super(EdgeFilter.ALL_EDGES);
@@ -736,12 +695,6 @@ public SingleEdge( int edgeId, int nodeId )
             setEdgeId(edgeId);
             nextEdge = EdgeIterable.NO_EDGE;
         }
-
-        @Override
-        public long getFlags()
-        {
-            return GraphHopperStorage.this.getFlags(edgePointer, switchFlags);
-        }
     }
 
     @Override
@@ -753,20 +706,19 @@ public EdgeExplorer createEdgeExplorer( EdgeFilter filter )
     @Override
     public EdgeExplorer createEdgeExplorer()
     {
-        return createEdgeExplorer(allEdgesFilter);
+        return createEdgeExplorer(EdgeFilter.ALL_EDGES);
     }
 
     protected class EdgeIterable implements EdgeExplorer, EdgeIterator
     {
         final EdgeFilter filter;
         int baseNode;
-        // edge properties
-        int node;
+        int adjNode;
         int edgeId;
         long edgePointer;
         int nextEdge;
+        boolean reverse;
 
-        // used for SingleEdge and as return value of edge()        
         public EdgeIterable( EdgeFilter filter )
         {
             if (filter == null)
@@ -799,7 +751,7 @@ public final int getBaseNode()
         @Override
         public final int getAdjNode()
         {
-            return node;
+            return adjNode;
         }
 
         @Override
@@ -814,12 +766,13 @@ public final boolean next()
 
                 edgePointer = (long) nextEdge * edgeEntryBytes;
                 edgeId = nextEdge;
-                node = getOtherNode(baseNode, edgePointer);
+                adjNode = getOtherNode(baseNode, edgePointer);
+                reverse = baseNode > adjNode;
 
                 // position to next edge
-                nextEdge = edges.getInt(getLinkPosInEdgeArea(baseNode, node, edgePointer));
+                nextEdge = edges.getInt(getLinkPosInEdgeArea(baseNode, adjNode, edgePointer));
                 if (nextEdge == edgeId)
-                    throw new AssertionError("endless loop detected for " + baseNode + ", " + node
+                    throw new AssertionError("endless loop detected for " + baseNode + ", " + adjNode
                             + ", " + edgePointer + ", " + edgeId);
 
                 foundNext = filter == null || filter.accept(this);
@@ -862,16 +815,13 @@ public final EdgeIteratorState setDistance( double dist )
         @Override
         public long getFlags()
         {
-            return GraphHopperStorage.this.getFlags(edgePointer, baseNode > node);
+            return GraphHopperStorage.this.getFlags(edgePointer, reverse);
         }
 
         @Override
         public final EdgeIteratorState setFlags( long fl )
         {
-            int nep = edges.getInt(getLinkPosInEdgeArea(baseNode, node, edgePointer));
-            int neop = edges.getInt(getLinkPosInEdgeArea(node, baseNode, edgePointer));
-            writeEdge(getEdge(), baseNode, node, nep, neop);
-            GraphHopperStorage.this.setFlags(edgePointer, baseNode, node, fl);
+            GraphHopperStorage.this.setFlags(edgePointer, reverse, fl);
             return this;
         }
 
@@ -891,14 +841,14 @@ public EdgeIteratorState setAdditionalField( int value )
         @Override
         public final EdgeIteratorState setWayGeometry( PointList pillarNodes )
         {
-            GraphHopperStorage.this.setWayGeometry(pillarNodes, edgePointer, baseNode > node);
+            GraphHopperStorage.this.setWayGeometry(pillarNodes, edgePointer, reverse);
             return this;
         }
 
         @Override
         public final PointList fetchWayGeometry( int mode )
         {
-            return GraphHopperStorage.this.fetchWayGeometry(edgePointer, baseNode > node, mode, getBaseNode(), getAdjNode());
+            return GraphHopperStorage.this.fetchWayGeometry(edgePointer, reverse, mode, getBaseNode(), getAdjNode());
         }
 
         @Override
@@ -923,15 +873,21 @@ public EdgeIteratorState setName( String name )
         }
 
         @Override
-        public EdgeIteratorState detach()
+        public EdgeIteratorState detach( boolean reverseArg )
         {
             if (edgeId == nextEdge)
                 throw new IllegalStateException("call next before detaching");
 
-            EdgeIterable iter = new EdgeIterable(filter);
+            EdgeIterable iter = iter = new EdgeIterable(filter);
             iter.setBaseNode(baseNode);
             iter.setEdgeId(edgeId);
             iter.next();
+            if (reverseArg)
+            {
+                iter.reverse = !this.reverse;
+                iter.adjNode = baseNode;
+                iter.baseNode = adjNode;
+            }
             return iter;
         }
 
@@ -942,44 +898,69 @@ public final String toString()
         }
 
         @Override
-        public void copyProperties( EdgeIteratorState edge )
+        public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
-            setDistance(edge.getDistance()).setFlags(edge.getFlags()).setWayGeometry(edge.fetchWayGeometry(0));
+            return GraphHopperStorage.this.copyProperties(this, edge);
         }
     }
 
+    /**
+     * @return to
+     */
+    EdgeIteratorState copyProperties( EdgeIteratorState from, EdgeIteratorState to )
+    {
+        to.setDistance(from.getDistance()).
+                setName(from.getName()).
+                setFlags(from.getFlags()).
+                setWayGeometry(from.fetchWayGeometry(0));
+
+        if (E_ADDITIONAL >= 0)
+            to.setAdditionalField(from.getAdditionalField());
+        return to;
+    }
+
     public void setAdditionalEdgeField( long edgePointer, int value )
     {
         if (extStorage.isRequireEdgeField() && E_ADDITIONAL >= 0)
-        {
-            nodes.setInt(edgePointer + E_ADDITIONAL, value);
-        } else
-        {
+            edges.setInt(edgePointer + E_ADDITIONAL, value);
+        else
             throw new AssertionError("This graph does not support an additional edge field.");
-        }
     }
 
     private void setWayGeometry( PointList pillarNodes, long edgePointer, boolean reverse )
     {
         if (pillarNodes != null && !pillarNodes.isEmpty())
         {
+            if (pillarNodes.getDimension() != nodeAccess.getDimension())
+                throw new IllegalArgumentException("Cannot use pointlist which is " + pillarNodes.getDimension()
+                        + "D for graph which is " + nodeAccess.getDimension() + "D");
+
             int len = pillarNodes.getSize();
-            int tmpRef = nextGeoRef(len * 2);
+            int dim = nodeAccess.getDimension();
+            int tmpRef = nextGeoRef(len * dim);
             edges.setInt(edgePointer + E_GEO, tmpRef);
             long geoRef = (long) tmpRef * 4;
-            ensureGeometry(geoRef, len * 8 + 4);
-            byte[] bytes = new byte[len * 2 * 4 + 4];
+            byte[] bytes = new byte[len * dim * 4 + 4];
+            ensureGeometry(geoRef, bytes.length);
             bitUtil.fromInt(bytes, len, 0);
             if (reverse)
                 pillarNodes.reverse();
 
             int tmpOffset = 4;
+            boolean is3D = nodeAccess.is3D();
             for (int i = 0; i < len; i++)
             {
-                bitUtil.fromInt(bytes, Helper.degreeToInt(pillarNodes.getLatitude(i)), tmpOffset);
+                double lat = pillarNodes.getLatitude(i);
+                bitUtil.fromInt(bytes, Helper.degreeToInt(lat), tmpOffset);
                 tmpOffset += 4;
                 bitUtil.fromInt(bytes, Helper.degreeToInt(pillarNodes.getLongitude(i)), tmpOffset);
                 tmpOffset += 4;
+
+                if (is3D)
+                {
+                    bitUtil.fromInt(bytes, Helper.eleToInt(pillarNodes.getElevation(i)), tmpOffset);
+                    tmpOffset += 4;
+                }
             }
 
             wayGeometry.setBytes(geoRef, bytes, bytes.length);
@@ -1001,20 +982,20 @@ private PointList fetchWayGeometry( long edgePointer, boolean reverse, int mode,
             wayGeometry.getInt(geoRef);
 
             geoRef += 4;
-            bytes = new byte[count * 2 * 4];
+            bytes = new byte[count * nodeAccess.getDimension() * 4];
             wayGeometry.getBytes(geoRef, bytes, bytes.length);
         } else if (mode == 0)
             return PointList.EMPTY;
 
-        PointList pillarNodes = new PointList(count + mode);
+        PointList pillarNodes = new PointList(count + mode, nodeAccess.is3D());
         if (reverse)
         {
             if ((mode & 2) != 0)
-                pillarNodes.add(getLatitude(adjNode), getLongitude(adjNode));
+                pillarNodes.add(nodeAccess, adjNode);
         } else
         {
             if ((mode & 1) != 0)
-                pillarNodes.add(getLatitude(baseNode), getLongitude(baseNode));
+                pillarNodes.add(nodeAccess, baseNode);
         }
 
         int index = 0;
@@ -1024,18 +1005,25 @@ private PointList fetchWayGeometry( long edgePointer, boolean reverse, int mode,
             index += 4;
             double lon = Helper.intToDegree(bitUtil.toInt(bytes, index));
             index += 4;
-            pillarNodes.add(lat, lon);
+            if (nodeAccess.is3D())
+            {
+                pillarNodes.add(lat, lon, Helper.intToEle(bitUtil.toInt(bytes, index)));
+                index += 4;
+            } else
+            {
+                pillarNodes.add(lat, lon);
+            }
         }
 
         if (reverse)
         {
             if ((mode & 1) != 0)
-                pillarNodes.add(getLatitude(baseNode), getLongitude(baseNode));
+                pillarNodes.add(nodeAccess, baseNode);
             pillarNodes.reverse();
         } else
         {
             if ((mode & 2) != 0)
-                pillarNodes.add(getLatitude(adjNode), getLongitude(adjNode));
+                pillarNodes.add(nodeAccess, adjNode);
         }
 
         return pillarNodes;
@@ -1056,10 +1044,16 @@ public Graph copyTo( Graph g )
     Graph _copyTo( GraphHopperStorage clonedG )
     {
         if (clonedG.edgeEntryBytes != edgeEntryBytes)
-            throw new IllegalStateException("edgeEntrySize cannot be different for cloned graph");
+            throw new IllegalStateException("edgeEntryBytes cannot be different for cloned graph. "
+                    + "Cloned: " + clonedG.edgeEntryBytes + " vs " + edgeEntryBytes);
 
         if (clonedG.nodeEntryBytes != nodeEntryBytes)
-            throw new IllegalStateException("nodeEntrySize cannot be different for cloned graph");
+            throw new IllegalStateException("nodeEntryBytes cannot be different for cloned graph. "
+                    + "Cloned: " + clonedG.nodeEntryBytes + " vs " + nodeEntryBytes);
+
+        if (clonedG.nodeAccess.getDimension() != nodeAccess.getDimension())
+            throw new IllegalStateException("dimension cannot be different for cloned graph. "
+                    + "Cloned: " + clonedG.nodeAccess.getDimension() + " vs " + nodeAccess.getDimension());
 
         // nodes
         setNodesHeader();
@@ -1184,7 +1178,7 @@ private void inPlaceNodeRemove( int removeNodeCount )
         GHBitSet toRemoveSet = new GHBitSetImpl(removeNodeCount);
         removedNodes.copyTo(toRemoveSet);
 
-        EdgeExplorer delExplorer = createEdgeExplorer(allEdgesFilter);
+        EdgeExplorer delExplorer = createEdgeExplorer(EdgeFilter.ALL_EDGES);
         // create map of old node ids pointing to new ids        
         for (int removeNode = removedNodes.next(0);
                 removeNode >= 0;
@@ -1297,7 +1291,7 @@ private void inPlaceNodeRemove( int removeNodeCount )
             int linkB = edges.getInt(getLinkPosInEdgeArea(nodeB, nodeA, edgePointer));
             long flags = getFlags(edgePointer, false);
             writeEdge(edge, updatedA, updatedB, linkA, linkB);
-            setFlags(edgePointer, updatedA, updatedB, flags);
+            setFlags(edgePointer, updatedA > updatedB, flags);
             if (updatedA < updatedB != nodeA < nodeB)
                 setWayGeometry(fetchWayGeometry(edgePointer, true, 0, -1, -1), edgePointer, false);
         }
@@ -1390,18 +1384,26 @@ public boolean loadExisting()
                             + dir.getLocation());
 
                 int bytesForFlags = 4;
-                if("8".equals(properties.get("osmreader.bytesForFlags")))
+                if ("8".equals(properties.get("osmreader.bytesForFlags")))
                     bytesForFlags = 8;
                 encodingManager = new EncodingManager(acceptStr, bytesForFlags);
             } else if (!acceptStr.isEmpty() && !encodingManager.toDetailsString().equalsIgnoreCase(acceptStr))
             {
-                throw new IllegalStateException("Encoding does not match:\nGraphhopper config: " + encodingManager.toDetailsString() 
+                throw new IllegalStateException("Encoding does not match:\nGraphhopper config: " + encodingManager.toDetailsString()
                         + "\nGraph: " + acceptStr + ", dir:" + dir.getLocation());
             }
 
+            String dim = properties.get("graph.dimension");
+            if (!dim.equalsIgnoreCase("" + nodeAccess.getDimension()))
+                throw new IllegalStateException("Configured dimension (" + dim + ") is not equal to dimension of loaded graph (" + nodeAccess.getDimension() + ")");
+
+            String byteOrder = properties.get("graph.byteOrder");
+            if (!byteOrder.equalsIgnoreCase("" + dir.getByteOrder()))
+                throw new IllegalStateException("Configured byteOrder (" + dim + ") is not equal to byteOrder of loaded graph (" + dir.getByteOrder() + ")");
+
             // first define header indices of this storage
             initStorage();
-            
+
             // now load some properties from stored data
             loadNodesHeader();
             loadEdgesHeader();
@@ -1412,7 +1414,7 @@ public boolean loadExisting()
     }
 
     protected void initStorage()
-    {   
+    {
         edgeEntryIndex = 0;
         nodeEntryIndex = 0;
         E_NODEA = nextEdgeEntryIndex(4);
@@ -1422,22 +1424,26 @@ protected void initStorage()
         E_DIST = nextEdgeEntryIndex(4);
         this.flagsSizeIsLong = encodingManager.getBytesForFlags() == 8;
         E_FLAGS = nextEdgeEntryIndex(encodingManager.getBytesForFlags());
-        
         E_GEO = nextEdgeEntryIndex(4);
         E_NAME = nextEdgeEntryIndex(4);
         if (extStorage.isRequireEdgeField())
             E_ADDITIONAL = nextEdgeEntryIndex(4);
         else
             E_ADDITIONAL = -1;
-        
+
         N_EDGE_REF = nextNodeEntryIndex(4);
         N_LAT = nextNodeEntryIndex(4);
         N_LON = nextNodeEntryIndex(4);
+        if (nodeAccess.is3D())
+            N_ELE = nextNodeEntryIndex(4);
+        else
+            N_ELE = -1;
+
         if (extStorage.isRequireNodeField())
             N_ADDITIONAL = nextNodeEntryIndex(4);
         else
             N_ADDITIONAL = -1;
-        
+
         initNodeAndEdgeEntrySize();
         initialized = true;
     }
@@ -1446,9 +1452,9 @@ protected int loadNodesHeader()
     {
         int hash = nodes.getHeader(0);
         if (hash != getClass().getName().hashCode())
-            throw new IllegalStateException("Cannot load the graph - use instance "
-                    + getClass().getName() + " to load it! " + dir);
-        
+            throw new IllegalStateException("Cannot load the graph when using instance of "
+                    + getClass().getName() + " and location: " + dir);
+
         nodeEntryBytes = nodes.getHeader(1 * 4);
         nodeCount = nodes.getHeader(2 * 4);
         bounds.minLon = Helper.intToDegree(nodes.getHeader(3 * 4));
@@ -1472,7 +1478,7 @@ protected int setNodesHeader()
 
     protected int loadEdgesHeader()
     {
-        edgeEntryBytes = edges.getHeader(0);
+        edgeEntryBytes = edges.getHeader(0 * 4);
         edgeCount = edges.getHeader(1 * 4);
         return 4;
     }
@@ -1532,7 +1538,7 @@ public ExtendedStorage getExtendedStorage()
     @Override
     public long getCapacity()
     {
-        return edges.getCapacity() + nodes.getCapacity() + nameIndex.getCapacity() + wayGeometry.getCapacity() 
+        return edges.getCapacity() + nodes.getCapacity() + nameIndex.getCapacity() + wayGeometry.getCapacity()
                 + properties.getCapacity() + extStorage.getCapacity();
     }
 
@@ -1552,6 +1558,7 @@ public String toString()
         return getClass().getSimpleName()
                 + "|" + encodingManager
                 + "|" + getDirectory().getDefaultType()
+                + "|" + nodeAccess.getDimension() + "D"
                 + "|" + getProperties().versionsToString();
     }
 }
diff --git a/core/src/main/java/com/graphhopper/storage/GraphStorage3D.java b/core/src/main/java/com/graphhopper/storage/GraphStorage3D.java
deleted file mode 100644
index 9133b517b2..0000000000
--- a/core/src/main/java/com/graphhopper/storage/GraphStorage3D.java
+++ /dev/null
@@ -1,68 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.storage;
-
-import com.graphhopper.routing.util.EncodingManager;
-import com.graphhopper.util.Helper;
-
-/**
- * @author Peter Karich
- */
-public class GraphStorage3D extends GraphHopperStorage implements Graph3D
-{
-    private int N_HEIGHT;
-
-    public GraphStorage3D( Directory dir, EncodingManager encodingManager )
-    {
-        super(dir, encodingManager);        
-    }
-
-    @Override
-    protected void initStorage()
-    {
-        super.initStorage();
-        N_HEIGHT = nextNodeEntryIndex(4);
-        initNodeAndEdgeEntrySize();
-    }
-
-    @Override
-    public GraphStorage3D create( long nodeCount )
-    {
-        return (GraphStorage3D) super.create(nodeCount);
-    }
-
-    @Override
-    public void setNode( int index, double lat, double lon, double height )
-    {
-        setNode(index, lat, lon);
-
-        // Improvements:
-        // 1 bounds for index
-        // 2 location to id index
-        // we need to avoid rewriting every algorithm like A*
-        // 3 currWeightToGoal = dist.calcDistKm(toLat, toLon, tmpLat, tmpLon);
-        nodes.setInt((long) index * nodeEntryBytes + N_HEIGHT, Helper.doubleToInt(height));
-    }
-
-    @Override
-    public double getHeight( int index )
-    {
-        ensureNodeIndex(index);
-        return Helper.intToDouble(nodes.getInt((long) index * nodeEntryBytes + N_HEIGHT));
-    }
-}
diff --git a/core/src/main/java/com/graphhopper/storage/LevelGraphStorage.java b/core/src/main/java/com/graphhopper/storage/LevelGraphStorage.java
index 7f12944b1a..775f84a924 100644
--- a/core/src/main/java/com/graphhopper/storage/LevelGraphStorage.java
+++ b/core/src/main/java/com/graphhopper/storage/LevelGraphStorage.java
@@ -17,6 +17,7 @@
  */
 package com.graphhopper.storage;
 
+import com.graphhopper.routing.ch.PrepareEncoder;
 import com.graphhopper.routing.util.AllEdgesSkipIterator;
 import com.graphhopper.routing.util.EdgeFilter;
 import com.graphhopper.routing.util.EncodingManager;
@@ -43,22 +44,24 @@
     private int I_SKIP_EDGE2;
     private int I_LEVEL;
     // after the last edge only shortcuts are stored
-    private int lastEdgeIndex;
+    private int lastEdgeIndex = -1;
+    private final long scDirMask = PrepareEncoder.getScDirMask();
 
-    public LevelGraphStorage( Directory dir, EncodingManager encodingManager )
+    public LevelGraphStorage( Directory dir, EncodingManager encodingManager, boolean enabled3D )
     {
-        super(dir, encodingManager);        
+        super(dir, encodingManager, enabled3D);
     }
 
     @Override
-    protected void initStorage() {
+    protected void initStorage()
+    {
         super.initStorage();
         I_SKIP_EDGE1 = nextEdgeEntryIndex(4);
         I_SKIP_EDGE2 = nextEdgeEntryIndex(4);
         I_LEVEL = nextNodeEntryIndex(4);
         initNodeAndEdgeEntrySize();
     }
-    
+
     @Override
     public final void setLevel( int index, int level )
     {
@@ -104,7 +107,7 @@ private EdgeSkipIterState createEdge( int a, int b )
     @Override
     public EdgeSkipExplorer createEdgeExplorer()
     {
-        return createEdgeExplorer(allEdgesFilter);
+        return createEdgeExplorer(EdgeFilter.ALL_EDGES);
     }
 
     @Override
@@ -184,7 +187,7 @@ public final double getWeight()
         }
 
         @Override
-        public final EdgeIteratorState detach()
+        public final EdgeIteratorState detach( boolean reverseArg )
         {
             if (edgeId == nextEdge)
                 throw new IllegalStateException("call next before detaching");
@@ -192,18 +195,42 @@ public final EdgeIteratorState detach()
             iter.setBaseNode(baseNode);
             iter.setEdgeId(edgeId);
             iter.next();
+            if (reverseArg)
+            {
+                iter.reverse = !this.reverse;
+                iter.adjNode = baseNode;
+                iter.baseNode = adjNode;
+            }
             return iter;
         }
 
         @Override
-        public final void copyProperties( EdgeIteratorState edge )
+        public final EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
-            super.copyProperties(edge);
-            EdgeSkipIterator eSkip = (EdgeSkipIterator) edge;
+            super.copyPropertiesTo(edge);
+
+//            EdgeSkipIterator eSkip = (EdgeSkipIterator) edge;
 //            setSkippedEdges(eSkip.getSkippedEdge1(), eSkip.getSkippedEdge2());
+            return edge;
         }
     }
 
+    @Override
+    long reverseFlags( long edgePointer, long flags )
+    {
+        boolean isShortcut = edgePointer > (long) lastEdgeIndex * edgeEntryBytes;
+        if (!isShortcut)
+            return super.reverseFlags(edgePointer, flags);
+
+        // we need a special swapping for level graph if it is a shortcut as we only store the weight and access flags then
+        long dir = flags & scDirMask;
+        if (dir == scDirMask || dir == 0)
+            return flags;
+
+        // swap the last bits with this mask
+        return flags ^ scDirMask;
+    }
+
     /**
      * Disconnects the edges (higher->lower node) via the specified edgeState pointing from lower to
      * higher node.
@@ -329,7 +356,7 @@ public final EdgeSkipIterState setWeight( double weight )
         public final double getWeight()
         {
             return LevelGraphStorage.this.getWeight(this);
-        }       
+        }
     }
 
     final void setWeight( EdgeSkipIterState edge, double weight )
@@ -345,7 +372,7 @@ final void setWeight( EdgeSkipIterState edge, double weight )
         else
             weightLong = ((long) (weight * WEIGHT_FACTOR)) << 2;
 
-        long accessFlags = edge.getFlags() & 0x3;
+        long accessFlags = edge.getFlags() & PrepareEncoder.getScDirMask();
         edge.setFlags(weightLong | accessFlags);
     }
 
diff --git a/core/src/main/java/com/graphhopper/storage/MMapDataAccess.java b/core/src/main/java/com/graphhopper/storage/MMapDataAccess.java
index dd16654526..1896d39774 100644
--- a/core/src/main/java/com/graphhopper/storage/MMapDataAccess.java
+++ b/core/src/main/java/com/graphhopper/storage/MMapDataAccess.java
@@ -134,6 +134,7 @@ protected boolean mapIt( long offset, long byteCount, boolean clearNew )
             {
                 newSegments = segmentsToMap;
                 clean(0, segments.size());
+                cleanHack();
                 segments.clear();
             } else
             {
@@ -275,14 +276,25 @@ public void flush()
 
     @Override
     public void close()
+    {
+        close(true);
+    }
+
+    /**
+     * @param forceClean if true the clean hack (system.gc) will be executed and forces the system
+     * to cleanup the mmap resources. Set false if you need to close many MMapDataAccess objects.
+     */
+    void close( boolean forceClean )
     {
         clean(0, segments.size());
         segments.clear();
         Helper.close(raFile);
+        if (forceClean)
+            cleanHack();
         closed = true;
     }
 
-    private void cleanHack()
+    void cleanHack()
     {
         // trying to force the release of the mapped ByteBuffer
         System.gc();
@@ -304,6 +316,22 @@ public final int getInt( long bytePos )
         return segments.get(bufferIndex).getInt(index);
     }
 
+    @Override
+    public final void setShort( long bytePos, short value )
+    {
+        int bufferIndex = (int) (bytePos >>> segmentSizePower);
+        int index = (int) (bytePos & indexDivisor);
+        segments.get(bufferIndex).putShort(index, value);
+    }
+
+    @Override
+    public final short getShort( long bytePos )
+    {
+        int bufferIndex = (int) (bytePos >>> segmentSizePower);
+        int index = (int) (bytePos & indexDivisor);
+        return segments.get(bufferIndex).getShort(index);
+    }
+
     @Override
     public void setBytes( long bytePos, byte[] values, int length )
     {
@@ -381,7 +409,6 @@ private void clean( int from, int to )
             Helper.cleanMappedByteBuffer(bb);
             segments.set(i, null);
         }
-        cleanHack();
     }
 
     @Override
@@ -398,6 +425,7 @@ public void trimTo( long capacity )
         }
 
         clean(remainingSegNo, segments.size());
+        cleanHack();
         segments = new ArrayList<ByteBuffer>(segments.subList(0, remainingSegNo));
 
         try
diff --git a/core/src/main/java/com/graphhopper/storage/NodeAccess.java b/core/src/main/java/com/graphhopper/storage/NodeAccess.java
new file mode 100644
index 0000000000..5221b1fb6b
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/storage/NodeAccess.java
@@ -0,0 +1,46 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.storage;
+
+import com.graphhopper.util.PointAccess;
+
+/**
+ * This interface specifies how to access properties of the nodes in the graph. Similar to
+ * EdgeExplorer as it needs multiple instances for different threads or loops but without the need
+ * for an additional iterator.
+ * <p>
+ * @author Peter Karich
+ */
+public interface NodeAccess extends PointAccess
+{
+    /**
+     * @return the additional value at the specified node index
+     * @throws AssertionError if, and only if, the extendedStorage does not require an additional
+     * node field
+     */
+    int getAdditionalNodeField( int nodeId );
+
+    /**
+     * Sets the additional value at the specified node index
+     * <p>
+     * @throws AssertionError if, and only if, the extendedStorage does not require an additional
+     * node field
+     */
+    void setAdditionalNodeField( int nodeId, int additionalValue );
+}
diff --git a/core/src/main/java/com/graphhopper/storage/RAMDataAccess.java b/core/src/main/java/com/graphhopper/storage/RAMDataAccess.java
index 22482cc254..495d795b8d 100644
--- a/core/src/main/java/com/graphhopper/storage/RAMDataAccess.java
+++ b/core/src/main/java/com/graphhopper/storage/RAMDataAccess.java
@@ -233,6 +233,26 @@ public final int getInt( long bytePos )
         return bitUtil.toInt(segments[bufferIndex], index);
     }
 
+    @Override
+    public final void setShort( long bytePos, short value )
+    {
+        assert segmentSizePower > 0 : "call create or loadExisting before usage!";
+        int bufferIndex = (int) (bytePos >>> segmentSizePower);
+        int index = (int) (bytePos & indexDivisor);
+        assert index + 2 <= segmentSizeInBytes : "integer cannot be distributed over two segments";
+        bitUtil.fromShort(segments[bufferIndex], value, index);
+    }
+
+    @Override
+    public final short getShort( long bytePos )
+    {
+        assert segmentSizePower > 0 : "call create or loadExisting before usage!";
+        int bufferIndex = (int) (bytePos >>> segmentSizePower);
+        int index = (int) (bytePos & indexDivisor);
+        assert index + 2 <= segmentSizeInBytes : "integer cannot be distributed over two segments";
+        return bitUtil.toShort(segments[bufferIndex], index);
+    }
+
     @Override
     public void setBytes( long bytePos, byte[] values, int length )
     {
diff --git a/core/src/main/java/com/graphhopper/storage/RAMIntDataAccess.java b/core/src/main/java/com/graphhopper/storage/RAMIntDataAccess.java
index 2b2b5fd236..e733417a87 100644
--- a/core/src/main/java/com/graphhopper/storage/RAMIntDataAccess.java
+++ b/core/src/main/java/com/graphhopper/storage/RAMIntDataAccess.java
@@ -63,7 +63,7 @@ public DataAccess copyTo( DataAccess da )
         if (da instanceof RAMIntDataAccess)
         {
             copyHeader(da);
-            RAMIntDataAccess rda = (RAMIntDataAccess) da;            
+            RAMIntDataAccess rda = (RAMIntDataAccess) da;
             // TODO PERFORMANCE we could reuse rda segments!
             rda.segments = new int[segments.length][];
             for (int i = 0; i < segments.length; i++)
@@ -223,25 +223,57 @@ public void flush()
     }
 
     @Override
-    public final void setInt( long longIndex, int value )
+    public final void setInt( long bytePos, int value )
     {
         assert segmentSizeIntsPower > 0 : "call create or loadExisting before usage!";
-        longIndex >>>= 2;
-        int bufferIndex = (int) (longIndex >>> segmentSizeIntsPower);
-        int index = (int) (longIndex & indexDivisor);
+        bytePos >>>= 2;
+        int bufferIndex = (int) (bytePos >>> segmentSizeIntsPower);
+        int index = (int) (bytePos & indexDivisor);
         segments[bufferIndex][index] = value;
     }
 
     @Override
-    public final int getInt( long longIndex )
+    public final int getInt( long bytePos )
     {
         assert segmentSizeIntsPower > 0 : "call create or loadExisting before usage!";
-        longIndex >>>= 2;
-        int bufferIndex = (int) (longIndex >>> segmentSizeIntsPower);
-        int index = (int) (longIndex & indexDivisor);
+        bytePos >>>= 2;
+        int bufferIndex = (int) (bytePos >>> segmentSizeIntsPower);
+        int index = (int) (bytePos & indexDivisor);
         return segments[bufferIndex][index];
     }
 
+    @Override
+    public final void setShort( long bytePos, short value )
+    {
+        assert segmentSizeIntsPower > 0 : "call create or loadExisting before usage!";
+        if (bytePos % 4 != 0 && bytePos % 4 != 2)
+            throw new IllegalMonitorStateException("bytePos of wrong multiple for RAMInt " + bytePos);
+
+        long tmpIndex = bytePos >>> 1;
+        int bufferIndex = (int) (tmpIndex >>> segmentSizeIntsPower);
+        int index = (int) (tmpIndex & indexDivisor);
+        if (tmpIndex * 2 == bytePos)
+            segments[bufferIndex][index] = value;
+        else
+            segments[bufferIndex][index] = value << 16;
+    }
+
+    @Override
+    public final short getShort( long bytePos )
+    {
+        assert segmentSizeIntsPower > 0 : "call create or loadExisting before usage!";
+        if (bytePos % 4 != 0 && bytePos % 4 != 2)
+            throw new IllegalMonitorStateException("bytePos of wrong multiple for RAMInt " + bytePos);
+
+        long tmpIndex = bytePos >>> 1;
+        int bufferIndex = (int) (tmpIndex >>> segmentSizeIntsPower);
+        int index = (int) (tmpIndex & indexDivisor);
+        if (tmpIndex * 2 == bytePos)
+            return (short) segments[bufferIndex][index];
+        else
+            return (short) (segments[bufferIndex][index] >> 16);
+    }
+
     @Override
     public void getBytes( long bytePos, byte[] values, int length )
     {
diff --git a/core/src/main/java/com/graphhopper/storage/SynchedDAWrapper.java b/core/src/main/java/com/graphhopper/storage/SynchedDAWrapper.java
index 8772e3ab49..93b0336535 100644
--- a/core/src/main/java/com/graphhopper/storage/SynchedDAWrapper.java
+++ b/core/src/main/java/com/graphhopper/storage/SynchedDAWrapper.java
@@ -57,6 +57,18 @@ public synchronized int getInt( long bytePos )
         return inner.getInt(bytePos);
     }
 
+    @Override
+    public synchronized void setShort( long bytePos, short value )
+    {
+        inner.setShort(bytePos, value);
+    }
+
+    @Override
+    public synchronized short getShort( long bytePos )
+    {
+        return inner.getShort(bytePos);
+    }
+
     @Override
     public synchronized void setBytes( long bytePos, byte[] values, int length )
     {
diff --git a/core/src/main/java/com/graphhopper/storage/TurnCostStorage.java b/core/src/main/java/com/graphhopper/storage/TurnCostStorage.java
index 03220080d0..a9d67d5f90 100644
--- a/core/src/main/java/com/graphhopper/storage/TurnCostStorage.java
+++ b/core/src/main/java/com/graphhopper/storage/TurnCostStorage.java
@@ -45,6 +45,7 @@
     protected int turnCostsCount;
 
     private GraphStorage graph;
+    private NodeAccess nodeAccess;
 
     public TurnCostStorage()
     {
@@ -63,6 +64,7 @@ public void init( GraphStorage graph )
             throw new AssertionError("The turn cost storage must be initialized only once.");
 
         this.graph = graph;
+        this.nodeAccess = graph.getNodeAccess();
         this.turnCosts = this.graph.getDirectory().find("turnCosts");
     }
 
@@ -123,10 +125,9 @@ public boolean loadExisting()
     private int getCostTableAdress( int index )
     {
         if (index >= graph.getNodes() || index < 0)
-        {
             return NO_COST_ENTRY;
-        }
-        return graph.getAdditionalNodeField(index);
+
+        return nodeAccess.getAdditionalNodeField(index);
     }
 
     public void setTurnCosts( int nodeIndex, int from, int to, int flags )
@@ -147,7 +148,7 @@ public void setTurnCosts( int nodeIndex, int from, int to, int flags )
         if (previousEntryIndex == NO_COST_ENTRY)
         {
             // set cost-pointer to this new cost entry
-            graph.setAdditionalNodeField(nodeIndex, newEntryIndex);
+            nodeAccess.setAdditionalNodeField(nodeIndex, newEntryIndex);
         } else
         {
             int i = 0;
diff --git a/core/src/main/java/com/graphhopper/storage/UnsafeDataAccess.java b/core/src/main/java/com/graphhopper/storage/UnsafeDataAccess.java
index 9e14874c65..db8df6fd45 100644
--- a/core/src/main/java/com/graphhopper/storage/UnsafeDataAccess.java
+++ b/core/src/main/java/com/graphhopper/storage/UnsafeDataAccess.java
@@ -32,9 +32,9 @@
  * <p>
  * 1. Highly experimental. Still some bugs and access through file/MMAP should work at some point
  * <p>
- * 2. Compared to MMAP no syncDAWrapper is need to make it safe from multiple threads
+ * 2. Compared to MMAP no syncDAWrapper is need to make it read and write safe from multiple threads
  * <p>
- * 3. Cannot be used on Android I think
+ * 3. Cannot be used on Android as no memory allocation methods are available there
  * <p/>
  * @author Peter Karich
  */
@@ -47,7 +47,7 @@
     static
     {
         try
-        {                           
+        {
             // On Android getting Unsafe fails as the field is named THE_ONE but Android has no memory allocation methods so it won't work nevertheless.
             // On Android we need JNI+malloc https://github.com/libgdx/libgdx/blob/5945211a88570ced7eafce95c68f6f1f7124cd23/gdx/src/com/badlogic/gdx/utils/BufferUtils.java#L287
             @SuppressWarnings("all")
@@ -220,6 +220,18 @@ public final int getInt( long bytePos )
         return UNSAFE.getInt(address + bytePos);
     }
 
+    @Override
+    public short getShort( long bytePos )
+    {
+        return UNSAFE.getShort(address + bytePos);
+    }
+
+    @Override
+    public void setShort( long bytePos, short value )
+    {
+        UNSAFE.putShort(address + bytePos, value);
+    }
+
     @Override
     public final void setBytes( long bytePos, byte[] values, int length )
     {
diff --git a/core/src/main/java/com/graphhopper/storage/index/Location2IDFullIndex.java b/core/src/main/java/com/graphhopper/storage/index/Location2IDFullIndex.java
index 2a10fdddac..09f141eec2 100644
--- a/core/src/main/java/com/graphhopper/storage/index/Location2IDFullIndex.java
+++ b/core/src/main/java/com/graphhopper/storage/index/Location2IDFullIndex.java
@@ -20,6 +20,7 @@
 import com.graphhopper.routing.util.AllEdgesIterator;
 import com.graphhopper.routing.util.EdgeFilter;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.DistanceCalc;
 import com.graphhopper.util.DistanceCalcEarth;
 import com.graphhopper.util.DistancePlaneProjection;
@@ -34,10 +35,12 @@
 {
     private DistanceCalc calc = new DistancePlaneProjection();
     private final Graph graph;
+    private final NodeAccess nodeAccess;
 
     public Location2IDFullIndex( Graph g )
     {
         this.graph = g;
+        this.nodeAccess = g.getNodeAccess();
     }
 
     @Override
@@ -50,12 +53,10 @@ public boolean loadExisting()
     public LocationIndex setApproximation( boolean approxDist )
     {
         if (approxDist)
-        {
             calc = new DistancePlaneProjection();
-        } else
-        {
+        else
             calc = new DistanceCalcEarth();
-        }
+
         return this;
     }
 
@@ -91,12 +92,12 @@ public QueryResult findClosest( double queryLat, double queryLon, EdgeFilter edg
                 {
                     node = iter.getAdjNode();
                 }
-                double tmpLat = graph.getLatitude(node);
-                double tmpLon = graph.getLongitude(node);
+                double tmpLat = nodeAccess.getLatitude(node);
+                double tmpLon = nodeAccess.getLongitude(node);
                 double dist = calc.calcDist(tmpLat, tmpLon, queryLat, queryLon);
                 if (circle == null || dist < calc.calcDist(circle.getLat(), circle.getLon(), queryLat, queryLon))
                 {
-                    res.setClosestEdge(iter.detach());
+                    res.setClosestEdge(iter.detach(false));
                     res.setClosestNode(node);
                     res.setQueryDistance(dist);
                     if (dist <= 0)
diff --git a/core/src/main/java/com/graphhopper/storage/index/Location2IDFullWithEdgesIndex.java b/core/src/main/java/com/graphhopper/storage/index/Location2IDFullWithEdgesIndex.java
index 72104be8fc..05fadf8dfc 100644
--- a/core/src/main/java/com/graphhopper/storage/index/Location2IDFullWithEdgesIndex.java
+++ b/core/src/main/java/com/graphhopper/storage/index/Location2IDFullWithEdgesIndex.java
@@ -20,6 +20,7 @@
 import com.graphhopper.routing.util.AllEdgesIterator;
 import com.graphhopper.routing.util.EdgeFilter;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.DistancePlaneProjection;
 import com.graphhopper.util.DistanceCalc;
 import com.graphhopper.util.DistanceCalcEarth;
@@ -32,11 +33,13 @@
 public class Location2IDFullWithEdgesIndex implements LocationIndex
 {
     private DistanceCalc calc = new DistanceCalcEarth();
-    private Graph graph;
+    private final Graph graph;
+    private final NodeAccess nodeAccess;
 
     public Location2IDFullWithEdgesIndex( Graph g )
     {
         this.graph = g;
+        this.nodeAccess = g.getNodeAccess();
     }
 
     @Override
@@ -98,8 +101,8 @@ public QueryResult findClosest( double queryLat, double queryLon, EdgeFilter fil
                     node = iter.getAdjNode();
                 }
 
-                double fromLat = graph.getLatitude(node);
-                double fromLon = graph.getLongitude(node);
+                double fromLat = nodeAccess.getLatitude(node);
+                double fromLon = nodeAccess.getLongitude(node);
                 double fromDist = calc.calcDist(fromLat, fromLon, queryLat, queryLon);
                 if (fromDist < 0)
                     continue;
@@ -107,7 +110,7 @@ public QueryResult findClosest( double queryLat, double queryLon, EdgeFilter fil
                 if (fromDist < foundDist)
                 {
                     res.setQueryDistance(fromDist);
-                    res.setClosestEdge(iter.detach());
+                    res.setClosestEdge(iter.detach(false));
                     res.setClosestNode(node);
                     foundDist = fromDist;
                 }
@@ -117,8 +120,8 @@ public QueryResult findClosest( double queryLat, double queryLon, EdgeFilter fil
                     continue;
 
                 int toNode = iter.getAdjNode();
-                double toLat = graph.getLatitude(toNode);
-                double toLon = graph.getLongitude(toNode);
+                double toLat = nodeAccess.getLatitude(toNode);
+                double toLon = nodeAccess.getLongitude(toNode);
 
                 if (calc.validEdgeDistance(queryLat, queryLon,
                         fromLat, fromLon, toLat, toLon))
diff --git a/core/src/main/java/com/graphhopper/storage/index/Location2IDQuadtree.java b/core/src/main/java/com/graphhopper/storage/index/Location2IDQuadtree.java
index 369d880cd3..d0c30ef8a1 100644
--- a/core/src/main/java/com/graphhopper/storage/index/Location2IDQuadtree.java
+++ b/core/src/main/java/com/graphhopper/storage/index/Location2IDQuadtree.java
@@ -23,10 +23,7 @@
 import com.graphhopper.geohash.KeyAlgo;
 import com.graphhopper.geohash.LinearKeyAlgo;
 import com.graphhopper.routing.util.EdgeFilter;
-import com.graphhopper.storage.DataAccess;
-import com.graphhopper.storage.Directory;
-import com.graphhopper.storage.Graph;
-import com.graphhopper.storage.RAMDirectory;
+import com.graphhopper.storage.*;
 import com.graphhopper.util.DistanceCalc;
 import com.graphhopper.util.DistanceCalcEarth;
 import com.graphhopper.util.DistancePlaneProjection;
@@ -57,11 +54,13 @@
     private final DataAccess index;
     private double maxRasterWidth2InMeterNormed;
     private final Graph graph;
+    private final NodeAccess nodeAccess;
     private int lonSize, latSize;
 
     public Location2IDQuadtree( Graph g, Directory dir )
     {
         this.graph = g;
+        this.nodeAccess = g.getNodeAccess();
         index = dir.find("loc2idIndex");
         setResolution(100 * 100);
     }
@@ -191,8 +190,8 @@ private GHBitSet fillQuadtree( int size )
         GHPoint coord = new GHPoint();
         for (int nodeId = 0; nodeId < locs; nodeId++)
         {
-            double lat = graph.getLatitude(nodeId);
-            double lon = graph.getLongitude(nodeId);
+            double lat = nodeAccess.getLatitude(nodeId);
+            double lon = nodeAccess.getLongitude(nodeId);
             int key = (int) keyAlgo.encode(lat, lon);
             long bytePos = (long) key * 4;
             if (filledIndices.contains(key))
@@ -201,8 +200,8 @@ private GHBitSet fillQuadtree( int size )
                 keyAlgo.decode(key, coord);
                 // decide which one is closer to 'key'
                 double distNew = distCalc.calcNormalizedDist(coord.lat, coord.lon, lat, lon);
-                double oldLat = graph.getLatitude(oldNodeId);
-                double oldLon = graph.getLongitude(oldNodeId);
+                double oldLat = nodeAccess.getLatitude(oldNodeId);
+                double oldLon = nodeAccess.getLongitude(oldNodeId);
                 double distOld = distCalc.calcNormalizedDist(coord.lat, coord.lon, oldLat, oldLon);
                 // new point is closer to quad tree point (key) so overwrite old
                 if (distNew < distOld)
@@ -342,8 +341,8 @@ public QueryResult findClosest( final double queryLat, final double queryLon,
          */
         long key = keyAlgo.encode(queryLat, queryLon);
         final int id = index.getInt(key * 4);
-        double mainLat = graph.getLatitude(id);
-        double mainLon = graph.getLongitude(id);
+        double mainLat = nodeAccess.getLatitude(id);
+        double mainLon = nodeAccess.getLongitude(id);
         final QueryResult res = new QueryResult(queryLat, queryLon);
         res.setClosestNode(id);
         res.setQueryDistance(distCalc.calcNormalizedDist(queryLat, queryLon, mainLat, mainLon));
@@ -363,8 +362,8 @@ protected boolean goFurther( int baseNode )
                     return true;
 
                 goFurtherHook(baseNode);
-                double currLat = graph.getLatitude(baseNode);
-                double currLon = graph.getLongitude(baseNode);
+                double currLat = nodeAccess.getLatitude(baseNode);
+                double currLon = nodeAccess.getLongitude(baseNode);
                 double currNormedDist = distCalc.calcNormalizedDist(queryLat, queryLon, currLat, currLon);
                 if (currNormedDist < res.getQueryDistance())
                 {
diff --git a/core/src/main/java/com/graphhopper/storage/index/LocationIndexTree.java b/core/src/main/java/com/graphhopper/storage/index/LocationIndexTree.java
index bd8eb79da2..23bad3c462 100644
--- a/core/src/main/java/com/graphhopper/storage/index/LocationIndexTree.java
+++ b/core/src/main/java/com/graphhopper/storage/index/LocationIndexTree.java
@@ -25,6 +25,7 @@
 import com.graphhopper.storage.DataAccess;
 import com.graphhopper.storage.Directory;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.*;
 import com.graphhopper.util.shapes.BBox;
 import gnu.trove.list.array.TIntArrayList;
@@ -52,6 +53,7 @@
     protected static DistanceCalc distCalc = new DistancePlaneProjection();
     private DistanceCalc preciseDistCalc = new DistanceCalcEarth();
     protected final Graph graph;
+    private final NodeAccess nodeAccess;
     final DataAccess dataAccess;
     private int[] entries;
     private byte[] shifts;
@@ -76,6 +78,7 @@ public LocationIndexTree( Graph g, Directory dir )
     {
         MAGIC_INT = Integer.MAX_VALUE / 22316;
         this.graph = g;
+        this.nodeAccess = g.getNodeAccess();
         dataAccess = dir.find("locationIndex");
     }
 
@@ -354,8 +357,8 @@ void prepare()
                 {
                     int nodeA = allIter.getBaseNode();
                     int nodeB = allIter.getAdjNode();
-                    double lat1 = graph.getLatitude(nodeA);
-                    double lon1 = graph.getLongitude(nodeA);
+                    double lat1 = nodeAccess.getLatitude(nodeA);
+                    double lon1 = nodeAccess.getLongitude(nodeA);
                     double lat2;
                     double lon2;
                     PointList points = allIter.fetchWayGeometry(0);
@@ -368,8 +371,8 @@ void prepare()
                         lat1 = lat2;
                         lon1 = lon2;
                     }
-                    lat2 = graph.getLatitude(nodeB);
-                    lon2 = graph.getLongitude(nodeB);
+                    lat2 = nodeAccess.getLatitude(nodeB);
+                    lon2 = nodeAccess.getLongitude(nodeB);
                     addNode(nodeA, nodeB, lat1, lon1, lat2, lon2);
                 }
             } catch (Exception ex)
@@ -596,11 +599,11 @@ protected TIntHashSet findNetworkEntries( double queryLat, double queryLon )
         if (regionSearch)
         {
             // search all rasters around minResolutionInMeter as we did not fill empty entries
-            double maxLat = queryLat + deltaLat;
-            double maxLon = queryLon + deltaLon;
-            for (double tmpLat = queryLat - deltaLat; tmpLat <= maxLat; tmpLat += deltaLat)
+            double maxLat = queryLat + 1.5 * deltaLat;
+            double maxLon = queryLon + 1.5 * deltaLon;
+            for (double tmpLat = queryLat - deltaLat; tmpLat < maxLat; tmpLat += deltaLat)
             {
-                for (double tmpLon = queryLon - deltaLon; tmpLon <= maxLon; tmpLon += deltaLon)
+                for (double tmpLon = queryLon - deltaLon; tmpLon < maxLon; tmpLon += deltaLon)
                 {
                     long keyPart = createReverseKey(tmpLat, tmpLon);
                     // System.out.println(BitUtilLittle.toBitString(key, keyAlgo.bits()));
@@ -620,7 +623,7 @@ public QueryResult findClosest( final double queryLat, final double queryLon,
             final EdgeFilter edgeFilter )
     {
         final TIntHashSet storedNetworkEntryIds = findNetworkEntries(queryLat, queryLon);
-        final QueryResult closestMatch = new QueryResult(queryLat, queryLon);               
+        final QueryResult closestMatch = new QueryResult(queryLat, queryLon);
         if (storedNetworkEntryIds.isEmpty())
             return closestMatch;
 
@@ -648,7 +651,7 @@ protected boolean check( int node, double normedDist, int wayIndex, EdgeIterator
                         {
                             closestMatch.setQueryDistance(normedDist);
                             closestMatch.setClosestNode(node);
-                            closestMatch.setClosestEdge(edge.detach());
+                            closestMatch.setClosestEdge(edge.detach(false));
                             closestMatch.setWayIndex(wayIndex);
                             closestMatch.setSnappedPosition(pos);
                             return true;
@@ -703,8 +706,8 @@ protected GHBitSet createBitSet()
         protected boolean goFurther( int baseNode )
         {
             currNode = baseNode;
-            currLat = graph.getLatitude(baseNode);
-            currLon = graph.getLongitude(baseNode);
+            currLat = nodeAccess.getLatitude(baseNode);
+            currLon = nodeAccess.getLongitude(baseNode);
             currNormedDist = distCalc.calcNormalizedDist(queryLat, queryLon, currLat, currLon);
             return goFurther;
         }
@@ -728,8 +731,8 @@ protected boolean checkAdjacent( EdgeIteratorState currEdge )
             }
 
             int adjNode = currEdge.getAdjNode();
-            double adjLat = graph.getLatitude(adjNode);
-            double adjLon = graph.getLongitude(adjNode);
+            double adjLat = nodeAccess.getLatitude(adjNode);
+            double adjLon = nodeAccess.getLongitude(adjNode);
             double adjDist = distCalc.calcNormalizedDist(adjLat, adjLon, queryLat, queryLon);
             // if there are wayPoints this is only an approximation
             if (adjDist < currNormedDist)
diff --git a/core/src/main/java/com/graphhopper/storage/index/LocationIndexTreeSC.java b/core/src/main/java/com/graphhopper/storage/index/LocationIndexTreeSC.java
index e929de2d88..6839b38ede 100644
--- a/core/src/main/java/com/graphhopper/storage/index/LocationIndexTreeSC.java
+++ b/core/src/main/java/com/graphhopper/storage/index/LocationIndexTreeSC.java
@@ -70,12 +70,6 @@ protected AllEdgesIterator getAllEdges()
         final AllEdgesSkipIterator tmpIter = lg.getAllEdges();
         return new AllEdgesIterator()
         {
-            @Override
-            public EdgeIteratorState detach()
-            {
-                return tmpIter.detach();
-            }
-
             @Override
             public int getMaxId()
             {
@@ -174,10 +168,16 @@ public EdgeIteratorState setAdditionalField( int value )
             }
 
             @Override
-            public void copyProperties( EdgeIteratorState edge )
+            public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
             {
-                tmpIter.copyProperties(edge);
-            }      
+                return tmpIter.copyPropertiesTo(edge);
+            }
+
+            @Override
+            public EdgeIteratorState detach( boolean reverse )
+            {
+                return tmpIter.detach(reverse);
+            }
         };
     }
 
diff --git a/core/src/main/java/com/graphhopper/storage/index/QueryResult.java b/core/src/main/java/com/graphhopper/storage/index/QueryResult.java
index 94ef64574a..26439ffb3c 100644
--- a/core/src/main/java/com/graphhopper/storage/index/QueryResult.java
+++ b/core/src/main/java/com/graphhopper/storage/index/QueryResult.java
@@ -22,6 +22,7 @@
 import com.graphhopper.util.PointList;
 import com.graphhopper.util.shapes.CoordTrig;
 import com.graphhopper.util.shapes.GHPoint;
+import com.graphhopper.util.shapes.GHPoint3D;
 
 /**
  * Result of LocationIndex lookup.
@@ -45,7 +46,7 @@
     private int closestNode = -1;
     private EdgeIteratorState closestEdge;
     private final GHPoint queryPoint;
-    private GHPoint snappedPoint;
+    private GHPoint3D snappedPoint;
     private Position snappedPosition;
 
     public static enum Position
@@ -145,7 +146,7 @@ public CoordTrig getQueryPoint()
      * Calculates the position of the query point 'snapped' to a close road segment or node. Call
      * calcSnappedPoint before, if not, an IllegalStateException is thrown.
      */
-    public GHPoint getSnappedPoint()
+    public GHPoint3D getSnappedPoint()
     {
         if (snappedPoint == null)
             throw new IllegalStateException("Calculate snapped point before!");
@@ -165,19 +166,23 @@ public void calcSnappedPoint( DistanceCalc distCalc )
         PointList fullPL = getClosestEdge().fetchWayGeometry(3);
         double tmpLat = fullPL.getLatitude(wayIndex);
         double tmpLon = fullPL.getLongitude(wayIndex);
+        double tmpEle = fullPL.getElevation(wayIndex);
         if (snappedPosition != Position.EDGE)
         {
-            snappedPoint = new GHPoint(tmpLat, tmpLon);
+            snappedPoint = new GHPoint3D(tmpLat, tmpLon, tmpEle);
             return;
         }
 
         double queryLat = getQueryPoint().lat, queryLon = getQueryPoint().lon;
         double adjLat = fullPL.getLatitude(wayIndex + 1), adjLon = fullPL.getLongitude(wayIndex + 1);
         if (distCalc.validEdgeDistance(queryLat, queryLon, tmpLat, tmpLon, adjLat, adjLon))
-            snappedPoint = distCalc.calcCrossingPointToEdge(queryLat, queryLon, tmpLat, tmpLon, adjLat, adjLon);
-        else
+        {
+            GHPoint tmpPoint = distCalc.calcCrossingPointToEdge(queryLat, queryLon, tmpLat, tmpLon, adjLat, adjLon);
+            double adjEle = fullPL.getElevation(wayIndex + 1);
+            snappedPoint = new GHPoint3D(tmpPoint.lat, tmpPoint.lon, (tmpEle + adjEle) / 2);
+        } else
             // outside of edge boundaries
-            snappedPoint = new GHPoint(tmpLat, tmpLon);
+            snappedPoint = new GHPoint3D(tmpLat, tmpLon, tmpEle);
     }
 
     @Override
diff --git a/core/src/main/java/com/graphhopper/trees/LeafWorker.java b/core/src/main/java/com/graphhopper/trees/LeafWorker.java
deleted file mode 100644
index 629717fd3d..0000000000
--- a/core/src/main/java/com/graphhopper/trees/LeafWorker.java
+++ /dev/null
@@ -1,31 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-/**
- * specify work on the leaf nodes of a quadtree
- * <p/>
- * @author Peter Karich
- */
-interface LeafWorker<T>
-{
-    /**
-     * @return true if no further search necessary
-     */
-    void doWork( QTDataNode<T> entry, int index );
-}
diff --git a/core/src/main/java/com/graphhopper/trees/QTBranchNode.java b/core/src/main/java/com/graphhopper/trees/QTBranchNode.java
deleted file mode 100644
index 7f9ba39696..0000000000
--- a/core/src/main/java/com/graphhopper/trees/QTBranchNode.java
+++ /dev/null
@@ -1,168 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import com.graphhopper.util.Helper;
-
-/**
- * @author Peter Karich
- */
-class QTBranchNode<V> implements QTNode<V>
-{
-    QTNode<V> node0;
-    QTNode<V> node1;
-    QTNode<V> node2;
-    QTNode<V> node3;
-
-    public QTBranchNode()
-    {
-    }
-
-    @Override
-    public final QTNode<V> get( int num )
-    {
-        switch (num)
-        {
-            case 0:
-                return node0;
-            case 1:
-                return node1;
-            case 2:
-                return node2;
-            default:
-                return node3;
-        }
-    }
-
-    @Override
-    public void set( int num, QTNode<V> n )
-    {
-        switch (num)
-        {
-            case 0:
-                node0 = n;
-                return;
-            case 1:
-                node1 = n;
-                return;
-            case 2:
-                node2 = n;
-                return;
-            default:
-                node3 = n;
-                return;
-        }
-    }
-
-    @Override
-    public final boolean hasData()
-    {
-        return false;
-    }
-
-    @Override
-    public String toString()
-    {
-        return "B 0:" + node0.hasData() + " 1:" + node1.hasData() + " 2:" + node2.hasData() + " 3:" + node3.hasData();
-    }
-
-    @Override
-    public long getMemoryUsageInBytes( int factor )
-    {
-        // recursivly fetch the results
-        long all = 4 * Helper.getSizeOfObjectRef(factor);
-        if (node0 != null)
-        {
-            all += node0.getMemoryUsageInBytes(factor);
-        }
-        if (node1 != null)
-        {
-            all += node1.getMemoryUsageInBytes(factor);
-        }
-        if (node2 != null)
-        {
-            all += node2.getMemoryUsageInBytes(factor);
-        }
-        if (node3 != null)
-        {
-            all += node3.getMemoryUsageInBytes(factor);
-        }
-        return all;
-    }
-
-    @Override
-    public int count()
-    {
-        int all = 0;
-        if (node0 != null)
-        {
-            all += node0.count();
-        }
-        if (node1 != null)
-        {
-            all += node1.count();
-        }
-        if (node2 != null)
-        {
-            all += node2.count();
-        }
-        if (node3 != null)
-        {
-            all += node3.count();
-        }
-        return all;
-    }
-
-    @Override
-    public long getEmptyEntries( boolean onlyBranches )
-    {
-        int all = 0;
-        if (node0 == null)
-        {
-            all++;
-        } else
-        {
-            all += node0.getEmptyEntries(onlyBranches);
-        }
-
-        if (node1 == null)
-        {
-            all++;
-        } else
-        {
-            all += node1.getEmptyEntries(onlyBranches);
-        }
-
-        if (node2 == null)
-        {
-            all++;
-        } else
-        {
-            all += node2.getEmptyEntries(onlyBranches);
-        }
-
-        if (node3 == null)
-        {
-            all++;
-        } else
-        {
-            all += node3.getEmptyEntries(onlyBranches);
-        }
-        return all;
-    }
-}
diff --git a/core/src/main/java/com/graphhopper/trees/QTDataNode.java b/core/src/main/java/com/graphhopper/trees/QTDataNode.java
deleted file mode 100644
index 90d12625e2..0000000000
--- a/core/src/main/java/com/graphhopper/trees/QTDataNode.java
+++ /dev/null
@@ -1,278 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import com.graphhopper.geohash.SpatialKeyAlgo;
-import com.graphhopper.util.Helper;
-import com.graphhopper.util.shapes.GHPoint;
-
-/**
- * @author Peter Karich
- */
-class QTDataNode<V> implements QTNode<V>
-{
-    long[] keys;
-    /**
-     * Use 'null' to mark the end of the array and to avoid an additional capacity int
-     */
-    V[] values;
-
-    @SuppressWarnings("unchecked")
-    public QTDataNode( int entries )
-    {
-        keys = new long[entries];
-        values = (V[]) new Object[entries];
-    }
-
-    @Override
-    public final boolean hasData()
-    {
-        return true;
-    }
-
-    public boolean isEmpty()
-    {
-        return values[0] == null;
-    }
-
-    public boolean isFull()
-    {
-        return count() == values.length;
-    }
-
-    public int remove( long key )
-    {
-        int removed = 0;
-        for (int i = 0; i < values.length;)
-        {
-            if (values[i] == null)
-            {
-                break;
-            }
-            if (keys[i] == key)
-            {
-                // is array copy more efficient?
-                int max = values.length - 1;
-                int j = i;
-                for (; j < max; j++)
-                {
-                    keys[j] = keys[j + 1];
-                    values[j] = values[j + 1];
-                }
-                // new end
-                values[j] = null;
-                removed++;
-            } else
-            {
-                i++;
-            }
-        }
-        return removed;
-    }
-
-    /**
-     * @return true if overflow necessary
-     */
-    public boolean add( long key, V value )
-    {
-        for (int i = 0; i < values.length; i++)
-        {
-            if (values[i] == null)
-            {
-                keys[i] = key;
-                values[i] = value;
-                i++;
-                if (i < values.length)
-                {
-                    values[i] = null;
-                }
-                return false;
-            }
-        }
-        return true;
-    }
-
-    /**
-     * @return true if data is full
-     */
-    public boolean overwriteFrom( int num, long bitPosition, QTDataNode<V> dn, long key, V value )
-    {
-        int counter = 0;
-        long nextBitPos = bitPosition >>> 1;
-        int tmp = (key & bitPosition) == 0 ? 0 : 2;
-        if ((key & nextBitPos) != 0)
-        {
-            tmp++;
-        }
-
-        if (tmp == num)
-        {
-            keys[counter] = key;
-            values[counter] = value;
-            counter++;
-        }
-        for (int i = 0; i < dn.values.length; i++)
-        {
-            if (dn.values[i] == null)
-            {
-                break;
-            }
-            tmp = (dn.keys[i] & bitPosition) == 0 ? 0 : 2;
-            if ((dn.keys[i] & nextBitPos) != 0)
-            {
-                tmp++;
-            }
-
-            if (tmp == num)
-            {
-                if (counter >= values.length)
-                {
-                    return true;
-                }
-                keys[counter] = dn.keys[i];
-                values[counter] = dn.values[i];
-                counter++;
-            }
-        }
-        // set last entry to null
-        if (counter < values.length)
-        {
-            values[counter] = null;
-        }
-        return false;
-    }
-
-    V getValue( long key )
-    {
-        for (int i = 0; i < values.length; i++)
-        {
-            if (values[i] == null)
-            {
-                return null;
-            }
-            if (keys[i] == key)
-            {
-                return (V) values[i];
-            }
-        }
-        return null;
-    }
-
-    @Override
-    public QTNode<V> get( int num )
-    {
-        throw new UnsupportedOperationException("no branch node.");
-    }
-
-    @Override
-    public void set( int num, QTNode<V> n )
-    {
-        throw new UnsupportedOperationException("no branch node.");
-    }
-
-    @Override
-    public String toString()
-    {
-        StringBuilder sb = new StringBuilder("dn:").append(count()).append(" ");
-        for (int i = 0; i < keys.length; i++)
-        {
-            if (values[i] == null)
-            {
-                break;
-            }
-
-            sb.append(values[i]).append(" ");
-        }
-        return sb.toString();
-    }
-
-    public String toString( SpatialKeyAlgo algo )
-    {
-        StringBuilder sb = new StringBuilder("dn:").append(count()).append(" ");
-        GHPoint obj = new GHPoint();
-        for (int i = 0; i < values.length; i++)
-        {
-            if (values[i] == null)
-            {
-                break;
-            }
-            algo.decode(keys[i], obj);
-            sb.append(values[i]).append(":").append(obj).append(" ");
-        }
-        return sb.toString();
-    }
-
-    @Override
-    public long getMemoryUsageInBytes( int factor )
-    {
-        return Helper.getSizeOfLongArray(keys.length, factor) + Helper.getSizeOfLongArray(values.length, factor);
-    }
-
-    @Override
-    public long getEmptyEntries( boolean onlyBranches )
-    {
-        if (onlyBranches)
-        {
-            return 0;
-        }
-
-        return values.length - count();
-    }
-
-    @Override
-    public int count()
-    {
-        int i = 0;
-        for (; i < values.length; i++)
-        {
-            if (values[i] == null)
-            {
-                return i;
-            }
-        }
-        return i;
-    }
-
-    @SuppressWarnings("unchecked")
-    void ensure( int newSize )
-    {
-        long[] tmpKeys = new long[newSize];
-        Object[] tmpValues = new Object[newSize];
-        System.arraycopy(keys, 0, tmpKeys, 0, keys.length);
-        System.arraycopy(values, 0, tmpValues, 0, values.length);
-        keys = tmpKeys;
-        values = (V[]) tmpValues;
-    }
-
-    int count( long spatialKey )
-    {
-        int counter = 0;
-        for (int i = 0; i < values.length; i++)
-        {
-            if (spatialKey == keys[i])
-            {
-                counter++;
-            }
-            if (values[i] == null)
-            {
-                break;
-            }
-        }
-        return counter;
-    }
-}
diff --git a/core/src/main/java/com/graphhopper/trees/QTNode.java b/core/src/main/java/com/graphhopper/trees/QTNode.java
deleted file mode 100644
index 933e02fa79..0000000000
--- a/core/src/main/java/com/graphhopper/trees/QTNode.java
+++ /dev/null
@@ -1,45 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-/**
- * Avoid ugly casting and use the same interface for data and branch nodes. although not really any
- * method in common
- * <p/>
- * @author Peter Karich
- */
-interface QTNode<V>
-{
-    QTNode<V> get( int num );
-
-    void set( int num, QTNode<V> n );
-
-    boolean hasData();
-
-    /**
-     * This methods returns the memory usage for PerfTest without the memory of the values. I.e. you
-     * need to add sizeOf(V)*noOfNodes
-     * <p/>
-     * @param factor is 1 for 32 bit and 2 for 64 bit systems
-     */
-    long getMemoryUsageInBytes( int factor );
-
-    int count();
-
-    long getEmptyEntries( boolean onlyBranches );
-}
diff --git a/core/src/main/java/com/graphhopper/trees/QuadTree.java b/core/src/main/java/com/graphhopper/trees/QuadTree.java
deleted file mode 100644
index 735a29874a..0000000000
--- a/core/src/main/java/com/graphhopper/trees/QuadTree.java
+++ /dev/null
@@ -1,89 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import com.graphhopper.storage.Graph;
-import com.graphhopper.util.shapes.CoordTrig;
-import com.graphhopper.util.shapes.Shape;
-import java.util.Collection;
-
-/**
- * A quad tree interface - think Map<latitude+longitude, V> with the possibility to get neighbouring
- * entries fast.
- * <p/>
- * @author Peter Karich
- */
-public interface QuadTree<V>
-{
-    /**
-     * The quadtree could be configured with implementation specific values. After this it needs to
-     * be configured.
-     * <p/>
-     * @throws RuntimeException could be thrown
-     */
-    QuadTree init( long maxItemsHint );
-
-    long getSize();
-
-    boolean isEmpty();
-
-    void add( double lat, double lon, V value );
-
-    int remove( double lat, double lon );
-
-    /**
-     * @return The nodes matching the specified latitude and longitude. If value is null all values
-     * will be returned
-     */
-    Collection<CoordTrig<V>> getNodesFromValue( double lat, double lon, V value );
-
-    /**
-     * @return points near the specified latitude/longitude
-     */
-    Collection<CoordTrig<V>> getNodes( double lat, double lon, double distanceInKm );
-
-    Collection<CoordTrig<V>> getNodes( Shape boundingBox );
-
-    void clear();
-
-    /**
-     * For debugging purposes
-     */
-    String toDetailString();
-
-    long getMemoryUsageInBytes( int factor );
-
-    /**
-     * Good for memory estimation
-     */
-    long getEmptyEntries( boolean onlyBranches );
-
-    class Util
-    {
-        public static void fill( QuadTree<Long> quadTree, Graph graph )
-        {
-            int locs = graph.getNodes();
-            for (int i = 0; i < locs; i++)
-            {
-                double lat = graph.getLatitude(i);
-                double lon = graph.getLongitude(i);
-                quadTree.add(lat, lon, 1L);
-            }
-        }
-    }
-}
diff --git a/core/src/main/java/com/graphhopper/trees/QuadTreeSimple.java b/core/src/main/java/com/graphhopper/trees/QuadTreeSimple.java
deleted file mode 100644
index 6db4012fa2..0000000000
--- a/core/src/main/java/com/graphhopper/trees/QuadTreeSimple.java
+++ /dev/null
@@ -1,498 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import com.graphhopper.geohash.SpatialKeyAlgo;
-import com.graphhopper.util.DistanceCalc;
-import com.graphhopper.util.DistanceCalcEarth;
-import com.graphhopper.util.Helper;
-import com.graphhopper.util.shapes.BBox;
-import com.graphhopper.util.shapes.Circle;
-import com.graphhopper.util.shapes.CoordTrig;
-import com.graphhopper.util.shapes.CoordTrigObjEntry;
-import com.graphhopper.util.shapes.Shape;
-import java.util.ArrayList;
-import java.util.Collection;
-import java.util.Collections;
-import java.util.List;
-import java.util.concurrent.atomic.AtomicInteger;
-
-/**
- * A simple implementation of a spatial index via a spatial key trie - the normal java way (a bit
- * memory intensive with all those object references).
- * <p/>
- * TODO depth is too large!
- * <p/>
- * The latitude and longitude is encoded via our spatial key - see SpatialKeyAlgo for more details.
- * <p/>
- * If the branch node would have only 2 children then it would be a binary tree - we would need to
- * shift only once. If the branch node would have 8 children then it would be an oct tree - shifting
- * 3 times.
- * <p/>
- * Warning: cannot store null values - an exception will be thrown.
- * <p/>
- * Duplicates allowed.
- * <p/>
- * @author Peter Karich
- */
-public class QuadTreeSimple<T> implements QuadTree<T>
-{
-    private static class Acceptor<T> implements LeafWorker<T>
-    {
-        public final List<CoordTrig<T>> result = new ArrayList<CoordTrig<T>>();
-        SpatialKeyAlgo algo;
-
-        public Acceptor( SpatialKeyAlgo algo )
-        {
-            this.algo = algo;
-        }
-
-        @Override
-        public void doWork( QTDataNode<T> dataNode, int i )
-        {
-            CoordTrigObjEntry<T> entry = new CoordTrigObjEntry<T>();
-            algo.decode(dataNode.keys[i], entry);
-            if (accept(entry))
-            {
-                entry.setValue(dataNode.values[i]);
-                result.add(entry);
-            }
-        }
-
-        public boolean accept( CoordTrig<T> entry )
-        {
-            return true;
-        }
-    }
-    private final int mbits;
-    private final long globalMaxBit;
-    private final SpatialKeyAlgo algo;
-    private final int entriesPerLeaf;
-    private DistanceCalc calc = new DistanceCalcEarth();
-    private int size;
-    private QTNode<T> root;
-
-    public QuadTreeSimple()
-    {
-        this(1, 64);
-    }
-
-    public QuadTreeSimple( int entriesPerLeafNode )
-    {
-        this(entriesPerLeafNode, 64);
-    }
-
-    public QuadTreeSimple( int entriesPerLeafNode, int bitsForLatLon )
-    {
-        mbits = bitsForLatLon;
-        entriesPerLeaf = entriesPerLeafNode;
-        globalMaxBit = 1L << (bitsForLatLon - 1);
-        algo = new SpatialKeyAlgo(bitsForLatLon);
-    }
-
-    public QuadTreeSimple setCalcDistance( DistanceCalc dist )
-    {
-        this.calc = dist;
-        return this;
-    }
-
-    @Override
-    public long getSize()
-    {
-        return size;
-    }
-
-    @Override
-    public QuadTreeSimple init( long maxItemsHint )
-    {
-        return this;
-    }
-
-    @Override
-    public void add( double lat, double lon, T value )
-    {
-        if (value == null)
-        {
-            throw new IllegalArgumentException("This quad tree does not support null values");
-        }
-
-        long spatialKey = algo.encode(lat, lon);
-        long maxBit = globalMaxBit;
-        if (root == null)
-        {
-            size++;
-            QTDataNode<T> d = new QTDataNode<T>(entriesPerLeaf);
-            d.add(spatialKey, value);
-            root = d;
-            return;
-        }
-        QTBranchNode<T> previousBranch = null;
-        int previousNum = -1;
-        QTNode<T> current = root;
-        while (maxBit != 0)
-        {
-            if (current.hasData())
-            {
-                addData(spatialKey, value, current, previousBranch, previousNum, maxBit);
-                return;
-            }
-
-            previousBranch = (QTBranchNode<T>) current;
-            // latitude
-            previousNum = (spatialKey & maxBit) == 0 ? 0 : 2;
-            maxBit >>>= 1;
-            // longitude
-            if ((spatialKey & maxBit) == 0)
-            {
-                current = previousNum == 0 ? previousBranch.node0 : previousBranch.node2;
-            } else
-            {
-                current = previousNum == 0 ? previousBranch.node1 : previousBranch.node3;
-                previousNum++;
-            }
-            maxBit >>>= 1;
-            if (current == null)
-            {
-                current = new QTDataNode<T>(entriesPerLeaf);
-                previousBranch.set(previousNum, current);
-            }
-        }
-
-        throw new UnsupportedOperationException("Cannot put element? Too many entries per area? Try increasing entries per leaf! "
-                + lat + "," + lon + " spatial key:" + spatialKey + " value:" + value + " size:" + size);
-    }
-
-    private void addData( long spatialKey, T value, QTNode<T> current, QTNode<T> previousBranch,
-            int previousNum, long maxBit )
-    {
-        size++;
-
-        QTDataNode<T> dataNode = (QTDataNode<T>) current;
-        boolean overflow = dataNode.add(spatialKey, value);
-        if (!overflow)
-        {
-            return;
-        }
-
-        QTBranchNode<T> n = new QTBranchNode<T>();
-        if (previousBranch != null)
-        {
-            previousBranch.set(previousNum, n);
-        } else
-        {
-            root = n;
-        }
-
-        int num;
-        MAIN:
-        for (; maxBit != 0; maxBit >>>= 2)
-        {
-            for (num = 0; num < 4; num++)
-            {
-                QTDataNode<T> dn = new QTDataNode<T>(entriesPerLeaf);
-                overflow = dn.overwriteFrom(num, maxBit, dataNode, spatialKey, value);
-                if (overflow)
-                {
-                    if ((maxBit & 0x3) != 0)
-                    {
-                        // if the dataNode contains duplicates or if too many nodes have a very similar position
-                        // it couldn't be splitted, so we need to increase size
-                        dn.ensure(dn.keys.length + 1);
-                        dn.add(spatialKey, value);
-                        n.set(num, dn);
-                        continue;
-                    } else
-                    {
-                        // current node would be full so divide it again
-                        QTBranchNode<T> tmp = new QTBranchNode<T>();
-                        n.set(num, tmp);
-                        n = tmp;
-                        continue MAIN;
-                    }
-                } else if (!dn.isEmpty())
-                {
-                    n.set(num, dn);
-                    continue;
-                }
-            }
-
-            return;
-        }
-
-        throw new AssertionError("Cannot happen? datanode:" + dataNode + " new entry:" + spatialKey + "->" + value);
-    }
-
-    @Override
-    public int remove( double lat, double lon )
-    {
-        if (root == null)
-        {
-            return 0;
-        }
-
-        final long spatialKey = algo.encode(lat, lon);
-        final AtomicInteger removedWrapper = new AtomicInteger(0);
-        LeafWorker<T> worker = new LeafWorker<T>()
-        {
-            @Override
-            public void doWork( QTDataNode<T> entry, int i )
-            {
-                int removed = entry.remove(spatialKey);
-                if (removed > 0)
-                {
-                    removedWrapper.addAndGet(removed);
-                    size -= removed;
-                }
-            }
-        };
-        double err = 1.0 / Math.pow(10, algo.getExactPrecision());
-        getNeighbours(BBox.createEarthMax(), new BBox(lon - err, lon + err, lat - err, lat + err), root, worker);
-        return removedWrapper.get();
-    }
-
-    @Override
-    public boolean isEmpty()
-    {
-        return size == 0;
-    }
-
-    @Override
-    public Collection<CoordTrig<T>> getNodesFromValue( final double lat, final double lon, final T value )
-    {
-        if (root == null)
-        {
-            return Collections.emptyList();
-        }
-
-        final long spatialKey = algo.encode(lat, lon);
-        final List<CoordTrig<T>> nodes = new ArrayList<CoordTrig<T>>(1);
-        LeafWorker<T> worker = new LeafWorker<T>()
-        {
-            @Override
-            public void doWork( QTDataNode<T> dataNode, int i )
-            {
-                if (value != null && !value.equals(dataNode.values[i]))
-                {
-                    return;
-                }
-
-                if (dataNode.keys[i] == spatialKey)
-                {
-                    CoordTrig<T> ret = new CoordTrigObjEntry<T>();
-                    algo.decode(dataNode.keys[i], ret);
-                    ret.setValue(dataNode.values[i]);
-                    nodes.add(ret);
-                }
-            }
-        };
-        double err = 1.0 / Math.pow(10, algo.getExactPrecision());
-        getNeighbours(BBox.createEarthMax(), new BBox(lon - err, lon + err, lat - err, lat + err), root, worker);
-        return nodes;
-    }
-
-    @Override
-    public Collection<CoordTrig<T>> getNodes( double lat, double lon, double distanceInMeter )
-    {
-        return getNodes(new Circle(lat, lon, distanceInMeter, calc));
-    }
-
-    @Override
-    public Collection<CoordTrig<T>> getNodes( final Shape boundingBox )
-    {
-        if (root == null)
-        {
-            return Collections.emptyList();
-        }
-
-        Acceptor<T> worker = new Acceptor<T>(algo)
-        {
-            @Override
-            public boolean accept( CoordTrig<T> entry )
-            {
-                return boundingBox.contains(entry.lat, entry.lon);
-            }
-        };
-        getNeighbours(BBox.createEarthMax(), boundingBox, root, worker);
-        return worker.result;
-    }
-
-    @SuppressWarnings("unchecked")
-    private void getNeighbours( BBox nodeBB, Shape searchRect, QTNode<T> current, LeafWorker<T> worker )
-    {
-        if (current.hasData())
-        {
-            QTDataNode<T> dataNode = (QTDataNode<T>) current;
-            for (int i = 0; i < dataNode.values.length; i++)
-            {
-                if (dataNode.values[i] == null)
-                {
-                    break;
-                }
-
-                worker.doWork(dataNode, i);
-            }
-            return;
-        }
-
-        double lat12 = (nodeBB.maxLat + nodeBB.minLat) / 2;
-        double lon12 = (nodeBB.minLon + nodeBB.maxLon) / 2;
-
-        // top-left - see SpatialKeyAlgo that latitude goes from bottom to top and is 1 if on top
-        // 10 11
-        // 00 01
-        QTNode<T> node10 = current.get(2);
-        if (node10 != null)
-        {
-            BBox nodeRect10 = new BBox(nodeBB.minLon, lon12, lat12, nodeBB.maxLat);
-            if (searchRect.intersect(nodeRect10))
-            {
-                getNeighbours(nodeRect10, searchRect, node10, worker);
-            }
-        }
-
-        // top-right
-        QTNode<T> node11 = current.get(3);
-        if (node11 != null)
-        {
-            BBox nodeRect11 = new BBox(lon12, nodeBB.maxLon, lat12, nodeBB.maxLat);
-            if (searchRect.intersect(nodeRect11))
-            {
-                getNeighbours(nodeRect11, searchRect, node11, worker);
-            }
-        }
-
-        // bottom-left
-        QTNode<T> node00 = current.get(0);
-        if (node00 != null)
-        {
-            BBox nodeRect00 = new BBox(nodeBB.minLon, lon12, nodeBB.minLat, lat12);
-            if (searchRect.intersect(nodeRect00))
-            {
-                getNeighbours(nodeRect00, searchRect, node00, worker);
-            }
-        }
-
-        // bottom-right
-        QTNode<T> node01 = current.get(1);
-        if (node01 != null)
-        {
-            BBox nodeRect01 = new BBox(lon12, nodeBB.maxLon, nodeBB.minLat, lat12);
-            if (searchRect.intersect(nodeRect01))
-            {
-                getNeighbours(nodeRect01, searchRect, node01, worker);
-            }
-        }
-    }
-
-    @Override
-    public void clear()
-    {
-        root = null;
-        size = 0;
-    }
-
-    @Override
-    public String toDetailString()
-    {
-        StringBuilder sb = new StringBuilder();
-        List<QTNode<T>> newList = new ArrayList<QTNode<T>>();
-        List<QTNode<T>> list = new ArrayList<QTNode<T>>();
-        list.add(root);
-        int counter = 0;
-        int level = 0;
-        while (true)
-        {
-            if (counter >= list.size())
-            {
-                if (newList.isEmpty())
-                {
-                    break;
-                }
-
-                level++;
-                sb.append(level).append("\n");
-                list.clear();
-                List<QTNode<T>> tmp = list;
-                list = newList;
-                newList = tmp;
-                counter = 0;
-            }
-
-            toDetailString(list.get(counter), sb, newList);
-            counter++;
-        }
-        sb.append("\n");
-        return sb.toString();
-    }
-
-    private void toDetailString( QTNode<T> current, StringBuilder sb, List<QTNode<T>> list )
-    {
-        if (current == null)
-        {
-            sb.append("dn:null\t");
-            return;
-        }
-
-        if (current.hasData())
-        {
-            sb.append(((QTDataNode) current).toString(algo)).append("\t");
-        } else
-        {
-            sb.append("B\t");
-            list.add(current.get(2));
-            list.add(current.get(3));
-            list.add(current.get(0));
-            list.add(current.get(1));
-        }
-    }
-
-    @Override
-    public long getMemoryUsageInBytes( int factor )
-    {
-        QTNode node = root;
-
-        // + some bytes for the deep objects
-        long offset = 3 * 4 + 8 + 3 * Helper.getSizeOfObjectRef(factor);
-        if (root != null)
-        {
-            return node.getMemoryUsageInBytes(factor) + offset;
-        }
-
-        return offset;
-    }
-
-    @Override
-    public long getEmptyEntries( boolean onlyBranches )
-    {
-        if (root != null)
-        {
-            return root.getEmptyEntries(onlyBranches);
-        }
-
-        return 0;
-    }
-
-    public int count()
-    {
-        if (root != null)
-        {
-            return root.count();
-        }
-        return 0;
-    }
-}
diff --git a/core/src/main/java/com/graphhopper/util/AngleCalc2D.java b/core/src/main/java/com/graphhopper/util/AngleCalc2D.java
new file mode 100644
index 0000000000..6777060fff
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/util/AngleCalc2D.java
@@ -0,0 +1,134 @@
+/*
+ *  Licensed to GraphHopper and Peter Karich under one or more contributor
+ *  license agreements. See the NOTICE file distributed with this work for 
+ *  additional information regarding copyright ownership.
+ * 
+ *  GraphHopper licenses this file to you under the Apache License, 
+ *  Version 2.0 (the "License"); you may not use this file except in 
+ *  compliance with the License. You may obtain a copy of the License at
+ * 
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util;
+
+/**
+ * Calculates the angle of a turn, defined by three points.
+ * <p>
+ * @author Johannes Pelzer
+ * @author Peter Karich
+ */
+public class AngleCalc2D
+{
+
+    /**
+     * Return orientation of line relative to east.
+     * <p>
+     * @return Orientation in interval -pi to +pi where 0 is east
+     * <p>
+     * @Deprecated because it seems to be nicer to align to north so try to use calcOrientationNorth
+     * instaead
+     */
+    @Deprecated
+    public double calcOrientation( double lat1, double lon1, double lat2, double lon2 )
+    {
+        return Math.atan2(lat2 - lat1, lon2 - lon1);
+        //return Math.atan2(lon2 - lon1, lat2 - lat1);
+    }
+
+    /**
+     * Return orientation of line relative to north. (North by coordinates, not magnetic north)
+     * <p>
+     * @return Orientation in interval -pi to +pi where 0 is north and pi is south
+     */
+    public double calcOrientationNorth( double lat1, double lon1, double lat2, double lon2 )
+    {
+        return Math.atan2(lon2 - lon1, lat2 - lat1);
+    }
+
+    /**
+     * Change the representation of an orientation, so the difference to the given baseOrientation
+     * will be smaller or equal to PI (180 degree). This is achieved by adding or substracting a
+     * 2*PI, so the direction of the orientation will not be changed
+     */
+    public double alignOrientation( double baseOrientation, double orientation )
+    {
+        double resultOrientation;
+        if (baseOrientation >= 0)
+        {
+            if (orientation < -Math.PI + baseOrientation)
+                resultOrientation = orientation + 2 * Math.PI;
+            else
+                resultOrientation = orientation;
+
+        } else
+        {
+            if (orientation > +Math.PI + baseOrientation)
+                resultOrientation = orientation - 2 * Math.PI;
+            else
+                resultOrientation = orientation;
+        }
+        return resultOrientation;
+    }
+
+    /**
+     * Calculate Azimuth for a line given by two coordinates. Direction in Degree where 0 is North,
+     * 90 is East, and 270 is West
+     * <p>
+     * @param lat1
+     * @param lon1
+     * @param lat2
+     * @param lon2
+     * @return
+     */
+    double calcAzimuth( double lat1, double lon1, double lat2, double lon2 )
+    {
+        double orientation = calcOrientationNorth(lat1, lon1, lat2, lon2);
+        double baseOrientation = calcOrientationNorth(2, 0, 1, 0);    // south
+        double alignedOrientation = alignOrientation(baseOrientation, orientation);
+
+        return Math.toDegrees(alignedOrientation);
+    }
+
+    String azimuth2compassPoint( double azimuth )
+    {
+
+        String cp;
+        double slice = 360.0 / 16;
+        if (azimuth < slice)
+        {
+            cp = "N";
+        } else if (azimuth < slice * 3)
+        {
+            cp = "NE";
+        } else if (azimuth < slice * 5)
+        {
+            cp = "E";
+        } else if (azimuth < slice * 7)
+        {
+            cp = "SE";
+        } else if (azimuth < slice * 9)
+        {
+            cp = "S";
+        } else if (azimuth < slice * 11)
+        {
+            cp = "SW";
+        } else if (azimuth < slice * 13)
+        {
+            cp = "W";
+        } else if (azimuth < slice * 15)
+        {
+            cp = "NW";
+        } else
+        {
+            cp = "N";
+        }
+        return cp;
+    }
+
+}
diff --git a/core/src/main/java/com/graphhopper/util/BitUtil.java b/core/src/main/java/com/graphhopper/util/BitUtil.java
index d427f2468d..2cc2bf043a 100644
--- a/core/src/main/java/com/graphhopper/util/BitUtil.java
+++ b/core/src/main/java/com/graphhopper/util/BitUtil.java
@@ -107,6 +107,13 @@ public final void fromFloat( byte[] bytes, float value, int offset )
         fromInt(bytes, Float.floatToRawIntBits(value), offset);
     }
 
+    public final short toShort( byte[] b )
+    {
+        return toShort(b, 0);
+    }
+
+    public abstract short toShort( byte[] b, int offset );
+
     public final int toInt( byte[] b )
     {
         return toInt(b, 0);
@@ -126,6 +133,20 @@ public final void fromInt( byte[] bytes, int value )
         fromInt(bytes, value, 0);
     }
 
+    public final byte[] fromShort( short value )
+    {
+        byte[] bytes = new byte[4];
+        fromShort(bytes, value, 0);
+        return bytes;
+    }
+
+    public final void fromShort( byte[] bytes, short value )
+    {
+        fromShort(bytes, value, 0);
+    }
+
+    public abstract void fromShort( byte[] bytes, short value, int offset );
+
     public abstract void fromInt( byte[] bytes, int value, int offset );
 
     public final long toLong( byte[] b )
diff --git a/core/src/main/java/com/graphhopper/util/BitUtilBig.java b/core/src/main/java/com/graphhopper/util/BitUtilBig.java
index 1c57166d31..96be62c536 100644
--- a/core/src/main/java/com/graphhopper/util/BitUtilBig.java
+++ b/core/src/main/java/com/graphhopper/util/BitUtilBig.java
@@ -28,11 +28,24 @@
     {
     }
 
+    @Override
+    public final short toShort( byte[] b, int offset )
+    {
+        return (short) ((b[offset] & 0xFF) << 8 | (b[offset + 1] & 0xFF));
+    }
+
     @Override
     public final int toInt( byte[] b, int offset )
     {
-        return (b[offset] & 0xFF) << 24 | (b[++offset] & 0xFF) << 16 | (b[++offset] & 0xFF) << 8
-                | (b[++offset] & 0xFF);
+        return (b[offset] & 0xFF) << 24 | (b[++offset] & 0xFF) << 16
+                | (b[++offset] & 0xFF) << 8 | (b[++offset] & 0xFF);
+    }
+
+    @Override
+    public void fromShort( byte[] bytes, short value, int offset )
+    {
+        bytes[offset] = (byte) (value >> 8);
+        bytes[offset + 1] = (byte) (value);
     }
 
     @Override
@@ -124,4 +137,10 @@ final long reversePart( long v, int maxBits )
         long rest = v & (~((1 << maxBits) - 1));
         return rest | reverse(v, maxBits);
     }
+
+    @Override
+    public String toString()
+    {
+        return "big";
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/BitUtilLittle.java b/core/src/main/java/com/graphhopper/util/BitUtilLittle.java
index 5d7f65cbd6..e4ac8415d9 100644
--- a/core/src/main/java/com/graphhopper/util/BitUtilLittle.java
+++ b/core/src/main/java/com/graphhopper/util/BitUtilLittle.java
@@ -28,11 +28,24 @@
     {
     }
 
+    @Override
+    public final short toShort( byte[] b, int offset )
+    {
+        return (short) ((b[offset + 1] & 0xFF) << 8 | (b[offset] & 0xFF));
+    }
+
     @Override
     public final int toInt( byte[] b, int offset )
     {
-        return (b[offset + 3] & 0xFF) << 24 | (b[offset + 2] & 0xFF) << 16 | (b[offset + 1] & 0xFF) << 8
-                | (b[offset] & 0xFF);
+        return (b[offset + 3] & 0xFF) << 24 | (b[offset + 2] & 0xFF) << 16
+                | (b[offset + 1] & 0xFF) << 8 | (b[offset] & 0xFF);
+    }
+
+    @Override
+    public void fromShort( byte[] bytes, short value, int offset )
+    {
+        bytes[offset + 1] = (byte) (value >> 8);
+        bytes[offset] = (byte) (value);
     }
 
     @Override
@@ -116,4 +129,10 @@ public String toBitString( byte[] bytes )
         }
         return sb.toString();
     }
+
+    @Override
+    public String toString()
+    {
+        return "little";
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/Constants.java b/core/src/main/java/com/graphhopper/util/Constants.java
index a3c48eec9a..ac6a723406 100644
--- a/core/src/main/java/com/graphhopper/util/Constants.java
+++ b/core/src/main/java/com/graphhopper/util/Constants.java
@@ -50,9 +50,9 @@
     public static final String OS_ARCH = System.getProperty("os.arch");
     public static final String OS_VERSION = System.getProperty("os.version");
     public static final String JAVA_VENDOR = System.getProperty("java.vendor");
-    public static final int VERSION_NODE = 2;
-    public static final int VERSION_EDGE = 4;
-    public static final int VERSION_GEOMETRY = 2;
+    public static final int VERSION_NODE = 3;
+    public static final int VERSION_EDGE = 5;
+    public static final int VERSION_GEOMETRY = 3;
     public static final int VERSION_LOCATION_IDX = 2;
     public static final int VERSION_NAME_IDX = 2;
     /**
diff --git a/core/src/main/java/com/graphhopper/util/DistanceCalcEarth.java b/core/src/main/java/com/graphhopper/util/DistanceCalcEarth.java
index 1870deea66..c2c88e9eba 100644
--- a/core/src/main/java/com/graphhopper/util/DistanceCalcEarth.java
+++ b/core/src/main/java/com/graphhopper/util/DistanceCalcEarth.java
@@ -268,10 +268,4 @@ public String toString()
     {
         return "EXACT";
     }
-
-    public static double round( double someDouble, int i )
-    {
-        double factor = Math.pow(10, i);
-        return Math.round(someDouble * factor) / factor;
-    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/DouglasPeucker.java b/core/src/main/java/com/graphhopper/util/DouglasPeucker.java
index 0804b7b26e..06759ad908 100644
--- a/core/src/main/java/com/graphhopper/util/DouglasPeucker.java
+++ b/core/src/main/java/com/graphhopper/util/DouglasPeucker.java
@@ -18,7 +18,7 @@
 package com.graphhopper.util;
 
 /**
- * Simplyfies a list of points which are not too far away.
+ * Simplyfies a list of 2D points which are not too far away.
  * http://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm
  * <p/>
  * Calling simplify is thread safe.
@@ -85,27 +85,6 @@ public int simplify( PointList points )
         return removed;
     }
 
-    /**
-     * compress list: move points into EMPTY slots
-     */
-    void compress( PointList list )
-    {
-        PointList pl = new PointList(list.getSize());
-        for (int i = 0; i < list.getSize(); i++)
-        {
-            if (Double.isNaN(list.getLatitude(i)))
-            {
-                continue;
-            }
-            pl.add(list.getLatitude(i), list.getLongitude(i));
-        }
-        list.clear();
-        for (int i = 0; i < pl.getSize(); i++)
-        {
-            list.add(pl.getLatitude(i), pl.getLongitude(i));
-        }
-    }
-
     /**
      * compress list: move points into EMPTY slots
      */
@@ -117,17 +96,16 @@ void compressNew( PointList points, int removed )
             if (Double.isNaN(points.getLatitude(currentIndex)))
             {
                 if (freeIndex < 0)
-                {
                     freeIndex = currentIndex;
-                }
+
                 continue;
             } else if (freeIndex < 0)
             {
                 continue;
             }
 
-            points.set(freeIndex, points.getLatitude(currentIndex), points.getLongitude(currentIndex));
-            points.set(currentIndex, Double.NaN, Double.NaN);
+            points.set(freeIndex, points.getLatitude(currentIndex), points.getLongitude(currentIndex), points.getElevation(currentIndex));
+            points.set(currentIndex, Double.NaN, Double.NaN, Double.NaN);
             // find next free index
             int max = currentIndex;
             int searchIndex = freeIndex + 1;
@@ -183,7 +161,7 @@ int simplify( PointList points, int fromIndex, int lastIndex )
         {
             for (int i = fromIndex + 1; i < lastIndex; i++)
             {
-                points.set(i, Double.NaN, Double.NaN);
+                points.set(i, Double.NaN, Double.NaN, Double.NaN);
                 counter++;
             }
         } else
diff --git a/core/src/main/java/com/graphhopper/util/Downloader.java b/core/src/main/java/com/graphhopper/util/Downloader.java
index 12ef79d5e0..4014857e44 100644
--- a/core/src/main/java/com/graphhopper/util/Downloader.java
+++ b/core/src/main/java/com/graphhopper/util/Downloader.java
@@ -27,13 +27,17 @@
 /**
  * @author Peter Karich
  */
-public class Downloader {
+public class Downloader
+{
 
-    public static void main(String[] args) throws IOException {
+    public static void main( String[] args ) throws IOException
+    {
         new Downloader("GraphHopper Downloader").downloadAndUnzip("http://graphhopper.com/public/maps/0.1/europe_germany_berlin.ghz", "somefolder",
-                new ProgressListener() {
+                new ProgressListener()
+                {
                     @Override
-                    public void update(long val) {
+                    public void update( long val )
+                    {
                         System.out.println("progress:" + val);
                     }
                 });
@@ -44,21 +48,25 @@ public void update(long val) {
     private int timeout = 4000;
     private int size = 1024 * 8;
 
-    public Downloader(String userAgent) {
+    public Downloader( String userAgent )
+    {
         this.userAgent = userAgent;
     }
 
-    public Downloader setTimeout(int timeout) {
+    public Downloader setTimeout( int timeout )
+    {
         this.timeout = timeout;
         return this;
     }
 
-    public Downloader setReferrer(String referrer) {
+    public Downloader setReferrer( String referrer )
+    {
         this.referrer = referrer;
         return this;
     }
 
-    public InputStream fetch(HttpURLConnection conn) throws IOException {
+    public InputStream fetch( HttpURLConnection conn ) throws IOException
+    {
         // create connection but before reading get the correct inputstream based on the compression
         conn.connect();
         String encoding = conn.getContentEncoding();
@@ -73,13 +81,16 @@ else if (encoding != null && encoding.equalsIgnoreCase("deflate"))
         return is;
     }
 
-    public InputStream fetch(String url) throws IOException {
+    public InputStream fetch( String url ) throws IOException
+    {
         return fetch((HttpURLConnection) createConnection(url));
     }
 
-    public HttpURLConnection createConnection(String urlStr) throws IOException {
+    public HttpURLConnection createConnection( String urlStr ) throws IOException
+    {
         URL url = new URL(urlStr);
         HttpURLConnection conn = (HttpURLConnection) url.openConnection();
+        // conn.setDoInput(true); // Will yield in a POST request
         conn.setDoOutput(true);
         conn.setUseCaches(true);
         conn.setRequestProperty("Referrer", referrer);
@@ -92,35 +103,64 @@ public HttpURLConnection createConnection(String urlStr) throws IOException {
         return conn;
     }
 
-    public void downloadAndUnzip(String url, String to, final ProgressListener progressListener) throws IOException {
+    public void downloadFile( String url, String toFile ) throws IOException
+    {
+        HttpURLConnection conn = createConnection(url);
+        InputStream iStream = fetch(conn);
+        BufferedOutputStream writer = new BufferedOutputStream(new FileOutputStream(toFile), size);
+        InputStream in = new BufferedInputStream(iStream, size);
+        try
+        {
+            byte[] buffer = new byte[size];
+            int numRead;
+            while ((numRead = in.read(buffer)) != -1)
+            {
+                writer.write(buffer, 0, numRead);
+            }
+        } finally
+        {
+            writer.close();
+            in.close();
+        }
+    }
+
+    public void downloadAndUnzip( String url, String toFolder, final ProgressListener progressListener ) throws IOException
+    {
         HttpURLConnection conn = createConnection(url);
         final int length = conn.getContentLength();
         InputStream iStream = fetch(conn);
 
-        new Unzipper().setSize(size).unzip(iStream, new File(to), new ProgressListener() {
+        new Unzipper().setSize(size).unzip(iStream, new File(toFolder), new ProgressListener()
+        {
             @Override
-            public void update(long sumBytes) {
+            public void update( long sumBytes )
+            {
                 progressListener.update((int) (100 * sumBytes / length));
             }
         });
     }
 
-    public String downloadAsString(String url) throws IOException {
+    public String downloadAsString( String url ) throws IOException
+    {
         return readString(fetch(url));
     }
 
-    private String readString(InputStream inputStream) throws IOException {
+    private String readString( InputStream inputStream ) throws IOException
+    {
         String encoding = "UTF-8";
         InputStream in = new BufferedInputStream(inputStream, size);
-        try {
+        try
+        {
             byte[] buffer = new byte[size];
             ByteArrayOutputStream output = new ByteArrayOutputStream();
             int numRead;
-            while ((numRead = in.read(buffer)) != -1) {
+            while ((numRead = in.read(buffer)) != -1)
+            {
                 output.write(buffer, 0, numRead);
             }
             return output.toString(encoding);
-        } finally {
+        } finally
+        {
             in.close();
         }
     }
diff --git a/core/src/main/java/com/graphhopper/util/EdgeIteratorState.java b/core/src/main/java/com/graphhopper/util/EdgeIteratorState.java
index 978ff6777b..e790ec8afb 100644
--- a/core/src/main/java/com/graphhopper/util/EdgeIteratorState.java
+++ b/core/src/main/java/com/graphhopper/util/EdgeIteratorState.java
@@ -26,20 +26,6 @@
  */
 public interface EdgeIteratorState
 {
-    /**
-     * Changes direction of this edge state. I.e. the following properties will change/'swap' so
-     * that this edge has the opposite direction: base and adjacent nodes, flags and wayGeometry.
-     * <p>
-     * The problem of this method is that we break the contract of a final state. If calling swap
-     * within a method it can cause side effects after calling this method which is very ugly.
-     * <p>
-     * Another possibility would be to create a new, independent edge state due to this method. But
-     * we already have this behaviour with graph.getEdgeProps
-     * <p>
-     * @return this edge state swapped
-     */
-    // void swap();
-
     /**
      * @return the edge id of the current edge. Do not make any assumptions about the concrete
      * values, except that for an implemention it is recommended that they'll be contiguous.
@@ -108,11 +94,17 @@
 
     /**
      * Clones this EdgeIteratorState.
+     * <p>
+     * @param reverse if true a detached edgeState with reversed properties is created where base
+     * and adjacent nodes, flags and wayGeometry are in reversed order. See #162 for more details
+     * about why we need the new reverse parameter.
      */
-    EdgeIteratorState detach();
-    
+    EdgeIteratorState detach( boolean reverse );
+
     /**
-     * Copies the specified edge into the current one.
+     * Copies the properties of this edge into the specified edge. Does not change nodes!
+     * <p>
+     * @return the specified edge e
      */
-    void copyProperties(EdgeIteratorState edge);
+    EdgeIteratorState copyPropertiesTo( EdgeIteratorState e );
 }
diff --git a/core/src/main/java/com/graphhopper/util/FinishInstruction.java b/core/src/main/java/com/graphhopper/util/FinishInstruction.java
index d1e1cc6cf9..80e573ccf8 100644
--- a/core/src/main/java/com/graphhopper/util/FinishInstruction.java
+++ b/core/src/main/java/com/graphhopper/util/FinishInstruction.java
@@ -22,14 +22,26 @@
  */
 public class FinishInstruction extends Instruction
 {
-    public FinishInstruction( final double lat, final double lon )
+    private int count = -1;
+
+    public FinishInstruction( final double lat, final double lon, final double ele )
     {
-        super(FINISH, "", 0, 0, new PointList()
-        {
-            
+        super(FINISH, "", 0, 0, new PointList(2, true)
+        {   
             {
-                add(lat, lon);
+                add(lat, lon, ele);
             }
         });
     }
+
+    void setVia( int i )
+    {
+        sign = REACHED_VIA;
+        count = i;
+    }
+
+    public int getViaPosition()
+    {
+        return count;
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/GHUtility.java b/core/src/main/java/com/graphhopper/util/GHUtility.java
index cc2d95c6d1..6af3ce37a8 100644
--- a/core/src/main/java/com/graphhopper/util/GHUtility.java
+++ b/core/src/main/java/com/graphhopper/util/GHUtility.java
@@ -45,16 +45,17 @@
         List<String> problems = new ArrayList<String>();
         int nodes = g.getNodes();
         int nodeIndex = 0;
+        NodeAccess na = g.getNodeAccess();
         try
         {
             EdgeExplorer explorer = g.createEdgeExplorer();
             for (; nodeIndex < nodes; nodeIndex++)
             {
-                double lat = g.getLatitude(nodeIndex);
+                double lat = na.getLatitude(nodeIndex);
                 if (lat > 90 || lat < -90)
                     problems.add("latitude is not within its bounds " + lat);
 
-                double lon = g.getLongitude(nodeIndex);
+                double lon = na.getLongitude(nodeIndex);
                 if (lon > 180 || lon < -180)
                     problems.add("longitude is not within its bounds " + lon);
 
@@ -114,6 +115,16 @@ public static int count( EdgeIterator iter )
         }
         return list;
     }
+    
+    public static List<Integer> getEdgeIds( EdgeIterator iter )
+    {
+        List<Integer> list = new ArrayList<Integer>();
+        while (iter.next())
+        {
+            list.add(iter.getEdge());
+        }
+        return list;
+    }
 
     public static void printEdgeInfo( final Graph g, FlagEncoder encoder )
     {
@@ -156,7 +167,8 @@ public static String getNodeInfo( LevelGraph g, int nodeId, EdgeFilter filter )
     {
         EdgeSkipExplorer ex = g.createEdgeExplorer(filter);
         EdgeSkipIterator iter = ex.setBaseNode(nodeId);
-        String str = nodeId + ":" + g.getLatitude(nodeId) + "," + g.getLongitude(nodeId) + "\n";
+        NodeAccess na = g.getNodeAccess();
+        String str = nodeId + ":" + na.getLatitude(nodeId) + "," + na.getLongitude(nodeId) + "\n";
         while (iter.next())
         {
             str += "  ->" + iter.getAdjNode() + "(" + iter.getSkippedEdge1() + "," + iter.getSkippedEdge2() + ") "
@@ -168,7 +180,8 @@ public static String getNodeInfo( LevelGraph g, int nodeId, EdgeFilter filter )
     public static String getNodeInfo( Graph g, int nodeId, EdgeFilter filter )
     {
         EdgeIterator iter = g.createEdgeExplorer(filter).setBaseNode(nodeId);
-        String str = nodeId + ":" + g.getLatitude(nodeId) + "," + g.getLongitude(nodeId) + "\n";
+        NodeAccess na = g.getNodeAccess();
+        String str = nodeId + ":" + na.getLatitude(nodeId) + "," + na.getLongitude(nodeId) + "\n";
         while (iter.next())
         {
             str += "  ->" + iter.getAdjNode() + " (" + iter.getDistance() + ") pillars:"
@@ -226,35 +239,62 @@ protected boolean goFurther( int nodeId )
         return createSortedGraph(g, sortedGraph, list);
     }
 
-    static Graph createSortedGraph( Graph g, Graph sortedGraph, final TIntList oldToNewNodeList )
+    static Graph createSortedGraph( Graph fromGraph, Graph toSortedGraph, final TIntList oldToNewNodeList )
     {
-        int len = oldToNewNodeList.size();
-        // important to avoid creating two edges for edges with both directions
-        GHBitSet bitset = new GHBitSetImpl(len);
-        EdgeExplorer explorer = g.createEdgeExplorer();
-        for (int old = 0; old < len; old++)
+        AllEdgesIterator eIter = fromGraph.getAllEdges();
+        while (eIter.next())
         {
-            int newIndex = oldToNewNodeList.get(old);
+            int base = eIter.getBaseNode();
+            int newBaseIndex = oldToNewNodeList.get(base);
+            int adj = eIter.getAdjNode();
+            int newAdjIndex = oldToNewNodeList.get(adj);
+
             // ignore empty entries
-            if (newIndex < 0)
+            if (newBaseIndex < 0 || newAdjIndex < 0)
                 continue;
 
-            bitset.add(newIndex);
-            sortedGraph.setNode(newIndex, g.getLatitude(old), g.getLongitude(old));
-            EdgeIterator eIter = explorer.setBaseNode(old);
-            while (eIter.next())
-            {
-                int newNodeIndex = oldToNewNodeList.get(eIter.getAdjNode());
-                if (newNodeIndex < 0)
-                    throw new IllegalStateException("empty entries should be connected to the others");
+            eIter.copyPropertiesTo(toSortedGraph.edge(newBaseIndex, newAdjIndex));
+        }
 
-                if (bitset.contains(newNodeIndex))
-                    continue;
+        int nodes = fromGraph.getNodes();
+        NodeAccess na = fromGraph.getNodeAccess();
+        NodeAccess sna = toSortedGraph.getNodeAccess();
+        for (int old = 0; old < nodes; old++)
+        {
+            int newIndex = oldToNewNodeList.get(old);
+            if (sna.is3D())
+                sna.setNode(newIndex, na.getLatitude(old), na.getLongitude(old), na.getElevation(old));
+            else
+                sna.setNode(newIndex, na.getLatitude(old), na.getLongitude(old));
+        }
+        return toSortedGraph;
+    }
 
-                sortedGraph.edge(newIndex, newNodeIndex).copyProperties(eIter);
-            }
+    /**
+     * @return the specified toGraph which is now filled with data from fromGraph
+     */
+    // TODO very similar to createSortedGraph -> use a 'int map(int)' interface
+    public static Graph copyTo( Graph fromGraph, Graph toGraph )
+    {
+        AllEdgesIterator eIter = fromGraph.getAllEdges();
+        while (eIter.next())
+        {
+            int base = eIter.getBaseNode();
+            int adj = eIter.getAdjNode();
+            eIter.copyPropertiesTo(toGraph.edge(base, adj));
         }
-        return sortedGraph;
+
+        NodeAccess fna = fromGraph.getNodeAccess();
+        NodeAccess tna = toGraph.getNodeAccess();
+        int nodes = fromGraph.getNodes();
+        for (int node = 0; node < nodes; node++)
+        {
+            if (tna.is3D())
+                tna.setNode(node, fna.getLatitude(node), fna.getLongitude(node), fna.getElevation(node));
+            else
+                tna.setNode(node, fna.getLatitude(node), fna.getLongitude(node));
+        }
+        return toGraph;
     }
 
     static Directory guessDirectory( GraphStorage store )
@@ -275,13 +315,12 @@ static Directory guessDirectory( GraphStorage store )
     static GraphStorage guessStorage( Graph g, Directory outdir, EncodingManager encodingManager )
     {
         GraphStorage store;
+        boolean is3D = g.getNodeAccess().is3D();
         if (g instanceof LevelGraphStorage)
-        {
-            store = new LevelGraphStorage(outdir, encodingManager);
-        } else
-        {
-            store = new GraphHopperStorage(outdir, encodingManager);
-        }
+            store = new LevelGraphStorage(outdir, encodingManager, is3D);
+        else
+            store = new GraphHopperStorage(outdir, encodingManager, is3D);
+
         return store;
     }
 
@@ -301,34 +340,6 @@ public static Graph clone( Graph g, GraphStorage outGraph )
         return g.copyTo(outGraph.create(g.getNodes()));
     }
 
-    /**
-     * @return the graph 'to'
-     */
-    // TODO very similar to createSortedGraph -> use a 'int map(int)' interface
-    public static Graph copyTo( Graph from, Graph to )
-    {
-        int len = from.getNodes();
-        // important to avoid creating two edges for edges with both directions        
-        GHBitSet bitset = new GHBitSetImpl(len);
-        EdgeExplorer explorer = from.createEdgeExplorer();
-        for (int oldNode = 0; oldNode < len; oldNode++)
-        {
-            bitset.add(oldNode);
-            to.setNode(oldNode, from.getLatitude(oldNode), from.getLongitude(oldNode));
-            EdgeIterator eIter = explorer.setBaseNode(oldNode);
-            while (eIter.next())
-            {
-                int adjacentNodeIndex = eIter.getAdjNode();
-                if (bitset.contains(adjacentNodeIndex))
-                    continue;
-
-                to.edge(oldNode, adjacentNodeIndex).setDistance(eIter.getDistance()).setFlags(eIter.getFlags()).
-                        setWayGeometry(eIter.fetchWayGeometry(0));
-            }
-        }
-        return to;
-    }
-
     public static int getToNode( Graph g, int edge, int endNode )
     {
         if (EdgeIterator.Edge.isValid(edge))
@@ -342,9 +353,9 @@ public static int getToNode( Graph g, int edge, int endNode )
     public static class DisabledEdgeIterator implements EdgeSkipIterator
     {
         @Override
-        public EdgeIterator detach()
+        public EdgeIterator detach( boolean reverse )
         {
-            return this;
+            throw new UnsupportedOperationException("Not supported. Edge is empty.");
         }
 
         @Override
@@ -456,7 +467,7 @@ public EdgeIteratorState setAdditionalField( int value )
         }
 
         @Override
-        public void copyProperties( EdgeIteratorState edge )
+        public EdgeIteratorState copyPropertiesTo( EdgeIteratorState edge )
         {
             throw new UnsupportedOperationException("Not supported. Edge is empty.");
         }
@@ -471,7 +482,7 @@ public double getWeight()
         public EdgeSkipIterState setWeight( double weight )
         {
             throw new UnsupportedOperationException("Not supported. Edge is empty.");
-        }        
+        }
     };
 
     /**
diff --git a/core/src/main/java/com/graphhopper/util/GPXEntry.java b/core/src/main/java/com/graphhopper/util/GPXEntry.java
index 31268245d5..8fcd97b5fe 100644
--- a/core/src/main/java/com/graphhopper/util/GPXEntry.java
+++ b/core/src/main/java/com/graphhopper/util/GPXEntry.java
@@ -17,7 +17,6 @@
  */
 package com.graphhopper.util;
 
-import com.graphhopper.util.shapes.CoordTrig;
 import com.graphhopper.util.shapes.GHPoint;
 
 /**
@@ -27,15 +26,15 @@
 {
     private long time;
 
-    public GPXEntry( double lat, double lon, long millis )
+    public GPXEntry( GHPoint p, long millis )
     {
-        super(lat, lon);
-        this.time = millis;
+        this(p.lat, p.lon, millis);
     }
 
-    public GPXEntry( GHPoint p, long millis )
+    public GPXEntry( double lat, double lon, long millis )
     {
-        this(p.lat, p.lon, millis);
+        super(lat, lon);
+        this.time = millis;
     }
 
     /**
diff --git a/core/src/main/java/com/graphhopper/util/Helper.java b/core/src/main/java/com/graphhopper/util/Helper.java
index 64cd8cd35f..ac9297f82f 100644
--- a/core/src/main/java/com/graphhopper/util/Helper.java
+++ b/core/src/main/java/com/graphhopper/util/Helper.java
@@ -271,9 +271,7 @@ public static String pruneFileEnd( String file )
     {
         int index = file.lastIndexOf(".");
         if (index < 0)
-        {
             return file;
-        }
         return file.substring(0, index);
     }
 
@@ -290,34 +288,29 @@ public static TIntList createTList( int... list )
     public static PointList createPointList( double... list )
     {
         if (list.length % 2 != 0)
-        {
             throw new IllegalArgumentException("list should consist of lat,lon pairs!");
-        }
-        PointList res = new PointList(list.length);
+
         int max = list.length / 2;
+        PointList res = new PointList(max, false);
         for (int i = 0; i < max; i++)
         {
-            res.add(list[2 * i], list[2 * i + 1]);
+            res.add(list[2 * i], list[2 * i + 1], Double.NaN);
         }
         return res;
     }
 
-    /**
-     * Converts a double (maximum value 10000) into an integer.
-     * <p/>
-     * @return the integer to be stored
-     */
-    public static int doubleToInt( double deg )
+    public static PointList createPointList3D( double... list )
     {
-        return (int) (deg * INT_FACTOR);
-    }
+        if (list.length % 3 != 0)
+            throw new IllegalArgumentException("list should consist of lat,lon,ele tuples!");
 
-    /**
-     * Converts back the once transformed storedInt from doubleToInt
-     */
-    public static double intToDouble( int storedInt )
-    {
-        return (double) storedInt / INT_FACTOR;
+        int max = list.length / 3;
+        PointList res = new PointList(max, true);
+        for (int i = 0; i < max; i++)
+        {
+            res.add(list[3 * i], list[3 * i + 1], list[3 * i + 2]);
+        }
+        return res;
     }
 
     /**
@@ -327,8 +320,10 @@ public static double intToDouble( int storedInt )
      * <p/>
      * @return the integer of the specified degree
      */
-    public static int degreeToInt( double deg )
+    public static final int degreeToInt( double deg )
     {
+        if (deg >= Double.MAX_VALUE)
+            return Integer.MAX_VALUE;
         return (int) (deg * DEGREE_FACTOR);
     }
 
@@ -337,14 +332,38 @@ public static int degreeToInt( double deg )
      * <p/>
      * @return the degree value of the specified integer
      */
-    public static double intToDegree( int storedInt )
+    public static final double intToDegree( int storedInt )
     {
-        // Double.longBitsToDouble();
+        if (storedInt == Integer.MAX_VALUE)
+            return Double.MAX_VALUE;
         return (double) storedInt / DEGREE_FACTOR;
     }
+
+    /**
+     * Converts elevation value (in meters) into integer for storage.
+     */
+    public static final int eleToInt( double ele )
+    {
+        if (ele >= Integer.MAX_VALUE)
+            return Integer.MAX_VALUE;
+        return (int) (ele * ELE_FACTOR);
+    }
+
+    /**
+     * Converts the integer value retrieved from storage into elevation (in meters). Do not expect
+     * more precision than meters although it currently is!
+     */
+    public static final double intToEle( int integEle )
+    {
+        if (integEle == Integer.MAX_VALUE)
+            return Double.MAX_VALUE;
+        return integEle / ELE_FACTOR;
+    }
+
     // +- 180 and +-90 => let use use 400
     private static final float DEGREE_FACTOR = Integer.MAX_VALUE / 400f;
-    private static final float INT_FACTOR = Integer.MAX_VALUE / 10000f;
+    // milli meter is a bit extreme but we have integers
+    private static final float ELE_FACTOR = 1000f;
 
     public static void cleanMappedByteBuffer( final ByteBuffer buffer )
     {
@@ -388,4 +407,12 @@ public static String firstBig( String sayText )
 
         return Character.toUpperCase(sayText.charAt(0)) + sayText.substring(1);
     }
+
+    /**
+     * This methods returns the value or min if too small or max if too big.
+     */
+    public static final double keepIn( double value, double min, double max )
+    {
+        return Math.max(min, Math.min(value, max));
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/Helper7.java b/core/src/main/java/com/graphhopper/util/Helper7.java
index ab8491e114..36a22f065b 100644
--- a/core/src/main/java/com/graphhopper/util/Helper7.java
+++ b/core/src/main/java/com/graphhopper/util/Helper7.java
@@ -21,32 +21,37 @@
 import javax.xml.stream.XMLStreamReader;
 
 /**
- * Put the usage of proprietary "sun" classes and after jdk6 classes into this
- * class. To use Helper class under Android as well.
+ * Put the usage of proprietary "sun" classes and after jdk6 classes into this class. To use Helper
+ * class under Android as well.
  * <p/>
  * @author Peter Karich
  */
-public class Helper7 {
+public class Helper7
+{
 
     /**
      * <code>true</code>, if this platform supports unmapping mmapped files.
      */
     public static final boolean UNMAP_SUPPORTED;
 
-    static {
+    static
+    {
         boolean v;
-        try {
+        try
+        {
             Class.forName("sun.misc.Cleaner");
             Class.forName("java.nio.DirectByteBuffer")
                     .getMethod("cleaner");
             v = true;
-        } catch (Exception e) {
+        } catch (Exception e)
+        {
             v = false;
         }
         UNMAP_SUPPORTED = v;
     }
 
-    public static String getBeanMemInfo() {
+    public static String getBeanMemInfo()
+    {
         java.lang.management.OperatingSystemMXBean mxbean = java.lang.management.ManagementFactory.getOperatingSystemMXBean();
         com.sun.management.OperatingSystemMXBean sunmxbean = (com.sun.management.OperatingSystemMXBean) mxbean;
         long freeMemory = sunmxbean.getFreePhysicalMemorySize();
@@ -55,12 +60,16 @@ public static String getBeanMemInfo() {
                 + ", rfree:" + Runtime.getRuntime().freeMemory() / Helper.MB;
     }
 
-    public static void close(XMLStreamReader r) {
-        try {
-            if (r != null) {
+    public static void close( XMLStreamReader r )
+    {
+        try
+        {
+            if (r != null)
+            {
                 r.close();
             }
-        } catch (XMLStreamException ex) {
+        } catch (XMLStreamException ex)
+        {
             throw new RuntimeException("Couldn't close xml reader", ex);
         }
     }
diff --git a/core/src/main/java/com/graphhopper/util/Instruction.java b/core/src/main/java/com/graphhopper/util/Instruction.java
index 4b5e1d2dbb..cd7dad4818 100644
--- a/core/src/main/java/com/graphhopper/util/Instruction.java
+++ b/core/src/main/java/com/graphhopper/util/Instruction.java
@@ -18,6 +18,7 @@
 package com.graphhopper.util;
 
 import java.util.List;
+import java.text.DecimalFormat;
 
 public class Instruction
 {
@@ -30,40 +31,41 @@
     public static final int TURN_RIGHT = 2;
     public static final int TURN_SHARP_RIGHT = 3;
     public static final int FINISH = 4;
-    private final int indication;
+    public static final int REACHED_VIA = 5;
+    protected int sign;
     private final String name;
     private double distance;
-    private long millis;
+    private long time;
     final PointList points;
     private final int pavementType;
-    private final int waytype;
+    private final int wayType;
 
     /**
      * The points, distances and times have exactly the same count. The last point of this
      * instruction is not duplicated here and should be in the next one.
      */
-    public Instruction( int indication, String name, int waytype, int pavementType, PointList pl )
+    public Instruction( int sign, String name, int wayType, int pavementType, PointList pl )
     {
-        this.indication = indication;
+        this.sign = sign;
         this.name = name;
         this.points = pl;
-        this.waytype = waytype;
+        this.wayType = wayType;
         this.pavementType = pavementType;
     }
 
-    public int getPavement()
+    public int getPavementType()
     {
         return pavementType;
     }
 
     public int getWayType()
     {
-        return waytype;
+        return wayType;
     }
 
-    public int getIndication()
+    public int getSign()
     {
-        return indication;
+        return sign;
     }
 
     /**
@@ -88,18 +90,18 @@ public double getDistance()
         return distance;
     }
 
-    public Instruction setMillis( long millis )
+    public Instruction setTime( long time )
     {
-        this.millis = millis;
+        this.time = time;
         return this;
     }
 
     /**
-     * Time in millis until no new instruction
+     * Time in time until no new instruction
      */
-    public long getMillis()
+    public long getTime()
     {
-        return millis;
+        return time;
     }
 
     /**
@@ -118,23 +120,19 @@ public long getMillis()
         return points.getLongitude(0);
     }
 
-    double getLastLat()
+    public PointList getPoints()
     {
-        return points.getLatitude(points.size() - 1);
-    }
-
-    double getLastLon()
-    {
-        return points.getLongitude(points.size() - 1);
+        return points;
     }
 
     /**
-     * This method returns a list of gpx entries where the time (in millis) is relative to the first
+     * This method returns a list of gpx entries where the time (in time) is relative to the first
      * which is 0. It does NOT contain the last point which is the first of the next instruction.
      * <p>
      * @return the time offset to add for the next instruction
      */
-    long fillGPXList( List<GPXEntry> list, long time, double nextInstrLat, double nextInstrLon )
+    long fillGPXList( List<GPXEntry> list, long time,
+            Instruction prevInstr, Instruction nextInstr, boolean firstInstr )
     {
         checkOne();
         int len = points.size();
@@ -144,16 +142,16 @@ long fillGPXList( List<GPXEntry> list, long time, double nextInstrLat, double ne
         for (int i = 0; i < len; i++)
         {
             boolean last = i + 1 == len;
-            double nextLat = last ? nextInstrLat : points.getLatitude(i + 1);
-            double nextLon = last ? nextInstrLon : points.getLongitude(i + 1);
+            double nextLat = last ? nextInstr.getFirstLat() : points.getLatitude(i + 1);
+            double nextLon = last ? nextInstr.getFirstLon() : points.getLongitude(i + 1);
 
             list.add(new GPXEntry(lat, lon, prevTime));
             // TODO in the case of elevation data the air-line distance is probably not precise enough
-            prevTime = Math.round(prevTime + millis * distanceCalc.calcDist(nextLat, nextLon, lat, lon) / distance);
+            prevTime = Math.round(prevTime + this.time * distanceCalc.calcDist(nextLat, nextLon, lat, lon) / distance);
             lat = nextLat;
             lon = nextLon;
         }
-        return time + millis;
+        return time + this.time;
     }
 
     @Override
@@ -161,17 +159,77 @@ public String toString()
     {
         StringBuilder sb = new StringBuilder();
         sb.append('(');
-        sb.append(indication);
+        sb.append(sign);
         sb.append(',');
         sb.append(name);
         sb.append(',');
         sb.append(distance);
         sb.append(',');
-        sb.append(millis);
+        sb.append(time);
         sb.append(')');
         return sb.toString();
     }
 
+    /**
+     * Return Direction/Compass point based on the first tracksegment of the instruction. If
+     * Instruction does not contain enough coordinate points, NULL will be returned.
+     * <p>
+     * @return
+     */
+    String getDirection( Instruction nextI )
+    {
+        AngleCalc2D ac = new AngleCalc2D();
+        double azimuth = calcAzimuth(nextI);
+        if (Double.isNaN(azimuth))
+            return null;
+
+        String dir = ac.azimuth2compassPoint(azimuth);
+        return dir;
+    }
+
+    /**
+     * Return Azimuth based on the first tracksegment of the instruction. If Instruction does not
+     * contain enough coordinate points, NULL will be returned.
+     * <p>
+     * @return
+     */
+    String getAzimuth( Instruction nextI )
+    {
+        double az = calcAzimuth(nextI);
+        if (Double.isNaN(az))
+            return null;
+
+        DecimalFormat angleFormatter = new DecimalFormat("#");
+        return angleFormatter.format(az);
+    }
+
+    private double calcAzimuth( Instruction nextI )
+    {
+        double nextLat;
+        double nextLon;
+
+        if (points.getSize() >= 2)
+        {
+            nextLat = points.getLatitude(1);
+            nextLon = points.getLongitude(1);
+        } else if (points.getSize() == 1 && null != nextI)
+        {
+            nextLat = nextI.points.getLatitude(0);
+            nextLon = nextI.points.getLongitude(0);
+        } else
+        {
+            return Double.NaN;
+        }
+
+        double lat = points.getLatitude(0);
+        double lon = points.getLongitude(0);
+
+        AngleCalc2D ac = new AngleCalc2D();
+
+        double azimuth = ac.calcAzimuth(lat, lon, nextLat, nextLon);
+        return azimuth;
+    }
+
     void checkOne()
     {
         if (points.size() < 1)
diff --git a/core/src/main/java/com/graphhopper/util/InstructionList.java b/core/src/main/java/com/graphhopper/util/InstructionList.java
index 9cd2806b70..5a1a93d6f1 100644
--- a/core/src/main/java/com/graphhopper/util/InstructionList.java
+++ b/core/src/main/java/com/graphhopper/util/InstructionList.java
@@ -19,11 +19,7 @@
 
 import java.text.SimpleDateFormat;
 
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.Iterator;
-import java.util.List;
-import java.util.TimeZone;
+import java.util.*;
 
 /**
  * List of instructions.
@@ -57,150 +53,116 @@ public int size()
         return instructions.size();
     }
 
-    /**
-     * @return list of indications useful to create images
-     */
-    public List<Integer> createIndications()
-    {
-        List<Integer> res = new ArrayList<Integer>(instructions.size());
-        for (Instruction instruction : instructions)
-        {
-            res.add(instruction.getIndication());
-        }
-        return res;
-    }
-
-    public List<Double> createDistances()
-    {
-        List<Double> res = new ArrayList<Double>(instructions.size());
-        for (Instruction instruction : instructions)
-        {
-            res.add(instruction.getDistance());
-        }
-        return res;
-    }
-
     public List<String> createDistances( TranslationMap.Translation tr, boolean mile )
     {
-        List<Double> distances = createDistances();
-        List<String> labels = new ArrayList<String>(distances.size());
-        for (int i = 0; i < distances.size(); i++)
+        List<String> labels = new ArrayList<String>(instructions.size());
+        for (int i = 0; i < instructions.size(); i++)
         {
-            double distInMeter = distances.get(i);
+            double distInMeter = instructions.get(i).getDistance();
             if (mile)
             {
                 // calculate miles
                 double distInMiles = distInMeter / 1000 / DistanceCalcEarth.KM_MILE;
                 if (distInMiles < 0.9)
                 {
-                    labels.add((int) DistanceCalcEarth.round(distInMiles * 5280, 1) + " " + tr.tr("ftAbbr"));
+                    labels.add((int) round(distInMiles * 5280, 1) + " " + tr.tr("ftAbbr"));
                 } else
                 {
                     if (distInMiles < 100)
-                        labels.add(DistanceCalcEarth.round(distInMiles, 2) + " " + tr.tr("miAbbr"));
+                        labels.add(round(distInMiles, 2) + " " + tr.tr("miAbbr"));
                     else
-                        labels.add((int) DistanceCalcEarth.round(distInMiles, 1) + " " + tr.tr("miAbbr"));
+                        labels.add((int) round(distInMiles, 1) + " " + tr.tr("miAbbr"));
                 }
             } else
             {
                 if (distInMeter < 950)
                 {
-                    labels.add((int) DistanceCalcEarth.round(distInMeter, 1) + " " + tr.tr("mAbbr"));
+                    labels.add((int) round(distInMeter, 1) + " " + tr.tr("mAbbr"));
                 } else
                 {
                     distInMeter /= 1000;
                     if (distInMeter < 100)
-                        labels.add(DistanceCalcEarth.round(distInMeter, 2) + " " + tr.tr("kmAbbr"));
+                        labels.add(round(distInMeter, 2) + " " + tr.tr("kmAbbr"));
                     else
-                        labels.add((int) DistanceCalcEarth.round(distInMeter, 1) + " " + tr.tr("kmAbbr"));
+                        labels.add((int) round(distInMeter, 1) + " " + tr.tr("kmAbbr"));
                 }
             }
         }
         return labels;
     }
 
-    /**
-     * @return string representations of the times until no new instruction.
-     */
-    public List<Long> createMillis()
+    public List<Map<String, Object>> createJson( TranslationMap.Translation tr )
     {
-        List<Long> res = new ArrayList<Long>(instructions.size());
+        List<Map<String, Object>> instrList = new ArrayList<Map<String, Object>>(instructions.size());
+        int pointsIndex = 0;
+        int counter = 0;
         for (Instruction instruction : instructions)
         {
-            res.add(instruction.getMillis());
-        }
-        return res;
-    }
+            Map<String, Object> instrJson = new HashMap<String, Object>();
+            instrList.add(instrJson);
 
-    /**
-     * @return the lat,lon positions at which the instructions have to be presented.
-     */
-    public List<List<Double>> createLatLngs()
-    {
-        List<List<Double>> res = new ArrayList<List<Double>>();
-        for (Instruction instruction : instructions)
-        {
-            List<Double> latLng = new ArrayList<Double>(2);
-            latLng.add(instruction.getFirstLat());
-            latLng.add(instruction.getFirstLon());
-            res.add(latLng);
+            instrJson.put("text", Helper.firstBig(getTurnDescription(instruction, tr)));
+            instrJson.put("time", instruction.getTime());
+            instrJson.put("distance", instruction.getDistance());
+            instrJson.put("sign", instruction.getSign());
+
+            int tmpIndex = pointsIndex + instruction.getPoints().size();
+            // the last instruction should not point to the next instruction
+            if (counter + 1 == instructions.size())
+                tmpIndex--;
+
+            instrJson.put("interval", Arrays.asList(pointsIndex, tmpIndex));
+            pointsIndex = tmpIndex;
+
+            counter++;
         }
-        return res;
+        return instrList;
     }
 
-    public List<String> createDescription( TranslationMap.Translation tr )
+    private String getTurnDescription( Instruction instruction, TranslationMap.Translation tr )
     {
-        String shLeftTr = tr.tr("sharp_left");
-        String shRightTr = tr.tr("sharp_right");
-        String slLeftTr = tr.tr("slight_left");
-        String slRightTr = tr.tr("slight_right");
-        String leftTr = tr.tr("left");
-        String rightTr = tr.tr("right");
-        String continueTr = tr.tr("continue");
-        List<String> res = new ArrayList<String>(instructions.size());
-        for (Instruction instruction : instructions)
+        String str;
+        String n = getWayName(instruction.getName(), instruction.getPavementType(), instruction.getWayType(), tr);
+        int indi = instruction.getSign();
+        if (indi == Instruction.FINISH)
         {
-            String str;
-            String n = getWayName(instruction.getName(), instruction.getPavement(), instruction.getWayType(), tr);
-            int indi = instruction.getIndication();
-            if (indi == Instruction.FINISH)
-            {
-                str = tr.tr("finish");
-            } else if (indi == Instruction.CONTINUE_ON_STREET)
-            {
-                str = Helper.isEmpty(n) ? continueTr : tr.tr("continue_onto", n);
-            } else
+            str = tr.tr("finish");
+        } else if (indi == Instruction.REACHED_VIA)
+        {
+            str = tr.tr("stopover", ((FinishInstruction) instruction).getViaPosition());
+        } else if (indi == Instruction.CONTINUE_ON_STREET)
+        {
+            str = Helper.isEmpty(n) ? tr.tr("continue") : tr.tr("continue_onto", n);
+        } else
+        {
+            String dir = null;
+            switch (indi)
             {
-                String dir = null;
-                switch (indi)
-                {
-                    case Instruction.TURN_SHARP_LEFT:
-                        dir = shLeftTr;
-                        break;
-                    case Instruction.TURN_LEFT:
-                        dir = leftTr;
-                        break;
-                    case Instruction.TURN_SLIGHT_LEFT:
-                        dir = slLeftTr;
-                        break;
-                    case Instruction.TURN_SLIGHT_RIGHT:
-                        dir = slRightTr;
-                        break;
-                    case Instruction.TURN_RIGHT:
-                        dir = rightTr;
-                        break;
-                    case Instruction.TURN_SHARP_RIGHT:
-                        dir = shRightTr;
-                        break;
-                }
-                if (dir == null)
-                    throw new IllegalStateException("Indication not found " + indi);
-
-                str = Helper.isEmpty(n) ? tr.tr("turn", dir) : tr.tr("turn_onto", dir, n);
+                case Instruction.TURN_SHARP_LEFT:
+                    dir = tr.tr("sharp_left");
+                    break;
+                case Instruction.TURN_LEFT:
+                    dir = tr.tr("left");
+                    break;
+                case Instruction.TURN_SLIGHT_LEFT:
+                    dir = tr.tr("slight_left");
+                    break;
+                case Instruction.TURN_SLIGHT_RIGHT:
+                    dir = tr.tr("slight_right");
+                    break;
+                case Instruction.TURN_RIGHT:
+                    dir = tr.tr("right");
+                    break;
+                case Instruction.TURN_SHARP_RIGHT:
+                    dir = tr.tr("sharp_right");
+                    break;
             }
-            res.add(Helper.firstBig(str));
+            if (dir == null)
+                throw new IllegalStateException("Indication not found " + indi);
+
+            str = Helper.isEmpty(n) ? tr.tr("turn", dir) : tr.tr("turn_onto", dir, n);
         }
-        return res;
+        return str;
     }
 
     public boolean isEmpty()
@@ -226,8 +188,9 @@ public String toString()
     }
 
     /**
-     * This method returns a list of gpx entries where the time (in millis) is relative to the first
-     * which is 0.
+     * @return This method returns a list of gpx entries where the time (in millis) is relative to
+     * the first which is 0.
+     * <p>
      */
     public List<GPXEntry> createGPXList()
     {
@@ -238,11 +201,12 @@ public String toString()
         long timeOffset = 0;
         for (int i = 0; i < size() - 1; i++)
         {
+            Instruction prevInstr = (i > 0) ? get(i - 1) : null;
+            boolean instrIsFirst = prevInstr == null;
             Instruction nextInstr = get(i + 1);
-            nextInstr.checkOne();            
+            nextInstr.checkOne();
             // current instruction does not contain last point which is equals to first point of next instruction:
-            double nextLat = nextInstr.getFirstLat(), nextLon = nextInstr.getFirstLon();            
-            timeOffset = get(i).fillGPXList(gpxList, timeOffset, nextLat, nextLon);
+            timeOffset = get(i).fillGPXList(gpxList, timeOffset, prevInstr, nextInstr, instrIsFirst);
         }
         Instruction lastI = get(size() - 1);
         if (lastI.points.size() != 1)
@@ -275,15 +239,39 @@ public String createGPX( String trackName, long startTimeMillis, String timeZone
                 + "</metadata>";
         StringBuilder track = new StringBuilder(header);
         track.append("<trk><name>").append(trackName).append("</name>");
+
         track.append("<trkseg>");
         for (GPXEntry entry : createGPXList())
         {
-            track.append("<trkpt lat='").append(entry.getLat()).append("' lon='").append(entry.getLon()).append("'>");
+            track.append("\n<trkpt lat='").append(entry.getLat()).append("' lon='").append(entry.getLon()).append("'>");
             track.append("<time>").append(tzHack(formatter.format(startTimeMillis + entry.getMillis()))).append("</time>");
             track.append("</trkpt>");
         }
         track.append("</trkseg>");
-        track.append("</trk></gpx>");
+        track.append("</trk>");
+
+        if (!isEmpty())
+        {
+            track.append("<rte>");
+            //Instruction prevI = null, middleI = null, nextI = null;
+            Instruction thisI = null, nextI;
+
+            for (Instruction i : instructions)
+            {
+                nextI = i;
+
+                if (null != thisI)
+                {
+                    createRteptBlock(track, thisI, nextI);
+                }
+                thisI = nextI;
+            }
+            createRteptBlock(track, thisI, null);
+            track.append("</rte>");
+        }
+
+        // TODO #147 use wpt for via points!
+        track.append("</gpx>");
         return track.toString().replaceAll("\\'", "\"");
     }
 
@@ -295,14 +283,76 @@ private static String tzHack( String str )
         return str.substring(0, str.length() - 2) + ":" + str.substring(str.length() - 2);
     }
 
-    public static String getWayName( String name, int pavetype, int waytype, TranslationMap.Translation tr )
+    private static final TranslationMap.Translation NO_TRANSLATE = new TranslationMap.Translation()
+    {
+
+        @Override
+        public String tr( String key, Object... params )
+        {
+            if (key.equals("turn_onto") || key.equals("turn"))
+                key = "";
+
+            for (Object p : params)
+            {
+                key += " " + p.toString();
+            }
+            return key.trim();
+        }
+
+        @Override
+        public Map<String, String> asMap()
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+
+        @Override
+        public Locale getLocale()
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+
+        @Override
+        public String getLanguage()
+        {
+            throw new UnsupportedOperationException("Not supported yet.");
+        }
+    };
+
+    private void createRteptBlock( StringBuilder output, Instruction instruction, Instruction nextI )
+    {
+        output.append("<rtept lat=\"").append(InstructionList.round(instruction.getFirstLat(), 6)).
+                append("\" lon=\"").append(InstructionList.round(instruction.getFirstLon(), 6)).append("\">");
+
+        if (!instruction.getName().isEmpty())
+            output.append("<desc>").append(getTurnDescription(instruction, NO_TRANSLATE)).append("</desc>");
+
+        output.append("<extensions>");
+
+        output.append("<distance>").append((int) instruction.getDistance()).append("</distance>");
+        output.append("<time>").append(instruction.getTime()).append("</time>");
+
+        String direction = instruction.getDirection(nextI);
+        if (null != direction)
+        {
+            output.append("<direction>").append(direction).append("</direction>");
+        }
+        String azimuth = instruction.getAzimuth(nextI);
+        if (null != azimuth)
+        {
+            output.append("<azimuth>").append(azimuth).append("</azimuth>");
+        }
+        output.append("</extensions>");
+        output.append("</rtept>");
+    }
+
+    public static String getWayName( String name, int paveType, int wayType, TranslationMap.Translation tr )
     {
         String pavementName = "";
-        if (pavetype == 1)
+        if (paveType == 1)
             pavementName = tr.tr("unpaved");
 
         String wayClass = "";
-        switch (waytype)
+        switch (wayType)
         {
             case 0:
                 wayClass = tr.tr("road");
@@ -324,7 +374,7 @@ public static String getWayName( String name, int pavetype, int waytype, Transla
             else
                 return wayClass + ", " + pavementName;
         else if (pavementName.isEmpty())
-            if (waytype == 0)
+            if (wayType == 0)
                 return name;
             else
                 return name + ", " + wayClass;
@@ -332,4 +382,25 @@ else if (pavementName.isEmpty())
             return name + ", " + pavementName;
     }
 
+    /**
+     * Round the value to the specified exponent
+     */
+    static double round( double value, int exponent )
+    {
+        double factor = Math.pow(10, exponent);
+        return Math.round(value * factor) / factor;
+    }
+
+    /**
+     * @return list of lat lon
+     */
+    List<List<Double>> createStartPoints()
+    {
+        List<List<Double>> res = new ArrayList<List<Double>>(instructions.size());
+        for (Instruction instruction : instructions)
+        {
+            res.add(Arrays.asList(instruction.getFirstLat(), instruction.getFirstLon()));
+        }
+        return res;
+    }
 }
diff --git a/core/src/main/java/com/graphhopper/util/Measurement.java b/core/src/main/java/com/graphhopper/util/Measurement.java
index 88ae7106f9..bd371c4252 100644
--- a/core/src/main/java/com/graphhopper/util/Measurement.java
+++ b/core/src/main/java/com/graphhopper/util/Measurement.java
@@ -24,6 +24,7 @@
 import com.graphhopper.storage.index.LocationIndex;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphStorage;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.shapes.BBox;
 import java.io.FileWriter;
 import java.io.IOException;
@@ -198,6 +199,7 @@ private void printTimeOfRouteQuery( final GraphHopper hopper, int count, String
 //        final AtomicLong calcDistTimeSum = new AtomicLong(0);
 //        final AtomicLong tmpDist = new AtomicLong(0);
         final Random rand = new Random(seed);
+        final NodeAccess na = g.getNodeAccess();
         MiniPerfTest miniPerf = new MiniPerfTest()
         {
             @Override
@@ -205,11 +207,23 @@ public int doCalc( boolean warmup, int run )
             {
                 int from = rand.nextInt(maxNode);
                 int to = rand.nextInt(maxNode);
-                double fromLat = g.getLatitude(from);
-                double fromLon = g.getLongitude(from);
-                double toLat = g.getLatitude(to);
-                double toLon = g.getLongitude(to);
-                GHResponse res = hopper.route(new GHRequest(fromLat, fromLon, toLat, toLon).setWeighting("fastest").setVehicle(vehicle));
+                double fromLat = na.getLatitude(from);
+                double fromLon = na.getLongitude(from);
+                double toLat = na.getLatitude(to);
+                double toLon = na.getLongitude(to);
+                GHRequest req = new GHRequest(fromLat, fromLon, toLat, toLon).
+                        setWeighting("fastest").
+                        setVehicle(vehicle);
+                GHResponse res;
+                try
+                {
+                    res = hopper.route(req);
+                } catch (Exception ex)
+                {
+                    throw new RuntimeException("Error while calculating route! "
+                            + "nodes:" + from + " -> " + to + ", request:" + req, ex);
+                }
+
                 if (res.hasErrors())
                     throw new IllegalStateException("errors should NOT happen in Measurement! " + res.getErrors());
 
diff --git a/core/src/main/java/com/graphhopper/util/PathMerger.java b/core/src/main/java/com/graphhopper/util/PathMerger.java
new file mode 100644
index 0000000000..f820c2b839
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/util/PathMerger.java
@@ -0,0 +1,145 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util;
+
+import com.graphhopper.GHResponse;
+import com.graphhopper.routing.Path;
+import java.util.List;
+
+/**
+ * This class merges a list of points into one point recognizing the specified places.
+ * <p>
+ * @author Peter Karich
+ * @author ratrun
+ */
+public class PathMerger
+{
+    boolean enableInstructions = true;
+    boolean simplifyRequest = false;
+    DouglasPeucker douglasPeucker;
+    boolean calcPoints;
+
+    public void doWork( GHResponse rsp, List<Path> paths )
+    {
+        int origPoints = 0;
+        StopWatch sw;
+        long fullMillis = 0;
+        double fullDistance = 0;
+        boolean allFound = true;
+
+        InstructionList fullInstructions = new InstructionList();
+        PointList fullPoints = PointList.EMPTY;
+        for (int pathIndex = 0; pathIndex < paths.size(); pathIndex++)
+        {
+            Path path = paths.get(pathIndex);
+            fullMillis += path.getMillis();
+            fullDistance += path.getDistance();
+            if (enableInstructions)
+            {
+                InstructionList il = path.calcInstructions();
+                sw = new StopWatch().start();
+
+                if (!il.isEmpty())
+                {
+                    if (fullPoints.isEmpty())
+                        fullPoints = createSimilarPL(il.get(0).getPoints());
+
+                    for (Instruction i : il)
+                    {
+                        if (simplifyRequest)
+                        {
+                            origPoints += i.getPoints().size();
+                            douglasPeucker.simplify(i.getPoints());
+                        }
+                        fullInstructions.add(i);
+                        fullPoints.add(i.getPoints());
+                    }
+                    sw.stop();
+
+                    // if not yet reached finish replace with 'reached via'
+                    if (pathIndex + 1 < paths.size())
+                    {
+                        FinishInstruction fi = (FinishInstruction) fullInstructions.get(fullInstructions.size() - 1);
+                        fi.setVia(pathIndex + 1);
+                    }
+                }
+
+            } else if (calcPoints)
+            {
+                PointList tmpPoints = path.calcPoints();
+                if (fullPoints.isEmpty())
+                    fullPoints = createSimilarPL(tmpPoints);
+
+                if (simplifyRequest)
+                {
+                    origPoints = tmpPoints.getSize();
+                    sw = new StopWatch().start();
+                    douglasPeucker.simplify(tmpPoints);
+                    sw.stop();
+                }
+                fullPoints.add(tmpPoints);
+            }
+
+            allFound = allFound && path.isFound();
+        }
+
+        if (!fullPoints.isEmpty())
+        {
+            String debug = rsp.getDebugInfo() + ", simplify (" + origPoints + "->" + fullPoints.getSize() + ")";
+            rsp.setDebugInfo(debug);
+        }
+
+        if (enableInstructions)
+            rsp.setInstructions(fullInstructions);
+
+        rsp.setFound(allFound).
+                setPoints(fullPoints).
+                setDistance(fullDistance).
+                setMillis(fullMillis);
+    }
+
+    PointList createSimilarPL( PointList pl )
+    {
+        return new PointList(pl.size(), pl.is3D());
+    }
+
+    public PathMerger setCalcPoints( boolean calcPoints )
+    {
+        this.calcPoints = calcPoints;
+        return this;
+    }
+
+    public PathMerger setDouglasPeucker( DouglasPeucker douglasPeucker )
+    {
+        this.douglasPeucker = douglasPeucker;
+        return this;
+    }
+
+    public PathMerger setSimplifyRequest( boolean simplifyRequest )
+    {
+        this.simplifyRequest = simplifyRequest;
+        return this;
+    }
+
+    public PathMerger setEnableInstructions( boolean enableInstructions )
+    {
+        this.enableInstructions = enableInstructions;
+        return this;
+    }
+}
diff --git a/core/src/main/java/com/graphhopper/util/PointAccess.java b/core/src/main/java/com/graphhopper/util/PointAccess.java
new file mode 100644
index 0000000000..e8a395192d
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/util/PointAccess.java
@@ -0,0 +1,73 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util;
+
+/**
+ * @author Peter Karich
+ */
+public interface PointAccess
+{
+
+    /**
+     * @return true if elevation data is stored and can be retrieved
+     */
+    boolean is3D();
+
+    /**
+     * @return 3 if elevation enabled. 2 otherwise
+     */
+    int getDimension();
+
+    /**
+     * This method ensures that the node with the specified index exists and prepares access to it.
+     * The index goes from 0 (inclusive) to graph.getNodes() (exclusive)
+     * <p>
+     * This methods sets the latitude, longitude and elevation to the specified value.
+     */
+    void setNode( int nodeId, double lat, double lon );
+
+    /**
+     * This method ensures that the node with the specified index exists and prepares access to it.
+     * The index goes from 0 (inclusive) to graph.getNodes() (exclusive)
+     * <p>
+     * This methods sets the latitude, longitude and elevation to the specified value.
+     */
+    void setNode( int nodeId, double lat, double lon, double ele );
+
+    /**
+     * @return the latitude at the specified node index
+     */
+    double getLatitude( int nodeId );
+
+    double getLat( int nodeId );
+
+    /**
+     * @return the longitude at the specified node index
+     */
+    double getLongitude( int nodeId );
+
+    double getLon( int nodeId );
+
+    /**
+     * Returns the elevation of the specified nodeId.
+     */
+    double getElevation( int nodeId );
+
+    double getEle( int nodeId );
+}
diff --git a/core/src/main/java/com/graphhopper/util/PointList.java b/core/src/main/java/com/graphhopper/util/PointList.java
index 7164f1486a..665c8b8cc3 100644
--- a/core/src/main/java/com/graphhopper/util/PointList.java
+++ b/core/src/main/java/com/graphhopper/util/PointList.java
@@ -19,6 +19,7 @@
 package com.graphhopper.util;
 
 import com.graphhopper.util.shapes.GHPoint;
+import com.graphhopper.util.shapes.GHPoint3D;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
@@ -28,35 +29,71 @@
  * <p/>
  * @author Peter Karich
  */
-public class PointList
+public class PointList implements PointAccess
 {
+    private final static DistanceCalc3D distCalc3D = new DistanceCalc3D();
+    private static String ERR_MSG = "Tried to access PointList with too big index!";
     private double[] latitudes;
     private double[] longitudes;
-    private int size = 0;
+    private double[] elevations;
+    protected int size = 0;
+    protected boolean is3D;
 
     public PointList()
     {
-        this(10);
+        this(10, false);
     }
 
-    public PointList( int cap )
+    public PointList( int cap, boolean is3D )
     {
         latitudes = new double[cap];
         longitudes = new double[cap];
+        this.is3D = is3D;
+        if (is3D)
+            elevations = new double[cap];
     }
 
-    public void set( int index, double lat, double lon )
+    @Override
+    public boolean is3D()
+    {
+        return is3D;
+    }
+
+    @Override
+    public int getDimension()
+    {
+        if (is3D)
+            return 3;
+        return 2;
+    }
+
+    @Override
+    public void setNode( int nodeId, double lat, double lon )
+    {
+        set(nodeId, lat, lon, Double.NaN);
+    }
+
+    @Override
+    public void setNode( int nodeId, double lat, double lon, double ele )
+    {
+        set(nodeId, lat, lon, ele);
+    }
+
+    public void set( int index, double lat, double lon, double ele )
     {
         if (index >= size)
             throw new ArrayIndexOutOfBoundsException("index has to be smaller than size " + size);
 
         latitudes[index] = lat;
         longitudes[index] = lon;
+        if (is3D)
+            elevations[index] = ele;
+        else if (!Double.isNaN(ele))
+            throw new IllegalStateException("This is a 2D list we cannot store elevation: " + ele);
     }
 
-    public void add( double lat, double lon )
+    private void incCap( int newSize )
     {
-        int newSize = size + 1;
         if (newSize >= latitudes.length)
         {
             int cap = (int) (newSize * 1.7);
@@ -64,10 +101,59 @@ public void add( double lat, double lon )
                 cap = 8;
             latitudes = Arrays.copyOf(latitudes, cap);
             longitudes = Arrays.copyOf(longitudes, cap);
+            if (is3D)
+                elevations = Arrays.copyOf(elevations, cap);
         }
+    }
+
+    public void add( double lat, double lon )
+    {
+        if (is3D)
+            throw new IllegalStateException("Cannot add point without elevation data in 3D mode");
+        add(lat, lon, Double.NaN);
+    }
 
+    public void add( double lat, double lon, double ele )
+    {
+        int newSize = size + 1;
+        incCap(newSize);
         latitudes[size] = lat;
         longitudes[size] = lon;
+        if (is3D)
+            elevations[size] = ele;
+        else if (!Double.isNaN(ele))
+            throw new IllegalStateException("This is a 2D list we cannot store elevation: " + ele);
+        size = newSize;
+    }
+
+    public void add( PointAccess nodeAccess, int index )
+    {
+        if (is3D)
+            add(nodeAccess.getLatitude(index), nodeAccess.getLongitude(index), nodeAccess.getElevation(index));
+        else
+            add(nodeAccess.getLatitude(index), nodeAccess.getLongitude(index));
+    }
+
+    public void add( GHPoint point )
+    {
+        if (is3D)
+            add(point.lat, point.lon, ((GHPoint3D) point).ele);
+        else
+            add(point.lat, point.lon);
+    }
+
+    public void add( PointList points )
+    {
+        int newSize = size + points.getSize();
+        incCap(newSize);
+        for (int i = 0; i < points.getSize(); i++)
+        {
+            int tmp = size + i;
+            latitudes[tmp] = points.getLatitude(i);
+            longitudes[tmp] = points.getLongitude(i);
+            if (is3D)
+                elevations[tmp] = points.getElevation(i);
+        }
         size = newSize;
     }
 
@@ -86,27 +172,56 @@ public boolean isEmpty()
         return size == 0;
     }
 
+    @Override
+    public double getLat( int index )
+    {
+        return getLatitude(index);
+    }
+
+    @Override
     public double getLatitude( int index )
     {
         if (index >= size)
-        {
-            throw new ArrayIndexOutOfBoundsException("Tried to access PointList with too big index! "
-                    + "index:" + index + ", size:" + size);
-        }
+            throw new ArrayIndexOutOfBoundsException(ERR_MSG + " index:" + index + ", size:" + size);
+
         return latitudes[index];
     }
 
+    @Override
+    public double getLon( int index )
+    {
+        return getLongitude(index);
+    }
+
+    @Override
     public double getLongitude( int index )
     {
         if (index >= size)
-            throw new ArrayIndexOutOfBoundsException("Tried to access PointList with too big index! "
-                    + "index:" + index + ", size:" + size);
+            throw new ArrayIndexOutOfBoundsException(ERR_MSG + " index:" + index + ", size:" + size);
 
         return longitudes[index];
     }
 
+    @Override
+    public double getElevation( int index )
+    {
+        if (index >= size)
+            throw new ArrayIndexOutOfBoundsException(ERR_MSG + " index:" + index + ", size:" + size);
+        if (!is3D)
+            return Double.NaN;
+
+        return elevations[index];
+    }
+
+    @Override
+    public double getEle( int index )
+    {
+        return getElevation(index);
+    }
+
     public void reverse()
     {
+        // in-place reverse
         int max = size / 2;
         for (int i = 0; i < max; i++)
         {
@@ -119,6 +234,13 @@ public void reverse()
             tmp = longitudes[i];
             longitudes[i] = longitudes[swapIndex];
             longitudes[swapIndex] = tmp;
+
+            if (is3D)
+            {
+                tmp = elevations[i];
+                elevations[i] = elevations[swapIndex];
+                elevations[swapIndex] = tmp;
+            }
         }
     }
 
@@ -148,23 +270,34 @@ public String toString()
             sb.append(latitudes[i]);
             sb.append(',');
             sb.append(longitudes[i]);
+            if (is3D)
+            {
+                sb.append(',');
+                sb.append(elevations[i]);
+            }
             sb.append(')');
         }
         return sb.toString();
     }
 
     /**
-     * Attention: geoJson is LON,LAT
+     * Attention: geoJson is LON,LAT or LON,LAT,ELE
      */
     public List<Double[]> toGeoJson()
     {
         ArrayList<Double[]> points = new ArrayList<Double[]>(size);
         for (int i = 0; i < size; i++)
         {
-            points.add(new Double[]
-            {
-                getLongitude(i), getLatitude(i)
-            });
+            if (is3D)
+                points.add(new Double[]
+                {
+                    getLongitude(i), getLatitude(i), getElevation(i)
+                });
+            else
+                points.add(new Double[]
+                {
+                    getLongitude(i), getLatitude(i)
+                });
         }
         return points;
     }
@@ -175,8 +308,11 @@ public boolean equals( Object obj )
         if (obj == null)
             return false;
 
-        final PointList other = (PointList) obj;
-        if (this.size != other.size)
+        PointList other = (PointList) obj;
+        if (other.isEmpty() && other.isEmpty())
+            return true;
+
+        if (this.getSize() != other.getSize() || this.is3D() != other.is3D())
             return false;
 
         for (int i = 0; i < size; i++)
@@ -186,17 +322,26 @@ public boolean equals( Object obj )
 
             if (!NumHelper.equalsEps(longitudes[i], other.longitudes[i]))
                 return false;
+
+            if (is3D && !NumHelper.equalsEps(elevations[i], other.elevations[i]))
+                return false;
         }
         return true;
     }
 
     public PointList clone( boolean reverse )
     {
-        PointList clonePL = new PointList(size);
-        for (int i = 0; i < size; i++)
-        {
-            clonePL.add(latitudes[i], longitudes[i]);
-        }
+        PointList clonePL = new PointList(size, is3D);
+        if (is3D)
+            for (int i = 0; i < size; i++)
+            {
+                clonePL.add(latitudes[i], longitudes[i], elevations[i]);
+            }
+        else
+            for (int i = 0; i < size; i++)
+            {
+                clonePL.add(latitudes[i], longitudes[i]);
+            }
         if (reverse)
             clonePL.reverse();
         return clonePL;
@@ -209,11 +354,18 @@ public PointList copy( int from, int end )
         if (from < 0 || end > size)
             throw new IllegalArgumentException("Illegal interval: " + from + ", " + end + ", size:" + size);
 
-        PointList copyPL = new PointList(size);
-        for (int i = from; i < end; i++)
-        {
-            copyPL.add(latitudes[i], longitudes[i]);
-        }
+        PointList copyPL = new PointList(size, is3D);
+        if (is3D)
+            for (int i = from; i < end; i++)
+            {
+                copyPL.add(latitudes[i], longitudes[i], elevations[i]);
+            }
+        else
+            for (int i = from; i < end; i++)
+            {
+                copyPL.add(latitudes[i], longitudes[i], Double.NaN);
+            }
+
         return copyPL;
     }
 
@@ -232,16 +384,24 @@ public int hashCode()
 
     public double calcDistance( DistanceCalc calc )
     {
-        double lat = -1;
-        double lon = -1;
+        double prevLat = Double.NaN;
+        double prevLon = Double.NaN;
+        double prevEle = Double.NaN;
         double dist = 0;
         for (int i = 0; i < size; i++)
         {
             if (i > 0)
-                dist += calc.calcDist(lat, lon, latitudes[i], longitudes[i]);
-
-            lat = latitudes[i];
-            lon = longitudes[i];
+            {
+                if (is3D)
+                    dist += distCalc3D.calcDist(prevLat, prevLon, prevEle, latitudes[i], longitudes[i], elevations[i]);
+                else
+                    dist += calc.calcDist(prevLat, prevLon, latitudes[i], longitudes[i]);
+            }
+
+            prevLat = latitudes[i];
+            prevLon = longitudes[i];
+            if (is3D)
+                prevEle = elevations[i];
         }
         return dist;
     }
@@ -250,7 +410,7 @@ public double calcDistance( DistanceCalc calc )
      * Takes the string from a json array ala [lon1,lat1], [lon2,lat2], ... and fills the list from
      * it.
      */
-    public void parseJSON( String str )
+    public void parse2DJSON( String str )
     {
         for (String latlon : str.split("\\["))
         {
@@ -259,19 +419,25 @@ public void parseJSON( String str )
 
             String ll[] = latlon.split(",");
             String lat = ll[1].replace("]", "").trim();
-            add(Double.parseDouble(lat), Double.parseDouble(ll[0].trim()));
+            add(Double.parseDouble(lat), Double.parseDouble(ll[0].trim()), Double.NaN);
         }
     }
-    public static final PointList EMPTY = new PointList(0)
+
+    public GHPoint3D toGHPoint( int index )
+    {
+        return new GHPoint3D(getLatitude(index), getLongitude(index), getElevation(index));
+    }
+
+    public static PointList EMPTY = new PointList(0, true)
     {
         @Override
-        public void set( int index, double lat, double lon )
+        public void set( int index, double lat, double lon, double ele )
         {
             throw new RuntimeException("cannot change EMPTY PointList");
         }
 
         @Override
-        public void add( double lat, double lon )
+        public void add( double lat, double lon, double ele )
         {
             throw new RuntimeException("cannot change EMPTY PointList");
         }
@@ -288,6 +454,12 @@ public double getLongitude( int index )
             throw new RuntimeException("cannot access EMPTY PointList");
         }
 
+        @Override
+        public boolean isEmpty()
+        {
+            return true;
+        }
+
         @Override
         public void clear()
         {
@@ -301,7 +473,7 @@ public void trimToSize( int newSize )
         }
 
         @Override
-        public void parseJSON( String str )
+        public void parse2DJSON( String str )
         {
             throw new RuntimeException("cannot change EMPTY PointList");
         }
@@ -309,7 +481,7 @@ public void parseJSON( String str )
         @Override
         public double calcDistance( DistanceCalc calc )
         {
-            return 0;
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
         }
 
         @Override
@@ -321,12 +493,72 @@ public PointList copy( int from, int end )
         @Override
         public PointList clone( boolean reverse )
         {
-            return this;
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public double getElevation( int index )
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public double getLat( int index )
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public double getLon( int index )
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public double getEle( int index )
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public List<Double[]> toGeoJson()
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public void reverse()
+        {
+            throw new UnsupportedOperationException("cannot change EMPTY PointList");
+        }
+
+        @Override
+        public int getSize()
+        {
+            return 0;
+        }
+
+        @Override
+        public int size()
+        {
+            return 0;
+        }
+
+        @Override
+        public GHPoint3D toGHPoint( int index )
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
+        }
+
+        @Override
+        public boolean is3D()
+        {
+            throw new UnsupportedOperationException("cannot access EMPTY PointList");
         }
     };
 
-    public GHPoint toGHPoint( int index )
+    int getCapacity()
     {
-        return new GHPoint(getLatitude(index), getLongitude(index));
+        return latitudes.length;
     }
 }
diff --git a/core/src/main/java/com/graphhopper/util/QueryTorture.java b/core/src/main/java/com/graphhopper/util/QueryTorture.java
index c2a81464d2..cc2761c388 100644
--- a/core/src/main/java/com/graphhopper/util/QueryTorture.java
+++ b/core/src/main/java/com/graphhopper/util/QueryTorture.java
@@ -70,8 +70,8 @@ public void start( CmdArgs read )
 
         if (baseUrl.endsWith("/"))
             baseUrl = baseUrl.substring(0, baseUrl.length() - 1);
-        if (!baseUrl.endsWith("/api/route"))
-            baseUrl += "/api/route";
+        if (!baseUrl.endsWith("/route"))
+            baseUrl += "/route";
         if (!baseUrl.endsWith("?"))
             baseUrl += "?";
 
diff --git a/core/src/main/java/com/graphhopper/util/StopWatch.java b/core/src/main/java/com/graphhopper/util/StopWatch.java
index 9a64df4379..dbe55ede43 100644
--- a/core/src/main/java/com/graphhopper/util/StopWatch.java
+++ b/core/src/main/java/com/graphhopper/util/StopWatch.java
@@ -24,6 +24,7 @@
  */
 public class StopWatch
 {
+
     private long lastTime;
     private long nanoTime;
     private String name = "";
diff --git a/core/src/main/java/com/graphhopper/util/shapes/BBox.java b/core/src/main/java/com/graphhopper/util/shapes/BBox.java
index 4d89ddc155..2ac7c8a57c 100644
--- a/core/src/main/java/com/graphhopper/util/shapes/BBox.java
+++ b/core/src/main/java/com/graphhopper/util/shapes/BBox.java
@@ -44,51 +44,71 @@
         INVERSE.maxLon = -Double.MAX_VALUE;
         INVERSE.minLat = Double.MAX_VALUE;
         INVERSE.maxLat = -Double.MAX_VALUE;
+        INVERSE.minEle = Double.MAX_VALUE;
+        INVERSE.maxEle = -Double.MAX_VALUE;
     }
-    // longitude (theta) = x, latitude (phi) = y
+    // longitude (theta) = x, latitude (phi) = y, elevation = z
     public double minLon;
     public double maxLon;
     public double minLat;
     public double maxLat;
+    public double minEle;
+    public double maxEle;
+    private final boolean is3D;
 
     private BBox()
     {
+        this.is3D = false;
+    }
+
+    private BBox( boolean is3D )
+    {
+        this.is3D = is3D;
     }
 
     public BBox( double minLon, double maxLon, double minLat, double maxLat )
     {
+        this(minLon, maxLon, minLat, maxLat, Double.NaN, Double.NaN, false);
+    }
+
+    public BBox( double minLon, double maxLon, double minLat, double maxLat, double minEle, double maxEle )
+    {
+        this(minLon, maxLon, minLat, maxLat, minEle, maxEle, true);
+    }
+
+    public BBox( double minLon, double maxLon, double minLat, double maxLat, double minEle, double maxEle, boolean is3D )
+    {
+        this.is3D = is3D;
         this.maxLat = maxLat;
         this.minLon = minLon;
         this.minLat = minLat;
         this.maxLon = maxLon;
+        this.minEle = minEle;
+        this.maxEle = maxEle;
     }
 
     public boolean check()
     {
-        // "second longitude should be bigger than the first";
+        // second longitude should be bigger than the first
         if (minLon >= maxLon)
-        {
             return false;
-        }
 
-        //"second latitude should be smaller than the first";
+        // second latitude should be smaller than the first
         if (minLat >= maxLat)
-        {
             return false;
-        }
-        return true;
 
-    }
+        // second elevation should be smaller than the first
+        if (is3D && minEle >= maxEle)
+            return false;
+
+        return true;
 
-    public static BBox createEarthMax()
-    {
-        return new BBox(-180.0, 180.0, -90.0, 90.0);
     }
 
     @Override
     public BBox clone()
     {
-        return new BBox(minLon, maxLon, minLat, maxLat);
+        return new BBox(minLon, maxLon, minLat, maxLat, minEle, maxEle, is3D);
     }
 
     @Override
@@ -150,7 +170,11 @@ public boolean contains( Circle c )
     @Override
     public String toString()
     {
-        return minLon + "," + maxLon + "," + minLat + "," + maxLat;
+        String str = minLon + "," + maxLon + "," + minLat + "," + maxLat;
+        if (is3D)
+            str += "," + minEle + "," + maxEle;
+
+        return str;
     }
 
     public String toLessPrecisionString()
@@ -196,15 +220,23 @@ public boolean isValid()
     }
 
     /**
-     * @return array containing this bounding box. Attention: GeoJson is lon,lat!
+     * @return array containing this bounding box. Attention: GeoJson is lon,lat! If 3D is gets even
+     * worse: lon,lat,ele
      */
     public List<Double> toGeoJson()
     {
         List<Double> list = new ArrayList<Double>(4);
         list.add(minLon);
         list.add(minLat);
+        // hmh
+        if (is3D)
+            list.add(minEle);
+
         list.add(maxLon);
         list.add(maxLat);
+        if (is3D)
+            list.add(maxEle);
+
         return list;
     }
 }
diff --git a/core/src/main/java/com/graphhopper/util/shapes/CoordFloat.java b/core/src/main/java/com/graphhopper/util/shapes/CoordFloat.java
index b33603bc3a..967334e4b7 100644
--- a/core/src/main/java/com/graphhopper/util/shapes/CoordFloat.java
+++ b/core/src/main/java/com/graphhopper/util/shapes/CoordFloat.java
@@ -18,34 +18,39 @@
 package com.graphhopper.util.shapes;
 
 /**
- * Single precision coordinates without an associated value. To add one -
- * subclass.
+ * Single precision coordinates without an associated value. To add one - subclass.
  * <p/>
  * @author Peter Karich
  */
-public class CoordFloat<T> {
+public class CoordFloat<T>
+{
 
     public float lat;
     public float lon;
 
-    public CoordFloat() {
+    public CoordFloat()
+    {
     }
 
-    public CoordFloat(float lat, float lon) {
+    public CoordFloat( float lat, float lon )
+    {
         this.lat = lat;
         this.lon = lon;
     }
 
-    public void setValue(T t) {
+    public void setValue( T t )
+    {
         throw new UnsupportedOperationException("Use CoordTrigObjEntry for value access");
     }
 
-    public T getValue() {
+    public T getValue()
+    {
         throw new UnsupportedOperationException("Use CoordTrigObjEntry for value access");
     }
 
     @Override
-    public String toString() {
+    public String toString()
+    {
         return lat + "," + lon;
     }
 }
diff --git a/core/src/main/java/com/graphhopper/util/shapes/GHPoint3D.java b/core/src/main/java/com/graphhopper/util/shapes/GHPoint3D.java
new file mode 100644
index 0000000000..77071ae7e5
--- /dev/null
+++ b/core/src/main/java/com/graphhopper/util/shapes/GHPoint3D.java
@@ -0,0 +1,39 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util.shapes;
+
+/**
+ * @author Peter Karich
+ */
+public class GHPoint3D extends GHPoint
+{
+
+    public double ele;
+
+    public GHPoint3D( double lat, double lon, double elevation )
+    {
+        super(lat, lon);
+        this.ele = elevation;
+    }
+
+    public double getEle()
+    {
+        return ele;
+    }
+}
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/Africa_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/Africa_names.txt.zip
new file mode 100644
index 0000000000..968a5c0c88
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/Africa_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/Australia_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/Australia_names.txt.zip
new file mode 100644
index 0000000000..8b0b0b3ab5
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/Australia_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/Eurasia_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/Eurasia_names.txt.zip
new file mode 100644
index 0000000000..0fefc171d4
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/Eurasia_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/Islands_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/Islands_names.txt.zip
new file mode 100644
index 0000000000..8a8aa9c177
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/Islands_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/North_America_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/North_America_names.txt.zip
new file mode 100644
index 0000000000..de10d69e00
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/North_America_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/reader/dem/South_America_names.txt.zip b/core/src/main/resources/com/graphhopper/reader/dem/South_America_names.txt.zip
new file mode 100644
index 0000000000..d1db72dc34
Binary files /dev/null and b/core/src/main/resources/com/graphhopper/reader/dem/South_America_names.txt.zip differ
diff --git a/core/src/main/resources/com/graphhopper/util/bg.txt b/core/src/main/resources/com/graphhopper/util/bg.txt
index 303332d6a1..3dfae328cf 100644
--- a/core/src/main/resources/com/graphhopper/util/bg.txt
+++ b/core/src/main/resources/com/graphhopper/util/bg.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/de_DE.txt b/core/src/main/resources/com/graphhopper/util/de_DE.txt
index 23cc4a344f..55ad00c1b6 100644
--- a/core/src/main/resources/com/graphhopper/util/de_DE.txt
+++ b/core/src/main/resources/com/graphhopper/util/de_DE.txt
@@ -34,3 +34,4 @@ cycleway=Radweg
 way=Weg
 paved=befestigt
 unpaved=unbefestigt
+stopover=Zwischenziel %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/en_US.txt b/core/src/main/resources/com/graphhopper/util/en_US.txt
index 5c8035891f..82fa88d8e2 100644
--- a/core/src/main/resources/com/graphhopper/util/en_US.txt
+++ b/core/src/main/resources/com/graphhopper/util/en_US.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
diff --git a/core/src/main/resources/com/graphhopper/util/es.txt b/core/src/main/resources/com/graphhopper/util/es.txt
index dcfa1d101c..4b4a9f2ff8 100644
--- a/core/src/main/resources/com/graphhopper/util/es.txt
+++ b/core/src/main/resources/com/graphhopper/util/es.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/fr.txt b/core/src/main/resources/com/graphhopper/util/fr.txt
index 9d69f55191..485c00ef4e 100644
--- a/core/src/main/resources/com/graphhopper/util/fr.txt
+++ b/core/src/main/resources/com/graphhopper/util/fr.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/ja.txt b/core/src/main/resources/com/graphhopper/util/ja.txt
index 40e4636e27..334b1ba456 100644
--- a/core/src/main/resources/com/graphhopper/util/ja.txt
+++ b/core/src/main/resources/com/graphhopper/util/ja.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/pt_BR.txt b/core/src/main/resources/com/graphhopper/util/pt_BR.txt
index 7d17fa458b..2af1a46611 100644
--- a/core/src/main/resources/com/graphhopper/util/pt_BR.txt
+++ b/core/src/main/resources/com/graphhopper/util/pt_BR.txt
@@ -34,3 +34,4 @@ cycleway=ciclovia
 way=caminho
 paved=asfaltado
 unpaved=no asfaltado
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/pt_PT.txt b/core/src/main/resources/com/graphhopper/util/pt_PT.txt
index 9863488fd1..8da488ae40 100644
--- a/core/src/main/resources/com/graphhopper/util/pt_PT.txt
+++ b/core/src/main/resources/com/graphhopper/util/pt_PT.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/ro.txt b/core/src/main/resources/com/graphhopper/util/ro.txt
index 1028d36d25..c8d6d9a6fa 100644
--- a/core/src/main/resources/com/graphhopper/util/ro.txt
+++ b/core/src/main/resources/com/graphhopper/util/ro.txt
@@ -34,3 +34,4 @@ cycleway=cycleway
 way=way
 paved=paved
 unpaved=unpaved
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/ru.txt b/core/src/main/resources/com/graphhopper/util/ru.txt
index d611fae831..1c757fe0fe 100644
--- a/core/src/main/resources/com/graphhopper/util/ru.txt
+++ b/core/src/main/resources/com/graphhopper/util/ru.txt
@@ -28,3 +28,4 @@ kmAbbr=km
 mAbbr=m
 miAbbr=mi
 ftAbbr=ft
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/si.txt b/core/src/main/resources/com/graphhopper/util/si.txt
index c3e75c3f27..09a2d8d13e 100644
--- a/core/src/main/resources/com/graphhopper/util/si.txt
+++ b/core/src/main/resources/com/graphhopper/util/si.txt
@@ -28,3 +28,4 @@ kmAbbr=km
 mAbbr=m
 miAbbr=mi
 ftAbbr=ft
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/main/resources/com/graphhopper/util/tr.txt b/core/src/main/resources/com/graphhopper/util/tr.txt
index fce2e33322..7b339cad12 100644
--- a/core/src/main/resources/com/graphhopper/util/tr.txt
+++ b/core/src/main/resources/com/graphhopper/util/tr.txt
@@ -28,3 +28,4 @@ kmAbbr=km
 mAbbr=m
 miAbbr=mi
 ftAbbr=ft
+stopover=stopover %1$s
\ No newline at end of file
diff --git a/core/src/test/java/com/graphhopper/GHRequestTest.java b/core/src/test/java/com/graphhopper/GHRequestTest.java
new file mode 100644
index 0000000000..bc3399867a
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/GHRequestTest.java
@@ -0,0 +1,44 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper;
+
+import org.junit.Test;
+import static org.junit.Assert.*;
+
+/**
+ *
+ * @author Peter Karich
+ */
+public class GHRequestTest
+{
+    @Test
+    public void testGetHint()
+    {
+        GHRequest instance = new GHRequest(10, 12, 12, 10);
+        instance.putHint("something", 1);
+        assertEquals(1, (Number) instance.getHint("something", 2));
+        // #173 - will throw an error: Integer cannot be cast to Double
+        assertEquals(1, instance.getHint("something", 2d), 1e1);
+        
+        instance = new GHRequest(10, 12, 12, 10);
+        instance.putHint("something", 1d);
+        assertEquals(1d, (Number) instance.getHint("something", 2));
+        assertEquals(1d, (Number) instance.getHint("something", 2d));
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/GraphHopperAPITest.java b/core/src/test/java/com/graphhopper/GraphHopperAPITest.java
index 1a2fe1e1c5..ef40eb1ef1 100644
--- a/core/src/test/java/com/graphhopper/GraphHopperAPITest.java
+++ b/core/src/test/java/com/graphhopper/GraphHopperAPITest.java
@@ -20,6 +20,7 @@
 import com.graphhopper.routing.util.EncodingManager;
 import com.graphhopper.storage.GraphStorage;
 import com.graphhopper.storage.GraphBuilder;
+import com.graphhopper.storage.NodeAccess;
 import org.junit.Test;
 import static org.junit.Assert.*;
 
@@ -35,11 +36,12 @@
     public void testLoad()
     {
         GraphStorage graph = new GraphBuilder(encodingManager).create();
-        graph.setNode(0, 42, 10);
-        graph.setNode(1, 42.1, 10.1);
-        graph.setNode(2, 42.1, 10.2);
-        graph.setNode(3, 42, 10.4);
-        graph.setNode(4, 41.9, 10.2);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 42, 10);
+        na.setNode(1, 42.1, 10.1);
+        na.setNode(2, 42.1, 10.2);
+        na.setNode(3, 42, 10.4);
+        na.setNode(4, 41.9, 10.2);
 
         graph.edge(0, 1, 10, true);
         graph.edge(1, 2, 10, false);
@@ -47,7 +49,11 @@ public void testLoad()
         graph.edge(0, 4, 40, true);
         graph.edge(4, 3, 40, true);
 
-        GraphHopperAPI instance = new GraphHopper().setEncodingManager(encodingManager).disableCHShortcuts().loadGraph(graph);
+        GraphHopper instance = new GraphHopper().
+                setInMemory(false).
+                setEncodingManager(encodingManager).
+                disableCHShortcuts().
+                loadGraph(graph);
         GHResponse ph = instance.route(new GHRequest(42, 10.4, 42, 10));
         assertTrue(ph.isFound());
         assertEquals(80, ph.getDistance(), 1e-6);
@@ -56,13 +62,40 @@ public void testLoad()
         assertEquals(41.9, ph.getPoints().getLatitude(1), 1e-5);
         assertEquals(10.2, ph.getPoints().getLongitude(1), 1e-5);
         assertEquals(3, ph.getPoints().getSize());
+        instance.close();
     }
 
     @Test
-    public void testNoLoad()
+    public void testDisconnected179()
     {
+        GraphStorage graph = new GraphBuilder(encodingManager).create();
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 42, 10);
+        na.setNode(1, 42.1, 10.1);
+        na.setNode(2, 42.1, 10.2);
+        na.setNode(3, 42, 10.4);
+
+        graph.edge(0, 1, 10, true);
+        graph.edge(2, 3, 10, true);
+        
+        GraphHopper instance = new GraphHopper().
+                setInMemory(false).
+                setEncodingManager(encodingManager).
+                disableCHShortcuts().
+                loadGraph(graph);
+        GHResponse ph = instance.route(new GHRequest(42, 10, 42, 10.4));
+        assertFalse(ph.isFound());
+        assertEquals(0, ph.getPoints().getSize());        
+        instance.close();
+    }
 
-        GraphHopperAPI instance = new GraphHopper().setEncodingManager(encodingManager).disableCHShortcuts();
+    @Test
+    public void testNoLoad()
+    {
+        GraphHopper instance = new GraphHopper().
+                setInMemory(false).
+                setEncodingManager(encodingManager).
+                disableCHShortcuts();
         try
         {
             instance.route(new GHRequest(42, 10.4, 42, 10));
@@ -81,6 +114,5 @@ public void testNoLoad()
         {
             assertTrue(ex.getMessage(), ex.getMessage().startsWith("Call load or importOrLoad before routing"));
         }
-
     }
 }
diff --git a/core/src/test/java/com/graphhopper/GraphHopperTest.java b/core/src/test/java/com/graphhopper/GraphHopperTest.java
index 9f22b1531c..652968b48d 100644
--- a/core/src/test/java/com/graphhopper/GraphHopperTest.java
+++ b/core/src/test/java/com/graphhopper/GraphHopperTest.java
@@ -20,6 +20,8 @@
 import com.graphhopper.routing.util.EncodingManager;
 import com.graphhopper.util.CmdArgs;
 import com.graphhopper.util.Helper;
+import com.graphhopper.util.Instruction;
+import com.graphhopper.util.shapes.GHPlace;
 import com.graphhopper.util.shapes.GHPoint;
 import java.io.File;
 import java.io.IOException;
@@ -75,7 +77,8 @@ public void testLoadOSM()
     @Test
     public void testPrepare()
     {
-        instance = new GraphHopper().setInMemory(false).
+        instance = new GraphHopper().
+                setInMemory(false).
                 setEncodingManager(new EncodingManager("CAR")).
                 setCHShortcuts("shortest").
                 setGraphHopperLocation(ghLoc).
@@ -141,12 +144,12 @@ public void testFootAndCar()
         // A to E only for foot
         res = instance.route(new GHRequest(11.1, 50, 10, 51).setVehicle(EncodingManager.FOOT));
         assertTrue(res.isFound());
-        assertEquals(2, res.getPoints().getSize());
+        assertEquals(3, res.getPoints().size());
 
         // A D E for car
         res = instance.route(new GHRequest(11.1, 50, 10, 51).setVehicle(EncodingManager.CAR));
         assertTrue(res.isFound());
-        assertEquals(3, res.getPoints().getSize());
+        assertEquals(4, res.getPoints().getSize());
     }
 
     @Test
@@ -154,6 +157,7 @@ public void testFailsForWrongConfig() throws IOException
     {
         instance = new GraphHopper().init(
                 new CmdArgs().
+                put("osmreader.dataaccess", "RAM").
                 put("osmreader.acceptWay", "FOOT,CAR").
                 put("prepare.chShortcuts", "no").
                 put("osmreader.osm", testOsm3)).
@@ -164,9 +168,11 @@ public void testFailsForWrongConfig() throws IOException
 
         instance = new GraphHopper().init(
                 new CmdArgs().
+                put("osmreader.dataaccess", "RAM").
                 put("osmreader.acceptWay", "FOOT").
                 put("prepare.chShortcuts", "no").
-                put("osmreader.osm", testOsm3)).setOSMFile(testOsm3);
+                put("osmreader.osm", testOsm3)).
+                setOSMFile(testOsm3);
         try
         {
             instance.load(ghLoc);
@@ -178,9 +184,11 @@ public void testFailsForWrongConfig() throws IOException
         // different order should be ok
         instance = new GraphHopper().init(
                 new CmdArgs().
+                put("osmreader.dataaccess", "RAM").
                 put("osmreader.acceptWay", "CAR,FOOT").
                 put("prepare.chShortcuts", "no").
-                put("osmreader.osm", testOsm3)).setOSMFile(testOsm3);
+                put("osmreader.osm", testOsm3)).
+                setOSMFile(testOsm3);
         assertTrue(instance.load(ghLoc));
         assertEquals(5, instance.getGraph().getNodes());
     }
@@ -208,7 +216,7 @@ public void testFailsForMissingParameters() throws IOException
         instance = new GraphHopper();
         try
         {
-            instance.setOSMFile(testOsm).importOSM();
+            instance.setOSMFile(testOsm).importData();
             assertTrue(false);
         } catch (IllegalStateException ex)
         {
@@ -226,8 +234,9 @@ public void testFailsForMissingParameters() throws IOException
             assertEquals("graphHopperLocation is not specified. call init before", ex.getMessage());
         }
 
-        // missing encoding manager
-        instance = new GraphHopper().setInMemory(true).
+        // missing OSM file to import
+        instance = new GraphHopper().
+                setInMemory(true).
                 setGraphHopperLocation(ghLoc);
         try
         {
@@ -235,7 +244,35 @@ public void testFailsForMissingParameters() throws IOException
             assertTrue(false);
         } catch (IllegalStateException ex)
         {
-            assertEquals("Couldn't load from existing folder: " + ghLoc 
+            assertEquals("Couldn't load from existing folder: " + ghLoc
+                    + " but also cannot import from OSM file as it wasn't specified!", ex.getMessage());
+        }
+
+        // missing encoding manager          
+        instance = new GraphHopper().
+                setInMemory(true).
+                setGraphHopperLocation(ghLoc).
+                setOSMFile(testOsm3);
+        try
+        {
+            instance.importOrLoad();
+            assertTrue(false);
+        } catch (IllegalStateException ex)
+        {
+            assertEquals("Missing encoding manager", ex.getMessage());
+        }
+
+        // Import is possible even if no storeOnFlush but missing OSM file
+        instance = new GraphHopper().
+                setInMemory(false).
+                setGraphHopperLocation(ghLoc);
+        try
+        {
+            instance.importOrLoad();
+            assertTrue(false);
+        } catch (Exception ex)
+        {
+            assertEquals("Couldn't load from existing folder: " + ghLoc
                     + " but also cannot import from OSM file as it wasn't specified!", ex.getMessage());
         }
     }
@@ -293,4 +330,35 @@ public void testPrepareOnly()
                 setOSMFile(testOsm3);
         instance.load(ghLoc);
     }
+
+    @Test
+    public void testVia()
+    {
+        instance = new GraphHopper().setInMemory(true).
+                setEncodingManager(new EncodingManager("CAR")).
+                setGraphHopperLocation(ghLoc).
+                setOSMFile(testOsm3);
+        instance.importOrLoad();
+
+        // A -> B -> C
+        GHPlace first = new GHPlace(11.1, 50);
+        GHPlace second = new GHPlace(12, 51);
+        GHPlace third = new GHPlace(11.2, 51.9);
+        GHResponse rsp12 = instance.route(new GHRequest().addPlace(first).addPlace(second));
+        assertTrue("should find 1->2", rsp12.isFound());
+        assertEquals(147931.5, rsp12.getDistance(), .1);
+        GHResponse rsp23 = instance.route(new GHRequest().addPlace(second).addPlace(third));
+        assertTrue("should find 2->3", rsp23.isFound());
+        assertEquals(176608.9, rsp23.getDistance(), .1);
+
+        GHResponse rsp = instance.route(new GHRequest().
+                addPlace(first).addPlace(second).addPlace(third));
+
+        assertFalse(rsp.hasErrors());
+        assertTrue("should find 1->2->3", rsp.isFound());
+        assertEquals(rsp12.getDistance() + rsp23.getDistance(), rsp.getDistance(), 1e-6);
+        assertEquals(5, rsp.getPoints().getSize());
+        assertEquals(5, rsp.getInstructions().size());
+        assertEquals(Instruction.REACHED_VIA, rsp.getInstructions().get(1).getSign());
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/coll/AbstractBinHeapTest.java b/core/src/test/java/com/graphhopper/coll/AbstractBinHeapTest.java
index be1c661a03..803d4d751d 100644
--- a/core/src/test/java/com/graphhopper/coll/AbstractBinHeapTest.java
+++ b/core/src/test/java/com/graphhopper/coll/AbstractBinHeapTest.java
@@ -139,7 +139,7 @@ public void testSize()
 
         for (int i = 0; i < N; i++)
         {
-            assertEquals(juQueue.poll().endNode, binHeap.pollElement(), 1e-5);
+            assertEquals(juQueue.poll().adjNode, binHeap.pollElement(), 1e-5);
         }
 
         assertEquals(binHeap.getSize(), 0);
diff --git a/core/src/test/java/com/graphhopper/coll/OSMIDSegmentedMapTest.java b/core/src/test/java/com/graphhopper/coll/OSMIDSegmentedMapTest.java
index 4bd696e0af..cdb07c9544 100644
--- a/core/src/test/java/com/graphhopper/coll/OSMIDSegmentedMapTest.java
+++ b/core/src/test/java/com/graphhopper/coll/OSMIDSegmentedMapTest.java
@@ -26,6 +26,7 @@
  */
 public class OSMIDSegmentedMapTest
 {
+
     @Test
     public void testZeroKey()
     {
diff --git a/core/src/test/java/com/graphhopper/reader/OSMElementTest.java b/core/src/test/java/com/graphhopper/reader/OSMElementTest.java
index 489554650b..ec6753870c 100644
--- a/core/src/test/java/com/graphhopper/reader/OSMElementTest.java
+++ b/core/src/test/java/com/graphhopper/reader/OSMElementTest.java
@@ -17,6 +17,8 @@
  */
 package com.graphhopper.reader;
 
+import java.util.HashMap;
+import java.util.Map;
 import org.junit.Test;
 import static org.junit.Assert.*;
 
@@ -34,4 +36,17 @@ public void testHasTag()
         assertTrue(instance.hasTag("surface", "now", "something"));
         assertFalse(instance.hasTag("surface", "now", "not"));
     }
+
+    @Test
+    public void testSetTags()
+    {
+        OSMElement instance = new OSMWay(1);
+        Map<String, String> map = new HashMap<String, String>();
+        map.put("test", "xy");
+        instance.setTags(map);
+        assertTrue(instance.hasTag("test", "xy"));
+
+        instance.setTags(null);
+        assertFalse(instance.hasTag("test", "xy"));
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/reader/OSMNodeTest.java b/core/src/test/java/com/graphhopper/reader/OSMNodeTest.java
new file mode 100644
index 0000000000..ff3610c9ae
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/reader/OSMNodeTest.java
@@ -0,0 +1,54 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader;
+
+import org.junit.Test;
+import static org.junit.Assert.*;
+
+/**
+ *
+ * @author Peter Karich
+ */
+public class OSMNodeTest
+{
+    @Test
+    public void testSetTags()
+    {
+        OSMNode instance = new OSMNode(0, 10, 10);
+        assertTrue(Double.isNaN(instance.getEle()));
+
+        instance.setTag("ele", "-10.1");
+        assertEquals(-10.1, instance.getEle(), 1e-1);
+
+        // oh OSM
+        instance.setTag("ele", "-10,1");
+        assertEquals(-10.1, instance.getEle(), 1e-1);
+        // do not parse other stuff
+        instance.setTag("ele", "-9.1 m.");
+        assertEquals(-10.1, instance.getEle(), 1e-1);
+
+        // empty values
+        instance.setTag("ele", "");
+        assertTrue(Double.isNaN(instance.getEle()));
+        instance.setTag("ele", "-10.1");
+        assertEquals(-10.1, instance.getEle(), 1e-1);
+        instance.setTag("ele", null);
+        assertTrue(Double.isNaN(instance.getEle()));
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/reader/OSMReaderTest.java b/core/src/test/java/com/graphhopper/reader/OSMReaderTest.java
index 2dc760a498..137a9f41b7 100644
--- a/core/src/test/java/com/graphhopper/reader/OSMReaderTest.java
+++ b/core/src/test/java/com/graphhopper/reader/OSMReaderTest.java
@@ -17,10 +17,7 @@
  */
 package com.graphhopper.reader;
 
-import static org.junit.Assert.assertEquals;
-import static org.junit.Assert.assertFalse;
-import static org.junit.Assert.assertNotEquals;
-import static org.junit.Assert.assertTrue;
+import static org.junit.Assert.*;
 import gnu.trove.list.TLongList;
 
 import java.io.File;
@@ -38,12 +35,15 @@
 import org.junit.Test;
 
 import com.graphhopper.GraphHopper;
+import com.graphhopper.reader.dem.ElevationProvider;
+import com.graphhopper.reader.dem.SRTMProvider;
 import com.graphhopper.routing.util.*;
 import com.graphhopper.storage.AbstractGraphStorageTester;
 import com.graphhopper.storage.ExtendedStorage;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphHopperStorage;
 import com.graphhopper.storage.GraphStorage;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.RAMDirectory;
 import com.graphhopper.storage.TurnCostStorage;
 import com.graphhopper.util.EdgeExplorer;
@@ -71,7 +71,6 @@
     private CarFlagEncoder carEncoder;
     private FootFlagEncoder footEncoder;
     private EdgeExplorer carOutExplorer;
-    private EdgeExplorer carInExplorer;
     private EdgeExplorer carAllExplorer;
 
     @Before
@@ -86,16 +85,17 @@ public void tearDown()
         Helper.removeDir(new File(dir));
     }
 
-    GraphStorage buildGraph( String directory, EncodingManager encodingManager, boolean turnRestrictionsImport )
+    GraphStorage newGraph( String directory, EncodingManager encodingManager, boolean is3D, boolean turnRestrictionsImport )
     {
-        return new GraphHopperStorage(new RAMDirectory(directory, false), encodingManager, 
-                (turnRestrictionsImport) ? new TurnCostStorage() : new ExtendedStorage.NoExtendedStorage());
+        return new GraphHopperStorage(new RAMDirectory(directory, false), encodingManager,
+                is3D, turnRestrictionsImport ? new TurnCostStorage() : new ExtendedStorage.NoExtendedStorage());
     }
 
     class GraphHopperTest extends GraphHopper
     {
         public GraphHopperTest( String osmFile )
         {
+            setInMemory(false);
             setOSMFile(osmFile);
             setGraphHopperLocation(dir);
             setEncodingManager(new EncodingManager("CAR,FOOT"));
@@ -105,27 +105,28 @@ public GraphHopperTest( String osmFile )
             footEncoder = (FootFlagEncoder) getEncodingManager().getEncoder("FOOT");
         }
 
-        OSMReader createReader( GraphStorage tmpGraph )
+        @Override
+        protected DataReader createReader( GraphStorage tmpGraph )
         {
-            return new OSMReader(tmpGraph, 1000);
+            return initOSMReader(new OSMReader(tmpGraph));
         }
 
         @Override
-        protected OSMReader importOSM() throws IOException
+        protected DataReader importData() throws IOException
         {
-            GraphStorage tmpGraph = buildGraph(dir, getEncodingManager(), isEnableTurnRestrictions());
+            GraphStorage tmpGraph = newGraph(dir, getEncodingManager(), is3D(), isEnableTurnRestrictions());
             setGraph(tmpGraph);
-            OSMReader osmReader = createReader(tmpGraph);
-            osmReader.setEncodingManager(getEncodingManager());
+
+            DataReader osmReader = createReader(tmpGraph);
             try
             {
-                osmReader.doOSM2Graph(new File(getClass().getResource(getOSMFile()).toURI()));
+                ((OSMReader) osmReader).setOSMFile(new File(getClass().getResource(getOSMFile()).toURI()));
             } catch (URISyntaxException e)
             {
                 throw new RuntimeException(e);
             }
+            osmReader.readGraph();
             carOutExplorer = getGraph().createEdgeExplorer(new DefaultEdgeFilter(carEncoder, false, true));
-            carInExplorer = getGraph().createEdgeExplorer(new DefaultEdgeFilter(carEncoder, true, false));
             carAllExplorer = getGraph().createEdgeExplorer(new DefaultEdgeFilter(carEncoder, true, true));
             return osmReader;
         }
@@ -140,7 +141,11 @@ InputStream getResource( String file )
     public void testMain()
     {
         GraphHopper hopper = new GraphHopperTest(file1).importOrLoad();
-        Graph graph = hopper.getGraph();
+        GraphStorage graph = (GraphStorage) hopper.getGraph();
+
+        assertNotNull(graph.getProperties().get("osmreader.import.date"));
+        assertNotEquals("", graph.getProperties().get("osmreader.import.date"));
+
         assertEquals(4, graph.getNodes());
         int n20 = AbstractGraphStorageTester.getIdOf(graph, 52);
         int n10 = AbstractGraphStorageTester.getIdOf(graph, 51.2492152);
@@ -180,12 +185,13 @@ public void testMain()
         assertEquals(n20, iter.getAdjNode());
         assertEquals(93146.888, iter.getDistance(), 1);
 
-        assertEquals(9.4, graph.getLongitude(hopper.getLocationIndex().findID(51.2, 9.4)), 1e-3);
-        assertEquals(10, graph.getLongitude(hopper.getLocationIndex().findID(49, 10)), 1e-3);
-        assertEquals(51.249, graph.getLatitude(hopper.getLocationIndex().findID(51.2492152, 9.4317166)), 1e-3);
+        NodeAccess na = graph.getNodeAccess();
+        assertEquals(9.4, na.getLongitude(hopper.getLocationIndex().findID(51.2, 9.4)), 1e-3);
+        assertEquals(10, na.getLongitude(hopper.getLocationIndex().findID(49, 10)), 1e-3);
+        assertEquals(51.249, na.getLatitude(hopper.getLocationIndex().findID(51.2492152, 9.4317166)), 1e-3);
 
         // node 40 is on the way between 30 and 50 => 9.0
-        assertEquals(9, graph.getLongitude(hopper.getLocationIndex().findID(51.25, 9.43)), 1e-3);
+        assertEquals(9, na.getLongitude(hopper.getLocationIndex().findID(51.25, 9.43)), 1e-3);
     }
 
     @Test
@@ -193,8 +199,9 @@ public void testSort()
     {
         GraphHopper hopper = new GraphHopperTest(file1).setSortGraph(true).importOrLoad();
         Graph graph = hopper.getGraph();
-        assertEquals(10, graph.getLongitude(hopper.getLocationIndex().findID(49, 10)), 1e-3);
-        assertEquals(51.249, graph.getLatitude(hopper.getLocationIndex().findID(51.2492152, 9.4317166)), 1e-3);
+        NodeAccess na = graph.getNodeAccess();
+        assertEquals(10, na.getLongitude(hopper.getLocationIndex().findID(49, 10)), 1e-3);
+        assertEquals(51.249, na.getLatitude(hopper.getLocationIndex().findID(51.2492152, 9.4317166)), 1e-3);
     }
 
     @Test
@@ -203,16 +210,16 @@ public void testWithBounds()
         GraphHopper hopper = new GraphHopperTest(file1)
         {
             @Override
-            OSMReader createReader( GraphStorage tmpGraph )
+            protected DataReader createReader( GraphStorage tmpGraph )
             {
-                return new OSMReader(tmpGraph, 1000)
+                return new OSMReader(tmpGraph)
                 {
                     @Override
                     public boolean isInBounds( OSMNode node )
                     {
                         return node.getLat() > 49 && node.getLon() > 8;
                     }
-                };
+                }.setEncodingManager(getEncodingManager());
             }
         };
 
@@ -319,11 +326,11 @@ public void cleanUp()
         iter.next();
         assertEquals(5, carEncoder.getSpeed(iter.getFlags()), 1e-1);
 
-        // more precise speed calculation! ~150km (from 54.0,10.1 to 55.0,10.1) in duration=70 minutes -> wow ;)
-        // => 130km/h => / 1.4 => 92km/h        
+        // duration 01:10 is given => more precise speed calculation! 
+        // ~111km (from 54.0,10.1 to 55.0,10.2) in duration=70 minutes => 95km/h => / 1.4 => 71km/h        
         iter = carOutExplorer.setBaseNode(n40);
         iter.next();
-        assertEquals(100, carEncoder.getSpeed(iter.getFlags()), 1e-1);
+        assertEquals(70, carEncoder.getSpeed(iter.getFlags()), 1e-1);
     }
 
     @Test
@@ -420,8 +427,9 @@ public void testBarriers()
         // separate id
         int new20 = 4;
         assertNotEquals(n20, new20);
-        assertEquals(graph.getLatitude(n20), graph.getLatitude(new20), 1e-5);
-        assertEquals(graph.getLongitude(n20), graph.getLongitude(new20), 1e-5);
+        NodeAccess na = graph.getNodeAccess();
+        assertEquals(na.getLatitude(n20), na.getLatitude(new20), 1e-5);
+        assertEquals(na.getLongitude(n20), na.getLongitude(new20), 1e-5);
 
         assertEquals(n20, hopper.getLocationIndex().findID(52, 9.4));
 
@@ -465,8 +473,9 @@ public void testBarriersOnTowerNodes()
     public void testRelation()
     {
         EncodingManager manager = new EncodingManager("bike");
-        OSMReader reader = new OSMReader(new GraphHopperStorage(new RAMDirectory(), manager), -1).setEncodingManager(manager);
-        OSMRelation osmRel = new OSMRelation(1, new HashMap<String, String>());
+        OSMReader reader = new OSMReader(new GraphHopperStorage(new RAMDirectory(), manager, false)).
+                setEncodingManager(manager);
+        OSMRelation osmRel = new OSMRelation(1);
         osmRel.getMembers().add(new OSMRelation.Member(OSMRelation.WAY, 1, ""));
         osmRel.getMembers().add(new OSMRelation.Member(OSMRelation.WAY, 2, ""));
 
@@ -549,13 +558,6 @@ private int getEdge( int from, int to )
         return EdgeIterator.NO_EDGE;
     }
 
-    @Test
-    public void testFixWayName()
-    {
-        assertEquals("B8, B12", OSMReader.fixWayName("B8;B12"));
-        assertEquals("B8, B12", OSMReader.fixWayName("B8; B12"));
-    }
-
     @Test
     public void testEstimatedCenter()
     {
@@ -572,7 +574,7 @@ public int defineNodeBits( int index, int shift )
             }
 
             @Override
-            public long analyzeNodeTags( OSMNode node )
+            public long handleNodeTags( OSMNode node )
             {
                 if (node.hasTag("test", "now"))
                     return -objectEncoder.setValue(0, 1);
@@ -589,8 +591,8 @@ public long applyNodeFlags( long wayFlags, long nodeFlags )
                 return setSpeed(0, speed);
             }
         };
-        EncodingManager manager = new EncodingManager(encoder);        
-        GraphStorage graph = buildGraph(dir, manager, false);
+        EncodingManager manager = new EncodingManager(encoder);
+        GraphStorage graph = newGraph(dir, manager, false, false);
         final Map<Integer, Double> latMap = new HashMap<Integer, Double>();
         final Map<Integer, Double> lonMap = new HashMap<Integer, Double>();
         latMap.put(1, 1.1d);
@@ -599,7 +601,7 @@ public long applyNodeFlags( long wayFlags, long nodeFlags )
         lonMap.put(1, 1.0d);
         lonMap.put(2, 1.0d);
         final AtomicInteger increased = new AtomicInteger(0);
-        OSMReader osmreader = new OSMReader(graph, 1000)
+        OSMReader osmreader = new OSMReader(graph)
         {
             // mock data access
             @Override
@@ -625,10 +627,9 @@ public long applyNodeFlags( long wayFlags, long nodeFlags )
         };
         osmreader.setEncodingManager(manager);
         // save some node tags for first node
-        Map<String, String> nodeMap = new HashMap<String, String>();
-        OSMNode osmNode = new OSMNode(1, nodeMap, 1.1d, 1.0d);
+        OSMNode osmNode = new OSMNode(1, 1.1d, 1.0d);
         osmNode.setTag("test", "now");
-        osmreader.getNodeFlagsMap().put(1, encoder.analyzeNodeTags(osmNode));
+        osmreader.getNodeFlagsMap().put(1, encoder.handleNodeTags(osmNode));
 
         OSMWay way = new OSMWay(1L);
         way.getNodes().add(1);
@@ -638,11 +639,63 @@ public long applyNodeFlags( long wayFlags, long nodeFlags )
         osmreader.getNodeMap().put(2, 2);
         osmreader.processWay(way);
 
-        GHPoint p = way.getInternalTag("estimated_center", null);
+        GHPoint p = way.getTag("estimated_center", null);
         assertEquals(1.15, p.lat, 1e-3);
         assertEquals(1.0, p.lon, 1e-3);
-        Double d = way.getInternalTag("estimated_distance", null);
+        Double d = way.getTag("estimated_distance", null);
         assertEquals(11119.5, d, 1e-1);
         assertEquals(1, increased.get());
     }
+
+    @Test
+    public void testReadEleFromCustomOSM()
+    {
+        GraphHopper hopper = new GraphHopperTest("custom-osm-ele.xml")
+        {
+            @Override
+            protected DataReader createReader( GraphStorage tmpGraph )
+            {
+                return initOSMReader(new OSMReader(tmpGraph)
+                {
+                    @Override
+                    protected double getElevation( OSMNode node )
+                    {
+                        return node.getEle();
+                    }
+                });
+            }
+        }.set3D(true).importOrLoad();
+
+        Graph graph = hopper.getGraph();
+        int n20 = AbstractGraphStorageTester.getIdOf(graph, 52);
+        int n50 = AbstractGraphStorageTester.getIdOf(graph, 49);
+
+        EdgeIteratorState edge = GHUtility.getEdge(graph, n20, n50);
+        assertEquals(Helper.createPointList3D(52, 9, -10, 51.25, 9.43, 100, 49, 10, -30), edge.fetchWayGeometry(3));
+    }
+
+    @Test
+    public void testReadEleFromDataProvider()
+    {
+        GraphHopper hopper = new GraphHopperTest("test-osm5.xml");
+        // get N10E046.hgt.zip
+        ElevationProvider provider = new SRTMProvider();
+        provider.setCacheDir(new File("./files"));
+        hopper.set3D(true).
+                setElevationProvider(provider);
+        hopper.importOrLoad();
+
+        Graph graph = hopper.getGraph();
+        int n10 = AbstractGraphStorageTester.getIdOf(graph, 49.501);
+        int n30 = AbstractGraphStorageTester.getIdOf(graph, 49.5011);
+        int n50 = AbstractGraphStorageTester.getIdOf(graph, 49.5001);
+
+        EdgeIteratorState edge = GHUtility.getEdge(graph, n50, n30);
+        assertEquals(Helper.createPointList3D(49.5001, 11.501, 441, 49.5002, 11.5015, 441, 49.5011, 11.502, 415.0),
+                edge.fetchWayGeometry(3));
+
+        edge = GHUtility.getEdge(graph, n10, n50);
+        assertEquals(Helper.createPointList3D(49.501, 11.5001, 399.0, 49.5001, 11.501, 441.0),
+                edge.fetchWayGeometry(3));
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/reader/dem/SRTMProviderTest.java b/core/src/test/java/com/graphhopper/reader/dem/SRTMProviderTest.java
new file mode 100644
index 0000000000..f640c8280f
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/reader/dem/SRTMProviderTest.java
@@ -0,0 +1,100 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.reader.dem;
+
+import java.io.File;
+import java.io.IOException;
+import org.junit.After;
+import org.junit.Test;
+import static org.junit.Assert.*;
+import org.junit.Before;
+
+/**
+ *
+ * @author Peter Karich
+ */
+public class SRTMProviderTest
+{
+    SRTMProvider instance;
+
+    @Before
+    public void setUp()
+    {
+        instance = new SRTMProvider();
+    }
+
+    @After
+    public void tearDown()
+    {
+        instance.release();
+    }
+
+    @Test
+    public void testGetFileString()
+    {
+        assertEquals("Eurasia/N49E011", instance.getFileString(49, 11));
+        assertEquals("Eurasia/N52W002", instance.getFileString(52.268157, -1.230469));
+        assertEquals("Africa/S06E034", instance.getFileString(-5.965754, 34.804687));
+        assertEquals("Australia/S29E131", instance.getFileString(-28.304381, 131.484375));
+        assertEquals("South_America/S09W045", instance.getFileString(-9, -45));
+        assertEquals("South_America/S10W046", instance.getFileString(-9.1, -45.1));
+        assertEquals("South_America/S10W045", instance.getFileString(-9.6, -45));
+        assertEquals("South_America/S28W071", instance.getFileString(-28, -71));
+        assertEquals("South_America/S29W072", instance.getFileString(-28.88316, -71.070557));
+    }
+
+    @Test
+    public void testGetHeight() throws IOException
+    {
+        instance.setCacheDir(new File("./files/"));
+        // easy to verify orientation of tile:
+//        instance.getEle(43, 13);
+
+        // siegesturm
+        assertEquals(466, instance.getEle(49.969331, 11.574783), 1e-1);
+        // am main
+        assertEquals(330, instance.getEle(49.958233, 11.558647), 1e-1);
+        // south america
+        assertEquals(1691, instance.getEle(-28.88316, -71.070557), 1e-1);
+        assertEquals(0, instance.getEle(-28.671311, -71.38916), 1e-1);
+
+        // montevideo
+        // assertEquals(45, instance.getEle(-34.906205,-56.189575), 1e-1);
+        // new york
+        // assertEquals(21, instance.getEle(40.730348,-73.985882), 1e-1);
+        // use 0 elevation if area not found
+        assertEquals(0, instance.getEle(55.4711873, 19.2501641), 1e-1);
+
+        assertEquals(160, instance.getEle(55.8943144, -3), 1e-1);
+        // precision = 1e6 => -3
+        // assertEquals(160, instance.getEle(55.8943144, -3.0000004), 1e-1);
+        // precision = 1e7 => -4
+        assertEquals(154, instance.getEle(55.8943144, -3.0000004), 1e-1);
+
+        assertEquals(160, instance.getEle(55.8943144, -3.0000001), 1e-1);
+    }
+
+    @Test
+    public void testGetHeightMMap() throws IOException
+    {
+        instance.setCacheDir(new File("./files/"));
+        instance.setInMemory(false);
+        assertEquals(160, instance.getEle(55.8943144, -3), 1e-1);
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/routing/AbstractRoutingAlgorithmTester.java b/core/src/test/java/com/graphhopper/routing/AbstractRoutingAlgorithmTester.java
index f3bd4fee7d..a62fcaa609 100644
--- a/core/src/test/java/com/graphhopper/routing/AbstractRoutingAlgorithmTester.java
+++ b/core/src/test/java/com/graphhopper/routing/AbstractRoutingAlgorithmTester.java
@@ -37,13 +37,18 @@
 {
     // problem is: matrix graph is expensive to create to cache it in a static variable
     private static Graph matrixGraph;
-    protected static EncodingManager encodingManager = new EncodingManager("CAR,FOOT");
+    protected static final EncodingManager encodingManager = new EncodingManager("CAR,FOOT");
     protected FlagEncoder carEncoder = (CarFlagEncoder) encodingManager.getEncoder("CAR");
     protected FlagEncoder footEncoder = (FootFlagEncoder) encodingManager.getEncoder("FOOT");
 
-    protected Graph createGraph()
+    protected Graph createGraph( EncodingManager em, boolean is3D )
     {
-        return new GraphBuilder(encodingManager).create();
+        return new GraphBuilder(em).set3D(is3D).create();
+    }
+
+    protected Graph createGraph( boolean is3D )
+    {
+        return createGraph(encodingManager, is3D);
     }
 
     public AlgorithmPreparation prepareGraph( Graph g )
@@ -66,17 +71,17 @@ public void testCalcShortestPath()
     @Test
     public void testCalcFastestPath()
     {
-        Graph graphShortest = createGraph();
+        Graph graphShortest = createGraph(false);
         initDirectedAndDiffSpeed(graphShortest);
         Path p1 = prepareGraph(graphShortest, carEncoder, new ShortestWeighting()).createAlgo().calcPath(0, 3);
         assertEquals(Helper.createTList(0, 1, 5, 2, 3), p1.calcNodes());
         assertEquals(p1.toString(), 402.293, p1.getDistance(), 1e-6);
         assertEquals(p1.toString(), 144823, p1.getMillis());
 
-        Graph graphFastest = createGraph();
+        Graph graphFastest = createGraph(false);
         initDirectedAndDiffSpeed(graphFastest);
         Path p2 = prepareGraph(graphFastest, carEncoder, new FastestWeighting(carEncoder)).createAlgo().calcPath(0, 3);
-        assertEquals(Helper.createTList(0, 4, 6, 7, 5, 3), p2.calcNodes());        
+        assertEquals(Helper.createTList(0, 4, 6, 7, 5, 3), p2.calcNodes());
         assertEquals(p2.toString(), 1261.714, p2.getDistance(), 1e-6);
         assertEquals(p2.toString(), 111437, p2.getMillis());
     }
@@ -125,7 +130,7 @@ void initDirectedAndDiffSpeed( Graph graph )
     @Test
     public void testCalcFootPath()
     {
-        Graph graphShortest = createGraph();
+        Graph graphShortest = createGraph(false);
         initFootVsCar(graphShortest);
         Path p1 = prepareGraph(graphShortest, footEncoder, new ShortestWeighting()).createAlgo().calcPath(0, 7);
         assertEquals(p1.toString(), 17000, p1.getDistance(), 1e-6);
@@ -160,7 +165,7 @@ void initFootVsCar( Graph graph )
     // see test-graph.svg !
     protected Graph createTestGraph()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
 
         graph.edge(0, 1, 7, true);
         graph.edge(0, 4, 6, true);
@@ -197,7 +202,7 @@ public void testCalcIfEmptyWay()
     @Test
     public void testNoPathFound()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         assertFalse(prepareGraph(graph).createAlgo().calcPath(0, 1).isFound());
 
         // two disconnected areas
@@ -212,7 +217,7 @@ public void testNoPathFound()
         // assertEquals(4, algo.getVisitedNodes());
 
         // disconnected as directed graph
-        graph = createGraph();
+        graph = createGraph(false);
         graph.edge(0, 1, 1, false);
         graph.edge(0, 2, 1, true);
         algo = prepareGraph(graph).createAlgo();
@@ -240,7 +245,7 @@ public void testCalcIf1EdgeAway()
     // see wikipedia-graph.svg !
     protected Graph createWikipediaTestGraph()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         graph.edge(0, 1, 7, true);
         graph.edge(0, 2, 9, true);
         graph.edge(0, 5, 14, true);
@@ -291,13 +296,14 @@ public static void initBiGraph( Graph graph )
 
     public static void updateDistancesFor( Graph g, int node, double lat, double lon )
     {
-        g.setNode(node, lat, lon);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(node, lat, lon);
         EdgeIterator iter = g.createEdgeExplorer().setBaseNode(node);
         while (iter.next())
         {
             int adj = iter.getAdjNode();
-            double adjLat = g.getLatitude(adj);
-            double adjLon = g.getLongitude(adj);
+            double adjLat = na.getLatitude(adj);
+            double adjLon = na.getLongitude(adj);
             iter.setDistance(distCalc.calcDist(lat, lon, adjLat, adjLon));
         }
     }
@@ -305,7 +311,7 @@ public static void updateDistancesFor( Graph g, int node, double lat, double lon
     @Test
     public void testBidirectional()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         initBiGraph(graph);
 
         // PrepareTowerNodesShortcutsTest.printEdges((LevelGraph) graph);
@@ -328,7 +334,7 @@ public void testBidirectional()
     @Test
     public void testBidirectional2()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
 
         graph.edge(0, 1, 100, true);
         graph.edge(1, 2, 1, true);
@@ -383,7 +389,7 @@ public void testCorrectWeight()
     @Test
     public void testCannotCalculateSP()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         graph.edge(0, 1, 1, false);
         graph.edge(1, 2, 1, false);
 
@@ -394,7 +400,7 @@ public void testCannotCalculateSP()
     @Test
     public void testDirectedGraphBug1()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         graph.edge(0, 1, 3, false);
         graph.edge(1, 2, 2.99, false);
 
@@ -411,7 +417,7 @@ public void testDirectedGraphBug1()
     @Test
     public void testDirectedGraphBug2()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         graph.edge(0, 1, 1, false);
         graph.edge(1, 2, 1, false);
         graph.edge(2, 3, 1, false);
@@ -429,12 +435,13 @@ public void testDirectedGraphBug2()
     @Test
     public void testWithCoordinates()
     {
-        Graph graph = createGraph();
-        graph.setNode(0, 0, 2);
-        graph.setNode(1, 0, 3.5);
-        graph.setNode(2, 1, 1);
-        graph.setNode(3, 1.5, 2.5);
-        graph.setNode(4, 0.5, 4.5);
+        Graph graph = createGraph(false);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0, 2);
+        na.setNode(1, 0, 3.5);
+        na.setNode(2, 1, 1);
+        na.setNode(3, 1.5, 2.5);
+        na.setNode(4, 0.5, 4.5);
 
         graph.edge(0, 1, 2, true).setWayGeometry(Helper.createPointList(0, 3));
         graph.edge(2, 3, 2, true);
@@ -462,7 +469,7 @@ public void testWithCoordinates()
     @Test
     public void testViaEdges_BiGraph()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         initBiGraph(graph);
 
         // 0-7 to 4-3
@@ -498,7 +505,7 @@ public void testViaEdges_WithCoordinates()
     @Test
     public void testViaEdges_SpecialCases()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         // 0->1\
         // |    2
         // 4<-3/
@@ -533,7 +540,7 @@ public void testViaEdges_SpecialCases()
     @Test
     public void testQueryGraphAndFastest()
     {
-        Graph graph = createGraph();
+        Graph graph = createGraph(false);
         initDirectedAndDiffSpeed(graph);
         Path p = calcPathViaQuery("fastest", graph, 0.002, 0.0005, 0.0017, 0.0031);
         assertEquals(Helper.createTList(9, 1, 5, 3, 8), p.calcNodes());
@@ -580,10 +587,11 @@ QueryResult newQR( Graph graph, int node1, int node2 )
         if (edge == null)
             throw new IllegalStateException("edge not found? " + node1 + "-" + node2);
 
-        double lat = graph.getLatitude(edge.getBaseNode());
-        double lon = graph.getLongitude(edge.getBaseNode());
-        double latAdj = graph.getLatitude(edge.getAdjNode());
-        double lonAdj = graph.getLongitude(edge.getAdjNode());
+        NodeAccess na = graph.getNodeAccess();
+        double lat = na.getLatitude(edge.getBaseNode());
+        double lon = na.getLongitude(edge.getBaseNode());
+        double latAdj = na.getLatitude(edge.getAdjNode());
+        double lonAdj = na.getLongitude(edge.getAdjNode());
         // calculate query point near the base node but not directly on it!
         QueryResult res = new QueryResult(lat + (latAdj - lat) * .1, lon + (lonAdj - lon) * .1);
         res.setClosestNode(edge.getBaseNode());
@@ -597,9 +605,25 @@ QueryResult newQR( Graph graph, int node1, int node2 )
     @Test
     public void testTwoWeightsPerEdge()
     {
+        FlagEncoder encoder = new Bike2WeightFlagEncoder();
+        Graph graph = initEleGraph(createGraph(new EncodingManager(encoder), true));
+        // force the other path
+        GHUtility.getEdge(graph, 0, 3).setFlags(encoder.setProperties(10, false, true));
+
+        // for two weights per edge it happened that Path (and also the Weighting) read the wrong side 
+        // of the speed and read 0 => infinity weight => overflow of millis => negative millis!
+        Path p = prepareGraph(graph, encoder, new FastestWeighting(encoder)).
+                createAlgo().calcPath(0, 10);
+//        assertEquals(Helper.createTList(13, 0, 1, 2, 11, 7, 10, 12), p.calcNodes());
+        assertEquals(85124371, p.getMillis());
+        assertEquals(425622, p.getDistance(), 1);
+        assertEquals(23646, p.getWeight(), 1);
+    }
 
-        // other direction should be different!
-        Graph graph = createEleGraph();
+    @Test
+    public void testTwoWeightsPerEdge2()
+    {
+        Graph graph = initEleGraph(createGraph(true));
         Path p = prepareGraph(graph, carEncoder, new ShortestWeighting()).createAlgo().calcPath(0, 10);
         // GHUtility.printEdgeInfo(graph, carEncoder);
         assertEquals(Helper.createTList(0, 4, 6, 10), p.calcNodes());
@@ -627,26 +651,22 @@ public double calcWeight( EdgeIteratorState edge, boolean reverse )
                 if (adj == 6)
                     return 3 * edge.getDistance();
                 else if (base == 6)
-                    return edge.getDistance() * 0.7;
+                    return edge.getDistance() * 0.9;
                 else if (adj == 4)
                     return 2 * edge.getDistance();
-                else if (base == 4)
-                    return edge.getDistance() * 0.8;
-
-                // a small 'hill' at node 11
-                else if (base == 7 && adj == 11)
-                    return 1.1 * edge.getDistance();
-                else
-                    return edge.getDistance();
+
+                return edge.getDistance() * 0.8;
             }
         };
+
+        graph = initEleGraph(createGraph(true));
         QueryResult from = newQR(graph, 3, 0);
         QueryResult to = newQR(graph, 10, 9);
-        graph = createEleGraph();
         p = prepareGraph(graph, carEncoder, fakeWeighting).createAlgo().calcPath(from, to);
         assertEquals(Helper.createTList(13, 0, 1, 2, 11, 7, 10, 12), p.calcNodes());
+        assertEquals(37009621, p.getMillis());
         assertEquals(616827, p.getDistance(), 1);
-        assertEquals(616827, p.getWeight(), 1);
+        assertEquals(493462, p.getWeight(), 1);
     }
 
     // 0-1-2
@@ -656,9 +676,8 @@ else if (base == 7 && adj == 11)
     // 5-6-7
     // | |\|
     // 8-9-10
-    Graph createEleGraph()
+    Graph initEleGraph( Graph g )
     {
-        Graph g = createGraph();
         g.edge(0, 1, 10, true);
         g.edge(0, 4, 12, true);
         g.edge(0, 3, 5, true);
diff --git a/core/src/test/java/com/graphhopper/routing/DijkstraOneToManyTest.java b/core/src/test/java/com/graphhopper/routing/DijkstraOneToManyTest.java
index d202f6cd84..0e2bba8ff0 100644
--- a/core/src/test/java/com/graphhopper/routing/DijkstraOneToManyTest.java
+++ b/core/src/test/java/com/graphhopper/routing/DijkstraOneToManyTest.java
@@ -51,39 +51,39 @@ public RoutingAlgorithm createAlgo()
     @Override
     public void testViaEdges_BiGraph()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
 
     @Override
     public void testViaEdges_SpecialCases()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
 
     @Override
     public void testViaEdges_FromEqualsTo()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
 
     @Override
     public void testViaEdges_WithCoordinates()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
 
     @Override
     public void testQueryGraphAndFastest()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
 
     @Override
-    public void testTwoWeightsPerEdge()
+    public void testTwoWeightsPerEdge2()
     {
-        // not supported
+        // calcPath with QueryResult not supported
     }
-    
+
     @Test
     public void testUseCache()
     {
diff --git a/core/src/test/java/com/graphhopper/routing/GraphHopperIT.java b/core/src/test/java/com/graphhopper/routing/GraphHopperIT.java
index e76e42c861..16f987a289 100644
--- a/core/src/test/java/com/graphhopper/routing/GraphHopperIT.java
+++ b/core/src/test/java/com/graphhopper/routing/GraphHopperIT.java
@@ -20,16 +20,20 @@
 import com.graphhopper.GHRequest;
 import com.graphhopper.GHResponse;
 import com.graphhopper.GraphHopper;
+import com.graphhopper.reader.dem.SRTMProvider;
 import com.graphhopper.routing.util.*;
-import com.graphhopper.storage.Graph;
 import com.graphhopper.util.*;
 import com.graphhopper.util.TranslationMap.Translation;
+import com.graphhopper.util.shapes.GHPlace;
 
 import java.io.File;
 import java.util.List;
 import java.util.Locale;
+import java.util.Map;
+import org.junit.After;
 import org.junit.Test;
 import static org.junit.Assert.*;
+import org.junit.Before;
 
 /**
  * @author Peter Karich
@@ -37,71 +41,161 @@
 public class GraphHopperIT
 {
     TranslationMap trMap = TranslationMapTest.SINGLETON;
+    Translation tr = trMap.getWithFallBack(Locale.US);
+    String graphFile = "target/graph-GraphHopperIT";
+    String osmFile = "files/monaco.osm.gz";
+    String vehicle = "FOOT";
+    String importVehicles = "FOOT";
+    String weightCalcStr = "shortest";
+
+    @Before
+    public void setUp()
+    {
+        // make sure we are using fresh graphhopper files with correct vehicle
+        Helper.removeDir(new File(graphFile));
+    }
+
+    @After
+    public void tearDown()
+    {
+        Helper.removeDir(new File(graphFile));
+    }
+
+    @Test
+    public void testMonacoWithInstructions() throws Exception
+    {
+        GraphHopper hopper = new GraphHopper().
+                setInMemory(true).
+                setOSMFile(osmFile).
+                disableCHShortcuts().
+                setGraphHopperLocation(graphFile).
+                setEncodingManager(new EncodingManager(importVehicles)).
+                importOrLoad();
+
+        GHResponse rsp = hopper.route(new GHRequest(43.727687, 7.418737, 43.74958, 7.436566).
+                setAlgorithm("astar").setVehicle(vehicle).setWeighting(weightCalcStr));
+
+        assertEquals(3437.6, rsp.getDistance(), .1);
+        assertEquals(89, rsp.getPoints().getSize());
+
+        InstructionList il = rsp.getInstructions();
+        assertEquals(13, il.size());
+
+        List<Map<String, Object>> resultJson = il.createJson(tr);
+        // TODO roundabout fine tuning -> enter + leave roundabout (+ two rounabouts -> is it necessary if we do not leave the street?)
+        assertEquals("Continue onto Avenue des Guelfes", resultJson.get(0).get("text"));
+        assertEquals("Turn slight left onto Avenue des Papalins", resultJson.get(1).get("text"));
+        assertEquals("Turn sharp right onto Quai Jean-Charles Rey", resultJson.get(2).get("text"));
+        assertEquals("Turn left onto road", resultJson.get(3).get("text"));
+        assertEquals("Turn right onto Avenue Albert II", resultJson.get(4).get("text"));
+
+        assertEquals(11, (Double) resultJson.get(0).get("distance"), 1);
+        assertEquals(289, (Double) resultJson.get(1).get("distance"), 1);
+        assertEquals(10, (Double) resultJson.get(2).get("distance"), 1);
+        assertEquals(43, (Double) resultJson.get(3).get("distance"), 1);
+        assertEquals(122, (Double) resultJson.get(4).get("distance"), 1);
+        assertEquals(447, (Double) resultJson.get(5).get("distance"), 1);
+
+        assertEquals(7, (Long) resultJson.get(0).get("time") / 1000);
+        assertEquals(207, (Long) resultJson.get(1).get("time") / 1000);
+        assertEquals(7, (Long) resultJson.get(2).get("time") / 1000);
+        assertEquals(30, (Long) resultJson.get(3).get("time") / 1000);
+        assertEquals(87, (Long) resultJson.get(4).get("time") / 1000);
+        assertEquals(321, (Long) resultJson.get(5).get("time") / 1000);
+
+        List<GPXEntry> list = rsp.getInstructions().createGPXList();
+        assertEquals(89, list.size());
+        final long lastEntryMillis = list.get(list.size() - 1).getMillis();
+        final long totalResponseMillis = rsp.getMillis();
+        assertEquals(totalResponseMillis, lastEntryMillis);
+    }
 
     @Test
-    public void testMonacoWithInstructions()
+    public void testSRTMWithInstructions() throws Exception
     {
-        String osmFile = "files/monaco.osm.gz";
-        String graphFile = "target/graph-monaco";
-        String vehicle = "FOOT";
-        String importVehicles = "FOOT";
-        String weightCalcStr = "shortest";
-
-        try
-        {
-            // make sure we are using fresh graphhopper files with correct vehicle
-            Helper.removeDir(new File(graphFile));
-            GraphHopper hopper = new GraphHopper().setInMemory(true).setOSMFile(osmFile).
-                    disableCHShortcuts().
-                    setGraphHopperLocation(graphFile).setEncodingManager(new EncodingManager(importVehicles)).
-                    importOrLoad();
-
-            Graph g = hopper.getGraph();
-            GHResponse rsp = hopper.route(new GHRequest(43.727687, 7.418737, 43.74958, 7.436566).
-                    setAlgorithm("astar").setVehicle(vehicle).setWeighting(weightCalcStr));
-
-            assertEquals(3437.6, rsp.getDistance(), .1);
-            assertEquals(87, rsp.getPoints().getSize());
-
-            InstructionList il = rsp.getInstructions();
-            assertEquals(13, il.size());
-            Translation tr = trMap.getWithFallBack(Locale.US);
-            List<String> iList = il.createDescription(tr);
-            // TODO roundabout fine tuning -> enter + leave roundabout (+ two rounabouts -> is it necessary if we do not leave the street?)
-            assertEquals("Continue onto Avenue des Guelfes", iList.get(0));
-            assertEquals("Turn slight left onto Avenue des Papalins", iList.get(1));
-            assertEquals("Turn sharp right onto Quai Jean-Charles Rey", iList.get(2));
-            assertEquals("Turn left onto road", iList.get(3));
-            assertEquals("Turn right onto Avenue Albert II", iList.get(4));
-
-            List<Double> dists = il.createDistances();
-            assertEquals(11, dists.get(0), 1);
-            assertEquals(289, dists.get(1), 1);
-            assertEquals(10, dists.get(2), 1);
-            assertEquals(43, dists.get(3), 1);
-            assertEquals(122, dists.get(4), 1);
-            assertEquals(447, dists.get(5), 1);
-
-            List<Long> times = il.createMillis();
-            assertEquals(7, times.get(0) / 1000);
-            assertEquals(207, times.get(1) / 1000);
-            assertEquals(7, times.get(2) / 1000);
-            assertEquals(30, times.get(3) / 1000);
-            assertEquals(87, times.get(4) / 1000);
-            assertEquals(321, times.get(5) / 1000);
-
-            List<GPXEntry> list = rsp.getInstructions().createGPXList();
-            assertEquals(123, list.size());
-            final long lastEntryMillis = list.get(list.size() - 1).getMillis();
-            final long totalResponseMillis = rsp.getMillis();
-            assertEquals(totalResponseMillis, lastEntryMillis);
-
-        } catch (Exception ex)
-        {
-            throw new RuntimeException("cannot handle osm file " + osmFile, ex);
-        } finally
-        {
-            Helper.removeDir(new File(graphFile));
-        }
+        GraphHopper hopper = new GraphHopper().
+                setInMemory(true).
+                setOSMFile(osmFile).
+                disableCHShortcuts().
+                setGraphHopperLocation(graphFile).
+                setEncodingManager(new EncodingManager(importVehicles));
+
+        hopper.setElevationProvider(new SRTMProvider().setCacheDir(new File("./files/")));
+        hopper.importOrLoad();
+
+        GHResponse rsp = hopper.route(new GHRequest(43.730729, 7.421288, 43.727697, 7.419199).
+                setAlgorithm("astar").setVehicle(vehicle).setWeighting(weightCalcStr));
+
+        assertEquals(1634, rsp.getDistance(), .1);
+        assertEquals(60, rsp.getPoints().getSize());
+        assertTrue(rsp.getPoints().is3D());
+
+        InstructionList il = rsp.getInstructions();
+        assertEquals(10, il.size());
+        assertTrue(il.get(0).getPoints().is3D());
+
+        String str = rsp.getPoints().toString();
+        assertTrue(str,
+                str.startsWith("(43.73068455771767,7.421283689825812,66.0), (43.73067957305937,7.421382123709815,66.0), "
+                        + "(43.73109792316924,7.421546222751131,66.0), (43.73129908884985,7.421589994913116,66.0), "
+                        + "(43.731327028527716,7.421414533736137,66.0), (43.73125047381037,7.421366291225693,66.0), "
+                        + "(43.73125457162979,7.421274090288746,66.0), "
+                        + "(43.73128213877862,7.421115579183003,66.0), (43.731362232521825,7.421145381506057,66.0), "
+                        + "(43.731371359483255,7.421123216028286,66.0), (43.731485725897976,7.42117332118392,45.0), "
+                        + "(43.731575132867135,7.420868778695214,52.0), (43.73160605277731,7.420824820268709,52.0), "
+                        + "(43.7316401391843,7.420850152243305,52.0), (43.731674039326776,7.421050014072285,45.0)"));
+    }
+
+    @Test
+    public void testMonacoVia()
+    {
+        GraphHopper hopper = new GraphHopper().
+                setInMemory(true).
+                setOSMFile(osmFile).
+                disableCHShortcuts().
+                setGraphHopperLocation(graphFile).
+                setEncodingManager(new EncodingManager(importVehicles)).
+                importOrLoad();
+
+        GHResponse rsp = hopper.route(new GHRequest().
+                addPlace(new GHPlace(43.727687, 7.418737)).
+                addPlace(new GHPlace(43.74958, 7.436566)).
+                addPlace(new GHPlace(43.727687, 7.418737)).
+                setAlgorithm("astar").setVehicle(vehicle).setWeighting(weightCalcStr));
+
+        assertEquals(6875.1, rsp.getDistance(), .1);
+        assertEquals(179, rsp.getPoints().getSize());
+
+        InstructionList il = rsp.getInstructions();
+        assertEquals(26, il.size());
+        List<Map<String, Object>> resultJson = il.createJson(tr);
+        assertEquals("Continue onto Avenue des Guelfes", resultJson.get(0).get("text"));
+        assertEquals("Turn slight left onto Avenue des Papalins", resultJson.get(1).get("text"));
+        assertEquals("Turn sharp right onto Quai Jean-Charles Rey", resultJson.get(2).get("text"));
+        assertEquals("Turn left onto road", resultJson.get(3).get("text"));
+        assertEquals("Turn right onto Avenue Albert II", resultJson.get(4).get("text"));
+
+        assertEquals("Stopover 1", resultJson.get(12).get("text"));
+
+        assertEquals("Continue onto Avenue Albert II", resultJson.get(20).get("text"));
+        assertEquals("Turn left onto road", resultJson.get(21).get("text"));
+        assertEquals("Turn right onto Quai Jean-Charles Rey", resultJson.get(22).get("text"));
+        assertEquals("Turn sharp left onto Avenue des Papalins", resultJson.get(23).get("text"));
+        assertEquals("Turn slight right onto Avenue des Guelfes", resultJson.get(24).get("text"));
+        assertEquals("Finish!", resultJson.get(25).get("text"));
+
+        assertEquals(11, (Double) resultJson.get(0).get("distance"), 1);
+        assertEquals(289, (Double) resultJson.get(1).get("distance"), 1);
+        assertEquals(10, (Double) resultJson.get(2).get("distance"), 1);
+        assertEquals(43, (Double) resultJson.get(3).get("distance"), 1);
+        assertEquals(122, (Double) resultJson.get(4).get("distance"), 1);
+        assertEquals(447, (Double) resultJson.get(5).get("distance"), 1);
+
+        assertEquals(7, (Long) resultJson.get(0).get("time") / 1000);
+        assertEquals(207, (Long) resultJson.get(1).get("time") / 1000);
+        assertEquals(7, (Long) resultJson.get(2).get("time") / 1000);
+        assertEquals(30, (Long) resultJson.get(3).get("time") / 1000);
+        assertEquals(87, (Long) resultJson.get(4).get("time") / 1000);
+        assertEquals(321, (Long) resultJson.get(5).get("time") / 1000);
     }
 }
diff --git a/core/src/test/java/com/graphhopper/routing/PathTest.java b/core/src/test/java/com/graphhopper/routing/PathTest.java
index 47ea9b578e..a7d62bdefd 100644
--- a/core/src/test/java/com/graphhopper/routing/PathTest.java
+++ b/core/src/test/java/com/graphhopper/routing/PathTest.java
@@ -17,15 +17,20 @@
  */
 package com.graphhopper.routing;
 
+import com.graphhopper.routing.util.Bike2WeightFlagEncoder;
 import com.graphhopper.routing.util.EncodingManager;
 import com.graphhopper.routing.util.FlagEncoder;
-import com.graphhopper.storage.Graph;
-import com.graphhopper.storage.GraphBuilder;
+import com.graphhopper.storage.*;
 import com.graphhopper.util.Helper;
 import static com.graphhopper.storage.AbstractGraphStorageTester.*;
-import com.graphhopper.storage.EdgeEntry;
 import com.graphhopper.util.EdgeIteratorState;
+import com.graphhopper.util.Instruction;
 import com.graphhopper.util.InstructionList;
+import com.graphhopper.storage.EdgeEntry;
+import com.graphhopper.util.*;
+import java.util.List;
+import java.util.Locale;
+import java.util.Map;
 import org.junit.Test;
 import static org.junit.Assert.*;
 
@@ -35,40 +40,50 @@
  */
 public class PathTest
 {
+    private final EncodingManager carManager = new EncodingManager("CAR");
+    private final FlagEncoder encoder = new EncodingManager("CAR").getEncoder("CAR");
+    private final TranslationMap trMap = TranslationMapTest.SINGLETON;
+    private final TranslationMap.Translation tr = trMap.getWithFallBack(Locale.US);
+
     @Test
     public void testFound()
     {
-        Path p = new Path(null, null);
+        GraphStorage g = new GraphBuilder(carManager).create();
+        Path p = new Path(g, encoder);
         assertFalse(p.isFound());
         assertEquals(0, p.getDistance(), 1e-7);
         assertEquals(0, p.calcNodes().size());
+        g.close();
     }
 
     @Test
     public void testTime()
     {
-        FlagEncoder encoder = new EncodingManager("CAR").getEncoder("CAR");
-        Path p = new Path(null, encoder);
-        assertEquals(60 * 60 * 1000, p.calcMillis(100000, encoder.setProperties(100, true, true)));
+        FlagEncoder tmpEnc = new Bike2WeightFlagEncoder();
+        GraphStorage g = new GraphBuilder(new EncodingManager(tmpEnc)).create();
+        Path p = new Path(g, tmpEnc);
+        long flags = tmpEnc.setSpeed(tmpEnc.setReverseSpeed(tmpEnc.setAccess(0, true, true), 10), 15);
+        assertEquals(375 * 60 * 1000, p.calcMillis(100000, flags, false));
+        assertEquals(600 * 60 * 1000, p.calcMillis(100000, flags, true));
+
+        g.close();
     }
 
     @Test
     public void testWayList()
     {
-        EncodingManager carManager = new EncodingManager("CAR");
-        FlagEncoder carEnc = carManager.getEncoder("CAR");
-        Graph g = new GraphBuilder(carManager).create();
-
-        g.setNode(0, 0.0, 0.1);
-        g.setNode(1, 1.0, 0.1);
-        g.setNode(2, 2.0, 0.1);
+        GraphStorage g = new GraphBuilder(carManager).create();
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0.0, 0.1);
+        na.setNode(1, 1.0, 0.1);
+        na.setNode(2, 2.0, 0.1);
 
-        EdgeIteratorState edge1 = g.edge(0, 1).setDistance(1000).setFlags(carEnc.setProperties(10, true, true));
+        EdgeIteratorState edge1 = g.edge(0, 1).setDistance(1000).setFlags(encoder.setProperties(10, true, true));
         edge1.setWayGeometry(Helper.createPointList(8, 1, 9, 1));
-        EdgeIteratorState edge2 = g.edge(2, 1).setDistance(2000).setFlags(carEnc.setProperties(50, true, true));
+        EdgeIteratorState edge2 = g.edge(2, 1).setDistance(2000).setFlags(encoder.setProperties(50, true, true));
         edge2.setWayGeometry(Helper.createPointList(11, 1, 10, 1));
 
-        Path path = new Path(g, carEnc);
+        Path path = new Path(g, encoder);
         EdgeEntry e1 = new EdgeEntry(edge2.getEdge(), 2, 1);
         e1.parent = new EdgeEntry(edge1.getEdge(), 1, 1);
         e1.parent.parent = new EdgeEntry(-1, 0, 1);
@@ -77,23 +92,48 @@ public void testWayList()
         // 0-1-2
         assertPList(Helper.createPointList(0, 0.1, 8, 1, 9, 1, 1, 0.1, 10, 1, 11, 1, 2, 0.1), path.calcPoints());
         InstructionList instr = path.calcInstructions();
-        assertEquals("[" + 504 * 1000 + ", 0]", instr.createMillis().toString());
-        assertEquals("[3000.0, 0.0]", instr.createDistances().toString());
+        List<Map<String, Object>> res = instr.createJson(tr);
+        Map<String, Object> tmp = res.get(0);
+        assertEquals(3000.0, tmp.get("distance"));
+        assertEquals(504000L, tmp.get("time"));
+        assertEquals("Continue onto road", tmp.get("text"));
+        assertEquals("[0, 6]", tmp.get("interval").toString());
+
+        tmp = res.get(1);
+        assertEquals(0.0, tmp.get("distance"));
+        assertEquals(0L, tmp.get("time"));
+        assertEquals("Finish!", tmp.get("text"));
+        assertEquals("[6, 6]", tmp.get("interval").toString());
+        int lastIndex = (Integer) ((List) res.get(res.size() - 1).get("interval")).get(0);
+        assertEquals(path.calcPoints().size() - 1, lastIndex);
 
         // force minor change for instructions
         edge2.setName("2");
-        path = new Path(g, carEnc);
+        path = new Path(g, encoder);
         e1 = new EdgeEntry(edge2.getEdge(), 2, 1);
         e1.parent = new EdgeEntry(edge1.getEdge(), 1, 1);
         e1.parent.parent = new EdgeEntry(-1, 0, 1);
         path.setEdgeEntry(e1);
         path.extract();
         instr = path.calcInstructions();
-        assertEquals("[" + 6 * 60 * 1000 + ", " + 144 * 1000 + ", 0]", instr.createMillis().toString());
-        assertEquals("[1000.0, 2000.0, 0.0]", instr.createDistances().toString());
+        res = instr.createJson(tr);
+
+        tmp = res.get(0);
+        assertEquals(1000.0, tmp.get("distance"));
+        assertEquals(360000L, tmp.get("time"));
+        assertEquals("Continue onto road", tmp.get("text"));
+        assertEquals("[0, 3]", tmp.get("interval").toString());
+
+        tmp = res.get(1);
+        assertEquals(2000.0, tmp.get("distance"));
+        assertEquals(144000L, tmp.get("time"));
+        assertEquals("Turn sharp right onto 2", tmp.get("text"));
+        assertEquals("[3, 6]", tmp.get("interval").toString());
+        lastIndex = (Integer) ((List) res.get(res.size() - 1).get("interval")).get(0);
+        assertEquals(path.calcPoints().size() - 1, lastIndex);
 
         // now reverse order
-        path = new Path(g, carEnc);
+        path = new Path(g, encoder);
         e1 = new EdgeEntry(edge1.getEdge(), 0, 1);
         e1.parent = new EdgeEntry(edge2.getEdge(), 1, 1);
         e1.parent.parent = new EdgeEntry(-1, 2, 1);
@@ -102,7 +142,66 @@ public void testWayList()
         // 2-1-0
         assertPList(Helper.createPointList(2, 0.1, 11, 1, 10, 1, 1, 0.1, 9, 1, 8, 1, 0, 0.1), path.calcPoints());
         instr = path.calcInstructions();
-        assertEquals("[" + 144 * 1000 + ", " + 6 * 60 * 1000 + ", 0]", instr.createMillis().toString());
-        assertEquals("[2000.0, 1000.0, 0.0]", instr.createDistances().toString());
+
+        res = instr.createJson(tr);
+        tmp = res.get(0);
+        assertEquals(2000.0, tmp.get("distance"));
+        assertEquals(144000L, tmp.get("time"));
+        assertEquals("Continue onto 2", tmp.get("text"));
+        assertEquals("[0, 3]", tmp.get("interval").toString());
+
+        tmp = res.get(1);
+        assertEquals(1000.0, tmp.get("distance"));
+        assertEquals(360000L, tmp.get("time"));
+        assertEquals("Turn sharp left onto road", tmp.get("text"));
+        assertEquals("[3, 6]", tmp.get("interval").toString());
+        lastIndex = (Integer) ((List) res.get(res.size() - 1).get("interval")).get(0);
+        assertEquals(path.calcPoints().size() - 1, lastIndex);
     }
+
+    @Test
+    public void testFindInstruction()
+    {
+        Graph g = new GraphBuilder(carManager).create();
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0.0, 0.0);
+        na.setNode(1, 5.0, 0.0);
+        na.setNode(2, 5.0, 0.5);
+        na.setNode(3, 10.0, 0.5);
+        na.setNode(4, 7.5, 0.25);
+
+        EdgeIteratorState edge1 = g.edge(0, 1).setDistance(1000).setFlags(encoder.setProperties(50, true, true));
+        edge1.setWayGeometry(Helper.createPointList());
+        edge1.setName("Street 1");
+        EdgeIteratorState edge2 = g.edge(1, 2).setDistance(1000).setFlags(encoder.setProperties(50, true, true));
+        edge2.setWayGeometry(Helper.createPointList());
+        edge2.setName("Street 2");
+        EdgeIteratorState edge3 = g.edge(2, 3).setDistance(1000).setFlags(encoder.setProperties(50, true, true));
+        edge3.setWayGeometry(Helper.createPointList());
+        edge3.setName("Street 3");
+        EdgeIteratorState edge4 = g.edge(3, 4).setDistance(500).setFlags(encoder.setProperties(50, true, true));
+        edge4.setWayGeometry(Helper.createPointList());
+        edge4.setName("Street 4");
+
+        Path path = new Path(g, encoder);
+        EdgeEntry e1 = new EdgeEntry(edge4.getEdge(), 4, 1);
+        e1.parent = new EdgeEntry(edge3.getEdge(), 3, 1);
+        e1.parent.parent = new EdgeEntry(edge2.getEdge(), 2, 1);
+        e1.parent.parent.parent = new EdgeEntry(edge1.getEdge(), 1, 1);
+        e1.parent.parent.parent.parent = new EdgeEntry(-1, 0, 1);
+        path.setEdgeEntry(e1);
+        path.extract();
+
+        path.calcInstructions();
+        Instruction nextInstr1 = path.findInstruction(0.0, 0.1);
+        Instruction nextInstr2 = path.findInstruction(5.0, 0.4);
+        Instruction nextInstr3 = path.findInstruction(9.0, 0.53);
+        Instruction nextInstr4 = path.findInstruction(7.8, 0.25);
+
+        assertEquals(Instruction.TURN_RIGHT, nextInstr1.getSign());
+        assertEquals(Instruction.TURN_LEFT, nextInstr2.getSign());
+        assertEquals(Instruction.TURN_SHARP_LEFT, nextInstr3.getSign());
+        assertEquals(Instruction.FINISH, nextInstr4.getSign());
+    }
+
 }
diff --git a/core/src/test/java/com/graphhopper/routing/QueryGraphTest.java b/core/src/test/java/com/graphhopper/routing/QueryGraphTest.java
index 012bf3ab6d..afd46f539e 100644
--- a/core/src/test/java/com/graphhopper/routing/QueryGraphTest.java
+++ b/core/src/test/java/com/graphhopper/routing/QueryGraphTest.java
@@ -18,8 +18,11 @@
 package com.graphhopper.routing;
 
 import com.graphhopper.routing.util.EncodingManager;
+import com.graphhopper.routing.util.FlagEncoder;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphHopperStorage;
+import com.graphhopper.storage.NodeAccess;
+import com.graphhopper.storage.GraphStorage;
 import com.graphhopper.storage.RAMDirectory;
 import com.graphhopper.storage.index.QueryResult;
 import static com.graphhopper.storage.index.QueryResult.Position.*;
@@ -27,9 +30,10 @@
 import com.graphhopper.util.shapes.GHPoint;
 import gnu.trove.map.TIntObjectMap;
 import java.util.Arrays;
-import java.util.Collections;
+import org.junit.After;
 import org.junit.Test;
 import static org.junit.Assert.*;
+import org.junit.Before;
 
 /**
  *
@@ -37,6 +41,21 @@
  */
 public class QueryGraphTest
 {
+    private final EncodingManager encodingManager = new EncodingManager("CAR");
+    private GraphStorage g;
+
+    @Before
+    public void setUp()
+    {
+        g = new GraphHopperStorage(new RAMDirectory(), encodingManager, false).create(100);
+    }
+
+    @After
+    public void tearDown()
+    {
+        g.close();
+    }
+
     void initGraph( Graph g )
     {
         //
@@ -44,9 +63,10 @@ void initGraph( Graph g )
         // 0     1
         // |
         // 2
-        g.setNode(0, 1, 0);
-        g.setNode(1, 1, 2.5);
-        g.setNode(2, 0, 0);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 1, 0);
+        na.setNode(1, 1, 2.5);
+        na.setNode(2, 0, 0);
         g.edge(0, 2, 10, true);
         g.edge(0, 1, 10, true).setWayGeometry(Helper.createPointList(1.5, 1, 1.5, 1.5));
     }
@@ -54,8 +74,6 @@ void initGraph( Graph g )
     @Test
     public void testOneVirtualNode()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         initGraph(g);
         EdgeExplorer expl = g.createEdgeExplorer();
 
@@ -93,7 +111,7 @@ public void testOneVirtualNode()
         queryGraph.lookup(Arrays.asList(res));
         assertEquals(new GHPoint(1.5, 1.5), res.getSnappedPoint());
         assertEquals(3, res.getClosestNode());
-        assertEquals(3, getPoints(queryGraph, 0, 3).getSize());
+        assertEquals(4, getPoints(queryGraph, 0, 3).getSize());
         assertEquals(2, getPoints(queryGraph, 3, 1).getSize());
 
         queryGraph = new QueryGraph(g);
@@ -101,7 +119,7 @@ public void testOneVirtualNode()
         queryGraph.lookup(Arrays.asList(res));
         assertEquals(new GHPoint(1.5, 1.5), res.getSnappedPoint());
         assertEquals(3, res.getClosestNode());
-        assertEquals(3, getPoints(queryGraph, 0, 3).getSize());
+        assertEquals(4, getPoints(queryGraph, 0, 3).getSize());
         assertEquals(2, getPoints(queryGraph, 3, 1).getSize());
 
         // snap to edge which has pillar nodes        
@@ -128,9 +146,8 @@ public void testOneVirtualNode()
     @Test
     public void testFillVirtualEdges()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         initGraph(g);
+        g.getNodeAccess().setNode(3, 0, 1);
         g.edge(1, 3);
 
         final int baseNode = 1;
@@ -154,14 +171,17 @@ else if (towerNode == 1)
             }
         };
         queryGraph.lookup(Arrays.asList(res1));
-        GHUtility.getEdge(queryGraph, 0, 1);
+        EdgeIteratorState state = GHUtility.getEdge(queryGraph, 0, 1);
+        assertEquals(4, state.fetchWayGeometry(3).size());
+
+        // fetch virtual edge and check way geometry
+        state = GHUtility.getEdge(queryGraph, 4, 3);
+        assertEquals(2, state.fetchWayGeometry(3).size());
     }
 
     @Test
     public void testMultipleVirtualNodes()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         initGraph(g);
 
         // snap to edge which has pillar nodes        
@@ -172,7 +192,7 @@ public void testMultipleVirtualNodes()
         queryGraph.lookup(Arrays.asList(res1));
         assertEquals(new GHPoint(1.5, 1.5), res1.getSnappedPoint());
         assertEquals(3, res1.getClosestNode());
-        assertEquals(3, getPoints(queryGraph, 0, 3).getSize());
+        assertEquals(4, getPoints(queryGraph, 0, 3).getSize());
         PointList pl = getPoints(queryGraph, 3, 1);
         assertEquals(2, pl.getSize());
         assertEquals(new GHPoint(1.5, 1.5), pl.toGHPoint(0));
@@ -198,7 +218,7 @@ public void testMultipleVirtualNodes()
         assertEquals(3, res1.getClosestNode());
         assertEquals(new GHPoint(1.5, 1.5), res1.getSnappedPoint());
 
-        assertEquals(3, getPoints(queryGraph, 3, 0).getSize());
+        assertEquals(4, getPoints(queryGraph, 3, 0).getSize());
         assertEquals(2, getPoints(queryGraph, 3, 4).getSize());
         assertEquals(2, getPoints(queryGraph, 4, 1).getSize());
         assertNull(GHUtility.getEdge(queryGraph, 4, 0));
@@ -208,10 +228,9 @@ public void testMultipleVirtualNodes()
     @Test
     public void testOneWay()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
-        g.setNode(0, 0, 0);
-        g.setNode(1, 0, 1);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0, 0);
+        na.setNode(1, 0, 1);
         g.edge(0, 1, 10, false);
 
         EdgeIteratorState edge = GHUtility.getEdge(g, 0, 1);
@@ -234,19 +253,44 @@ public void testOneWay()
     @Test
     public void testVirtEdges()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         initGraph(g);
 
         EdgeIterator iter = g.createEdgeExplorer().setBaseNode(0);
         iter.next();
 
         QueryGraph.VirtualEdgeIterator vi = new QueryGraph.VirtualEdgeIterator(2);
-        vi.add(iter.detach());
+        vi.add(iter.detach(false));
 
         assertTrue(vi.next());
     }
 
+    @Test
+    public void testUseMeanElevation()
+    {
+        g.close();
+        g = new GraphHopperStorage(new RAMDirectory(), encodingManager, true).create(100);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0, 0, 0);
+        na.setNode(1, 0, 0.0001, 20);
+        EdgeIteratorState edge = g.edge(0, 1);
+        EdgeIteratorState edgeReverse = edge.detach(true);
+
+        DistanceCalc2D distCalc = new DistanceCalc2D();
+        QueryResult qr = new QueryResult(0, 0.00005);
+        qr.setClosestEdge(edge);
+        qr.setWayIndex(0);
+        qr.setSnappedPosition(EDGE);
+        qr.calcSnappedPoint(distCalc);
+        assertEquals(10, qr.getSnappedPoint().getEle(), 1e-1);
+
+        qr = new QueryResult(0, 0.00005);
+        qr.setClosestEdge(edgeReverse);
+        qr.setWayIndex(0);
+        qr.setSnappedPosition(EDGE);
+        qr.calcSnappedPoint(distCalc);
+        assertEquals(10, qr.getSnappedPoint().getEle(), 1e-1);
+    }
+
     @Test
     public void testLoopStreet_Issue151()
     {
@@ -256,8 +300,6 @@ public void testLoopStreet_Issue151()
         //    |  |
         //    x---
         //
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         g.edge(0, 1, 10, true);
         g.edge(1, 3, 10, true);
         g.edge(3, 4, 10, true);
@@ -275,15 +317,54 @@ public void testLoopStreet_Issue151()
         QueryGraph qg = new QueryGraph(g);
         qg.lookup(Arrays.asList(qr));
         EdgeExplorer ee = qg.createEdgeExplorer();
-        
+
         assertEquals(GHUtility.asSet(0, 5, 3), GHUtility.getNeighbors(ee.setBaseNode(1)));
     }
 
+    @Test
+    public void testOneWayLoop_Issue162()
+    {
+        // do query at x, where edge is oneway
+        //
+        // |\
+        // | x
+        // 0<-\
+        // |
+        // 1
+        FlagEncoder carEncoder = encodingManager.getSingle();
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0, 0);
+        na.setNode(1, 0, -0.001);
+        g.edge(0, 1, 10, true);
+        // in the case of identical nodes the wayGeometry defines the direction!
+        EdgeIteratorState edge = g.edge(0, 0).
+                setDistance(100).
+                setFlags(carEncoder.setProperties(20, true, false)).
+                setWayGeometry(Helper.createPointList(0.001, 0, 0, 0.001));
+
+        QueryResult qr = new QueryResult(0.0011, 0.0009);
+        qr.setClosestEdge(edge);
+        qr.setWayIndex(1);
+        qr.calcSnappedPoint(new DistanceCalc2D());
+
+        QueryGraph qg = new QueryGraph(g);
+        qg.lookup(Arrays.asList(qr));
+        EdgeExplorer ee = qg.createEdgeExplorer();
+        assertTrue(qr.getClosestNode() > 1);
+        assertEquals(2, GHUtility.count(ee.setBaseNode(qr.getClosestNode())));
+        EdgeIterator iter = ee.setBaseNode(qr.getClosestNode());
+        iter.next();
+        assertFalse(iter.toString(), carEncoder.isBackward(iter.getFlags()));
+        assertTrue(iter.toString(), carEncoder.isForward(iter.getFlags()));
+
+        iter.next();
+        assertTrue(iter.toString(), carEncoder.isBackward(iter.getFlags()));
+        assertFalse(iter.toString(), carEncoder.isForward(iter.getFlags()));
+    }
+
     @Test
     public void testEdgesShareOneNode()
     {
-        EncodingManager encodingManager = new EncodingManager("CAR");
-        Graph g = new GraphHopperStorage(new RAMDirectory(), encodingManager).create(100);
         initGraph(g);
 
         EdgeIteratorState iter = GHUtility.getEdge(g, 0, 2);
diff --git a/core/src/test/java/com/graphhopper/routing/RoutingAlgorithmIT.java b/core/src/test/java/com/graphhopper/routing/RoutingAlgorithmIT.java
index f393efe686..2b9b0b8a13 100644
--- a/core/src/test/java/com/graphhopper/routing/RoutingAlgorithmIT.java
+++ b/core/src/test/java/com/graphhopper/routing/RoutingAlgorithmIT.java
@@ -20,8 +20,10 @@
 import com.graphhopper.routing.util.TestAlgoCollector;
 import com.graphhopper.GraphHopper;
 import com.graphhopper.reader.PrinctonReader;
+import com.graphhopper.reader.dem.SRTMProvider;
 import com.graphhopper.routing.util.*;
 import com.graphhopper.routing.util.EncodingManager;
+import com.graphhopper.routing.util.TestAlgoCollector.OneRun;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphBuilder;
 import com.graphhopper.storage.index.LocationIndex;
@@ -59,16 +61,16 @@ public void setUp()
     List<OneRun> createMonacoCar()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(43.730729, 7.42135, 43.727697, 7.419199, 2581, 91));
-        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3586, 126));
-        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.4277, 2560, 102));
-        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 2227, 105));
-        list.add(new OneRun(43.730949, 7.412338, 43.739643, 7.424542, 2101, 100));
+        list.add(new OneRun(43.730729, 7.42135, 43.727697, 7.419199, 2581, 102));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3586, 162));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.4277, 2560, 131));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 2227, 128));
+        list.add(new OneRun(43.730949, 7.412338, 43.739643, 7.424542, 2101, 110));
         list.add(new OneRun(43.727592, 7.419333, 43.727712, 7.419333, 0, 1));
 
         // same special cases where GPS-exact routing could have problems (same edge and neighbor edges)
         list.add(new OneRun(43.727592, 7.419333, 43.727712, 7.41934, 0, 1));
-        // on the same edge and very close
+        // on the same edge and very release
         list.add(new OneRun(43.727592, 7.419333, 43.727712, 7.4193, 2, 2));
         // one way stuff
         list.add(new OneRun(43.729445, 7.415063, 43.728856, 7.41472, 107, 4));
@@ -80,7 +82,22 @@ public void setUp()
     public void testMonaco()
     {
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                createMonacoCar(), "CAR", true, "CAR", "shortest");
+                createMonacoCar(), "CAR", true, "CAR", "shortest", false);
+        assertEquals(testCollector.toString(), 0, testCollector.errors.size());
+    }
+
+    @Test
+    public void testOneWayCircleBug()
+    {
+        // export from http://www.openstreetmap.org/export#map=19/51.37605/-0.53155
+        List<OneRun> list = new ArrayList<OneRun>();
+        // going the bit longer way out of the circle
+        list.add(new OneRun(51.376197, -0.531576, 51.376509, -0.530863, 153, 19));
+        // now exacle the opposite direction: going into the circle (shorter)
+        list.add(new OneRun(51.376509, -0.530863, 51.376197, -0.531576, 75, 13));
+
+        runAlgo(testCollector, "files/circle-bug.osm.gz", "target/graph-circle-bug",
+                list, "CAR", true, "CAR", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -88,7 +105,6 @@ public void testMonaco()
     public void testMoscow()
     {
         // extracted via ./graphhopper.sh extract "37.582641,55.805261,37.626929,55.824455"
-
         List<OneRun> list = new ArrayList<OneRun>();
         // choose perpendicular
         // http://localhost:8989/?point=55.818994%2C37.595354&point=55.819175%2C37.596931
@@ -100,7 +116,7 @@ public void testMoscow()
         // http://localhost:8989/?point=55.819066%2C37.596374&point=55.818898%2C37.59661
         list.add(new OneRun(55.819066, 37.596374, 55.818898, 37.59661, 1114, 23));
         runAlgo(testCollector, "files/moscow.osm.gz", "target/graph-moscow",
-                list, "CAR", true, "CAR", "fastest");
+                list, "CAR", true, "CAR", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -108,13 +124,13 @@ public void testMoscow()
     public void testMonacoFastest()
     {
         List<OneRun> list = createMonacoCar();
-        list.get(0).locs = 95;
-        list.get(3).dist = 2276;
-        list.get(3).locs = 107;
-        list.get(4).dist = 2150;
-        list.get(4).locs = 102;
+        list.get(0).setLocs(1, 105);
+        list.get(3).setDistance(1, 2276);
+        list.get(3).setLocs(1, 133);
+        list.get(4).setDistance(1, 2149);
+        list.get(4).setLocs(1, 115);
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "CAR", true, "CAR", "fastest");
+                list, "CAR", true, "CAR", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -124,27 +140,66 @@ public void testMonacoMixed()
         // Additional locations are inserted because of new crossings from foot to highway paths!
         // Distance is the same.
         List<OneRun> list = createMonacoCar();
-        list.get(0).locs = 101;
-        list.get(1).locs = 135;
-        list.get(2).locs = 105;
-        list.get(3).locs = 117;
-        list.get(4).locs = 106;
+        list.get(0).setLocs(1, 107);
+        list.get(1).setLocs(1, 165);
+        list.get(2).setLocs(1, 132);
+        list.get(3).setLocs(1, 132);
+        list.get(4).setLocs(1, 114);
 
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "CAR,FOOT", false, "CAR", "shortest");
+                list, "CAR,FOOT", false, "CAR", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
+    List<OneRun> createMonacoFoot()
+    {
+        List<OneRun> list = new ArrayList<OneRun>();
+        list.add(new OneRun(43.730729, 7.421288, 43.727697, 7.419199, 1566, 92));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3435, 132));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2085, 111));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1425, 89));
+        return list;
+    }
+
     @Test
     public void testMonacoFoot()
+    {
+        runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
+                createMonacoFoot(), "FOOT", true, "FOOT", "shortest", false);
+        assertEquals(testCollector.toString(), 0, testCollector.errors.size());
+    }
+
+    @Test
+    public void testMonacoFoot3D()
+    {
+        // same number of points as testMonaceFoot results but longer distance due to elevation difference
+        List<OneRun> list = createMonacoFoot();
+        list.get(0).setDistance(1, 1634);
+        list.get(1).setDistance(1, 3610);
+        list.get(2).setDistance(1, 2182);
+        list.get(3).setDistance(1, 1498);
+
+        runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
+                list, "FOOT", true, "FOOT", "shortest", true);
+        assertEquals(testCollector.toString(), 0, testCollector.errors.size());
+    }
+
+    @Test
+    public void testMonacoBike3D_twoSpeedsPerEdge()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(43.730729, 7.421288, 43.727697, 7.419199, 1566, 84));
-        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3435, 123));
-        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2085, 89));
-        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1421, 78));
+        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 1724, 85));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3835, 171));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2425, 122));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1610, 85));
+
+        // try reverse direction
+        list.add(new OneRun(43.727687, 7.418737, 43.730864, 7.420771, 2624, 116));
+        list.add(new OneRun(43.74958, 7.436566, 43.727687, 7.418737, 4255, 159));
+        list.add(new OneRun(43.739213, 7.427806, 43.728677, 7.41016, 2852, 149));
+        list.add(new OneRun(43.739662, 7.424355, 43.733802, 7.413433, 1869, 110));
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "FOOT", true, "FOOT", "shortest");
+                list, "BIKE2", true, "BIKE2", "fastest", true);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -152,12 +207,12 @@ public void testMonacoFoot()
     public void testMonacoBike()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 1641, 76));
-        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3580, 133));
-        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 100));
-        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1434, 80));
+        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 1641, 85));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3580, 163));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 121));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1434, 89));
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "BIKE", true, "BIKE", "shortest");
+                list, "BIKE", true, "BIKE", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -165,16 +220,16 @@ public void testMonacoBike()
     public void testMonacoMountainBike()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 2332, 102));
-        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3588, 135));
-        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 100));
-        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1475, 80));
+        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 2332, 107));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3588, 165));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 121));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1475, 88));
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "MTB", true, "MTB", "fastest");
+                list, "MTB", true, "MTB", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
 
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "BIKE,MTB,RACINGBIKE", false, "MTB", "fastest");
+                list, "BIKE,MTB,RACINGBIKE", false, "MTB", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -182,16 +237,16 @@ public void testMonacoMountainBike()
     public void testMonacoRacingBike()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 2597, 110));
-        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3615, 155));
-        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 100));
-        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1490, 74));
+        list.add(new OneRun(43.730864, 7.420771, 43.727687, 7.418737, 2597, 115));
+        list.add(new OneRun(43.727687, 7.418737, 43.74958, 7.436566, 3615, 179));
+        list.add(new OneRun(43.728677, 7.41016, 43.739213, 7.427806, 2323, 121));
+        list.add(new OneRun(43.733802, 7.413433, 43.739662, 7.424355, 1490, 84));
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "RACINGBIKE", true, "RACINGBIKE", "fastest");
+                list, "RACINGBIKE", true, "RACINGBIKE", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
 
         runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
-                list, "CAR,BIKE,RACINGBIKE", false, "RACINGBIKE", "fastest");
+                list, "CAR,BIKE,RACINGBIKE", false, "RACINGBIKE", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -199,16 +254,16 @@ public void testMonacoRacingBike()
     public void testKremsBikeRelation()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(48.409523, 15.602394, 48.375466, 15.72916, 12489, 141));
-        list.add(new OneRun(48.410061, 15.63951, 48.411386, 15.604899, 3077, 75));
-        list.add(new OneRun(48.412294, 15.62007, 48.398306, 15.609667, 3965, 85));
+        list.add(new OneRun(48.409523, 15.602394, 48.375466, 15.72916, 12489, 155));
+        list.add(new OneRun(48.410061, 15.63951, 48.411386, 15.604899, 3077, 81));
+        list.add(new OneRun(48.412294, 15.62007, 48.398306, 15.609667, 3965, 93));
 
         runAlgo(testCollector, "files/krems.osm.gz", "target/graph-krems",
-                list, "BIKE", true, "BIKE", "fastest");
+                list, "BIKE", true, "BIKE", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
 
         runAlgo(testCollector, "files/krems.osm.gz", "target/graph-krems",
-                list, "CAR,BIKE,MTB", false, "BIKE", "fastest");
+                list, "CAR,BIKE,MTB", false, "BIKE", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -216,24 +271,24 @@ public void testKremsBikeRelation()
     public void testKremsMountainBikeRelation()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(48.409523, 15.602394, 48.375466, 15.72916, 12479, 141));
-        list.add(new OneRun(48.410061, 15.63951, 48.411386, 15.604899, 3164, 83));
-        list.add(new OneRun(48.412294, 15.62007, 48.398306, 15.609667, 3965, 86));
+        list.add(new OneRun(48.409523, 15.602394, 48.375466, 15.72916, 12479, 153));
+        list.add(new OneRun(48.410061, 15.63951, 48.411386, 15.604899, 3164, 91));
+        list.add(new OneRun(48.412294, 15.62007, 48.398306, 15.609667, 3965, 93));
 
         runAlgo(testCollector, "files/krems.osm.gz", "target/graph-krems",
-                list, "MTB", true, "MTB", "fastest");
+                list, "MTB", true, "MTB", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
 
         runAlgo(testCollector, "files/krems.osm.gz", "target/graph-krems",
-                list, "CAR,BIKE,MTB", false, "MTB", "fastest");
+                list, "CAR,BIKE,MTB", false, "MTB", "fastest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
     List<OneRun> createAndorra()
     {
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(42.56819, 1.603231, 42.571034, 1.520662, 17710, 446));
-        list.add(new OneRun(42.529176, 1.571302, 42.571034, 1.520662, 11411, 259));
+        list.add(new OneRun(42.56819, 1.603231, 42.571034, 1.520662, 17710, 498));
+        list.add(new OneRun(42.529176, 1.571302, 42.571034, 1.520662, 11408, 287));
         return list;
     }
 
@@ -241,7 +296,7 @@ public void testKremsMountainBikeRelation()
     public void testAndorra()
     {
         runAlgo(testCollector, "files/andorra.osm.gz", "target/graph-andorra",
-                createAndorra(), "CAR", true, "CAR", "shortest");
+                createAndorra(), "CAR", true, "CAR", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -249,7 +304,7 @@ public void testAndorra()
     public void testAndorraPbf()
     {
         runAlgo(testCollector, "files/andorra.osm.pbf", "target/graph-andorra",
-                createAndorra(), "CAR", true, "CAR", "shortest");
+                createAndorra(), "CAR", true, "CAR", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -257,13 +312,13 @@ public void testAndorraPbf()
     public void testAndorraFoot()
     {
         List<OneRun> list = createAndorra();
-        list.get(0).dist = 16354;
-        list.get(0).locs = 523;
-        list.get(1).dist = 12704;
-        list.get(1).locs = 404;
+        list.get(0).setDistance(1, 16354);
+        list.get(0).setLocs(1, 633);
+        list.get(1).setDistance(1, 12701);
+        list.get(1).setLocs(1, 427);
 
         runAlgo(testCollector, "files/andorra.osm.gz", "target/graph-andorra",
-                list, "FOOT", true, "FOOT", "shortest");
+                list, "FOOT", true, "FOOT", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
@@ -276,26 +331,50 @@ public void testCampoGrande()
         //   | ./bin/osmosis --read-xml enableDateParsing=no file=- --bounding-box top=-20.4 left=-54.6 bottom=-20.6 right=-54.5 --write-xml file=- 
         //   | bzip2 > campo-grande.extracted.osm.bz2
         List<OneRun> list = new ArrayList<OneRun>();
-        list.add(new OneRun(-20.4, -54.6, -20.6, -54.54, 25515, 253));
+        list.add(new OneRun(-20.4, -54.6, -20.6, -54.54, 25515, 267));
         list.add(new OneRun(-20.43, -54.54, -20.537, -54.674, 18009, 234));
         runAlgo(testCollector, "files/campo-grande.osm.gz", "target/graph-campo-grande", list,
-                "CAR", false, "CAR", "shortest");
+                "CAR", false, "CAR", "shortest", false);
+        assertEquals(testCollector.toString(), 0, testCollector.errors.size());
+    }
+
+    @Test
+    public void testMonacoVia()
+    {
+        OneRun oneRun = new OneRun();
+        oneRun.add(43.730729, 7.42135, 0, 0);
+        oneRun.add(43.727697, 7.419199, 2581, 102);
+        oneRun.add(43.726387, 7.4, 3001, 89);
+
+        List<OneRun> list = new ArrayList<OneRun>();
+        list.add(oneRun);
+
+        runAlgo(testCollector, "files/monaco.osm.gz", "target/graph-monaco",
+                list, "CAR", true, "CAR", "shortest", false);
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
     }
 
     void runAlgo( TestAlgoCollector testCollector, String osmFile,
             String graphFile, List<OneRun> forEveryAlgo, String importVehicles,
-            boolean ch, String vehicle, String weightCalcStr )
+            boolean ch, String vehicle, String weightCalcStr, boolean is3D )
     {
         AlgorithmPreparation tmpPrepare = null;
         OneRun tmpOneRun = null;
         try
         {
             Helper.removeDir(new File(graphFile));
-            GraphHopper hopper = new GraphHopper().setInMemory(true).setOSMFile(osmFile).
+            GraphHopper hopper = new GraphHopper().
+                    setInMemory(true).
+                    // avoid that path.getDistance is too different to path.getPoint.calcDistance
+                    setWayPointMaxDistance(0.1).
+                    setOSMFile(osmFile).
                     disableCHShortcuts().
-                    setGraphHopperLocation(graphFile).setEncodingManager(new EncodingManager(importVehicles)).
-                    importOrLoad();
+                    setGraphHopperLocation(graphFile).
+                    setEncodingManager(new EncodingManager(importVehicles));
+            if (is3D)
+                hopper.setElevationProvider(new SRTMProvider().setCacheDir(new File("./files")));
+
+            hopper.importOrLoad();
 
             FlagEncoder encoder = hopper.getEncodingManager().getEncoder(vehicle);
             Weighting weighting = new ShortestWeighting();
@@ -312,9 +391,8 @@ void runAlgo( TestAlgoCollector testCollector, String osmFile,
                 for (OneRun oneRun : forEveryAlgo)
                 {
                     tmpOneRun = oneRun;
-                    QueryResult from = idx.findClosest(oneRun.fromLat, oneRun.fromLon, edgeFilter);
-                    QueryResult to = idx.findClosest(oneRun.toLat, oneRun.toLon, edgeFilter);
-                    testCollector.assertDistance(tmpPrepare.createAlgo(), from, to, oneRun.dist, oneRun.locs);
+                    List<QueryResult> list = oneRun.getList(idx, edgeFilter);
+                    testCollector.assertDistance(tmpPrepare, list, oneRun);
                 }
             }
         } catch (Exception ex)
@@ -326,7 +404,7 @@ void runAlgo( TestAlgoCollector testCollector, String osmFile,
                     + ", file " + osmFile, ex);
         } finally
         {
-            Helper.removeDir(new File(graphFile));
+            // Helper.removeDir(new File(graphFile));
         }
     }
 
@@ -379,8 +457,11 @@ public void testMonacoParallel() throws IOException
         String graphFile = "target/graph-monaco";
         Helper.removeDir(new File(graphFile));
         final EncodingManager encodingManager = new EncodingManager("CAR");
-        GraphHopper hopper = new GraphHopper().setInMemory(true).setEncodingManager(encodingManager).
+        GraphHopper hopper = new GraphHopper().
+                setInMemory(true).
+                setEncodingManager(encodingManager).
                 disableCHShortcuts().
+                setWayPointMaxDistance(0.1).
                 setOSMFile("files/monaco.osm.gz").setGraphHopperLocation(graphFile).
                 importOrLoad();
         final Graph g = hopper.getGraph();
@@ -415,9 +496,14 @@ public void testMonacoParallel() throws IOException
                         public void run()
                         {
                             OneRun oneRun = instances.get(instanceIndex);
-                            QueryResult from = idx.findClosest(oneRun.fromLat, oneRun.fromLon, filter);
-                            QueryResult to = idx.findClosest(oneRun.toLat, oneRun.toLon, filter);
-                            testCollector.assertDistance(algo, from, to, oneRun.dist, oneRun.locs);
+                            testCollector.assertDistance(new NoOpAlgorithmPreparation()
+                            {
+                                @Override
+                                public RoutingAlgorithm createAlgo()
+                                {
+                                    return algo;
+                                }
+                            }, oneRun.getList(idx, filter), oneRun);
                             integ.addAndGet(1);
                         }
                     };
@@ -440,29 +526,6 @@ public void run()
 
         assertEquals(MAX * algosLength * instances.size(), integ.get());
         assertEquals(testCollector.toString(), 0, testCollector.errors.size());
-    }
-
-    static class OneRun
-    {
-        double fromLat, fromLon;
-        double toLat, toLon;
-        double dist;
-        int locs;
-
-        public OneRun( double fromLat, double fromLon, double toLat, double toLon, double dist, int locs )
-        {
-            this.fromLat = fromLat;
-            this.fromLon = fromLon;
-            this.toLat = toLat;
-            this.toLon = toLon;
-            this.dist = dist;
-            this.locs = locs;
-        }
-
-        @Override
-        public String toString()
-        {
-            return fromLat + "," + fromLon + " -> " + toLat + "," + toLon + " with dist " + dist + " and locs " + locs;
-        }
+        hopper.close();
     }
 }
diff --git a/core/src/test/java/com/graphhopper/routing/ch/DijkstraBidirectionCHTest.java b/core/src/test/java/com/graphhopper/routing/ch/DijkstraBidirectionCHTest.java
index 2f23cd5edc..7a2cd5e0cf 100644
--- a/core/src/test/java/com/graphhopper/routing/ch/DijkstraBidirectionCHTest.java
+++ b/core/src/test/java/com/graphhopper/routing/ch/DijkstraBidirectionCHTest.java
@@ -19,6 +19,7 @@
 
 import com.graphhopper.routing.AbstractRoutingAlgorithmTester;
 import com.graphhopper.routing.Path;
+import com.graphhopper.routing.util.Bike2WeightFlagEncoder;
 import com.graphhopper.routing.util.CarFlagEncoder;
 import com.graphhopper.routing.util.EncodingManager;
 import com.graphhopper.routing.util.FlagEncoder;
@@ -50,7 +51,7 @@ public Graph getMatrixGraph()
     {
         if (preparedMatrixGraph == null)
         {
-            LevelGraph lg = createGraph();
+            LevelGraph lg = (LevelGraph) createGraph(false);
             getMatrixAlikeGraph().copyTo(lg);
             prepareGraph(lg);
             preparedMatrixGraph = lg;
@@ -59,9 +60,9 @@ public Graph getMatrixGraph()
     }
 
     @Override
-    protected LevelGraph createGraph()
+    protected LevelGraph createGraph( EncodingManager em, boolean is3D )
     {
-        return new GraphBuilder(encodingManager).levelGraphCreate();
+        return new GraphBuilder(em).set3D(is3D).levelGraphCreate();
     }
 
     @Override
@@ -78,10 +79,13 @@ public PrepareContractionHierarchies prepareGraph( Graph g, FlagEncoder encoder,
     @Test
     public void testPathRecursiveUnpacking()
     {
-        LevelGraphStorage g2 = (LevelGraphStorage) createGraph();
+        // use an encoder where it is possible to store 2 weights per edge
+        FlagEncoder encoder = new Bike2WeightFlagEncoder();
+        EncodingManager em = new EncodingManager(encoder);
+        LevelGraphStorage g2 = (LevelGraphStorage) createGraph(em, false);
         g2.edge(0, 1, 1, true);
-        EdgeIteratorState iter1_1 = g2.edge(0, 2, 1.4, true);
-        EdgeIteratorState iter1_2 = g2.edge(2, 5, 1.4, true);
+        EdgeIteratorState iter1_1 = g2.edge(0, 2, 1.4, false);
+        EdgeIteratorState iter1_2 = g2.edge(2, 5, 1.4, false);
         g2.edge(1, 2, 1, true);
         g2.edge(1, 3, 3, true);
         g2.edge(2, 3, 1, true);
@@ -90,17 +94,16 @@ public void testPathRecursiveUnpacking()
         g2.edge(3, 5, 1, true);
         g2.edge(5, 6, 1, true);
         g2.edge(4, 6, 1, true);
-        g2.edge(5, 7, 1.4, true);
         g2.edge(6, 7, 1, true);
+        EdgeIteratorState iter2_2 = g2.edge(5, 7);
+        iter2_2.setDistance(1.4).setFlags(encoder.setProperties(10, true, false));
 
         // simulate preparation
-        EdgeIteratorState iter2_2 = g2.edge(5, 7);
-        iter2_2.setDistance(1.4).setFlags(carEncoder.setProperties(0, true, true));
         EdgeSkipIterState iter2_1 = g2.shortcut(0, 5);
-        iter2_1.setDistance(2.8).setFlags(carEncoder.setProperties(0, true, true));
+        iter2_1.setDistance(2.8).setFlags(encoder.setProperties(10, true, false));
         iter2_1.setSkippedEdges(iter1_1.getEdge(), iter1_2.getEdge());
         EdgeSkipIterState tmp = g2.shortcut(0, 7);
-        tmp.setDistance(4.2).setFlags(carEncoder.setProperties(0, true, true));
+        tmp.setDistance(4.2).setFlags(encoder.setProperties(10, true, false));
         tmp.setSkippedEdges(iter2_1.getEdge(), iter2_2.getEdge());
         g2.setLevel(1, 0);
         g2.setLevel(3, 1);
@@ -111,9 +114,11 @@ public void testPathRecursiveUnpacking()
         g2.setLevel(7, 6);
         g2.setLevel(0, 7);
 
-        Path p = new PrepareContractionHierarchies(carEncoder, new ShortestWeighting()).setGraph(g2).createAlgo().calcPath(0, 7);
+        Path p = new PrepareContractionHierarchies(encoder, new ShortestWeighting()).
+                setGraph(g2).createAlgo().calcPath(0, 7);
+
         assertEquals(Helper.createTList(0, 2, 5, 7), p.calcNodes());
-        assertEquals(4, p.calcNodes().size());
+        assertEquals(1064, p.getMillis());
         assertEquals(4.2, p.getDistance(), 1e-5);
     }
 
@@ -124,15 +129,15 @@ public void testCalcFootPath()
         FlagEncoder tmpFootEncoder = footEncoder;
         FlagEncoder tmpCarEncoder = carEncoder;
         carEncoder = new CarFlagEncoder()
-        {            
+        {
             @Override
             public long setProperties( double speed, boolean forward, boolean backward )
             {
                 return 0;
-            }                        
+            }
         };
-        
-        footEncoder = new EncodingManager("FOOT").getSingle();        
+
+        footEncoder = new EncodingManager("FOOT").getSingle();
         super.testCalcFootPath();
         footEncoder = tmpFootEncoder;
         carEncoder = tmpCarEncoder;
diff --git a/core/src/test/java/com/graphhopper/routing/ch/PrepareContractionHierarchiesTest.java b/core/src/test/java/com/graphhopper/routing/ch/PrepareContractionHierarchiesTest.java
index 3b5b834f6f..18cd029095 100644
--- a/core/src/test/java/com/graphhopper/routing/ch/PrepareContractionHierarchiesTest.java
+++ b/core/src/test/java/com/graphhopper/routing/ch/PrepareContractionHierarchiesTest.java
@@ -204,7 +204,7 @@ public void testDirectedGraph3()
 
         // both dirs
         assertTrue(sc1.toString(), sc1.from == 3 && sc1.to == 2);
-        assertTrue(sc1.toString(), carEncoder.isBoth(sc1.flags));
+        assertTrue(sc1.toString(), carEncoder.isForward(sc1.flags) && carEncoder.isBackward(sc1.flags));
 
         // directed
         assertTrue(sc2.toString(), sc2.from == 2 && sc2.to == 3);
@@ -298,17 +298,17 @@ public void testFindShortcuts_Roundabout()
 
         PrepareContractionHierarchies prepare = new PrepareContractionHierarchies(carEncoder, weighting).setGraph(g);
         EdgeSkipIterState tmp = g.shortcut(1, 4);
-        tmp.setFlags(prepare.getScBothDir());
-        tmp.setWeight(2);        
+        tmp.setFlags(PrepareEncoder.getScDirMask());
+        tmp.setWeight(2);
         tmp.setSkippedEdges(iter1_1.getEdge(), iter1_2.getEdge());
-        long f = prepare.getScFwdDir();
+        long f = PrepareEncoder.getScFwdDir();
         tmp = g.shortcut(4, 6);
         tmp.setFlags(f);
-        tmp.setWeight(2);        
+        tmp.setWeight(2);
         tmp.setSkippedEdges(iter2_1.getEdge(), iter2_2.getEdge());
         tmp = g.shortcut(6, 4);
         tmp.setFlags(f);
-        tmp.setWeight(3);        
+        tmp.setWeight(3);
         tmp.setSkippedEdges(iter3_1.getEdge(), iter3_2.getEdge());
 
         prepare.initFromGraph();
@@ -329,7 +329,7 @@ void initUnpackingGraph( LevelGraphStorage g, Weighting w )
         EdgeIteratorState iter4 = g.edge(3, 4).setDistance(dist).setFlags(flags);
         EdgeIteratorState iter5 = g.edge(4, 5).setDistance(dist).setFlags(flags);
         EdgeIteratorState iter6 = g.edge(5, 6).setDistance(dist).setFlags(flags);
-        long oneDirFlags = new PrepareContractionHierarchies(carEncoder, w).getScFwdDir();
+        long oneDirFlags = PrepareEncoder.getScFwdDir();
 
         int tmp = iterTmp1.getEdge();
         EdgeSkipIterState sc1 = g.shortcut(0, 2);
@@ -403,6 +403,30 @@ public void testCircleBug()
         assertEquals(0, prepare.getShortcuts());
     }
 
+    @Test
+    public void testBug178()
+    {
+        // 5--------6__
+        // |        |  \
+        // 0-1->-2--3--4
+        //   \-<-/
+        //
+        LevelGraph g = createGraph();
+        g.edge(1, 2, 1, false);
+        g.edge(2, 1, 1, false);
+        
+        g.edge(5, 0, 1, true);
+        g.edge(5, 6, 1, true);
+        g.edge(0, 1, 1, true);
+        g.edge(2, 3, 1, true);
+        g.edge(3, 4, 1, true);
+        g.edge(6, 3, 1, true);
+        
+        PrepareContractionHierarchies prepare = new PrepareContractionHierarchies(carEncoder, weighting).setGraph(g);
+        prepare.doWork();
+        assertEquals(2, prepare.getShortcuts());
+    }
+
     // 0-1-2-3-4
     // |     / |
     // |    8  |
diff --git a/core/src/test/java/com/graphhopper/routing/ch/PrepareEncoderTest.java b/core/src/test/java/com/graphhopper/routing/ch/PrepareEncoderTest.java
new file mode 100644
index 0000000000..27e3d9415e
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/routing/ch/PrepareEncoderTest.java
@@ -0,0 +1,48 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.routing.ch;
+
+import org.junit.Test;
+import static org.junit.Assert.*;
+
+/**
+ *
+ * @author Peter Karich
+ */
+public class PrepareEncoderTest
+{
+
+    @Test
+    public void testOverwrite()
+    {
+        long forward = PrepareEncoder.getScFwdDir();
+        long backward = PrepareEncoder.getScFwdDir() ^ PrepareEncoder.getScDirMask();
+        long both = PrepareEncoder.getScDirMask();
+        assertTrue(PrepareEncoder.canBeOverwritten(forward, forward));
+        assertTrue(PrepareEncoder.canBeOverwritten(backward, backward));
+        assertTrue(PrepareEncoder.canBeOverwritten(forward, both));
+        assertTrue(PrepareEncoder.canBeOverwritten(backward, both));
+
+        assertTrue(PrepareEncoder.canBeOverwritten(both, both));
+        assertFalse(PrepareEncoder.canBeOverwritten(both, forward));
+        assertFalse(PrepareEncoder.canBeOverwritten(both, backward));
+        assertFalse(PrepareEncoder.canBeOverwritten(forward, backward));
+        assertFalse(PrepareEncoder.canBeOverwritten(backward, forward));
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/routing/util/AbstractBikeFlagEncoderTester.java b/core/src/test/java/com/graphhopper/routing/util/AbstractBikeFlagEncoderTester.java
index 35d6f89deb..8d5c0e0bfc 100644
--- a/core/src/test/java/com/graphhopper/routing/util/AbstractBikeFlagEncoderTester.java
+++ b/core/src/test/java/com/graphhopper/routing/util/AbstractBikeFlagEncoderTester.java
@@ -58,8 +58,8 @@ public String encodeDecodeWayType( String name, OSMWay way )
     {
         long allowed = encoder.acceptBit;
         long flags = encoder.handleWayTags(way, allowed, 0);
-        int pavement = encoder.getPavementCode(flags);
-        int wayType = encoder.getWayTypeCode(flags);
+        int pavement = encoder.getPavementType(flags);
+        int wayType = encoder.getWayType(flags);
 
         TranslationMap.Translation enMap = SINGLETON.getWithFallBack(Locale.UK);
         return InstructionList.getWayName(name, pavement, wayType, enMap);
@@ -68,118 +68,116 @@ public String encodeDecodeWayType( String name, OSMWay way )
     @Test
     public void testAccess()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
+        OSMWay way = new OSMWay(1);
 
-        map.put("highway", "motorway");
+        way.setTag("highway", "motorway");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.put("highway", "footway");
+        way.setTag("highway", "footway");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("bicycle", "no");
+        way.setTag("bicycle", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.put("highway", "footway");
-        map.put("bicycle", "yes");
+        way.setTag("highway", "footway");
+        way.setTag("bicycle", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("highway", "pedestrian");
-        map.put("bicycle", "no");
+        way.setTag("highway", "pedestrian");
+        way.setTag("bicycle", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.put("highway", "pedestrian");
-        map.put("bicycle", "yes");
+        way.setTag("highway", "pedestrian");
+        way.setTag("bicycle", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("bicycle", "yes");
-        map.put("highway", "cycleway");
+        way.setTag("bicycle", "yes");
+        way.setTag("highway", "cycleway");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "path");
+        way.clearTags();
+        way.setTag("highway", "path");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("highway", "path");
-        map.put("bicycle", "yes");
+        way.setTag("highway", "path");
+        way.setTag("bicycle", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
-        map.clear();
+        way.clearTags();
 
-        map.put("highway", "track");
-        map.put("bicycle", "yes");
+        way.setTag("highway", "track");
+        way.setTag("bicycle", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
-        map.clear();
+        way.clearTags();
 
-        map.put("highway", "track");
+        way.setTag("highway", "track");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("mtb", "yes");
+        way.setTag("mtb", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "path");
-        map.put("foot", "official");
+        way.clearTags();
+        way.setTag("highway", "path");
+        way.setTag("foot", "official");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.put("bicycle", "official");
+        way.setTag("bicycle", "official");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "service");
-        map.put("access", "no");
+        way.clearTags();
+        way.setTag("highway", "service");
+        way.setTag("access", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "tertiary");
-        map.put("motorroad", "yes");
+        way.clearTags();
+        way.setTag("highway", "tertiary");
+        way.setTag("motorroad", "yes");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "track");
-        map.put("ford", "yes");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("ford", "yes");
         assertFalse(encoder.acceptWay(way) > 0);
-        map.put("bicycle", "yes");
+        way.setTag("bicycle", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("route", "ferry");
+        way.clearTags();
+        way.setTag("route", "ferry");
         assertTrue(encoder.acceptWay(way) > 0);
-        map.put("bicycle", "no");
+        way.setTag("bicycle", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("route", "ferry");
-        map.put("foot", "yes");
+        way.clearTags();
+        way.setTag("route", "ferry");
+        way.setTag("foot", "yes");
         assertFalse(encoder.acceptWay(way) > 0);
     }
 
     @Test
     public void testTramStations()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
-        map.put("highway", "secondary");
-        map.put("railway", "rail");
+        OSMWay way = new OSMWay(1);
+        way.setTag("highway", "secondary");
+        way.setTag("railway", "rail");
         // disallow rail
         assertEquals(0, encoder.acceptWay(way));
 
-        way = new OSMWay(1, map);
-        map.put("highway", "secondary");
-        map.put("railway", "station");
+        way = new OSMWay(1);
+        way.setTag("highway", "secondary");
+        way.setTag("railway", "station");
         // disallow stations
         assertEquals(0, encoder.acceptWay(way));
 
-        way = new OSMWay(1, map);
-        map.put("highway", "secondary");
-        map.put("railway", "station");
-        map.put("bicycle", "yes");
+        way = new OSMWay(1);
+        way.setTag("highway", "secondary");
+        way.setTag("railway", "station");
+        way.setTag("bicycle", "yes");
         // allow stations if explicitely tagged
         assertNotSame(0, encoder.acceptWay(way));
 
-        way = new OSMWay(1, map);
-        map.put("highway", "secondary");
-        map.put("railway", "station");
-        map.put("bicycle", "no");
+        way = new OSMWay(1);
+        way.setTag("highway", "secondary");
+        way.setTag("railway", "station");
+        way.setTag("bicycle", "no");
         // disallow
         assertEquals(0, encoder.acceptWay(way));
     }
@@ -187,53 +185,52 @@ public void testTramStations()
     @Test
     public void testHandleCommonWayTags()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, wayMap);
+        OSMWay way = new OSMWay(1);
         String wayType;
 
-        wayMap.put("highway", "steps");
+        way.setTag("highway", "steps");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section", wayType);
 
-        wayMap.put("highway", "steps");
+        way.setTag("highway", "steps");
         wayType = encodeDecodeWayType("Famous steps", way);
         assertEquals("Famous steps, pushing section", wayType);
 
-        wayMap.put("highway", "footway");
+        way.setTag("highway", "footway");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section", wayType);
 
-        wayMap.put("highway", "footway");
-        wayMap.put("surface", "pebblestone");
+        way.setTag("highway", "footway");
+        way.setTag("surface", "pebblestone");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section", wayType);
 
-        wayMap.put("highway", "residential");
+        way.setTag("highway", "residential");
         wayType = encodeDecodeWayType("", way);
         assertEquals("road", wayType);
 
-        wayMap.put("highway", "cycleway");
+        way.setTag("highway", "cycleway");
         wayType = encodeDecodeWayType("", way);
         assertEquals("cycleway", wayType);
 
-        wayMap.put("surface", "grass");
+        way.setTag("surface", "grass");
         wayType = encodeDecodeWayType("", way);
         assertEquals("cycleway, unpaved", wayType);
 
-        wayMap.put("surface", "asphalt");
+        way.setTag("surface", "asphalt");
         wayType = encodeDecodeWayType("", way);
         assertEquals("cycleway", wayType);
 
-        wayMap.put("highway", "footway");
-        wayMap.put("bicycle", "yes");
-        wayMap.put("surface", "grass");
+        way.setTag("highway", "footway");
+        way.setTag("bicycle", "yes");
+        way.setTag("surface", "grass");
         wayType = encodeDecodeWayType("", way);
         assertEquals("cycleway, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "footway");
-        wayMap.put("bicycle", "yes");
-        wayMap.put("surface", "grass");
+        way.clearTags();
+        way.setTag("highway", "footway");
+        way.setTag("bicycle", "yes");
+        way.setTag("surface", "grass");
         wayType = encodeDecodeWayType("", way);
         assertEquals("cycleway, unpaved", wayType);
     }
diff --git a/core/src/test/java/com/graphhopper/routing/util/Bike2WeightFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/Bike2WeightFlagEncoderTest.java
new file mode 100644
index 0000000000..2088078bd5
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/routing/util/Bike2WeightFlagEncoderTest.java
@@ -0,0 +1,82 @@
+/*
+ *  Licensed to Peter Karich under one or more contributor license
+ *  agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  Peter Karich licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except
+ *  in compliance with the License. You may obtain a copy of the
+ *  License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.routing.util;
+
+import com.graphhopper.reader.OSMWay;
+import com.graphhopper.storage.*;
+import com.graphhopper.util.EdgeIteratorState;
+import com.graphhopper.util.GHUtility;
+import com.graphhopper.util.Helper;
+import org.junit.Test;
+import static org.junit.Assert.*;
+
+/**
+ *
+ * @author Peter Karich
+ */
+public class Bike2WeightFlagEncoderTest
+{
+    private Graph initExampleGraph( FlagEncoder instance )
+    {
+        EncodingManager em = new EncodingManager(instance);
+        GraphStorage gs = new GraphHopperStorage(new RAMDirectory(), em, true).create(1000);
+        NodeAccess na = gs.getNodeAccess();
+        // 50--(0.0001)-->49--(0.0004)-->55--(0.0005)-->60
+        na.setNode(0, 51.1, 12.001, 50);
+        na.setNode(1, 51.1, 12.002, 60);
+        EdgeIteratorState edge = gs.edge(0, 1).
+                setWayGeometry(Helper.createPointList3D(51.1, 12.0011, 49, 51.1, 12.0015, 55));
+
+        edge.setFlags(instance.setReverseSpeed(instance.setProperties(10, true, true), 15));
+        return gs;
+    }
+
+    @Test
+    public void testApplyWayTags()
+    {
+        Bike2WeightFlagEncoder instance = new Bike2WeightFlagEncoder();
+        Graph graph = initExampleGraph(instance);
+        EdgeIteratorState edge = GHUtility.getEdge(graph, 0, 1);
+        OSMWay way = new OSMWay(1);
+        instance.applyWayTags(way, edge);
+
+        long flags = edge.getFlags();
+        // decrease speed
+        assertEquals(6, instance.getSpeed(flags), 1e-1);
+        // increase speed but use maximum speed (calculated was 24)
+        assertEquals(18, instance.getReverseSpeed(flags), 1e-1);
+    }
+
+    @Test
+    public void testSteps()
+    {
+        Bike2WeightFlagEncoder instance = new Bike2WeightFlagEncoder();
+        Graph graph = initExampleGraph(instance);
+        EdgeIteratorState edge = GHUtility.getEdge(graph, 0, 1);
+        OSMWay way = new OSMWay(1);
+        way.setTag("highway", "steps");
+        instance.applyWayTags(way, edge);
+
+        long flags = edge.getFlags();
+        // steps speed for both directions although upwards is probably harder
+        double stepSpeed = Bike2WeightFlagEncoder.PUSHING_SECTION_SPEED / 2;
+        assertEquals(stepSpeed, instance.getSpeed(flags), 1e-1);
+        assertEquals(stepSpeed, instance.getReverseSpeed(flags), 1e-1);
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/routing/util/BikeFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/BikeFlagEncoderTest.java
index b0b622e6ea..a94b0af218 100644
--- a/core/src/test/java/com/graphhopper/routing/util/BikeFlagEncoderTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/BikeFlagEncoderTest.java
@@ -19,11 +19,8 @@
 
 import com.graphhopper.reader.OSMRelation;
 import com.graphhopper.reader.OSMWay;
-import java.util.Collections;
 import org.junit.Test;
 
-import java.util.HashMap;
-import java.util.Map;
 import java.util.concurrent.atomic.AtomicInteger;
 
 import static org.junit.Assert.*;
@@ -78,123 +75,120 @@ public void testGetSpeed()
 
         way.setTag("surface", "paved");
         assertEquals(20, encoder.getSpeed(way));
-        
+
         way.clearTags();
         way.setTag("highway", "path");
         way.setTag("surface", "ground");
         assertEquals(4, encoder.getSpeed(way));
-        
+
         way.clearTags();
         way.setTag("highway", "track");
         way.setTag("bicycle", "yes");
         way.setTag("surface", "fine_gravel");
         assertEquals(18, encoder.getSpeed(way));
-        
+
         way.clearTags();
         way.setTag("highway", "track");
         way.setTag("bicycle", "yes");
         way.setTag("surface", "unknown_surface");
         assertEquals(4, encoder.getSpeed(way));
-        
+
     }
 
     @Test
     public void testHandleWayTags()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, wayMap);
+        OSMWay way = new OSMWay(1);
         String wayType;
-        
-        wayMap.put("highway", "track");
+
+        way.setTag("highway", "track");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section, unpaved", wayType);
-        
-        wayMap.clear();
-        wayMap.put("highway", "path");
+
+        way.clearTags();
+        way.setTag("highway", "path");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "path");
-        wayMap.put("surface", "grass");
+        way.clearTags();
+        way.setTag("highway", "path");
+        way.setTag("surface", "grass");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "path");
-        wayMap.put("surface", "concrete");
+        way.clearTags();
+        way.setTag("highway", "path");
+        way.setTag("surface", "concrete");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "track");
-        wayMap.put("foot", "yes");
-        wayMap.put("surface", "paved");
-        wayMap.put("tracktype", "grade1");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("foot", "yes");
+        way.setTag("surface", "paved");
+        way.setTag("tracktype", "grade1");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "track");
-        wayMap.put("foot", "yes");
-        wayMap.put("surface", "paved");
-        wayMap.put("tracktype", "grade2");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("foot", "yes");
+        way.setTag("surface", "paved");
+        way.setTag("tracktype", "grade2");
         wayType = encodeDecodeWayType("", way);
         assertEquals("pushing section, unpaved", wayType);
-        
+
     }
 
     @Test
     public void testHandleWayTagsInfluencedByRelation()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay osmWay = new OSMWay(1, wayMap);
-        wayMap.put("highway", "track");
-        long allowed=encoder.acceptBit;
+        OSMWay osmWay = new OSMWay(1);
+        osmWay.setTag("highway", "track");
+        long allowed = encoder.acceptBit;
 
-        Map<String, String> relMap = new HashMap<String, String>();
-        OSMRelation osmRel = new OSMRelation(1, relMap);
+        OSMRelation osmRel = new OSMRelation(1);
 
         long relFlags = encoder.handleRelationTags(osmRel, 0);
         // unchanged
         long flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(16, encoder.getSpeed(flags), 1e-1);
-        assertEquals(1, encoder.getWayTypeCode(flags));
-        assertEquals(1, encoder.getPavementCode(flags));
+        assertEquals(1, encoder.getWayType(flags));
+        assertEquals(1, encoder.getPavementType(flags));
 
         // relation code is PREFER
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(20, encoder.getSpeed(flags), 1e-1);
-        assertEquals(1, encoder.getWayTypeCode(flags));
-        assertEquals(1, encoder.getPavementCode(flags));
+        assertEquals(1, encoder.getWayType(flags));
+        assertEquals(1, encoder.getPavementType(flags));
 
         // relation code is VERY_NICE
-        relMap.put("network", "rcn");
+        osmRel.setTag("network", "rcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(24, encoder.getSpeed(flags), 1e-1);
 
         // relation code is OUTSTANDING_NICE
-        relMap.put("network", "ncn");
+        osmRel.setTag("network", "ncn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(28, encoder.getSpeed(flags), 1e-1);
 
         // PREFER relation, but tertiary road
         // => no pushing section but road wayTypeCode and faster
-        wayMap.clear();
-        wayMap.put("highway", "tertiary");
+        osmWay.clearTags();
+        osmWay.setTag("highway", "tertiary");
 
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(22, encoder.getSpeed(flags), 1e-1);
-        assertEquals(0, encoder.getWayTypeCode(flags));
-        
+        assertEquals(0, encoder.getWayType(flags));
+
         // test max and min speed
         final AtomicInteger fakeSpeed = new AtomicInteger(40);
         BikeFlagEncoder fakeEncoder = new BikeFlagEncoder()
@@ -213,63 +207,74 @@ int relationWeightCodeToSpeed( int highwaySpeed, int relationCode )
         assertEquals(30, fakeEncoder.getSpeed(flags), 1e-1);
 
         fakeSpeed.set(-2);
+        try
+        {
+            flags = fakeEncoder.handleWayTags(osmWay, allowed, 1);
+            assertTrue(false);
+        } catch (IllegalArgumentException ex)
+        {
+        }
+
+        fakeSpeed.set(0);
         flags = fakeEncoder.handleWayTags(osmWay, allowed, 1);
         assertEquals(0, fakeEncoder.getSpeed(flags), 1e-1);
-        
+
     }
-    
+
     @Test
-    public void testTurnFlagEncoding_noCosts() {
+    public void testTurnFlagEncoding_noCosts()
+    {
         encoder.defineTurnBits(0, 0, 0);
-        
+
         long flags_r0 = encoder.getTurnFlags(true, 0);
         long flags_0 = encoder.getTurnFlags(false, 0);
-        
+
         long flags_r20 = encoder.getTurnFlags(true, 20);
         long flags_20 = encoder.getTurnFlags(false, 20);
-        
+
         assertEquals(0, encoder.getTurnCosts(flags_r0));
         assertEquals(0, encoder.getTurnCosts(flags_0));
-        
+
         assertEquals(0, encoder.getTurnCosts(flags_r20));
         assertEquals(0, encoder.getTurnCosts(flags_20));
-        
+
         assertTrue(encoder.isTurnRestricted(flags_r0));
         assertFalse(encoder.isTurnRestricted(flags_0));
-        
+
         assertTrue(encoder.isTurnRestricted(flags_r20));
         assertFalse(encoder.isTurnRestricted(flags_20));
     }
-    
+
     @Test
-    public void testTurnFlagEncoding_withCosts() {
+    public void testTurnFlagEncoding_withCosts()
+    {
         //arbitrary shift, 7 turn cost bits: [0,127]
         encoder.defineTurnBits(0, 2, 7);
-        
+
         long flags_r0 = encoder.getTurnFlags(true, 0);
         long flags_0 = encoder.getTurnFlags(false, 0);
-        
+
         long flags_r20 = encoder.getTurnFlags(true, 20);
         long flags_20 = encoder.getTurnFlags(false, 20);
-        
+
         long flags_r220 = encoder.getTurnFlags(true, 220);
         long flags_220 = encoder.getTurnFlags(false, 220);
-        
+
         assertEquals(0, encoder.getTurnCosts(flags_r0));
         assertEquals(0, encoder.getTurnCosts(flags_0));
-        
+
         assertEquals(20, encoder.getTurnCosts(flags_r20));
         assertEquals(20, encoder.getTurnCosts(flags_20));
-        
+
         assertEquals(127, encoder.getTurnCosts(flags_r220));
         assertEquals(127, encoder.getTurnCosts(flags_220));
-        
+
         assertTrue(encoder.isTurnRestricted(flags_r0));
         assertFalse(encoder.isTurnRestricted(flags_0));
-        
+
         assertTrue(encoder.isTurnRestricted(flags_r20));
         assertFalse(encoder.isTurnRestricted(flags_20));
-        
+
         assertTrue(encoder.isTurnRestricted(flags_r220));
         assertFalse(encoder.isTurnRestricted(flags_220));
     }
diff --git a/core/src/test/java/com/graphhopper/routing/util/CarFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/CarFlagEncoderTest.java
index 7d8f1a8ee8..5af8a86c52 100644
--- a/core/src/test/java/com/graphhopper/routing/util/CarFlagEncoderTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/CarFlagEncoderTest.java
@@ -18,13 +18,8 @@
 package com.graphhopper.routing.util;
 
 import com.graphhopper.reader.OSMNode;
-import java.util.HashMap;
-import java.util.Map;
-
 import com.graphhopper.reader.OSMWay;
-
 import org.junit.Test;
-
 import static org.junit.Assert.*;
 
 /**
@@ -39,36 +34,45 @@
     @Test
     public void testAccess()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
+        OSMWay way = new OSMWay(1);
         assertFalse(encoder.acceptWay(way) > 0);
-        map.put("highway", "service");
+        way.setTag("highway", "service");
         assertTrue(encoder.acceptWay(way) > 0);
-        map.put("access", "no");
+        way.setTag("access", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "track");
-        map.put("motorcar", "no");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("motorcar", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "unclassified");
-        map.put("ford", "yes");
+        way.clearTags();
+        way.setTag("highway", "unclassified");
+        way.setTag("ford", "yes");
         assertFalse(encoder.acceptWay(way) > 0);
-        map.put("motorcar", "yes");
+        way.setTag("motorcar", "yes");
         assertTrue(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("route", "ferry");
+        way.clearTags();
+        way.setTag("route", "ferry");
         assertTrue(encoder.acceptWay(way) > 0);
-        map.put("motorcar", "no");
+        way.setTag("motorcar", "no");
         assertFalse(encoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("route", "ferry");
-        map.put("foot", "yes");
+        way.clearTags();
+        way.setTag("route", "ferry");
+        way.setTag("foot", "yes");
         assertFalse(encoder.acceptWay(way) > 0);
+
+        way.clearTags();
+        way.setTag("highway", "primary");
+        long flags = encoder.handleWayTags(way, encoder.acceptWay(way), 0);
+        assertTrue(encoder.isForward(flags));
+        assertTrue(encoder.isBackward(flags));
+        way.setTag("oneway", "yes");
+        flags = encoder.handleWayTags(way, encoder.acceptWay(way), 0);
+        assertTrue(encoder.isForward(flags));
+        assertFalse(encoder.isBackward(flags));
     }
 
     @Test
@@ -85,52 +89,69 @@ public void testSetAccess()
     }
 
     @Test
-    public void testSpeedLimitBiggerThanMaxValue()
+    public void testMaxSpeed()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
-        map.put("highway", "trunk");
-        map.put("maxspeed", "500");
+        OSMWay way = new OSMWay(1);
+        way.setTag("highway", "trunk");
+        way.setTag("maxspeed", "500");
         long allowed = encoder.acceptWay(way);
         long encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(100, encoder.getSpeed(encoded), 1e-1);
+
+        way = new OSMWay(1);
+        way.setTag("highway", "primary");
+        way.setTag("maxspeed:backward", "10");
+        way.setTag("maxspeed:forward", "20");
+        encoded = encoder.handleWayTags(way, encoder.acceptWay(way), 0);
+        assertEquals(10, encoder.getSpeed(encoded), 1e-1);
+        
+        way = new OSMWay(1);
+        way.setTag("highway", "primary");
+        way.setTag("maxspeed:forward", "20");
+        encoded = encoder.handleWayTags(way, encoder.acceptWay(way), 0);
+        assertEquals(20, encoder.getSpeed(encoded), 1e-1);
+        
+        way = new OSMWay(1);
+        way.setTag("highway", "primary");
+        way.setTag("maxspeed:backward", "20");
+        encoded = encoder.handleWayTags(way, encoder.acceptWay(way), 0);
+        assertEquals(20, encoder.getSpeed(encoded), 1e-1);
     }
 
     @Test
     public void testSpeed()
     {
         // limit bigger than default road speed
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
-        map.put("highway", "trunk");
-        map.put("maxspeed", "110");
+        OSMWay way = new OSMWay(1);
+        way.setTag("highway", "trunk");
+        way.setTag("maxspeed", "110");
         long allowed = encoder.acceptWay(way);
         long encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(100, encoder.getSpeed(encoded), 1e-1);
 
-        map.clear();
-        map.put("highway", "residential");
-        map.put("surface", "cobblestone");
+        way.clearTags();
+        way.setTag("highway", "residential");
+        way.setTag("surface", "cobblestone");
         allowed = encoder.acceptWay(way);
         encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(30, encoder.getSpeed(encoded), 1e-1);
 
-        map.clear();
-        map.put("highway", "track");
+        way.clearTags();
+        way.setTag("highway", "track");
         allowed = encoder.acceptWay(way);
         encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(15, encoder.getSpeed(encoded), 1e-1);
 
-        map.clear();
-        map.put("highway", "track");
-        map.put("tracktype", "grade1");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("tracktype", "grade1");
         allowed = encoder.acceptWay(way);
         encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(20, encoder.getSpeed(encoded), 1e-1);
 
-        map.clear();
-        map.put("highway", "track");
-        map.put("tracktype", "grade5");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("tracktype", "grade5");
         allowed = encoder.acceptWay(way);
         encoded = encoder.handleWayTags(way, allowed, 0);
         assertEquals(5, encoder.getSpeed(encoded), 1e-1);
@@ -170,11 +191,11 @@ public void testRailway()
         way.setTag("motorcar", "yes");
         way.setTag("bicycle", "no");
         way.setTag("duration", "35");
-        way.setInternalTag("estimated_distance", 50000);
+        way.setTag("estimated_distance", 50000);
         // accept
         assertNotSame(0, encoder.acceptWay(way));
         // calculate speed from estimated_distance and duration
-        assertEquals(60, encoder.getSpeed(encoder.handleFerry(way, 20, 30, 40)), 1e-1);
+        assertEquals(60, encoder.getSpeed(encoder.handleFerryTags(way, 20, 30, 40)), 1e-1);
     }
 
     @Test
@@ -182,44 +203,24 @@ public void testBasics()
     {
         assertTrue(encoder.isForward(encoder.flagsDefault(true, true)));
         assertTrue(encoder.isBackward(encoder.flagsDefault(true, true)));
-        assertTrue(encoder.isBoth(encoder.flagsDefault(true, true)));
 
         assertTrue(encoder.isForward(encoder.flagsDefault(true, false)));
         assertFalse(encoder.isBackward(encoder.flagsDefault(true, false)));
-        assertFalse(encoder.isBoth(encoder.flagsDefault(true, false)));
-    }
-
-    @Test
-    public void testOverwrite()
-    {
-        long forward = encoder.setProperties(10, true, false);
-        long backward = encoder.swapDirection(forward);
-        long both = encoder.setProperties(20, true, true);
-        assertTrue(encoder.canBeOverwritten(forward, forward));
-        assertTrue(encoder.canBeOverwritten(backward, backward));
-        assertTrue(encoder.canBeOverwritten(forward, both));
-        assertTrue(encoder.canBeOverwritten(backward, both));
-
-        assertTrue(encoder.canBeOverwritten(both, both));
-        assertFalse(encoder.canBeOverwritten(both, forward));
-        assertFalse(encoder.canBeOverwritten(both, backward));
-        assertFalse(encoder.canBeOverwritten(forward, backward));
-        assertFalse(encoder.canBeOverwritten(backward, forward));
     }
 
     @Test
     public void testSwapDir()
     {
-        long swappedFlags = encoder.swapDirection(encoder.flagsDefault(true, true));
+        long swappedFlags = encoder.reverseFlags(encoder.flagsDefault(true, true));
         assertTrue(encoder.isForward(swappedFlags));
         assertTrue(encoder.isBackward(swappedFlags));
 
-        swappedFlags = encoder.swapDirection(encoder.flagsDefault(true, false));
+        swappedFlags = encoder.reverseFlags(encoder.flagsDefault(true, false));
 
         assertFalse(encoder.isForward(swappedFlags));
         assertTrue(encoder.isBackward(swappedFlags));
 
-        assertEquals(0, encoder.swapDirection(0));
+        assertEquals(0, encoder.reverseFlags(0));
     }
 
     @Test
@@ -229,27 +230,27 @@ public void testBarrierAccess()
         node.setTag("barrier", "lift_gate");
         node.setTag("access", "yes");
         // no barrier!
-        assertTrue(encoder.analyzeNodeTags(node) == 0);
+        assertTrue(encoder.handleNodeTags(node) == 0);
 
         node = new OSMNode(1, -1, -1);
         node.setTag("barrier", "lift_gate");
         node.setTag("bicycle", "yes");
         // barrier!
-        assertTrue(encoder.analyzeNodeTags(node) > 0);
+        assertTrue(encoder.handleNodeTags(node) > 0);
 
         node = new OSMNode(1, -1, -1);
         node.setTag("barrier", "lift_gate");
         node.setTag("access", "yes");
         node.setTag("bicycle", "yes");
         // should this be a barrier for motorcars too?
-        // assertTrue(encoder.analyzeNodeTags(node) > 0);
+        // assertTrue(encoder.handleNodeTags(node) > 0);
 
         node = new OSMNode(1, -1, -1);
         node.setTag("barrier", "lift_gate");
         node.setTag("access", "no");
         node.setTag("motorcar", "yes");
         // no barrier!
-        assertTrue(encoder.analyzeNodeTags(node) == 0);
+        assertTrue(encoder.handleNodeTags(node) == 0);
     }
 
     @Test
@@ -322,7 +323,7 @@ public void testMaxValue()
 
         // double speed = AbstractFlagEncoder.parseSpeed("70 mph");
         // => 112.654 * 0.9 => 101
-        instance.swapDirection(flags);
+        flags = instance.reverseFlags(flags);
         assertEquals(100, instance.getSpeed(flags), 1e-1);
     }
 
diff --git a/core/src/test/java/com/graphhopper/routing/util/EncodedDoubleValueTest.java b/core/src/test/java/com/graphhopper/routing/util/EncodedDoubleValueTest.java
index b421744a29..3c041efa03 100644
--- a/core/src/test/java/com/graphhopper/routing/util/EncodedDoubleValueTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/EncodedDoubleValueTest.java
@@ -61,7 +61,7 @@ public void testMaxValueAndSwap()
         flags = carEncoder.handleWayTags(way, 1, 0);
 
         // double speed = AbstractFlagEncoder.parseSpeed("70 mph");
-        carEncoder.swapDirection(flags);
+        flags = carEncoder.reverseFlags(flags);
         assertEquals(100, carEncoder.getSpeed(flags), 1e-1);
     }
 }
diff --git a/core/src/test/java/com/graphhopper/routing/util/EncodedValueTest.java b/core/src/test/java/com/graphhopper/routing/util/EncodedValueTest.java
index fcd59de3d2..9fcb71771d 100644
--- a/core/src/test/java/com/graphhopper/routing/util/EncodedValueTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/EncodedValueTest.java
@@ -36,7 +36,7 @@ public void testSetValue()
         assertEquals(10, instance.getValue(instance.setValue(0, 10)));
 
         instance = new EncodedValue("test", 0, 4, 1, 5, 10);
-        assertEquals(5, instance.getValue(instance.setDefaultValue(0)));                
+        assertEquals(5, instance.getValue(instance.setDefaultValue(0)));
     }
 
     @Test
diff --git a/core/src/test/java/com/graphhopper/routing/util/EncodingManagerTest.java b/core/src/test/java/com/graphhopper/routing/util/EncodingManagerTest.java
index 101fd97ff7..c492adf212 100644
--- a/core/src/test/java/com/graphhopper/routing/util/EncodingManagerTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/EncodingManagerTest.java
@@ -24,8 +24,6 @@
 
 import java.util.Collection;
 import java.util.Collections;
-import java.util.HashMap;
-import java.util.Map;
 
 import org.junit.Test;
 
@@ -76,33 +74,35 @@ public void testEncoderAcceptNoException()
     }
 
     @Test
-    public void testTooManyEncoders()
+    public void testWrongEncoders()
     {
-        List<FlagEncoder> list = new ArrayList<FlagEncoder>();
-        for (int i = 0; i < 4; i++)
+        try
+        {
+            FootFlagEncoder foot = new FootFlagEncoder();
+            new EncodingManager(foot, foot);
+            assertTrue(false);
+        } catch (Exception ex)
         {
-            list.add(new FootFlagEncoder());
+            assertEquals("You must not register a FlagEncoder (foot) twice!", ex.getMessage());
         }
-        new EncodingManager(list);
-        list.add(new FootFlagEncoder());
+
         try
         {
-            new EncodingManager(list);
+            new EncodingManager(new FootFlagEncoder(), new CarFlagEncoder(), new BikeFlagEncoder(), new MountainBikeFlagEncoder(), new RacingBikeFlagEncoder());
             assertTrue(false);
         } catch (Exception ex)
         {
+            assertEquals("Encoders are requesting more than 32 bits of way flags. Decrease the number of vehicles or increase the flags to take long.",
+                    ex.getMessage());
         }
     }
 
     @Test
     public void testCombineRelations()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        wayMap.put("highway", "track");
-        OSMWay osmWay = new OSMWay(1, wayMap);
-
-        Map<String, String> relMap = new HashMap<String, String>();
-        OSMRelation osmRel = new OSMRelation(1, relMap);
+        OSMWay osmWay = new OSMWay(1);
+        osmWay.setTag("highway", "track");
+        OSMRelation osmRel = new OSMRelation(1);
 
         BikeFlagEncoder defaultBike = new BikeFlagEncoder();
         BikeFlagEncoder lessRelationCodes = new BikeFlagEncoder()
@@ -137,8 +137,8 @@ public String toString()
         EncodingManager manager = new EncodingManager(defaultBike, lessRelationCodes);
 
         // relation code is PREFER
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         long relFlags = manager.handleRelationTags(osmRel, 0);
         long allow = defaultBike.acceptBit | lessRelationCodes.acceptBit;
         long flags = manager.handleWayTags(osmWay, allow, relFlags);
@@ -150,28 +150,26 @@ public String toString()
     @Test
     public void testMixBikeTypesAndRelationCombination()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        wayMap.put("highway", "track");
-        wayMap.put("tracktype", "grade1");
-        OSMWay osmWay = new OSMWay(1, wayMap);
+        OSMWay osmWay = new OSMWay(1);
+        osmWay.setTag("highway", "track");
+        osmWay.setTag("tracktype", "grade1");
 
-        Map<String, String> relMap = new HashMap<String, String>();
-        OSMRelation osmRel = new OSMRelation(1, relMap);
+        OSMRelation osmRel = new OSMRelation(1);
 
         BikeFlagEncoder bikeEncoder = new BikeFlagEncoder();
         MountainBikeFlagEncoder mtbEncoder = new MountainBikeFlagEncoder();
         EncodingManager manager = new EncodingManager(bikeEncoder, mtbEncoder);
 
         // relation code for network rcn is VERY_NICE for bike and PREFER for mountainbike
-        relMap.put("route", "bicycle");
-        relMap.put("network", "rcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "rcn");
         long relFlags = manager.handleRelationTags(osmRel, 0);
         long allow = bikeEncoder.acceptBit | mtbEncoder.acceptBit;
         long flags = manager.handleWayTags(osmWay, allow, relFlags);
 
-        // Uninfluenced speed for grade1 bikeencoder = 4 (pushing section) -> smaller than 15 -> VERYNICE -> 22
+        // uninfluenced speed for grade1 bikeencoder = 4 (pushing section) -> smaller than 15 -> VERYNICE -> 22
         assertEquals(24, bikeEncoder.getSpeed(flags), 1e-1);
-        // Uninfluenced speed for grade1 bikeencoder = 12 -> smaller than 15 -> PREFER -> 18
+        // uninfluenced speed for grade1 bikeencoder = 12 -> smaller than 15 -> PREFER -> 18
         assertEquals(20, mtbEncoder.getSpeed(flags), 1e-1);
     }
 
@@ -203,9 +201,9 @@ public int defineNodeBits( int index, int shift )
             }
 
             @Override
-            public long analyzeNodeTags( OSMNode node )
+            public long handleNodeTags( OSMNode node )
             {
-                String tmp = node.getTags().get("test");
+                String tmp = node.getTag("test");
                 // return negative value to indicate that this is not a barrier
                 if (tmp == null)
                     return -nodeEncoder.setValue(0, 1);
@@ -222,29 +220,27 @@ public long applyNodeFlags( long wayFlags, long nodeFlags )
         };
         EncodingManager manager = new EncodingManager(car, car2);
 
-        Map<String, String> nodeMap = new HashMap<String, String>();
-        OSMNode node = new OSMNode(1, nodeMap, Double.NaN, Double.NaN);
-        Map<String, String> wayMap = new HashMap<String, String>();
-        wayMap.put("highway", "secondary");
-        OSMWay way = new OSMWay(2, wayMap);
+        OSMNode node = new OSMNode(1, Double.NaN, Double.NaN);
+        OSMWay way = new OSMWay(2);
+        way.setTag("highway", "secondary");
 
         long wayFlags = manager.handleWayTags(way, manager.acceptWay(way), 0);
-        long nodeFlags = manager.analyzeNodeTags(node);
+        long nodeFlags = manager.handleNodeTags(node);
         wayFlags = manager.applyNodeFlags(wayFlags, -nodeFlags);
         assertEquals(60, car.getSpeed(wayFlags), 1e-1);
         assertEquals(59, car2.getSpeed(wayFlags), 1e-1);
 
-        nodeMap.put("test", "something");
+        node.setTag("test", "something");
         wayFlags = manager.handleWayTags(way, manager.acceptWay(way), 0);
-        nodeFlags = manager.analyzeNodeTags(node);
+        nodeFlags = manager.handleNodeTags(node);
         wayFlags = manager.applyNodeFlags(wayFlags, -nodeFlags);
         assertEquals(58, car2.getSpeed(wayFlags), 1e-1);
         assertEquals(60, car.getSpeed(wayFlags), 1e-1);
 
-        wayMap.put("maxspeed", "130");
+        way.setTag("maxspeed", "130");
         wayFlags = manager.handleWayTags(way, manager.acceptWay(way), 0);
         assertEquals(car.getMaxSpeed(), car2.getSpeed(wayFlags), 1e-1);
-        nodeFlags = manager.analyzeNodeTags(node);
+        nodeFlags = manager.handleNodeTags(node);
         wayFlags = manager.applyNodeFlags(wayFlags, -nodeFlags);
         assertEquals(98, car2.getSpeed(wayFlags), 1e-1);
         assertEquals(100, car.getSpeed(wayFlags), 1e-1);
@@ -285,7 +281,7 @@ public void testTurnFlagCombination()
             }
         };
 
-        EncodingManager manager = new EncodingManager(Arrays.asList(bike, foot, car), 4, 127);        
+        EncodingManager manager = new EncodingManager(Arrays.asList(bike, foot, car), 4, 127);
 
         // turn cost entries for car and foot are for the same relations (same viaNode, edgeFrom and edgeTo), turn cost entry for bike is for another relation (different viaNode) 
         turnCostEntry_car.edgeFrom = 1;
@@ -309,7 +305,7 @@ public void testTurnFlagCombination()
         for (TurnCostTableEntry entry : entries)
         {
             if (entry.edgeFrom == 1)
-            { 
+            {
                 // the first entry provides turn flags for car and foot only 
                 assertEquals(assertFlag1, entry.flags);
                 assertTrue(car.isTurnRestricted(entry.flags));
@@ -320,7 +316,7 @@ public void testTurnFlagCombination()
                 assertEquals(0, foot.getTurnCosts(entry.flags));
                 assertEquals(0, bike.getTurnCosts(entry.flags));
             } else if (entry.edgeFrom == 2)
-            { 
+            {
                 // the 2nd entry provides turn flags for bike only
                 assertEquals(assertFlag2, entry.flags);
                 assertFalse(car.isTurnRestricted(entry.flags));
@@ -332,7 +328,12 @@ public void testTurnFlagCombination()
                 assertEquals(10, bike.getTurnCosts(entry.flags));
             }
         }
-
     }
 
+    @Test
+    public void testFixWayName()
+    {
+        assertEquals("B8, B12", EncodingManager.fixWayName("B8;B12"));
+        assertEquals("B8, B12", EncodingManager.fixWayName("B8; B12"));
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/routing/util/FastestWeightingTest.java b/core/src/test/java/com/graphhopper/routing/util/FastestWeightingTest.java
index 849de131c0..d84ed992d8 100644
--- a/core/src/test/java/com/graphhopper/routing/util/FastestWeightingTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/FastestWeightingTest.java
@@ -41,7 +41,11 @@ public void testMinWeightHasSameUnitAs_getWeight()
     public void testSpeed0()
     {
         FastestWeighting instance = new FastestWeighting(encoder);
+
         assertEquals(1.0 / 0, instance.calcWeight(createEdge(10, encoder.setProperties(0, true, true)), false), 1e-8);
+
+        // 0 / 0 returns NaN but calcWeight should not return NaN!
+        assertEquals(1.0 / 0, instance.calcWeight(createEdge(0, encoder.setProperties(0, true, true)), false), 1e-8);
     }
 
     EdgeIterator createEdge( final double distance, final long flags )
diff --git a/core/src/test/java/com/graphhopper/routing/util/FootFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/FootFlagEncoderTest.java
index 58e23b35fe..538ecccf2a 100644
--- a/core/src/test/java/com/graphhopper/routing/util/FootFlagEncoderTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/FootFlagEncoderTest.java
@@ -54,7 +54,7 @@ public void testBasics()
         assertEquals(FootFlagEncoder.MEAN, footEncoder.getSpeed(fl), 1e-1);
 
         long fl1 = footEncoder.flagsDefault(true, false);
-        long fl2 = footEncoder.swapDirection(fl1);
+        long fl2 = footEncoder.reverseFlags(fl1);
         assertEquals(footEncoder.getSpeed(fl2), footEncoder.getSpeed(fl1), 1e-1);
     }
 
@@ -90,83 +90,81 @@ public void testGraph()
     @Test
     public void testAccess()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
+        OSMWay way = new OSMWay(1);
 
-        map.put("highway", "motorway");
-        map.put("sidewalk", "yes");
+        way.setTag("highway", "motorway");
+        way.setTag("sidewalk", "yes");
         assertTrue(footEncoder.acceptWay(way) > 0);
-        map.put("sidewalk", "left");
+        way.setTag("sidewalk", "left");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.put("sidewalk", "none");
+        way.setTag("sidewalk", "none");
         assertFalse(footEncoder.acceptWay(way) > 0);
-        map.clear();
+        way.clearTags();
 
-        map.put("highway", "pedestrian");
+        way.setTag("highway", "pedestrian");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.put("highway", "footway");
+        way.setTag("highway", "footway");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.put("highway", "motorway");
+        way.setTag("highway", "motorway");
         assertFalse(footEncoder.acceptWay(way) > 0);
 
-        map.put("highway", "path");
+        way.setTag("highway", "path");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.put("bicycle", "official");
+        way.setTag("bicycle", "official");
         assertFalse(footEncoder.acceptWay(way) > 0);
 
-        map.put("foot", "official");
+        way.setTag("foot", "official");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "service");
-        map.put("access", "no");
+        way.clearTags();
+        way.setTag("highway", "service");
+        way.setTag("access", "no");
         assertFalse(footEncoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "tertiary");
-        map.put("motorroad", "yes");
+        way.clearTags();
+        way.setTag("highway", "tertiary");
+        way.setTag("motorroad", "yes");
         assertFalse(footEncoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "cycleway");
+        way.clearTags();
+        way.setTag("highway", "cycleway");
         assertFalse(footEncoder.acceptWay(way) > 0);
-        map.put("foot", "yes");
+        way.setTag("foot", "yes");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("highway", "track");
-        map.put("ford", "yes");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("ford", "yes");
         assertFalse(footEncoder.acceptWay(way) > 0);
-        map.put("foot", "yes");
+        way.setTag("foot", "yes");
         assertTrue(footEncoder.acceptWay(way) > 0);
 
-        map.clear();
-        map.put("route", "ferry");
+        way.clearTags();
+        way.setTag("route", "ferry");
         assertTrue(footEncoder.acceptWay(way) > 0);
-        map.put("foot", "no");
+        way.setTag("foot", "no");
         assertFalse(footEncoder.acceptWay(way) > 0);
     }
 
     @Test
     public void testMixSpeedAndSafe()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
+        OSMWay way = new OSMWay(1);
 
-        map.put("highway", "motorway");
+        way.setTag("highway", "motorway");
         long flags = footEncoder.handleWayTags(way, footEncoder.acceptWay(way), 0);
         assertEquals(0, flags);
 
-        map.put("sidewalk", "yes");
+        way.setTag("sidewalk", "yes");
         flags = footEncoder.handleWayTags(way, footEncoder.acceptWay(way), 0);
         assertEquals(5, footEncoder.getSpeed(flags), 1e-1);
 
-        map.clear();
-        map.put("highway", "track");
+        way.clearTags();
+        way.setTag("highway", "track");
         flags = footEncoder.handleWayTags(way, footEncoder.acceptWay(way), 0);
         assertEquals(5, footEncoder.getSpeed(flags), 1e-1);
     }
@@ -174,36 +172,36 @@ public void testMixSpeedAndSafe()
     @Test
     public void testSlowHiking()
     {
-        Map<String, String> map = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, map);
-        map.put("highway", "track");
-        map.put("sac_scale", "hiking");
+        OSMWay way = new OSMWay(1);
+        way.setTag("highway", "track");
+        way.setTag("sac_scale", "hiking");
         long flags = footEncoder.handleWayTags(way, footEncoder.acceptWay(way), 0);
         assertEquals(FootFlagEncoder.MEAN, footEncoder.getSpeed(flags), 1e-1);
 
-        map.put("highway", "track");
-        map.put("sac_scale", "mountain_hiking");
+        way.setTag("highway", "track");
+        way.setTag("sac_scale", "mountain_hiking");
         flags = footEncoder.handleWayTags(way, footEncoder.acceptWay(way), 0);
         assertEquals(FootFlagEncoder.SLOW, footEncoder.getSpeed(flags), 1e-1);
     }
-    
+
     @Test
-    public void testTurnFlagEncoding_noCostsAndRestrictions() {
+    public void testTurnFlagEncoding_noCostsAndRestrictions()
+    {
         long flags_r0 = footEncoder.getTurnFlags(true, 0);
         long flags_0 = footEncoder.getTurnFlags(false, 0);
-        
+
         long flags_r20 = footEncoder.getTurnFlags(true, 20);
         long flags_20 = footEncoder.getTurnFlags(false, 20);
-        
+
         assertEquals(0, footEncoder.getTurnCosts(flags_r0));
         assertEquals(0, footEncoder.getTurnCosts(flags_0));
-        
-        assertEquals(0,footEncoder.getTurnCosts(flags_r20));
+
+        assertEquals(0, footEncoder.getTurnCosts(flags_r20));
         assertEquals(0, footEncoder.getTurnCosts(flags_20));
-        
+
         assertFalse(footEncoder.isTurnRestricted(flags_r0));
         assertFalse(footEncoder.isTurnRestricted(flags_0));
-        
+
         assertFalse(footEncoder.isTurnRestricted(flags_r20));
         assertFalse(footEncoder.isTurnRestricted(flags_20));
     }
diff --git a/core/src/test/java/com/graphhopper/routing/util/MountainBikeFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/MountainBikeFlagEncoderTest.java
index 1c4d1df1db..e9efbb1baf 100644
--- a/core/src/test/java/com/graphhopper/routing/util/MountainBikeFlagEncoderTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/MountainBikeFlagEncoderTest.java
@@ -19,8 +19,6 @@
 import com.graphhopper.reader.OSMWay;
 import org.junit.Test;
 
-import java.util.HashMap;
-import java.util.Map;
 import java.util.concurrent.atomic.AtomicInteger;
 
 import static org.junit.Assert.*;
@@ -81,44 +79,43 @@ public void testGetSpeed()
     @Test
     public void testHandleWayTags()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay way = new OSMWay(1, wayMap);
+        OSMWay way = new OSMWay(1);
         String wayType;
 
-        wayMap.put("highway", "track");
+        way.setTag("highway", "track");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "path");
+        way.clearTags();
+        way.setTag("highway", "path");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "path");
-        wayMap.put("surface", "grass");
+        way.clearTags();
+        way.setTag("highway", "path");
+        way.setTag("surface", "grass");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way, unpaved", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "path");
-        wayMap.put("surface", "concrete");
+        way.clearTags();
+        way.setTag("highway", "path");
+        way.setTag("surface", "concrete");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "track");
-        wayMap.put("foot", "yes");
-        wayMap.put("surface", "paved");
-        wayMap.put("tracktype", "grade1");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("foot", "yes");
+        way.setTag("surface", "paved");
+        way.setTag("tracktype", "grade1");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way", wayType);
 
-        wayMap.clear();
-        wayMap.put("highway", "track");
-        wayMap.put("foot", "yes");
-        wayMap.put("surface", "paved");
-        wayMap.put("tracktype", "grade2");
+        way.clearTags();
+        way.setTag("highway", "track");
+        way.setTag("foot", "yes");
+        way.setTag("surface", "paved");
+        way.setTag("tracktype", "grade2");
         wayType = encodeDecodeWayType("", way);
         assertEquals("way, unpaved", wayType);
 
@@ -127,74 +124,50 @@ public void testHandleWayTags()
     @Test
     public void testHandleWayTagsInfluencedByRelation()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay osmWay = new OSMWay(1, wayMap);
-        wayMap.put("highway", "track");
+        OSMWay osmWay = new OSMWay(1);
+        osmWay.setTag("highway", "track");
         long allowed = encoder.acceptBit;
 
-        Map<String, String> relMap = new HashMap<String, String>();
-        OSMRelation osmRel = new OSMRelation(1, relMap);
+        OSMRelation osmRel = new OSMRelation(1);
 
         long relFlags = encoder.handleRelationTags(osmRel, 0);
         // unchanged
         long flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(24, encoder.getSpeed(flags), 1e-1);
-        assertEquals(3, encoder.getWayTypeCode(flags));
-        assertEquals(1, encoder.getPavementCode(flags));
+        assertEquals(3, encoder.getWayType(flags));
+        assertEquals(1, encoder.getPavementType(flags));
 
         // relation code is PREFER
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(28, encoder.getSpeed(flags), 1e-1);
-        assertEquals(3, encoder.getWayTypeCode(flags));
-        assertEquals(1, encoder.getPavementCode(flags));
+        assertEquals(3, encoder.getWayType(flags));
+        assertEquals(1, encoder.getPavementType(flags));
 
         // relation code is PREFER
-        relMap.put("network", "rcn");
+        osmRel.setTag("network", "rcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(28, encoder.getSpeed(flags), 1e-1);
 
         // relation code is PREFER
-        relMap.put("network", "ncn");
+        osmRel.setTag("network", "ncn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(28, encoder.getSpeed(flags), 1e-1);
 
         // PREFER relation, but tertiary road
         // => no pushing section but road wayTypeCode and faster
-        wayMap.clear();
-        wayMap.put("highway", "tertiary");
+        osmWay.clearTags();
+        osmWay.setTag("highway", "tertiary");
 
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(20, encoder.getSpeed(flags), 1e-1);
-        assertEquals(0, encoder.getWayTypeCode(flags));
-
-        // test max and min speed
-        final AtomicInteger fakeSpeed = new AtomicInteger(40);
-        MountainBikeFlagEncoder fakeEncoder = new MountainBikeFlagEncoder()
-        {
-            @Override
-            int relationWeightCodeToSpeed( int highwaySpeed, int relationCode )
-            {
-                return fakeSpeed.get();
-            }
-        };
-        // call necessary register
-        new EncodingManager(fakeEncoder);
-        allowed = fakeEncoder.acceptBit;
-
-        flags = fakeEncoder.handleWayTags(osmWay, allowed, 1);
-        assertEquals(30, fakeEncoder.getSpeed(flags), 1e-1);
-
-        fakeSpeed.set(-2);
-        flags = fakeEncoder.handleWayTags(osmWay, allowed, 1);
-        assertEquals(0, fakeEncoder.getSpeed(flags), 1e-1);
-
+        assertEquals(0, encoder.getWayType(flags));
     }
 }
diff --git a/core/src/test/java/com/graphhopper/routing/util/RacingBikeFlagEncoderTest.java b/core/src/test/java/com/graphhopper/routing/util/RacingBikeFlagEncoderTest.java
index 6017ff6f0e..0cc304222d 100644
--- a/core/src/test/java/com/graphhopper/routing/util/RacingBikeFlagEncoderTest.java
+++ b/core/src/test/java/com/graphhopper/routing/util/RacingBikeFlagEncoderTest.java
@@ -61,39 +61,37 @@ public void testGetSpeed()
     @Test
     public void testHandleWayTagsInfluencedByRelation()
     {
-        Map<String, String> wayMap = new HashMap<String, String>();
-        OSMWay osmWay = new OSMWay(1, wayMap);
-        wayMap.put("highway", "track");
+        OSMWay osmWay = new OSMWay(1);
+        osmWay.setTag("highway", "track");
         long allowed = encoder.acceptBit;
 
-        Map<String, String> relMap = new HashMap<String, String>();
-        OSMRelation osmRel = new OSMRelation(1, relMap);
+        OSMRelation osmRel = new OSMRelation(1);
 
         assertEquals(PUSHING_SECTION_SPEED / 2, getEncodedDecodedSpeed(osmWay), 1e-1);
 
         // relation code is PREFER
-        relMap.put("route", "bicycle");
-        relMap.put("network", "lcn");
+        osmRel.setTag("route", "bicycle");
+        osmRel.setTag("network", "lcn");
         long relFlags = encoder.handleRelationTags(osmRel, 0);
         long flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(2, encoder.getSpeed(flags), 1e-1);
-        assertEquals(1, encoder.getWayTypeCode(flags)); // Pushing section
-        assertEquals(1, encoder.getPavementCode(flags)); //  Unpaved
+        assertEquals(1, encoder.getWayType(flags)); // Pushing section
+        assertEquals(1, encoder.getPavementType(flags)); //  Unpaved
 
         // relation code is OUTSTANDING NICE but as unpaved, the speed is still PUSHING_SECTION_SPEED/2
-        relMap.put("network", "icn");
+        osmRel.setTag("network", "icn");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(2, encoder.getSpeed(flags), 1e-1);
 
         // Now we assume bicycle=yes, anyhow still unpaved
-        wayMap.put("bicycle", "yes");
+        osmWay.setTag("bicycle", "yes");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(2, encoder.getSpeed(flags), 1e-1);
 
         // Now we assume bicycle=yes, and paved -> The speed is pushed!
-        wayMap.put("tracktype", "grade1");
+        osmWay.setTag("tracktype", "grade1");
         relFlags = encoder.handleRelationTags(osmRel, 0);
         flags = encoder.handleWayTags(osmWay, allowed, relFlags);
         assertEquals(30, encoder.getSpeed(flags), 1e-1);
diff --git a/core/src/test/java/com/graphhopper/storage/AbstractDirectoryTester.java b/core/src/test/java/com/graphhopper/storage/AbstractDirectoryTester.java
index ed7764e4a1..7c719e78eb 100644
--- a/core/src/test/java/com/graphhopper/storage/AbstractDirectoryTester.java
+++ b/core/src/test/java/com/graphhopper/storage/AbstractDirectoryTester.java
@@ -48,16 +48,6 @@ public void setUp()
         Helper.removeDir(new File(location));
     }
 
-    @Test
-    public void testRename()
-    {
-        Directory dir = createDir();
-        da = dir.find("testing");
-        da.create(100);
-        da.flush();
-        dir.rename(da, "newtesting");
-    }
-
     @Test
     public void testRequestedDataAccessHasToBeTheIdenticalType()
     {
diff --git a/core/src/test/java/com/graphhopper/storage/AbstractGraphStorageTester.java b/core/src/test/java/com/graphhopper/storage/AbstractGraphStorageTester.java
index 8bd6b587df..c9ad7d2618 100644
--- a/core/src/test/java/com/graphhopper/storage/AbstractGraphStorageTester.java
+++ b/core/src/test/java/com/graphhopper/storage/AbstractGraphStorageTester.java
@@ -39,7 +39,7 @@
  */
 public abstract class AbstractGraphStorageTester
 {
-    private final String location = "./target/graphstorage";
+    private final String locationParent = "./target/graphstorage";
     protected int defaultSize = 100;
     protected String defaultGraphLoc = "./target/graphstorage/default";
     protected EncodingManager encodingManager = new EncodingManager("CAR,FOOT");
@@ -54,31 +54,31 @@
 
     protected GraphStorage createGraph()
     {
-        GraphStorage g = createGraph(defaultGraphLoc, defaultSize);
+        GraphStorage g = createGraph(defaultGraphLoc, false);
         carOutExplorer = g.createEdgeExplorer(carOutFilter);
         carInExplorer = g.createEdgeExplorer(carInFilter);
         carAllExplorer = g.createEdgeExplorer();
         return g;
     }
 
-    abstract GraphStorage createGraph( String location, int size );
+    abstract GraphStorage createGraph( String location, boolean is3D );
 
     protected GraphStorage newRAMGraph()
     {
-        return new GraphHopperStorage(new RAMDirectory(), encodingManager);
+        return new GraphHopperStorage(new RAMDirectory(), encodingManager, false);
     }
 
     @Before
     public void setUp()
     {
-        Helper.removeDir(new File(location));
+        Helper.removeDir(new File(locationParent));
     }
 
     @After
     public void tearDown()
     {
         Helper.close((Closeable) graph);
-        Helper.removeDir(new File(location));
+        Helper.removeDir(new File(locationParent));
     }
 
     @Test
@@ -94,9 +94,10 @@ public void testInfinityWeight()
     public void testSetNodes()
     {
         graph = createGraph();
+        NodeAccess na = graph.getNodeAccess();
         for (int i = 0; i < defaultSize * 2; i++)
         {
-            graph.setNode(i, 2 * i, 3 * i);
+            na.setNode(i, 2 * i, 3 * i);
         }
         graph.edge(defaultSize + 1, defaultSize + 2, 10, true);
         graph.edge(defaultSize + 1, defaultSize + 3, 10, true);
@@ -234,13 +235,14 @@ public void testClone()
     {
         graph = createGraph();
         graph.edge(1, 2, 10, true);
-        graph.setNode(0, 12, 23);
-        graph.setNode(1, 8, 13);
-        graph.setNode(2, 2, 10);
-        graph.setNode(3, 5, 9);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 12, 23);
+        na.setNode(1, 8, 13);
+        na.setNode(2, 2, 10);
+        na.setNode(3, 5, 9);
         graph.edge(1, 3, 10, true);
 
-        Graph clone = graph.copyTo(createGraph(location + "/clone", defaultSize));
+        Graph clone = graph.copyTo(createGraph(locationParent + "/clone", false));
         assertEquals(graph.getNodes(), clone.getNodes());
         assertEquals(count(carOutExplorer.setBaseNode(1)), count(clone.createEdgeExplorer(carOutFilter).setBaseNode(1)));
         clone.edge(1, 4, 10, true);
@@ -249,12 +251,27 @@ public void testClone()
         Helper.close((Closeable) clone);
     }
 
+    @Test
+    public void testCopyProperties()
+    {
+        graph = createGraph();
+        EdgeIteratorState edge = graph.edge(1, 3, 10, false).setName("testing").setWayGeometry(Helper.createPointList(1, 2));
+
+        EdgeIteratorState newEdge = graph.edge(1, 3, 10, false);
+        edge.copyPropertiesTo(newEdge);
+        assertEquals(edge.getName(), newEdge.getName());
+        assertEquals(edge.getDistance(), newEdge.getDistance(), 1e-7);
+        assertEquals(edge.getFlags(), newEdge.getFlags());
+        assertEquals(edge.fetchWayGeometry(0), newEdge.fetchWayGeometry(0));
+    }
+
     @Test
     public void testGetLocations()
     {
         graph = createGraph();
-        graph.setNode(0, 12, 23);
-        graph.setNode(1, 22, 23);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 12, 23);
+        na.setNode(1, 22, 23);
         assertEquals(2, graph.getNodes());
 
         graph.edge(0, 1, 10, true);
@@ -310,12 +327,13 @@ public void testAddLocation()
 
     protected void initExampleGraph( Graph g )
     {
-        g.setNode(0, 12, 23);
-        g.setNode(1, 38.33f, 135.3f);
-        g.setNode(2, 6, 139);
-        g.setNode(3, 78, 89);
-        g.setNode(4, 2, 1);
-        g.setNode(5, 7, 5);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 12, 23);
+        na.setNode(1, 38.33f, 135.3f);
+        na.setNode(2, 6, 139);
+        na.setNode(3, 78, 89);
+        na.setNode(4, 2, 1);
+        na.setNode(5, 7, 5);
         g.edge(0, 1, 12, true);
         g.edge(0, 2, 212, true);
         g.edge(0, 3, 212, true);
@@ -325,17 +343,18 @@ protected void initExampleGraph( Graph g )
 
     private void checkExampleGraph( Graph graph )
     {
-        assertEquals(12f, graph.getLatitude(0), 1e-6);
-        assertEquals(23f, graph.getLongitude(0), 1e-6);
+        NodeAccess na = graph.getNodeAccess();
+        assertEquals(12f, na.getLatitude(0), 1e-6);
+        assertEquals(23f, na.getLongitude(0), 1e-6);
 
-        assertEquals(38.33f, graph.getLatitude(1), 1e-6);
-        assertEquals(135.3f, graph.getLongitude(1), 1e-6);
+        assertEquals(38.33f, na.getLatitude(1), 1e-6);
+        assertEquals(135.3f, na.getLongitude(1), 1e-6);
 
-        assertEquals(6, graph.getLatitude(2), 1e-6);
-        assertEquals(139, graph.getLongitude(2), 1e-6);
+        assertEquals(6, na.getLatitude(2), 1e-6);
+        assertEquals(139, na.getLongitude(2), 1e-6);
 
-        assertEquals(78, graph.getLatitude(3), 1e-6);
-        assertEquals(89, graph.getLongitude(3), 1e-6);
+        assertEquals(78, na.getLatitude(3), 1e-6);
+        assertEquals(89, na.getLongitude(3), 1e-6);
 
         assertEquals(GHUtility.asSet(0), GHUtility.getNeighbors(carOutExplorer.setBaseNode((1))));
         assertEquals(GHUtility.asSet(5, 4, 3, 2, 1), GHUtility.getNeighbors(carOutExplorer.setBaseNode(0)));
@@ -427,10 +446,11 @@ public void testCheckFirstNode()
     public void testDeleteNodeForUnidir()
     {
         graph = createGraph();
-        graph.setNode(10, 10, 1);
-        graph.setNode(6, 6, 1);
-        graph.setNode(20, 20, 1);
-        graph.setNode(21, 21, 1);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(10, 10, 1);
+        na.setNode(6, 6, 1);
+        na.setNode(20, 20, 1);
+        na.setNode(21, 21, 1);
 
         graph.edge(10, 20, 10, false);
         graph.edge(21, 6, 10, false);
@@ -469,17 +489,18 @@ public void testComplexDeleteNode2()
     public void testDeleteNodes( int fillToSize )
     {
         graph = createGraph();
-        graph.setNode(0, 12, 23);
-        graph.setNode(1, 38.33f, 135.3f);
-        graph.setNode(2, 3, 3);
-        graph.setNode(3, 78, 89);
-        graph.setNode(4, 2, 1);
-        graph.setNode(5, 2.5f, 1);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 12, 23);
+        na.setNode(1, 38.33f, 135.3f);
+        na.setNode(2, 3, 3);
+        na.setNode(3, 78, 89);
+        na.setNode(4, 2, 1);
+        na.setNode(5, 2.5f, 1);
 
         int deleted = 2;
         for (int i = 6; i < fillToSize; i++)
         {
-            graph.setNode(i, i * 1.5, i * 1.6);
+            na.setNode(i, i * 1.5, i * 1.6);
             if (i % 3 == 0)
             {
                 graph.markNodeRemoved(i);
@@ -515,21 +536,22 @@ public void testDeleteNodes( int fillToSize )
 
         assertEquals(fillToSize - deleted, graph.getNodes());
         int id1 = getIdOf(graph, 38.33f);
-        assertEquals(135.3f, graph.getLongitude(id1), 1e-4);
+        assertEquals(135.3f, na.getLongitude(id1), 1e-4);
         assertTrue(containsLatitude(graph, carAllExplorer.setBaseNode(id1), 2.5));
         assertFalse(containsLatitude(graph, carAllExplorer.setBaseNode(id1), 12));
 
         int id3 = getIdOf(graph, 78);
-        assertEquals(89, graph.getLongitude(id3), 1e-4);
+        assertEquals(89, na.getLongitude(id3), 1e-4);
         assertTrue(containsLatitude(graph, carAllExplorer.setBaseNode(id3), 2.5));
         assertFalse(containsLatitude(graph, carAllExplorer.setBaseNode(id3), 12));
     }
 
     public boolean containsLatitude( Graph g, EdgeIterator iter, double latitude )
     {
+        NodeAccess na = g.getNodeAccess();
         while (iter.next())
         {
-            if (Math.abs(g.getLatitude(iter.getAdjNode()) - latitude) < 1e-4)
+            if (Math.abs(na.getLatitude(iter.getAdjNode()) - latitude) < 1e-4)
                 return true;
         }
         return false;
@@ -539,10 +561,11 @@ public boolean containsLatitude( Graph g, EdgeIterator iter, double latitude )
     public void testSimpleDelete()
     {
         graph = createGraph();
-        graph.setNode(0, 12, 23);
-        graph.setNode(1, 38.33f, 135.3f);
-        graph.setNode(2, 3, 3);
-        graph.setNode(3, 78, 89);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 12, 23);
+        na.setNode(1, 38.33f, 135.3f);
+        na.setNode(2, 3, 3);
+        na.setNode(3, 78, 89);
 
         graph.edge(3, 0, 21, true);
         graph.edge(5, 0, 22, true);
@@ -569,12 +592,13 @@ public void testSimpleDelete()
     public void testSimpleDelete2()
     {
         graph = createGraph();
+        NodeAccess na = graph.getNodeAccess();
         assertEquals(-1, getIdOf(graph, 12));
-        graph.setNode(9, 9, 1);
+        na.setNode(9, 9, 1);
         assertEquals(-1, getIdOf(graph, 12));
 
-        graph.setNode(11, 11, 1);
-        graph.setNode(12, 12, 1);
+        na.setNode(11, 11, 1);
+        na.setNode(12, 12, 1);
 
         // mini subnetwork which gets completely removed:
         graph.edge(5, 10, 510, true);
@@ -582,8 +606,8 @@ public void testSimpleDelete2()
         graph.markNodeRemoved(10);
 
         PointList pl = new PointList();
-        pl.add(1, 2);
-        pl.add(1, 3);
+        pl.add(1, 2, Double.NaN);
+        pl.add(1, 3, Double.NaN);
         graph.edge(9, 11, 911, true).setWayGeometry(pl);
         graph.edge(9, 12, 912, true).setWayGeometry(pl);
 
@@ -617,10 +641,11 @@ public void testSimpleDelete2()
     public void testSimpleDelete3()
     {
         graph = createGraph();
-        graph.setNode(7, 7, 1);
-        graph.setNode(8, 8, 1);
-        graph.setNode(9, 9, 1);
-        graph.setNode(11, 11, 1);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(7, 7, 1);
+        na.setNode(8, 8, 1);
+        na.setNode(9, 9, 1);
+        na.setNode(11, 11, 1);
 
         // mini subnetwork which gets completely removed:
         graph.edge(5, 10, 510, true);
@@ -648,11 +673,12 @@ public void testSimpleDelete3()
     public void testDeleteAndOptimize()
     {
         graph = createGraph();
-        graph.setNode(20, 10, 10);
-        graph.setNode(21, 10, 11);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(20, 10, 10);
+        na.setNode(21, 10, 11);
         graph.markNodeRemoved(20);
         graph.optimize();
-        assertEquals(11, graph.getLongitude(20), 1e-5);
+        assertEquals(11, na.getLongitude(20), 1e-5);
     }
 
     @Test
@@ -662,11 +688,12 @@ public void testBounds()
         BBox b = graph.getBounds();
         assertEquals(BBox.INVERSE.maxLat, b.maxLat, 1e-6);
 
-        graph.setNode(0, 10, 20);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 10, 20);
         assertEquals(10, b.maxLat, 1e-6);
         assertEquals(20, b.maxLon, 1e-6);
 
-        graph.setNode(0, 15, -15);
+        na.setNode(0, 15, -15);
         assertEquals(15, b.maxLat, 1e-6);
         assertEquals(20, b.maxLon, 1e-6);
         assertEquals(10, b.minLat, 1e-6);
@@ -774,13 +801,13 @@ public void testCreateDuplicateEdges()
         assertEquals(13, oneIter.getDistance(), 1e-6);
         assertEquals(2, oneIter.getBaseNode());
         assertTrue(carEncoder.isForward(oneIter.getFlags()));
-        assertFalse(carEncoder.isBoth(oneIter.getFlags()));
+        assertFalse(carEncoder.isBackward(oneIter.getFlags()));
 
         oneIter = graph.getEdgeProps(iter.getEdge(), 2);
         assertEquals(13, oneIter.getDistance(), 1e-6);
         assertEquals(3, oneIter.getBaseNode());
         assertTrue(carEncoder.isBackward(oneIter.getFlags()));
-        assertFalse(carEncoder.isBoth(oneIter.getFlags()));
+        assertFalse(carEncoder.isForward(oneIter.getFlags()));
 
         graph.edge(3, 2, 14, true);
         assertEquals(4, GHUtility.count(carOutExplorer.setBaseNode(2)));
@@ -819,10 +846,11 @@ public void testEdgeReturn()
     public void testPillarNodes()
     {
         graph = createGraph();
-        graph.setNode(0, 0.01, 0.01);
-        graph.setNode(4, 0.4, 0.4);
-        graph.setNode(14, 0.14, 0.14);
-        graph.setNode(10, 0.99, 0.99);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0.01, 0.01);
+        na.setNode(4, 0.4, 0.4);
+        na.setNode(14, 0.14, 0.14);
+        na.setNode(10, 0.99, 0.99);
 
         PointList pointList = Helper.createPointList(1, 1, 1, 2, 1, 3);
         graph.edge(0, 4).setDistance(100).setFlags(carEncoder.setProperties(10, true, false)).setWayGeometry(pointList);
@@ -908,10 +936,11 @@ public void testGetAllEdges()
     public void testGetAllEdgesWithDelete()
     {
         graph = createGraph();
-        graph.setNode(0, 0, 5);
-        graph.setNode(1, 1, 5);
-        graph.setNode(2, 2, 5);
-        graph.setNode(3, 3, 5);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0, 5);
+        na.setNode(1, 1, 5);
+        na.setNode(2, 2, 5);
+        na.setNode(3, 3, 5);
         graph.edge(0, 1, 1, true);
         graph.edge(0, 2, 1, true);
         graph.edge(1, 2, 1, true);
@@ -926,6 +955,18 @@ public void testGetAllEdgesWithDelete()
         iter = graph.getAllEdges();
         assertEquals(2, GHUtility.count(iter));
         assertEquals(4, iter.getMaxId());
+
+        iter = graph.getAllEdges();
+        iter.next();
+        EdgeIteratorState eState = iter.detach(false);
+        assertEquals(iter.toString(), eState.toString());
+        iter.next();
+        assertNotEquals(iter.toString(), eState.toString());
+
+        EdgeIteratorState eState2 = iter.detach(true);
+        assertEquals(iter.getAdjNode(), eState2.getBaseNode());
+        iter.next();
+        assertNotEquals(iter.getAdjNode(), eState2.getBaseNode());
     }
 
     public static void assertPList( PointList expected, PointList list )
@@ -941,9 +982,10 @@ public static void assertPList( PointList expected, PointList list )
     public static int getIdOf( Graph g, double latitude )
     {
         int s = g.getNodes();
+        NodeAccess na = g.getNodeAccess();
         for (int i = 0; i < s; i++)
         {
-            if (Math.abs(g.getLatitude(i) - latitude) < 1e-4)
+            if (Math.abs(na.getLatitude(i) - latitude) < 1e-4)
             {
                 return i;
             }
@@ -954,9 +996,10 @@ public static int getIdOf( Graph g, double latitude )
     public static int getIdOf( Graph g, double latitude, double longitude )
     {
         int s = g.getNodes();
+        NodeAccess na = g.getNodeAccess();
         for (int i = 0; i < s; i++)
         {
-            if (Math.abs(g.getLatitude(i) - latitude) < 1e-4 && Math.abs(g.getLongitude(i) - longitude) < 1e-4)
+            if (Math.abs(na.getLatitude(i) - latitude) < 1e-4 && Math.abs(na.getLongitude(i) - longitude) < 1e-4)
             {
                 return i;
             }
@@ -986,14 +1029,16 @@ public void test8BytesFlags()
         list.add(new TmpCarFlagEncoder(30, 0.001));
         list.add(new TmpCarFlagEncoder(30, 0.001));
         EncodingManager manager = new EncodingManager(list, 8, 0);
-        graph = new GraphHopperStorage(dir, manager).create(defaultSize);
+        graph = new GraphHopperStorage(dir, manager, false).create(defaultSize);
+
         EdgeIteratorState edge = graph.edge(0, 1);
         edge.setFlags(Long.MAX_VALUE / 3);
         // System.out.println(BitUtil.LITTLE.toBitString(Long.MAX_VALUE / 3) + "\n" + BitUtil.LITTLE.toBitString(edge.getFlags()));
         assertEquals(Long.MAX_VALUE / 3, edge.getFlags());
         graph.close();
 
-        graph = new GraphHopperStorage(dir, manager).create(defaultSize);
+        graph = new GraphHopperStorage(dir, manager, false).create(defaultSize);
+
         edge = graph.edge(0, 1);
         edge.setFlags(list.get(0).setProperties(99.123, true, true));
         assertEquals(99.123, list.get(0).getSpeed(edge.getFlags()), 1e-3);
@@ -1009,33 +1054,73 @@ public void test8BytesFlags()
         assertTrue(list.get(1).isForward(flags));
         assertFalse(list.get(1).isBackward(flags));
     }
-    
+
+    @Test
+    public void testEnabledElevation()
+    {
+        graph = createGraph(defaultGraphLoc, true);
+        NodeAccess na = graph.getNodeAccess();
+        assertTrue(na.is3D());
+        na.setNode(0, 10, 20, -10);
+        na.setNode(1, 11, 2, 100);
+        assertEquals(-10, na.getEle(0), 1e-1);
+        assertEquals(100, na.getEle(1), 1e-1);
+
+        graph.edge(0, 1).setWayGeometry(Helper.createPointList3D(10, 27, 72, 11, 20, 1));
+        assertEquals(Helper.createPointList3D(10, 27, 72, 11, 20, 1), GHUtility.getEdge(graph, 0, 1).fetchWayGeometry(0));
+        assertEquals(Helper.createPointList3D(10, 20, -10, 10, 27, 72, 11, 20, 1, 11, 2, 100), GHUtility.getEdge(graph, 0, 1).fetchWayGeometry(3));
+        assertEquals(Helper.createPointList3D(11, 2, 100, 11, 20, 1, 10, 27, 72, 10, 20, -10), GHUtility.getEdge(graph, 1, 0).fetchWayGeometry(3));
+    }
+
     @Test
     public void testDetachEdge()
     {
         graph = createGraph();
         graph.edge(0, 1, 2, true);
-        graph.edge(0, 2, 2, true);
+        long flags = carEncoder.setProperties(10, true, false);
+        graph.edge(0, 2, 2, true).setWayGeometry(Helper.createPointList(1, 2, 3, 4)).setFlags(flags);
         graph.edge(1, 2, 2, true);
 
         EdgeIterator iter = graph.createEdgeExplorer().setBaseNode(0);
         try
         {
-            // currently not possible to implement without a new property inside EdgeIterable
-            iter.detach();
+            // currently not possible to detach without next, without introducing a new property inside EdgeIterable
+            iter.detach(false);
             assertTrue(false);
         } catch (Exception ex)
         {
         }
 
         iter.next();
-        EdgeIteratorState iter2 = iter.detach();
+        EdgeIteratorState edgeState2 = iter.detach(false);
         assertEquals(2, iter.getAdjNode());
-        assertEquals(2, iter2.getAdjNode());
+        assertEquals(1, edgeState2.fetchWayGeometry(0).getLatitude(0), 1e-1);
+        assertEquals(2, edgeState2.getAdjNode());
+        assertTrue(carEncoder.isForward(edgeState2.getFlags()));
+
+        EdgeIteratorState edgeState3 = iter.detach(true);
+        assertEquals(0, edgeState3.getAdjNode());
+        assertEquals(2, edgeState3.getBaseNode());
+        assertEquals(3, edgeState3.fetchWayGeometry(0).getLatitude(0), 1e-1);
+        assertFalse(carEncoder.isForward(edgeState3.getFlags()));
+        assertEquals(GHUtility.getEdge(graph, 0, 2).getFlags(), edgeState2.getFlags());
+        assertEquals(GHUtility.getEdge(graph, 2, 0).getFlags(), edgeState3.getFlags());
 
         iter.next();
         assertEquals(1, iter.getAdjNode());
-        assertEquals(2, iter2.getAdjNode());
+        assertEquals(2, edgeState2.getAdjNode());
+        assertEquals(2, edgeState3.getBaseNode());
+
+        assertEquals(0, iter.fetchWayGeometry(0).size());
+        assertEquals(1, edgeState2.fetchWayGeometry(0).getLatitude(0), 1e-1);
+        assertEquals(3, edgeState3.fetchWayGeometry(0).getLatitude(0), 1e-1);
+
+        // #162 a directed self referencing edge should be able to reverse its state too
+        graph.edge(3, 3, 2, true).setFlags(flags);
+        EdgeIterator iter2 = graph.createEdgeExplorer().setBaseNode(3);
+        iter2.next();
+        assertEquals(edgeState2.getFlags(), iter2.detach(false).getFlags());
+        assertEquals(edgeState3.getFlags(), iter2.detach(true).getFlags());
     }
 
     static class TmpCarFlagEncoder extends CarFlagEncoder
diff --git a/core/src/test/java/com/graphhopper/storage/DataAccessTest.java b/core/src/test/java/com/graphhopper/storage/DataAccessTest.java
index f58677c6a0..aedacce9ba 100644
--- a/core/src/test/java/com/graphhopper/storage/DataAccessTest.java
+++ b/core/src/test/java/com/graphhopper/storage/DataAccessTest.java
@@ -348,4 +348,26 @@ public void testSet_GetBytes()
         assertEquals(256, bufferIndex);
         assertEquals(11111, index);
     }
+
+    @Test
+    public void testSet_Get_Short_Long()
+    {
+        DataAccess da = createDataAccess(name);
+        da.create(300);
+        da.setShort(6, (short) (Short.MAX_VALUE / 5));
+        assertEquals(Short.MAX_VALUE / 5, da.getShort(6));
+
+        da.setShort(8, (short) (Short.MAX_VALUE / 7));
+        assertEquals(Short.MAX_VALUE / 7, da.getShort(8));
+
+        // currently RAMIntDA does not support arbitrary byte positions
+        if (!(da instanceof RAMIntDataAccess))
+        {
+            da.setShort(7, (short) (Short.MAX_VALUE / 3));
+            assertEquals(Short.MAX_VALUE / 3, da.getShort(7));
+            // should be overwritten
+            assertNotEquals(Short.MAX_VALUE / 3, da.getShort(8));
+        }
+        da.close();
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/storage/GraphHopperStorageTest.java b/core/src/test/java/com/graphhopper/storage/GraphHopperStorageTest.java
index a278f308f8..1c0900623a 100644
--- a/core/src/test/java/com/graphhopper/storage/GraphHopperStorageTest.java
+++ b/core/src/test/java/com/graphhopper/storage/GraphHopperStorageTest.java
@@ -30,23 +30,18 @@
 public class GraphHopperStorageTest extends AbstractGraphStorageTester
 {
     @Override
-    public GraphStorage createGraph( String location, int size )
+    public GraphStorage createGraph( String location, boolean enabled3D )
     {
         // reduce segment size in order to test the case where multiple segments come into the game
-        GraphStorage gs = newGraph(new RAMDirectory(location));
-        gs.setSegmentSize(size / 2);
-        gs.create(size);
+        GraphStorage gs = newGraph(new RAMDirectory(location), enabled3D);
+        gs.setSegmentSize(defaultSize / 2);
+        gs.create(defaultSize);
         return gs;
     }
 
-    protected GraphStorage newGraph( Directory dir )
+    protected GraphStorage newGraph( Directory dir, boolean enabled3D )
     {
-        return new GraphHopperStorage(dir, encodingManager);
-    }
-
-    protected GraphStorage createGraphStorage( Directory dir )
-    {
-        return newGraph(dir).create(defaultSize);
+        return new GraphHopperStorage(dir, encodingManager, enabled3D);
     }
 
     @Test
@@ -72,10 +67,11 @@ public void testNoCreateCalled() throws IOException
     @Test
     public void testSave_and_fileFormat() throws IOException
     {
-        graph = (GraphHopperStorage) createGraphStorage(new RAMDirectory(defaultGraphLoc, true));
-        graph.setNode(0, 10, 10);
-        graph.setNode(1, 11, 20);
-        graph.setNode(2, 12, 12);
+        graph = newGraph(new RAMDirectory(defaultGraphLoc, true), false).create(defaultSize);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 10, 10);
+        na.setNode(1, 11, 20);
+        na.setNode(2, 12, 12);
 
         EdgeIteratorState iter2 = graph.edge(0, 1, 100, true);
         iter2.setWayGeometry(Helper.createPointList(1.5, 1, 2, 3));
@@ -92,7 +88,7 @@ public void testSave_and_fileFormat() throws IOException
         graph.flush();
         graph.close();
 
-        graph = (GraphHopperStorage) newGraph(new MMapDirectory(defaultGraphLoc));
+        graph = newGraph(new MMapDirectory(defaultGraphLoc), false);
         assertTrue(graph.loadExisting());
 
         assertEquals(12, graph.getNodes());
@@ -106,9 +102,10 @@ public void testSave_and_fileFormat() throws IOException
 
     protected void checkGraph( Graph g )
     {
+        NodeAccess na = g.getNodeAccess();
         assertEquals(new BBox(10, 20, 10, 12), g.getBounds());
-        assertEquals(10, g.getLatitude(0), 1e-2);
-        assertEquals(10, g.getLongitude(0), 1e-2);
+        assertEquals(10, na.getLatitude(0), 1e-2);
+        assertEquals(10, na.getLongitude(0), 1e-2);
         EdgeExplorer explorer = g.createEdgeExplorer(carOutFilter);
         assertEquals(2, GHUtility.count(explorer.setBaseNode(0)));
         assertEquals(GHUtility.asSet(2, 1), GHUtility.getNeighbors(explorer.setBaseNode(0)));
@@ -122,13 +119,13 @@ protected void checkGraph( Graph g )
         assertEquals(Helper.createPointList(10, 10, 1.5, 1, 2, 3), iter.fetchWayGeometry(1));
         assertEquals(Helper.createPointList(1.5, 1, 2, 3, 11, 20), iter.fetchWayGeometry(2));
 
-        assertEquals(11, g.getLatitude(1), 1e-2);
-        assertEquals(20, g.getLongitude(1), 1e-2);
+        assertEquals(11, na.getLatitude(1), 1e-2);
+        assertEquals(20, na.getLongitude(1), 1e-2);
         assertEquals(2, GHUtility.count(explorer.setBaseNode(1)));
         assertEquals(GHUtility.asSet(2, 0), GHUtility.getNeighbors(explorer.setBaseNode(1)));
 
-        assertEquals(12, g.getLatitude(2), 1e-2);
-        assertEquals(12, g.getLongitude(2), 1e-2);
+        assertEquals(12, na.getLatitude(2), 1e-2);
+        assertEquals(12, na.getLongitude(2), 1e-2);
         assertEquals(1, GHUtility.count(explorer.setBaseNode(2)));
 
         assertEquals(GHUtility.asSet(0), GHUtility.getNeighbors(explorer.setBaseNode(2)));
@@ -171,7 +168,7 @@ public void internalDisconnect()
     public void testEnsureSize()
     {
         Directory dir = new RAMDirectory();
-        graph = new GraphHopperStorage(dir, encodingManager).create(defaultSize);
+        graph = newGraph(dir, false).create(defaultSize);
         int testIndex = dir.find("edges").getSegmentSize() * 3;
         graph.edge(0, testIndex, 10, true);
 
@@ -183,10 +180,29 @@ public void testEnsureSize()
     public void testBigDataEdge()
     {
         Directory dir = new RAMDirectory();
-        GraphHopperStorage tmpGS = new GraphHopperStorage(dir, encodingManager);
-        tmpGS.create(defaultSize);
-        tmpGS.setEdgeCount(Integer.MAX_VALUE / 2);
-        assertTrue(tmpGS.getAllEdges().next());
-        tmpGS.close();
-    }  
+        GraphHopperStorage graph = new GraphHopperStorage(dir, encodingManager, false);
+        graph.create(defaultSize);
+        graph.setEdgeCount(Integer.MAX_VALUE / 2);
+        assertTrue(graph.getAllEdges().next());
+        graph.close();
+    }
+
+    @Test
+    public void testDoThrowExceptionIfDimDoesNotMatch()
+    {
+        graph = newGraph(new RAMDirectory(defaultGraphLoc, true), false);
+        graph.create(1000);
+        graph.flush();
+        graph.close();
+
+        graph = newGraph(new RAMDirectory(defaultGraphLoc, true), true);
+        try
+        {
+            graph.loadExisting();
+            assertTrue(false);
+        } catch (Exception ex)
+        {
+
+        }
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/storage/GraphHopperStorageWithTurnCostsTest.java b/core/src/test/java/com/graphhopper/storage/GraphHopperStorageWithTurnCostsTest.java
index 0cb53d3672..f02e479d25 100644
--- a/core/src/test/java/com/graphhopper/storage/GraphHopperStorageWithTurnCostsTest.java
+++ b/core/src/test/java/com/graphhopper/storage/GraphHopperStorageWithTurnCostsTest.java
@@ -36,25 +36,26 @@
     private TurnCostStorage turnCostStorage;
 
     @Override
-    protected GraphStorage newGraph( Directory dir )
+    protected GraphStorage newGraph( Directory dir, boolean is3D )
     {
         turnCostStorage = new TurnCostStorage();
-        return new GraphHopperStorage(dir, encodingManager, turnCostStorage);
+        return new GraphHopperStorage(dir, encodingManager, is3D, turnCostStorage);
     }
 
     @Override
     protected GraphStorage newRAMGraph()
     {
-        return newGraph(new RAMDirectory());
+        return newGraph(new RAMDirectory(), false);
     }
 
     @Test
     public void testSave_and_fileFormat_withTurnCostEntries() throws IOException
     {
-        graph = createGraphStorage(new RAMDirectory(defaultGraphLoc, true));
-        graph.setNode(0, 10, 10);
-        graph.setNode(1, 11, 20);
-        graph.setNode(2, 12, 12);
+        graph = newGraph(new RAMDirectory(defaultGraphLoc, true), false).create(defaultSize);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 10, 10);
+        na.setNode(1, 11, 20);
+        na.setNode(2, 12, 12);
 
         EdgeIteratorState iter2 = graph.edge(0, 1, 100, true);
         iter2.setWayGeometry(Helper.createPointList(1.5, 1, 2, 3));
@@ -75,7 +76,7 @@ public void testSave_and_fileFormat_withTurnCostEntries() throws IOException
         graph.flush();
         graph.close();
 
-        graph = newGraph(new MMapDirectory(defaultGraphLoc));
+        graph = newGraph(new MMapDirectory(defaultGraphLoc), false);
         assertTrue(graph.loadExisting());
 
         assertEquals(12, graph.getNodes());
diff --git a/core/src/test/java/com/graphhopper/storage/GraphStorage3DTest.java b/core/src/test/java/com/graphhopper/storage/GraphStorage3DTest.java
deleted file mode 100644
index 7ab2358815..0000000000
--- a/core/src/test/java/com/graphhopper/storage/GraphStorage3DTest.java
+++ /dev/null
@@ -1,68 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.storage;
-
-import com.graphhopper.routing.DijkstraBidirection;
-import com.graphhopper.routing.Path;
-import com.graphhopper.routing.util.EncodingManager;
-import com.graphhopper.routing.util.ShortestWeighting;
-import com.graphhopper.util.DistanceCalc3D;
-import com.graphhopper.util.Helper;
-import static org.junit.Assert.*;
-import org.junit.Test;
-
-/**
- *
- * @author Peter Karich
- */
-public class GraphStorage3DTest
-{
-    final EncodingManager encodingManager = new EncodingManager("CAR");
-
-    @Test
-    public void testGetHeight()
-    {
-        GraphStorage3D g = new GraphStorage3D(new RAMDirectory(), encodingManager).create(100);
-        g.setNode(0, 50, 20000.00, 100);
-        g.setNode(1, 50, 20000.02, 100);
-
-        g.setNode(2, 50, 20000.01, 200);
-        g.setNode(3, 50, 20000.01, 50);
-        g.setNode(4, 50, 20000.01, 5);
-
-        DistanceCalc3D dist = new DistanceCalc3D();
-        edge(g, dist, 0, 2);
-        edge(g, dist, 0, 3);
-        edge(g, dist, 0, 4);
-        edge(g, dist, 1, 2);
-        edge(g, dist, 1, 3);
-        edge(g, dist, 1, 4);
-
-        Path p = new DijkstraBidirection(g, encodingManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(0, 1);
-        assertEquals(Helper.createTList(0, 3, 1), p.calcNodes());
-        assertEquals(100, p.getDistance(), .1);
-    }
-
-    public static void edge( GraphStorage3D g, DistanceCalc3D dist, int from, int to )
-    {
-        double tmpDist = dist.calcDist(g.getLatitude(from), g.getLongitude(from), g.getHeight(from),
-                g.getLatitude(to), g.getLongitude(to), g.getHeight(to));
-        // System.out.println(from + "->" + to + " " + tmpDist);
-        g.edge(from, to, tmpDist, true);
-    }
-}
diff --git a/core/src/test/java/com/graphhopper/storage/GraphStorageViaMMapTest.java b/core/src/test/java/com/graphhopper/storage/GraphStorageViaMMapTest.java
index 036c8573ec..3a69d6c9af 100644
--- a/core/src/test/java/com/graphhopper/storage/GraphStorageViaMMapTest.java
+++ b/core/src/test/java/com/graphhopper/storage/GraphStorageViaMMapTest.java
@@ -23,11 +23,11 @@
 public class GraphStorageViaMMapTest extends AbstractGraphStorageTester
 {
     @Override
-    public GraphStorage createGraph( String location, int size )
+    public GraphStorage createGraph( String location, boolean is3D )
     {
-        GraphStorage gs = new GraphBuilder(encodingManager).setLocation(location).setMmap(true).build();
-        gs.setSegmentSize(size / 2);
-        gs.create(size);
+        GraphStorage gs = new GraphBuilder(encodingManager).set3D(is3D).setLocation(location).setMmap(true).build();
+        gs.setSegmentSize(defaultSize / 2);
+        gs.create(defaultSize);
         return gs;
     }
 }
diff --git a/core/src/test/java/com/graphhopper/storage/LevelGraphStorageTest.java b/core/src/test/java/com/graphhopper/storage/LevelGraphStorageTest.java
index 03ecf9b7dd..413f1538b9 100644
--- a/core/src/test/java/com/graphhopper/storage/LevelGraphStorageTest.java
+++ b/core/src/test/java/com/graphhopper/storage/LevelGraphStorageTest.java
@@ -17,6 +17,10 @@
  */
 package com.graphhopper.storage;
 
+import com.graphhopper.routing.ch.PrepareEncoder;
+import com.graphhopper.routing.util.Bike2WeightFlagEncoder;
+import com.graphhopper.routing.util.EncodingManager;
+import com.graphhopper.routing.util.FlagEncoder;
 import com.graphhopper.routing.util.LevelEdgeFilter;
 import com.graphhopper.util.EdgeIterator;
 import com.graphhopper.util.EdgeSkipIterState;
@@ -36,21 +40,15 @@ protected LevelGraphStorage createGraph()
     }
 
     @Override
-    protected LevelGraphStorage createGraphStorage( Directory dir )
+    public GraphStorage newGraph( Directory dir, boolean is3D )
     {
-        return (LevelGraphStorage) super.createGraphStorage(dir);
-    }
-
-    @Override
-    public GraphStorage newGraph( Directory dir )
-    {
-        return new LevelGraphStorage(dir, encodingManager);
+        return new LevelGraphStorage(dir, encodingManager, is3D);
     }
 
     @Test
     public void testCannotBeLoadedViaDifferentClass()
     {
-        GraphStorage g = createGraphStorage(new RAMDirectory(defaultGraphLoc, true));
+        GraphStorage g = newGraph(new RAMDirectory(defaultGraphLoc, true), false).create(defaultSize);
         g.flush();
         g.close();
 
@@ -63,7 +61,7 @@ public void testCannotBeLoadedViaDifferentClass()
         {
         }
 
-        g = newGraph(new RAMDirectory(defaultGraphLoc, true));
+        g = newGraph(new RAMDirectory(defaultGraphLoc, true), false);
         assertTrue(g.loadExisting());
     }
 
@@ -161,9 +159,9 @@ public void testGetWeight()
         LevelGraphStorage g = (LevelGraphStorage) createGraph();
         assertFalse(g.edge(0, 1).isShortcut());
         assertFalse(g.edge(1, 2).isShortcut());
-        
+
         // only remove edges
-        long flags = carEncoder.setProperties(0, true, true);
+        long flags = carEncoder.setProperties(10, true, true);
         EdgeSkipIterState sc1 = g.shortcut(0, 1);
         assertTrue(sc1.isShortcut());
         sc1.setWeight(2.001);
@@ -179,11 +177,34 @@ public void testGetWeight()
         assertTrue(carEncoder.isBackward(sc1.getFlags()));
         assertTrue(carEncoder.isForward(sc1.getFlags()));
 
-        flags = carEncoder.setProperties(0, false, true);
+        flags = carEncoder.setProperties(10, false, true);
         sc1.setFlags(flags);
         sc1.setWeight(100.123);
         assertEquals(100.123, sc1.getWeight(), 1e-3);
         assertTrue(carEncoder.isBackward(sc1.getFlags()));
         assertFalse(carEncoder.isForward(sc1.getFlags()));
     }
+
+    @Test
+    public void testGetWeightIfAdvancedEncoder()
+    {
+        FlagEncoder customEncoder = new Bike2WeightFlagEncoder();
+        LevelGraphStorage g = new GraphBuilder(new EncodingManager(customEncoder)).levelGraphCreate();
+
+        EdgeSkipIterState sc1 = g.shortcut(0, 1);
+        long flags = customEncoder.setProperties(10, false, true);
+        sc1.setFlags(flags);
+        sc1.setWeight(100.123);
+
+        assertEquals(100.123, g.getEdgeProps(sc1.getEdge(), sc1.getAdjNode()).getWeight(), 1e-3);
+        assertEquals(100.123, g.getEdgeProps(sc1.getEdge(), sc1.getBaseNode()).getWeight(), 1e-3);
+        assertEquals(100.123, ((EdgeSkipIterState) GHUtility.getEdge(g, sc1.getBaseNode(), sc1.getAdjNode())).getWeight(), 1e-3);
+        assertEquals(100.123, ((EdgeSkipIterState) GHUtility.getEdge(g, sc1.getAdjNode(), sc1.getBaseNode())).getWeight(), 1e-3);
+
+        sc1 = g.shortcut(1, 0);
+        assertTrue(sc1.isShortcut());
+        sc1.setFlags(PrepareEncoder.getScDirMask());
+        sc1.setWeight(1.011011);
+        assertEquals(1.011011, sc1.getWeight(), 1e-3);
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/storage/index/AbstractLocationIndexTester.java b/core/src/test/java/com/graphhopper/storage/index/AbstractLocationIndexTester.java
index e82b7776c0..cf996add31 100644
--- a/core/src/test/java/com/graphhopper/storage/index/AbstractLocationIndexTester.java
+++ b/core/src/test/java/com/graphhopper/storage/index/AbstractLocationIndexTester.java
@@ -25,6 +25,7 @@
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphHopperStorage;
 import com.graphhopper.storage.MMapDirectory;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.RAMDirectory;
 import com.graphhopper.util.DistanceCalc;
 import com.graphhopper.util.DistanceCalcEarth;
@@ -103,13 +104,14 @@ public void initSimpleGraph( Graph g )
         // ---|-------------------
         //    |-2 -1 0 1 2 3 4
         //
-        g.setNode(0, -1, -2);
-        g.setNode(1, 2, -1);
-        g.setNode(2, 0, 1);
-        g.setNode(3, 1, 2);
-        g.setNode(4, 6, 1);
-        g.setNode(5, 4, 4);
-        g.setNode(6, 4.5, -0.5);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, -1, -2);
+        na.setNode(1, 2, -1);
+        na.setNode(2, 0, 1);
+        na.setNode(3, 1, 2);
+        na.setNode(4, 6, 1);
+        na.setNode(5, 4, 4);
+        na.setNode(6, 4.5, -0.5);
         g.edge(0, 1, 3.5, true);
         g.edge(0, 2, 2.5, true);
         g.edge(2, 3, 1, true);
@@ -155,10 +157,11 @@ public void testGrid()
         // if we would use less array entries then some points gets the same key so avoid that for this test
         // e.g. for 16 we get "expected 6 but was 9" i.e 6 was overwritten by node j9 which is a bit closer to the grid center        
         // go through every point of the graph if all points are reachable
+        NodeAccess na = g.getNodeAccess();
         for (int i = 0; i < locs; i++)
         {
-            double lat = g.getLatitude(i);
-            double lon = g.getLongitude(i);
+            double lat = na.getLatitude(i);
+            double lon = na.getLongitude(i);
             assertEquals("nodeId:" + i + " " + (float) lat + "," + (float) lon, i, idx.findID(lat, lon));
         }
 
@@ -176,12 +179,12 @@ public void testGrid()
             double lat = rand.nextDouble() * 5;
             double lon = rand.nextDouble() * 5;
             int fullId = fullIndex.findID(lat, lon);
-            double fullLat = g.getLatitude(fullId);
-            double fullLon = g.getLongitude(fullId);
+            double fullLat = na.getLatitude(fullId);
+            double fullLon = na.getLongitude(fullId);
             float fullDist = (float) dist.calcDist(lat, lon, fullLat, fullLon);
             int newId = idx.findID(lat, lon);
-            double newLat = g.getLatitude(newId);
-            double newLon = g.getLongitude(newId);
+            double newLat = na.getLatitude(newId);
+            double newLon = na.getLongitude(newId);
             float newDist = (float) dist.calcDist(lat, lon, newLat, newLon);
 
             if (testGridIgnore(i))
@@ -245,11 +248,12 @@ public void testNoErrorOnEdgeCase_lastIndex()
     {
         final EncodingManager encodingManager = new EncodingManager("CAR");
         int locs = 10000;
-        Graph g = createGraph(new MMapDirectory(location), encodingManager);
+        Graph g = createGraph(new MMapDirectory(location), encodingManager, false);
+        NodeAccess na = g.getNodeAccess();
         Random rand = new Random(12);
         for (int i = 0; i < locs; i++)
         {
-            g.setNode(i, (float) rand.nextDouble() * 10 + 10, (float) rand.nextDouble() * 10 + 10);
+            na.setNode(i, (float) rand.nextDouble() * 10 + 10, (float) rand.nextDouble() * 10 + 10);
         }
         idx = createIndex(g, 200);
         Helper.close((Closeable) g);
@@ -257,12 +261,12 @@ public void testNoErrorOnEdgeCase_lastIndex()
 
     Graph createGraph( EncodingManager encodingManager )
     {
-        return createGraph(new RAMDirectory(), encodingManager);
+        return createGraph(new RAMDirectory(), encodingManager, false);
     }
 
-    Graph createGraph( Directory dir, EncodingManager encodingManager )
+    Graph createGraph( Directory dir, EncodingManager encodingManager, boolean is3D )
     {
-        return new GraphHopperStorage(dir, encodingManager).create(100);
+        return new GraphHopperStorage(dir, encodingManager, is3D).create(100);
     }
 
     public Graph createSampleGraph( EncodingManager encodingManager )
@@ -286,39 +290,40 @@ public Graph createSampleGraph( EncodingManager encodingManager )
 //        
 //   lon: 0   1   2   3   4   5
         int a0 = 0;
-        graph.setNode(0, 0, 1.0001f);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0, 1.0001f);
         int b1 = 1;
-        graph.setNode(1, 1, 2);
+        na.setNode(1, 1, 2);
         int c2 = 2;
-        graph.setNode(2, 0.5f, 4.5f);
+        na.setNode(2, 0.5f, 4.5f);
         int d3 = 3;
-        graph.setNode(3, 1.5f, 3.8f);
+        na.setNode(3, 1.5f, 3.8f);
         int e4 = 4;
-        graph.setNode(4, 2.01f, 0.5f);
+        na.setNode(4, 2.01f, 0.5f);
         int f5 = 5;
-        graph.setNode(5, 2, 3);
+        na.setNode(5, 2, 3);
         int g6 = 6;
-        graph.setNode(6, 3, 1.5f);
+        na.setNode(6, 3, 1.5f);
         int h7 = 7;
-        graph.setNode(7, 2.99f, 3.01f);
+        na.setNode(7, 2.99f, 3.01f);
         int i8 = 8;
-        graph.setNode(8, 3, 4);
+        na.setNode(8, 3, 4);
         int j9 = 9;
-        graph.setNode(9, 3.3f, 2.2f);
+        na.setNode(9, 3.3f, 2.2f);
         int k10 = 10;
-        graph.setNode(10, 4, 1);
+        na.setNode(10, 4, 1);
         int l11 = 11;
-        graph.setNode(11, 4.1f, 3);
+        na.setNode(11, 4.1f, 3);
         int m12 = 12;
-        graph.setNode(12, 4, 4.5f);
+        na.setNode(12, 4, 4.5f);
         int n13 = 13;
-        graph.setNode(13, 4.5f, 4.1f);
+        na.setNode(13, 4.5f, 4.1f);
         int o14 = 14;
-        graph.setNode(14, 5, 0);
+        na.setNode(14, 5, 0);
         int p15 = 15;
-        graph.setNode(15, 4.9f, 2.5f);
+        na.setNode(15, 4.9f, 2.5f);
         int q16 = 16;
-        graph.setNode(16, 5, 5);
+        na.setNode(16, 5, 5);
         // => 17 locations
 
         graph.edge(a0, b1, 1, true);
diff --git a/core/src/test/java/com/graphhopper/storage/index/BresenhamLineTest.java b/core/src/test/java/com/graphhopper/storage/index/BresenhamLineTest.java
index 669bde9b61..3def5e0395 100644
--- a/core/src/test/java/com/graphhopper/storage/index/BresenhamLineTest.java
+++ b/core/src/test/java/com/graphhopper/storage/index/BresenhamLineTest.java
@@ -33,13 +33,13 @@
  */
 public class BresenhamLineTest
 {
-    final PointList points = new PointList();
+    final PointList points = new PointList(10, false);
     PointEmitter emitter = new PointEmitter()
     {
         @Override
         public void set( double lat, double lon )
         {
-            points.add(lat, lon);
+            points.add(lat, lon, Double.NaN);
         }
     };
 
diff --git a/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeSCTest.java b/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeSCTest.java
index 7bbc0f3d8e..18259f4463 100644
--- a/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeSCTest.java
+++ b/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeSCTest.java
@@ -23,6 +23,7 @@
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.LevelGraph;
 import com.graphhopper.storage.LevelGraphStorage;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.RAMDirectory;
 import com.graphhopper.util.EdgeIteratorState;
 import com.graphhopper.util.EdgeSkipIterState;
@@ -51,26 +52,26 @@ public LocationIndexTreeSC createIndex( Graph g, int resolution )
     }
 
     @Override
-    LevelGraph createGraph( Directory dir, EncodingManager encodingManager )
+    LevelGraph createGraph( Directory dir, EncodingManager encodingManager, boolean is3D )
     {
-        return new LevelGraphStorage(dir, encodingManager).create(100);
+        return new LevelGraphStorage(dir, encodingManager, is3D).create(100);
     }
 
     @Test
     public void testLevelGraph()
     {
-        LevelGraph g = createGraph(new RAMDirectory(), encodingManager);
+        LevelGraph g = createGraph(new RAMDirectory(), encodingManager, false);
         // 0
         // 1
         // 2
         //  3
         //   4
-
-        g.setNode(0, 1, 0);
-        g.setNode(1, 0.5, 0);
-        g.setNode(2, 0, 0);
-        g.setNode(3, -1, 1);
-        g.setNode(4, -2, 2);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 1, 0);
+        na.setNode(1, 0.5, 0);
+        na.setNode(2, 0, 0);
+        na.setNode(3, -1, 1);
+        na.setNode(4, -2, 2);
 
         EdgeIteratorState iter1 = g.edge(0, 1, 10, true);
         EdgeIteratorState iter2 = g.edge(1, 2, 10, true);
@@ -97,7 +98,7 @@ public void testLevelGraph()
     @Test
     public void testSortHighLevelFirst()
     {
-        final LevelGraph lg = createGraph(new RAMDirectory(), encodingManager);
+        final LevelGraph lg = createGraph(new RAMDirectory(), encodingManager, false);
         lg.setLevel(1, 10);
         lg.setLevel(2, 30);
         lg.setLevel(3, 20);
@@ -127,11 +128,12 @@ public void testLevelGraphBug()
         // |
         // 1
 
-        LevelGraphStorage lg = (LevelGraphStorage) createGraph(new RAMDirectory(), encodingManager);
-        lg.setNode(0, 1, 0);
-        lg.setNode(1, 0, 0);
-        lg.setNode(2, 0.5, 0.5);
-        lg.setNode(3, 0.5, 1);
+        LevelGraphStorage lg = (LevelGraphStorage) createGraph(new RAMDirectory(), encodingManager, false);
+        NodeAccess na = lg.getNodeAccess();
+        na.setNode(0, 1, 0);
+        na.setNode(1, 0, 0);
+        na.setNode(2, 0.5, 0.5);
+        na.setNode(3, 0.5, 1);
         EdgeIteratorState iter1 = lg.edge(1, 0, 100, true);
         EdgeIteratorState iter2 = lg.edge(2, 3, 100, true);
 
diff --git a/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeTest.java b/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeTest.java
index ec89f029dc..863278f7a5 100644
--- a/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeTest.java
+++ b/core/src/test/java/com/graphhopper/storage/index/LocationIndexTreeTest.java
@@ -21,6 +21,7 @@
 import com.graphhopper.routing.util.EncodingManager;
 import com.graphhopper.storage.Directory;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.RAMDirectory;
 import com.graphhopper.util.BitUtil;
 import com.graphhopper.util.EdgeIteratorState;
@@ -66,12 +67,13 @@ public boolean hasEdgeSupport()
     // 2---/---/
     Graph createTestGraph()
     {
-        Graph graph = createGraph(new RAMDirectory(), encodingManager);
-        graph.setNode(0, 0.5, -0.5);
-        graph.setNode(1, -0.5, -0.5);
-        graph.setNode(2, -1, -1);
-        graph.setNode(3, -0.4, 0.9);
-        graph.setNode(4, -0.6, 1.6);
+        Graph graph = createGraph(new RAMDirectory(), encodingManager, false);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0.5, -0.5);
+        na.setNode(1, -0.5, -0.5);
+        na.setNode(2, -1, -1);
+        na.setNode(3, -0.4, 0.9);
+        na.setNode(4, -0.6, 1.6);
         graph.edge(0, 1, 1, true);
         graph.edge(0, 2, 1, true);
         graph.edge(0, 4, 1, true);
@@ -217,10 +219,11 @@ public void testReverseSpatialKey()
     public void testMoreReal()
     {
         Graph graph = createGraph(new EncodingManager("CAR"));
-        graph.setNode(1, 51.2492152, 9.4317166);
-        graph.setNode(0, 52, 9);
-        graph.setNode(2, 51.2, 9.4);
-        graph.setNode(3, 49, 10);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(1, 51.2492152, 9.4317166);
+        na.setNode(0, 52, 9);
+        na.setNode(2, 51.2, 9.4);
+        na.setNode(3, 49, 10);
 
         graph.edge(1, 0, 1000, true);
         graph.edge(0, 2, 1000, true);
@@ -241,11 +244,12 @@ public void testMoreReal()
     private Graph createTestGraphWithWayGeometry()
     {
         Graph graph = createGraph(encodingManager);
-        graph.setNode(0, 0.5, -0.5);
-        graph.setNode(1, -0.5, -0.5);
-        graph.setNode(2, -1, -1);
-        graph.setNode(3, -0.4, 0.9);
-        graph.setNode(4, -0.6, 1.6);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(0, 0.5, -0.5);
+        na.setNode(1, -0.5, -0.5);
+        na.setNode(2, -1, -1);
+        na.setNode(3, -0.4, 0.9);
+        na.setNode(4, -0.6, 1.6);
         graph.edge(0, 1, 1, true);
         graph.edge(0, 2, 1, true);
         // insert A and B, without this we would get 0 for 0,0
@@ -272,10 +276,11 @@ public void testWayGeometry()
     public void testFindingWayGeometry()
     {
         Graph g = createGraph(encodingManager);
-        g.setNode(10, 51.2492152, 9.4317166);
-        g.setNode(20, 52, 9);
-        g.setNode(30, 51.2, 9.4);
-        g.setNode(50, 49, 10);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(10, 51.2492152, 9.4317166);
+        na.setNode(20, 52, 9);
+        na.setNode(30, 51.2, 9.4);
+        na.setNode(50, 49, 10);
         g.edge(20, 50, 1, true).setWayGeometry(Helper.createPointList(51.25, 9.43));
         g.edge(10, 20, 1, true);
         g.edge(20, 30, 1, true);
@@ -304,57 +309,57 @@ public boolean accept( EdgeIteratorState iter )
     // see testgraph2.jpg
     Graph createTestGraph2()
     {
-        Graph graph = createGraph(new RAMDirectory(), encodingManager);
-
-        graph.setNode(8, 49.94553, 11.57214);
-        graph.setNode(9, 49.94553, 11.57314);
-        graph.setNode(10, 49.94553, 11.57414);
-        graph.setNode(11, 49.94553, 11.57514);
-        graph.setNode(12, 49.94553, 11.57614);
-        graph.setNode(13, 49.94553, 11.57714);
-
-        graph.setNode(0, 49.94653, 11.57114);
-        graph.setNode(1, 49.94653, 11.57214);
-        graph.setNode(2, 49.94653, 11.57314);
-        graph.setNode(3, 49.94653, 11.57414);
-        graph.setNode(4, 49.94653, 11.57514);
-        graph.setNode(5, 49.94653, 11.57614);
-        graph.setNode(6, 49.94653, 11.57714);
-        graph.setNode(7, 49.94653, 11.57814);
-
-        graph.setNode(14, 49.94753, 11.57214);
-        graph.setNode(15, 49.94753, 11.57314);
-        graph.setNode(16, 49.94753, 11.57614);
-        graph.setNode(17, 49.94753, 11.57814);
-
-        graph.setNode(18, 49.94853, 11.57114);
-        graph.setNode(19, 49.94853, 11.57214);
-        graph.setNode(20, 49.94853, 11.57814);
-
-        graph.setNode(21, 49.94953, 11.57214);
-        graph.setNode(22, 49.94953, 11.57614);
-
-        graph.setNode(23, 49.95053, 11.57114);
-        graph.setNode(24, 49.95053, 11.57214);
-        graph.setNode(25, 49.95053, 11.57314);
-        graph.setNode(26, 49.95053, 11.57514);
-        graph.setNode(27, 49.95053, 11.57614);
-        graph.setNode(28, 49.95053, 11.57714);
-        graph.setNode(29, 49.95053, 11.57814);
-
-        graph.setNode(30, 49.95153, 11.57214);
-        graph.setNode(31, 49.95153, 11.57314);
-        graph.setNode(32, 49.95153, 11.57514);
-        graph.setNode(33, 49.95153, 11.57614);
-        graph.setNode(34, 49.95153, 11.57714);
-
-        graph.setNode(34, 49.95153, 11.57714);
+        Graph graph = createGraph(new RAMDirectory(), encodingManager, false);
+        NodeAccess na = graph.getNodeAccess();
+        na.setNode(8, 49.94553, 11.57214);
+        na.setNode(9, 49.94553, 11.57314);
+        na.setNode(10, 49.94553, 11.57414);
+        na.setNode(11, 49.94553, 11.57514);
+        na.setNode(12, 49.94553, 11.57614);
+        na.setNode(13, 49.94553, 11.57714);
+
+        na.setNode(0, 49.94653, 11.57114);
+        na.setNode(1, 49.94653, 11.57214);
+        na.setNode(2, 49.94653, 11.57314);
+        na.setNode(3, 49.94653, 11.57414);
+        na.setNode(4, 49.94653, 11.57514);
+        na.setNode(5, 49.94653, 11.57614);
+        na.setNode(6, 49.94653, 11.57714);
+        na.setNode(7, 49.94653, 11.57814);
+
+        na.setNode(14, 49.94753, 11.57214);
+        na.setNode(15, 49.94753, 11.57314);
+        na.setNode(16, 49.94753, 11.57614);
+        na.setNode(17, 49.94753, 11.57814);
+
+        na.setNode(18, 49.94853, 11.57114);
+        na.setNode(19, 49.94853, 11.57214);
+        na.setNode(20, 49.94853, 11.57814);
+
+        na.setNode(21, 49.94953, 11.57214);
+        na.setNode(22, 49.94953, 11.57614);
+
+        na.setNode(23, 49.95053, 11.57114);
+        na.setNode(24, 49.95053, 11.57214);
+        na.setNode(25, 49.95053, 11.57314);
+        na.setNode(26, 49.95053, 11.57514);
+        na.setNode(27, 49.95053, 11.57614);
+        na.setNode(28, 49.95053, 11.57714);
+        na.setNode(29, 49.95053, 11.57814);
+
+        na.setNode(30, 49.95153, 11.57214);
+        na.setNode(31, 49.95153, 11.57314);
+        na.setNode(32, 49.95153, 11.57514);
+        na.setNode(33, 49.95153, 11.57614);
+        na.setNode(34, 49.95153, 11.57714);
+
+        na.setNode(34, 49.95153, 11.57714);
 
         // to create correct bounds
         // bottom left
-        graph.setNode(100, 49.94053, 11.56614);
+        na.setNode(100, 49.94053, 11.56614);
         // bottom right
-        graph.setNode(101, 49.96053, 11.58814);
+        na.setNode(101, 49.96053, 11.58814);
 
         graph.edge(0, 1, 10, true);
         graph.edge(1, 2, 10, true);
diff --git a/core/src/test/java/com/graphhopper/trees/QTDataNodeTest.java b/core/src/test/java/com/graphhopper/trees/QTDataNodeTest.java
deleted file mode 100644
index 54ea583e5a..0000000000
--- a/core/src/test/java/com/graphhopper/trees/QTDataNodeTest.java
+++ /dev/null
@@ -1,87 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import org.junit.*;
-import static org.junit.Assert.*;
-
-/**
- *
- * @author Peter Karich
- */
-public class QTDataNodeTest
-{
-    @Test
-    public void testGetMemoryUsageInBytes()
-    {
-        QTDataNode<Integer> dn = new QTDataNode<Integer>(8);
-        dn.keys[1] = 111;
-        // dn.values[1] = (Integer) 222;
-        assertEquals(0, dn.count());
-        dn.add(1, 1);
-        assertEquals(1, dn.count());
-    }
-
-    @Test
-    public void testAddDuplicates()
-    {
-        QTDataNode<String> dn = new QTDataNode<String>(4);
-        dn.add(1, "test1");
-        assertEquals(1, dn.count());
-        dn.add(1, "test5");
-        dn.add(1, "test2");
-        assertEquals(3, dn.count());
-    }
-
-    @Test
-    public void testNodeAdd()
-    {
-        QTDataNode<String> dn = new QTDataNode<String>(2);
-        assertFalse(dn.add(1, "test1"));
-        assertFalse(dn.add(5, "test5"));
-        assertTrue(dn.add(2, "test2"));
-    }
-
-    @Test
-    public void testNodeRemove()
-    {
-        QTDataNode<String> dn = new QTDataNode<String>(4);
-        dn.add(1, "test1");
-        dn.add(5, "test5");
-        dn.add(2, "test2");
-        dn.add(3, "test3");
-
-        assertEquals(1, dn.remove(3));
-        assertEquals(1, dn.remove(5));
-
-        assertNull(dn.getValue(5));
-        assertNull(dn.getValue(3));
-        assertEquals("test1", dn.getValue(1));
-        assertEquals("test2", dn.getValue(2));
-    }
-
-    @Test
-    public void testNodeRemoveWithDuplicates()
-    {
-        QTDataNode<String> dn = new QTDataNode<String>(4);
-        dn.add(1, "test1");
-        dn.add(1, "test5");
-
-        assertEquals(2, dn.remove(1));
-    }
-}
diff --git a/core/src/test/java/com/graphhopper/trees/QuadTreeSimple8Test.java b/core/src/test/java/com/graphhopper/trees/QuadTreeSimple8Test.java
deleted file mode 100644
index 4111ba07f9..0000000000
--- a/core/src/test/java/com/graphhopper/trees/QuadTreeSimple8Test.java
+++ /dev/null
@@ -1,33 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-/**
- *
- * @author Peter Karich
- */
-public class QuadTreeSimple8Test extends QuadTreeTester
-{
-    @Override
-    protected QuadTree<Long> createQuadTree( long items )
-    {
-        QuadTreeSimple<Long> qt = new QuadTreeSimple<Long>(8);
-        qt.init(items);
-        return qt;
-    }
-}
diff --git a/core/src/test/java/com/graphhopper/trees/QuadTreeSimpleTest.java b/core/src/test/java/com/graphhopper/trees/QuadTreeSimpleTest.java
deleted file mode 100644
index 67c6090060..0000000000
--- a/core/src/test/java/com/graphhopper/trees/QuadTreeSimpleTest.java
+++ /dev/null
@@ -1,48 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import org.junit.Test;
-import static org.junit.Assert.*;
-
-/**
- *
- * @author Peter Karich
- */
-public class QuadTreeSimpleTest extends QuadTreeTester
-{
-    @Override
-    protected QuadTree<Long> createQuadTree( long items )
-    {
-        QuadTreeSimple<Long> qt = new QuadTreeSimple<Long>();
-        qt.init(items);
-        return qt;
-    }
-
-    @Test
-    public void testNodePutNull()
-    {
-        try
-        {
-            createQuadTree(10).add(10, 10, null);
-            assertTrue("an exception should be thrown on 'storing null' as we rely on this in datanode", false);
-        } catch (Exception ex)
-        {
-        }
-    }
-}
diff --git a/core/src/test/java/com/graphhopper/trees/QuadTreeTester.java b/core/src/test/java/com/graphhopper/trees/QuadTreeTester.java
deleted file mode 100644
index dffe79dc04..0000000000
--- a/core/src/test/java/com/graphhopper/trees/QuadTreeTester.java
+++ /dev/null
@@ -1,221 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.trees;
-
-import com.graphhopper.util.shapes.BBox;
-import com.graphhopper.util.shapes.CoordTrig;
-import java.util.Collection;
-import java.util.Iterator;
-import org.junit.*;
-import static org.junit.Assert.*;
-
-/**
- *
- * @author Peter Karich
- */
-public abstract class QuadTreeTester
-{
-    protected abstract QuadTree<Long> createQuadTree( long items );
-
-    @Test
-    public void testSize()
-    {
-        QuadTree instance = createQuadTree(100);
-        assertEquals(0, instance.getSize());
-    }
-
-    @Test
-    public void testPutAndGet()
-    {
-        QuadTree<Long> instance = createQuadTree(100);
-        assertEquals(0, instance.getNodesFromValue(12, 10, null).size());
-        instance.add(12, 10, 111L);
-        assertEquals(1, instance.getSize());
-        assertEquals(111, (long) instance.getNodesFromValue(12, 10, null).iterator().next().getValue());
-
-        instance.add(12, 10, 222L);
-        assertEquals(2, instance.getSize());
-
-        instance.add(12, 12, 333L);
-        assertEquals(3, instance.getSize());
-
-        assertEquals(2, instance.getNodesFromValue(12, 10, null).size());
-        instance.add(12.0001, 12.0001, 444L);
-        assertEquals(4, instance.getSize());
-        assertEquals(444, (long) instance.getNodesFromValue(12.0001, 12.0001, null).iterator().next().getValue());
-        assertEquals(0, instance.getNodesFromValue(12.0001, 12.0001, 445L).size());
-
-        instance.add(10, 10, 1010L);
-        assertEquals(5, instance.getSize());
-        assertEquals(1010, (long) instance.getNodesFromValue(10, 10, null).iterator().next().getValue());
-
-        instance.add(10, 12, 1012L);
-
-        assertEquals(6, instance.getSize());
-        assertEquals(444, (long) instance.getNodesFromValue(12.0001, 12.0001, null).iterator().next().getValue());
-        assertEquals(1010, (long) instance.getNodesFromValue(10, 10, null).iterator().next().getValue());
-        assertEquals(1012, (long) instance.getNodesFromValue(10, 12, null).iterator().next().getValue());
-
-        instance.clear();
-        assertEquals(0, instance.getSize());
-    }
-
-    @Test
-    public void testPutBatch()
-    {
-        int max = 100;
-        QuadTree<Long> instance = createQuadTree(max);
-        for (long i = 0; i < max; i++)
-        {
-            instance.add(i / 100.0, i / 100.0, i);
-            assertEquals(i + 1, instance.getSize());
-        }
-
-        assertEquals(max, instance.getSize());
-        for (int i = 0; i < max; i++)
-        {
-            Collection<CoordTrig<Long>> coll = instance.getNodesFromValue(i / 100.0, i / 100.0, null);
-            assertEquals(i + "/" + max, 1, coll.size());
-            Long val = (Long) coll.iterator().next().getValue();
-            assertNotNull(i + "/" + max, val);
-            assertEquals(i + "/" + max, i, (long) val);
-        }
-
-        for (int i = 0; i < max; i++)
-        {
-            assertEquals(max - i, instance.getSize());
-            Collection<CoordTrig<Long>> res = instance.getNodes(i / 100.0, i / 100.0, 1d);
-            CoordTrig<Long> coord = res.iterator().next();
-            assertEquals("couldn't remove " + i / 100.0 + " -> " + coord, 1, instance.remove(coord.lat, coord.lon));
-        }
-    }
-
-    @Test
-    public void testRemove()
-    {
-        QuadTree<Long> instance = createQuadTree(100);
-
-        assertEquals(0, instance.remove(7.002f, 7.001f));
-        instance.add(12, 10, 111L);
-        assertEquals(1, instance.getSize());
-
-        assertEquals(1, instance.remove(12, 10));
-        assertEquals(0, instance.getNodesFromValue(12, 10, null).size());
-        assertEquals(0, instance.getSize());
-
-        instance.add(12, 10, 111L);
-        instance.add(12, 10.1, 222L);
-        assertEquals(2, instance.getSize());
-        // System.out.println(instance.toDetailString());
-        assertEquals(1, instance.remove(12, 10));
-        // System.out.println(instance.toDetailString());
-        assertEquals(1, instance.getSize());
-        assertEquals(0, instance.getNodesFromValue(12, 10, null).size());
-        assertEquals(222, (long) instance.getNodesFromValue(12, 10.1, null).iterator().next().getValue());
-    }
-
-    @Test
-    public void testGetNeighboursExactHit()
-    {
-        QuadTree<Long> instance = createQuadTree(100);
-        Collection<CoordTrig<Long>> coll = instance.getNodes(8.124, 8.123, 10000);
-        assertTrue(coll.isEmpty());
-
-        instance.add(8.124, 8.123, 1L);
-        instance.add(8.123, 8.123, 2L);
-        instance.add(9.124, 8.123, 3l);
-        assertEquals(3, instance.getSize());
-
-        // search in 10km - exact hit
-        coll = instance.getNodes(8.124, 8.123, 10000);
-        assertEquals(2, coll.size());
-
-        coll = instance.getNodes(8.124, 8.123, 120000);
-        assertEquals(3, coll.size());
-    }
-
-    @Test
-    public void testGetNeighboursSearch()
-    {
-        QuadTree<Long> instance = createQuadTree(100);
-        Collection<CoordTrig<Long>> coll = instance.getNodes(8.124, 8.123, 10000);
-        assertTrue(coll.isEmpty());
-
-        instance.add(8.124, 8.123, 1L);
-        instance.add(8.123, 8.123, 2L);
-        instance.add(9.124, 8.123, 3L);
-        instance.add(8, 9, 4L);
-        instance.add(9, 9, 5L);
-        instance.add(7, 7, 6L);
-        instance.add(7, 8, 7L);
-        instance.add(7, 9, 8L);
-        instance.add(8, 7, 9L);
-        instance.add(9, 7, 10L);
-
-        // distances from 8.12, 8.12
-        //
-        // 9,7: 157.29199    9.124,8.123: 111.64019   9,9: 137.61365
-        //
-        // 8,7: 124.02789    distance:0               8,9: 97.79944
-        //
-        // 7,7: 175.3585     7,8: 125.23878           7,9: 157.85646
-        //
-//        CalcDistance c = new CalcDistance();
-//        System.out.println("9.124, 8.123:" + c.calcDistKm(9.124, 8.123, 8.12, 8.12));
-//        System.out.println("8,9:" + c.calcDistKm(8, 9, 8.12, 8.12));
-//        System.out.println("9,9:" + c.calcDistKm(9, 9, 8.12, 8.12));
-//        System.out.println("7,7:" + c.calcDistKm(7, 7, 8.12, 8.12));
-//        System.out.println("7,8:" + c.calcDistKm(7, 8, 8.12, 8.12));
-//        System.out.println("7,9:" + c.calcDistKm(7, 9, 8.12, 8.12));
-//        System.out.println("8,7:" + c.calcDistKm(8, 7, 8.12, 8.12));
-//        System.out.println("9,7:" + c.calcDistKm(9, 7, 8.12, 8.12));
-        assertEquals(10, instance.getSize());
-
-        assertEquals(2, instance.getNodes(8.12, 8.12, 10000).size());
-        assertEquals(2, instance.getNodes(8.12, 8.12, 50000).size());
-        assertEquals(1, instance.getNodes(8.12, 8.12, 500).size());
-        Iterator<CoordTrig<Long>> iter = instance.getNodes(8.12, 8.12, 500).iterator();
-        assertEquals(2, (long) iter.next().getValue());
-        assertEquals(3, instance.getNodes(8.12, 8.12, 100000).size());
-//        System.out.println(instance.getNodes(8.12, 8.12, 130));
-        assertEquals(6, instance.getNodes(8.12, 8.12, 130000).size());
-        assertEquals(9, instance.getNodes(8.12, 8.12, 175000).size());
-        assertEquals(10, instance.getNodes(8.12, 8.12, 176000).size());
-    }
-
-    public static void assertOrder( Collection<CoordTrig> coll, double... latitudes )
-    {
-        Iterator<CoordTrig> iter = coll.iterator();
-        for (int i = 0; i < latitudes.length; i++)
-        {
-            double f = latitudes[i];
-            CoordTrig f2d = iter.next();
-            assertEquals(f, f2d.lat, 1e-8);
-        }
-        assertFalse("There are more than " + latitudes.length + " items", iter.hasNext());
-    }
-
-    public static void assertCount( int c, Iterator iter )
-    {
-        for (int i = c; i >= 0; i--)
-        {
-            iter.next();
-        }
-        assertFalse("There are more than " + c + " items", iter.hasNext());
-    }
-}
diff --git a/core/src/test/java/com/graphhopper/util/AbstractBitUtilTester.java b/core/src/test/java/com/graphhopper/util/AbstractBitUtilTester.java
index 8f44409ddb..48a9fc00ac 100644
--- a/core/src/test/java/com/graphhopper/util/AbstractBitUtilTester.java
+++ b/core/src/test/java/com/graphhopper/util/AbstractBitUtilTester.java
@@ -59,6 +59,22 @@ public void testToInt()
         assertEquals(Integer.MAX_VALUE / 3, bitUtil.toInt(bytes));
     }
 
+    @Test
+    public void testToShort()
+    {
+        byte[] bytes = bitUtil.fromShort(Short.MAX_VALUE);
+        assertEquals(Short.MAX_VALUE, bitUtil.toShort(bytes));
+
+        bytes = bitUtil.fromShort((short) (Short.MAX_VALUE / 3));
+        assertEquals(Short.MAX_VALUE / 3, bitUtil.toShort(bytes));
+
+        bytes = bitUtil.fromShort((short) -123);
+        assertEquals(-123, bitUtil.toShort(bytes));
+
+        bytes = bitUtil.fromShort((short) (0xFF | 0xFF));
+        assertEquals(0xFF | 0xFF, bitUtil.toShort(bytes));
+    }
+
     @Test
     public void testToLong()
     {
diff --git a/core/src/test/java/com/graphhopper/util/AngleCalcTest.java b/core/src/test/java/com/graphhopper/util/AngleCalcTest.java
new file mode 100644
index 0000000000..2291fa22f7
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/util/AngleCalcTest.java
@@ -0,0 +1,78 @@
+/*
+ *  Licensed to GraphHopper and Peter Karich under one or more contributor
+ *  license agreements. See the NOTICE file distributed with this work for 
+ *  additional information regarding copyright ownership.
+ * 
+ *  GraphHopper licenses this file to you under the Apache License, 
+ *  Version 2.0 (the "License"); you may not use this file except in 
+ *  compliance with the License. You may obtain a copy of the License at
+ * 
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util;
+
+import static org.junit.Assert.*;
+import org.junit.Test;
+
+/**
+ * @author Johannes Pelzer
+ * @author Peter Karich
+ */
+public class AngleCalcTest
+{
+    private final AngleCalc2D ac = new AngleCalc2D();
+
+    @Test
+    public void testOrientation()
+    {
+        assertEquals(90.0, Math.toDegrees(ac.calcOrientation(0, 0, 10, 0)), 0.0001);
+        assertEquals(45.0, Math.toDegrees(ac.calcOrientation(0, 0, 10, 10)), 0.0001);
+        assertEquals(0.0, Math.toDegrees(ac.calcOrientation(0, 0, 0, 10)), 0.0001);
+        assertEquals(-135.0, Math.toDegrees(ac.calcOrientation(0, 0, -10, -10)), 0.0001);
+    }
+
+    @Test
+    public void testOrientationNorth()
+    {
+        assertEquals(0.0, Math.toDegrees(ac.calcOrientationNorth(0, 0, 10, 0)), 0.0001);
+        assertEquals(45.0, Math.toDegrees(ac.calcOrientationNorth(0, 0, 10, 10)), 0.0001);
+        assertEquals(90.0, Math.toDegrees(ac.calcOrientationNorth(0, 0, 0, 10)), 0.0001);
+        assertEquals(-135.0, Math.toDegrees(ac.calcOrientationNorth(0, 0, -10, -10)), 0.0001);
+    }
+
+    @Test
+    public void testAlignOrientation()
+    {
+        assertEquals(90.0, Math.toDegrees(ac.alignOrientation(Math.toRadians(90), Math.toRadians(90))), 0.0001);
+        assertEquals(225.0, Math.toDegrees(ac.alignOrientation(Math.toRadians(90), Math.toRadians(-135))), 0.0001);
+        assertEquals(-45.0, Math.toDegrees(ac.alignOrientation(Math.toRadians(-135), Math.toRadians(-45))), 0.0001);
+        assertEquals(-270.0, Math.toDegrees(ac.alignOrientation(Math.toRadians(-135), Math.toRadians(90))), 0.0001);
+    }
+
+    @Test
+    public void testCombined()
+    {
+        double orientation = ac.calcOrientation(52.414918, 13.244221, 52.415333, 13.243595);
+        assertEquals(146.458, Math.toDegrees(ac.alignOrientation(0, orientation)), 0.001);
+    }
+
+    @Test
+    public void testCalcAzimuth()
+    {
+        assertEquals(90.0, ac.calcAzimuth(0, 0, 0, 10), 0.0001);
+        assertEquals(180.0, ac.calcAzimuth(0, 0, -10, 0), 0.0001);
+        assertEquals(270.0, ac.calcAzimuth(0, 0, 0, -10), 0.0001);
+    }
+
+    @Test
+    public void testAzimuthCompassPoint()
+    {
+        assertEquals("S", ac.azimuth2compassPoint(199));
+    }
+}
diff --git a/core/src/test/java/com/graphhopper/util/DistanceCalcEarthTest.java b/core/src/test/java/com/graphhopper/util/DistanceCalcEarthTest.java
index 3413d0dc91..3f12d3d8e3 100644
--- a/core/src/test/java/com/graphhopper/util/DistanceCalcEarthTest.java
+++ b/core/src/test/java/com/graphhopper/util/DistanceCalcEarthTest.java
@@ -35,14 +35,6 @@ public void testCalcCircumference()
         assertEquals(DistanceCalcEarth.C, dc.calcCircumference(0), 1e-7);
     }
 
-    @Test
-    public void testRound()
-    {
-        assertEquals(100.94, DistanceCalcEarth.round(100.94, 2), 1e-7);
-        assertEquals(100.9, DistanceCalcEarth.round(100.94, 1), 1e-7);
-        assertEquals(101.0, DistanceCalcEarth.round(100.95, 1), 1e-7);
-    }
-
     @Test
     public void testGeohashMaxDist()
     {
diff --git a/core/src/test/java/com/graphhopper/util/DouglasPeuckerTest.java b/core/src/test/java/com/graphhopper/util/DouglasPeuckerTest.java
index 9bec61fda7..c13e850f06 100644
--- a/core/src/test/java/com/graphhopper/util/DouglasPeuckerTest.java
+++ b/core/src/test/java/com/graphhopper/util/DouglasPeuckerTest.java
@@ -28,7 +28,7 @@
 {
 
     // get some real life points from graphhopper API
-    // http://217.92.216.224:8080/api?from=49.945642,11.571436&to=49.946001,11.580706
+    // http://217.92.216.224:8080/?point=49.945642,11.571436&point=49.946001,11.580706
     String points1 = "[[11.571499218899739,49.945605917549265],[11.571664621792689,49.94570668665409],[11.571787742639804,49.94578156499077],[11.572065649302282,49.94590338198625],[11.572209445511016,49.94595944760649],[11.57229438213172,49.94598850487147],"
             + "[11.573315297960832,49.946237913062525],[11.57367665112786,49.946338495902836],[11.573895511937787,49.94641784458796],[11.574013417378367,49.94646347939514],[11.574228180368875,49.94654916107392],[11.574703899950622,49.94677509993557],"
             + "[11.575003599561832,49.946924670344394],[11.575434615658997,49.94711838544425],[11.575559971680342,49.94716010869652],[11.57563783024932,49.947186185729194],[11.57609697228887,49.94727875919518],[11.57656188852851,49.947290121330845],"
@@ -40,7 +40,7 @@
     public void testParse()
     {
         PointList pointList = new PointList();
-        pointList.parseJSON("[[11.571499218899739,49.945605917549265],[11.571664621792689,49.94570668665409]]");
+        pointList.parse2DJSON("[[11.571499218899739,49.945605917549265],[11.571664621792689,49.94570668665409]]");
         assertEquals(49.945605917549265, pointList.getLatitude(0), 1e-6);
         assertEquals(11.571499218899739, pointList.getLongitude(0), 1e-6);
         assertEquals(49.94570668665409, pointList.getLatitude(1), 1e-6);
@@ -51,7 +51,7 @@ public void testParse()
     public void testPathSimplify()
     {
         PointList pointList = new PointList();
-        pointList.parseJSON(points1);
+        pointList.parse2DJSON(points1);
         assertEquals(32, pointList.getSize());
         new DouglasPeucker().setMaxDistance(.5).simplify(pointList);
         // Arrays.asList(2, 4, 6, 7, 8, 9, 12, 14, 15, 17, 18, 19, 20, 22, 24, 27, 28, 29, 31, 33),
@@ -62,7 +62,7 @@ public void testPathSimplify()
     public void testSimplifyCheckPointCount()
     {
         PointList pointList = new PointList();
-        pointList.parseJSON(points1);
+        pointList.parse2DJSON(points1);
         DouglasPeucker dp = new DouglasPeucker().setMaxDistance(.5);
         assertEquals(32, pointList.getSize());
         dp.simplify(pointList);
@@ -76,7 +76,7 @@ public void testSimplifyCheckPointCount()
     public void testSimplifyCheckPointOrder()
     {
         PointList pointList = new PointList();
-        pointList.parseJSON(points2);
+        pointList.parse2DJSON(points2);
         assertEquals(13, pointList.getSize());
         new DouglasPeucker().setMaxDistance(.5).simplify(pointList);
         assertEquals(11, pointList.getSize());
diff --git a/core/src/test/java/com/graphhopper/util/GHUtilityTest.java b/core/src/test/java/com/graphhopper/util/GHUtilityTest.java
index be3c671cdd..88b4702d2e 100644
--- a/core/src/test/java/com/graphhopper/util/GHUtilityTest.java
+++ b/core/src/test/java/com/graphhopper/util/GHUtilityTest.java
@@ -21,6 +21,7 @@
 import com.graphhopper.storage.GraphBuilder;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.LevelGraph;
+import com.graphhopper.storage.NodeAccess;
 import static org.junit.Assert.*;
 import org.junit.Test;
 
@@ -39,15 +40,16 @@ Graph createGraph()
 
     Graph initUnsorted( Graph g )
     {
-        g.setNode(0, 0, 1);
-        g.setNode(1, 2.5, 4.5);
-        g.setNode(2, 4.5, 4.5);
-        g.setNode(3, 3, 0.5);
-        g.setNode(4, 2.8, 2.8);
-        g.setNode(5, 4.2, 1.6);
-        g.setNode(6, 2.3, 2.2);
-        g.setNode(7, 5, 1.5);
-        g.setNode(8, 4.6, 4);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0, 1);
+        na.setNode(1, 2.5, 4.5);
+        na.setNode(2, 4.5, 4.5);
+        na.setNode(3, 3, 0.5);
+        na.setNode(4, 2.8, 2.8);
+        na.setNode(5, 4.2, 1.6);
+        na.setNode(6, 2.3, 2.2);
+        na.setNode(7, 5, 1.5);
+        na.setNode(8, 4.6, 4);
         g.edge(8, 2, 0.5, true);
         g.edge(7, 3, 2.1, false);
         g.edge(1, 0, 3.9, true);
@@ -63,13 +65,14 @@ public void testSort()
         Graph g = initUnsorted(createGraph());
         Graph newG = GHUtility.sortDFS(g, createGraph());
         assertEquals(g.getNodes(), newG.getNodes());
-        assertEquals(0, newG.getLatitude(0), 1e-4); // 0
-        assertEquals(2.5, newG.getLatitude(1), 1e-4); // 1
-        assertEquals(4.6, newG.getLatitude(2), 1e-4); // 8
-        assertEquals(4.5, newG.getLatitude(3), 1e-4); // 2                
-        assertEquals(3.0, newG.getLatitude(4), 1e-4); // 3
-        assertEquals(5.0, newG.getLatitude(5), 1e-4); // 7
-        assertEquals(4.2, newG.getLatitude(6), 1e-4); // 5
+        NodeAccess na = newG.getNodeAccess();
+        assertEquals(0, na.getLatitude(0), 1e-4); // 0
+        assertEquals(2.5, na.getLatitude(1), 1e-4); // 1
+        assertEquals(4.6, na.getLatitude(2), 1e-4); // 8
+        assertEquals(4.5, na.getLatitude(3), 1e-4); // 2                
+        assertEquals(3.0, na.getLatitude(4), 1e-4); // 3
+        assertEquals(5.0, na.getLatitude(5), 1e-4); // 7
+        assertEquals(4.2, na.getLatitude(6), 1e-4); // 5
     }
 
     @Test
@@ -79,24 +82,38 @@ public void testSort2()
         Graph newG = GHUtility.sortDFS(g, createGraph());
         // TODO does not handle subnetworks
         assertEquals(g.getNodes(), newG.getNodes());
-        assertEquals(0, newG.getLatitude(0), 1e-4); // 0
-        assertEquals(2.5, newG.getLatitude(1), 1e-4); // 1
-        assertEquals(4.6, newG.getLatitude(2), 1e-4); // 8
-        assertEquals(4.5, newG.getLatitude(3), 1e-4); // 2        
+        NodeAccess na = newG.getNodeAccess();
+        assertEquals(0, na.getLatitude(0), 1e-4); // 0
+        assertEquals(2.5, na.getLatitude(1), 1e-4); // 1
+        assertEquals(4.6, na.getLatitude(2), 1e-4); // 8
+        assertEquals(4.5, na.getLatitude(3), 1e-4); // 2        
     }
 
     @Test
     public void testSortDirected()
     {
         Graph g = createGraph();
-        g.setNode(0, 0, 1);
-        g.setNode(1, 2.5, 2);
-        g.setNode(2, 3.5, 3);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 0, 1);
+        na.setNode(1, 2.5, 2);
+        na.setNode(2, 3.5, 3);
         g.edge(0, 1, 1.1, false);
         g.edge(2, 1, 1.1, false);
         GHUtility.sortDFS(g, createGraph());
     }
 
+    @Test
+    public void testCopyWithSelfRef()
+    {
+        Graph g = initUnsorted(createGraph());
+        EdgeIteratorState eb = g.edge(0, 0, 11, true);
+
+        LevelGraph lg = new GraphBuilder(encodingManager).levelGraphCreate();
+        GHUtility.copyTo(g, lg);
+
+        assertEquals(g.getAllEdges().getMaxId(), lg.getAllEdges().getMaxId());
+    }
+
     @Test
     public void testCopy()
     {
@@ -111,17 +128,18 @@ public void testCopy()
 
         assertEquals(0, lg.getLevel(0));
         assertEquals(0, lg.getLevel(1));
-        assertEquals(0, lg.getLatitude(0), 1e-6);
-        assertEquals(1, lg.getLongitude(0), 1e-6);
-        assertEquals(2.5, lg.getLatitude(1), 1e-6);
-        assertEquals(4.5, lg.getLongitude(1), 1e-6);
+        NodeAccess na = lg.getNodeAccess();
+        assertEquals(0, na.getLatitude(0), 1e-6);
+        assertEquals(1, na.getLongitude(0), 1e-6);
+        assertEquals(2.5, na.getLatitude(1), 1e-6);
+        assertEquals(4.5, na.getLongitude(1), 1e-6);
         assertEquals(9, lg.getNodes());
         EdgeIterator iter = lg.createEdgeExplorer().setBaseNode(8);
         iter.next();
-        assertEquals(0.5, iter.getDistance(), 1e-6);
+        assertEquals(2.05, iter.getDistance(), 1e-6);
         assertEquals("11", BitUtil.BIG.toLastBitString(iter.getFlags(), 2));
         iter.next();
-        assertEquals(2.05, iter.getDistance(), 1e-6);
+        assertEquals(0.5, iter.getDistance(), 1e-6);
         assertEquals("11", BitUtil.BIG.toLastBitString(iter.getFlags(), 2));
 
         iter = lg.createEdgeExplorer().setBaseNode(7);
diff --git a/core/src/test/java/com/graphhopper/util/InstructionListTest.java b/core/src/test/java/com/graphhopper/util/InstructionListTest.java
index f09c459512..2fff266992 100644
--- a/core/src/test/java/com/graphhopper/util/InstructionListTest.java
+++ b/core/src/test/java/com/graphhopper/util/InstructionListTest.java
@@ -24,9 +24,12 @@
 import com.graphhopper.routing.util.ShortestWeighting;
 import com.graphhopper.storage.Graph;
 import com.graphhopper.storage.GraphBuilder;
+import com.graphhopper.storage.NodeAccess;
+import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
 import java.util.Locale;
+import java.util.*;
 import org.junit.Test;
 import static org.junit.Assert.*;
 
@@ -48,18 +51,19 @@ public void testWayList()
         // 3-4-5  9-10
         // | | |  |
         // 6-7-8--*
-        g.setNode(0, 1.2, 1.0);
-        g.setNode(1, 1.2, 1.1);
-        g.setNode(2, 1.2, 1.2);
-        g.setNode(3, 1.1, 1.0);
-        g.setNode(4, 1.1, 1.1);
-        g.setNode(5, 1.1, 1.2);
-        g.setNode(9, 1.1, 1.3);
-        g.setNode(10, 1.1, 1.4);
-
-        g.setNode(6, 1.0, 1.0);
-        g.setNode(7, 1.0, 1.1);
-        g.setNode(8, 1.0, 1.2);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(0, 1.2, 1.0);
+        na.setNode(1, 1.2, 1.1);
+        na.setNode(2, 1.2, 1.2);
+        na.setNode(3, 1.1, 1.0);
+        na.setNode(4, 1.1, 1.1);
+        na.setNode(5, 1.1, 1.2);
+        na.setNode(9, 1.1, 1.3);
+        na.setNode(10, 1.1, 1.4);
+
+        na.setNode(6, 1.0, 1.0);
+        na.setNode(7, 1.0, 1.1);
+        na.setNode(8, 1.0, 1.2);
         g.edge(0, 1, 10000, true).setName("0-1");
         g.edge(1, 2, 11000, true).setName("1-2");
 
@@ -88,20 +92,23 @@ public void testWayList()
 
         Path p = new Dijkstra(g, carManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(0, 10);
         InstructionList wayList = p.calcInstructions();
+        List<String> tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.CANADA)));
         assertEquals(Arrays.asList("Continue onto 0-1", "Turn right onto 1-4", "Continue onto 4-7",
                 "Turn left onto 7-8", "Continue onto 8-9", "Turn right onto road", "Finish!"),
-                wayList.createDescription(trMap.getWithFallBack(Locale.CANADA)));
+                tmpList);
 
+        tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.GERMAN)));
         assertEquals(Arrays.asList("Geradeaus auf 0-1", "Rechts abbiegen auf 1-4", "Geradeaus auf 4-7",
                 "Links abbiegen auf 7-8", "Geradeaus auf 8-9", "Rechts abbiegen auf Strasse", "Ziel erreicht!"),
-                wayList.createDescription(trMap.getWithFallBack(Locale.GERMAN)));
+                tmpList);
 
-        List<Double> distList = wayList.createDistances();
-        assertEquals(70000.0, sum(distList), 1e-1);
+        assertEquals(70000.0, sumDistances(wayList), 1e-1);
         List<String> distStrings = wayList.createDistances(trMap.get("de"), false);
-        assertEquals(Arrays.asList("10.0 km", "10.0 km", "10.0 km", "10.0 km", "20.0 km", "10.0 km", "0 m"), distStrings);
+        assertEquals(Arrays.asList("10.0 km", "10.0 km", "10.0 km", "10.0 km", "20.0 km", "10.0 km", "0 m"),
+                distStrings);
         distStrings = wayList.createDistances(trMap.get("en_US"), true);
-        assertEquals(Arrays.asList("6.21 mi", "6.21 mi", "6.21 mi", "6.21 mi", "12.43 mi", "6.21 mi", "0 ft"), distStrings);
+        assertEquals(Arrays.asList("6.21 mi", "6.21 mi", "6.21 mi", "6.21 mi", "12.43 mi", "6.21 mi", "0 ft"),
+                distStrings);
         List<GPXEntry> gpxes = wayList.createGPXList();
         assertEquals(10, gpxes.size());
         // check order of tower nodes        
@@ -111,20 +118,74 @@ public void testWayList()
         // check order of pillar nodes        
         assertEquals(1.15, gpxes.get(4).getLon(), 1e-6);
         assertEquals(1.16, gpxes.get(5).getLon(), 1e-6);
+        assertEquals(1.16, gpxes.get(5).getLon(), 1e-6);
+
+        compare(Arrays.asList(asL(1.2d, 1.0d), asL(1.2d, 1.1), asL(1.1d, 1.1), asL(1.0, 1.1),
+                asL(1.0, 1.2), asL(1.1, 1.3), asL(1.1, 1.4)),
+                wayList.createStartPoints());
 
         p = new Dijkstra(g, carManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(6, 2);
         assertEquals(42000, p.getDistance(), 1e-2);
+        assertEquals(Helper.createTList(6, 7, 8, 5, 2), p.calcNodes());
         wayList = p.calcInstructions();
+        tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.CANADA)));
         assertEquals(Arrays.asList("Continue onto 6-7", "Continue onto 7-8", "Turn left onto 5-8", "Continue onto 5-2", "Finish!"),
-                wayList.createDescription(trMap.getWithFallBack(Locale.CANADA)));
+                tmpList);
+
+        // assertEquals(Arrays.asList(0, 1, 4, 5, 6), wayList.createPointIndices());
+        // tmpList = createList(p.calcPoints(), wayList.createPointIndices());
+        compare(Arrays.asList(asL(1d, 1d), asL(1d, 1.1), asL(1d, 1.2), asL(1.1, 1.2), asL(1.2, 1.2)),
+                wayList.createStartPoints());
+    }
+
+    List<String> pick( String key, List<Map<String, Object>> instructionJson )
+    {
+        List<String> list = new ArrayList<String>();
+
+        for (Map<String, Object> json : instructionJson)
+        {
+            list.add(json.get(key).toString());
+        }
+        return list;
+    }
+
+    List<List<Double>> createList( PointList pl, List<Integer> integs )
+    {
+        List<List<Double>> list = new ArrayList<List<Double>>();
+        for (int i : integs)
+        {
+            List<Double> entryList = new ArrayList<Double>(2);
+            entryList.add(pl.getLatitude(i));
+            entryList.add(pl.getLongitude(i));
+            list.add(entryList);
+        }
+        return list;
+    }
+
+    void compare( List<List<Double>> expected, List<List<Double>> was )
+    {
+        for (int i = 0; i < expected.size(); i++)
+        {
+            List<Double> e = expected.get(i);
+            List<Double> wasE = was.get(i);
+            for (int j = 0; j < e.size(); j++)
+            {
+                assertEquals("at " + j + " value " + e + " vs " + wasE, e.get(j), wasE.get(j), 1e-5d);
+            }
+        }
+    }
+
+    List<Double> asL( Double... list )
+    {
+        return Arrays.asList(list);
     }
 
-    double sum( List<Double> list )
+    double sumDistances( InstructionList il )
     {
         double val = 0;
-        for (Double d : list)
+        for (Instruction i : il)
         {
-            val += d;
+            val += i.getDistance();
         }
         return val;
     }
@@ -140,10 +201,11 @@ public void testWayList2()
         //      4
         //     /
         //    3
-        g.setNode(2, 10.3, 10.15);
-        g.setNode(3, 10.0, 10.08);
-        g.setNode(4, 10.1, 10.10);
-        g.setNode(5, 10.2, 10.13);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(2, 10.3, 10.15);
+        na.setNode(3, 10.0, 10.08);
+        na.setNode(4, 10.1, 10.10);
+        na.setNode(5, 10.2, 10.13);
         g.edge(3, 4, 100, true).setName("3-4");
         g.edge(4, 5, 100, true).setName("4-5");
 
@@ -155,13 +217,15 @@ public void testWayList2()
 
         Path p = new Dijkstra(g, carManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(2, 3);
         InstructionList wayList = p.calcInstructions();
+        List<String> tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.CANADA)));
         assertEquals(Arrays.asList("Continue onto 2-4", "Turn slight right onto 3-4", "Finish!"),
-                wayList.createDescription(trMap.getWithFallBack(Locale.CANADA)));
+                tmpList);
 
         p = new Dijkstra(g, carManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(3, 5);
         wayList = p.calcInstructions();
+        tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.CANADA)));
         assertEquals(Arrays.asList("Continue onto 3-4", "Continue onto 4-5", "Finish!"),
-                wayList.createDescription(trMap.getWithFallBack(Locale.CANADA)));
+                tmpList);
     }
 
     // problem: we normally don't want instructions if streetname stays but here it is suboptimal:
@@ -176,10 +240,11 @@ public void testNoInstructionIfSameStreet()
         //      4
         //     /
         //    3
-        g.setNode(2, 10.3, 10.15);
-        g.setNode(3, 10.0, 10.05);
-        g.setNode(4, 10.1, 10.10);
-        g.setNode(5, 10.2, 10.15);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(2, 10.3, 10.15);
+        na.setNode(3, 10.0, 10.05);
+        na.setNode(4, 10.1, 10.10);
+        na.setNode(5, 10.2, 10.15);
         g.edge(3, 4, 100, true).setName("street");
         g.edge(4, 5, 100, true).setName("4-5");
 
@@ -191,7 +256,8 @@ public void testNoInstructionIfSameStreet()
 
         Path p = new Dijkstra(g, carManager.getEncoder("CAR"), new ShortestWeighting()).calcPath(2, 3);
         InstructionList wayList = p.calcInstructions();
-        assertEquals(Arrays.asList("Continue onto street", "Finish!"), wayList.createDescription(trMap.getWithFallBack(Locale.CANADA)));
+        List<String> tmpList = pick("text", wayList.createJson(trMap.getWithFallBack(Locale.CANADA)));
+        assertEquals(Arrays.asList("Continue onto street", "Finish!"), tmpList);
     }
 
     @Test
@@ -204,11 +270,12 @@ public void testInstructionsWithTimeAndPlace()
         //   3-2
         //     |
         //     1
-        g.setNode(1, 15.0, 10);
-        g.setNode(2, 15.1, 10);
-        g.setNode(3, 15.1, 9.9);
-        g.setNode(4, 15.2, 9.9);
-        g.setNode(5, 15.2, 10);
+        NodeAccess na = g.getNodeAccess();
+        na.setNode(1, 15.0, 10);
+        na.setNode(2, 15.1, 10);
+        na.setNode(3, 15.1, 9.9);
+        na.setNode(4, 15.2, 9.9);
+        na.setNode(5, 15.2, 10);
 
         g.edge(1, 2, 7000, true).setName("1-2").setFlags(flagsForSpeed(carManager, 70));
         g.edge(2, 3, 8000, true).setName("2-3").setFlags(flagsForSpeed(carManager, 80));
@@ -221,29 +288,38 @@ public void testInstructionsWithTimeAndPlace()
 
         List<GPXEntry> gpxList = wayList.createGPXList();
         assertEquals(34000, p.getDistance(), 1e-1);
-        assertEquals(34000, sum(wayList.createDistances()), 1e-1);
+        assertEquals(34000, sumDistances(wayList), 1e-1);
         assertEquals(5, gpxList.size());
         assertEquals(1604120, p.getMillis());
         assertEquals(1604120, gpxList.get(gpxList.size() - 1).getMillis());
 
-        assertEquals(Instruction.CONTINUE_ON_STREET, wayList.get(0).getIndication());
+        assertEquals(Instruction.CONTINUE_ON_STREET, wayList.get(0).getSign());
         assertEquals(15, wayList.get(0).getFirstLat(), 1e-3);
         assertEquals(10, wayList.get(0).getFirstLon(), 1e-3);
 
-        assertEquals(Instruction.TURN_LEFT, wayList.get(1).getIndication());
+        assertEquals(Instruction.TURN_LEFT, wayList.get(1).getSign());
         assertEquals(15.1, wayList.get(1).getFirstLat(), 1e-3);
         assertEquals(10, wayList.get(1).getFirstLon(), 1e-3);
 
-        assertEquals(Instruction.TURN_RIGHT, wayList.get(2).getIndication());
+        assertEquals(Instruction.TURN_RIGHT, wayList.get(2).getSign());
         assertEquals(15.1, wayList.get(2).getFirstLat(), 1e-3);
         assertEquals(9.9, wayList.get(2).getFirstLon(), 1e-3);
 
-        assertEquals(Instruction.TURN_RIGHT, wayList.get(3).getIndication());
+        assertEquals(Instruction.TURN_RIGHT, wayList.get(3).getSign());
         assertEquals(15.2, wayList.get(3).getFirstLat(), 1e-3);
         assertEquals(9.9, wayList.get(3).getFirstLon(), 1e-3);
 
         String gpxStr = wayList.createGPX("test", 0, "GMT+1");
-        assertTrue(gpxStr, gpxStr.contains("<trkpt lat=\"15.0\" lon=\"10.0\"><time>1970-01-01T01:00:00+01:00</time></trkpt>"));
+
+        assertTrue(gpxStr, gpxStr.contains("<trkpt lat=\"15.0\" lon=\"10.0\"><time>1970-01-01T01:00:00+01:00</time>"));
+        assertTrue(gpxStr, gpxStr.contains("<extensions>") && gpxStr.contains("</extensions>"));
+        assertTrue(gpxStr, gpxStr.contains("<rtept lat=\"15.1\" lon=\"10.0\">"));
+        assertTrue(gpxStr, gpxStr.contains("<distance>8000</distance>"));
+        assertTrue(gpxStr, gpxStr.contains("<desc>left 2-3</desc>"));
+
+        // assertTrue(gpxStr, gpxStr.contains("<direction>W</direction>"));
+        // assertTrue(gpxStr, gpxStr.contains("<turn-angle>-90</turn-angle>"));
+        // assertTrue(gpxStr, gpxStr.contains("<azimuth>270</azimuth/>"));
     }
 
     @Test
@@ -253,16 +329,16 @@ public void testCreateGPX()
         PointList pl = new PointList();
         pl.add(49.942576, 11.580384);
         pl.add(49.941858, 11.582422);
-        instructions.add(new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, pl).setDistance(240).setMillis(15000));
+        instructions.add(new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, pl).setDistance(240).setTime(15000));
 
         pl = new PointList();
         pl.add(49.941575, 11.583501);
-        instructions.add(new Instruction(Instruction.TURN_LEFT, "temp2", 0, 0, pl).setDistance(25).setMillis(4000));
+        instructions.add(new Instruction(Instruction.TURN_LEFT, "temp2", 0, 0, pl).setDistance(25).setTime(4000));
 
         pl = new PointList();
         pl.add(49.941389, 11.584311);
-        instructions.add(new Instruction(Instruction.TURN_LEFT, "temp2", 0, 0, pl).setDistance(25).setMillis(3000));
-        instructions.add(new FinishInstruction(49.941029, 11.584514));
+        instructions.add(new Instruction(Instruction.TURN_LEFT, "temp2", 0, 0, pl).setDistance(25).setTime(3000));
+        instructions.add(new FinishInstruction(49.941029, 11.584514, 0));
 
         List<GPXEntry> result = instructions.createGPXList();
         assertEquals(5, result.size());
@@ -281,4 +357,23 @@ private long flagsForSpeed( EncodingManager encodingManager, int speedKmPerHour
         way.setTag("maxspeed", String.format("%d km/h", speedKmPerHour));
         return encodingManager.handleWayTags(way, 1, 0);
     }
+
+    @Test
+    public void testEmptyList()
+    {
+        EncodingManager carManager = new EncodingManager("CAR");
+        Graph g = new GraphBuilder(carManager).create();
+        Path p = new Dijkstra(g, carManager.getSingle(), new ShortestWeighting()).calcPath(0, 1);
+        InstructionList il = p.calcInstructions();
+        assertEquals(0, il.size());
+        assertEquals(0, il.createStartPoints().size());
+    }
+
+    @Test
+    public void testRound()
+    {
+        assertEquals(100.94, InstructionList.round(100.94, 2), 1e-7);
+        assertEquals(100.9, InstructionList.round(100.94, 1), 1e-7);
+        assertEquals(101.0, InstructionList.round(100.95, 1), 1e-7);
+    }
 }
diff --git a/core/src/test/java/com/graphhopper/util/InstructionTest.java b/core/src/test/java/com/graphhopper/util/InstructionTest.java
new file mode 100644
index 0000000000..f34b17f4bb
--- /dev/null
+++ b/core/src/test/java/com/graphhopper/util/InstructionTest.java
@@ -0,0 +1,77 @@
+/*
+ *  Licensed to GraphHopper and Peter Karich under one or more contributor
+ *  license agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  GraphHopper licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except in
+ *  compliance with the License. You may obtain a copy of the License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.util;
+
+import org.junit.Test;
+import static org.junit.Assert.*;
+
+/**
+ *
+ * @author Johannes Pelzer
+ */
+public class InstructionTest
+{   
+    @Test
+    public void testGetAzimuthAndGetDirection() {
+        PointList pl = new PointList();
+        pl.add(49.942, 11.584);
+        pl.add(49.942, 11.582);
+        Instruction i1 = new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, pl).setDistance(240).setTime(15000);
+        
+        assertEquals("270", i1.getAzimuth(null));
+        assertEquals("W", i1.getDirection(null));
+
+        
+        PointList p2 = new PointList();
+        p2.add(49.942, 11.580);
+        p2.add(49.944, 11.582);
+        Instruction i2 = new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, p2).setDistance(240).setTime(15000);
+        
+        assertEquals("45", i2.getAzimuth(null));
+        assertEquals("NE", i2.getDirection(null));
+        
+        
+        PointList p3 = new PointList();
+        p3.add(49.942, 11.580);
+        p3.add(49.944, 11.580);
+        Instruction i3 = new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, p3).setDistance(240).setTime(15000);
+        
+        
+        assertEquals("0", i3.getAzimuth(null));
+        assertEquals("N", i3.getDirection(null));
+        
+        PointList p4 = new PointList();
+        p4.add(49.940, 11.580);
+        p4.add(49.920, 11.586);
+        Instruction i4 = new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, p4).setDistance(240).setTime(15000);
+        
+        
+        
+        assertEquals("S", i4.getDirection(null));
+ 
+        PointList p5 = new PointList();
+        p5.add(49.940, 11.580);
+        Instruction i5 = new Instruction(Instruction.CONTINUE_ON_STREET, "temp", 0, 0, p5).setDistance(240).setTime(15000);
+        
+        assertEquals(null, i5.getAzimuth(null));
+        assertEquals(null, i5.getDirection(null));
+    }
+    
+    
+    
+}
diff --git a/core/src/test/java/com/graphhopper/util/PointListTest.java b/core/src/test/java/com/graphhopper/util/PointListTest.java
index c0a4ce8902..f3187631cd 100644
--- a/core/src/test/java/com/graphhopper/util/PointListTest.java
+++ b/core/src/test/java/com/graphhopper/util/PointListTest.java
@@ -55,4 +55,36 @@ public void testReverse()
 
         assertEquals(clonedList, instance.clone(true));
     }
+
+    @Test
+    public void testAddPL()
+    {
+        PointList instance = new PointList();
+        for (int i = 0; i < 7; i++)
+        {
+            instance.add(0, 0);
+        }
+        assertEquals(7, instance.getSize());
+        assertEquals(10, instance.getCapacity());
+
+        PointList toAdd = new PointList();
+        instance.add(toAdd);
+        assertEquals(7, instance.getSize());
+        assertEquals(10, instance.getCapacity());
+
+        toAdd.add(1, 1);
+        toAdd.add(2, 2);
+        toAdd.add(3, 3);
+        toAdd.add(4, 4);
+        toAdd.add(5, 5);
+        instance.add(toAdd);
+
+        assertEquals(12, instance.getSize());
+        assertEquals(20, instance.getCapacity());
+
+        for (int i = 0; i < toAdd.size(); i++)
+        {
+            assertEquals(toAdd.getLatitude(i), instance.getLatitude(7 + i), 1e-1);
+        }
+    }
 }
diff --git a/core/src/test/resources/com/graphhopper/reader/custom-osm-ele.xml b/core/src/test/resources/com/graphhopper/reader/custom-osm-ele.xml
new file mode 100644
index 0000000000..09093ea247
--- /dev/null
+++ b/core/src/test/resources/com/graphhopper/reader/custom-osm-ele.xml
@@ -0,0 +1,56 @@
+<?xml version='1.0' encoding='UTF-8'?>
+<osm version="0.6" generator="pbf2osm">
+    <node id="10" lat="51.2492152" lon="9.4317166" uid="24853">
+        <tag k="is_in" v="Wiesbaden,Hessen,Germany,Europe" />
+        <tag k="name" v="Wiesbaden-Naurod" />
+        <tag k="place" v="village" />
+        <tag k="ele" v="3" />
+    </node>
+    <node id="20" lat="52" lon="9" uid="24854">
+        <tag k="name" v="Halbendorf-Spree" />
+        <tag k="ele" v="-10" />
+    </node>
+    <node id="30" lat="51.2" lon="9.4" uid="24855">
+        <tag k="name" v="Dresden" />
+        <tag k="ele" v="10" />
+    </node>
+    
+    <node id="35" lat="45.2" lon="13.431" uid="3212487">
+        <tag k="name" v="Unused1" />
+        <tag k="ele" v="4" />
+    </node>
+
+    <node id="40" lat="51.25" lon="9.43" uid="24856">
+        <tag k="name" v="Cottbus" />
+        <tag k="ele" v="100" />
+    </node>
+    <node id="41" lat="51.23" lon="11.43" uid="3214857">
+        <tag k="name" v="Unused2" />
+        <tag k="ele" v="1000" />
+    </node>
+    <node id="45" lat="41.2" lon="10.431" uid="32124857">
+        <tag k="name" v="Unused3" />
+        <tag k="ele" v="20" />
+    </node>
+    <node id="50" lat="49" lon="10" uid="24857">
+        <tag k="name" v="Tester" />
+        <tag k="ele" v="-30" />
+    </node>
+    
+    <way id="10" uid="85761">
+        <nd ref="10"/>
+        <nd ref="20"/>        
+        <nd ref="30"/>
+        <tag k="name" v="route 666" />
+        <tag k="highway" v="motorway_link" />
+        <tag k="destination" v="hof;frth" />
+    </way> 
+    
+    <way id="11" uid="85762">
+        <nd ref="20"/>
+        <nd ref="40"/>
+        <nd ref="50"/>        
+        <tag k="name" v="street 123;B 122" />
+        <tag k="highway" v="service" />
+    </way>
+</osm>
diff --git a/core/src/test/resources/com/graphhopper/reader/test-osm3.xml b/core/src/test/resources/com/graphhopper/reader/test-osm3.xml
index ca75a0f670..e56f318909 100644
--- a/core/src/test/resources/com/graphhopper/reader/test-osm3.xml
+++ b/core/src/test/resources/com/graphhopper/reader/test-osm3.xml
@@ -29,7 +29,7 @@
         <nd ref="10"/>
         <nd ref="20"/>
         <nd ref="30"/>
-        <tag k="tmpStr" v="A B C" />
+        <tag k="name" v="A B C" />
         <tag k="oneway" v="true" />
         <tag k="highway" v="secondary" />
     </way>    
@@ -38,7 +38,7 @@
         <nd ref="10"/>
         <nd ref="40"/>
         <nd ref="30"/>
-        <tag k="tmpStr" v="A D C" />
+        <tag k="name" v="A D C" />
         <tag k="oneway" v="true" />
         <tag k="highway" v="motorway" />      
     </way>
@@ -47,15 +47,15 @@
         <nd ref="10"/>
         <nd ref="50"/>
         <nd ref="30"/>
-        <tag k="tmpStr" v="A E C" />
-        <tag k="highway" v="footway"/>
+        <tag k="name" v="A E C" />
+        <tag k="highway" v="footway"/>        
     </way>    
     
     <way id="13">
         <nd ref="20"/>
         <nd ref="40"/>
         <nd ref="50"/>
-        <tag k="tmpStr" v="B D E" />
+        <tag k="name" v="B D E" />
         <tag k="highway" v="motorway" />
         <tag k="maxspeed" v="40" />
     </way>
diff --git a/core/src/test/resources/com/graphhopper/reader/test-osm5.xml b/core/src/test/resources/com/graphhopper/reader/test-osm5.xml
new file mode 100644
index 0000000000..f99ddde32d
--- /dev/null
+++ b/core/src/test/resources/com/graphhopper/reader/test-osm5.xml
@@ -0,0 +1,66 @@
+<?xml version='1.0' encoding='UTF-8'?>
+<osm version="0.6" generator="pbf2osm">
+    
+    <!--  __B__ 
+         /  |  \
+        A___D__C
+         \  |  /
+          \_E_F    
+    -->
+          
+    <node id="10" lat="49.501" lon="11.5001" uid="24853">
+        <tag k="name" v="A" />
+    </node>
+    <node id="20" lat="49.502" lon="11.501" uid="24854">
+        <tag k="name" v="B" />
+    </node>
+    <node id="30" lat="49.5011" lon="11.502" uid="24855">
+        <tag k="name" v="C" />
+    </node>
+    <node id="40" lat="49.5009" lon="11.501" uid="24854">
+        <tag k="name" v="D" />
+    </node>
+    <node id="50" lat="49.5001" lon="11.501">
+        <tag k="name" v="E" />
+    </node>
+    <node id="60" lat="49.5002" lon="11.5015">
+        <tag k="name" v="F" />
+    </node>
+        
+    <way id="10" uid="85761">
+        <nd ref="10"/>
+        <nd ref="20"/>
+        <nd ref="30"/>
+        <tag k="tmpStr" v="A B C" />
+        <tag k="oneway" v="true" />
+        <tag k="highway" v="secondary" />
+    </way>    
+    
+    <way id="12" uid="85762">
+        <nd ref="10"/>
+        <nd ref="40"/>
+        <nd ref="30"/>
+        <tag k="tmpStr" v="A D C" />
+        <tag k="oneway" v="true" />
+        <tag k="highway" v="motorway" />      
+    </way>
+    
+    <way id="11" uid="85761">
+        <nd ref="10"/>
+        <nd ref="50"/>
+        <nd ref="60"/>
+        <nd ref="30"/>
+        <tag k="tmpStr" v="A E F C" />
+        <tag k="highway" v="footway"/>
+    </way>    
+    
+    <way id="13">
+        <nd ref="20"/>
+        <nd ref="40"/>
+        <nd ref="50"/>
+        <tag k="tmpStr" v="B D E" />
+        <tag k="highway" v="motorway" />
+        <tag k="maxspeed" v="40" />
+    </way>
+
+</osm>
\ No newline at end of file
diff --git a/docs/android/index.md b/docs/android/index.md
new file mode 100644
index 0000000000..414c258f78
--- /dev/null
+++ b/docs/android/index.md
@@ -0,0 +1,52 @@
+## Get Demo
+
+[Download GraphHopper Demo APK](http://graphhopper.com/#download)
+
+## Set-up Development
+As starting point you can use [the demo project](https://github.com/graphhopper/graphhopper/tree/master/android) which can be used from Eclipse or NetBeans via maven command line.
+
+### Before installation
+
+```bash
+$ git clone git://github.com/graphhopper/graphhopper.git graphhopper
+$ cd graphhopper
+$ ./graphhopper.sh import your-area.pbf
+```
+
+And go to the Android SDK Manager and install at least 2.2 (API 8)
+
+**Either via Maven and Command line -> use this for NetBeans**
+ 1. Download [Maven SDK Deployer](https://github.com/mosabua/maven-android-sdk-deployer) and execute `mvn install -P 2.2` - it uses [Android Maven Plugin](http://code.google.com/p/maven-android-plugin/wiki/GettingStarted) under the hood where you need to set up ANDROID_HOME
+ 2. Install Mapsforge in your local repository via the provided script `scripts/maven-install-mapsforge.sh` - see some [explanations/issues](https://github.com/graphhopper/graphhopper/issues/122)
+ 3. Now do `./graphhopper.sh android`
+
+**Or Eclipse**
+
+Import Sources as Android project. If you want to customize graphhopper itself do:
+ 1. `cd graphhopper; ./graphhopper.sh eclipse`
+ 2. Refresh your Eclipse project and use it.
+
+See [this](https://lists.openstreetmap.org/pipermail/graphhopper/2013-November/000501.html) for the discussion.
+
+**Maps**
+
+Now that you have a running android app you need to copy somehow the routing and maps data. 
+
+ 1. [Download the raw openstreetmap file](http://download.geofabrik.de/openstreetmap/) - you'll need that only for the next step to create the routing data
+ 2. Execute `./graphhopper.sh import <your-osm-file>`. This creates the routing data
+ 3. [Download a map](http://download.mapsforge.org/maps/) e.g. berlin.map
+ 4. Copy berlin.map into the created berlin-gh folder
+ 5. Optional Compression Step: Bundle a graphhopper zip file via cd berlin-gh;zip -r berlin.ghz *
+ 6. Now copy the berlin-gh folder from step 4 (or the .ghz file from step 5) to android /sdcard/graphhopper/maps - e.g. use [SSHDroid](https://play.google.com/store/apps/details?id=berserker.android.apps.sshdroid): scp -P 2222 berlin.ghz  root@$URL:/sdcard/graphhopper/maps/
+
+## Limitations
+
+ * For now OSMReader does not work on Android due to some javax.xml dependencies. But you can simply create the graphhopper folder on your desktop and copy them to the Android storage.
+
+ * [A memory bound a* algoritm](http://en.wikipedia.org/wiki/SMA*) is not yet implemented so you can use disableShortcuts only for small routes. Let me know if you need this!
+
+## Example
+
+Routes for areas of up to 500km^2 are calculated in under 5s with the help of Contraction Hierarchies
+
+![simple routing](http://karussell.files.wordpress.com/2012/09/graphhopper-android.png)
\ No newline at end of file
diff --git a/docs/core/ch.md b/docs/core/ch.md
new file mode 100644
index 0000000000..32cdbda276
--- /dev/null
+++ b/docs/core/ch.md
@@ -0,0 +1,19 @@
+# Contraction Hierarchies
+
+CH is a post-import process which makes routing faster. 
+In GraphHopper CH is enabled by default but can be easily disabled.
+
+To make CH work in GraphHopper a LevelGraphStorage instead of the normal GraphStorage 
+is necessary which allows to store shortcuts too.
+
+After a graph is prepared it cannot be used for graph exploration anymore, this is
+a limitation of the preparation and storage and is handled in issue #116.
+Due to that limitation a special location index is necessary (LocationIndexTreeSC).
+
+Also at the moment only one vehicle can be used if CH is enabled, see issue #111.
+
+So, if you still need graph exploration for your LevelGraphStorage you can specify 
+graphHopper.doPrepare(false) before you call importOrLoad, which avoids the CH preparation.
+Then do your graph explorations or whatever and store the graph.
+If you call importOrLoad next time without doPrepare(false) the CH-preparation will be done.
+
diff --git a/docs/core/location-index.md b/docs/core/location-index.md
new file mode 100644
index 0000000000..9fa25b7c7a
--- /dev/null
+++ b/docs/core/location-index.md
@@ -0,0 +1,30 @@
+You get the location index from the GraphHopper instance, after you imported or loaded the data:
+
+```java
+GraphHopper hopper = new GraphHopper();
+hopper.set...
+hopper.importOrLoad();
+
+LocationIndex index = hopper.getLocationIndex();
+
+//  now you can fetch the closest edge via:
+QueryResult qr = findClosest(lat, lon, EdgeFilter.ALL_EDGES );
+EdgeIteratorState edge = qr.getClosestEdge();
+```
+
+If you don't use the GraphHopper class you have to handle every case on your own to build a location index.
+E.g. if it is a LevelGraph you need LocationIndexTreeSC otherwise LocationIndexTree:
+
+```java
+LocationIndexTree tmpIndex;
+if (graph instanceof LevelGraph)
+   tmpIndex = new LocationIndexTreeSC((LevelGraph) graph, dir);
+else
+   tmpIndex = new LocationIndexTree(graph, dir);
+
+tmpIndex.setResolution(preciseIndexResolution);
+tmpIndex.setSearchRegion(searchRegion);
+// now build the index if it cannot be loaded
+if (!tmpIndex.loadExisting())
+   tmpIndex.prepareIndex();
+```
\ No newline at end of file
diff --git a/docs/core/low-level-api.md b/docs/core/low-level-api.md
new file mode 100644
index 0000000000..f4f37617b2
--- /dev/null
+++ b/docs/core/low-level-api.md
@@ -0,0 +1,83 @@
+## Low level API
+
+If you just start to use GraphHopper please refer to [routing docs](./routing.md)
+or [the quickstart for developers](./quickstart-from-source.md)
+and come back here later if the higher level API does not suit your needs.
+
+### Create and save the graph
+
+```java
+FlagEncoder encoder = new CarFlagEncoder();
+EncodingManager em = new EncodingManager(encoder);
+GraphBuilder gb = new GraphBuilder(em).setLocation("graphhopper-folder").setStore(true);
+GraphStorage graph = gb.create();
+// Make a weighted edge between two nodes.
+EdgeIteratorState edge = graph.edge(fromId, toId);
+edge.setDistance(distance);
+edge.setFlags(encoder.setProperties(speed, true, true));
+// Store to disc
+graph.flush();
+```
+
+### Load the graph
+
+```java
+...
+GraphStorage graph = gb.load();
+// Load index
+LocationIndex index = new LocationIndexTree(graph, new RAMDirectory("graphhopper-folder", true));
+if (!index.loadExisting())
+    throw new IllegalStateException("location index cannot be loaded!");
+```
+
+### Calculate Path with LocationIndex
+
+```java
+QueryResult fromQR = index.findClosest(latitudeFrom, longituteFrom, EdgeFilter.ALL_EDGES);
+QueryResult toQR = index.findID(latitudeTo, longituteTo, EdgeFilter.ALL_EDGES);
+Path path = new Dijkstra(graph, encoder).calcPath(fromQR, toQR);
+```
+
+### Calculate Path without LocationIndex
+
+```java
+// get the fromId and toId nodes from other code parts
+Path path = new Dijkstra(graph, encoder).calcPath(fromId, toId);
+```
+
+### Use LevelGraph to make queries faster
+
+```java
+// Creating and saving the graph
+GraphBuilder gb = new GraphBuilder(em).
+    setLocation("graphhopper-folder").
+    setStore(true).
+    setLevelGraph(true);
+GraphStorage graph = gb.create();
+// Make a weighted edge between two nodes.
+EdgeIteratorState edge = graph.edge(fromId, toId);
+...
+
+// Prepare the graph for fast querying ...
+PrepareContractionHierarchies pch = new PrepareContractionHierarchies();
+pch.setGraph(graph).doWork();
+
+// flush after preparation!
+graph.flush();
+
+// Load and use the graph
+GraphStorage graph = gb.load();
+
+ // Load index
+Location2IDIndex index = new LocationIndexTreeSC(graph, new RAMDirectory("graphhopper-folder", true));
+if (!index.loadExisting())
+    throw new IllegalStateException("location2id index cannot be loaded!");
+
+// create the algorithm using the PrepareContractionHierarchies object
+RoutingAlgorithm algorithm = pch.createAlgo();
+
+// calculate path is identical
+QueryResult fromQR = index.findClosest(latitudeFrom, longituteFrom, EdgeFilter.ALL_EDGES);
+QueryResult toQR = index.findID(latitudeTo, longituteTo, EdgeFilter.ALL_EDGES);
+Path path = new Dijkstra(graph, encoder).calcPath(fromQR, toQR);
+```
\ No newline at end of file
diff --git a/docs/core/quickstart-from-source.md b/docs/core/quickstart-from-source.md
new file mode 100644
index 0000000000..fa3e52aa00
--- /dev/null
+++ b/docs/core/quickstart-from-source.md
@@ -0,0 +1,141 @@
+## Try out
+
+For a start which requires only the JRE have a look [here](../web/quickstart.md). 
+Windows user can find a quick guide [here](https://github.com/graphhopper/graphhopper/wiki/Windows). 
+
+Now, before you proceed install git and jdk6, 7 or 8. Then do:
+
+```bash
+$ git clone git://github.com/graphhopper/graphhopper.git
+$ cd graphhopper; ./graphhopper.sh web europe_germany_berlin.pbf
+now go to http://localhost:8989/
+```
+
+  1. These steps make the Berlin area routable. It'll download and unzip the osm file for you.
+  2. It builds the graphhopper jars. If Maven is not available it will automatically download it.
+  3. Then it creates routable files for graphhopper in the folder europe_germany_berlin-gh. It'll skip this step if files are already present.
+  4. Also check the instructions for [Android](https://github.com/graphhopper/graphhopper/wiki/Android)
+
+For you favourite area do
+
+```bash
+$ ./graphhopper.sh web europe_france.pbf
+$ ./graphhopper.sh web north-america_us_new-york.pbf
+# the format follows the link structure at http://download.geofabrik.de
+```
+
+## Start Development
+
+Open the project with NetBeans or enable Maven in your IDE. 
+[Maven](http://maven.apache.org/download.cgi) is downloaded to ```graphhopper/maven``` if not 
+installed when executing graphhopper.sh.
+
+Have a look into the [Java API documentation](./) 
+for further details.
+
+For more details on Android-usage have a look into this [Android site](https://github.com/graphhopper/graphhopper/wiki/Android)
+
+### Debug
+
+No special setup is required since the core and the web module can be started via a main method now.
+
+### Create your UI
+
+ * For an example of how to use graphhopper in a web application see the [web subfolder](https://github.com/graphhopper/graphhopper/tree/master/web)
+ * For an Android example see [the android folder](https://github.com/graphhopper/graphhopper/tree/master/android)
+ * You can use graphhopper on the Desktop with the help of the yet outdated [mapsforge swing library](http://osm4j.svn.sourceforge.net/viewvc/osm4j/trunk/lib/). The new 'rewrite' branch of mapsforge will help here soon.
+
+### Notes
+
+If you develop for Android have a look into the android subfolder. For smallish graph (e.g. size of Berlin) use
+ a RAMDataAccess driven GraphStorage (loads all into memory). For larger ones use the ContractionHierarchies 
+preparation class and MMapDataAccess to avoid OutOfMemoryErrors. 
+
+If you develop a web application have a look into the web demo ('web' subfolder). The simple API 
+(json,jsonp) in this demo is optimized regarding several aspects:
+ * It tries to return a smallish data set (encoded polyline, gzip filter)
+ * It enables cross-site scripting on the server- and client-site (jQuery, header setting)
+ * To make things simple it uses the GeoCoder called Nominatim to get the name for a latitude+longitude point or vice versa.
+ * Where it utilizes the jquery Deferred object to chain ajax requests and avoids browser UI blocking when resolving locations in parallel.
+
+## Web Service Deployment
+
+For simplicity you could just start jetty from maven and schedule it as background job: 
+`export GH_FOREGROUND=false && export JETTY_PORT=11111 && ./graphhopper.sh web europe_germany_berlin.pbf`. 
+Then the service will be accessible on port 11111.
+
+The Web API documentation is [here](../web)
+
+For production usage you can install the latest jetty (8 or 9) as a service but we prefer to have it bundled as a 
+simple jar. Tomcat should work too. To create a war file do `mvn clean war:war` and copy it from the target/ 
+folder to your jetty installation. Then copy web/config.properties also there and change this properties 
+file to point to the required graphhopper folder. Increase the Xmx/Xms values of your jetty server e.g. 
+for world wide coverage with a hierarchical graph I do the following in bin/jetty.sh
+```bash
+export JAVA=java-home/bin/java
+export JAVA_OPTIONS="-server -Xconcurrentio -Xmx15000m -Xms15000m"
+```
+
+For [World-Wide-Road-Network](https://github.com/graphhopper/graphhopper/wiki/World-Wide-Road-Network) we have a separate wiki page.
+
+Important notes:
+ * none-hierarchical graphs should be limited to a certain distance otherwise you'll require lots of RAM per request! See https://github.com/graphhopper/graphhopper/issues/104
+ * if you have strange speed problems which could be related to low memory you can try to [entire disable swap](http://askubuntu.com/questions/103915/how-do-i-configure-swappiness). Or just try it out via `sudo swapoff -a`. Swapping out is very harmful to Java programs especially when the GC kicks in.
+
+## Technical Overview
+
+To get a better understanding also take a look in the source code, especially in the unit tests and in 
+some resources we [published](http://karussell.wordpress.com/2014/01/23/graphhopper-news-article-in-java-magazine-and-fosdem-2014/). 
+
+There are mainly three parts:
+
+### 1. Data Import
+
+The default import is done via OSMReader which imports OpenStreetMap data. You can configure it via API 
+or use the graphhopper.sh script which utilizes the config.properties where you can specify if it should 
+read CAR, FOOT etc or all at once. You'll have to make sure that you allocate enough memory for your 
+specific graph (E.g. ~1GB for Germany) e.g. `export JAVA_OPTS="-Xmx1g"`. The import process is fast e.g. 
+complete germany takes about 10 minutes on my oldish laptop. Additionally it will take time if you choose 
+osmreader.chShortcuts=fastest in the config.properties which will dramatically improve query time.
+
+### 2. The Graph
+
+To process algorithms you need a _Graph_. At the moment there is one main implementation GraphHopperStorage 
+which can be used: 
+  * in-memory with a safe/flush option (RAMDataAccess) and 
+  * a memory mapped (MMapDataAccess).
+
+The interface _Graph_ is developed in the sense that the implementation can be as much efficient as possible
+ - i.e. node ids and edge ids are successive (and so are just _indices_) and in the range of 0 to MAX-1. 
+This design could be used to have an array-like structure in the underlying DataAccess implementation like 
+it is currently the case.
+
+The data layout for the DataAccess objects in GraphHopperStorage called 'nodes' and 'edges' is the following:
+
+![storage layout](http://karussell.files.wordpress.com/2013/08/wiki-graph.png)
+
+Some explanations:
+ * One 'node row' consists of latitude,longitude (not shown) and an edgeID
+ * One 'edge row' consists of two edgeIDs: nextA and nextB, then two nodeIDs nodeA and nodeB, and finally some properties like the distance and the flags.
+ * One node has several edges which is implemented as a linked list. E.g. node 3 points to its first edge in the edge area at position 0 to edge 0-3 (nodeA-nodeB where nodeA is always smaller than nodeB). To get the next edge of node 3 you need nextB and this goes to edge 1-3, again node 3 is nodeB, but for the next edge 3-5 node 3 is nodeA ... and so on.
+ * For you custom data import keep in mind that although the nodes 4 and 6 have no edges they still 'exist' and consume space in the current implementations of DataAccess. For OSMReader this cannot be the case as separate networks with only a small number of nodes are removed (very likely OSM bugs).
+
+For some algorithms there are special implementations of the Graph. E.g. there is a LevelGraphStorage which is a Graph with the possibility to store shortcut edges and a level for every node. This special storage is necessary for _Contraction Hierarchies_. For this the graph needs also some preprocessing (which can take several hours for bigger areas like Europe) which is done in the OSMReader when configured (osmreader.chShortcuts=fastest) or via API in PrepareContractionHierarchies. In order to use the shortcuts and get the benefits of the optimized graph you must use the algorithm returned from createAlgo() in the preparation class.
+
+A LevelGraphStorage (and all subclasses of GraphStorage) cannot read files created with GraphStorage and vice versa. Also there is a file version which is changed if the data structure of GraphHopper gets incompatible to the previous versions.
+
+### 3. The Algorithms
+
+In the routing package you'll find some shortest path algorithms like Dijkstra or A* etc. For those 
+algorithms you need a _Graph_.
+
+An algorithm needs a kind of path extraction: from the shortest-path-tree one needs to determine the route 
+(list of edges) including the distance and time. Afterwards from this list the exact point (latitude,longitude) 
+can be determined. For bidirectional algorithms this is a bit more complicated and done in PathBidirRef. 
+For [_Contraction Hierarchies_](http://ad-wiki.informatik.uni-freiburg.de/teaching/EfficientRoutePlanningSS2012)
+ one needs to additionally find the shortcutted edges and process them recursivly - this is done in Path4CH.
+
+Further Links
+---------------
+ * [Spatial Key](http://karussell.wordpress.com/2012/05/23/spatial-keys-memory-efficient-geohashes/)
+ * [Author@Twitter](https://twitter.com/timetabling)
\ No newline at end of file
diff --git a/docs/core/routing.md b/docs/core/routing.md
new file mode 100644
index 0000000000..0e17633cc4
--- /dev/null
+++ b/docs/core/routing.md
@@ -0,0 +1,70 @@
+To do routing in your Java code you'll need just a few lines of code:
+
+```java
+GraphHopper hopper = new GraphHopper().forServer();
+hopper.setInMemory(true);
+hopper.setOSMFile(osmFile);
+// where to store graphhopper files?
+hopper.setGraphHopperLocation(graphFolder);
+hopper.setEncodingManager(new EncodingManager("car"));
+
+// now this can take minutes if it imports or a few seconds for loading
+// of course this is dependent on the area you import
+hopper.importOrLoad();
+
+GHRequest req = new GHRequest(latFrom, lonFrom, latTo, lonTo).setVehicle("car");
+GHResponse rsp = hopper.route(req);
+
+// first check for errors
+if(rsp.hasErrors()) {
+   // handle them!
+   // rsp.getErrors()
+   return;
+}
+
+// route was found? e.g. if disconnected areas (like island) 
+// no route can ever be found
+if(!rsp.isFound()) {
+   // handle properly
+   return;
+}
+
+// points, distance in meters and time in millis of the full path
+PointList pointList = rsp.getPoints();
+double distance = rsp.getDistance();
+long millis = rsp.getMillis();
+
+// get the turn instructions for the path
+InstructionList il = rsp.getInstructions();
+Translation tr = trMap.getWithFallBack(Locale.US);
+List<String> iList = il.createDescription(tr);
+
+// or get the result as gpx entries:
+List<GPXEntry> list = il.createGPXList();
+```
+
+If you want a more flexible routing (but slower) you can disable contraction hierarchies
+and import multiple vehicles. Then pick one vehicle and optionally the algorithm like
+astar as algorithm:
+
+```java
+GraphHopper hopper = new GraphHopper().forServer();
+hopper.disableCHShortcuts();
+hopper.setInMemory(true);
+hopper.setOSMFile(osmFile);
+hopper.setGraphHopperLocation(graphFolder);
+hopper.setEncodingManager(new EncodingManager("car,bike"));
+
+hopper.importOrLoad();
+
+GHRequest req = new GHRequest(latFrom, lonFrom, latTo, lonTo).setVehicle("bike").setAlgorithm("astar");
+GHResponse res = hopper.route(req);
+```
+
+In case you need the online routing API in a Java or Android application the GraphHopperWeb comes handy - see the 'web' sub module.
+
+```java
+GraphHopperAPI gh = new GraphHopperWeb();
+gh.load("http://your-graphhopper-service.com");
+GHResponse rsp = gh.route(new GHRequest(...));
+```
\ No newline at end of file
diff --git a/docs/core/weighting.md b/docs/core/weighting.md
new file mode 100644
index 0000000000..d628f42b7a
--- /dev/null
+++ b/docs/core/weighting.md
@@ -0,0 +1,72 @@
+## Weighting
+
+In order to create a custom Weighting you need to do the following:
+
+ 1. implement the Weighting class
+ 2. create a subclass of GraphHopper and overwrite createWeighting where you return a new instance of your custom weighting if e.g. the string 'customweighting' is specified. Otherwise let the super class handle it.
+
+Here is an example of a custom weighting which avoids certain edges (i.e. returns infinity weight):
+
+```java
+
+class BlockingWeighting implements Weighting 
+{
+    private final FlagEncoder encoder;
+    private final double maxSpeed;
+    private Set<Integer> forbiddenEdges;
+
+    public FastestWeighting( FlagEncoder encoder, Set<Integer> forbiddenEdges)
+    {
+        this.encoder = encoder;
+        this.maxSpeed = encoder.getMaxSpeed();
+        this.forbiddenEdges = forbiddenEdges;
+    }
+
+    @Override
+    public double getMinWeight( double distance )
+    {
+        return distance / maxSpeed;
+    }
+
+    @Override
+    public double calcWeight( EdgeIteratorState edge, boolean reverse )
+    {
+        if(forbiddenEdges.contains(edge.getEdge()))
+            return Double.POSITIVE_INFINITY;
+
+        double speed = reverse ? encoder.getReverseSpeed(edge.getFlags()) : encoder.getSpeed(edge.getFlags());
+        if (speed == 0)
+            return Double.POSITIVE_INFINITY;
+        return edge.getDistance() / speed;
+    }
+
+    @Override
+    public String toString()
+    {
+        return "BLOCKING";
+    }
+}
+```
+
+Now you need to create your custom GraphHopper:
+
+```java
+class MyGraphHopper extends GraphHopper {
+
+    Set<Integer> forbiddenEdges;
+    public void determineForbiddenEdges() {
+       forbiddenEdges = ...
+    }
+
+    @Override
+    public Weighting createWeighting(String weighting, FlagEncoder encoder) {        
+        if ("BLOCKING".equalsIgnoreCase(weighting))
+            return new BlockingWeighting(encoder, forbiddenEdges);
+        else
+            return super.createWeighting(weighting, encoder);
+    }
+}
+```
+
+For forbiddenEdges you need to determine the edges from some GPS coordinates. 
+Have a look into the [location index docs](./location-index.md).
\ No newline at end of file
diff --git a/docs/core/windows-setup.md b/docs/core/windows-setup.md
new file mode 100644
index 0000000000..0686ac25a8
--- /dev/null
+++ b/docs/core/windows-setup.md
@@ -0,0 +1,27 @@
+# Windows Setup from Source
+
+Download [cygwin](http://www.cygwin.com/) to execute bash scripts. Click on the setup and select wget, git and unzip
+
+```bash
+# go to your development area
+$ cd /cygdrive/c/Dokumente und Einstellungen/peter/dev
+
+# get the sources
+$ git clone https://github.com/graphhopper/graphhopper.git
+
+# go into graphhopper root
+$ cd graphhopper
+
+# and execute
+$ ./graphhopper.sh web europe_germany_berlin.osm
+```
+
+Now graphhopper web should start. After this open [http://localhost:8989/](http://localhost:8989/) in your browser.
+
+### Troubleshooting
+ * Make sure you have the JDK installed (6,7 or 8) and not only the JRE
+ * For me JAVA_HOME was not correct so I had to overwrite it:
+   ```bash
+   $ export JAVA_HOME=/cygdrive/c/Programme/Java/jdk1.7.0_17
+   $ ./graphhopper.sh web europe_germany_berlin.osm
+   ```
\ No newline at end of file
diff --git a/docs/core/world-wide.md b/docs/core/world-wide.md
new file mode 100644
index 0000000000..bba235e159
--- /dev/null
+++ b/docs/core/world-wide.md
@@ -0,0 +1,31 @@
+GraphHopper is able to handle coverage for the whole [Openstreetmap road network](http://planet.osm.org/). 
+It needs approximately 22GB RAM for the import (CAR only) and ~1 hour (plus ~5h for contraction). 
+If you can accept slower import times this can be reduced to 14GB RAM - you'll need to set osmreader.dataaccess=MMAP
+
+Then, to run the web service with this world wide graph 'only' 15GB are necessary. Without contraction hierarchy 
+this would be about 9GB.
+
+With CH the service is able to handle about 180 queries per second (from localhost to localhost this was 300qps). 
+Measured for CAR routing, real world requests, at least 100km long, on a linux machine with 8 cores and 32GB, 
+java 1.7.0_25, jetty 8.1.10 via custom QueryTorture class (10 worker threads).
+
+## JVM
+
+If GC pauses are too long try `-XX:+UseG1GC`
+
+## Elevation Data 
+
+If you want to use elevation data you need to increase the allowed number of open files. Under linux this works as follows:
+
+ * sudo vi /etc/security/limits.conf
+ * add: `* - nofile 100000`
+   which means set hard and soft limit of "number of open files" for all users to 100K
+ * sudo vi /etc/sysctl.conf
+ * add: `fs.file-max = 90000`
+ * reboot now (or sudo sysctl -p; and re-login)
+ * afterwards `ulimit -Hn` and `ulimit -Sn` should give you 100000
+
+
+## TODOs
+
+ * Try out to disable NUMA -> http://engineering.linkedin.com/performance/optimizing-linux-memory-management-low-latency-high-throughput-databases
\ No newline at end of file
diff --git a/docs/index.md b/docs/index.md
new file mode 100644
index 0000000000..873261e962
--- /dev/null
+++ b/docs/index.md
@@ -0,0 +1,16 @@
+Users
+---------------
+ * [Read Overview](http://graphhopper.com/#overview)
+ * [Add GraphHopper Maps to your Browser](./web/open-search.md)
+ * [GraphHopper on Twitter](https://twitter.com/graphhopp)
+ * [Quickstart](./web/quickstart.md) for users
+
+Developers
+--------------- 
+ * [Quickstart](./core/quickstart-from-source.md) for developers with git checkout and IDE setup etc
+   * [Android](./android/index.md)
+   * [Windows](./core/windows-setup.md)
+ * [Slides from FOSDEM 2014](http://graphhopper.com/public/slides/)
+ * [World-Wide-Road-Network](./core/world-wide.md)
+ * [Changelog](https://github.com/graphhopper/graphhopper/blob/master/core/files/changelog.txt)
+
diff --git a/docs/web/api-doc.md b/docs/web/api-doc.md
new file mode 100644
index 0000000000..a7d6873834
--- /dev/null
+++ b/docs/web/api-doc.md
@@ -0,0 +1,174 @@
+## Routing Web API Docs
+
+In order to communicate with your or [our](http://graphhopper.com/#enterprise) hosted GraphHopper 
+server you need to understand how to use it.
+
+### A simple example
+[http://localhost:8989/route?point=45.752193%2C-0.686646&point=46.229253%2C-0.32959](http://localhost:8989/route?point=45.752193%2C-0.686646&point=46.229253%2C-0.32959)
+
+The end point of the local instance is [http://localhost:8989](http://localhost:8989)
+
+The URL path to obtain the route is `/route`
+
+All official parameters are shown in the following table
+
+Parameter   | Default | Description
+:-----------|:--------|:-----------
+point       | -       | Specifiy multiple points for which the route should be calculated. The order is important. Specify at least two points.
+locale      | en      | The locale of the result. E.g. pt_PT for Portuguese or de for German
+instructions| true  | If instruction should be calculated and returned
+vehicle     | car     | The vehicle for which the route should be calculated. Other vehicles are foot and bike
+weighting   | fastest | Which kind of 'best' route calculation you need. Other option is 'shortest', currently not available in the public service.
+algorithm   | dijkstrabi | The algorithm to calculate the route. Other options are dijkstra, astar and astarbi. For the public service only dijkstrabi is supported.
+points_encoded     | true | If the resulting route should be 'compressed' using a special algorithm leading to massive bandwith reduction. You'll need a special handling on the client, if enabled. We provide Open Source code in Java and JavaScript.
+debug              | false   | If true, the output will be formated.
+calc_points        | true    | If the points for the route should be calculated at all. Sometimes only the distance and time is necessary.
+type               | json    | Specifies the resulting format of the route, for json the content type will be application/json. Other possible format options: <br> jsonp you'll need to provide the callback function via the callback parameter. The content type will be application/javascript<br> gpx, the content type will be application/xml
+min_path_precision | 1  | Not recommended to change. Increase this number if you want to further reduce bandwith.
+
+## Example output for the case type=json
+
+Keep in mind that some attributes which are not documented here can be removed in the future - 
+so you should not rely on them!
+
+```json
+{
+  "info": {"took": 0.00414920412003994},
+  "paths": [{
+    "bbox": [
+      13.362853824187303,
+      52.469481955531585,
+      13.385836736460217,
+      52.473849308838446
+    ],
+    "distance": 2138.3027624572337,
+    "instructions": [
+      {
+        "distance": 1268.519329705091,
+        "interval": [
+          0,
+          10
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf A 100",
+        "time": 65237
+      },
+      {
+        "distance": 379.74399999999997,
+        "interval": [
+          10,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Strasse",
+        "time": 24855
+      },
+      {
+        "distance": 16.451,
+        "interval": [
+          11,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Tempelhofer Damm",
+        "time": 1316
+      },
+      {
+        "distance": 473.58843275214315,
+        "interval": [
+          11,
+          12
+        ],
+        "sign": -2,
+        "text": "Links abbiegen auf Tempelhofer Damm, B 96",
+        "time": 37882
+      },
+      {
+        "distance": 0,
+        "interval": [
+          12,
+          12
+        ],
+        "sign": 4,
+        "text": "Ziel erreicht!",
+        "time": 0
+      }
+    ],
+    "points": "oxg_Iy|ppAl@wCdE}LfFsN|@_Ej@eEtAaMh@sGVuDNcDb@{PFyGdAi]FoC?q@sXQ_@?",
+    "points_encoded": true,
+    "time": 129290
+  }]
+}
+```
+
+The JSON result contains the following structure:
+
+JSON path/attribute        | Description
+:--------------------------|:------------
+info.took                  | How many ms the request took on the server, of course without network latency taken into account.
+paths                      | An array of possible paths
+paths[0].distance          | The overall distance of the route, in meter
+paths[0].time              | The overall time of the route, in ms
+paths[0].points            | The polyline encoded coordinates of the path. Order is lat,lon,elelevation as it is no geoJson!
+paths[0].points_encoded    | Is true if the points are encoded, if not paths[0].points contains the geo json of the path (then order is lon,lat,elevation), which is easier to handle but consumes more bandwidth compared to encoded version
+paths[0].points_dimension  | The dimension of the points field. Can be 2 or 3.
+paths[0].bbox              | The bounding box of the route, format: <br> minLon, minLat, maxLon, maxLat
+paths[0].instructions      | Contains information about the instructions for this route. The last instruction is always the Finish instruction and takes 0ms and 0meter. Keep in mind that instructions are currently under active development and can sometimes contain misleading information, so, make sure you always show an image of the map at the same time when navigating your users!
+paths[0].instructions[0].text     | A description what the user has to do in order to follow the route. The language depends on the locale parameter.
+paths[0].instructions[0].distance | The distance for this instruction, in meter
+paths[0].instructions[0].time     | The duration for this instruction, in ms
+paths[0].instructions[0].interval | An array containing the first and the last index (relative to paths[0].points) of the points for this instruction
+paths[0].instructions[0].sign     | A number which specifies the sign to show e.g. for right turn etc <br>TURN_SHARP_LEFT = -3<br>TURN_LEFT = -2<br>TURN_SLIGHT_LEFT = -1<br>CONTINUE_ON_STREET = 0<br>TURN_SLIGHT_RIGHT = 1<br>TURN_RIGHT = 2<br>TURN_SHARP_RIGHT = 3<br>FINISH = 4<br>VIA_REACHED = 5
+
+
+## Area information
+
+If you need to find out defails about the area or need to ping the service use '/info'
+
+[http://localhost:8989/info](http://localhost:8989/info)
+
+### Example output:
+```json
+{ "build_date":"2014-02-21T16:52",
+  "bbox":[13.0726237909337,52.33350773901,13.7639719344073,52.679616459003],
+  "version":"0.3",
+  "supported_vehicles": ["foot"]
+}
+```
+
+JSON path/attribute | Description
+:-------------------|:------------
+build_date          | The GraphHopper build date
+version             | The GraphHopper version
+supported_vehicles  | An array of strings indicating the supported vehicles
+bbox                | The maximum bounding box of the area, format: <br> minLon, minLat, maxLon, maxLat
+import_date         | [optional] The date time at which the OSM import was done
+prepare_date        | [optional] The date time at which the preparation (contraction hierarchies) was done. If nothing was done this is empty
+
+### Output if expected error(s) while routing:
+```json
+{
+  "info": {"errors": [{
+    "details": "java.lang.IllegalArgumentException",
+    "message": "Cannot find point 2: 2248.224673, 3.867187"
+  }]}
+}
+```
+
+Sometimes a point can be too offroad and you'll get 'cannot find point', this normally does not
+indicate a bug in the routing engine and is expected to a certain degree.
+
+JSON path/attribute    | Description
+:----------------------|:------------
+info.errors            | A list of error messages
+info.errors[0].details | E.g. to see the underlying exception, if any
+info.errors[0].message | Not intended to be displayed to the user as it is currently not translated
+
+
+### HTTP Error codes
+
+HTTP error code | Reason
+:---------------|:------------
+500             | Internal server error. It is strongely recommended to send us the message and the link to it, as it is very likely a bug in our system.
+501             | Only a special list of vehicles is supported
+400             | Something was wrong in your request
diff --git a/docs/web/open-search.md b/docs/web/open-search.md
new file mode 100644
index 0000000000..ce5f526239
--- /dev/null
+++ b/docs/web/open-search.md
@@ -0,0 +1,16 @@
+Add GraphHopper Maps to your Browser
+----
+
+## Firefox
+
+1. go to http://graphhopper.com/maps
+2. Then right click into the search bar and select 'add GraphHopper Maps' (here 'GraphHopper Maps' hinzufgen)
+3. Finally select 'GraphHopper Maps' and type your locations. Put 'p:' before your every location.
+
+![firefox](http://karussell.files.wordpress.com/2013/08/firefox.png)
+
+## Chrome
+
+1. Open your settings in chrome and go to 'search' to add a new search engine. Use the URL `http://graphhopper.com/maps/?q=%s`
+2. Finally search via GraphHopper Maps: type 'gh ' and then put 'p:' before your locations.
+![chrome](http://karussell.files.wordpress.com/2013/08/chrome.png)
\ No newline at end of file
diff --git a/docs/web/quickstart.md b/docs/web/quickstart.md
new file mode 100644
index 0000000000..957f81daa6
--- /dev/null
+++ b/docs/web/quickstart.md
@@ -0,0 +1,18 @@
+## Quickstart
+
+If you want to build GraphHopper from source look at the [Developers page](../core/quickstart-from-source.md). 
+The following steps are simpler and only need the JRE, a jar file and an OSM file.
+
+ 1. Install the latest JRE and get [graphhopper](https://oss.sonatype.org/content/repositories/snapshots/com/graphhopper/graphhopper-web/0.3-SNAPSHOT/) (a zip file, ~7MB)
+ 2. Unzip it and copy an OSM file into the created directory. For example [berlin-latest.osm.pbf](http://download.geofabrik.de/europe/germany/berlin.html)
+ 3. Start GraphHopper Maps via: java -jar *.jar jetty.resourcebase=webapp config=config-example.properties osmreader.osm=berlin-latest.osm.pbf
+ 4. Go to [http://localhost:8989/](http://localhost:8989/) and you should see a map of Berlin. You should be able to click on the map and a route appears.
+
+
+## Troubleshooting
+
+ * Make sure JRE7 or 8 is installed. If not get Java [here](http://java.com).
+ * Regarding step 2:
+    * The folder where you execute the java command should contain the following files: berlin-latest.osm.pbf, config-example.properties and `graphhopper-web-[version].jar`
+    * The first time you execute this it'll take ~30 seconds (for Berlin), further starts will only load the graph and should be nearly instantaneous. You should see log statements but no exceptions and the last entry should be something like: Started server at HTTP 8989
+ * Join the [mailing list](http://graphhopper.com/#developers) and do not hesitate to ask questions!
\ No newline at end of file
diff --git a/graphhopper.sh b/graphhopper.sh
index a27a183083..a5b0e24425 100755
--- a/graphhopper.sh
+++ b/graphhopper.sh
@@ -1,14 +1,14 @@
 #!/bin/bash
 
 GH_CLASS=com.graphhopper.GraphHopper
-GH_HOME=$(dirname $0)
+GH_HOME=$(dirname "$0")
 JAVA=$JAVA_HOME/bin/java
 if [ "x$JAVA_HOME" = "x" ]; then
  JAVA=java
 fi
 
-vers=`$JAVA -version 2>&1 | grep "java version" | awk '{print $3}' | tr -d \"`
-bit64=`$JAVA -version 2>&1 | grep "64-Bit"`
+vers=$($JAVA -version 2>&1 | grep "java version" | awk '{print $3}' | tr -d \")
+bit64=$($JAVA -version 2>&1 | grep "64-Bit")
 if [ "x$bit64" != "x" ]; then
   vers="$vers (64bit)"
 fi
@@ -39,15 +39,15 @@ function ensureOsmXml {
     echo "## now downloading OSM file from $LINK and extracting to $OSM_FILE"
     
     if [ ${OSM_FILE: -4} == ".pbf" ]; then
-       wget -S -nv -O $OSM_FILE $LINK
+       wget -S -nv -O "$OSM_FILE" "$LINK"
     elif [ ${OSM_FILE: -4} == ".ghz" ]; then
-       wget -S -nv -O $OSM_FILE $LINK
-       unzip $FILE -d $NAME-gh             
+       wget -S -nv -O "$OSM_FILE" "$LINK"
+       unzip "$FILE" -d "$NAME-gh"
     else    
        # make sure aborting download does not result in loading corrupt osm file
        TMP_OSM=temp.osm
-       wget -S -nv -O - $LINK | bzip2 -d > $TMP_OSM
-       mv $TMP_OSM $OSM_FILE
+       wget -S -nv -O - "$LINK" | bzip2 -d > $TMP_OSM
+       mv $TMP_OSM "$OSM_FILE"
     fi
   
     if [[ ! -s "$OSM_FILE" ]]; then
@@ -63,15 +63,15 @@ function ensureMaven {
   # maven home existent?
   if [ "x$MAVEN_HOME" = "x" ]; then
     # not existent but probably is maven in the path?
-    MAVEN_HOME=`mvn -v | grep "Maven home" | cut -d' ' -f3`
+    MAVEN_HOME=$(mvn -v | grep "Maven home" | cut -d' ' -f3)
     if [ "x$MAVEN_HOME" = "x" ]; then
       # try to detect previous downloaded version
       MAVEN_HOME="$GH_HOME/maven"
       if [ ! -f "$MAVEN_HOME/bin/mvn" ]; then
         echo "No Maven found in the PATH. Now downloading+installing it to $MAVEN_HOME"
         cd "$GH_HOME"
-        MVN_PACKAGE=apache-maven-3.0.5
-        wget -O maven.zip http://www.eu.apache.org/dist/maven/maven-3/3.0.5/binaries/$MVN_PACKAGE-bin.zip
+        MVN_PACKAGE=apache-maven-3.2.1
+        wget -O maven.zip http://www.eu.apache.org/dist/maven/maven-3/3.2.1/binaries/$MVN_PACKAGE-bin.zip
         unzip maven.zip
         mv $MVN_PACKAGE maven
         rm maven.zip
@@ -117,7 +117,7 @@ function prepareEclipse {
 
 ## now handle actions which do not take an OSM file
 if [ "x$ACTION" = "xclean" ]; then
- rm -rf */target
+ rm -rf ./*/target
  exit
 
 elif [ "x$ACTION" = "xeclipse" ]; then
@@ -132,7 +132,7 @@ elif [ "x$ACTION" = "xextract" ]; then
  echo use "./graphhopper.sh extract \"left,bottom,right,top\""
  URL="http://overpass-api.de/api/map?bbox=$2"
  #echo "$URL"
- wget -O extract.osm $URL
+ wget -O extract.osm "$URL"
  exit
  
 elif [ "x$ACTION" = "xandroid" ]; then
@@ -152,18 +152,18 @@ NAME="${FILE%.*}"
 if [ "x$FILE" == "x-" ]; then
    OSM_FILE=
 elif [ ${FILE: -4} == ".osm" ]; then
-   OSM_FILE=$FILE
+   OSM_FILE="$FILE"
 elif [ ${FILE: -4} == ".pbf" ]; then
-   OSM_FILE=$FILE
+   OSM_FILE="$FILE"
 elif [ ${FILE: -7} == ".osm.gz" ]; then
-   OSM_FILE=$FILE   
+   OSM_FILE="$FILE"
 elif [ ${FILE: -3} == "-gh" ]; then
-   OSM_FILE=$FILE
+   OSM_FILE="$FILE"
    NAME=${FILE%%???}
 elif [ ${FILE: -4} == ".ghz" ]; then
-   OSM_FILE=$FILE
+   OSM_FILE="$FILE"
    if [[ ! -d "$NAME-gh" ]]; then
-      unzip $FILE -d $NAME-gh
+      unzip "$FILE" -d "$NAME-gh"
    fi
 else
    # no known end -> no import
@@ -171,10 +171,10 @@ else
 fi
 
 GRAPH=$NAME-gh
-VERSION=`grep  "<name>" -A 1 pom.xml | grep version | cut -d'>' -f2 | cut -d'<' -f1`
+VERSION=$(grep  "<name>" -A 1 pom.xml | grep version | cut -d'>' -f2 | cut -d'<' -f1)
 JAR=core/target/graphhopper-$VERSION-jar-with-dependencies.jar
 
-LINK=`echo $NAME | tr '_' '/'`
+LINK=$(echo $NAME | tr '_' '/')
 if [ "x$FILE" == "x-" ]; then
    LINK=
 elif [ ${FILE: -4} == ".osm" ]; then 
@@ -204,11 +204,31 @@ if [ "x$ACTION" = "xui" ] || [ "x$ACTION" = "xweb" ]; then
   if [ "x$JETTY_PORT" = "x" ]; then  
     JETTY_PORT=8989
   fi
-  "$MAVEN_HOME/bin/mvn" -f "$GH_HOME/web/pom.xml" -Djetty.port=$JETTY_PORT -Djetty.reload=manual \
-      -Dgraphhopper.config=$CONFIG \
-      $GH_WEB_OPTS -Dgraphhopper.graph.location="$GRAPH" -Dgraphhopper.osmreader.osm="$OSM_FILE" \
-      jetty:run
+  WEB_JAR="$GH_HOME/web/target/graphhopper-web-$VERSION-with-dep.jar"
+  if [ ! -s "$WEB_JAR" ]; then         
+    "$MAVEN_HOME/bin/mvn" --projects web -DskipTests=true install assembly:single > /tmp/graphhopper-web-compile.log
+    returncode=$?
+    if [[ $returncode != 0 ]] ; then
+      echo "## compilation of web failed"
+      cat /tmp/graphhopper-web-compile.log
+      exit $returncode
+    fi
+  fi
 
+  RC_BASE=./web/src/main/webapp
+
+  if [ "x$GH_FOREGROUND" = "x" ]; then
+    exec "$JAVA" $JAVA_OPTS -jar "$WEB_JAR" jetty.resourcebase=$RC_BASE jetty.port=$JETTY_PORT config=$CONFIG \
+         $GH_WEB_OPTS graph.location="$GRAPH" osmreader.osm="$OSM_FILE"
+    # foreground => we never reach this here
+  else
+    exec "$JAVA" $JAVA_OPTS -jar "$WEB_JAR" jetty.resourcebase=$RC_BASE jetty.port=$JETTY_PORT config=$CONFIG \
+         $GH_WEB_OPTS graph.location="$GRAPH" osmreader.osm="$OSM_FILE" <&- &
+    if [ "x$GH_PID_FILE" != "x" ]; then
+       echo $! > $GH_PID_FILE
+    fi
+    exit $?                    
+  fi
 
 elif [ "x$ACTION" = "ximport" ]; then
  "$JAVA" $JAVA_OPTS -cp "$JAR" $GH_CLASS printVersion=true \
@@ -244,9 +264,9 @@ elif [ "x$ACTION" = "xmeasurement" ]; then
 
  function startMeasurement {
     COUNT=5000
-    commit_info=`git log -n 1 --pretty=oneline`     
+    commit_info=$(git log -n 1 --pretty=oneline)
     echo -e "\nperform measurement via jar=> $JAR and ARGS=> $ARGS"
-    "$JAVA" $JAVA_OPTS -cp "$JAR" com.graphhopper.util.Measurement $ARGS measurement.count=$COUNT measurement.location=$M_FILE_NAME \
+    "$JAVA" $JAVA_OPTS -cp "$JAR" com.graphhopper.util.Measurement $ARGS measurement.count=$COUNT measurement.location="$M_FILE_NAME" \
             graph.importTime=$IMPORT_TIME measurement.gitinfo="$commit_info"
  }
  
@@ -261,17 +281,17 @@ elif [ "x$ACTION" = "xmeasurement" ]; then
    exit
  fi
 
- current_commit=`git log -n 1 --pretty=oneline | cut -d' ' -f1` 
+ current_commit=$(git log -n 1 --pretty=oneline | cut -d' ' -f1)
  commits=$(git rev-list HEAD -n $last_commits)
  for commit in $commits; do
    git checkout $commit -q
-   M_FILE_NAME=`git log -n 1 --pretty=oneline | grep -o "\ .*" |  tr " ,;" "_"`
+   M_FILE_NAME=$(git log -n 1 --pretty=oneline | grep -o "\ .*" |  tr " ,;" "_")
    M_FILE_NAME="measurement$M_FILE_NAME.properties"
    echo -e "\nusing commit $commit and $M_FILE_NAME"
    
    "$MAVEN_HOME/bin/mvn" -f "$GH_HOME/core/pom.xml" -DskipTests clean install assembly:single
    startMeasurement
-   echo -e "\nmeasurement.commit=$commit\n" >> $M_FILE_NAME
+   echo -e "\nmeasurement.commit=$commit\n" >> "$M_FILE_NAME"
  done
  # revert checkout
  git checkout $current_commit
diff --git a/pom.xml b/pom.xml
index 4a5a9e7ea7..a93b64449a 100644
--- a/pom.xml
+++ b/pom.xml
@@ -16,14 +16,14 @@
     <parent>
         <groupId>org.sonatype.oss</groupId>
         <artifactId>oss-parent</artifactId>
-        <version>7</version>
+        <version>9</version>
         <relativePath></relativePath>
     </parent>
 
     <properties>
         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
         <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
-        <slf4j.version>1.7.5</slf4j.version>
+        <slf4j.version>1.7.7</slf4j.version>
         <log4j.version>1.2.17</log4j.version>
         
         <!-- netbeans formatting rules -->
@@ -102,7 +102,7 @@
             <plugin>                
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-surefire-plugin</artifactId>
-                <version>2.15</version>
+                <version>2.17</version>
                 <configuration>
                     <argLine>-Xmx100m -Xms100m</argLine>
                 </configuration>
@@ -111,7 +111,7 @@
             <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-failsafe-plugin</artifactId>
-                <version>2.15</version>
+                <version>2.17</version>
                 <executions>
                     <execution>
                         <goals>
@@ -125,7 +125,7 @@
             <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-deploy-plugin</artifactId>
-                <version>2.7</version>
+                <version>2.8.1</version>
             </plugin>
             <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
@@ -164,7 +164,7 @@
                     <plugin>
                         <groupId>org.apache.maven.plugins</groupId>
                         <artifactId>maven-gpg-plugin</artifactId>
-                        <version>1.4</version>
+                        <version>1.5</version>
                         <executions>
                             <execution>
                                 <id>sign-artifacts</id>
diff --git a/tools/pom.xml b/tools/pom.xml
index 40f6ae364f..afbbeb5f8e 100644
--- a/tools/pom.xml
+++ b/tools/pom.xml
@@ -41,7 +41,7 @@
         <dependency>
             <groupId>org.apache.commons</groupId>
             <artifactId>commons-compress</artifactId>
-            <version>1.5</version>
+            <version>1.8</version>
         </dependency>
     </dependencies>
     <build>
diff --git a/tools/src/main/java/com/graphhopper/ui/GraphicsWrapper.java b/tools/src/main/java/com/graphhopper/ui/GraphicsWrapper.java
index cd452a0e27..635f2f76c4 100644
--- a/tools/src/main/java/com/graphhopper/ui/GraphicsWrapper.java
+++ b/tools/src/main/java/com/graphhopper/ui/GraphicsWrapper.java
@@ -18,6 +18,7 @@
 package com.graphhopper.ui;
 
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.util.shapes.BBox;
 import java.awt.BasicStroke;
 import java.awt.Color;
@@ -30,7 +31,8 @@
  */
 public class GraphicsWrapper
 {
-    private Graph g;
+    private final Graph g;
+    private final NodeAccess na;
     private double scaleX;
     private double scaleY;
     private double offsetX;
@@ -40,6 +42,7 @@
     public GraphicsWrapper( Graph g )
     {
         this.g = g;
+        this.na = g.getNodeAccess();
         BBox b = g.getBounds();
         scaleX = scaleY = 0.002 * (b.maxLat - b.minLat);
         offsetY = b.maxLat - 90;
@@ -104,8 +107,8 @@ public double getLat( int y )
 
     public void plotNode( Graphics2D g2, int loc, Color c )
     {
-        double lat = g.getLatitude(loc);
-        double lon = g.getLongitude(loc);
+        double lat = na.getLatitude(loc);
+        double lon = na.getLongitude(loc);
         if (lat < bounds.minLat || lat > bounds.maxLat || lon < bounds.minLon || lon > bounds.maxLon)
         {
             return;
diff --git a/tools/src/main/java/com/graphhopper/ui/MiniGraphUI.java b/tools/src/main/java/com/graphhopper/ui/MiniGraphUI.java
index c72e524d4d..3daefdf17d 100644
--- a/tools/src/main/java/com/graphhopper/ui/MiniGraphUI.java
+++ b/tools/src/main/java/com/graphhopper/ui/MiniGraphUI.java
@@ -27,9 +27,9 @@
 import com.graphhopper.routing.util.FastestWeighting;
 import com.graphhopper.routing.util.FlagEncoder;
 import com.graphhopper.routing.util.NoOpAlgorithmPreparation;
-import com.graphhopper.routing.util.ShortestWeighting;
 import com.graphhopper.routing.util.Weighting;
 import com.graphhopper.storage.Graph;
+import com.graphhopper.storage.NodeAccess;
 import com.graphhopper.storage.index.LocationIndex;
 import com.graphhopper.storage.index.QueryResult;
 import com.graphhopper.util.*;
@@ -65,6 +65,7 @@ public static void main( String[] strs ) throws Exception
     private Path path;
     private AlgorithmPreparation prepare;
     private final Graph graph;
+    private final NodeAccess na;
     private LocationIndex index;
     private String latLon = "";
     private GraphicsWrapper mg;
@@ -78,6 +79,7 @@ public static void main( String[] strs ) throws Exception
     public MiniGraphUI( GraphHopper hopper, boolean debug )
     {
         this.graph = hopper.getGraph();
+        this.na = graph.getNodeAccess();
         prepare = hopper.getPreparation();
         FlagEncoder encoder = hopper.getEncodingManager().getSingle();
         weighting = new FastestWeighting(encoder);
@@ -154,9 +156,9 @@ public void paintComponent( Graphics2D g2 )
                 {
                     if (fastPaint && rand.nextInt(30) > 1)
                         continue;
+                    double lat = na.getLatitude(nodeIndex);
+                    double lon = na.getLongitude(nodeIndex);
 
-                    double lat = graph.getLatitude(nodeIndex);
-                    double lon = graph.getLongitude(nodeIndex);
                     // mg.plotText(g2, lat, lon, "" + nodeIndex);
                     if (lat < b.minLat || lat > b.maxLat || lon < b.minLon || lon > b.maxLon)
                         continue;
@@ -173,8 +175,8 @@ public void paintComponent( Graphics2D g2 )
 
                             bitset.add(sum);
                         }
-                        double lat2 = graph.getLatitude(nodeId);
-                        double lon2 = graph.getLongitude(nodeId);
+                        double lat2 = na.getLatitude(nodeId);
+                        double lon2 = na.getLongitude(nodeId);
                         mg.plotEdge(g2, lat, lon, lat2, lon2);
                     }
                 }
@@ -197,8 +199,8 @@ public void paintComponent( Graphics2D g2 )
                 }
 
                 StopWatch sw = new StopWatch().start();
-                fromRes = index.findClosest(48.983787742949886, 12.14355546976484, EdgeFilter.ALL_EDGES);
-                toRes = index.findClosest(48.98291180219765, 12.13610228968002, EdgeFilter.ALL_EDGES);
+                fromRes = index.findClosest(49.973878, 11.604132, EdgeFilter.ALL_EDGES);
+                toRes = index.findClosest(49.973896, 11.604363, EdgeFilter.ALL_EDGES);
 
                 logger.info("start searching from:" + fromRes + " to:" + toRes + " " + weighting);
                 path = algo.calcPath(fromRes, toRes);
@@ -213,7 +215,8 @@ public void paintComponent( Graphics2D g2 )
                     return;
                 }
 
-                logger.info("found path in " + sw.getSeconds() + "s with " + path.calcNodes().size() + " nodes: " + path);
+                logger.info("found path in " + sw.getSeconds() + "s with nodes:"
+                        + path.calcNodes().size() + ", millis: " + path.getMillis() + ", " + path);
                 g2.setColor(Color.BLUE.brighter().brighter());
                 plotPath(path, g2, 1);
             }
@@ -244,8 +247,8 @@ private Path calcPath( RoutingAlgorithm algo )
 
     void plotNodeName( Graphics2D g2, int node )
     {
-        double lat = graph.getLatitude(node);
-        double lon = graph.getLongitude(node);
+        double lat = na.getLatitude(node);
+        double lon = na.getLongitude(node);
         mg.plotText(g2, lat, lon, "" + node);
     }
 
diff --git a/web/Readme.md b/web/Readme.md
index 83570d51d2..498ba0e605 100644
--- a/web/Readme.md
+++ b/web/Readme.md
@@ -1,5 +1,6 @@
 This application uses jQuery and Leaflet to display the calculated route from GraphHopper.
-Execute `./graphhopper.sh web europe_germany_berlin.osm` in the parent folder. Then go to [http://localhost:8989/](http://localhost:8989/).
-Get the raw json query [here](http://localhost:8989/api/route?from=52.439688,13.276863&to=52.532932,13.479424)
+Execute `./graphhopper.sh web europe_germany_berlin.osm` in the parent folder. 
+Then go to [http://localhost:8989/](http://localhost:8989/).
+Get the raw json query [here](http://localhost:8989/route?from=52.439688,13.276863&to=52.532932,13.479424)
 
 [![GraphHopper Maps image](http://karussell.files.wordpress.com/2013/07/maps-preview1.png)](http://graphhopper.com/maps/?point=new%20york&point=los%20angeles)
\ No newline at end of file
diff --git a/web/nb-configuration.xml b/web/nb-configuration.xml
index d07afc98fa..a40fe01b7d 100644
--- a/web/nb-configuration.xml
+++ b/web/nb-configuration.xml
@@ -13,6 +13,6 @@
         That way multiple projects can share the same settings (useful for formatting rules for example).
         Any value defined here will override the pom.xml file value but is only applicable to the current project.
         -->
-        <netbeans.compile.on.save>all</netbeans.compile.on.save>      
+        <netbeans.compile.on.save>all</netbeans.compile.on.save>
     </properties>
 </project-shared-configuration>
diff --git a/web/nbactions.xml b/web/nbactions.xml
index 322e3eca86..b0c017492b 100644
--- a/web/nbactions.xml
+++ b/web/nbactions.xml
@@ -1,34 +1,54 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <actions>
     <action>
-        <actionName>CUSTOM-jetty:run</actionName>
-        <displayName>jetty:run</displayName>
+        <actionName>CUSTOM-failsafe verify</actionName>
+        <displayName>failsafe verify</displayName>
         <goals>
-            <goal>jetty:run</goal>
+            <goal>failsafe:integration-test</goal>
+            <goal>verify</goal>
         </goals>
-        <properties>
-            <maven.test.skip>true</maven.test.skip>
-            <Env.MAVEN_OPTS>-Djetty.port=8989 -Dgraphhopper.config=../config.properties -Dgraphhopper.osmreader.osm=../core/files/krems.osm.gz -Xms1500m -Xms1500m</Env.MAVEN_OPTS>
-        </properties>
     </action>
     <action>
-        <actionName>CUSTOM-jetty:run debug</actionName>
-        <displayName>jetty:run debug</displayName>
-        <goals>
-            <goal>jetty:run</goal>
-        </goals>
-        
-        <properties>
-            <maven.test.skip>true</maven.test.skip>
-            <Env.MAVEN_OPTS>-Djetty.port=8989 -Dgraphhopper.config=../config.properties -Dgraphhopper.osmreader.osm=../core/files/krems.osm.gz -Xms1500m -Xms1500m -Xdebug -Xrunjdwp:transport=dt_socket,server=y,address=8000</Env.MAVEN_OPTS>
-        </properties>
-    </action>
+            <actionName>run</actionName>
+            <packagings>
+                <packaging>jar</packaging>
+            </packagings>
+            <goals>
+                <goal>process-classes</goal>
+                <goal>org.codehaus.mojo:exec-maven-plugin:1.2.1:exec</goal>
+            </goals>
+            <properties>
+                <exec.args>-classpath %classpath com.graphhopper.http.GHServer graph.elevation.cachedir=../srtmprovider jetty.port=8900 config=../config.properties osmreader.osm=/media/SAMSUNG/maps/berlin.pbf</exec.args>
+                <exec.executable>java</exec.executable>
+            </properties>
+        </action>
+    <action>
+            <actionName>debug</actionName>
+            <packagings>
+                <packaging>jar</packaging>
+            </packagings>
+            <goals>
+                <goal>process-classes</goal>
+                <goal>org.codehaus.mojo:exec-maven-plugin:1.2.1:exec</goal>
+            </goals>
+            <properties>
+                <exec.args>-Xdebug -Xrunjdwp:transport=dt_socket,server=n,address=${jpda.address} -classpath %classpath com.graphhopper.http.GHServer graph.elevation.cachedir=../srtmprovider jetty.port=8900 config=../config.properties osmreader.osm=/media/SAMSUNG/maps/berlin.pbf</exec.args>
+                <exec.executable>java</exec.executable>
+                <jpda.listen>true</jpda.listen>
+            </properties>
+        </action>
     <action>
-            <actionName>CUSTOM-failsafe verify</actionName>
-            <displayName>failsafe verify</displayName>
+            <actionName>profile</actionName>
+            <packagings>
+                <packaging>jar</packaging>
+            </packagings>
             <goals>
-                <goal>failsafe:integration-test</goal>
-                <goal>verify</goal>
+                <goal>process-classes</goal>
+                <goal>org.codehaus.mojo:exec-maven-plugin:1.2.1:exec</goal>
             </goals>
+            <properties>
+                <exec.args>-classpath %classpath com.graphhopper.http.GHServer graph.elevation.cachedir=../srtmprovider jetty.port=8900 config=../config.properties osmreader.osm=/media/SAMSUNG/maps/berlin.pbf</exec.args>
+                <exec.executable>java</exec.executable>
+            </properties>
         </action>
 </actions>
diff --git a/web/pom.xml b/web/pom.xml
index a739d22359..2dfbfd39e7 100644
--- a/web/pom.xml
+++ b/web/pom.xml
@@ -5,7 +5,7 @@
     <modelVersion>4.0.0</modelVersion>
     <groupId>com.graphhopper</groupId>
     <artifactId>graphhopper-web</artifactId>
-    <packaging>war</packaging>
+    <packaging>jar</packaging>
     <version>0.3-SNAPSHOT</version>
     <name>GraphHopper Web</name>
     <description>Example on how to use GraphHopper in a web-based application</description>
@@ -16,7 +16,7 @@
         <version>0.3-SNAPSHOT</version>
     </parent>
     <properties>
-        <jetty.version>8.1.10.v20130312</jetty.version>
+        <jetty.version>8.1.14.v20131031</jetty.version>
     </properties>
     
     <dependencies>
@@ -38,7 +38,7 @@
         <dependency>
             <groupId>org.json</groupId>
             <artifactId>json</artifactId>
-            <version>20090211</version>            
+            <version>20140107</version>            
         </dependency>        
         <dependency>
             <groupId>com.google.inject</groupId>
@@ -84,6 +84,17 @@
             <version>${jetty.version}</version>
         </dependency>
         
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-server</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        <dependency>
+            <groupId>org.eclipse.jetty</groupId>
+            <artifactId>jetty-servlet</artifactId>
+            <version>${jetty.version}</version>
+        </dependency>
+        
         <!-- for integration tests of service -->
         <dependency>
             <groupId>org.eclipse.jetty</groupId>
@@ -106,27 +117,7 @@
             <plugin>
                 <groupId>org.apache.maven.plugins</groupId>
                 <artifactId>maven-surefire-plugin</artifactId>
-                <version>2.14</version>
-            </plugin>
-            <plugin>
-                <groupId>org.mortbay.jetty</groupId>
-                <artifactId>jetty-maven-plugin</artifactId>
-                <version>${jetty.version}</version>
-                <configuration>
-                    <!--
-                    <connectors>
-                        <connector implementation="org.eclipse.jetty.server.nio.SelectChannelConnector">	
-                            <port>8989</port>
-                        </connector>
-                    </connectors>
-                    -->
-                                        
-                    <!-- to be used in combination with netbeans compile on save feature -->
-                    <scanTargets>
-                        <scanTarget>target/classes/</scanTarget>
-                    </scanTargets>
-                    <scanIntervalSeconds>1</scanIntervalSeconds>
-                </configuration>
+                <version>2.17</version>
             </plugin>
             <!-- create a jar file too, so others can use it more easily -->
             <plugin>
@@ -135,7 +126,79 @@
                 <configuration>
                     <attachClasses>true</attachClasses>
                 </configuration>
+            </plugin>            
+            <plugin>
+                <artifactId>maven-assembly-plugin</artifactId>
+                
+                <configuration>
+                    <archive>
+                        <manifest>
+                            <mainClass>com.graphhopper.http.GHServer</mainClass>
+                        </manifest>
+                    </archive>
+                    <descriptors>
+                        <descriptor>src/main/assembly/jar.xml</descriptor>
+                        <!-- this is defined to be executed afterwards -->
+                        <descriptor>src/main/assembly/zip.xml</descriptor>
+                    </descriptors>
+                </configuration>
+                <executions>
+                    <execution>
+                        <id>make-assembly</id>
+                        <phase>package</phase>
+                        <goals>
+                            <goal>single</goal>
+                        </goals>
+                    </execution>
+                </executions>
+
+<!--
+                <executions>
+                    <execution>
+                        <id>build-jar</id>
+                        <configuration>
+                            <archive>
+                                <manifest>
+                                    <mainClass>com.graphhopper.http.GHServer</mainClass>
+                                </manifest>
+                            </archive>
+                    
+                            <descriptorRefs>
+                                <descriptorRef>jar-with-dependencies</descriptorRef>
+                            </descriptorRefs>
+                        </configuration>
+                        <phase>package</phase>
+                        <goals>
+                            <goal>single</goal>
+                        </goals>                        
+                    </execution>
+                    <execution>
+                        <id>build-zip</id>
+                        
+                        <configuration>
+                            <appendAssemblyId>false</appendAssemblyId>
+                            <descriptors>
+                                <descriptor>src/main/assembly/zip.xml</descriptor>                                        
+                            </descriptors>                            
+                        </configuration>
+                        <phase>package</phase>
+                        <goals>
+                            <goal>single</goal>
+                        </goals>
+                    </execution>
+                </executions>
+                -->
+                <!--                <executions>
+                    <execution>
+                        <id>make-assembly</id>  this is used for inheritance merges 
+                        <phase>package</phase>  bind to the packaging phase 
+                        <goals>
+                            <goal>single</goal>
+                        </goals>
+                    </execution>
+                </executions>-->
             </plugin>
+ 
         </plugins>
     </build>
 
diff --git a/web/src/main/assembly/jar.xml b/web/src/main/assembly/jar.xml
new file mode 100644
index 0000000000..9deb284f62
--- /dev/null
+++ b/web/src/main/assembly/jar.xml
@@ -0,0 +1,39 @@
+<?xml version='1.0' encoding='UTF-8'?>
+<!--
+  Licensed to the Apache Software Foundation (ASF) under one
+  or more contributor license agreements.  See the NOTICE file
+  distributed with this work for additional information
+  regarding copyright ownership.  The ASF licenses this file
+  to you under the Apache License, Version 2.0 (the
+  "License"); you may not use this file except in compliance
+  with the License.  You may obtain a copy of the License at
+
+  http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing,
+  software distributed under the License is distributed on an
+  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+  KIND, either express or implied.  See the License for the
+  specific language governing permissions and limitations
+  under the License.
+-->
+
+<!-- START SNIPPET: jar-with-dependencies -->
+<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/${mdoVersion}" 
+          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+          xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/${mdoVersion} http://maven.apache.org/xsd/assembly-${mdoVersion}.xsd">
+    <id>with-dep</id>
+    <formats>
+        <format>jar</format>
+    </formats>
+    <includeBaseDirectory>false</includeBaseDirectory>
+    <dependencySets>
+        <dependencySet>
+            <outputDirectory>/</outputDirectory>
+            <useProjectArtifact>true</useProjectArtifact>
+            <unpack>true</unpack>
+            <scope>runtime</scope>
+        </dependencySet>
+    </dependencySets>
+</assembly>
+<!-- END SNIPPET: jar-with-dependencies -->
diff --git a/web/src/main/assembly/zip.xml b/web/src/main/assembly/zip.xml
new file mode 100644
index 0000000000..128b9a092b
--- /dev/null
+++ b/web/src/main/assembly/zip.xml
@@ -0,0 +1,35 @@
+<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0"
+          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+          xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0 http://maven.apache.org/xsd/assembly-1.1.0.xsd">
+    <id>bin</id>
+    <formats>
+        <format>zip</format>
+    </formats>
+    <includeBaseDirectory>false</includeBaseDirectory>
+    <fileSets>
+        <fileSet>
+            <directory>${project.basedir}/src/main/</directory>
+            <outputDirectory/>
+            <includes>
+                <include>webapp/**</include>
+            </includes>
+        </fileSet>
+        <fileSet>
+            <directory>${project.basedir}/..</directory>
+            <outputDirectory/>
+            <includes>
+                <include>NOTICE*</include>
+                <include>LICENSE*</include>
+                <include>CONTRIBUTORS*</include>
+                <include>config-example.properties</include>
+            </includes>
+        </fileSet>
+        <fileSet>
+            <directory>${project.build.directory}</directory>
+            <outputDirectory/>
+            <includes>
+                <include>*-with-dep.jar</include>
+            </includes>
+        </fileSet>
+    </fileSets>
+</assembly>
diff --git a/web/src/main/java/com/graphhopper/http/DefaultModule.java b/web/src/main/java/com/graphhopper/http/DefaultModule.java
index 904321cd06..3d86dcffe4 100644
--- a/web/src/main/java/com/graphhopper/http/DefaultModule.java
+++ b/web/src/main/java/com/graphhopper/http/DefaultModule.java
@@ -31,14 +31,19 @@
  */
 public class DefaultModule extends AbstractModule
 {
-    private Logger logger = LoggerFactory.getLogger(getClass());
+    private final Logger logger = LoggerFactory.getLogger(getClass());
+    private final CmdArgs args;
+
+    public DefaultModule( CmdArgs args )
+    {
+        this.args = args;
+    }
 
     @Override
     protected void configure()
     {
         try
         {
-            CmdArgs args = CmdArgs.readFromConfig("config.properties", "graphhopper.config");
             GraphHopper hopper = create().forServer().init(args);
             hopper.importOrLoad();
             logger.info("loaded graph at:" + hopper.getGraphHopperLocation()
@@ -53,11 +58,6 @@ protected void configure()
 
             long timeout = args.getLong("web.timeout", 3000);
             bind(Long.class).annotatedWith(Names.named("timeout")).toInstance(timeout);
-            bind(Geocoding.class).toInstance(new NominatimGeocoder().
-                    setTimeout((int) timeout).
-                    setBounds(hopper.getGraph().getBounds()));
-            bind(GHThreadPool.class).toInstance(new GHThreadPool(1000, 50).startService());
-
             bind(TranslationMap.class).toInstance(new TranslationMap().doImport());
         } catch (Exception ex)
         {
diff --git a/web/src/main/java/com/graphhopper/http/GHBaseServlet.java b/web/src/main/java/com/graphhopper/http/GHBaseServlet.java
index 276c86db2e..df0029a185 100644
--- a/web/src/main/java/com/graphhopper/http/GHBaseServlet.java
+++ b/web/src/main/java/com/graphhopper/http/GHBaseServlet.java
@@ -34,7 +34,7 @@
 {
     protected Logger logger = LoggerFactory.getLogger(getClass());
 
-    protected void writeJson( HttpServletRequest req, HttpServletResponse res, JSONObject json ) throws JSONException
+    protected void writeJson( HttpServletRequest req, HttpServletResponse res, JSONObject json ) throws JSONException, IOException
     {
         String type = getParam(req, "type", "json");
         res.setCharacterEncoding("UTF-8");
@@ -43,6 +43,12 @@ protected void writeJson( HttpServletRequest req, HttpServletResponse res, JSONO
         {
             res.setContentType("application/javascript");
             String callbackName = getParam(req, "callback", null);
+            if (callbackName == null)
+            {
+                res.sendError(SC_BAD_REQUEST, "No callback provided, necessary if type=jsonp");
+                return;
+            }
+
             if (debug)
             {
                 writeResponse(res, callbackName + "(" + json.toString(2) + ")");
diff --git a/web/src/main/java/com/graphhopper/http/MyGZIPHook.java b/web/src/main/java/com/graphhopper/http/GHGZIPHook.java
similarity index 97%
rename from web/src/main/java/com/graphhopper/http/MyGZIPHook.java
rename to web/src/main/java/com/graphhopper/http/GHGZIPHook.java
index 70668ecd55..828684f0d1 100644
--- a/web/src/main/java/com/graphhopper/http/MyGZIPHook.java
+++ b/web/src/main/java/com/graphhopper/http/GHGZIPHook.java
@@ -31,7 +31,7 @@
  * <p/>
  * @author Peter Karich
  */
-public class MyGZIPHook extends GzipFilter
+public class GHGZIPHook extends GzipFilter
 {
     private Logger logger = LoggerFactory.getLogger(getClass());
 
diff --git a/web/src/main/java/com/graphhopper/http/GHServer.java b/web/src/main/java/com/graphhopper/http/GHServer.java
new file mode 100644
index 0000000000..db1992ee94
--- /dev/null
+++ b/web/src/main/java/com/graphhopper/http/GHServer.java
@@ -0,0 +1,138 @@
+/*
+ *  Licensed to GraphHopper and Peter Karich under one or more contributor
+ *  license agreements. See the NOTICE file distributed with this work for
+ *  additional information regarding copyright ownership.
+ *
+ *  GraphHopper licenses this file to you under the Apache License,
+ *  Version 2.0 (the "License"); you may not use this file except in
+ *  compliance with the License. You may obtain a copy of the License at
+ *
+ *       http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package com.graphhopper.http;
+
+import com.google.inject.AbstractModule;
+import com.google.inject.Guice;
+import com.google.inject.Injector;
+import com.google.inject.Module;
+import com.google.inject.servlet.GuiceFilter;
+import com.graphhopper.GraphHopper;
+import com.graphhopper.util.CmdArgs;
+import org.eclipse.jetty.server.Server;
+import org.eclipse.jetty.servlet.ServletHolder;
+
+import it.esalab.mapaal.http.MapaalGraphHopper;
+
+import java.util.EnumSet;
+import javax.servlet.DispatcherType;
+import org.eclipse.jetty.server.Handler;
+import org.eclipse.jetty.server.handler.HandlerList;
+import org.eclipse.jetty.server.handler.ResourceHandler;
+import org.eclipse.jetty.server.nio.SelectChannelConnector;
+import org.eclipse.jetty.servlet.FilterHolder;
+import org.eclipse.jetty.servlet.ServletContextHandler;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+/**
+ * Simple server similar to integration tests setup.
+ */
+public class GHServer
+{
+    public static void main( String[] args ) throws Exception
+    {
+        new GHServer(CmdArgs.read(args)).start();
+    }
+
+    private final CmdArgs args;
+    private Server server;
+    private final Logger logger = LoggerFactory.getLogger(getClass());
+
+    public GHServer( CmdArgs args )
+    {
+        this.args = args;
+    }
+
+    public void start() throws Exception
+    {
+        Injector injector = Guice.createInjector(createModule());
+        start(injector);
+    }
+
+    public void start( Injector injector ) throws Exception
+    {
+        ResourceHandler resHandler = new ResourceHandler();
+        resHandler.setDirectoriesListed(false);
+        resHandler.setWelcomeFiles(new String[]
+        {
+            "index.html"
+        });
+        resHandler.setResourceBase(args.get("jetty.resourcebase", "./src/main/webapp"));
+
+        server = new Server();
+        // getSessionHandler and getSecurityHandler should always return null
+        ServletContextHandler servHandler = new ServletContextHandler(ServletContextHandler.NO_SECURITY | ServletContextHandler.NO_SESSIONS);
+        servHandler.setContextPath("/");
+
+        servHandler.addServlet(new ServletHolder(new InvalidRequestServlet()), "/*");
+
+        FilterHolder guiceFilter = new FilterHolder(injector.getInstance(GuiceFilter.class));
+        servHandler.addFilter(guiceFilter, "/*", EnumSet.allOf(DispatcherType.class));
+
+        int httpPort = args.getInt("jetty.port", 8989);
+        SelectChannelConnector connector0 = new SelectChannelConnector();
+        // don't allow access from outside!
+        // connector0.setHost("127.0.0.1");
+        connector0.setPort(httpPort);
+        server.addConnector(connector0);
+
+        HandlerList handlers = new HandlerList();
+        handlers.setHandlers(new Handler[]
+        {
+            resHandler, servHandler
+        });
+        server.setHandler(handlers);
+        server.start();
+        logger.info("Started server at HTTP " + httpPort);
+    }
+
+    private Module createModule()
+    {
+        return new AbstractModule()
+        {
+            @Override
+            protected void configure()
+            {
+                binder().requireExplicitBindings();
+
+                install(new DefaultModule(args){
+                  @Override
+                  protected GraphHopper create() {
+                    // EXPLICIT CODE CHANGE!
+                    return new MapaalGraphHopper();
+                  }
+                });
+                install(new GHServletModule());
+
+                bind(GuiceFilter.class);
+            }
+        };
+    }
+
+    public void stop()
+    {
+        try
+        {
+            server.stop();
+        } catch (Exception ex)
+        {
+            logger.error("Cannot stop jetty", ex);
+        }
+    }
+}
diff --git a/web/src/main/java/com/graphhopper/http/GHServletModule.java b/web/src/main/java/com/graphhopper/http/GHServletModule.java
new file mode 100644
index 0000000000..59b09da320
--- /dev/null
+++ b/web/src/main/java/com/graphhopper/http/GHServletModule.java
@@ -0,0 +1,40 @@
+/*
+ * To change this license header, choose License Headers in Project Properties.
+ * To change this template file, choose Tools | Templates
+ * and open the template in the editor.
+ */
+package com.graphhopper.http;
+
+import com.google.inject.Singleton;
+import com.google.inject.servlet.ServletModule;
+import java.util.HashMap;
+import java.util.Map;
+
+/**
+ * @author Peter Karich
+ */
+public class GHServletModule extends ServletModule
+{
+    @Override
+    protected void configureServlets()
+    {
+        Map<String, String> params = new HashMap<String, String>();
+        params.put("mimeTypes", "text/html,"
+                + "text/plain,"
+                + "text/xml,"
+                + "application/xhtml+xml,"
+                + "text/css,"
+                + "application/json,"
+                + "application/javascript,"
+                + "image/svg+xml");
+
+        filter("*").through(GHGZIPHook.class, params);
+        bind(GHGZIPHook.class).in(Singleton.class);
+
+        serve("/i18n*").with(I18NServlet.class);
+        bind(I18NServlet.class).in(Singleton.class);
+
+        serve("*").with(GraphHopperServlet.class);
+        bind(GraphHopperServlet.class).in(Singleton.class);
+    }
+}
diff --git a/web/src/main/java/com/graphhopper/http/GHThreadPool.java b/web/src/main/java/com/graphhopper/http/GHThreadPool.java
deleted file mode 100644
index 89d12a51f4..0000000000
--- a/web/src/main/java/com/graphhopper/http/GHThreadPool.java
+++ /dev/null
@@ -1,206 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.http;
-
-import java.util.ArrayList;
-import java.util.Collection;
-import java.util.List;
-import java.util.concurrent.BlockingQueue;
-import java.util.concurrent.Callable;
-import java.util.concurrent.ExecutorService;
-import java.util.concurrent.Executors;
-import java.util.concurrent.LinkedBlockingQueue;
-import java.util.concurrent.RejectedExecutionException;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
-/**
- * @author Peter Karich
- */
-public class GHThreadPool
-{
-    private final Logger logger = LoggerFactory.getLogger(getClass());
-    private final ExecutorService service;
-    private final int threads;
-    private final BlockingQueue<GHWorker> resolverQueue;
-
-    public GHThreadPool( int queueSize, int threads )
-    {
-        resolverQueue = new LinkedBlockingQueue<GHWorker>(queueSize);
-        this.threads = threads;
-        service = Executors.newFixedThreadPool(threads);
-    }
-
-    /**
-     * Starts this thread pool in background
-     */
-    public GHThreadPool startService()
-    {
-        new Thread("ThreadPool Service Executor")
-        {
-            @Override
-            public void run()
-            {
-                Collection<Callable<Object>> callableCollection = new ArrayList<Callable<Object>>(threads);
-                for (int i = 0; i < threads; i++)
-                {
-                    final int threadNo = i;
-                    callableCollection.add(new Callable<Object>()
-                    {
-                        @Override
-                        public Object call() throws Exception
-                        {
-                            try
-                            {
-                                while (!isInterrupted())
-                                {
-                                    execute(threadNo);
-                                }
-                            } catch (InterruptedException ex)
-                            {
-                                logger.debug(getName() + " - thread " + threadNo + " interrupted. Error: " + ex.getMessage());
-                            } catch (Throwable ex)
-                            {
-                                logger.error(getName() + " - thread " + threadNo + " died", ex);
-                            }
-                            return null;
-                        }
-                    });
-                }
-                try
-                {
-                    logger.info(getName() + " STARTED");
-                    service.invokeAll(callableCollection);
-                    logger.info(getName() + " FINISHED");
-                } catch (RejectedExecutionException ex)
-                {
-                    logger.info(getName() + " cannot create threads, " + ex.getMessage());
-                } catch (InterruptedException ex)
-                {
-                    logger.info(getName() + " was interrupted, " + ex.getMessage());
-                }
-            }
-        }.start();
-        return this;
-    }
-
-    public void enqueue( GHWorker worker )
-    {
-        if (!resolverQueue.offer(worker.doEnqueue()))
-        {
-            logger.error("Queue full!? " + resolverQueue.size() + " couldn't enqueue " + worker);
-        }
-    }
-
-    protected void execute( int workerNo ) throws InterruptedException
-    {
-        GHWorker worker = resolverQueue.take();
-        try
-        {
-            if (!worker.isTimedOut())
-            {
-                worker.run();
-            } else
-            {
-                logger.warn(worker + " timed out - maximum livetime reached (" + worker.maxLiveTimeInMillis + ")");
-            }
-        } catch (Exception ex)
-        {
-            logger.warn(workerNo + " Error for worker " + worker + ", error:" + ex.getMessage());
-        }
-        worker.finish();
-    }
-
-    public void stopService()
-    {
-        service.shutdown();
-    }
-
-    public void waitFor( List<GHWorker> workers, long timeOutInMillis )
-    {
-        long remainingTimeout = timeOutInMillis;
-        try
-        {
-            for (GHWorker w : workers)
-            {
-                long tmp = System.currentTimeMillis();
-                synchronized (w)
-                {
-                    if (w.isAlive())
-                        w.wait(timeOutInMillis);
-                }
-                remainingTimeout -= (System.currentTimeMillis() - tmp);
-                if (remainingTimeout < 10)
-                {
-                    break;
-                }
-            }
-        } catch (InterruptedException ex)
-        {
-            logger.warn("workers were interrupted " + workers);
-        }
-    }
-
-    public static abstract class GHWorker implements Runnable
-    {
-        private final long maxLiveTimeInMillis;
-        private volatile long startTime = -1;
-        private volatile boolean alive = true;
-
-        public GHWorker( long maxLiveTimeInMillis )
-        {
-            this.maxLiveTimeInMillis = maxLiveTimeInMillis;
-        }
-
-        private GHWorker doEnqueue()
-        {
-            startTime = System.currentTimeMillis();
-            return this;
-        }
-
-        private boolean isTimedOut()
-        {
-            if (startTime < 0)
-                throw new IllegalStateException("Call doEnqueue before");
-
-            return (System.currentTimeMillis() - startTime) > maxLiveTimeInMillis;
-        }
-
-        public abstract String getName();
-
-        public boolean isAlive()
-        {
-            return alive;
-        }
-
-        @Override
-        public String toString()
-        {
-            return getName();
-        }
-
-        private void finish()
-        {            
-            synchronized (this)
-            {
-                alive = false;
-                notifyAll();
-            }
-        }
-    }
-}
diff --git a/web/src/main/java/com/graphhopper/http/GraphHopperServlet.java b/web/src/main/java/com/graphhopper/http/GraphHopperServlet.java
index 7b7e904d00..d9f55c4c61 100644
--- a/web/src/main/java/com/graphhopper/http/GraphHopperServlet.java
+++ b/web/src/main/java/com/graphhopper/http/GraphHopperServlet.java
@@ -17,11 +17,11 @@
  */
 package com.graphhopper.http;
 
-import com.graphhopper.search.Geocoding;
 import com.graphhopper.GHRequest;
 import com.graphhopper.GraphHopper;
 import com.graphhopper.GHResponse;
 import com.graphhopper.routing.util.FlagEncoder;
+import com.graphhopper.storage.StorableProperties;
 import com.graphhopper.util.*;
 import com.graphhopper.util.TranslationMap.Translation;
 import com.graphhopper.util.shapes.BBox;
@@ -35,257 +35,217 @@
 import javax.servlet.http.HttpServletResponse;
 import static javax.servlet.http.HttpServletResponse.*;
 import org.json.JSONException;
+import org.json.JSONObject;
 
 /**
- * Servlet to use GraphHopper in a remote application (mobile or browser).
- * Attention: If type is json it returns the points in GeoJson format
- * (longitude,latitude) unlike the format "lat,lon" used otherwise.
+ * Servlet to use GraphHopper in a remote application (mobile or browser). Attention: If type is
+ * json it returns the points in GeoJson format (longitude,latitude) unlike the format "lat,lon"
+ * used otherwise.
  * <p/>
  * @author Peter Karich
  */
-public class GraphHopperServlet extends GHBaseServlet {
+public class GraphHopperServlet extends GHBaseServlet
+{
 
     @Inject
     private GraphHopper hopper;
     @Inject
-    private Geocoding geocoding;
-    @Inject
     @Named("defaultAlgorithm")
     private String defaultAlgorithm;
     @Inject
-    @Named("timeout")
-    private Long timeOutInMillis;
-    @Inject
-    private GHThreadPool threadPool;
-    @Inject
     private TranslationMap trMap;
 
     @Override
-    public void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
-        try {
-            if ("/info".equals(req.getPathInfo())) {
+    public void doGet( HttpServletRequest req, HttpServletResponse res ) throws ServletException, IOException
+    {
+        try
+        {
+            if ("/info".equals(req.getPathInfo()))
+            {
                 writeInfos(req, res);
-            } else if ("/route".equals(req.getPathInfo())) {
+            } else if ("/route".equals(req.getPathInfo()))
+            {
                 writePath(req, res);
             }
-        } catch (Exception ex) {
+        } catch (IllegalArgumentException ex)
+        {
+            writeError(res, SC_BAD_REQUEST, ex.getMessage());
+        } catch (Exception ex)
+        {
             logger.error("Error while executing request: " + req.getQueryString(), ex);
             writeError(res, SC_INTERNAL_SERVER_ERROR, "Problem occured:" + ex.getMessage());
         }
     }
 
-    void writeInfos(HttpServletRequest req, HttpServletResponse res) throws Exception {
+    void writeInfos( HttpServletRequest req, HttpServletResponse res ) throws Exception
+    {
         BBox bb = hopper.getGraph().getBounds();
         List<Double> list = new ArrayList<Double>(4);
         list.add(bb.minLon);
         list.add(bb.minLat);
         list.add(bb.maxLon);
         list.add(bb.maxLat);
-        JSONBuilder json = new JSONBuilder().
-                object("bbox", list).
-                object("supportedVehicles", hopper.getEncodingManager()).
-                object("version", Constants.VERSION).
-                object("buildDate", Constants.BUILD_DATE);
-        writeJson(req, res, json.build());
-    }
 
-    void writePath(HttpServletRequest req, HttpServletResponse res) throws Exception {
-        StopWatch sw = new StopWatch().start();
-        List<GHPlace> infoPoints = getPoints(req);
-        float tookGeocoding = sw.stop().getSeconds();
-        GHPlace start = infoPoints.get(0);
-        GHPlace end = infoPoints.get(1);
-        try {
-            // we can reduce the path length based on the maximum differences to the original coordinates
-            double minPathPrecision = getDoubleParam(req, "minPathPrecision", 1d);
-            boolean writeGPX = "gpx".equalsIgnoreCase(getParam(req, "type", "json"));
-            boolean enableInstructions = writeGPX || getBooleanParam(req, "instructions", true);
-            boolean calcPoints = getBooleanParam(req, "calcPoints", true);
-            String vehicleStr = getParam(req, "vehicle", "CAR").toUpperCase();
-            String weighting = getParam(req, "weighting", "fastest");
-            // REMOVE_IN 0.3
-            if (req.getParameterMap().containsKey("algoType"))
-                weighting = getParam(req, "algoType", "fastest");
+        JSONObject json = new JSONObject();
+        json.put("bbox", list);
+        json.put("supported_vehicles", hopper.getGraph().getEncodingManager().toString().split(","));
+        json.put("version", Constants.VERSION);
+        json.put("build_date", Constants.BUILD_DATE);
 
-            String algoStr = getParam(req, "algorithm", defaultAlgorithm);
+        StorableProperties props = hopper.getGraph().getProperties();
+        json.put("import_date", props.get("osmreader.import.date"));
 
-            sw = new StopWatch().start();
-            GHResponse rsp;
-            if (hopper.getEncodingManager().supports(vehicleStr)) {
-                FlagEncoder algoVehicle = hopper.getEncodingManager().getEncoder(vehicleStr);
-                rsp = hopper.route(new GHRequest(start, end).
-                        setVehicle(algoVehicle.toString()).
-                        setWeighting(weighting).
-                        setAlgorithm(algoStr).
-                        putHint("calcPoints", calcPoints).
-                        putHint("instructions", enableInstructions).
-                        putHint("douglas.minprecision", minPathPrecision));
-            } else {
-                rsp = new GHResponse().addError(new IllegalArgumentException("Vehicle not supported: " + vehicleStr));
-            }
+        if (!Helper.isEmpty(props.get("prepare.date")))
+            json.put("prepare_date", props.get("prepare.date"));
 
-            float took = sw.stop().getSeconds();
-            String infoStr = req.getRemoteAddr() + " " + req.getLocale() + " " + req.getHeader("User-Agent");
-            PointList points = rsp.getPoints();
-            String logStr = req.getQueryString() + " " + infoStr + " " + start + "->" + end
-                    + ", distance: " + rsp.getDistance() + ", time:" + Math.round(rsp.getMillis() / 60000f)
-                    + "min, points:" + points.getSize() + ", took:" + took
-                    + ", debug - " + rsp.getDebugInfo() + ", " + algoStr + ", "
-                    + weighting + ", " + vehicleStr;
+        writeJson(req, res, json);
+    }
 
-            if (rsp.hasErrors())
-                logger.error(logStr + ", errors:" + rsp.getErrors());
-            else
-                logger.info(logStr);
+    void writePath( HttpServletRequest req, HttpServletResponse res ) throws Exception
+    {
+        List<GHPlace> infoPoints = getPoints(req);
 
-            if (writeGPX)
-                writeGPX(req, res, rsp);
-            else
-                writeJson(req, res, rsp, start, end, tookGeocoding, took);
+        // we can reduce the path length based on the maximum differences to the original coordinates
+        double minPathPrecision = getDoubleParam(req, "min_path_precision", 1d);
+        boolean writeGPX = "gpx".equalsIgnoreCase(getParam(req, "type", "json"));
+        boolean enableInstructions = writeGPX || getBooleanParam(req, "instructions", true);
+        boolean calcPoints = getBooleanParam(req, "calc_points", true);
+        String vehicleStr = getParam(req, "vehicle", "CAR").toUpperCase();
+        String weighting = getParam(req, "weighting", "fastest");
+        String algoStr = getParam(req, "algorithm", defaultAlgorithm);
 
-        } catch (Exception ex) {
-            logger.error("Error while query:" + start + "->" + end, ex);
-            writeError(res, SC_INTERNAL_SERVER_ERROR, "Problem occured:" + ex.getMessage());
+        StopWatch sw = new StopWatch().start();
+        GHResponse rsp;
+        if (hopper.getEncodingManager().supports(vehicleStr))
+        {
+            FlagEncoder algoVehicle = hopper.getEncodingManager().getEncoder(vehicleStr);
+            rsp = hopper.route(new GHRequest(infoPoints).
+                    setVehicle(algoVehicle.toString()).
+                    setWeighting(weighting).
+                    setAlgorithm(algoStr).
+                    putHint("calcPoints", calcPoints).
+                    putHint("instructions", enableInstructions).
+                    putHint("douglas.minprecision", minPathPrecision));
+        } else
+        {
+            rsp = new GHResponse().addError(new IllegalArgumentException("Vehicle not supported: " + vehicleStr));
         }
+
+        float took = sw.stop().getSeconds();
+        String infoStr = req.getRemoteAddr() + " " + req.getLocale() + " " + req.getHeader("User-Agent");
+        PointList points = rsp.getPoints();
+        String logStr = req.getQueryString() + " " + infoStr + " " + infoPoints
+                + ", distance: " + rsp.getDistance() + ", time:" + Math.round(rsp.getMillis() / 60000f)
+                + "min, points:" + points.getSize() + ", took:" + took
+                + ", debug - " + rsp.getDebugInfo() + ", " + algoStr + ", "
+                + weighting + ", " + vehicleStr;
+
+        if (rsp.hasErrors())
+            logger.error(logStr + ", errors:" + rsp.getErrors());
+        else
+            logger.info(logStr);
+
+        if (writeGPX)
+            writeGPX(req, res, rsp);
+        else
+            writeJson(req, res, rsp, took);
     }
 
-    private void writeGPX(HttpServletRequest req, HttpServletResponse res, GHResponse rsp) {
+    private void writeGPX( HttpServletRequest req, HttpServletResponse res, GHResponse rsp )
+    {
         res.setCharacterEncoding("UTF-8");
         res.setContentType("application/xml");
         String trackName = getParam(req, "track", "GraphHopper Track");
-        res.setHeader( "Content-Disposition", "attachment;filename=" + "GraphHopper.gpx" );
+        res.setHeader("Content-Disposition", "attachment;filename=" + "GraphHopper.gpx");
         String timeZone = getParam(req, "timezone", "GMT");
         long time = getLongParam(req, "millis", System.currentTimeMillis());
         writeResponse(res, rsp.getInstructions().createGPX(trackName, time, timeZone));
     }
 
-    private void writeJson(HttpServletRequest req, HttpServletResponse res,
-            GHResponse rsp, GHPlace start, GHPlace end,
-            float tookGeocoding, float took) throws JSONException {
+    private void writeJson( HttpServletRequest req, HttpServletResponse res,
+            GHResponse rsp, float took ) throws JSONException, IOException
+    {
         boolean enableInstructions = getBooleanParam(req, "instructions", true);
-        boolean useMiles = getBooleanParam(req, "useMiles", false);
         Locale locale = Helper.getLocale(getParam(req, "locale", "en"));
-        boolean encodedPolylineParam = getBooleanParam(req, "encodedPolyline", true);
-        JSONBuilder builder;
-        if (rsp.hasErrors()) {
-            builder = new JSONBuilder().startObject("info");
+        boolean pointsEncoded = getBooleanParam(req, "points_encoded", true);
+        boolean calcPoints = getBooleanParam(req, "calc_points", true);
+        JSONObject json = new JSONObject();
+        JSONObject jsonInfo = new JSONObject();
+        json.put("info", jsonInfo);
+
+        if (rsp.hasErrors())
+        {
             List<Map<String, String>> list = new ArrayList<Map<String, String>>();
-            for (Throwable t : rsp.getErrors()) {
+            for (Throwable t : rsp.getErrors())
+            {
                 Map<String, String> map = new HashMap<String, String>();
                 map.put("message", t.getMessage());
                 map.put("details", t.getClass().getName());
                 list.add(map);
             }
-            builder = builder.object("errors", list).endObject();
-        } else {
-            builder = new JSONBuilder().
-                    startObject("info").
-                    object("routeFound", rsp.isFound()).
-                    object("took", took).
-                    object("tookGeocoding", tookGeocoding).
-                    endObject();
-            builder = builder.startObject("route").
-                    object("from", new Double[]{
-                        start.lon, start.lat
-                    }).
-                    object("to", new Double[]{
-                        end.lon, end.lat
-                    }).
-                    object("distance", rsp.getDistance()).
-                    object("time", rsp.getMillis());
-
-            if (enableInstructions) {
-                Translation tr = trMap.getWithFallBack(locale);
-                InstructionList instructions = rsp.getInstructions();
-                builder.startObject("instructions").
-                        object("descriptions", instructions.createDescription(tr)).
-                        object("distances", instructions.createDistances()).
-                        object("indications", instructions.createIndications()).
-                        object("millis", instructions.createMillis()).
-                        object("latLngs", instructions.createLatLngs()).
-                        endObject();
+            jsonInfo.put("errors", list);
+        } else if (!rsp.isFound())
+        {
+            Map<String, String> map = new HashMap<String, String>();
+            map.put("message", "Not found");
+            map.put("details", "");
+            jsonInfo.put("errors", Collections.singletonList(map));
+        } else
+        {
+            JSONObject jsonPath = new JSONObject();
+            jsonInfo.put("took", took);
+            jsonPath.put("distance", rsp.getDistance());
+            jsonPath.put("time", rsp.getMillis());
+
+            if (calcPoints)
+            {
+                jsonPath.put("points_encoded", pointsEncoded);
+
+                PointList points = rsp.getPoints();
+                if (points.getSize() >= 2)
+                    jsonPath.put("bbox", rsp.calcRouteBBox(hopper.getGraph().getBounds()).toGeoJson());
+
+                jsonPath.put("points", createPoints(points, pointsEncoded));
+                jsonPath.put("points_dimension", points.getDimension());
+
+                if (enableInstructions)
+                {
+                    Translation tr = trMap.getWithFallBack(locale);
+                    InstructionList instructions = rsp.getInstructions();
+                    jsonPath.put("instructions", instructions.createJson(tr));
+                }
             }
+            json.put("paths", Collections.singletonList(jsonPath));
+        }                        
 
-            PointList points = rsp.getPoints();
-            if (points.getSize() >= 2)
-                builder.object("bbox", rsp.calcRouteBBox(hopper.getGraph().getBounds()).toGeoJson());
+        writeJson(req, res, json);
+    }
 
-            if (encodedPolylineParam) {
-                String encodedPolyline = WebHelper.encodePolyline(points);
-                builder.object("coordinates", encodedPolyline);
-            } else {
-                builder.startObject("data").
-                        object("type", "LineString").
-                        object("coordinates", points.toGeoJson()).
-                        endObject();
-            }
-            // end route
-            builder = builder.endObject();
-        }
+    Object createPoints( PointList points, boolean pointsEncoded ) throws JSONException
+    {
+        if (pointsEncoded)
+            return WebHelper.encodePolyline(points);
 
-        writeJson(req, res, builder.build());
+        JSONObject jsonPoints = new JSONObject();
+        jsonPoints.put("type", "LineString");
+        jsonPoints.put("coordinates", points.toGeoJson());
+        return jsonPoints;
     }
 
-    private List<GHPlace> getPoints(HttpServletRequest req) throws IOException {
+    private List<GHPlace> getPoints( HttpServletRequest req ) throws IOException
+    {
         String[] pointsAsStr = getParams(req, "point");
-        // allow two formats
-        if (pointsAsStr.length == 0) {
-            String from = getParam(req, "from", "");
-            String to = getParam(req, "to", "");
-            if (!Helper.isEmpty(from) && !Helper.isEmpty(to)) {
-                pointsAsStr = new String[]{
-                    from, to
-                };
-            }
-        }
-
         final List<GHPlace> infoPoints = new ArrayList<GHPlace>();
-        List<GHThreadPool.GHWorker> workers = new ArrayList<GHThreadPool.GHWorker>();
-        for (int pointNo = 0; pointNo < pointsAsStr.length; pointNo++) {
+        for (int pointNo = 0; pointNo < pointsAsStr.length; pointNo++)
+        {
             final String str = pointsAsStr[pointNo];
             String[] fromStrs = str.split(",");
-            if (fromStrs.length == 2) {
+            if (fromStrs.length == 2)
+            {
                 GHPlace place = GHPlace.parse(str);
                 if (place != null)
                     infoPoints.add(place);
-                continue;
             }
-
-            // now it is not a coordinate and we need to call geo resolver
-            final int index = infoPoints.size();
-            infoPoints.add(new GHPlace(Double.NaN, Double.NaN).setName(str));
-            GHThreadPool.GHWorker worker = new GHThreadPool.GHWorker(timeOutInMillis) {
-                @Override
-                public String getName() {
-                    return "geocoding search " + str;
-                }
-
-                @Override
-                public void run() {
-                    List<GHPlace> tmpPoints = geocoding.name2point(new GHPlace(str));
-                    if (!tmpPoints.isEmpty()) {
-                        infoPoints.set(index, tmpPoints.get(0));
-                    }
-                }
-            };
-            workers.add(worker);
-            threadPool.enqueue(worker);
-        }
-        threadPool.waitFor(workers, timeOutInMillis);
-        for (GHPlace p : infoPoints) {
-            if (Double.isNaN(p.lat)) {
-                throw new IllegalArgumentException("[nominatim] Not all points could be resolved! " + infoPoints);
-            }
-        }
-
-        // TODO resolve name in a thread if only lat,lon is given but limit to a certain timeout
-        if (infoPoints == null || infoPoints.size() < 2) {
-            throw new IllegalArgumentException("Did you specify point=<from>&point=<to> ? Use at least 2 points! " + infoPoints);
-        }
-
-        // TODO execute algorithm multiple times!
-        if (infoPoints.size() != 2) {
-            throw new IllegalArgumentException("TODO! At the moment only 2 points can be specified");
         }
 
         return infoPoints;
diff --git a/web/src/main/java/com/graphhopper/http/GraphHopperWeb.java b/web/src/main/java/com/graphhopper/http/GraphHopperWeb.java
index 1d87410adf..9e114a2a57 100644
--- a/web/src/main/java/com/graphhopper/http/GraphHopperWeb.java
+++ b/web/src/main/java/com/graphhopper/http/GraphHopperWeb.java
@@ -21,8 +21,11 @@
 import com.graphhopper.GHResponse;
 import com.graphhopper.GraphHopperAPI;
 import com.graphhopper.util.Downloader;
+import com.graphhopper.util.Instruction;
+import com.graphhopper.util.InstructionList;
 import com.graphhopper.util.PointList;
 import com.graphhopper.util.StopWatch;
+import com.graphhopper.util.shapes.GHPlace;
 import org.json.JSONArray;
 import org.json.JSONObject;
 import org.slf4j.Logger;
@@ -38,15 +41,16 @@
     public static void main( String[] args )
     {
         GraphHopperAPI gh = new GraphHopperWeb();
-        gh.load("http://localhost:8989/api/route");
+        gh.load("http://localhost:8989/route");
         //GHResponse ph = gh.route(new GHRequest(53.080827, 9.074707, 50.597186, 11.184082));
         GHResponse ph = gh.route(new GHRequest(49.6724, 11.3494, 49.6550, 11.4180));
         System.out.println(ph);
     }
     private Logger logger = LoggerFactory.getLogger(getClass());
     private String serviceUrl;
-    private boolean encodePolyline = true;
+    private boolean pointsEncoded = true;
     private Downloader downloader = new Downloader("GraphHopperWeb");
+    private boolean instructions = true;
 
     public GraphHopperWeb()
     {
@@ -58,7 +62,7 @@ public void setDownloader( Downloader downloader )
     }
 
     /**
-     * Example url: http://localhost:8989/api or http://217.92.216.224:8080/api
+     * Example url: http://localhost:8989 or http://217.92.216.224:8080
      */
     @Override
     public boolean load( String url )
@@ -67,53 +71,100 @@ public boolean load( String url )
         return true;
     }
 
-    public GraphHopperWeb setEncodePolyline( boolean b )
+    public GraphHopperWeb setPointsEncoded( boolean b )
     {
-        encodePolyline = b;
+        pointsEncoded = b;
+        return this;
+    }
+
+    public GraphHopperWeb setInstructions( boolean b )
+    {
+        instructions = b;
         return this;
     }
 
     @Override
     public GHResponse route( GHRequest request )
     {
-        request.check();
         StopWatch sw = new StopWatch().start();
         double took = 0;
         try
         {
+            String places = "";
+            for (GHPlace p : request.getPlaces())
+            {
+                places += "point=" + p.lat + "," + p.lon + "&";
+            }
             String url = serviceUrl
-                    + "?from=" + request.getFrom().lat + "," + request.getFrom().lon
-                    + "&to=" + request.getTo().lat + "," + request.getTo().lon
+                    + "?"
+                    + places
                     + "&type=json"
-                    + "&encodedPolyline=" + encodePolyline
-                    + "&minPathPrecision=" + request.getHint("douglas.minprecision", 1)
+                    + "&points_encoded=" + pointsEncoded
+                    + "&min_path_precision=" + request.getHint("douglas.minprecision", 1)
                     + "&algo=" + request.getAlgorithm();
             String str = downloader.downloadAsString(url);
             JSONObject json = new JSONObject(str);
             took = json.getJSONObject("info").getDouble("took");
-            JSONObject route = json.getJSONObject("route");
-            double distance = route.getDouble("distance");
-            int millis = route.getInt("time");
-            PointList list;
-            if (encodePolyline)
+            JSONArray paths = json.getJSONArray("paths");
+            JSONObject firstPath = paths.getJSONObject(0);
+
+            boolean is3D = false;
+            if (firstPath.has("points_dim"))
+                is3D = "3".equals(firstPath.getString("points_dim"));
+            double distance = firstPath.getDouble("distance");
+            int time = firstPath.getInt("time");
+            PointList pointList;
+            if (pointsEncoded)
             {
-                list = WebHelper.decodePolyline(route.getString("coordinates"), 100);
+                pointList = WebHelper.decodePolyline(firstPath.getString("points"), 100, is3D);
             } else
             {
-                JSONArray coords = route.getJSONObject("data").getJSONArray("coordinates");
-                list = new PointList(coords.length());
+                JSONArray coords = firstPath.getJSONObject("points").getJSONArray("coordinates");
+                pointList = new PointList(coords.length(), is3D);
                 for (int i = 0; i < coords.length(); i++)
                 {
                     JSONArray arr = coords.getJSONArray(i);
                     double lon = arr.getDouble(0);
                     double lat = arr.getDouble(1);
-                    list.add(lat, lon);
+                    if (is3D)
+                        pointList.add(lat, lon, arr.getDouble(2));
+                    else
+                        pointList.add(lat, lon);
+                }
+            }
+            GHResponse res = new GHResponse();
+            if (instructions)
+            {
+                JSONArray instrArr = firstPath.getJSONArray("instructions");
+
+                InstructionList il = new InstructionList();
+                for (int instrIndex = 0; instrIndex < instrArr.length(); instrIndex++)
+                {
+                    JSONObject jsonObj = instrArr.getJSONObject(instrIndex);
+                    double instDist = jsonObj.getDouble("distance");
+                    String text = jsonObj.getString("text");
+                    long instTime = jsonObj.getLong("time");
+                    int sign = jsonObj.getInt("sign");
+                    JSONArray iv = jsonObj.getJSONArray("interval");
+                    int from = iv.getInt(0);
+                    int to = iv.getInt(1);
+                    PointList instPL = new PointList(to - from, is3D);
+                    for (int j = from; j <= to; j++)
+                    {
+                        instPL.add(pointList, j);
+                    }
+
+                    // TODO way and payment type
+                    Instruction instr = new Instruction(sign, text, -1, -1, instPL).
+                            setDistance(instDist).setTime(instTime);
+                    il.add(instr);
                 }
+                res.setInstructions(il);
             }
-            return new GHResponse().setPoints(list).setDistance(distance).setMillis(millis);
+            return res.setPoints(pointList).setDistance(distance).setMillis(time);
         } catch (Exception ex)
         {
-            throw new RuntimeException("Problem while fetching path " + request.getFrom() + "->" + request.getTo(), ex);
+            throw new RuntimeException("Problem while fetching path " + request.getPlaces(), ex);
         } finally
         {
             logger.debug("Full request took:" + sw.stop().getSeconds() + ", API took:" + took);
diff --git a/web/src/main/java/com/graphhopper/http/GuiceServletConfig.java b/web/src/main/java/com/graphhopper/http/GuiceServletConfig.java
index 5ab455f52f..af29f2604c 100644
--- a/web/src/main/java/com/graphhopper/http/GuiceServletConfig.java
+++ b/web/src/main/java/com/graphhopper/http/GuiceServletConfig.java
@@ -17,14 +17,14 @@
  */
 package com.graphhopper.http;
 
+import it.esalab.mapaal.http.MapaalGraphHopper;
+
 import com.google.inject.Guice;
 import com.google.inject.Injector;
 import com.google.inject.Module;
-import com.google.inject.Singleton;
 import com.google.inject.servlet.GuiceServletContextListener;
-import com.google.inject.servlet.ServletModule;
-import java.util.HashMap;
-import java.util.Map;
+import com.graphhopper.GraphHopper;
+import com.graphhopper.util.CmdArgs;
 
 /**
  * Replacement of web.xml
@@ -43,35 +43,17 @@ protected Injector getInjector()
 
     protected Module createDefaultModule()
     {
-        return new DefaultModule();
+        return new DefaultModule(new CmdArgs()){
+          @Override
+          protected GraphHopper create() {
+            // EXPLICIT CODE CHANGE!
+            return new MapaalGraphHopper();
+          }
+        };
     }
 
     protected Module createServletModule()
     {
-        return new ServletModule()
-        {
-            @Override
-            protected void configureServlets()
-            {
-                Map<String, String> params = new HashMap<String, String>();
-                params.put("mimeTypes", "text/html,"
-                        + "text/plain,"
-                        + "text/xml,"
-                        + "application/xhtml+xml,"
-                        + "text/css,"
-                        + "application/json,"
-                        + "application/javascript,"
-                        + "image/svg+xml");
-
-                // filter("/*").through(MyGZIPHook.class, params);
-                bind(MyGZIPHook.class).in(Singleton.class);
-
-                serve("/api/i18n*").with(I18NServlet.class);
-                bind(I18NServlet.class).in(Singleton.class);
-
-                serve("/api*").with(GraphHopperServlet.class);
-                bind(GraphHopperServlet.class).in(Singleton.class);
-            }
-        };
+        return new GHServletModule();
     }
 }
diff --git a/web/src/main/java/com/graphhopper/http/InvalidRequestServlet.java b/web/src/main/java/com/graphhopper/http/InvalidRequestServlet.java
new file mode 100644
index 0000000000..28829bb68e
--- /dev/null
+++ b/web/src/main/java/com/graphhopper/http/InvalidRequestServlet.java
@@ -0,0 +1,35 @@
+/*
+ * Copyright  2011. Team Lazer Beez (http://teamlazerbeez.com)
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.graphhopper.http;
+
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServlet;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.IOException;
+
+public class InvalidRequestServlet extends HttpServlet
+{
+
+    @Override
+    protected void service( HttpServletRequest req, HttpServletResponse resp ) throws ServletException, IOException
+    {
+        resp.setStatus(HttpServletResponse.SC_NOT_FOUND);
+        resp.setContentType("text/plain");
+        resp.setContentType("UTF-8");
+        resp.getWriter().append("404");
+    }
+}
diff --git a/web/src/main/java/com/graphhopper/http/JSONBuilder.java b/web/src/main/java/com/graphhopper/http/JSONBuilder.java
deleted file mode 100644
index 39bf080994..0000000000
--- a/web/src/main/java/com/graphhopper/http/JSONBuilder.java
+++ /dev/null
@@ -1,77 +0,0 @@
-/*
- *  Licensed to GraphHopper and Peter Karich under one or more contributor
- *  license agreements. See the NOTICE file distributed with this work for 
- *  additional information regarding copyright ownership.
- * 
- *  GraphHopper licenses this file to you under the Apache License, 
- *  Version 2.0 (the "License"); you may not use this file except in 
- *  compliance with the License. You may obtain a copy of the License at
- * 
- *       http://www.apache.org/licenses/LICENSE-2.0
- * 
- *  Unless required by applicable law or agreed to in writing, software
- *  distributed under the License is distributed on an "AS IS" BASIS,
- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- *  See the License for the specific language governing permissions and
- *  limitations under the License.
- */
-package com.graphhopper.http;
-
-import java.util.HashMap;
-import java.util.Map;
-import org.json.JSONObject;
-
-/**
- * @author Peter Karich
- */
-public class JSONBuilder
-{
-    private String lastObjectName;
-    private JSONBuilder parent;
-    private Map<String, Object> map;
-
-    public JSONBuilder()
-    {
-        map = new HashMap<String, Object>(5);
-    }
-
-    public JSONBuilder setParent( JSONBuilder p )
-    {
-        parent = p;
-        return this;
-    }
-
-    public JSONBuilder startObject( String entry )
-    {
-        lastObjectName = entry;
-        return new JSONBuilder().setParent(this);
-    }
-
-    public JSONBuilder endObject()
-    {
-        if (parent == null)
-        {
-            throw new IllegalStateException("object not opened?");
-        }
-
-        parent.map.put(parent.lastObjectName, map);
-        parent.lastObjectName = null;
-        return parent;
-    }
-
-    public JSONBuilder object( String key, Object val )
-    {
-        map.put(key, val);
-        return this;
-    }
-
-    public JSONObject build()
-    {
-        if (parent != null || lastObjectName != null)
-        {
-            throw new IllegalStateException("json with name " + lastObjectName + " not closed");
-        }
-
-        return new JSONObject(map);
-    }
-}
diff --git a/web/src/main/java/com/graphhopper/http/WebHelper.java b/web/src/main/java/com/graphhopper/http/WebHelper.java
index 60730a750b..3767f34904 100644
--- a/web/src/main/java/com/graphhopper/http/WebHelper.java
+++ b/web/src/main/java/com/graphhopper/http/WebHelper.java
@@ -40,11 +40,12 @@ public static String encodeURL( String str )
         }
     }
 
-    public static PointList decodePolyline( String encoded, int initCap )
+    public static PointList decodePolyline( String encoded, int initCap, boolean is3D )
     {
-        PointList poly = new PointList(initCap);
-        int index = 0, len = encoded.length();
-        int lat = 0, lng = 0;
+        PointList poly = new PointList(initCap, is3D);
+        int index = 0;
+        int len = encoded.length();
+        int lat = 0, lng = 0, ele = 0;
         while (index < len)
         {
             // latitude
@@ -69,7 +70,23 @@ public static PointList decodePolyline( String encoded, int initCap )
             } while (b >= 0x20);
             int deltaLongitude = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
             lng += deltaLongitude;
-            poly.add((double) lat / 1E5, (double) lng / 1E5);
+
+            if (is3D)
+            {
+                // elevation
+                shift = 0;
+                result = 0;
+                do
+                {
+                    b = encoded.charAt(index++) - 63;
+                    result |= (b & 0x1f) << shift;
+                    shift += 5;
+                } while (b >= 0x20);
+                int deltaElevation = ((result & 1) != 0 ? ~(result >> 1) : (result >> 1));
+                ele += deltaElevation;
+                poly.add((double) lat / 1e5, (double) lng / 1e5, (double) ele / 100);
+            } else
+                poly.add((double) lat / 1e5, (double) lng / 1e5);
         }
         return poly;
     }
@@ -81,6 +98,7 @@ public static String encodePolyline( PointList poly )
         int size = poly.getSize();
         int prevLat = 0;
         int prevLon = 0;
+        int prevEle = 0;
         for (int i = 0; i < size; i++)
         {
             int num = (int) Math.floor(poly.getLatitude(i) * 1e5);
@@ -89,6 +107,12 @@ public static String encodePolyline( PointList poly )
             num = (int) Math.floor(poly.getLongitude(i) * 1e5);
             encodeNumber(sb, num - prevLon);
             prevLon = num;
+            if (poly.is3D())
+            {
+                num = (int) Math.floor(poly.getElevation(i) * 100);
+                encodeNumber(sb, num - prevEle);
+                prevEle = num;
+            }
         }
         return sb.toString();
     }
diff --git a/web/src/main/resources/api-doc.md b/web/src/main/resources/api-doc.md
deleted file mode 100644
index 2f9356f606..0000000000
--- a/web/src/main/resources/api-doc.md
+++ /dev/null
@@ -1,130 +0,0 @@
-## Routing Web API Docs
-
-In order to communicate with your own hosted GraphHopper server you need to understand how. 
-
-If you intend to use the Web API without hosting GraphHopper on your own
-servers you can have a look into [our packages](http://graphhopper.com/#enterprise)!
-
-### A simple example
-[http://localhost:8989/api/route?point=45.752193%2C-0.686646&point=46.229253%2C-0.32959](http://localhost:8989/api/route?point=45.752193%2C-0.686646&point=46.229253%2C-0.32959)
-
-The end point of the local instance is [http://localhost:8989](http://localhost:8989)
-
-The URL path to obtain the route is `api/route`
-
-All official parameters are shown in the following table
-
-Parameter   | Default | Description
-:-----------|:--------|:-----------
-point       | -       |Specifiy multiple points for which the route should be calculated. The order is important. Currently only two point parameter are supported. At least two points have to be specified.
-locale      | en      | The locale of the result. E.g. pt_PT for Portuguese
-instructions| true  | If instruction should be calculated and returned
-vehicle     | car     | The vehicle for which the route should be calculated. Other vehicles are foot and bike
-weighting   | fastest | Which kind of 'best' route calculation you need. Other option is 'shortest', currently not available in the public service.
-algorithm   | dijkstrabi | The algorithm to calculate the route. Other options are dijkstra, astar and astarbi. For the public service only dijkstrabi is supported.
-encodedPolyline | true | If the resulting route should be 'compressed' using a special algorithm leading to massive bandwith reduction. You'll need a special handling on the client, if enabled. We provide Open Source code in Java and JavaScript.
-debug       | false   | If true, the output will be formated.
-calcPoints  | true    | If the points for the route should be calculated at all. Sometimes only the distance and time is necessary.
-type        | json    | Specifies the resulting format of the route, for json the content type will be application/json. Other possible format options: <br> jsonp you'll need to provide the callback function via the callback parameter. The content type will be application/javascript<br> gpx, the content type will be application/xml
-minPathPrecision | 1  | Not recommended to change. Increase this number if you want to further reduce bandwith.
-
-## Example output for the case type=json
-
-Keep in mind that attributes which are not documented here can be removed in the future - so you should not rely on them!
-
-```json
-{ "info": {
-    "routeFound": true,
-    "took": 0.002
-  },
-  "route": {
-    "bbox": [ 13.388849400, 52.4457314, 13.444651963, 52.5170358125 ],
-    "coordinates": "yhb_Imp`qAOwE@c@Ee@F_@@m@[CA^KdBqAhC_B`EoCfIk@`CQdAu....",
-    "distance": 10246.272216816824,
-    "time": 857191,
-    "instructions": {
-      "descriptions": [
-        "Continue onto Parchimer Allee",
-        "Turn slight right onto Fulhamer Allee",
-        "Turn right onto Britzer Damm",
-        "Continue onto Britzer Brcke",
-        ...
-        "Finish!"
-      ],
-      "distances": [
-        188.393,
-        628.815,
-        1058.67,
-        43.245,
-        ...
-        0
-      ],
-      "indications": [
-        0,
-        1,
-        2,
-        0,
-        ...
-        4
-      ],
-      "latLngs": [
-        [ 52.4457314546623, 13.44279753929394 ],
-        [ 52.445991764500555, 13.44398439177836 ],
-        [ 52.44897032042527, 13.436276393449523 ],
-        [ 52.45799502263952, 13.436300049043448 ],
-        ...
-        [ 52.517035812555115,13.388849400593703 ]
-      ],
-      "millis": [
-        26100,
-        78113,
-        84689,
-        3459,
-        ...
-        0
-      ]
-    }
-  }
-}
-```
-
-The JSON result contains the following structure:
-
-JSON path/attribute | Description
-:-------------------|:------------
-info.took           | How many ms the request took on the server, without latency taken into account.
-info.routeFound     | Is true if route was found, false otherwise
-route.bbox          | The bounding box of the route, format: <br> minLon, minLat, maxLon, maxLat
-route.coordinates   | The polyline encoded coordinates of the route. Order is lat,lon as it is no geoJson! Not provided if encodedPolyline=false, which is not yet formalized to be documented.
-route.distance      | The overall distance of the route, in meter
-route.time          | The overall time of the route, in ms
-route.instructions  | Contains information about the instructions for this route. The last instruction is always the Finish instruction and takes 0ms and 0meter. Keep in mind that instructions are currently under active development and can sometimes contain misleading information, so, make sure you always show an image of the map at the same time when navigating your users!
-route.instructions.descriptions | A description what the user has to do in order to follow the route. The language depends on the locale parameter.
-route.instructions.distances    | The array of distances of validity for every instruction, in meter
-route.instructions.millis       | The array of durations of validity for every instruction, in ms
-route.instructions.latLngs      | The array of the first point where an instruction should be presented to the user
-route.instructions.indications  | The array of indication numbers for every instruction. If you want to display signs for right turn etc you need these numbers. <br>TURN_SHARP_LEFT = -3<br>TURN_LEFT = -2<br>TURN_SLIGHT_LEFT = -1<br>CONTINUE_ON_STREET = 0<br>TURN_SLIGHT_RIGHT = 1<br>TURN_RIGHT = 2<br>TURN_SHARP_RIGHT = 3
-
-
-## Area information
-
-If you need to find out defails about the area or need to ping the service use 'api/info'
-
-[http://localhost:8989/api/info](http://localhost:8989/api/info)
-
-### Example output:
-```json
-{ "buildDate":"2014-02-21T16:52",
-  "bbox":[13.0726237909337,52.33350773901,13.7639719344073,52.679616459003],
-  "version":"0.3",
-  "supportedVehicles":"foot"
-}
-```
-
-JSON path/attribute | Description
-:-------------------|:------------
-buildDate           | The GraphHopper build date
-version             | The GraphHopper version
-supportedVehicle    | A comma separated list of supported vehicles
-bbox                | The maximum bounding box of the area, format: <br> minLon, minLat, maxLon, maxLat
-
diff --git a/web/src/main/webapp/WEB-INF/web.xml b/web/src/main/webapp/WEB-INF/web.xml
index 0a0c9aa7e5..ccec31545e 100644
--- a/web/src/main/webapp/WEB-INF/web.xml
+++ b/web/src/main/webapp/WEB-INF/web.xml
@@ -10,7 +10,7 @@
         <url-pattern>/*</url-pattern>
     </filter-mapping>    
     <listener>
-        <listener-class>it.esalab.mapaal.http.config.MapaalServletConfig</listener-class>
+        <listener-class>com.graphhopper.http.GuiceServletConfig</listener-class>        
     </listener>
     <session-config>
         <session-timeout>1</session-timeout>
diff --git a/web/src/main/webapp/css/Leaflet.Elevation-0.0.2.css b/web/src/main/webapp/css/Leaflet.Elevation-0.0.2.css
new file mode 100644
index 0000000000..fe4fc2a013
--- /dev/null
+++ b/web/src/main/webapp/css/Leaflet.Elevation-0.0.2.css
@@ -0,0 +1,11 @@
+.lime-theme .leaflet-control.elevation .background{background-color:rgba(156,194,34,.2);-webkit-border-radius:5px;-moz-border-radius:5px;-ms-border-radius:5px;-o-border-radius:5px;border-radius:5px}.lime-theme .leaflet-control.elevation .axis line,.lime-theme .leaflet-control.elevation .axis path{fill:none;stroke:#566b13;stroke-width:2}
+.lime-theme .leaflet-control.elevation .area{fill:#9cc222}.lime-theme .leaflet-control.elevation .mouse-focus-line{pointer-events:none;stroke-width:1;stroke:#101404}.lime-theme .leaflet-control.elevation .elevation-toggle{cursor:pointer;box-shadow:0 1px 7px rgba(0,0,0,.4);-webkit-border-radius:5px;border-radius:5px;width:36px;height:36px;background:url(images/elevation.png) no-repeat center center #f8f8f9}.lime-theme .leaflet-control.elevation-collapsed .background{display:none}.lime-theme .leaflet-control.elevation-collapsed .elevation-toggle{display:block}
+.lime-theme .leaflet-control.elevation .mouse-drag{fill:rgba(99,126,11,.4)}.lime-theme .leaflet-overlay-pane .height-focus{stroke:#9cc222;fill:#9cc222}.lime-theme .leaflet-overlay-pane .height-focus.line{pointer-events:none;stroke-width:2}.steelblue-theme .leaflet-control.elevation .background{background-color:rgba(70,130,180,.2);-webkit-border-radius:5px;-moz-border-radius:5px;-ms-border-radius:5px;-o-border-radius:5px;border-radius:5px}.steelblue-theme .leaflet-control.elevation .axis line,.steelblue-theme .leaflet-control.elevation .axis path{fill:none;stroke:#0d1821;stroke-width:2}.steelblue-theme .leaflet-control.elevation .area{fill:#4682b4}.steelblue-theme .leaflet-control.elevation .mouse-focus-line{pointer-events:none;stroke-width:1;stroke:#0d1821}.steelblue-theme .leaflet-control.elevation .elevation-toggle{cursor:pointer;box-shadow:0 1px 7px rgba(0,0,0,.4);-webkit-border-radius:5px;border-radius:5px;width:36px;height:36px;background:url(images/elevation.png) no-repeat center center #f8f8f9}.steelblue-theme .leaflet-control.elevation-collapsed .background{display:none}.steelblue-theme .leaflet-control.elevation-collapsed .elevation-toggle{display:block}.steelblue-theme .leaflet-control.elevation .mouse-drag{fill:rgba(23,74,117,.4)}.steelblue-theme .leaflet-overlay-pane .height-focus{stroke:#4682b4;fill:#4682b4}.steelblue-theme .leaflet-overlay-pane .height-focus.line{pointer-events:none;stroke-width:2}.purple-theme .leaflet-control.elevation .background{background-color:rgba(115,44,123,.2);-webkit-border-radius:5px;-moz-border-radius:5px;-ms-border-radius:5px;-o-border-radius:5px;border-radius:5px}.purple-theme .leaflet-control.elevation .axis line,.purple-theme .leaflet-control.elevation .axis path{fill:none;stroke:#2d1130;stroke-width:2}.purple-theme .leaflet-control.elevation .area{fill:#732c7b}.purple-theme .leaflet-control.elevation .mouse-focus-line{pointer-events:none;stroke-width:1;stroke:#000}.purple-theme .leaflet-control.elevation .elevation-toggle{cursor:pointer;box-shadow:0 1px 7px rgba(0,0,0,.4);-webkit-border-radius:5px;border-radius:5px;width:36px;height:36px;background:url(images/elevation.png) no-repeat center center #f8f8f9}.purple-theme .leaflet-control.elevation-collapsed .background{display:none}.purple-theme .leaflet-control.elevation-collapsed .elevation-toggle{display:block}.purple-theme .leaflet-control.elevation .mouse-drag{fill:rgba(74,14,80,.4)}.purple-theme .leaflet-overlay-pane .height-focus{stroke:#732c7b;fill:#732c7b}.purple-theme .leaflet-overlay-pane .height-focus.line{pointer-events:none;stroke-width:2}
+
+.white-theme .leaflet-control.elevation .background{background-color:rgba(250,250,250,.6);-webkit-border-radius:5px;-moz-border-radius:5px;-ms-border-radius:5px;-o-border-radius:5px;border-radius:5px}.white-theme .leaflet-control.elevation .axis path,.white-theme .leaflet-control.elevation .axis line{fill:none;stroke:#0d1821;stroke-width:2}
+.white-theme .leaflet-control.elevation .area{fill:#00cc33; opacity: 0.8}.white-theme .leaflet-control.elevation .mouse-focus-line{pointer-events:none;stroke-width:1;stroke:#0d1821}.white-theme .leaflet-control.elevation .elevation-toggle{cursor:pointer;box-shadow:0 1px 7px rgba(0,0,0,.4);-webkit-border-radius:5px;border-radius:5px;width:36px;height:36px;background:url(images/elevation.png) no-repeat center center #f8f8f9}.white-theme .leaflet-control.elevation-collapsed .background{display:none}.white-theme .leaflet-control.elevation-collapsed .elevation-toggle{display:block}.white-theme .leaflet-overlay-pane .height-focus{stroke:#4682b4;fill:#4682b4}.white-theme .leaflet-overlay-pane .height-focus.line{pointer-events:none;stroke-width:2}
+.white-theme .leaflet-control.elevation .mouse-drag{fill:#00cc33; opacity: 0.2}
+.white-theme .leaflet-control.elevation .axis text{ x: -10; }
+.text {
+    color:#00cc33
+}
\ No newline at end of file
diff --git a/web/src/main/webapp/css/images/elevation.png b/web/src/main/webapp/css/images/elevation.png
new file mode 100644
index 0000000000..68fb537e42
Binary files /dev/null and b/web/src/main/webapp/css/images/elevation.png differ
diff --git a/web/src/main/webapp/css/leaflet.css b/web/src/main/webapp/css/leaflet.css
index 7e77da3460..1232550253 100644
--- a/web/src/main/webapp/css/leaflet.css
+++ b/web/src/main/webapp/css/leaflet.css
@@ -65,6 +65,16 @@
 .leaflet-marker-pane  { z-index: 6; }
 .leaflet-popup-pane   { z-index: 7; }
 
+.leaflet-vml-shape {
+	width: 1px;
+	height: 1px;
+	}
+.lvml {
+	behavior: url(#default#VML);
+	display: inline-block;
+	position: absolute;
+	}
+
 
 /* control positioning */
 
@@ -160,9 +170,8 @@
 .leaflet-control {
 	cursor: auto;
 	}
-.leaflet-dragging,
-.leaflet-dragging .leaflet-clickable,
-.leaflet-dragging .leaflet-container {
+.leaflet-dragging .leaflet-container,
+.leaflet-dragging .leaflet-clickable {
 	cursor: move;
 	cursor: -webkit-grabbing;
 	cursor:    -moz-grabbing;
@@ -182,9 +191,8 @@
 	outline: 2px solid orange;
 	}
 .leaflet-zoom-box {
-	border: 2px dotted #05f;
-	background: white;
-	opacity: 0.5;
+	border: 2px dotted #38f;
+	background: rgba(255,255,255,0.5);
 	}
 
 
@@ -197,11 +205,11 @@
 /* general toolbar styles */
 
 .leaflet-bar {
-	box-shadow: 0 1px 7px rgba(0,0,0,0.65);
-	-webkit-border-radius: 4px;
-	        border-radius: 4px;
+	box-shadow: 0 1px 5px rgba(0,0,0,0.65);
+	border-radius: 4px;
 	}
-.leaflet-bar a, .leaflet-bar a:hover {
+.leaflet-bar a,
+.leaflet-bar a:hover {
 	background-color: #fff;
 	border-bottom: 1px solid #ccc;
 	width: 26px;
@@ -222,16 +230,12 @@
 	background-color: #f4f4f4;
 	}
 .leaflet-bar a:first-child {
-	-webkit-border-top-left-radius: 4px;
-	        border-top-left-radius: 4px;
-	-webkit-border-top-right-radius: 4px;
-	        border-top-right-radius: 4px;
+	border-top-left-radius: 4px;
+	border-top-right-radius: 4px;
 	}
 .leaflet-bar a:last-child {
-	-webkit-border-bottom-left-radius: 4px;
-	        border-bottom-left-radius: 4px;
-	-webkit-border-bottom-right-radius: 4px;
-	        border-bottom-right-radius: 4px;
+	border-bottom-left-radius: 4px;
+	border-bottom-right-radius: 4px;
 	border-bottom: none;
 	}
 .leaflet-bar a.leaflet-disabled {
@@ -240,55 +244,38 @@
 	color: #bbb;
 	}
 
-.leaflet-touch .leaflet-bar {
-	-webkit-border-radius: 10px;
-	        border-radius: 10px;
-	}
 .leaflet-touch .leaflet-bar a {
 	width: 30px;
 	height: 30px;
-	}
-.leaflet-touch .leaflet-bar a:first-child {
-	-webkit-border-top-left-radius: 7px;
-	        border-top-left-radius: 7px;
-	-webkit-border-top-right-radius: 7px;
-	        border-top-right-radius: 7px;
-	}
-.leaflet-touch .leaflet-bar a:last-child {
-	-webkit-border-bottom-left-radius: 7px;
-	        border-bottom-left-radius: 7px;
-	-webkit-border-bottom-right-radius: 7px;
-	        border-bottom-right-radius: 7px;
-	border-bottom: none;
+	line-height: 30px;
 	}
 
 
 /* zoom control */
 
-.leaflet-control-zoom-in {
+.leaflet-control-zoom-in,
+.leaflet-control-zoom-out {
 	font: bold 18px 'Lucida Console', Monaco, monospace;
+	text-indent: 1px;
 	}
 .leaflet-control-zoom-out {
-	font: bold 22px 'Lucida Console', Monaco, monospace;
+	font-size: 20px;
 	}
 
 .leaflet-touch .leaflet-control-zoom-in {
 	font-size: 22px;
-	line-height: 30px;
 	}
 .leaflet-touch .leaflet-control-zoom-out {
-	font-size: 28px;
-	line-height: 30px;
+	font-size: 24px;
 	}
 
 
 /* layers control */
 
 .leaflet-control-layers {
-	box-shadow: 0 1px 7px rgba(0,0,0,0.4);
-	background: #f8f8f9;
-	-webkit-border-radius: 5px;
-	        border-radius: 5px;
+	box-shadow: 0 1px 5px rgba(0,0,0,0.4);
+	background: #fff;
+	border-radius: 5px;
 	}
 .leaflet-control-layers-toggle {
 	background-image: url(images/layers.png);
@@ -334,8 +321,8 @@
 /* attribution and scale controls */
 
 .leaflet-container .leaflet-control-attribution {
-	background-color: rgba(255, 255, 255, 0.7);
-	box-shadow: 0 0 5px #bbb;
+	background: #fff;
+	background: rgba(255, 255, 255, 0.7);
 	margin: 0;
 	}
 .leaflet-control-attribution,
@@ -343,6 +330,12 @@
 	padding: 0 5px;
 	color: #333;
 	}
+.leaflet-control-attribution a {
+	text-decoration: none;
+	}
+.leaflet-control-attribution a:hover {
+	text-decoration: underline;
+	}
 .leaflet-container .leaflet-control-attribution,
 .leaflet-container .leaflet-control-scale {
 	font-size: 11px;
@@ -356,21 +349,21 @@
 .leaflet-control-scale-line {
 	border: 2px solid #777;
 	border-top: none;
-	color: black;
 	line-height: 1.1;
 	padding: 2px 5px 1px;
 	font-size: 11px;
-	text-shadow: 1px 1px 1px #fff;
-	background-color: rgba(255, 255, 255, 0.5);
-	box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.2);
 	white-space: nowrap;
 	overflow: hidden;
+	-moz-box-sizing: content-box;
+	     box-sizing: content-box;
+
+	background: #fff;
+	background: rgba(255, 255, 255, 0.5);
 	}
 .leaflet-control-scale-line:not(:first-child) {
 	border-top: 2px solid #777;
 	border-bottom: none;
 	margin-top: -2px;
-	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
 	}
 .leaflet-control-scale-line:not(:first-child):not(:last-child) {
 	border-bottom: 2px solid #777;
@@ -383,7 +376,8 @@
 	}
 .leaflet-touch .leaflet-control-layers,
 .leaflet-touch .leaflet-bar {
-	border: 4px solid rgba(0,0,0,0.3);
+	border: 2px solid rgba(0,0,0,0.2);
+	background-clip: padding-box;
 	}
 
 
@@ -396,8 +390,7 @@
 .leaflet-popup-content-wrapper {
 	padding: 1px;
 	text-align: left;
-	-webkit-border-radius: 12px;
-	        border-radius: 12px;
+	border-radius: 12px;
 	}
 .leaflet-popup-content {
 	margin: 13px 19px;
@@ -426,7 +419,8 @@
 	     -o-transform: rotate(45deg);
 	        transform: rotate(45deg);
 	}
-.leaflet-popup-content-wrapper, .leaflet-popup-tip {
+.leaflet-popup-content-wrapper,
+.leaflet-popup-tip {
 	background: white;
 
 	box-shadow: 0 3px 14px rgba(0,0,0,0.4);
@@ -454,6 +448,27 @@
 	border-top: 1px solid #ddd;
 	}
 
+.leaflet-oldie .leaflet-popup-content-wrapper {
+	zoom: 1;
+	}
+.leaflet-oldie .leaflet-popup-tip {
+	width: 24px;
+	margin: 0 auto;
+
+	-ms-filter: "progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678)";
+	filter: progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678);
+	}
+.leaflet-oldie .leaflet-popup-tip-container {
+	margin-top: -1px;
+	}
+
+.leaflet-oldie .leaflet-control-zoom,
+.leaflet-oldie .leaflet-control-layers,
+.leaflet-oldie .leaflet-popup-content-wrapper,
+.leaflet-oldie .leaflet-popup-tip {
+	border: 1px solid #999;
+	}
+
 
 /* div icon */
 
@@ -461,7 +476,3 @@
 	background: #fff;
 	border: 1px solid #666;
 	}
-.leaflet-editing-icon {
-	-webkit-border-radius: 2px;
-	        border-radius: 2px;
-	}
diff --git a/web/src/main/webapp/css/leaflet.ie.css b/web/src/main/webapp/css/leaflet.ie.css
deleted file mode 100644
index f3daf1f3c0..0000000000
--- a/web/src/main/webapp/css/leaflet.ie.css
+++ /dev/null
@@ -1,51 +0,0 @@
-.leaflet-vml-shape {
-	width: 1px;
-	height: 1px;
-	}
-.lvml {
-	behavior: url(#default#VML);
-	display: inline-block;
-	position: absolute;
-	}
-
-.leaflet-control {
-	display: inline;
-	}
-
-.leaflet-popup-tip {
-	width: 21px;
-	_width: 27px;
-	margin: 0 auto;
-	_margin-top: -3px;
-
-	filter: progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678);
-	-ms-filter: "progid:DXImageTransform.Microsoft.Matrix(M11=0.70710678, M12=0.70710678, M21=-0.70710678, M22=0.70710678)";
-	}
-.leaflet-popup-tip-container {
-	margin-top: -1px;
-	}
-.leaflet-popup-content-wrapper, .leaflet-popup-tip {
-	border: 1px solid #999;
-	}
-.leaflet-popup-content-wrapper {
-	zoom: 1;
-	}
-
-.leaflet-control-zoom,
-.leaflet-control-layers {
-	border: 3px solid #999;
-	}
-.leaflet-control-layers-toggle {
-	}
-.leaflet-control-attribution,
-.leaflet-control-layers,
-.leaflet-control-scale-line {
-	background: white;
-	}
-.leaflet-zoom-box {
-	filter: alpha(opacity=50);
-	}
-.leaflet-control-attribution {
-	border-top: 1px solid #bbb;
-	border-left: 1px solid #bbb;
-	}
diff --git a/web/src/main/webapp/css/style.css b/web/src/main/webapp/css/style.css
index 9449ce7c01..8206c3b57e 100644
--- a/web/src/main/webapp/css/style.css
+++ b/web/src/main/webapp/css/style.css
@@ -1,17 +1,17 @@
 body {                
     color: #000;
     font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;    
-    line-height: 1.4;    
+    line-height: 1.4;
     color: #111111;
-    background-color: #EEEEEE;
+    background-color: white;
     margin: 0;
+    min-width: 600px;
 }
-#map {
-    /*    float: right;*/
-    width: 800px;
-    height: 600px;
+#map {    
+    /* set size via JS */
     cursor: default;
 }
+
 #input {
     float: left;                
     padding-left: 10px; 
@@ -19,6 +19,7 @@ body {
 }
 
 #info {
+    margin-top: 10px;
     border: lightgray groove thin;
     display: none;
     padding: 5px;
@@ -28,11 +29,11 @@ body {
     padding-right: 5px;
 }
 #input, #instructions {
-    width: 255px;
+    width: 280px;
 }
 #fromInput, #toInput {
-    width: 225px;
-    float: right;    
+    width: 250px;
+    float: right;
 }
 
 #fromResolveFound a, #toResolveFound a {
@@ -76,15 +77,20 @@ body {
     padding-top: 20px;
     color: #666666                    
 }
+#locationpoints {
+    padding-bottom: 10px;
+}
 #fromDiv img, #toDiv img {
-    margin-top: 4px;
-    padding-right: 3px;                
+    margin-top: 6px;
+    padding-left: 3px;
+    padding-right: 3px;
     float: left;
 }
 .left {
     float: left;
 }
 #routeDetails {
+    padding: 20px;
     font-size: 12px;
 }
 .hidden {
@@ -109,10 +115,11 @@ body {
 }
 #header_img {
     padding-top: 15px;
+    padding-left: 20px;
     padding-bottom: 15px;
 }
 #header_img img {
-    width: 200px;
+    width: 230px;
 }
 #gpxExportButton {
     margin-top: -3px;
@@ -128,40 +135,52 @@ body {
     clear: both;
 }
 #hosting {
-    padding-top: 10px;
-    color: gray;                
+    display: none;
+    /*    float: left;*/
+    padding-top: 4px;
+    padding-bottom: 10px;
+    /* color: #666666; */
+    font-size: smaller;
+    opacity: 0.8;
 }
 #hosting a {
-    color: gray;                
+    text-decoration: none;
+    color: #00cc33;
 }
-
-.instruction {    
-    padding-top: 5px;
-    padding-bottom: 5px;
+#exportLink {
+    float: left;
 }
-tr.instruction td {
-    border-bottom: beige groove thin;
+
+tr.instruction {
+    cursor: pointer;
+    border-bottom: #dadada dashed thin;
 }
 #instructions {
+    table-layout:fixed;
     border-collapse: collapse;
     padding-top: 10px;
     width: 100%;
     font-size: smaller;
 }
+
 #instructions th, #instructions td {
-    padding: 3px;
+    padding: 6px 3px;
 }
-.instr_title {    
-}
-.instr_distance_td {
-    min-width: 40px;
+
+td.instr_title {
+    width: 130px;
 }
-.instr_distance {
+td.instr_distance {
+    min-width: 50px;
     float: right;    
     color: gray;
     text-align: right;
 }
-.instr_pic {    
+
+#instructions tr .instr_pic {
+    width: 20px;
+}
+td img.pic {    
     max-height: 24px;
     max-width: 16px;
 }
@@ -189,13 +208,36 @@ tr.instruction td {
 }
 
 .complete-1, .complete-2 { border: 1px solid #999; background: #FFF; overflow: auto; }
-.complete-1 strong, .complete-2 strong { font-weight: normal; /*color: #3399FF;*/; color: #04B431; }
-.autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; font-size: 12px; }
-.autocomplete-selected { background: #e7e7e7; }
+.complete-1 strong, .complete-2 strong { font-weight: normal; color: #04B431; }
+.autocomplete-suggestion { 
+    padding: 5px 5px; 
+    white-space: nowrap; 
+    overflow: hidden;
+    font-size: small;
+    background-image: linear-gradient(to bottom, white, #e7e7e7);
+}
+.autocomplete-selected { 
+    padding: 5px 5px; background: #e7e7e7; 
+    background-image: linear-gradient(to bottom, #9f9f9f, #e7e7e7);
+}
 .light { font-weight: lighter; color: #9f9f9f; font-size: smaller }
 .wikilink { float: right; }
 .wikilink img { max-width: 16px; }
 
-.roadseg {}
-.cityseg {}
-.moreseg { font-size: 9px; }
\ No newline at end of file
+.nameseg { /*border-top: #dadada dashed thin;*/ }
+.cityseg { float: left; font-size: 10px; }
+.moreseg { float: right; font-size: 9px; }
+
+#expandDetails {
+    color: gray;
+    font-size:14px; 
+    float: right;
+    font-weight: bold;    
+
+    width: 20px;
+    height: 20px;    
+    background-image: linear-gradient(to bottom, white, #e7e7e7);
+}
+#moreButton {
+    background-image: linear-gradient(to bottom, white, #e7e7e7);
+}
\ No newline at end of file
diff --git a/web/src/main/webapp/img/bike2.png b/web/src/main/webapp/img/bike2.png
new file mode 100644
index 0000000000..2bc450e6c1
Binary files /dev/null and b/web/src/main/webapp/img/bike2.png differ
diff --git a/web/src/main/webapp/img/header.png b/web/src/main/webapp/img/header.png
new file mode 100644
index 0000000000..e89b782da1
Binary files /dev/null and b/web/src/main/webapp/img/header.png differ
diff --git a/web/src/main/webapp/img/icon.png b/web/src/main/webapp/img/icon.png
index 3c36288213..2101141930 100644
Binary files a/web/src/main/webapp/img/icon.png and b/web/src/main/webapp/img/icon.png differ
diff --git a/web/src/main/webapp/index.html b/web/src/main/webapp/index.html
index 4f08340c5f..d4e81eaa1d 100644
--- a/web/src/main/webapp/index.html
+++ b/web/src/main/webapp/index.html
@@ -8,24 +8,29 @@
         <link rel="search" type="application/opensearchdescription+xml" title="GraphHopper Maps" href="opensearch.xml"/>
         <title>Driving Directions - GraphHopper Maps</title>
 
-        <link rel="stylesheet" href="css/leaflet.css" />
-        <!--[if lte IE 8]>
-            <link rel="stylesheet" href="css/leaflet.ie.css" />
-        <![endif]-->
-        <script type="text/javascript" src="js/leaflet.js?v=0.6.4"></script>
-        <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
+        <link rel="stylesheet" href="css/leaflet.css" />        
+        <script type="text/javascript" src="js/leaflet.js?v=0.7.2"></script>
+        <link rel="stylesheet" href="css/Leaflet.Elevation-0.0.2.css" />
+        <script type="text/javascript" src="js/d3.min.js"></script>
+        <script type="text/javascript" src="js/Leaflet.Elevation-0.0.2.min.js"></script>        
+
+        <script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>        
+        <!--
+        <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.0.min.js"></script>        
+        -->
         <script type="text/javascript" src="js/jquery.history.js"></script>
         <!--        <script type="text/javascript" src="js/jquery.autocomplete.min.js"></script>-->
         <script type="text/javascript" src="js/jquery.autocomplete.js"></script>
-        <script type="text/javascript" src="js/ghrequest.js?v=3"></script>
-        <script type="text/javascript" src="js/main.js?v=14"></script>
+        <script type="text/javascript" src="js/ghrequest.js"></script>
+        <script type="text/javascript" src="js/main.js"></script>         
         <link rel="stylesheet" type="text/css" href="css/style.css" />
     </head>
     <body>
         <div id="input">
+            <div id="input_header">
             <div id="header_img">
                 <a class="no_link" href="http://graphhopper.com">
-                    <img alt="GraphHopper" src="http://graphhopper.com/img/header.png"/>                    
+                    <img alt="GraphHopper" src="./img/header.png"/>                    
                 </a>
             </div>
             <div id="options">
@@ -53,17 +58,19 @@
                         <div id="toResolveError"></div>
                     </div>
                 </div>
-                <div class="clear"> </div>
-                <div id="exportLink" title="Static Link" class="left"><a href="/maps"><img src='img/link.png'></a></div>
-                <input id="searchButton" type="submit" value="Search">
+                <div class="clear"> </div>                
+                <input id="searchButton" type="submit" value="Search">                
             </form>      
+            <div id="exportLink" title="Static Link" class="left"><a href="/maps"><img src='img/link.png'></a></div>
             <div id="gpxExportButton" title="GPX Download"><a href=""><img alt="gpx" src='img/gpx.png'></a></div>
+            <div id="hosting">Powered by <a href='http://graphhopper.com/#enterprise'>GraphHopper API</a></div>            
+            </div>
             <div class="clear"> </div>
             <div id="info" class="small_text">
             </div>
             <div id="error" class="error">
             </div>
-        </div>
+        </div>        
 
         <div id="map">
         </div>
diff --git a/web/src/main/webapp/js/Leaflet.Elevation-0.0.2.min.js b/web/src/main/webapp/js/Leaflet.Elevation-0.0.2.min.js
new file mode 100644
index 0000000000..198bd29237
--- /dev/null
+++ b/web/src/main/webapp/js/Leaflet.Elevation-0.0.2.min.js
@@ -0,0 +1,2 @@
+/*! Leaflet.Elevation 05-03-2014 */
+L.Control.Elevation=L.Control.extend({options:{position:"topright",theme:"lime-theme",width:600,height:175,margins:{top:10,right:20,bottom:30,left:60},useHeightIndicator:!0,interpolation:"linear",hoverNumber:{decimalsX:3,decimalsY:0,formatter:void 0},xTicks:void 0,yTicks:void 0,collapsed:!1,yAxisMin:void 0,yAxisMax:void 0,forceAxisBounds:!1},onRemove:function(){this._container=null},onAdd:function(a){this._map=a;var b=this.options,c=b.margins;b.xTicks=b.xTicks||Math.round(this._width()/75),b.yTicks=b.yTicks||Math.round(this._height()/30),b.hoverNumber.formatter=b.hoverNumber.formatter||this._formatter,d3.select("body").classed(b.theme,!0);var d=this._x=d3.scale.linear().range([0,this._width()]),e=this._y=d3.scale.linear().range([this._height(),0]),f=(this._area=d3.svg.area().interpolate(b.interpolation).x(function(a){return d(a.dist)}).y0(this._height()).y1(function(a){return e(a.altitude)}),this._container=L.DomUtil.create("div","elevation"));this._initToggle();var g=d3.select(f);g.attr("width",b.width);var h=g.append("svg");h.attr("width",b.width).attr("class","background").attr("height",b.height).append("g").attr("transform","translate("+c.left+","+c.top+")");var i=d3.svg.line();i=i.x(function(){return d3.mouse(h.select("g"))[0]}).y(function(){return this._height()});var j=d3.select(this._container).select("svg").select("g");this._areapath=j.append("path").attr("class","area");var k=this._background=j.append("rect").attr("width",this._width()).attr("height",this._height()).style("fill","none").style("stroke","none").style("pointer-events","all");L.Browser.touch?(k.on("touchmove.drag",this._dragHandler.bind(this)).on("touchstart.drag",this._dragStartHandler.bind(this)).on("touchstart.focus",this._mousemoveHandler.bind(this)),L.DomEvent.on(this._container,"touchend",this._dragEndHandler,this)):(k.on("mousemove.focus",this._mousemoveHandler.bind(this)).on("mouseout.focus",this._mouseoutHandler.bind(this)).on("mousedown.drag",this._dragStartHandler.bind(this)).on("mousemove.drag",this._dragHandler.bind(this)),L.DomEvent.on(this._container,"mouseup",this._dragEndHandler,this)),this._xaxisgraphicnode=j.append("g"),this._yaxisgraphicnode=j.append("g"),this._appendXaxis(this._xaxisgraphicnode),this._appendYaxis(this._yaxisgraphicnode);var l=this._focusG=j.append("g");return this._mousefocus=l.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0"),this._focuslabelX=l.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-x"),this._focuslabelY=l.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-y"),this._data&&this._applyData(),f},_dragHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!0,this._drawDragRectangle()},_drawDragRectangle:function(){if(this._dragStartCoords){var a=this._dragCurrentCoords=d3.mouse(this._background.node()),b=Math.min(this._dragStartCoords[0],a[0]),c=Math.max(this._dragStartCoords[0],a[0]);if(this._dragRectangle||this._dragRectangleG)this._dragRectangle.attr("width",c-b).attr("x",b);else{var d=d3.select(this._container).select("svg").select("g");this._dragRectangleG=d.append("g"),this._dragRectangle=this._dragRectangleG.append("rect").attr("width",c-b).attr("height",this._height()).attr("x",b).attr("class","mouse-drag").style("pointer-events","none")}}},_resetDrag:function(){this._dragRectangleG&&(this._dragRectangleG.remove(),this._dragRectangleG=null,this._dragRectangle=null,this._hidePositionMarker(),this._map.fitBounds(this._fullExtent))},_dragEndHandler:function(){if(!this._dragStartCoords||!this._gotDragged)return this._dragStartCoords=null,this._gotDragged=!1,void this._resetDrag();this._hidePositionMarker();var a=this._findItemForX(this._dragStartCoords[0]),b=this._findItemForX(this._dragCurrentCoords[0]);this._fitSection(a,b),this._dragStartCoords=null,this._gotDragged=!1},_dragStartHandler:function(){d3.event.preventDefault(),d3.event.stopPropagation(),this._gotDragged=!1,this._dragStartCoords=d3.mouse(this._background.node())},_findItemForX:function(a){var b=d3.bisector(function(a){return a.dist}).left,c=this._x.invert(a);return b(this._data,c)},_fitSection:function(a,b){var c=Math.min(a,b),d=Math.max(a,b),e=this._calculateFullExtent(this._data.slice(c,d));this._map.fitBounds(e)},_initToggle:function(){var a=this._container;if(a.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(a),this.options.collapsed){this._collapse(),L.Browser.android||L.DomEvent.on(a,"mouseover",this._expand,this).on(a,"mouseout",this._collapse,this);var b=this._button=L.DomUtil.create("a","elevation-toggle",a);b.href="#",b.title="Elevation",L.Browser.touch?L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",this._expand,this):L.DomEvent.on(b,"focus",this._expand,this),this._map.on("click",this._collapse,this)}},_expand:function(){this._container.className=this._container.className.replace(" elevation-collapsed","")},_collapse:function(){L.DomUtil.addClass(this._container,"elevation-collapsed")},_width:function(){var a=this.options;return a.width-a.margins.left-a.margins.right},_height:function(){var a=this.options;return a.height-a.margins.top-a.margins.bottom},_formatter:function(a,b,c){var d;d=0===b?Math.round(a)+"":L.Util.formatNum(a,b)+"";var e=d.split(".");if(e[1]){for(var f=b-e[1].length;f>0;f--)e[1]+="0";d=e.join(c||".")}return d},_appendYaxis:function(a){a.attr("class","y axis").call(d3.svg.axis().scale(this._y).ticks(this.options.yTicks).orient("left")).append("text").attr("x",-36).attr("y",3).style("text-anchor","end").text("m")},_appendXaxis:function(a){a.attr("class","x axis").attr("transform","translate(0,"+this._height()+")").call(d3.svg.axis().scale(this._x).ticks(this.options.xTicks).orient("bottom")).append("text").attr("x",this._width()+20).attr("y",15).style("text-anchor","end").text("km")},_updateAxis:function(){this._xaxisgraphicnode.selectAll("g").remove(),this._xaxisgraphicnode.selectAll("path").remove(),this._xaxisgraphicnode.selectAll("text").remove(),this._yaxisgraphicnode.selectAll("g").remove(),this._yaxisgraphicnode.selectAll("path").remove(),this._yaxisgraphicnode.selectAll("text").remove(),this._appendXaxis(this._xaxisgraphicnode),this._appendYaxis(this._yaxisgraphicnode)},_mouseoutHandler:function(){this._hidePositionMarker()},_hidePositionMarker:function(){this._marker&&(this._map.removeLayer(this._marker),this._marker=null),this._mouseHeightFocus&&(this._mouseHeightFocus.style("visibility","hidden"),this._mouseHeightFocusLabel.style("visibility","hidden")),this._pointG&&this._pointG.style("visibility","hidden"),this._focusG.style("visibility","hidden")},_mousemoveHandler:function(){if(this._data&&0!==this._data.length){var a=d3.mouse(this._background.node()),b=this.options;this._focusG.style("visibility","visible"),this._mousefocus.attr("x1",a[0]).attr("y1",0).attr("x2",a[0]).attr("y2",this._height()).classed("hidden",!1);var c=(d3.bisector(function(a){return a.dist}).left,this._data[this._findItemForX(a[0])]),d=c.altitude,e=c.dist,f=c.latlng,g=b.hoverNumber.formatter(d,b.hoverNumber.decimalsY),h=b.hoverNumber.formatter(e,b.hoverNumber.decimalsX);this._focuslabelX.attr("x",a[0]).text(g+" m"),this._focuslabelY.attr("y",this._height()-5).attr("x",a[0]).text(h+" km");var i=this._map.latLngToLayerPoint(f);if(b.useHeightIndicator){if(!this._mouseHeightFocus){var j=d3.select(".leaflet-overlay-pane svg").append("g");this._mouseHeightFocus=j.append("svg:line").attr("class","height-focus line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0");var k=this._pointG=j.append("g");k.append("svg:circle").attr("r",6).attr("cx",0).attr("cy",0).attr("class","height-focus circle-lower"),this._mouseHeightFocusLabel=j.append("svg:text").attr("class","height-focus-label").style("pointer-events","none")}var l=this._height()/this._maxElevation*d,m=i.y-l;this._mouseHeightFocus.attr("x1",i.x).attr("x2",i.x).attr("y1",i.y).attr("y2",m).style("visibility","visible"),this._pointG.attr("transform","translate("+i.x+","+i.y+")").style("visibility","visible"),this._mouseHeightFocusLabel.attr("x",i.x).attr("y",m).text(d+" m").style("visibility","visible")}else this._marker?this._marker.setLatLng(f):this._marker=new L.Marker(f).addTo(this._map)}},_addGeoJSONData:function(a){if(a){for(var b=this._data||[],c=this._dist||0,d=this._maxElevation||0,e=0;e<a.length;e++){var f=new L.LatLng(a[e][1],a[e][0]),g=new L.LatLng(a[e?e-1:0][1],a[e?e-1:0][0]),h=f.distanceTo(g);c+=Math.round(h/1e3*1e5)/1e5,d=d<a[e][2]?a[e][2]:d,b.push({dist:c,altitude:a[e][2],x:a[e][0],y:a[e][1],latlng:f})}this._dist=c,this._data=b,this._maxElevation=d}},_addGPXdata:function(a){if(a){for(var b=this._data||[],c=this._dist||0,d=this._maxElevation||0,e=0;e<a.length;e++){var f=a[e],g=a[e?e-1:0],h=f.distanceTo(g);c+=Math.round(h/1e3*1e5)/1e5,d=d<f.meta.ele?f.meta.ele:d,b.push({dist:c,altitude:f.meta.ele,x:f.lng,y:f.lat,latlng:f})}this._dist=c,this._data=b,this._maxElevation=d}},_addData:function(a){var b,c=a&&a.geometry&&a.geometry;if(c)switch(c.type){case"LineString":this._addGeoJSONData(c.coordinates);break;case"MultiLineString":for(b=0;b<c.coordinates.length;b++)this._addGeoJSONData(c.coordinates[b]);break;default:throw new Error("Invalid GeoJSON object.")}var d=a&&"FeatureCollection"===a.type;if(d)for(b=0;b<a.features.length;b++)this._addData(a.features[b]);a&&a._latlngs&&this._addGPXdata(a._latlngs)},_calculateFullExtent:function(a){if(!a||a.length<1)throw new Error("no data in parameters");var b=new L.latLngBounds(a[0].latlng,a[0].latlng);return a.forEach(function(a){b.extend(a.latlng)}),b},addData:function(a){this._addData(a),this._container&&this._applyData()},_applyData:function(){var a=d3.extent(this._data,function(a){return a.dist}),b=d3.extent(this._data,function(a){return a.altitude}),c=this.options;void 0!==c.yAxisMin&&(c.yAxisMin<b[0]||c.forceAxisBounds)&&(b[0]=c.yAxisMin),void 0!==c.yAxisMax&&(c.yAxisMax>b[1]||c.forceAxisBounds)&&(b[1]=c.yAxisMax),this._x.domain(a),this._y.domain(b),this._areapath.datum(this._data).attr("d",this._area),this._updateAxis(),this._fullExtent=this._calculateFullExtent(this._data)},_clearData:function(){this._data=null,this._dist=null,this._maxElevation=null},clear:function(){this._clearData(),this._areapath&&(this._areapath.attr("d","M0 0"),this._x.domain([0,1]),this._y.domain([0,1]),this._updateAxis())}}),L.control.elevation=function(a){return new L.Control.Elevation(a)};
\ No newline at end of file
diff --git a/web/src/main/webapp/js/d3.min.js b/web/src/main/webapp/js/d3.min.js
new file mode 100644
index 0000000000..eed58e6a57
--- /dev/null
+++ b/web/src/main/webapp/js/d3.min.js
@@ -0,0 +1,5 @@
+!function(){function n(n){return null!=n&&!isNaN(n)}function t(n){return n.length}function e(n){for(var t=1;n*t%1;)t*=10;return t}function r(n,t){try{for(var e in t)Object.defineProperty(n.prototype,e,{value:t[e],enumerable:!1})}catch(r){n.prototype=t}}function u(){}function i(n){return aa+n in this}function o(n){return n=aa+n,n in this&&delete this[n]}function a(){var n=[];return this.forEach(function(t){n.push(t)}),n}function c(){var n=0;for(var t in this)t.charCodeAt(0)===ca&&++n;return n}function s(){for(var n in this)if(n.charCodeAt(0)===ca)return!1;return!0}function l(){}function f(n,t,e){return function(){var r=e.apply(t,arguments);return r===t?n:r}}function h(n,t){if(t in n)return t;t=t.charAt(0).toUpperCase()+t.substring(1);for(var e=0,r=sa.length;r>e;++e){var u=sa[e]+t;if(u in n)return u}}function g(){}function p(){}function v(n){function t(){for(var t,r=e,u=-1,i=r.length;++u<i;)(t=r[u].on)&&t.apply(this,arguments);return n}var e=[],r=new u;return t.on=function(t,u){var i,o=r.get(t);return arguments.length<2?o&&o.on:(o&&(o.on=null,e=e.slice(0,i=e.indexOf(o)).concat(e.slice(i+1)),r.remove(t)),u&&e.push(r.set(t,{on:u})),n)},t}function d(){Xo.event.preventDefault()}function m(){for(var n,t=Xo.event;n=t.sourceEvent;)t=n;return t}function y(n){for(var t=new p,e=0,r=arguments.length;++e<r;)t[arguments[e]]=v(t);return t.of=function(e,r){return function(u){try{var i=u.sourceEvent=Xo.event;u.target=n,Xo.event=u,t[u.type].apply(e,r)}finally{Xo.event=i}}},t}function x(n){return fa(n,da),n}function M(n){return"function"==typeof n?n:function(){return ha(n,this)}}function _(n){return"function"==typeof n?n:function(){return ga(n,this)}}function b(n,t){function e(){this.removeAttribute(n)}function r(){this.removeAttributeNS(n.space,n.local)}function u(){this.setAttribute(n,t)}function i(){this.setAttributeNS(n.space,n.local,t)}function o(){var e=t.apply(this,arguments);null==e?this.removeAttribute(n):this.setAttribute(n,e)}function a(){var e=t.apply(this,arguments);null==e?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,e)}return n=Xo.ns.qualify(n),null==t?n.local?r:e:"function"==typeof t?n.local?a:o:n.local?i:u}function w(n){return n.trim().replace(/\s+/g," ")}function S(n){return new RegExp("(?:^|\\s+)"+Xo.requote(n)+"(?:\\s+|$)","g")}function k(n){return n.trim().split(/^|\s+/)}function E(n,t){function e(){for(var e=-1;++e<u;)n[e](this,t)}function r(){for(var e=-1,r=t.apply(this,arguments);++e<u;)n[e](this,r)}n=k(n).map(A);var u=n.length;return"function"==typeof t?r:e}function A(n){var t=S(n);return function(e,r){if(u=e.classList)return r?u.add(n):u.remove(n);var u=e.getAttribute("class")||"";r?(t.lastIndex=0,t.test(u)||e.setAttribute("class",w(u+" "+n))):e.setAttribute("class",w(u.replace(t," ")))}}function C(n,t,e){function r(){this.style.removeProperty(n)}function u(){this.style.setProperty(n,t,e)}function i(){var r=t.apply(this,arguments);null==r?this.style.removeProperty(n):this.style.setProperty(n,r,e)}return null==t?r:"function"==typeof t?i:u}function N(n,t){function e(){delete this[n]}function r(){this[n]=t}function u(){var e=t.apply(this,arguments);null==e?delete this[n]:this[n]=e}return null==t?e:"function"==typeof t?u:r}function L(n){return"function"==typeof n?n:(n=Xo.ns.qualify(n)).local?function(){return this.ownerDocument.createElementNS(n.space,n.local)}:function(){return this.ownerDocument.createElementNS(this.namespaceURI,n)}}function z(n){return{__data__:n}}function q(n){return function(){return va(this,n)}}function T(n){return arguments.length||(n=Xo.ascending),function(t,e){return t&&e?n(t.__data__,e.__data__):!t-!e}}function R(n,t){for(var e=0,r=n.length;r>e;e++)for(var u,i=n[e],o=0,a=i.length;a>o;o++)(u=i[o])&&t(u,o,e);return n}function D(n){return fa(n,ya),n}function P(n){var t,e;return function(r,u,i){var o,a=n[i].update,c=a.length;for(i!=e&&(e=i,t=0),u>=t&&(t=u+1);!(o=a[t])&&++t<c;);return o}}function U(){var n=this.__transition__;n&&++n.active}function j(n,t,e){function r(){var t=this[o];t&&(this.removeEventListener(n,t,t.$),delete this[o])}function u(){var u=c(t,Bo(arguments));r.call(this),this.addEventListener(n,this[o]=u,u.$=e),u._=t}function i(){var t,e=new RegExp("^__on([^.]+)"+Xo.requote(n)+"$");for(var r in this)if(t=r.match(e)){var u=this[r];this.removeEventListener(t[1],u,u.$),delete this[r]}}var o="__on"+n,a=n.indexOf("."),c=H;a>0&&(n=n.substring(0,a));var s=Ma.get(n);return s&&(n=s,c=F),a?t?u:r:t?g:i}function H(n,t){return function(e){var r=Xo.event;Xo.event=e,t[0]=this.__data__;try{n.apply(this,t)}finally{Xo.event=r}}}function F(n,t){var e=H(n,t);return function(n){var t=this,r=n.relatedTarget;r&&(r===t||8&r.compareDocumentPosition(t))||e.call(t,n)}}function O(){var n=".dragsuppress-"+ ++ba,t="click"+n,e=Xo.select(Go).on("touchmove"+n,d).on("dragstart"+n,d).on("selectstart"+n,d);if(_a){var r=Jo.style,u=r[_a];r[_a]="none"}return function(i){function o(){e.on(t,null)}e.on(n,null),_a&&(r[_a]=u),i&&(e.on(t,function(){d(),o()},!0),setTimeout(o,0))}}function Y(n,t){t.changedTouches&&(t=t.changedTouches[0]);var e=n.ownerSVGElement||n;if(e.createSVGPoint){var r=e.createSVGPoint();if(0>wa&&(Go.scrollX||Go.scrollY)){e=Xo.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var u=e[0][0].getScreenCTM();wa=!(u.f||u.e),e.remove()}return wa?(r.x=t.pageX,r.y=t.pageY):(r.x=t.clientX,r.y=t.clientY),r=r.matrixTransform(n.getScreenCTM().inverse()),[r.x,r.y]}var i=n.getBoundingClientRect();return[t.clientX-i.left-n.clientLeft,t.clientY-i.top-n.clientTop]}function I(n){return n>0?1:0>n?-1:0}function Z(n,t,e){return(t[0]-n[0])*(e[1]-n[1])-(t[1]-n[1])*(e[0]-n[0])}function V(n){return n>1?0:-1>n?Sa:Math.acos(n)}function X(n){return n>1?Ea:-1>n?-Ea:Math.asin(n)}function $(n){return((n=Math.exp(n))-1/n)/2}function B(n){return((n=Math.exp(n))+1/n)/2}function W(n){return((n=Math.exp(2*n))-1)/(n+1)}function J(n){return(n=Math.sin(n/2))*n}function G(){}function K(n,t,e){return new Q(n,t,e)}function Q(n,t,e){this.h=n,this.s=t,this.l=e}function nt(n,t,e){function r(n){return n>360?n-=360:0>n&&(n+=360),60>n?i+(o-i)*n/60:180>n?o:240>n?i+(o-i)*(240-n)/60:i}function u(n){return Math.round(255*r(n))}var i,o;return n=isNaN(n)?0:(n%=360)<0?n+360:n,t=isNaN(t)?0:0>t?0:t>1?1:t,e=0>e?0:e>1?1:e,o=.5>=e?e*(1+t):e+t-e*t,i=2*e-o,gt(u(n+120),u(n),u(n-120))}function tt(n,t,e){return new et(n,t,e)}function et(n,t,e){this.h=n,this.c=t,this.l=e}function rt(n,t,e){return isNaN(n)&&(n=0),isNaN(t)&&(t=0),ut(e,Math.cos(n*=Na)*t,Math.sin(n)*t)}function ut(n,t,e){return new it(n,t,e)}function it(n,t,e){this.l=n,this.a=t,this.b=e}function ot(n,t,e){var r=(n+16)/116,u=r+t/500,i=r-e/200;return u=ct(u)*Fa,r=ct(r)*Oa,i=ct(i)*Ya,gt(lt(3.2404542*u-1.5371385*r-.4985314*i),lt(-.969266*u+1.8760108*r+.041556*i),lt(.0556434*u-.2040259*r+1.0572252*i))}function at(n,t,e){return n>0?tt(Math.atan2(e,t)*La,Math.sqrt(t*t+e*e),n):tt(0/0,0/0,n)}function ct(n){return n>.206893034?n*n*n:(n-4/29)/7.787037}function st(n){return n>.008856?Math.pow(n,1/3):7.787037*n+4/29}function lt(n){return Math.round(255*(.00304>=n?12.92*n:1.055*Math.pow(n,1/2.4)-.055))}function ft(n){return gt(n>>16,255&n>>8,255&n)}function ht(n){return ft(n)+""}function gt(n,t,e){return new pt(n,t,e)}function pt(n,t,e){this.r=n,this.g=t,this.b=e}function vt(n){return 16>n?"0"+Math.max(0,n).toString(16):Math.min(255,n).toString(16)}function dt(n,t,e){var r,u,i,o=0,a=0,c=0;if(r=/([a-z]+)\((.*)\)/i.exec(n))switch(u=r[2].split(","),r[1]){case"hsl":return e(parseFloat(u[0]),parseFloat(u[1])/100,parseFloat(u[2])/100);case"rgb":return t(Mt(u[0]),Mt(u[1]),Mt(u[2]))}return(i=Va.get(n))?t(i.r,i.g,i.b):(null!=n&&"#"===n.charAt(0)&&(4===n.length?(o=n.charAt(1),o+=o,a=n.charAt(2),a+=a,c=n.charAt(3),c+=c):7===n.length&&(o=n.substring(1,3),a=n.substring(3,5),c=n.substring(5,7)),o=parseInt(o,16),a=parseInt(a,16),c=parseInt(c,16)),t(o,a,c))}function mt(n,t,e){var r,u,i=Math.min(n/=255,t/=255,e/=255),o=Math.max(n,t,e),a=o-i,c=(o+i)/2;return a?(u=.5>c?a/(o+i):a/(2-o-i),r=n==o?(t-e)/a+(e>t?6:0):t==o?(e-n)/a+2:(n-t)/a+4,r*=60):(r=0/0,u=c>0&&1>c?0:r),K(r,u,c)}function yt(n,t,e){n=xt(n),t=xt(t),e=xt(e);var r=st((.4124564*n+.3575761*t+.1804375*e)/Fa),u=st((.2126729*n+.7151522*t+.072175*e)/Oa),i=st((.0193339*n+.119192*t+.9503041*e)/Ya);return ut(116*u-16,500*(r-u),200*(u-i))}function xt(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function Mt(n){var t=parseFloat(n);return"%"===n.charAt(n.length-1)?Math.round(2.55*t):t}function _t(n){return"function"==typeof n?n:function(){return n}}function bt(n){return n}function wt(n){return function(t,e,r){return 2===arguments.length&&"function"==typeof e&&(r=e,e=null),St(t,e,n,r)}}function St(n,t,e,r){function u(){var n,t=c.status;if(!t&&c.responseText||t>=200&&300>t||304===t){try{n=e.call(i,c)}catch(r){return o.error.call(i,r),void 0}o.load.call(i,n)}else o.error.call(i,c)}var i={},o=Xo.dispatch("beforesend","progress","load","error"),a={},c=new XMLHttpRequest,s=null;return!Go.XDomainRequest||"withCredentials"in c||!/^(http(s)?:)?\/\//.test(n)||(c=new XDomainRequest),"onload"in c?c.onload=c.onerror=u:c.onreadystatechange=function(){c.readyState>3&&u()},c.onprogress=function(n){var t=Xo.event;Xo.event=n;try{o.progress.call(i,c)}finally{Xo.event=t}},i.header=function(n,t){return n=(n+"").toLowerCase(),arguments.length<2?a[n]:(null==t?delete a[n]:a[n]=t+"",i)},i.mimeType=function(n){return arguments.length?(t=null==n?null:n+"",i):t},i.responseType=function(n){return arguments.length?(s=n,i):s},i.response=function(n){return e=n,i},["get","post"].forEach(function(n){i[n]=function(){return i.send.apply(i,[n].concat(Bo(arguments)))}}),i.send=function(e,r,u){if(2===arguments.length&&"function"==typeof r&&(u=r,r=null),c.open(e,n,!0),null==t||"accept"in a||(a.accept=t+",*/*"),c.setRequestHeader)for(var l in a)c.setRequestHeader(l,a[l]);return null!=t&&c.overrideMimeType&&c.overrideMimeType(t),null!=s&&(c.responseType=s),null!=u&&i.on("error",u).on("load",function(n){u(null,n)}),o.beforesend.call(i,c),c.send(null==r?null:r),i},i.abort=function(){return c.abort(),i},Xo.rebind(i,o,"on"),null==r?i:i.get(kt(r))}function kt(n){return 1===n.length?function(t,e){n(null==t?e:null)}:n}function Et(){var n=At(),t=Ct()-n;t>24?(isFinite(t)&&(clearTimeout(Wa),Wa=setTimeout(Et,t)),Ba=0):(Ba=1,Ga(Et))}function At(){var n=Date.now();for(Ja=Xa;Ja;)n>=Ja.t&&(Ja.f=Ja.c(n-Ja.t)),Ja=Ja.n;return n}function Ct(){for(var n,t=Xa,e=1/0;t;)t.f?t=n?n.n=t.n:Xa=t.n:(t.t<e&&(e=t.t),t=(n=t).n);return $a=n,e}function Nt(n,t){return t-(n?Math.ceil(Math.log(n)/Math.LN10):1)}function Lt(n,t){var e=Math.pow(10,3*oa(8-t));return{scale:t>8?function(n){return n/e}:function(n){return n*e},symbol:n}}function zt(n){var t=n.decimal,e=n.thousands,r=n.grouping,u=n.currency,i=r?function(n){for(var t=n.length,u=[],i=0,o=r[0];t>0&&o>0;)u.push(n.substring(t-=o,t+o)),o=r[i=(i+1)%r.length];return u.reverse().join(e)}:bt;return function(n){var e=Qa.exec(n),r=e[1]||" ",o=e[2]||">",a=e[3]||"",c=e[4]||"",s=e[5],l=+e[6],f=e[7],h=e[8],g=e[9],p=1,v="",d="",m=!1;switch(h&&(h=+h.substring(1)),(s||"0"===r&&"="===o)&&(s=r="0",o="=",f&&(l-=Math.floor((l-1)/4))),g){case"n":f=!0,g="g";break;case"%":p=100,d="%",g="f";break;case"p":p=100,d="%",g="r";break;case"b":case"o":case"x":case"X":"#"===c&&(v="0"+g.toLowerCase());case"c":case"d":m=!0,h=0;break;case"s":p=-1,g="r"}"$"===c&&(v=u[0],d=u[1]),"r"!=g||h||(g="g"),null!=h&&("g"==g?h=Math.max(1,Math.min(21,h)):("e"==g||"f"==g)&&(h=Math.max(0,Math.min(20,h)))),g=nc.get(g)||qt;var y=s&&f;return function(n){var e=d;if(m&&n%1)return"";var u=0>n||0===n&&0>1/n?(n=-n,"-"):a;if(0>p){var c=Xo.formatPrefix(n,h);n=c.scale(n),e=c.symbol+d}else n*=p;n=g(n,h);var x=n.lastIndexOf("."),M=0>x?n:n.substring(0,x),_=0>x?"":t+n.substring(x+1);!s&&f&&(M=i(M));var b=v.length+M.length+_.length+(y?0:u.length),w=l>b?new Array(b=l-b+1).join(r):"";return y&&(M=i(w+M)),u+=v,n=M+_,("<"===o?u+n+w:">"===o?w+u+n:"^"===o?w.substring(0,b>>=1)+u+n+w.substring(b):u+(y?n:w+n))+e}}}function qt(n){return n+""}function Tt(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0])}function Rt(n,t,e){function r(t){var e=n(t),r=i(e,1);return r-t>t-e?e:r}function u(e){return t(e=n(new ec(e-1)),1),e}function i(n,e){return t(n=new ec(+n),e),n}function o(n,r,i){var o=u(n),a=[];if(i>1)for(;r>o;)e(o)%i||a.push(new Date(+o)),t(o,1);else for(;r>o;)a.push(new Date(+o)),t(o,1);return a}function a(n,t,e){try{ec=Tt;var r=new Tt;return r._=n,o(r,t,e)}finally{ec=Date}}n.floor=n,n.round=r,n.ceil=u,n.offset=i,n.range=o;var c=n.utc=Dt(n);return c.floor=c,c.round=Dt(r),c.ceil=Dt(u),c.offset=Dt(i),c.range=a,n}function Dt(n){return function(t,e){try{ec=Tt;var r=new Tt;return r._=t,n(r,e)._}finally{ec=Date}}}function Pt(n){function t(n){function t(t){for(var e,u,i,o=[],a=-1,c=0;++a<r;)37===n.charCodeAt(a)&&(o.push(n.substring(c,a)),null!=(u=uc[e=n.charAt(++a)])&&(e=n.charAt(++a)),(i=C[e])&&(e=i(t,null==u?"e"===e?" ":"0":u)),o.push(e),c=a+1);return o.push(n.substring(c,a)),o.join("")}var r=n.length;return t.parse=function(t){var r={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null},u=e(r,n,t,0);if(u!=t.length)return null;"p"in r&&(r.H=r.H%12+12*r.p);var i=null!=r.Z&&ec!==Tt,o=new(i?Tt:ec);return"j"in r?o.setFullYear(r.y,0,r.j):"w"in r&&("W"in r||"U"in r)?(o.setFullYear(r.y,0,1),o.setFullYear(r.y,0,"W"in r?(r.w+6)%7+7*r.W-(o.getDay()+5)%7:r.w+7*r.U-(o.getDay()+6)%7)):o.setFullYear(r.y,r.m,r.d),o.setHours(r.H+Math.floor(r.Z/100),r.M+r.Z%100,r.S,r.L),i?o._:o},t.toString=function(){return n},t}function e(n,t,e,r){for(var u,i,o,a=0,c=t.length,s=e.length;c>a;){if(r>=s)return-1;if(u=t.charCodeAt(a++),37===u){if(o=t.charAt(a++),i=N[o in uc?t.charAt(a++):o],!i||(r=i(n,e,r))<0)return-1}else if(u!=e.charCodeAt(r++))return-1}return r}function r(n,t,e){b.lastIndex=0;var r=b.exec(t.substring(e));return r?(n.w=w.get(r[0].toLowerCase()),e+r[0].length):-1}function u(n,t,e){M.lastIndex=0;var r=M.exec(t.substring(e));return r?(n.w=_.get(r[0].toLowerCase()),e+r[0].length):-1}function i(n,t,e){E.lastIndex=0;var r=E.exec(t.substring(e));return r?(n.m=A.get(r[0].toLowerCase()),e+r[0].length):-1}function o(n,t,e){S.lastIndex=0;var r=S.exec(t.substring(e));return r?(n.m=k.get(r[0].toLowerCase()),e+r[0].length):-1}function a(n,t,r){return e(n,C.c.toString(),t,r)}function c(n,t,r){return e(n,C.x.toString(),t,r)}function s(n,t,r){return e(n,C.X.toString(),t,r)}function l(n,t,e){var r=x.get(t.substring(e,e+=2).toLowerCase());return null==r?-1:(n.p=r,e)}var f=n.dateTime,h=n.date,g=n.time,p=n.periods,v=n.days,d=n.shortDays,m=n.months,y=n.shortMonths;t.utc=function(n){function e(n){try{ec=Tt;var t=new ec;return t._=n,r(t)}finally{ec=Date}}var r=t(n);return e.parse=function(n){try{ec=Tt;var t=r.parse(n);return t&&t._}finally{ec=Date}},e.toString=r.toString,e},t.multi=t.utc.multi=ee;var x=Xo.map(),M=jt(v),_=Ht(v),b=jt(d),w=Ht(d),S=jt(m),k=Ht(m),E=jt(y),A=Ht(y);p.forEach(function(n,t){x.set(n.toLowerCase(),t)});var C={a:function(n){return d[n.getDay()]},A:function(n){return v[n.getDay()]},b:function(n){return y[n.getMonth()]},B:function(n){return m[n.getMonth()]},c:t(f),d:function(n,t){return Ut(n.getDate(),t,2)},e:function(n,t){return Ut(n.getDate(),t,2)},H:function(n,t){return Ut(n.getHours(),t,2)},I:function(n,t){return Ut(n.getHours()%12||12,t,2)},j:function(n,t){return Ut(1+tc.dayOfYear(n),t,3)},L:function(n,t){return Ut(n.getMilliseconds(),t,3)},m:function(n,t){return Ut(n.getMonth()+1,t,2)},M:function(n,t){return Ut(n.getMinutes(),t,2)},p:function(n){return p[+(n.getHours()>=12)]},S:function(n,t){return Ut(n.getSeconds(),t,2)},U:function(n,t){return Ut(tc.sundayOfYear(n),t,2)},w:function(n){return n.getDay()},W:function(n,t){return Ut(tc.mondayOfYear(n),t,2)},x:t(h),X:t(g),y:function(n,t){return Ut(n.getFullYear()%100,t,2)},Y:function(n,t){return Ut(n.getFullYear()%1e4,t,4)},Z:ne,"%":function(){return"%"}},N={a:r,A:u,b:i,B:o,c:a,d:Bt,e:Bt,H:Jt,I:Jt,j:Wt,L:Qt,m:$t,M:Gt,p:l,S:Kt,U:Ot,w:Ft,W:Yt,x:c,X:s,y:Zt,Y:It,Z:Vt,"%":te};return t}function Ut(n,t,e){var r=0>n?"-":"",u=(r?-n:n)+"",i=u.length;return r+(e>i?new Array(e-i+1).join(t)+u:u)}function jt(n){return new RegExp("^(?:"+n.map(Xo.requote).join("|")+")","i")}function Ht(n){for(var t=new u,e=-1,r=n.length;++e<r;)t.set(n[e].toLowerCase(),e);return t}function Ft(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+1));return r?(n.w=+r[0],e+r[0].length):-1}function Ot(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e));return r?(n.U=+r[0],e+r[0].length):-1}function Yt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e));return r?(n.W=+r[0],e+r[0].length):-1}function It(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+4));return r?(n.y=+r[0],e+r[0].length):-1}function Zt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.y=Xt(+r[0]),e+r[0].length):-1}function Vt(n,t,e){return/^[+-]\d{4}$/.test(t=t.substring(e,e+5))?(n.Z=+t,e+5):-1}function Xt(n){return n+(n>68?1900:2e3)}function $t(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.m=r[0]-1,e+r[0].length):-1}function Bt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.d=+r[0],e+r[0].length):-1}function Wt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+3));return r?(n.j=+r[0],e+r[0].length):-1}function Jt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.H=+r[0],e+r[0].length):-1}function Gt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.M=+r[0],e+r[0].length):-1}function Kt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+2));return r?(n.S=+r[0],e+r[0].length):-1}function Qt(n,t,e){ic.lastIndex=0;var r=ic.exec(t.substring(e,e+3));return r?(n.L=+r[0],e+r[0].length):-1}function ne(n){var t=n.getTimezoneOffset(),e=t>0?"-":"+",r=~~(oa(t)/60),u=oa(t)%60;return e+Ut(r,"0",2)+Ut(u,"0",2)}function te(n,t,e){oc.lastIndex=0;var r=oc.exec(t.substring(e,e+1));return r?e+r[0].length:-1}function ee(n){for(var t=n.length,e=-1;++e<t;)n[e][0]=this(n[e][0]);return function(t){for(var e=0,r=n[e];!r[1](t);)r=n[++e];return r[0](t)}}function re(){}function ue(n,t,e){var r=e.s=n+t,u=r-n,i=r-u;e.t=n-i+(t-u)}function ie(n,t){n&&lc.hasOwnProperty(n.type)&&lc[n.type](n,t)}function oe(n,t,e){var r,u=-1,i=n.length-e;for(t.lineStart();++u<i;)r=n[u],t.point(r[0],r[1],r[2]);t.lineEnd()}function ae(n,t){var e=-1,r=n.length;for(t.polygonStart();++e<r;)oe(n[e],t,1);t.polygonEnd()}function ce(){function n(n,t){n*=Na,t=t*Na/2+Sa/4;var e=n-r,o=Math.cos(t),a=Math.sin(t),c=i*a,s=u*o+c*Math.cos(e),l=c*Math.sin(e);hc.add(Math.atan2(l,s)),r=n,u=o,i=a}var t,e,r,u,i;gc.point=function(o,a){gc.point=n,r=(t=o)*Na,u=Math.cos(a=(e=a)*Na/2+Sa/4),i=Math.sin(a)},gc.lineEnd=function(){n(t,e)}}function se(n){var t=n[0],e=n[1],r=Math.cos(e);return[r*Math.cos(t),r*Math.sin(t),Math.sin(e)]}function le(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function fe(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function he(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function ge(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function pe(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function ve(n){return[Math.atan2(n[1],n[0]),X(n[2])]}function de(n,t){return oa(n[0]-t[0])<Aa&&oa(n[1]-t[1])<Aa}function me(n,t){n*=Na;var e=Math.cos(t*=Na);ye(e*Math.cos(n),e*Math.sin(n),Math.sin(t))}function ye(n,t,e){++pc,dc+=(n-dc)/pc,mc+=(t-mc)/pc,yc+=(e-yc)/pc}function xe(){function n(n,u){n*=Na;var i=Math.cos(u*=Na),o=i*Math.cos(n),a=i*Math.sin(n),c=Math.sin(u),s=Math.atan2(Math.sqrt((s=e*c-r*a)*s+(s=r*o-t*c)*s+(s=t*a-e*o)*s),t*o+e*a+r*c);vc+=s,xc+=s*(t+(t=o)),Mc+=s*(e+(e=a)),_c+=s*(r+(r=c)),ye(t,e,r)}var t,e,r;kc.point=function(u,i){u*=Na;var o=Math.cos(i*=Na);t=o*Math.cos(u),e=o*Math.sin(u),r=Math.sin(i),kc.point=n,ye(t,e,r)}}function Me(){kc.point=me}function _e(){function n(n,t){n*=Na;var e=Math.cos(t*=Na),o=e*Math.cos(n),a=e*Math.sin(n),c=Math.sin(t),s=u*c-i*a,l=i*o-r*c,f=r*a-u*o,h=Math.sqrt(s*s+l*l+f*f),g=r*o+u*a+i*c,p=h&&-V(g)/h,v=Math.atan2(h,g);bc+=p*s,wc+=p*l,Sc+=p*f,vc+=v,xc+=v*(r+(r=o)),Mc+=v*(u+(u=a)),_c+=v*(i+(i=c)),ye(r,u,i)}var t,e,r,u,i;kc.point=function(o,a){t=o,e=a,kc.point=n,o*=Na;var c=Math.cos(a*=Na);r=c*Math.cos(o),u=c*Math.sin(o),i=Math.sin(a),ye(r,u,i)},kc.lineEnd=function(){n(t,e),kc.lineEnd=Me,kc.point=me}}function be(){return!0}function we(n,t,e,r,u){var i=[],o=[];if(n.forEach(function(n){if(!((t=n.length-1)<=0)){var t,e=n[0],r=n[t];if(de(e,r)){u.lineStart();for(var a=0;t>a;++a)u.point((e=n[a])[0],e[1]);return u.lineEnd(),void 0}var c=new ke(e,n,null,!0),s=new ke(e,null,c,!1);c.o=s,i.push(c),o.push(s),c=new ke(r,n,null,!1),s=new ke(r,null,c,!0),c.o=s,i.push(c),o.push(s)}}),o.sort(t),Se(i),Se(o),i.length){for(var a=0,c=e,s=o.length;s>a;++a)o[a].e=c=!c;for(var l,f,h=i[0];;){for(var g=h,p=!0;g.v;)if((g=g.n)===h)return;l=g.z,u.lineStart();do{if(g.v=g.o.v=!0,g.e){if(p)for(var a=0,s=l.length;s>a;++a)u.point((f=l[a])[0],f[1]);else r(g.x,g.n.x,1,u);g=g.n}else{if(p){l=g.p.z;for(var a=l.length-1;a>=0;--a)u.point((f=l[a])[0],f[1])}else r(g.x,g.p.x,-1,u);g=g.p}g=g.o,l=g.z,p=!p}while(!g.v);u.lineEnd()}}}function Se(n){if(t=n.length){for(var t,e,r=0,u=n[0];++r<t;)u.n=e=n[r],e.p=u,u=e;u.n=e=n[0],e.p=u}}function ke(n,t,e,r){this.x=n,this.z=t,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function Ee(n,t,e,r){return function(u,i){function o(t,e){var r=u(t,e);n(t=r[0],e=r[1])&&i.point(t,e)}function a(n,t){var e=u(n,t);d.point(e[0],e[1])}function c(){y.point=a,d.lineStart()}function s(){y.point=o,d.lineEnd()}function l(n,t){v.push([n,t]);var e=u(n,t);M.point(e[0],e[1])}function f(){M.lineStart(),v=[]}function h(){l(v[0][0],v[0][1]),M.lineEnd();var n,t=M.clean(),e=x.buffer(),r=e.length;if(v.pop(),p.push(v),v=null,r){if(1&t){n=e[0];var u,r=n.length-1,o=-1;for(i.lineStart();++o<r;)i.point((u=n[o])[0],u[1]);return i.lineEnd(),void 0}r>1&&2&t&&e.push(e.pop().concat(e.shift())),g.push(e.filter(Ae))}}var g,p,v,d=t(i),m=u.invert(r[0],r[1]),y={point:o,lineStart:c,lineEnd:s,polygonStart:function(){y.point=l,y.lineStart=f,y.lineEnd=h,g=[],p=[],i.polygonStart()},polygonEnd:function(){y.point=o,y.lineStart=c,y.lineEnd=s,g=Xo.merge(g);var n=Le(m,p);g.length?we(g,Ne,n,e,i):n&&(i.lineStart(),e(null,null,1,i),i.lineEnd()),i.polygonEnd(),g=p=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}},x=Ce(),M=t(x);return y}}function Ae(n){return n.length>1}function Ce(){var n,t=[];return{lineStart:function(){t.push(n=[])},point:function(t,e){n.push([t,e])},lineEnd:g,buffer:function(){var e=t;return t=[],n=null,e},rejoin:function(){t.length>1&&t.push(t.pop().concat(t.shift()))}}}function Ne(n,t){return((n=n.x)[0]<0?n[1]-Ea-Aa:Ea-n[1])-((t=t.x)[0]<0?t[1]-Ea-Aa:Ea-t[1])}function Le(n,t){var e=n[0],r=n[1],u=[Math.sin(e),-Math.cos(e),0],i=0,o=0;hc.reset();for(var a=0,c=t.length;c>a;++a){var s=t[a],l=s.length;if(l)for(var f=s[0],h=f[0],g=f[1]/2+Sa/4,p=Math.sin(g),v=Math.cos(g),d=1;;){d===l&&(d=0),n=s[d];var m=n[0],y=n[1]/2+Sa/4,x=Math.sin(y),M=Math.cos(y),_=m-h,b=oa(_)>Sa,w=p*x;if(hc.add(Math.atan2(w*Math.sin(_),v*M+w*Math.cos(_))),i+=b?_+(_>=0?ka:-ka):_,b^h>=e^m>=e){var S=fe(se(f),se(n));pe(S);var k=fe(u,S);pe(k);var E=(b^_>=0?-1:1)*X(k[2]);(r>E||r===E&&(S[0]||S[1]))&&(o+=b^_>=0?1:-1)}if(!d++)break;h=m,p=x,v=M,f=n}}return(-Aa>i||Aa>i&&0>hc)^1&o}function ze(n){var t,e=0/0,r=0/0,u=0/0;return{lineStart:function(){n.lineStart(),t=1},point:function(i,o){var a=i>0?Sa:-Sa,c=oa(i-e);oa(c-Sa)<Aa?(n.point(e,r=(r+o)/2>0?Ea:-Ea),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),n.point(i,r),t=0):u!==a&&c>=Sa&&(oa(e-u)<Aa&&(e-=u*Aa),oa(i-a)<Aa&&(i-=a*Aa),r=qe(e,r,i,o),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),t=0),n.point(e=i,r=o),u=a},lineEnd:function(){n.lineEnd(),e=r=0/0},clean:function(){return 2-t}}}function qe(n,t,e,r){var u,i,o=Math.sin(n-e);return oa(o)>Aa?Math.atan((Math.sin(t)*(i=Math.cos(r))*Math.sin(e)-Math.sin(r)*(u=Math.cos(t))*Math.sin(n))/(u*i*o)):(t+r)/2}function Te(n,t,e,r){var u;if(null==n)u=e*Ea,r.point(-Sa,u),r.point(0,u),r.point(Sa,u),r.point(Sa,0),r.point(Sa,-u),r.point(0,-u),r.point(-Sa,-u),r.point(-Sa,0),r.point(-Sa,u);else if(oa(n[0]-t[0])>Aa){var i=n[0]<t[0]?Sa:-Sa;u=e*i/2,r.point(-i,u),r.point(0,u),r.point(i,u)}else r.point(t[0],t[1])}function Re(n){function t(n,t){return Math.cos(n)*Math.cos(t)>i}function e(n){var e,i,c,s,l;return{lineStart:function(){s=c=!1,l=1},point:function(f,h){var g,p=[f,h],v=t(f,h),d=o?v?0:u(f,h):v?u(f+(0>f?Sa:-Sa),h):0;if(!e&&(s=c=v)&&n.lineStart(),v!==c&&(g=r(e,p),(de(e,g)||de(p,g))&&(p[0]+=Aa,p[1]+=Aa,v=t(p[0],p[1]))),v!==c)l=0,v?(n.lineStart(),g=r(p,e),n.point(g[0],g[1])):(g=r(e,p),n.point(g[0],g[1]),n.lineEnd()),e=g;else if(a&&e&&o^v){var m;d&i||!(m=r(p,e,!0))||(l=0,o?(n.lineStart(),n.point(m[0][0],m[0][1]),n.point(m[1][0],m[1][1]),n.lineEnd()):(n.point(m[1][0],m[1][1]),n.lineEnd(),n.lineStart(),n.point(m[0][0],m[0][1])))}!v||e&&de(e,p)||n.point(p[0],p[1]),e=p,c=v,i=d},lineEnd:function(){c&&n.lineEnd(),e=null},clean:function(){return l|(s&&c)<<1}}}function r(n,t,e){var r=se(n),u=se(t),o=[1,0,0],a=fe(r,u),c=le(a,a),s=a[0],l=c-s*s;if(!l)return!e&&n;var f=i*c/l,h=-i*s/l,g=fe(o,a),p=ge(o,f),v=ge(a,h);he(p,v);var d=g,m=le(p,d),y=le(d,d),x=m*m-y*(le(p,p)-1);if(!(0>x)){var M=Math.sqrt(x),_=ge(d,(-m-M)/y);if(he(_,p),_=ve(_),!e)return _;var b,w=n[0],S=t[0],k=n[1],E=t[1];w>S&&(b=w,w=S,S=b);var A=S-w,C=oa(A-Sa)<Aa,N=C||Aa>A;if(!C&&k>E&&(b=k,k=E,E=b),N?C?k+E>0^_[1]<(oa(_[0]-w)<Aa?k:E):k<=_[1]&&_[1]<=E:A>Sa^(w<=_[0]&&_[0]<=S)){var L=ge(d,(-m+M)/y);return he(L,p),[_,ve(L)]}}}function u(t,e){var r=o?n:Sa-n,u=0;return-r>t?u|=1:t>r&&(u|=2),-r>e?u|=4:e>r&&(u|=8),u}var i=Math.cos(n),o=i>0,a=oa(i)>Aa,c=cr(n,6*Na);return Ee(t,e,c,o?[0,-n]:[-Sa,n-Sa])}function De(n,t,e,r){return function(u){var i,o=u.a,a=u.b,c=o.x,s=o.y,l=a.x,f=a.y,h=0,g=1,p=l-c,v=f-s;if(i=n-c,p||!(i>0)){if(i/=p,0>p){if(h>i)return;g>i&&(g=i)}else if(p>0){if(i>g)return;i>h&&(h=i)}if(i=e-c,p||!(0>i)){if(i/=p,0>p){if(i>g)return;i>h&&(h=i)}else if(p>0){if(h>i)return;g>i&&(g=i)}if(i=t-s,v||!(i>0)){if(i/=v,0>v){if(h>i)return;g>i&&(g=i)}else if(v>0){if(i>g)return;i>h&&(h=i)}if(i=r-s,v||!(0>i)){if(i/=v,0>v){if(i>g)return;i>h&&(h=i)}else if(v>0){if(h>i)return;g>i&&(g=i)}return h>0&&(u.a={x:c+h*p,y:s+h*v}),1>g&&(u.b={x:c+g*p,y:s+g*v}),u}}}}}}function Pe(n,t,e,r){function u(r,u){return oa(r[0]-n)<Aa?u>0?0:3:oa(r[0]-e)<Aa?u>0?2:1:oa(r[1]-t)<Aa?u>0?1:0:u>0?3:2}function i(n,t){return o(n.x,t.x)}function o(n,t){var e=u(n,1),r=u(t,1);return e!==r?e-r:0===e?t[1]-n[1]:1===e?n[0]-t[0]:2===e?n[1]-t[1]:t[0]-n[0]}return function(a){function c(n){for(var t=0,e=d.length,r=n[1],u=0;e>u;++u)for(var i,o=1,a=d[u],c=a.length,s=a[0];c>o;++o)i=a[o],s[1]<=r?i[1]>r&&Z(s,i,n)>0&&++t:i[1]<=r&&Z(s,i,n)<0&&--t,s=i;return 0!==t}function s(i,a,c,s){var l=0,f=0;if(null==i||(l=u(i,c))!==(f=u(a,c))||o(i,a)<0^c>0){do s.point(0===l||3===l?n:e,l>1?r:t);while((l=(l+c+4)%4)!==f)}else s.point(a[0],a[1])}function l(u,i){return u>=n&&e>=u&&i>=t&&r>=i}function f(n,t){l(n,t)&&a.point(n,t)}function h(){N.point=p,d&&d.push(m=[]),S=!0,w=!1,_=b=0/0}function g(){v&&(p(y,x),M&&w&&A.rejoin(),v.push(A.buffer())),N.point=f,w&&a.lineEnd()}function p(n,t){n=Math.max(-Ac,Math.min(Ac,n)),t=Math.max(-Ac,Math.min(Ac,t));var e=l(n,t);if(d&&m.push([n,t]),S)y=n,x=t,M=e,S=!1,e&&(a.lineStart(),a.point(n,t));else if(e&&w)a.point(n,t);else{var r={a:{x:_,y:b},b:{x:n,y:t}};C(r)?(w||(a.lineStart(),a.point(r.a.x,r.a.y)),a.point(r.b.x,r.b.y),e||a.lineEnd(),k=!1):e&&(a.lineStart(),a.point(n,t),k=!1)}_=n,b=t,w=e}var v,d,m,y,x,M,_,b,w,S,k,E=a,A=Ce(),C=De(n,t,e,r),N={point:f,lineStart:h,lineEnd:g,polygonStart:function(){a=A,v=[],d=[],k=!0},polygonEnd:function(){a=E,v=Xo.merge(v);var t=c([n,r]),e=k&&t,u=v.length;(e||u)&&(a.polygonStart(),e&&(a.lineStart(),s(null,null,1,a),a.lineEnd()),u&&we(v,i,t,s,a),a.polygonEnd()),v=d=m=null}};return N}}function Ue(n,t){function e(e,r){return e=n(e,r),t(e[0],e[1])}return n.invert&&t.invert&&(e.invert=function(e,r){return e=t.invert(e,r),e&&n.invert(e[0],e[1])}),e}function je(n){var t=0,e=Sa/3,r=nr(n),u=r(t,e);return u.parallels=function(n){return arguments.length?r(t=n[0]*Sa/180,e=n[1]*Sa/180):[180*(t/Sa),180*(e/Sa)]},u}function He(n,t){function e(n,t){var e=Math.sqrt(i-2*u*Math.sin(t))/u;return[e*Math.sin(n*=u),o-e*Math.cos(n)]}var r=Math.sin(n),u=(r+Math.sin(t))/2,i=1+r*(2*u-r),o=Math.sqrt(i)/u;return e.invert=function(n,t){var e=o-t;return[Math.atan2(n,e)/u,X((i-(n*n+e*e)*u*u)/(2*u))]},e}function Fe(){function n(n,t){Nc+=u*n-r*t,r=n,u=t}var t,e,r,u;Rc.point=function(i,o){Rc.point=n,t=r=i,e=u=o},Rc.lineEnd=function(){n(t,e)}}function Oe(n,t){Lc>n&&(Lc=n),n>qc&&(qc=n),zc>t&&(zc=t),t>Tc&&(Tc=t)}function Ye(){function n(n,t){o.push("M",n,",",t,i)}function t(n,t){o.push("M",n,",",t),a.point=e}function e(n,t){o.push("L",n,",",t)}function r(){a.point=n}function u(){o.push("Z")}var i=Ie(4.5),o=[],a={point:n,lineStart:function(){a.point=t},lineEnd:r,polygonStart:function(){a.lineEnd=u},polygonEnd:function(){a.lineEnd=r,a.point=n},pointRadius:function(n){return i=Ie(n),a},result:function(){if(o.length){var n=o.join("");return o=[],n}}};return a}function Ie(n){return"m0,"+n+"a"+n+","+n+" 0 1,1 0,"+-2*n+"a"+n+","+n+" 0 1,1 0,"+2*n+"z"}function Ze(n,t){dc+=n,mc+=t,++yc}function Ve(){function n(n,r){var u=n-t,i=r-e,o=Math.sqrt(u*u+i*i);xc+=o*(t+n)/2,Mc+=o*(e+r)/2,_c+=o,Ze(t=n,e=r)}var t,e;Pc.point=function(r,u){Pc.point=n,Ze(t=r,e=u)}}function Xe(){Pc.point=Ze}function $e(){function n(n,t){var e=n-r,i=t-u,o=Math.sqrt(e*e+i*i);xc+=o*(r+n)/2,Mc+=o*(u+t)/2,_c+=o,o=u*n-r*t,bc+=o*(r+n),wc+=o*(u+t),Sc+=3*o,Ze(r=n,u=t)}var t,e,r,u;Pc.point=function(i,o){Pc.point=n,Ze(t=r=i,e=u=o)},Pc.lineEnd=function(){n(t,e)}}function Be(n){function t(t,e){n.moveTo(t,e),n.arc(t,e,o,0,ka)}function e(t,e){n.moveTo(t,e),a.point=r}function r(t,e){n.lineTo(t,e)}function u(){a.point=t}function i(){n.closePath()}var o=4.5,a={point:t,lineStart:function(){a.point=e},lineEnd:u,polygonStart:function(){a.lineEnd=i},polygonEnd:function(){a.lineEnd=u,a.point=t},pointRadius:function(n){return o=n,a},result:g};return a}function We(n){function t(n){return(a?r:e)(n)}function e(t){return Ke(t,function(e,r){e=n(e,r),t.point(e[0],e[1])})}function r(t){function e(e,r){e=n(e,r),t.point(e[0],e[1])}function r(){x=0/0,S.point=i,t.lineStart()}function i(e,r){var i=se([e,r]),o=n(e,r);u(x,M,y,_,b,w,x=o[0],M=o[1],y=e,_=i[0],b=i[1],w=i[2],a,t),t.point(x,M)}function o(){S.point=e,t.lineEnd()}function c(){r(),S.point=s,S.lineEnd=l}function s(n,t){i(f=n,h=t),g=x,p=M,v=_,d=b,m=w,S.point=i}function l(){u(x,M,y,_,b,w,g,p,f,v,d,m,a,t),S.lineEnd=o,o()}var f,h,g,p,v,d,m,y,x,M,_,b,w,S={point:e,lineStart:r,lineEnd:o,polygonStart:function(){t.polygonStart(),S.lineStart=c},polygonEnd:function(){t.polygonEnd(),S.lineStart=r}};return S}function u(t,e,r,a,c,s,l,f,h,g,p,v,d,m){var y=l-t,x=f-e,M=y*y+x*x;if(M>4*i&&d--){var _=a+g,b=c+p,w=s+v,S=Math.sqrt(_*_+b*b+w*w),k=Math.asin(w/=S),E=oa(oa(w)-1)<Aa||oa(r-h)<Aa?(r+h)/2:Math.atan2(b,_),A=n(E,k),C=A[0],N=A[1],L=C-t,z=N-e,q=x*L-y*z;(q*q/M>i||oa((y*L+x*z)/M-.5)>.3||o>a*g+c*p+s*v)&&(u(t,e,r,a,c,s,C,N,E,_/=S,b/=S,w,d,m),m.point(C,N),u(C,N,E,_,b,w,l,f,h,g,p,v,d,m))}}var i=.5,o=Math.cos(30*Na),a=16;return t.precision=function(n){return arguments.length?(a=(i=n*n)>0&&16,t):Math.sqrt(i)},t}function Je(n){var t=We(function(t,e){return n([t*La,e*La])});return function(n){return tr(t(n))}}function Ge(n){this.stream=n}function Ke(n,t){return{point:t,sphere:function(){n.sphere()},lineStart:function(){n.lineStart()},lineEnd:function(){n.lineEnd()},polygonStart:function(){n.polygonStart()},polygonEnd:function(){n.polygonEnd()}}}function Qe(n){return nr(function(){return n})()}function nr(n){function t(n){return n=a(n[0]*Na,n[1]*Na),[n[0]*h+c,s-n[1]*h]}function e(n){return n=a.invert((n[0]-c)/h,(s-n[1])/h),n&&[n[0]*La,n[1]*La]}function r(){a=Ue(o=ur(m,y,x),i);var n=i(v,d);return c=g-n[0]*h,s=p+n[1]*h,u()}function u(){return l&&(l.valid=!1,l=null),t}var i,o,a,c,s,l,f=We(function(n,t){return n=i(n,t),[n[0]*h+c,s-n[1]*h]}),h=150,g=480,p=250,v=0,d=0,m=0,y=0,x=0,M=Ec,_=bt,b=null,w=null;return t.stream=function(n){return l&&(l.valid=!1),l=tr(M(o,f(_(n)))),l.valid=!0,l},t.clipAngle=function(n){return arguments.length?(M=null==n?(b=n,Ec):Re((b=+n)*Na),u()):b
+},t.clipExtent=function(n){return arguments.length?(w=n,_=n?Pe(n[0][0],n[0][1],n[1][0],n[1][1]):bt,u()):w},t.scale=function(n){return arguments.length?(h=+n,r()):h},t.translate=function(n){return arguments.length?(g=+n[0],p=+n[1],r()):[g,p]},t.center=function(n){return arguments.length?(v=n[0]%360*Na,d=n[1]%360*Na,r()):[v*La,d*La]},t.rotate=function(n){return arguments.length?(m=n[0]%360*Na,y=n[1]%360*Na,x=n.length>2?n[2]%360*Na:0,r()):[m*La,y*La,x*La]},Xo.rebind(t,f,"precision"),function(){return i=n.apply(this,arguments),t.invert=i.invert&&e,r()}}function tr(n){return Ke(n,function(t,e){n.point(t*Na,e*Na)})}function er(n,t){return[n,t]}function rr(n,t){return[n>Sa?n-ka:-Sa>n?n+ka:n,t]}function ur(n,t,e){return n?t||e?Ue(or(n),ar(t,e)):or(n):t||e?ar(t,e):rr}function ir(n){return function(t,e){return t+=n,[t>Sa?t-ka:-Sa>t?t+ka:t,e]}}function or(n){var t=ir(n);return t.invert=ir(-n),t}function ar(n,t){function e(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,s=Math.sin(t),l=s*r+a*u;return[Math.atan2(c*i-l*o,a*r-s*u),X(l*i+c*o)]}var r=Math.cos(n),u=Math.sin(n),i=Math.cos(t),o=Math.sin(t);return e.invert=function(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,s=Math.sin(t),l=s*i-c*o;return[Math.atan2(c*i+s*o,a*r+l*u),X(l*r-a*u)]},e}function cr(n,t){var e=Math.cos(n),r=Math.sin(n);return function(u,i,o,a){var c=o*t;null!=u?(u=sr(e,u),i=sr(e,i),(o>0?i>u:u>i)&&(u+=o*ka)):(u=n+o*ka,i=n-.5*c);for(var s,l=u;o>0?l>i:i>l;l-=c)a.point((s=ve([e,-r*Math.cos(l),-r*Math.sin(l)]))[0],s[1])}}function sr(n,t){var e=se(t);e[0]-=n,pe(e);var r=V(-e[1]);return((-e[2]<0?-r:r)+2*Math.PI-Aa)%(2*Math.PI)}function lr(n,t,e){var r=Xo.range(n,t-Aa,e).concat(t);return function(n){return r.map(function(t){return[n,t]})}}function fr(n,t,e){var r=Xo.range(n,t-Aa,e).concat(t);return function(n){return r.map(function(t){return[t,n]})}}function hr(n){return n.source}function gr(n){return n.target}function pr(n,t,e,r){var u=Math.cos(t),i=Math.sin(t),o=Math.cos(r),a=Math.sin(r),c=u*Math.cos(n),s=u*Math.sin(n),l=o*Math.cos(e),f=o*Math.sin(e),h=2*Math.asin(Math.sqrt(J(r-t)+u*o*J(e-n))),g=1/Math.sin(h),p=h?function(n){var t=Math.sin(n*=h)*g,e=Math.sin(h-n)*g,r=e*c+t*l,u=e*s+t*f,o=e*i+t*a;return[Math.atan2(u,r)*La,Math.atan2(o,Math.sqrt(r*r+u*u))*La]}:function(){return[n*La,t*La]};return p.distance=h,p}function vr(){function n(n,u){var i=Math.sin(u*=Na),o=Math.cos(u),a=oa((n*=Na)-t),c=Math.cos(a);Uc+=Math.atan2(Math.sqrt((a=o*Math.sin(a))*a+(a=r*i-e*o*c)*a),e*i+r*o*c),t=n,e=i,r=o}var t,e,r;jc.point=function(u,i){t=u*Na,e=Math.sin(i*=Na),r=Math.cos(i),jc.point=n},jc.lineEnd=function(){jc.point=jc.lineEnd=g}}function dr(n,t){function e(t,e){var r=Math.cos(t),u=Math.cos(e),i=n(r*u);return[i*u*Math.sin(t),i*Math.sin(e)]}return e.invert=function(n,e){var r=Math.sqrt(n*n+e*e),u=t(r),i=Math.sin(u),o=Math.cos(u);return[Math.atan2(n*i,r*o),Math.asin(r&&e*i/r)]},e}function mr(n,t){function e(n,t){var e=oa(oa(t)-Ea)<Aa?0:o/Math.pow(u(t),i);return[e*Math.sin(i*n),o-e*Math.cos(i*n)]}var r=Math.cos(n),u=function(n){return Math.tan(Sa/4+n/2)},i=n===t?Math.sin(n):Math.log(r/Math.cos(t))/Math.log(u(t)/u(n)),o=r*Math.pow(u(n),i)/i;return i?(e.invert=function(n,t){var e=o-t,r=I(i)*Math.sqrt(n*n+e*e);return[Math.atan2(n,e)/i,2*Math.atan(Math.pow(o/r,1/i))-Ea]},e):xr}function yr(n,t){function e(n,t){var e=i-t;return[e*Math.sin(u*n),i-e*Math.cos(u*n)]}var r=Math.cos(n),u=n===t?Math.sin(n):(r-Math.cos(t))/(t-n),i=r/u+n;return oa(u)<Aa?er:(e.invert=function(n,t){var e=i-t;return[Math.atan2(n,e)/u,i-I(u)*Math.sqrt(n*n+e*e)]},e)}function xr(n,t){return[n,Math.log(Math.tan(Sa/4+t/2))]}function Mr(n){var t,e=Qe(n),r=e.scale,u=e.translate,i=e.clipExtent;return e.scale=function(){var n=r.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.translate=function(){var n=u.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.clipExtent=function(n){var o=i.apply(e,arguments);if(o===e){if(t=null==n){var a=Sa*r(),c=u();i([[c[0]-a,c[1]-a],[c[0]+a,c[1]+a]])}}else t&&(o=null);return o},e.clipExtent(null)}function _r(n,t){return[Math.log(Math.tan(Sa/4+t/2)),-n]}function br(n){return n[0]}function wr(n){return n[1]}function Sr(n){for(var t=n.length,e=[0,1],r=2,u=2;t>u;u++){for(;r>1&&Z(n[e[r-2]],n[e[r-1]],n[u])<=0;)--r;e[r++]=u}return e.slice(0,r)}function kr(n,t){return n[0]-t[0]||n[1]-t[1]}function Er(n,t,e){return(e[0]-t[0])*(n[1]-t[1])<(e[1]-t[1])*(n[0]-t[0])}function Ar(n,t,e,r){var u=n[0],i=e[0],o=t[0]-u,a=r[0]-i,c=n[1],s=e[1],l=t[1]-c,f=r[1]-s,h=(a*(c-s)-f*(u-i))/(f*o-a*l);return[u+h*o,c+h*l]}function Cr(n){var t=n[0],e=n[n.length-1];return!(t[0]-e[0]||t[1]-e[1])}function Nr(){Jr(this),this.edge=this.site=this.circle=null}function Lr(n){var t=Jc.pop()||new Nr;return t.site=n,t}function zr(n){Or(n),$c.remove(n),Jc.push(n),Jr(n)}function qr(n){var t=n.circle,e=t.x,r=t.cy,u={x:e,y:r},i=n.P,o=n.N,a=[n];zr(n);for(var c=i;c.circle&&oa(e-c.circle.x)<Aa&&oa(r-c.circle.cy)<Aa;)i=c.P,a.unshift(c),zr(c),c=i;a.unshift(c),Or(c);for(var s=o;s.circle&&oa(e-s.circle.x)<Aa&&oa(r-s.circle.cy)<Aa;)o=s.N,a.push(s),zr(s),s=o;a.push(s),Or(s);var l,f=a.length;for(l=1;f>l;++l)s=a[l],c=a[l-1],$r(s.edge,c.site,s.site,u);c=a[0],s=a[f-1],s.edge=Vr(c.site,s.site,null,u),Fr(c),Fr(s)}function Tr(n){for(var t,e,r,u,i=n.x,o=n.y,a=$c._;a;)if(r=Rr(a,o)-i,r>Aa)a=a.L;else{if(u=i-Dr(a,o),!(u>Aa)){r>-Aa?(t=a.P,e=a):u>-Aa?(t=a,e=a.N):t=e=a;break}if(!a.R){t=a;break}a=a.R}var c=Lr(n);if($c.insert(t,c),t||e){if(t===e)return Or(t),e=Lr(t.site),$c.insert(c,e),c.edge=e.edge=Vr(t.site,c.site),Fr(t),Fr(e),void 0;if(!e)return c.edge=Vr(t.site,c.site),void 0;Or(t),Or(e);var s=t.site,l=s.x,f=s.y,h=n.x-l,g=n.y-f,p=e.site,v=p.x-l,d=p.y-f,m=2*(h*d-g*v),y=h*h+g*g,x=v*v+d*d,M={x:(d*y-g*x)/m+l,y:(h*x-v*y)/m+f};$r(e.edge,s,p,M),c.edge=Vr(s,n,null,M),e.edge=Vr(n,p,null,M),Fr(t),Fr(e)}}function Rr(n,t){var e=n.site,r=e.x,u=e.y,i=u-t;if(!i)return r;var o=n.P;if(!o)return-1/0;e=o.site;var a=e.x,c=e.y,s=c-t;if(!s)return a;var l=a-r,f=1/i-1/s,h=l/s;return f?(-h+Math.sqrt(h*h-2*f*(l*l/(-2*s)-c+s/2+u-i/2)))/f+r:(r+a)/2}function Dr(n,t){var e=n.N;if(e)return Rr(e,t);var r=n.site;return r.y===t?r.x:1/0}function Pr(n){this.site=n,this.edges=[]}function Ur(n){for(var t,e,r,u,i,o,a,c,s,l,f=n[0][0],h=n[1][0],g=n[0][1],p=n[1][1],v=Xc,d=v.length;d--;)if(i=v[d],i&&i.prepare())for(a=i.edges,c=a.length,o=0;c>o;)l=a[o].end(),r=l.x,u=l.y,s=a[++o%c].start(),t=s.x,e=s.y,(oa(r-t)>Aa||oa(u-e)>Aa)&&(a.splice(o,0,new Br(Xr(i.site,l,oa(r-f)<Aa&&p-u>Aa?{x:f,y:oa(t-f)<Aa?e:p}:oa(u-p)<Aa&&h-r>Aa?{x:oa(e-p)<Aa?t:h,y:p}:oa(r-h)<Aa&&u-g>Aa?{x:h,y:oa(t-h)<Aa?e:g}:oa(u-g)<Aa&&r-f>Aa?{x:oa(e-g)<Aa?t:f,y:g}:null),i.site,null)),++c)}function jr(n,t){return t.angle-n.angle}function Hr(){Jr(this),this.x=this.y=this.arc=this.site=this.cy=null}function Fr(n){var t=n.P,e=n.N;if(t&&e){var r=t.site,u=n.site,i=e.site;if(r!==i){var o=u.x,a=u.y,c=r.x-o,s=r.y-a,l=i.x-o,f=i.y-a,h=2*(c*f-s*l);if(!(h>=-Ca)){var g=c*c+s*s,p=l*l+f*f,v=(f*g-s*p)/h,d=(c*p-l*g)/h,f=d+a,m=Gc.pop()||new Hr;m.arc=n,m.site=u,m.x=v+o,m.y=f+Math.sqrt(v*v+d*d),m.cy=f,n.circle=m;for(var y=null,x=Wc._;x;)if(m.y<x.y||m.y===x.y&&m.x<=x.x){if(!x.L){y=x.P;break}x=x.L}else{if(!x.R){y=x;break}x=x.R}Wc.insert(y,m),y||(Bc=m)}}}}function Or(n){var t=n.circle;t&&(t.P||(Bc=t.N),Wc.remove(t),Gc.push(t),Jr(t),n.circle=null)}function Yr(n){for(var t,e=Vc,r=De(n[0][0],n[0][1],n[1][0],n[1][1]),u=e.length;u--;)t=e[u],(!Ir(t,n)||!r(t)||oa(t.a.x-t.b.x)<Aa&&oa(t.a.y-t.b.y)<Aa)&&(t.a=t.b=null,e.splice(u,1))}function Ir(n,t){var e=n.b;if(e)return!0;var r,u,i=n.a,o=t[0][0],a=t[1][0],c=t[0][1],s=t[1][1],l=n.l,f=n.r,h=l.x,g=l.y,p=f.x,v=f.y,d=(h+p)/2,m=(g+v)/2;if(v===g){if(o>d||d>=a)return;if(h>p){if(i){if(i.y>=s)return}else i={x:d,y:c};e={x:d,y:s}}else{if(i){if(i.y<c)return}else i={x:d,y:s};e={x:d,y:c}}}else if(r=(h-p)/(v-g),u=m-r*d,-1>r||r>1)if(h>p){if(i){if(i.y>=s)return}else i={x:(c-u)/r,y:c};e={x:(s-u)/r,y:s}}else{if(i){if(i.y<c)return}else i={x:(s-u)/r,y:s};e={x:(c-u)/r,y:c}}else if(v>g){if(i){if(i.x>=a)return}else i={x:o,y:r*o+u};e={x:a,y:r*a+u}}else{if(i){if(i.x<o)return}else i={x:a,y:r*a+u};e={x:o,y:r*o+u}}return n.a=i,n.b=e,!0}function Zr(n,t){this.l=n,this.r=t,this.a=this.b=null}function Vr(n,t,e,r){var u=new Zr(n,t);return Vc.push(u),e&&$r(u,n,t,e),r&&$r(u,t,n,r),Xc[n.i].edges.push(new Br(u,n,t)),Xc[t.i].edges.push(new Br(u,t,n)),u}function Xr(n,t,e){var r=new Zr(n,null);return r.a=t,r.b=e,Vc.push(r),r}function $r(n,t,e,r){n.a||n.b?n.l===e?n.b=r:n.a=r:(n.a=r,n.l=t,n.r=e)}function Br(n,t,e){var r=n.a,u=n.b;this.edge=n,this.site=t,this.angle=e?Math.atan2(e.y-t.y,e.x-t.x):n.l===t?Math.atan2(u.x-r.x,r.y-u.y):Math.atan2(r.x-u.x,u.y-r.y)}function Wr(){this._=null}function Jr(n){n.U=n.C=n.L=n.R=n.P=n.N=null}function Gr(n,t){var e=t,r=t.R,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.R=r.L,e.R&&(e.R.U=e),r.L=e}function Kr(n,t){var e=t,r=t.L,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.L=r.R,e.L&&(e.L.U=e),r.R=e}function Qr(n){for(;n.L;)n=n.L;return n}function nu(n,t){var e,r,u,i=n.sort(tu).pop();for(Vc=[],Xc=new Array(n.length),$c=new Wr,Wc=new Wr;;)if(u=Bc,i&&(!u||i.y<u.y||i.y===u.y&&i.x<u.x))(i.x!==e||i.y!==r)&&(Xc[i.i]=new Pr(i),Tr(i),e=i.x,r=i.y),i=n.pop();else{if(!u)break;qr(u.arc)}t&&(Yr(t),Ur(t));var o={cells:Xc,edges:Vc};return $c=Wc=Vc=Xc=null,o}function tu(n,t){return t.y-n.y||t.x-n.x}function eu(n,t,e){return(n.x-e.x)*(t.y-n.y)-(n.x-t.x)*(e.y-n.y)}function ru(n){return n.x}function uu(n){return n.y}function iu(){return{leaf:!0,nodes:[],point:null,x:null,y:null}}function ou(n,t,e,r,u,i){if(!n(t,e,r,u,i)){var o=.5*(e+u),a=.5*(r+i),c=t.nodes;c[0]&&ou(n,c[0],e,r,o,a),c[1]&&ou(n,c[1],o,r,u,a),c[2]&&ou(n,c[2],e,a,o,i),c[3]&&ou(n,c[3],o,a,u,i)}}function au(n,t){n=Xo.rgb(n),t=Xo.rgb(t);var e=n.r,r=n.g,u=n.b,i=t.r-e,o=t.g-r,a=t.b-u;return function(n){return"#"+vt(Math.round(e+i*n))+vt(Math.round(r+o*n))+vt(Math.round(u+a*n))}}function cu(n,t){var e,r={},u={};for(e in n)e in t?r[e]=fu(n[e],t[e]):u[e]=n[e];for(e in t)e in n||(u[e]=t[e]);return function(n){for(e in r)u[e]=r[e](n);return u}}function su(n,t){return t-=n=+n,function(e){return n+t*e}}function lu(n,t){var e,r,u,i,o,a=0,c=0,s=[],l=[];for(n+="",t+="",Qc.lastIndex=0,r=0;e=Qc.exec(t);++r)e.index&&s.push(t.substring(a,c=e.index)),l.push({i:s.length,x:e[0]}),s.push(null),a=Qc.lastIndex;for(a<t.length&&s.push(t.substring(a)),r=0,i=l.length;(e=Qc.exec(n))&&i>r;++r)if(o=l[r],o.x==e[0]){if(o.i)if(null==s[o.i+1])for(s[o.i-1]+=o.x,s.splice(o.i,1),u=r+1;i>u;++u)l[u].i--;else for(s[o.i-1]+=o.x+s[o.i+1],s.splice(o.i,2),u=r+1;i>u;++u)l[u].i-=2;else if(null==s[o.i+1])s[o.i]=o.x;else for(s[o.i]=o.x+s[o.i+1],s.splice(o.i+1,1),u=r+1;i>u;++u)l[u].i--;l.splice(r,1),i--,r--}else o.x=su(parseFloat(e[0]),parseFloat(o.x));for(;i>r;)o=l.pop(),null==s[o.i+1]?s[o.i]=o.x:(s[o.i]=o.x+s[o.i+1],s.splice(o.i+1,1)),i--;return 1===s.length?null==s[0]?(o=l[0].x,function(n){return o(n)+""}):function(){return t}:function(n){for(r=0;i>r;++r)s[(o=l[r]).i]=o.x(n);return s.join("")}}function fu(n,t){for(var e,r=Xo.interpolators.length;--r>=0&&!(e=Xo.interpolators[r](n,t)););return e}function hu(n,t){var e,r=[],u=[],i=n.length,o=t.length,a=Math.min(n.length,t.length);for(e=0;a>e;++e)r.push(fu(n[e],t[e]));for(;i>e;++e)u[e]=n[e];for(;o>e;++e)u[e]=t[e];return function(n){for(e=0;a>e;++e)u[e]=r[e](n);return u}}function gu(n){return function(t){return 0>=t?0:t>=1?1:n(t)}}function pu(n){return function(t){return 1-n(1-t)}}function vu(n){return function(t){return.5*(.5>t?n(2*t):2-n(2-2*t))}}function du(n){return n*n}function mu(n){return n*n*n}function yu(n){if(0>=n)return 0;if(n>=1)return 1;var t=n*n,e=t*n;return 4*(.5>n?e:3*(n-t)+e-.75)}function xu(n){return function(t){return Math.pow(t,n)}}function Mu(n){return 1-Math.cos(n*Ea)}function _u(n){return Math.pow(2,10*(n-1))}function bu(n){return 1-Math.sqrt(1-n*n)}function wu(n,t){var e;return arguments.length<2&&(t=.45),arguments.length?e=t/ka*Math.asin(1/n):(n=1,e=t/4),function(r){return 1+n*Math.pow(2,-10*r)*Math.sin((r-e)*ka/t)}}function Su(n){return n||(n=1.70158),function(t){return t*t*((n+1)*t-n)}}function ku(n){return 1/2.75>n?7.5625*n*n:2/2.75>n?7.5625*(n-=1.5/2.75)*n+.75:2.5/2.75>n?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375}function Eu(n,t){n=Xo.hcl(n),t=Xo.hcl(t);var e=n.h,r=n.c,u=n.l,i=t.h-e,o=t.c-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.c:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return rt(e+i*n,r+o*n,u+a*n)+""}}function Au(n,t){n=Xo.hsl(n),t=Xo.hsl(t);var e=n.h,r=n.s,u=n.l,i=t.h-e,o=t.s-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.s:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return nt(e+i*n,r+o*n,u+a*n)+""}}function Cu(n,t){n=Xo.lab(n),t=Xo.lab(t);var e=n.l,r=n.a,u=n.b,i=t.l-e,o=t.a-r,a=t.b-u;return function(n){return ot(e+i*n,r+o*n,u+a*n)+""}}function Nu(n,t){return t-=n,function(e){return Math.round(n+t*e)}}function Lu(n){var t=[n.a,n.b],e=[n.c,n.d],r=qu(t),u=zu(t,e),i=qu(Tu(e,t,-u))||0;t[0]*e[1]<e[0]*t[1]&&(t[0]*=-1,t[1]*=-1,r*=-1,u*=-1),this.rotate=(r?Math.atan2(t[1],t[0]):Math.atan2(-e[0],e[1]))*La,this.translate=[n.e,n.f],this.scale=[r,i],this.skew=i?Math.atan2(u,i)*La:0}function zu(n,t){return n[0]*t[0]+n[1]*t[1]}function qu(n){var t=Math.sqrt(zu(n,n));return t&&(n[0]/=t,n[1]/=t),t}function Tu(n,t,e){return n[0]+=e*t[0],n[1]+=e*t[1],n}function Ru(n,t){var e,r=[],u=[],i=Xo.transform(n),o=Xo.transform(t),a=i.translate,c=o.translate,s=i.rotate,l=o.rotate,f=i.skew,h=o.skew,g=i.scale,p=o.scale;return a[0]!=c[0]||a[1]!=c[1]?(r.push("translate(",null,",",null,")"),u.push({i:1,x:su(a[0],c[0])},{i:3,x:su(a[1],c[1])})):c[0]||c[1]?r.push("translate("+c+")"):r.push(""),s!=l?(s-l>180?l+=360:l-s>180&&(s+=360),u.push({i:r.push(r.pop()+"rotate(",null,")")-2,x:su(s,l)})):l&&r.push(r.pop()+"rotate("+l+")"),f!=h?u.push({i:r.push(r.pop()+"skewX(",null,")")-2,x:su(f,h)}):h&&r.push(r.pop()+"skewX("+h+")"),g[0]!=p[0]||g[1]!=p[1]?(e=r.push(r.pop()+"scale(",null,",",null,")"),u.push({i:e-4,x:su(g[0],p[0])},{i:e-2,x:su(g[1],p[1])})):(1!=p[0]||1!=p[1])&&r.push(r.pop()+"scale("+p+")"),e=u.length,function(n){for(var t,i=-1;++i<e;)r[(t=u[i]).i]=t.x(n);return r.join("")}}function Du(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return(e-n)*t}}function Pu(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return Math.max(0,Math.min(1,(e-n)*t))}}function Uu(n){for(var t=n.source,e=n.target,r=Hu(t,e),u=[t];t!==r;)t=t.parent,u.push(t);for(var i=u.length;e!==r;)u.splice(i,0,e),e=e.parent;return u}function ju(n){for(var t=[],e=n.parent;null!=e;)t.push(n),n=e,e=e.parent;return t.push(n),t}function Hu(n,t){if(n===t)return n;for(var e=ju(n),r=ju(t),u=e.pop(),i=r.pop(),o=null;u===i;)o=u,u=e.pop(),i=r.pop();return o}function Fu(n){n.fixed|=2}function Ou(n){n.fixed&=-7}function Yu(n){n.fixed|=4,n.px=n.x,n.py=n.y}function Iu(n){n.fixed&=-5}function Zu(n,t,e){var r=0,u=0;if(n.charge=0,!n.leaf)for(var i,o=n.nodes,a=o.length,c=-1;++c<a;)i=o[c],null!=i&&(Zu(i,t,e),n.charge+=i.charge,r+=i.charge*i.cx,u+=i.charge*i.cy);if(n.point){n.leaf||(n.point.x+=Math.random()-.5,n.point.y+=Math.random()-.5);var s=t*e[n.point.index];n.charge+=n.pointCharge=s,r+=s*n.point.x,u+=s*n.point.y}n.cx=r/n.charge,n.cy=u/n.charge}function Vu(n,t){return Xo.rebind(n,t,"sort","children","value"),n.nodes=n,n.links=Wu,n}function Xu(n){return n.children}function $u(n){return n.value}function Bu(n,t){return t.value-n.value}function Wu(n){return Xo.merge(n.map(function(n){return(n.children||[]).map(function(t){return{source:n,target:t}})}))}function Ju(n){return n.x}function Gu(n){return n.y}function Ku(n,t,e){n.y0=t,n.y=e}function Qu(n){return Xo.range(n.length)}function ni(n){for(var t=-1,e=n[0].length,r=[];++t<e;)r[t]=0;return r}function ti(n){for(var t,e=1,r=0,u=n[0][1],i=n.length;i>e;++e)(t=n[e][1])>u&&(r=e,u=t);return r}function ei(n){return n.reduce(ri,0)}function ri(n,t){return n+t[1]}function ui(n,t){return ii(n,Math.ceil(Math.log(t.length)/Math.LN2+1))}function ii(n,t){for(var e=-1,r=+n[0],u=(n[1]-r)/t,i=[];++e<=t;)i[e]=u*e+r;return i}function oi(n){return[Xo.min(n),Xo.max(n)]}function ai(n,t){return n.parent==t.parent?1:2}function ci(n){var t=n.children;return t&&t.length?t[0]:n._tree.thread}function si(n){var t,e=n.children;return e&&(t=e.length)?e[t-1]:n._tree.thread}function li(n,t){var e=n.children;if(e&&(u=e.length))for(var r,u,i=-1;++i<u;)t(r=li(e[i],t),n)>0&&(n=r);return n}function fi(n,t){return n.x-t.x}function hi(n,t){return t.x-n.x}function gi(n,t){return n.depth-t.depth}function pi(n,t){function e(n,r){var u=n.children;if(u&&(o=u.length))for(var i,o,a=null,c=-1;++c<o;)i=u[c],e(i,a),a=i;t(n,r)}e(n,null)}function vi(n){for(var t,e=0,r=0,u=n.children,i=u.length;--i>=0;)t=u[i]._tree,t.prelim+=e,t.mod+=e,e+=t.shift+(r+=t.change)}function di(n,t,e){n=n._tree,t=t._tree;var r=e/(t.number-n.number);n.change+=r,t.change-=r,t.shift+=e,t.prelim+=e,t.mod+=e}function mi(n,t,e){return n._tree.ancestor.parent==t.parent?n._tree.ancestor:e}function yi(n,t){return n.value-t.value}function xi(n,t){var e=n._pack_next;n._pack_next=t,t._pack_prev=n,t._pack_next=e,e._pack_prev=t}function Mi(n,t){n._pack_next=t,t._pack_prev=n}function _i(n,t){var e=t.x-n.x,r=t.y-n.y,u=n.r+t.r;return.999*u*u>e*e+r*r}function bi(n){function t(n){l=Math.min(n.x-n.r,l),f=Math.max(n.x+n.r,f),h=Math.min(n.y-n.r,h),g=Math.max(n.y+n.r,g)}if((e=n.children)&&(s=e.length)){var e,r,u,i,o,a,c,s,l=1/0,f=-1/0,h=1/0,g=-1/0;if(e.forEach(wi),r=e[0],r.x=-r.r,r.y=0,t(r),s>1&&(u=e[1],u.x=u.r,u.y=0,t(u),s>2))for(i=e[2],Ei(r,u,i),t(i),xi(r,i),r._pack_prev=i,xi(i,u),u=r._pack_next,o=3;s>o;o++){Ei(r,u,i=e[o]);var p=0,v=1,d=1;for(a=u._pack_next;a!==u;a=a._pack_next,v++)if(_i(a,i)){p=1;break}if(1==p)for(c=r._pack_prev;c!==a._pack_prev&&!_i(c,i);c=c._pack_prev,d++);p?(d>v||v==d&&u.r<r.r?Mi(r,u=a):Mi(r=c,u),o--):(xi(r,i),u=i,t(i))}var m=(l+f)/2,y=(h+g)/2,x=0;for(o=0;s>o;o++)i=e[o],i.x-=m,i.y-=y,x=Math.max(x,i.r+Math.sqrt(i.x*i.x+i.y*i.y));n.r=x,e.forEach(Si)}}function wi(n){n._pack_next=n._pack_prev=n}function Si(n){delete n._pack_next,delete n._pack_prev}function ki(n,t,e,r){var u=n.children;if(n.x=t+=r*n.x,n.y=e+=r*n.y,n.r*=r,u)for(var i=-1,o=u.length;++i<o;)ki(u[i],t,e,r)}function Ei(n,t,e){var r=n.r+e.r,u=t.x-n.x,i=t.y-n.y;if(r&&(u||i)){var o=t.r+e.r,a=u*u+i*i;o*=o,r*=r;var c=.5+(r-o)/(2*a),s=Math.sqrt(Math.max(0,2*o*(r+a)-(r-=a)*r-o*o))/(2*a);e.x=n.x+c*u+s*i,e.y=n.y+c*i-s*u}else e.x=n.x+r,e.y=n.y}function Ai(n){return 1+Xo.max(n,function(n){return n.y})}function Ci(n){return n.reduce(function(n,t){return n+t.x},0)/n.length}function Ni(n){var t=n.children;return t&&t.length?Ni(t[0]):n}function Li(n){var t,e=n.children;return e&&(t=e.length)?Li(e[t-1]):n}function zi(n){return{x:n.x,y:n.y,dx:n.dx,dy:n.dy}}function qi(n,t){var e=n.x+t[3],r=n.y+t[0],u=n.dx-t[1]-t[3],i=n.dy-t[0]-t[2];return 0>u&&(e+=u/2,u=0),0>i&&(r+=i/2,i=0),{x:e,y:r,dx:u,dy:i}}function Ti(n){var t=n[0],e=n[n.length-1];return e>t?[t,e]:[e,t]}function Ri(n){return n.rangeExtent?n.rangeExtent():Ti(n.range())}function Di(n,t,e,r){var u=e(n[0],n[1]),i=r(t[0],t[1]);return function(n){return i(u(n))}}function Pi(n,t){var e,r=0,u=n.length-1,i=n[r],o=n[u];return i>o&&(e=r,r=u,u=e,e=i,i=o,o=e),n[r]=t.floor(i),n[u]=t.ceil(o),n}function Ui(n){return n?{floor:function(t){return Math.floor(t/n)*n},ceil:function(t){return Math.ceil(t/n)*n}}:ls}function ji(n,t,e,r){var u=[],i=[],o=0,a=Math.min(n.length,t.length)-1;for(n[a]<n[0]&&(n=n.slice().reverse(),t=t.slice().reverse());++o<=a;)u.push(e(n[o-1],n[o])),i.push(r(t[o-1],t[o]));return function(t){var e=Xo.bisect(n,t,1,a)-1;return i[e](u[e](t))}}function Hi(n,t,e,r){function u(){var u=Math.min(n.length,t.length)>2?ji:Di,c=r?Pu:Du;return o=u(n,t,c,e),a=u(t,n,c,fu),i}function i(n){return o(n)}var o,a;return i.invert=function(n){return a(n)},i.domain=function(t){return arguments.length?(n=t.map(Number),u()):n},i.range=function(n){return arguments.length?(t=n,u()):t},i.rangeRound=function(n){return i.range(n).interpolate(Nu)},i.clamp=function(n){return arguments.length?(r=n,u()):r},i.interpolate=function(n){return arguments.length?(e=n,u()):e},i.ticks=function(t){return Ii(n,t)},i.tickFormat=function(t,e){return Zi(n,t,e)},i.nice=function(t){return Oi(n,t),u()},i.copy=function(){return Hi(n,t,e,r)},u()}function Fi(n,t){return Xo.rebind(n,t,"range","rangeRound","interpolate","clamp")}function Oi(n,t){return Pi(n,Ui(Yi(n,t)[2]))}function Yi(n,t){null==t&&(t=10);var e=Ti(n),r=e[1]-e[0],u=Math.pow(10,Math.floor(Math.log(r/t)/Math.LN10)),i=t/r*u;return.15>=i?u*=10:.35>=i?u*=5:.75>=i&&(u*=2),e[0]=Math.ceil(e[0]/u)*u,e[1]=Math.floor(e[1]/u)*u+.5*u,e[2]=u,e}function Ii(n,t){return Xo.range.apply(Xo,Yi(n,t))}function Zi(n,t,e){var r=Yi(n,t);return Xo.format(e?e.replace(Qa,function(n,t,e,u,i,o,a,c,s,l){return[t,e,u,i,o,a,c,s||"."+Xi(l,r),l].join("")}):",."+Vi(r[2])+"f")}function Vi(n){return-Math.floor(Math.log(n)/Math.LN10+.01)}function Xi(n,t){var e=Vi(t[2]);return n in fs?Math.abs(e-Vi(Math.max(Math.abs(t[0]),Math.abs(t[1]))))+ +("e"!==n):e-2*("%"===n)}function $i(n,t,e,r){function u(n){return(e?Math.log(0>n?0:n):-Math.log(n>0?0:-n))/Math.log(t)}function i(n){return e?Math.pow(t,n):-Math.pow(t,-n)}function o(t){return n(u(t))}return o.invert=function(t){return i(n.invert(t))},o.domain=function(t){return arguments.length?(e=t[0]>=0,n.domain((r=t.map(Number)).map(u)),o):r},o.base=function(e){return arguments.length?(t=+e,n.domain(r.map(u)),o):t},o.nice=function(){var t=Pi(r.map(u),e?Math:gs);return n.domain(t),r=t.map(i),o},o.ticks=function(){var n=Ti(r),o=[],a=n[0],c=n[1],s=Math.floor(u(a)),l=Math.ceil(u(c)),f=t%1?2:t;if(isFinite(l-s)){if(e){for(;l>s;s++)for(var h=1;f>h;h++)o.push(i(s)*h);o.push(i(s))}else for(o.push(i(s));s++<l;)for(var h=f-1;h>0;h--)o.push(i(s)*h);for(s=0;o[s]<a;s++);for(l=o.length;o[l-1]>c;l--);o=o.slice(s,l)}return o},o.tickFormat=function(n,t){if(!arguments.length)return hs;arguments.length<2?t=hs:"function"!=typeof t&&(t=Xo.format(t));var r,a=Math.max(.1,n/o.ticks().length),c=e?(r=1e-12,Math.ceil):(r=-1e-12,Math.floor);return function(n){return n/i(c(u(n)+r))<=a?t(n):""}},o.copy=function(){return $i(n.copy(),t,e,r)},Fi(o,n)}function Bi(n,t,e){function r(t){return n(u(t))}var u=Wi(t),i=Wi(1/t);return r.invert=function(t){return i(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain((e=t.map(Number)).map(u)),r):e},r.ticks=function(n){return Ii(e,n)},r.tickFormat=function(n,t){return Zi(e,n,t)},r.nice=function(n){return r.domain(Oi(e,n))},r.exponent=function(o){return arguments.length?(u=Wi(t=o),i=Wi(1/t),n.domain(e.map(u)),r):t},r.copy=function(){return Bi(n.copy(),t,e)},Fi(r,n)}function Wi(n){return function(t){return 0>t?-Math.pow(-t,n):Math.pow(t,n)}}function Ji(n,t){function e(e){return o[((i.get(e)||"range"===t.t&&i.set(e,n.push(e)))-1)%o.length]}function r(t,e){return Xo.range(n.length).map(function(n){return t+e*n})}var i,o,a;return e.domain=function(r){if(!arguments.length)return n;n=[],i=new u;for(var o,a=-1,c=r.length;++a<c;)i.has(o=r[a])||i.set(o,n.push(o));return e[t.t].apply(e,t.a)},e.range=function(n){return arguments.length?(o=n,a=0,t={t:"range",a:arguments},e):o},e.rangePoints=function(u,i){arguments.length<2&&(i=0);var c=u[0],s=u[1],l=(s-c)/(Math.max(1,n.length-1)+i);return o=r(n.length<2?(c+s)/2:c+l*i/2,l),a=0,t={t:"rangePoints",a:arguments},e},e.rangeBands=function(u,i,c){arguments.length<2&&(i=0),arguments.length<3&&(c=i);var s=u[1]<u[0],l=u[s-0],f=u[1-s],h=(f-l)/(n.length-i+2*c);return o=r(l+h*c,h),s&&o.reverse(),a=h*(1-i),t={t:"rangeBands",a:arguments},e},e.rangeRoundBands=function(u,i,c){arguments.length<2&&(i=0),arguments.length<3&&(c=i);var s=u[1]<u[0],l=u[s-0],f=u[1-s],h=Math.floor((f-l)/(n.length-i+2*c)),g=f-l-(n.length-i)*h;return o=r(l+Math.round(g/2),h),s&&o.reverse(),a=Math.round(h*(1-i)),t={t:"rangeRoundBands",a:arguments},e},e.rangeBand=function(){return a},e.rangeExtent=function(){return Ti(t.a[0])},e.copy=function(){return Ji(n,t)},e.domain(n)}function Gi(n,t){function e(){var e=0,i=t.length;for(u=[];++e<i;)u[e-1]=Xo.quantile(n,e/i);return r}function r(n){return isNaN(n=+n)?void 0:t[Xo.bisect(u,n)]}var u;return r.domain=function(t){return arguments.length?(n=t.filter(function(n){return!isNaN(n)}).sort(Xo.ascending),e()):n},r.range=function(n){return arguments.length?(t=n,e()):t},r.quantiles=function(){return u},r.invertExtent=function(e){return e=t.indexOf(e),0>e?[0/0,0/0]:[e>0?u[e-1]:n[0],e<u.length?u[e]:n[n.length-1]]},r.copy=function(){return Gi(n,t)},e()}function Ki(n,t,e){function r(t){return e[Math.max(0,Math.min(o,Math.floor(i*(t-n))))]}function u(){return i=e.length/(t-n),o=e.length-1,r}var i,o;return r.domain=function(e){return arguments.length?(n=+e[0],t=+e[e.length-1],u()):[n,t]},r.range=function(n){return arguments.length?(e=n,u()):e},r.invertExtent=function(t){return t=e.indexOf(t),t=0>t?0/0:t/i+n,[t,t+1/i]},r.copy=function(){return Ki(n,t,e)},u()}function Qi(n,t){function e(e){return e>=e?t[Xo.bisect(n,e)]:void 0}return e.domain=function(t){return arguments.length?(n=t,e):n},e.range=function(n){return arguments.length?(t=n,e):t},e.invertExtent=function(e){return e=t.indexOf(e),[n[e-1],n[e]]},e.copy=function(){return Qi(n,t)},e}function no(n){function t(n){return+n}return t.invert=t,t.domain=t.range=function(e){return arguments.length?(n=e.map(t),t):n},t.ticks=function(t){return Ii(n,t)},t.tickFormat=function(t,e){return Zi(n,t,e)},t.copy=function(){return no(n)},t}function to(n){return n.innerRadius}function eo(n){return n.outerRadius}function ro(n){return n.startAngle}function uo(n){return n.endAngle}function io(n){function t(t){function o(){s.push("M",i(n(l),a))}for(var c,s=[],l=[],f=-1,h=t.length,g=_t(e),p=_t(r);++f<h;)u.call(this,c=t[f],f)?l.push([+g.call(this,c,f),+p.call(this,c,f)]):l.length&&(o(),l=[]);return l.length&&o(),s.length?s.join(""):null}var e=br,r=wr,u=be,i=oo,o=i.key,a=.7;return t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t.defined=function(n){return arguments.length?(u=n,t):u},t.interpolate=function(n){return arguments.length?(o="function"==typeof n?i=n:(i=Ms.get(n)||oo).key,t):o},t.tension=function(n){return arguments.length?(a=n,t):a},t}function oo(n){return n.join("L")}function ao(n){return oo(n)+"Z"}function co(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("H",(r[0]+(r=n[t])[0])/2,"V",r[1]);return e>1&&u.push("H",r[0]),u.join("")}function so(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("V",(r=n[t])[1],"H",r[0]);return u.join("")}function lo(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("H",(r=n[t])[0],"V",r[1]);return u.join("")}function fo(n,t){return n.length<4?oo(n):n[1]+po(n.slice(1,n.length-1),vo(n,t))}function ho(n,t){return n.length<3?oo(n):n[0]+po((n.push(n[0]),n),vo([n[n.length-2]].concat(n,[n[1]]),t))}function go(n,t){return n.length<3?oo(n):n[0]+po(n,vo(n,t))}function po(n,t){if(t.length<1||n.length!=t.length&&n.length!=t.length+2)return oo(n);var e=n.length!=t.length,r="",u=n[0],i=n[1],o=t[0],a=o,c=1;if(e&&(r+="Q"+(i[0]-2*o[0]/3)+","+(i[1]-2*o[1]/3)+","+i[0]+","+i[1],u=n[1],c=2),t.length>1){a=t[1],i=n[c],c++,r+="C"+(u[0]+o[0])+","+(u[1]+o[1])+","+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1];for(var s=2;s<t.length;s++,c++)i=n[c],a=t[s],r+="S"+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1]}if(e){var l=n[c];r+="Q"+(i[0]+2*a[0]/3)+","+(i[1]+2*a[1]/3)+","+l[0]+","+l[1]}return r}function vo(n,t){for(var e,r=[],u=(1-t)/2,i=n[0],o=n[1],a=1,c=n.length;++a<c;)e=i,i=o,o=n[a],r.push([u*(o[0]-e[0]),u*(o[1]-e[1])]);return r}function mo(n){if(n.length<3)return oo(n);var t=1,e=n.length,r=n[0],u=r[0],i=r[1],o=[u,u,u,(r=n[1])[0]],a=[i,i,i,r[1]],c=[u,",",i,"L",_o(ws,o),",",_o(ws,a)];for(n.push(n[e-1]);++t<=e;)r=n[t],o.shift(),o.push(r[0]),a.shift(),a.push(r[1]),bo(c,o,a);return n.pop(),c.push("L",r),c.join("")}function yo(n){if(n.length<4)return oo(n);for(var t,e=[],r=-1,u=n.length,i=[0],o=[0];++r<3;)t=n[r],i.push(t[0]),o.push(t[1]);for(e.push(_o(ws,i)+","+_o(ws,o)),--r;++r<u;)t=n[r],i.shift(),i.push(t[0]),o.shift(),o.push(t[1]),bo(e,i,o);return e.join("")}function xo(n){for(var t,e,r=-1,u=n.length,i=u+4,o=[],a=[];++r<4;)e=n[r%u],o.push(e[0]),a.push(e[1]);for(t=[_o(ws,o),",",_o(ws,a)],--r;++r<i;)e=n[r%u],o.shift(),o.push(e[0]),a.shift(),a.push(e[1]),bo(t,o,a);return t.join("")}function Mo(n,t){var e=n.length-1;if(e)for(var r,u,i=n[0][0],o=n[0][1],a=n[e][0]-i,c=n[e][1]-o,s=-1;++s<=e;)r=n[s],u=s/e,r[0]=t*r[0]+(1-t)*(i+u*a),r[1]=t*r[1]+(1-t)*(o+u*c);return mo(n)}function _o(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]*t[3]}function bo(n,t,e){n.push("C",_o(_s,t),",",_o(_s,e),",",_o(bs,t),",",_o(bs,e),",",_o(ws,t),",",_o(ws,e))}function wo(n,t){return(t[1]-n[1])/(t[0]-n[0])}function So(n){for(var t=0,e=n.length-1,r=[],u=n[0],i=n[1],o=r[0]=wo(u,i);++t<e;)r[t]=(o+(o=wo(u=i,i=n[t+1])))/2;return r[t]=o,r}function ko(n){for(var t,e,r,u,i=[],o=So(n),a=-1,c=n.length-1;++a<c;)t=wo(n[a],n[a+1]),oa(t)<Aa?o[a]=o[a+1]=0:(e=o[a]/t,r=o[a+1]/t,u=e*e+r*r,u>9&&(u=3*t/Math.sqrt(u),o[a]=u*e,o[a+1]=u*r));for(a=-1;++a<=c;)u=(n[Math.min(c,a+1)][0]-n[Math.max(0,a-1)][0])/(6*(1+o[a]*o[a])),i.push([u||0,o[a]*u||0]);return i}function Eo(n){return n.length<3?oo(n):n[0]+po(n,ko(n))}function Ao(n){for(var t,e,r,u=-1,i=n.length;++u<i;)t=n[u],e=t[0],r=t[1]+ys,t[0]=e*Math.cos(r),t[1]=e*Math.sin(r);return n}function Co(n){function t(t){function c(){v.push("M",a(n(m),f),l,s(n(d.reverse()),f),"Z")}for(var h,g,p,v=[],d=[],m=[],y=-1,x=t.length,M=_t(e),_=_t(u),b=e===r?function(){return g}:_t(r),w=u===i?function(){return p}:_t(i);++y<x;)o.call(this,h=t[y],y)?(d.push([g=+M.call(this,h,y),p=+_.call(this,h,y)]),m.push([+b.call(this,h,y),+w.call(this,h,y)])):d.length&&(c(),d=[],m=[]);return d.length&&c(),v.length?v.join(""):null}var e=br,r=br,u=0,i=wr,o=be,a=oo,c=a.key,s=a,l="L",f=.7;return t.x=function(n){return arguments.length?(e=r=n,t):r},t.x0=function(n){return arguments.length?(e=n,t):e},t.x1=function(n){return arguments.length?(r=n,t):r},t.y=function(n){return arguments.length?(u=i=n,t):i},t.y0=function(n){return arguments.length?(u=n,t):u},t.y1=function(n){return arguments.length?(i=n,t):i},t.defined=function(n){return arguments.length?(o=n,t):o},t.interpolate=function(n){return arguments.length?(c="function"==typeof n?a=n:(a=Ms.get(n)||oo).key,s=a.reverse||a,l=a.closed?"M":"L",t):c},t.tension=function(n){return arguments.length?(f=n,t):f},t}function No(n){return n.radius}function Lo(n){return[n.x,n.y]}function zo(n){return function(){var t=n.apply(this,arguments),e=t[0],r=t[1]+ys;return[e*Math.cos(r),e*Math.sin(r)]}}function qo(){return 64}function To(){return"circle"}function Ro(n){var t=Math.sqrt(n/Sa);return"M0,"+t+"A"+t+","+t+" 0 1,1 0,"+-t+"A"+t+","+t+" 0 1,1 0,"+t+"Z"}function Do(n,t){return fa(n,Ns),n.id=t,n}function Po(n,t,e,r){var u=n.id;return R(n,"function"==typeof e?function(n,i,o){n.__transition__[u].tween.set(t,r(e.call(n,n.__data__,i,o)))}:(e=r(e),function(n){n.__transition__[u].tween.set(t,e)}))}function Uo(n){return null==n&&(n=""),function(){this.textContent=n}}function jo(n,t,e,r){var i=n.__transition__||(n.__transition__={active:0,count:0}),o=i[e];if(!o){var a=r.time;o=i[e]={tween:new u,time:a,ease:r.ease,delay:r.delay,duration:r.duration},++i.count,Xo.timer(function(r){function u(r){return i.active>e?s():(i.active=e,o.event&&o.event.start.call(n,l,t),o.tween.forEach(function(e,r){(r=r.call(n,l,t))&&v.push(r)}),Xo.timer(function(){return p.c=c(r||1)?be:c,1},0,a),void 0)}function c(r){if(i.active!==e)return s();for(var u=r/g,a=f(u),c=v.length;c>0;)v[--c].call(n,a);return u>=1?(o.event&&o.event.end.call(n,l,t),s()):void 0}function s(){return--i.count?delete i[e]:delete n.__transition__,1}var l=n.__data__,f=o.ease,h=o.delay,g=o.duration,p=Ja,v=[];return p.t=h+a,r>=h?u(r-h):(p.c=u,void 0)},0,a)}}function Ho(n,t){n.attr("transform",function(n){return"translate("+t(n)+",0)"})}function Fo(n,t){n.attr("transform",function(n){return"translate(0,"+t(n)+")"})}function Oo(n){return n.toISOString()}function Yo(n,t,e){function r(t){return n(t)}function u(n,e){var r=n[1]-n[0],u=r/e,i=Xo.bisect(js,u);return i==js.length?[t.year,Yi(n.map(function(n){return n/31536e6}),e)[2]]:i?t[u/js[i-1]<js[i]/u?i-1:i]:[Os,Yi(n,e)[2]]
+}return r.invert=function(t){return Io(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain(t),r):n.domain().map(Io)},r.nice=function(n,t){function e(e){return!isNaN(e)&&!n.range(e,Io(+e+1),t).length}var i=r.domain(),o=Ti(i),a=null==n?u(o,10):"number"==typeof n&&u(o,n);return a&&(n=a[0],t=a[1]),r.domain(Pi(i,t>1?{floor:function(t){for(;e(t=n.floor(t));)t=Io(t-1);return t},ceil:function(t){for(;e(t=n.ceil(t));)t=Io(+t+1);return t}}:n))},r.ticks=function(n,t){var e=Ti(r.domain()),i=null==n?u(e,10):"number"==typeof n?u(e,n):!n.range&&[{range:n},t];return i&&(n=i[0],t=i[1]),n.range(e[0],Io(+e[1]+1),1>t?1:t)},r.tickFormat=function(){return e},r.copy=function(){return Yo(n.copy(),t,e)},Fi(r,n)}function Io(n){return new Date(n)}function Zo(n){return JSON.parse(n.responseText)}function Vo(n){var t=Wo.createRange();return t.selectNode(Wo.body),t.createContextualFragment(n.responseText)}var Xo={version:"3.4.2"};Date.now||(Date.now=function(){return+new Date});var $o=[].slice,Bo=function(n){return $o.call(n)},Wo=document,Jo=Wo.documentElement,Go=window;try{Bo(Jo.childNodes)[0].nodeType}catch(Ko){Bo=function(n){for(var t=n.length,e=new Array(t);t--;)e[t]=n[t];return e}}try{Wo.createElement("div").style.setProperty("opacity",0,"")}catch(Qo){var na=Go.Element.prototype,ta=na.setAttribute,ea=na.setAttributeNS,ra=Go.CSSStyleDeclaration.prototype,ua=ra.setProperty;na.setAttribute=function(n,t){ta.call(this,n,t+"")},na.setAttributeNS=function(n,t,e){ea.call(this,n,t,e+"")},ra.setProperty=function(n,t,e){ua.call(this,n,t+"",e)}}Xo.ascending=function(n,t){return t>n?-1:n>t?1:n>=t?0:0/0},Xo.descending=function(n,t){return n>t?-1:t>n?1:t>=n?0:0/0},Xo.min=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i&&!(null!=(e=n[u])&&e>=e);)e=void 0;for(;++u<i;)null!=(r=n[u])&&e>r&&(e=r)}else{for(;++u<i&&!(null!=(e=t.call(n,n[u],u))&&e>=e);)e=void 0;for(;++u<i;)null!=(r=t.call(n,n[u],u))&&e>r&&(e=r)}return e},Xo.max=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i&&!(null!=(e=n[u])&&e>=e);)e=void 0;for(;++u<i;)null!=(r=n[u])&&r>e&&(e=r)}else{for(;++u<i&&!(null!=(e=t.call(n,n[u],u))&&e>=e);)e=void 0;for(;++u<i;)null!=(r=t.call(n,n[u],u))&&r>e&&(e=r)}return e},Xo.extent=function(n,t){var e,r,u,i=-1,o=n.length;if(1===arguments.length){for(;++i<o&&!(null!=(e=u=n[i])&&e>=e);)e=u=void 0;for(;++i<o;)null!=(r=n[i])&&(e>r&&(e=r),r>u&&(u=r))}else{for(;++i<o&&!(null!=(e=u=t.call(n,n[i],i))&&e>=e);)e=void 0;for(;++i<o;)null!=(r=t.call(n,n[i],i))&&(e>r&&(e=r),r>u&&(u=r))}return[e,u]},Xo.sum=function(n,t){var e,r=0,u=n.length,i=-1;if(1===arguments.length)for(;++i<u;)isNaN(e=+n[i])||(r+=e);else for(;++i<u;)isNaN(e=+t.call(n,n[i],i))||(r+=e);return r},Xo.mean=function(t,e){var r,u=t.length,i=0,o=-1,a=0;if(1===arguments.length)for(;++o<u;)n(r=t[o])&&(i+=(r-i)/++a);else for(;++o<u;)n(r=e.call(t,t[o],o))&&(i+=(r-i)/++a);return a?i:void 0},Xo.quantile=function(n,t){var e=(n.length-1)*t+1,r=Math.floor(e),u=+n[r-1],i=e-r;return i?u+i*(n[r]-u):u},Xo.median=function(t,e){return arguments.length>1&&(t=t.map(e)),t=t.filter(n),t.length?Xo.quantile(t.sort(Xo.ascending),.5):void 0},Xo.bisector=function(n){return{left:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;n.call(t,t[i],i)<e?r=i+1:u=i}return r},right:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;e<n.call(t,t[i],i)?u=i:r=i+1}return r}}};var ia=Xo.bisector(function(n){return n});Xo.bisectLeft=ia.left,Xo.bisect=Xo.bisectRight=ia.right,Xo.shuffle=function(n){for(var t,e,r=n.length;r;)e=0|Math.random()*r--,t=n[r],n[r]=n[e],n[e]=t;return n},Xo.permute=function(n,t){for(var e=t.length,r=new Array(e);e--;)r[e]=n[t[e]];return r},Xo.pairs=function(n){for(var t,e=0,r=n.length-1,u=n[0],i=new Array(0>r?0:r);r>e;)i[e]=[t=u,u=n[++e]];return i},Xo.zip=function(){if(!(u=arguments.length))return[];for(var n=-1,e=Xo.min(arguments,t),r=new Array(e);++n<e;)for(var u,i=-1,o=r[n]=new Array(u);++i<u;)o[i]=arguments[i][n];return r},Xo.transpose=function(n){return Xo.zip.apply(Xo,n)},Xo.keys=function(n){var t=[];for(var e in n)t.push(e);return t},Xo.values=function(n){var t=[];for(var e in n)t.push(n[e]);return t},Xo.entries=function(n){var t=[];for(var e in n)t.push({key:e,value:n[e]});return t},Xo.merge=function(n){for(var t,e,r,u=n.length,i=-1,o=0;++i<u;)o+=n[i].length;for(e=new Array(o);--u>=0;)for(r=n[u],t=r.length;--t>=0;)e[--o]=r[t];return e};var oa=Math.abs;Xo.range=function(n,t,r){if(arguments.length<3&&(r=1,arguments.length<2&&(t=n,n=0)),1/0===(t-n)/r)throw new Error("infinite range");var u,i=[],o=e(oa(r)),a=-1;if(n*=o,t*=o,r*=o,0>r)for(;(u=n+r*++a)>t;)i.push(u/o);else for(;(u=n+r*++a)<t;)i.push(u/o);return i},Xo.map=function(n){var t=new u;if(n instanceof u)n.forEach(function(n,e){t.set(n,e)});else for(var e in n)t.set(e,n[e]);return t},r(u,{has:i,get:function(n){return this[aa+n]},set:function(n,t){return this[aa+n]=t},remove:o,keys:a,values:function(){var n=[];return this.forEach(function(t,e){n.push(e)}),n},entries:function(){var n=[];return this.forEach(function(t,e){n.push({key:t,value:e})}),n},size:c,empty:s,forEach:function(n){for(var t in this)t.charCodeAt(0)===ca&&n.call(this,t.substring(1),this[t])}});var aa="\x00",ca=aa.charCodeAt(0);Xo.nest=function(){function n(t,a,c){if(c>=o.length)return r?r.call(i,a):e?a.sort(e):a;for(var s,l,f,h,g=-1,p=a.length,v=o[c++],d=new u;++g<p;)(h=d.get(s=v(l=a[g])))?h.push(l):d.set(s,[l]);return t?(l=t(),f=function(e,r){l.set(e,n(t,r,c))}):(l={},f=function(e,r){l[e]=n(t,r,c)}),d.forEach(f),l}function t(n,e){if(e>=o.length)return n;var r=[],u=a[e++];return n.forEach(function(n,u){r.push({key:n,values:t(u,e)})}),u?r.sort(function(n,t){return u(n.key,t.key)}):r}var e,r,i={},o=[],a=[];return i.map=function(t,e){return n(e,t,0)},i.entries=function(e){return t(n(Xo.map,e,0),0)},i.key=function(n){return o.push(n),i},i.sortKeys=function(n){return a[o.length-1]=n,i},i.sortValues=function(n){return e=n,i},i.rollup=function(n){return r=n,i},i},Xo.set=function(n){var t=new l;if(n)for(var e=0,r=n.length;r>e;++e)t.add(n[e]);return t},r(l,{has:i,add:function(n){return this[aa+n]=!0,n},remove:function(n){return n=aa+n,n in this&&delete this[n]},values:a,size:c,empty:s,forEach:function(n){for(var t in this)t.charCodeAt(0)===ca&&n.call(this,t.substring(1))}}),Xo.behavior={},Xo.rebind=function(n,t){for(var e,r=1,u=arguments.length;++r<u;)n[e=arguments[r]]=f(n,t,t[e]);return n};var sa=["webkit","ms","moz","Moz","o","O"];Xo.dispatch=function(){for(var n=new p,t=-1,e=arguments.length;++t<e;)n[arguments[t]]=v(n);return n},p.prototype.on=function(n,t){var e=n.indexOf("."),r="";if(e>=0&&(r=n.substring(e+1),n=n.substring(0,e)),n)return arguments.length<2?this[n].on(r):this[n].on(r,t);if(2===arguments.length){if(null==t)for(n in this)this.hasOwnProperty(n)&&this[n].on(r,null);return this}},Xo.event=null,Xo.requote=function(n){return n.replace(la,"\\$&")};var la=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g,fa={}.__proto__?function(n,t){n.__proto__=t}:function(n,t){for(var e in t)n[e]=t[e]},ha=function(n,t){return t.querySelector(n)},ga=function(n,t){return t.querySelectorAll(n)},pa=Jo[h(Jo,"matchesSelector")],va=function(n,t){return pa.call(n,t)};"function"==typeof Sizzle&&(ha=function(n,t){return Sizzle(n,t)[0]||null},ga=function(n,t){return Sizzle.uniqueSort(Sizzle(n,t))},va=Sizzle.matchesSelector),Xo.selection=function(){return xa};var da=Xo.selection.prototype=[];da.select=function(n){var t,e,r,u,i=[];n=M(n);for(var o=-1,a=this.length;++o<a;){i.push(t=[]),t.parentNode=(r=this[o]).parentNode;for(var c=-1,s=r.length;++c<s;)(u=r[c])?(t.push(e=n.call(u,u.__data__,c,o)),e&&"__data__"in u&&(e.__data__=u.__data__)):t.push(null)}return x(i)},da.selectAll=function(n){var t,e,r=[];n=_(n);for(var u=-1,i=this.length;++u<i;)for(var o=this[u],a=-1,c=o.length;++a<c;)(e=o[a])&&(r.push(t=Bo(n.call(e,e.__data__,a,u))),t.parentNode=e);return x(r)};var ma={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};Xo.ns={prefix:ma,qualify:function(n){var t=n.indexOf(":"),e=n;return t>=0&&(e=n.substring(0,t),n=n.substring(t+1)),ma.hasOwnProperty(e)?{space:ma[e],local:n}:n}},da.attr=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node();return n=Xo.ns.qualify(n),n.local?e.getAttributeNS(n.space,n.local):e.getAttribute(n)}for(t in n)this.each(b(t,n[t]));return this}return this.each(b(n,t))},da.classed=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node(),r=(n=k(n)).length,u=-1;if(t=e.classList){for(;++u<r;)if(!t.contains(n[u]))return!1}else for(t=e.getAttribute("class");++u<r;)if(!S(n[u]).test(t))return!1;return!0}for(t in n)this.each(E(t,n[t]));return this}return this.each(E(n,t))},da.style=function(n,t,e){var r=arguments.length;if(3>r){if("string"!=typeof n){2>r&&(t="");for(e in n)this.each(C(e,n[e],t));return this}if(2>r)return Go.getComputedStyle(this.node(),null).getPropertyValue(n);e=""}return this.each(C(n,t,e))},da.property=function(n,t){if(arguments.length<2){if("string"==typeof n)return this.node()[n];for(t in n)this.each(N(t,n[t]));return this}return this.each(N(n,t))},da.text=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.textContent=null==t?"":t}:null==n?function(){this.textContent=""}:function(){this.textContent=n}):this.node().textContent},da.html=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.innerHTML=null==t?"":t}:null==n?function(){this.innerHTML=""}:function(){this.innerHTML=n}):this.node().innerHTML},da.append=function(n){return n=L(n),this.select(function(){return this.appendChild(n.apply(this,arguments))})},da.insert=function(n,t){return n=L(n),t=M(t),this.select(function(){return this.insertBefore(n.apply(this,arguments),t.apply(this,arguments)||null)})},da.remove=function(){return this.each(function(){var n=this.parentNode;n&&n.removeChild(this)})},da.data=function(n,t){function e(n,e){var r,i,o,a=n.length,f=e.length,h=Math.min(a,f),g=new Array(f),p=new Array(f),v=new Array(a);if(t){var d,m=new u,y=new u,x=[];for(r=-1;++r<a;)d=t.call(i=n[r],i.__data__,r),m.has(d)?v[r]=i:m.set(d,i),x.push(d);for(r=-1;++r<f;)d=t.call(e,o=e[r],r),(i=m.get(d))?(g[r]=i,i.__data__=o):y.has(d)||(p[r]=z(o)),y.set(d,o),m.remove(d);for(r=-1;++r<a;)m.has(x[r])&&(v[r]=n[r])}else{for(r=-1;++r<h;)i=n[r],o=e[r],i?(i.__data__=o,g[r]=i):p[r]=z(o);for(;f>r;++r)p[r]=z(e[r]);for(;a>r;++r)v[r]=n[r]}p.update=g,p.parentNode=g.parentNode=v.parentNode=n.parentNode,c.push(p),s.push(g),l.push(v)}var r,i,o=-1,a=this.length;if(!arguments.length){for(n=new Array(a=(r=this[0]).length);++o<a;)(i=r[o])&&(n[o]=i.__data__);return n}var c=D([]),s=x([]),l=x([]);if("function"==typeof n)for(;++o<a;)e(r=this[o],n.call(r,r.parentNode.__data__,o));else for(;++o<a;)e(r=this[o],n);return s.enter=function(){return c},s.exit=function(){return l},s},da.datum=function(n){return arguments.length?this.property("__data__",n):this.property("__data__")},da.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=q(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]),t.parentNode=(e=this[i]).parentNode;for(var a=0,c=e.length;c>a;a++)(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}return x(u)},da.order=function(){for(var n=-1,t=this.length;++n<t;)for(var e,r=this[n],u=r.length-1,i=r[u];--u>=0;)(e=r[u])&&(i&&i!==e.nextSibling&&i.parentNode.insertBefore(e,i),i=e);return this},da.sort=function(n){n=T.apply(this,arguments);for(var t=-1,e=this.length;++t<e;)this[t].sort(n);return this.order()},da.each=function(n){return R(this,function(t,e,r){n.call(t,t.__data__,e,r)})},da.call=function(n){var t=Bo(arguments);return n.apply(t[0]=this,t),this},da.empty=function(){return!this.node()},da.node=function(){for(var n=0,t=this.length;t>n;n++)for(var e=this[n],r=0,u=e.length;u>r;r++){var i=e[r];if(i)return i}return null},da.size=function(){var n=0;return this.each(function(){++n}),n};var ya=[];Xo.selection.enter=D,Xo.selection.enter.prototype=ya,ya.append=da.append,ya.empty=da.empty,ya.node=da.node,ya.call=da.call,ya.size=da.size,ya.select=function(n){for(var t,e,r,u,i,o=[],a=-1,c=this.length;++a<c;){r=(u=this[a]).update,o.push(t=[]),t.parentNode=u.parentNode;for(var s=-1,l=u.length;++s<l;)(i=u[s])?(t.push(r[s]=e=n.call(u.parentNode,i.__data__,s,a)),e.__data__=i.__data__):t.push(null)}return x(o)},ya.insert=function(n,t){return arguments.length<2&&(t=P(this)),da.insert.call(this,n,t)},da.transition=function(){for(var n,t,e=ks||++Ls,r=[],u=Es||{time:Date.now(),ease:yu,delay:0,duration:250},i=-1,o=this.length;++i<o;){r.push(n=[]);for(var a=this[i],c=-1,s=a.length;++c<s;)(t=a[c])&&jo(t,c,e,u),n.push(t)}return Do(r,e)},da.interrupt=function(){return this.each(U)},Xo.select=function(n){var t=["string"==typeof n?ha(n,Wo):n];return t.parentNode=Jo,x([t])},Xo.selectAll=function(n){var t=Bo("string"==typeof n?ga(n,Wo):n);return t.parentNode=Jo,x([t])};var xa=Xo.select(Jo);da.on=function(n,t,e){var r=arguments.length;if(3>r){if("string"!=typeof n){2>r&&(t=!1);for(e in n)this.each(j(e,n[e],t));return this}if(2>r)return(r=this.node()["__on"+n])&&r._;e=!1}return this.each(j(n,t,e))};var Ma=Xo.map({mouseenter:"mouseover",mouseleave:"mouseout"});Ma.forEach(function(n){"on"+n in Wo&&Ma.remove(n)});var _a="onselectstart"in Wo?null:h(Jo.style,"userSelect"),ba=0;Xo.mouse=function(n){return Y(n,m())};var wa=/WebKit/.test(Go.navigator.userAgent)?-1:0;Xo.touches=function(n,t){return arguments.length<2&&(t=m().touches),t?Bo(t).map(function(t){var e=Y(n,t);return e.identifier=t.identifier,e}):[]},Xo.behavior.drag=function(){function n(){this.on("mousedown.drag",o).on("touchstart.drag",a)}function t(){return Xo.event.changedTouches[0].identifier}function e(n,t){return Xo.touches(n).filter(function(n){return n.identifier===t})[0]}function r(n,t,e,r){return function(){function o(){var n=t(l,g),e=n[0]-v[0],r=n[1]-v[1];d|=e|r,v=n,f({type:"drag",x:n[0]+c[0],y:n[1]+c[1],dx:e,dy:r})}function a(){m.on(e+"."+p,null).on(r+"."+p,null),y(d&&Xo.event.target===h),f({type:"dragend"})}var c,s=this,l=s.parentNode,f=u.of(s,arguments),h=Xo.event.target,g=n(),p=null==g?"drag":"drag-"+g,v=t(l,g),d=0,m=Xo.select(Go).on(e+"."+p,o).on(r+"."+p,a),y=O();i?(c=i.apply(s,arguments),c=[c.x-v[0],c.y-v[1]]):c=[0,0],f({type:"dragstart"})}}var u=y(n,"drag","dragstart","dragend"),i=null,o=r(g,Xo.mouse,"mousemove","mouseup"),a=r(t,e,"touchmove","touchend");return n.origin=function(t){return arguments.length?(i=t,n):i},Xo.rebind(n,u,"on")};var Sa=Math.PI,ka=2*Sa,Ea=Sa/2,Aa=1e-6,Ca=Aa*Aa,Na=Sa/180,La=180/Sa,za=Math.SQRT2,qa=2,Ta=4;Xo.interpolateZoom=function(n,t){function e(n){var t=n*y;if(m){var e=B(v),o=i/(qa*h)*(e*W(za*t+v)-$(v));return[r+o*s,u+o*l,i*e/B(za*t+v)]}return[r+n*s,u+n*l,i*Math.exp(za*t)]}var r=n[0],u=n[1],i=n[2],o=t[0],a=t[1],c=t[2],s=o-r,l=a-u,f=s*s+l*l,h=Math.sqrt(f),g=(c*c-i*i+Ta*f)/(2*i*qa*h),p=(c*c-i*i-Ta*f)/(2*c*qa*h),v=Math.log(Math.sqrt(g*g+1)-g),d=Math.log(Math.sqrt(p*p+1)-p),m=d-v,y=(m||Math.log(c/i))/za;return e.duration=1e3*y,e},Xo.behavior.zoom=function(){function n(n){n.on(A,s).on(Pa+".zoom",f).on(C,h).on("dblclick.zoom",g).on(L,l)}function t(n){return[(n[0]-S.x)/S.k,(n[1]-S.y)/S.k]}function e(n){return[n[0]*S.k+S.x,n[1]*S.k+S.y]}function r(n){S.k=Math.max(E[0],Math.min(E[1],n))}function u(n,t){t=e(t),S.x+=n[0]-t[0],S.y+=n[1]-t[1]}function i(){_&&_.domain(M.range().map(function(n){return(n-S.x)/S.k}).map(M.invert)),w&&w.domain(b.range().map(function(n){return(n-S.y)/S.k}).map(b.invert))}function o(n){n({type:"zoomstart"})}function a(n){i(),n({type:"zoom",scale:S.k,translate:[S.x,S.y]})}function c(n){n({type:"zoomend"})}function s(){function n(){l=1,u(Xo.mouse(r),g),a(i)}function e(){f.on(C,Go===r?h:null).on(N,null),p(l&&Xo.event.target===s),c(i)}var r=this,i=z.of(r,arguments),s=Xo.event.target,l=0,f=Xo.select(Go).on(C,n).on(N,e),g=t(Xo.mouse(r)),p=O();U.call(r),o(i)}function l(){function n(){var n=Xo.touches(g);return h=S.k,n.forEach(function(n){n.identifier in v&&(v[n.identifier]=t(n))}),n}function e(){for(var t=Xo.event.changedTouches,e=0,i=t.length;i>e;++e)v[t[e].identifier]=null;var o=n(),c=Date.now();if(1===o.length){if(500>c-x){var s=o[0],l=v[s.identifier];r(2*S.k),u(s,l),d(),a(p)}x=c}else if(o.length>1){var s=o[0],f=o[1],h=s[0]-f[0],g=s[1]-f[1];m=h*h+g*g}}function i(){for(var n,t,e,i,o=Xo.touches(g),c=0,s=o.length;s>c;++c,i=null)if(e=o[c],i=v[e.identifier]){if(t)break;n=e,t=i}if(i){var l=(l=e[0]-n[0])*l+(l=e[1]-n[1])*l,f=m&&Math.sqrt(l/m);n=[(n[0]+e[0])/2,(n[1]+e[1])/2],t=[(t[0]+i[0])/2,(t[1]+i[1])/2],r(f*h)}x=null,u(n,t),a(p)}function f(){if(Xo.event.touches.length){for(var t=Xo.event.changedTouches,e=0,r=t.length;r>e;++e)delete v[t[e].identifier];for(var u in v)return void n()}b.on(M,null).on(_,null),w.on(A,s).on(L,l),k(),c(p)}var h,g=this,p=z.of(g,arguments),v={},m=0,y=Xo.event.changedTouches[0].identifier,M="touchmove.zoom-"+y,_="touchend.zoom-"+y,b=Xo.select(Go).on(M,i).on(_,f),w=Xo.select(g).on(A,null).on(L,e),k=O();U.call(g),e(),o(p)}function f(){var n=z.of(this,arguments);m?clearTimeout(m):(U.call(this),o(n)),m=setTimeout(function(){m=null,c(n)},50),d();var e=v||Xo.mouse(this);p||(p=t(e)),r(Math.pow(2,.002*Ra())*S.k),u(e,p),a(n)}function h(){p=null}function g(){var n=z.of(this,arguments),e=Xo.mouse(this),i=t(e),s=Math.log(S.k)/Math.LN2;o(n),r(Math.pow(2,Xo.event.shiftKey?Math.ceil(s)-1:Math.floor(s)+1)),u(e,i),a(n),c(n)}var p,v,m,x,M,_,b,w,S={x:0,y:0,k:1},k=[960,500],E=Da,A="mousedown.zoom",C="mousemove.zoom",N="mouseup.zoom",L="touchstart.zoom",z=y(n,"zoomstart","zoom","zoomend");return n.event=function(n){n.each(function(){var n=z.of(this,arguments),t=S;ks?Xo.select(this).transition().each("start.zoom",function(){S=this.__chart__||{x:0,y:0,k:1},o(n)}).tween("zoom:zoom",function(){var e=k[0],r=k[1],u=e/2,i=r/2,o=Xo.interpolateZoom([(u-S.x)/S.k,(i-S.y)/S.k,e/S.k],[(u-t.x)/t.k,(i-t.y)/t.k,e/t.k]);return function(t){var r=o(t),c=e/r[2];this.__chart__=S={x:u-r[0]*c,y:i-r[1]*c,k:c},a(n)}}).each("end.zoom",function(){c(n)}):(this.__chart__=S,o(n),a(n),c(n))})},n.translate=function(t){return arguments.length?(S={x:+t[0],y:+t[1],k:S.k},i(),n):[S.x,S.y]},n.scale=function(t){return arguments.length?(S={x:S.x,y:S.y,k:+t},i(),n):S.k},n.scaleExtent=function(t){return arguments.length?(E=null==t?Da:[+t[0],+t[1]],n):E},n.center=function(t){return arguments.length?(v=t&&[+t[0],+t[1]],n):v},n.size=function(t){return arguments.length?(k=t&&[+t[0],+t[1]],n):k},n.x=function(t){return arguments.length?(_=t,M=t.copy(),S={x:0,y:0,k:1},n):_},n.y=function(t){return arguments.length?(w=t,b=t.copy(),S={x:0,y:0,k:1},n):w},Xo.rebind(n,z,"on")};var Ra,Da=[0,1/0],Pa="onwheel"in Wo?(Ra=function(){return-Xo.event.deltaY*(Xo.event.deltaMode?120:1)},"wheel"):"onmousewheel"in Wo?(Ra=function(){return Xo.event.wheelDelta},"mousewheel"):(Ra=function(){return-Xo.event.detail},"MozMousePixelScroll");G.prototype.toString=function(){return this.rgb()+""},Xo.hsl=function(n,t,e){return 1===arguments.length?n instanceof Q?K(n.h,n.s,n.l):dt(""+n,mt,K):K(+n,+t,+e)};var Ua=Q.prototype=new G;Ua.brighter=function(n){return n=Math.pow(.7,arguments.length?n:1),K(this.h,this.s,this.l/n)},Ua.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),K(this.h,this.s,n*this.l)},Ua.rgb=function(){return nt(this.h,this.s,this.l)},Xo.hcl=function(n,t,e){return 1===arguments.length?n instanceof et?tt(n.h,n.c,n.l):n instanceof it?at(n.l,n.a,n.b):at((n=yt((n=Xo.rgb(n)).r,n.g,n.b)).l,n.a,n.b):tt(+n,+t,+e)};var ja=et.prototype=new G;ja.brighter=function(n){return tt(this.h,this.c,Math.min(100,this.l+Ha*(arguments.length?n:1)))},ja.darker=function(n){return tt(this.h,this.c,Math.max(0,this.l-Ha*(arguments.length?n:1)))},ja.rgb=function(){return rt(this.h,this.c,this.l).rgb()},Xo.lab=function(n,t,e){return 1===arguments.length?n instanceof it?ut(n.l,n.a,n.b):n instanceof et?rt(n.l,n.c,n.h):yt((n=Xo.rgb(n)).r,n.g,n.b):ut(+n,+t,+e)};var Ha=18,Fa=.95047,Oa=1,Ya=1.08883,Ia=it.prototype=new G;Ia.brighter=function(n){return ut(Math.min(100,this.l+Ha*(arguments.length?n:1)),this.a,this.b)},Ia.darker=function(n){return ut(Math.max(0,this.l-Ha*(arguments.length?n:1)),this.a,this.b)},Ia.rgb=function(){return ot(this.l,this.a,this.b)},Xo.rgb=function(n,t,e){return 1===arguments.length?n instanceof pt?gt(n.r,n.g,n.b):dt(""+n,gt,nt):gt(~~n,~~t,~~e)};var Za=pt.prototype=new G;Za.brighter=function(n){n=Math.pow(.7,arguments.length?n:1);var t=this.r,e=this.g,r=this.b,u=30;return t||e||r?(t&&u>t&&(t=u),e&&u>e&&(e=u),r&&u>r&&(r=u),gt(Math.min(255,~~(t/n)),Math.min(255,~~(e/n)),Math.min(255,~~(r/n)))):gt(u,u,u)},Za.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),gt(~~(n*this.r),~~(n*this.g),~~(n*this.b))},Za.hsl=function(){return mt(this.r,this.g,this.b)},Za.toString=function(){return"#"+vt(this.r)+vt(this.g)+vt(this.b)};var Va=Xo.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});Va.forEach(function(n,t){Va.set(n,ft(t))}),Xo.functor=_t,Xo.xhr=wt(bt),Xo.dsv=function(n,t){function e(n,e,i){arguments.length<3&&(i=e,e=null);var o=St(n,t,null==e?r:u(e),i);return o.row=function(n){return arguments.length?o.response(null==(e=n)?r:u(n)):e},o}function r(n){return e.parse(n.responseText)}function u(n){return function(t){return e.parse(t.responseText,n)}}function i(t){return t.map(o).join(n)}function o(n){return a.test(n)?'"'+n.replace(/\"/g,'""')+'"':n}var a=new RegExp('["'+n+"\n]"),c=n.charCodeAt(0);return e.parse=function(n,t){var r;return e.parseRows(n,function(n,e){if(r)return r(n,e-1);var u=new Function("d","return {"+n.map(function(n,t){return JSON.stringify(n)+": d["+t+"]"}).join(",")+"}");r=t?function(n,e){return t(u(n),e)}:u})},e.parseRows=function(n,t){function e(){if(l>=s)return o;if(u)return u=!1,i;var t=l;if(34===n.charCodeAt(t)){for(var e=t;e++<s;)if(34===n.charCodeAt(e)){if(34!==n.charCodeAt(e+1))break;++e}l=e+2;var r=n.charCodeAt(e+1);return 13===r?(u=!0,10===n.charCodeAt(e+2)&&++l):10===r&&(u=!0),n.substring(t+1,e).replace(/""/g,'"')}for(;s>l;){var r=n.charCodeAt(l++),a=1;if(10===r)u=!0;else if(13===r)u=!0,10===n.charCodeAt(l)&&(++l,++a);else if(r!==c)continue;return n.substring(t,l-a)}return n.substring(t)}for(var r,u,i={},o={},a=[],s=n.length,l=0,f=0;(r=e())!==o;){for(var h=[];r!==i&&r!==o;)h.push(r),r=e();(!t||(h=t(h,f++)))&&a.push(h)}return a},e.format=function(t){if(Array.isArray(t[0]))return e.formatRows(t);var r=new l,u=[];return t.forEach(function(n){for(var t in n)r.has(t)||u.push(r.add(t))}),[u.map(o).join(n)].concat(t.map(function(t){return u.map(function(n){return o(t[n])}).join(n)})).join("\n")},e.formatRows=function(n){return n.map(i).join("\n")},e},Xo.csv=Xo.dsv(",","text/csv"),Xo.tsv=Xo.dsv("	","text/tab-separated-values");var Xa,$a,Ba,Wa,Ja,Ga=Go[h(Go,"requestAnimationFrame")]||function(n){setTimeout(n,17)};Xo.timer=function(n,t,e){var r=arguments.length;2>r&&(t=0),3>r&&(e=Date.now());var u=e+t,i={c:n,t:u,f:!1,n:null};$a?$a.n=i:Xa=i,$a=i,Ba||(Wa=clearTimeout(Wa),Ba=1,Ga(Et))},Xo.timer.flush=function(){At(),Ct()},Xo.round=function(n,t){return t?Math.round(n*(t=Math.pow(10,t)))/t:Math.round(n)};var Ka=["y","z","a","f","p","n","\xb5","m","","k","M","G","T","P","E","Z","Y"].map(Lt);Xo.formatPrefix=function(n,t){var e=0;return n&&(0>n&&(n*=-1),t&&(n=Xo.round(n,Nt(n,t))),e=1+Math.floor(1e-12+Math.log(n)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((0>=e?e+1:e-1)/3)))),Ka[8+e/3]};var Qa=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,nc=Xo.map({b:function(n){return n.toString(2)},c:function(n){return String.fromCharCode(n)},o:function(n){return n.toString(8)},x:function(n){return n.toString(16)},X:function(n){return n.toString(16).toUpperCase()},g:function(n,t){return n.toPrecision(t)},e:function(n,t){return n.toExponential(t)},f:function(n,t){return n.toFixed(t)},r:function(n,t){return(n=Xo.round(n,Nt(n,t))).toFixed(Math.max(0,Math.min(20,Nt(n*(1+1e-15),t))))}}),tc=Xo.time={},ec=Date;Tt.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){rc.setUTCDate.apply(this._,arguments)},setDay:function(){rc.setUTCDay.apply(this._,arguments)},setFullYear:function(){rc.setUTCFullYear.apply(this._,arguments)},setHours:function(){rc.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){rc.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){rc.setUTCMinutes.apply(this._,arguments)},setMonth:function(){rc.setUTCMonth.apply(this._,arguments)},setSeconds:function(){rc.setUTCSeconds.apply(this._,arguments)},setTime:function(){rc.setTime.apply(this._,arguments)}};var rc=Date.prototype;tc.year=Rt(function(n){return n=tc.day(n),n.setMonth(0,1),n},function(n,t){n.setFullYear(n.getFullYear()+t)},function(n){return n.getFullYear()}),tc.years=tc.year.range,tc.years.utc=tc.year.utc.range,tc.day=Rt(function(n){var t=new ec(2e3,0);return t.setFullYear(n.getFullYear(),n.getMonth(),n.getDate()),t},function(n,t){n.setDate(n.getDate()+t)},function(n){return n.getDate()-1}),tc.days=tc.day.range,tc.days.utc=tc.day.utc.range,tc.dayOfYear=function(n){var t=tc.year(n);return Math.floor((n-t-6e4*(n.getTimezoneOffset()-t.getTimezoneOffset()))/864e5)},["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].forEach(function(n,t){t=7-t;var e=tc[n]=Rt(function(n){return(n=tc.day(n)).setDate(n.getDate()-(n.getDay()+t)%7),n},function(n,t){n.setDate(n.getDate()+7*Math.floor(t))},function(n){var e=tc.year(n).getDay();return Math.floor((tc.dayOfYear(n)+(e+t)%7)/7)-(e!==t)});tc[n+"s"]=e.range,tc[n+"s"].utc=e.utc.range,tc[n+"OfYear"]=function(n){var e=tc.year(n).getDay();return Math.floor((tc.dayOfYear(n)+(e+t)%7)/7)}}),tc.week=tc.sunday,tc.weeks=tc.sunday.range,tc.weeks.utc=tc.sunday.utc.range,tc.weekOfYear=tc.sundayOfYear;var uc={"-":"",_:" ",0:"0"},ic=/^\s*\d+/,oc=/^%/;Xo.locale=function(n){return{numberFormat:zt(n),timeFormat:Pt(n)}};var ac=Xo.locale({decimal:".",thousands:",",grouping:[3],currency:["$",""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});Xo.format=ac.numberFormat,Xo.geo={},re.prototype={s:0,t:0,add:function(n){ue(n,this.t,cc),ue(cc.s,this.s,this),this.s?this.t+=cc.t:this.s=cc.t},reset:function(){this.s=this.t=0},valueOf:function(){return this.s}};var cc=new re;Xo.geo.stream=function(n,t){n&&sc.hasOwnProperty(n.type)?sc[n.type](n,t):ie(n,t)};var sc={Feature:function(n,t){ie(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,r=-1,u=e.length;++r<u;)ie(e[r].geometry,t)}},lc={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)n=e[r],t.point(n[0],n[1],n[2])},LineString:function(n,t){oe(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)oe(e[r],t,0)},Polygon:function(n,t){ae(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)ae(e[r],t)},GeometryCollection:function(n,t){for(var e=n.geometries,r=-1,u=e.length;++r<u;)ie(e[r],t)}};Xo.geo.area=function(n){return fc=0,Xo.geo.stream(n,gc),fc};var fc,hc=new re,gc={sphere:function(){fc+=4*Sa},point:g,lineStart:g,lineEnd:g,polygonStart:function(){hc.reset(),gc.lineStart=ce},polygonEnd:function(){var n=2*hc;fc+=0>n?4*Sa+n:n,gc.lineStart=gc.lineEnd=gc.point=g}};Xo.geo.bounds=function(){function n(n,t){x.push(M=[l=n,h=n]),f>t&&(f=t),t>g&&(g=t)}function t(t,e){var r=se([t*Na,e*Na]);if(m){var u=fe(m,r),i=[u[1],-u[0],0],o=fe(i,u);pe(o),o=ve(o);var c=t-p,s=c>0?1:-1,v=o[0]*La*s,d=oa(c)>180;if(d^(v>s*p&&s*t>v)){var y=o[1]*La;y>g&&(g=y)}else if(v=(v+360)%360-180,d^(v>s*p&&s*t>v)){var y=-o[1]*La;f>y&&(f=y)}else f>e&&(f=e),e>g&&(g=e);d?p>t?a(l,t)>a(l,h)&&(h=t):a(t,h)>a(l,h)&&(l=t):h>=l?(l>t&&(l=t),t>h&&(h=t)):t>p?a(l,t)>a(l,h)&&(h=t):a(t,h)>a(l,h)&&(l=t)}else n(t,e);m=r,p=t}function e(){_.point=t}function r(){M[0]=l,M[1]=h,_.point=n,m=null}function u(n,e){if(m){var r=n-p;y+=oa(r)>180?r+(r>0?360:-360):r}else v=n,d=e;gc.point(n,e),t(n,e)}function i(){gc.lineStart()}function o(){u(v,d),gc.lineEnd(),oa(y)>Aa&&(l=-(h=180)),M[0]=l,M[1]=h,m=null}function a(n,t){return(t-=n)<0?t+360:t}function c(n,t){return n[0]-t[0]}function s(n,t){return t[0]<=t[1]?t[0]<=n&&n<=t[1]:n<t[0]||t[1]<n}var l,f,h,g,p,v,d,m,y,x,M,_={point:n,lineStart:e,lineEnd:r,polygonStart:function(){_.point=u,_.lineStart=i,_.lineEnd=o,y=0,gc.polygonStart()},polygonEnd:function(){gc.polygonEnd(),_.point=n,_.lineStart=e,_.lineEnd=r,0>hc?(l=-(h=180),f=-(g=90)):y>Aa?g=90:-Aa>y&&(f=-90),M[0]=l,M[1]=h
+}};return function(n){g=h=-(l=f=1/0),x=[],Xo.geo.stream(n,_);var t=x.length;if(t){x.sort(c);for(var e,r=1,u=x[0],i=[u];t>r;++r)e=x[r],s(e[0],u)||s(e[1],u)?(a(u[0],e[1])>a(u[0],u[1])&&(u[1]=e[1]),a(e[0],u[1])>a(u[0],u[1])&&(u[0]=e[0])):i.push(u=e);for(var o,e,p=-1/0,t=i.length-1,r=0,u=i[t];t>=r;u=e,++r)e=i[r],(o=a(u[1],e[0]))>p&&(p=o,l=e[0],h=u[1])}return x=M=null,1/0===l||1/0===f?[[0/0,0/0],[0/0,0/0]]:[[l,f],[h,g]]}}(),Xo.geo.centroid=function(n){pc=vc=dc=mc=yc=xc=Mc=_c=bc=wc=Sc=0,Xo.geo.stream(n,kc);var t=bc,e=wc,r=Sc,u=t*t+e*e+r*r;return Ca>u&&(t=xc,e=Mc,r=_c,Aa>vc&&(t=dc,e=mc,r=yc),u=t*t+e*e+r*r,Ca>u)?[0/0,0/0]:[Math.atan2(e,t)*La,X(r/Math.sqrt(u))*La]};var pc,vc,dc,mc,yc,xc,Mc,_c,bc,wc,Sc,kc={sphere:g,point:me,lineStart:xe,lineEnd:Me,polygonStart:function(){kc.lineStart=_e},polygonEnd:function(){kc.lineStart=xe}},Ec=Ee(be,ze,Te,[-Sa,-Sa/2]),Ac=1e9;Xo.geo.clipExtent=function(){var n,t,e,r,u,i,o={stream:function(n){return u&&(u.valid=!1),u=i(n),u.valid=!0,u},extent:function(a){return arguments.length?(i=Pe(n=+a[0][0],t=+a[0][1],e=+a[1][0],r=+a[1][1]),u&&(u.valid=!1,u=null),o):[[n,t],[e,r]]}};return o.extent([[0,0],[960,500]])},(Xo.geo.conicEqualArea=function(){return je(He)}).raw=He,Xo.geo.albers=function(){return Xo.geo.conicEqualArea().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(1070)},Xo.geo.albersUsa=function(){function n(n){var i=n[0],o=n[1];return t=null,e(i,o),t||(r(i,o),t)||u(i,o),t}var t,e,r,u,i=Xo.geo.albers(),o=Xo.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),a=Xo.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),c={point:function(n,e){t=[n,e]}};return n.invert=function(n){var t=i.scale(),e=i.translate(),r=(n[0]-e[0])/t,u=(n[1]-e[1])/t;return(u>=.12&&.234>u&&r>=-.425&&-.214>r?o:u>=.166&&.234>u&&r>=-.214&&-.115>r?a:i).invert(n)},n.stream=function(n){var t=i.stream(n),e=o.stream(n),r=a.stream(n);return{point:function(n,u){t.point(n,u),e.point(n,u),r.point(n,u)},sphere:function(){t.sphere(),e.sphere(),r.sphere()},lineStart:function(){t.lineStart(),e.lineStart(),r.lineStart()},lineEnd:function(){t.lineEnd(),e.lineEnd(),r.lineEnd()},polygonStart:function(){t.polygonStart(),e.polygonStart(),r.polygonStart()},polygonEnd:function(){t.polygonEnd(),e.polygonEnd(),r.polygonEnd()}}},n.precision=function(t){return arguments.length?(i.precision(t),o.precision(t),a.precision(t),n):i.precision()},n.scale=function(t){return arguments.length?(i.scale(t),o.scale(.35*t),a.scale(t),n.translate(i.translate())):i.scale()},n.translate=function(t){if(!arguments.length)return i.translate();var s=i.scale(),l=+t[0],f=+t[1];return e=i.translate(t).clipExtent([[l-.455*s,f-.238*s],[l+.455*s,f+.238*s]]).stream(c).point,r=o.translate([l-.307*s,f+.201*s]).clipExtent([[l-.425*s+Aa,f+.12*s+Aa],[l-.214*s-Aa,f+.234*s-Aa]]).stream(c).point,u=a.translate([l-.205*s,f+.212*s]).clipExtent([[l-.214*s+Aa,f+.166*s+Aa],[l-.115*s-Aa,f+.234*s-Aa]]).stream(c).point,n},n.scale(1070)};var Cc,Nc,Lc,zc,qc,Tc,Rc={point:g,lineStart:g,lineEnd:g,polygonStart:function(){Nc=0,Rc.lineStart=Fe},polygonEnd:function(){Rc.lineStart=Rc.lineEnd=Rc.point=g,Cc+=oa(Nc/2)}},Dc={point:Oe,lineStart:g,lineEnd:g,polygonStart:g,polygonEnd:g},Pc={point:Ze,lineStart:Ve,lineEnd:Xe,polygonStart:function(){Pc.lineStart=$e},polygonEnd:function(){Pc.point=Ze,Pc.lineStart=Ve,Pc.lineEnd=Xe}};Xo.geo.path=function(){function n(n){return n&&("function"==typeof a&&i.pointRadius(+a.apply(this,arguments)),o&&o.valid||(o=u(i)),Xo.geo.stream(n,o)),i.result()}function t(){return o=null,n}var e,r,u,i,o,a=4.5;return n.area=function(n){return Cc=0,Xo.geo.stream(n,u(Rc)),Cc},n.centroid=function(n){return dc=mc=yc=xc=Mc=_c=bc=wc=Sc=0,Xo.geo.stream(n,u(Pc)),Sc?[bc/Sc,wc/Sc]:_c?[xc/_c,Mc/_c]:yc?[dc/yc,mc/yc]:[0/0,0/0]},n.bounds=function(n){return qc=Tc=-(Lc=zc=1/0),Xo.geo.stream(n,u(Dc)),[[Lc,zc],[qc,Tc]]},n.projection=function(n){return arguments.length?(u=(e=n)?n.stream||Je(n):bt,t()):e},n.context=function(n){return arguments.length?(i=null==(r=n)?new Ye:new Be(n),"function"!=typeof a&&i.pointRadius(a),t()):r},n.pointRadius=function(t){return arguments.length?(a="function"==typeof t?t:(i.pointRadius(+t),+t),n):a},n.projection(Xo.geo.albersUsa()).context(null)},Xo.geo.transform=function(n){return{stream:function(t){var e=new Ge(t);for(var r in n)e[r]=n[r];return e}}},Ge.prototype={point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}},Xo.geo.projection=Qe,Xo.geo.projectionMutator=nr,(Xo.geo.equirectangular=function(){return Qe(er)}).raw=er.invert=er,Xo.geo.rotation=function(n){function t(t){return t=n(t[0]*Na,t[1]*Na),t[0]*=La,t[1]*=La,t}return n=ur(n[0]%360*Na,n[1]*Na,n.length>2?n[2]*Na:0),t.invert=function(t){return t=n.invert(t[0]*Na,t[1]*Na),t[0]*=La,t[1]*=La,t},t},rr.invert=er,Xo.geo.circle=function(){function n(){var n="function"==typeof r?r.apply(this,arguments):r,t=ur(-n[0]*Na,-n[1]*Na,0).invert,u=[];return e(null,null,1,{point:function(n,e){u.push(n=t(n,e)),n[0]*=La,n[1]*=La}}),{type:"Polygon",coordinates:[u]}}var t,e,r=[0,0],u=6;return n.origin=function(t){return arguments.length?(r=t,n):r},n.angle=function(r){return arguments.length?(e=cr((t=+r)*Na,u*Na),n):t},n.precision=function(r){return arguments.length?(e=cr(t*Na,(u=+r)*Na),n):u},n.angle(90)},Xo.geo.distance=function(n,t){var e,r=(t[0]-n[0])*Na,u=n[1]*Na,i=t[1]*Na,o=Math.sin(r),a=Math.cos(r),c=Math.sin(u),s=Math.cos(u),l=Math.sin(i),f=Math.cos(i);return Math.atan2(Math.sqrt((e=f*o)*e+(e=s*l-c*f*a)*e),c*l+s*f*a)},Xo.geo.graticule=function(){function n(){return{type:"MultiLineString",coordinates:t()}}function t(){return Xo.range(Math.ceil(i/d)*d,u,d).map(h).concat(Xo.range(Math.ceil(s/m)*m,c,m).map(g)).concat(Xo.range(Math.ceil(r/p)*p,e,p).filter(function(n){return oa(n%d)>Aa}).map(l)).concat(Xo.range(Math.ceil(a/v)*v,o,v).filter(function(n){return oa(n%m)>Aa}).map(f))}var e,r,u,i,o,a,c,s,l,f,h,g,p=10,v=p,d=90,m=360,y=2.5;return n.lines=function(){return t().map(function(n){return{type:"LineString",coordinates:n}})},n.outline=function(){return{type:"Polygon",coordinates:[h(i).concat(g(c).slice(1),h(u).reverse().slice(1),g(s).reverse().slice(1))]}},n.extent=function(t){return arguments.length?n.majorExtent(t).minorExtent(t):n.minorExtent()},n.majorExtent=function(t){return arguments.length?(i=+t[0][0],u=+t[1][0],s=+t[0][1],c=+t[1][1],i>u&&(t=i,i=u,u=t),s>c&&(t=s,s=c,c=t),n.precision(y)):[[i,s],[u,c]]},n.minorExtent=function(t){return arguments.length?(r=+t[0][0],e=+t[1][0],a=+t[0][1],o=+t[1][1],r>e&&(t=r,r=e,e=t),a>o&&(t=a,a=o,o=t),n.precision(y)):[[r,a],[e,o]]},n.step=function(t){return arguments.length?n.majorStep(t).minorStep(t):n.minorStep()},n.majorStep=function(t){return arguments.length?(d=+t[0],m=+t[1],n):[d,m]},n.minorStep=function(t){return arguments.length?(p=+t[0],v=+t[1],n):[p,v]},n.precision=function(t){return arguments.length?(y=+t,l=lr(a,o,90),f=fr(r,e,y),h=lr(s,c,90),g=fr(i,u,y),n):y},n.majorExtent([[-180,-90+Aa],[180,90-Aa]]).minorExtent([[-180,-80-Aa],[180,80+Aa]])},Xo.geo.greatArc=function(){function n(){return{type:"LineString",coordinates:[t||r.apply(this,arguments),e||u.apply(this,arguments)]}}var t,e,r=hr,u=gr;return n.distance=function(){return Xo.geo.distance(t||r.apply(this,arguments),e||u.apply(this,arguments))},n.source=function(e){return arguments.length?(r=e,t="function"==typeof e?null:e,n):r},n.target=function(t){return arguments.length?(u=t,e="function"==typeof t?null:t,n):u},n.precision=function(){return arguments.length?n:0},n},Xo.geo.interpolate=function(n,t){return pr(n[0]*Na,n[1]*Na,t[0]*Na,t[1]*Na)},Xo.geo.length=function(n){return Uc=0,Xo.geo.stream(n,jc),Uc};var Uc,jc={sphere:g,point:g,lineStart:vr,lineEnd:g,polygonStart:g,polygonEnd:g},Hc=dr(function(n){return Math.sqrt(2/(1+n))},function(n){return 2*Math.asin(n/2)});(Xo.geo.azimuthalEqualArea=function(){return Qe(Hc)}).raw=Hc;var Fc=dr(function(n){var t=Math.acos(n);return t&&t/Math.sin(t)},bt);(Xo.geo.azimuthalEquidistant=function(){return Qe(Fc)}).raw=Fc,(Xo.geo.conicConformal=function(){return je(mr)}).raw=mr,(Xo.geo.conicEquidistant=function(){return je(yr)}).raw=yr;var Oc=dr(function(n){return 1/n},Math.atan);(Xo.geo.gnomonic=function(){return Qe(Oc)}).raw=Oc,xr.invert=function(n,t){return[n,2*Math.atan(Math.exp(t))-Ea]},(Xo.geo.mercator=function(){return Mr(xr)}).raw=xr;var Yc=dr(function(){return 1},Math.asin);(Xo.geo.orthographic=function(){return Qe(Yc)}).raw=Yc;var Ic=dr(function(n){return 1/(1+n)},function(n){return 2*Math.atan(n)});(Xo.geo.stereographic=function(){return Qe(Ic)}).raw=Ic,_r.invert=function(n,t){return[-t,2*Math.atan(Math.exp(n))-Ea]},(Xo.geo.transverseMercator=function(){var n=Mr(_r),t=n.center,e=n.rotate;return n.center=function(n){return n?t([-n[1],n[0]]):(n=t(),[-n[1],n[0]])},n.rotate=function(n){return n?e([n[0],n[1],n.length>2?n[2]+90:90]):(n=e(),[n[0],n[1],n[2]-90])},n.rotate([0,0])}).raw=_r,Xo.geom={},Xo.geom.hull=function(n){function t(n){if(n.length<3)return[];var t,u=_t(e),i=_t(r),o=n.length,a=[],c=[];for(t=0;o>t;t++)a.push([+u.call(this,n[t],t),+i.call(this,n[t],t),t]);for(a.sort(kr),t=0;o>t;t++)c.push([a[t][0],-a[t][1]]);var s=Sr(a),l=Sr(c),f=l[0]===s[0],h=l[l.length-1]===s[s.length-1],g=[];for(t=s.length-1;t>=0;--t)g.push(n[a[s[t]][2]]);for(t=+f;t<l.length-h;++t)g.push(n[a[l[t]][2]]);return g}var e=br,r=wr;return arguments.length?t(n):(t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t)},Xo.geom.polygon=function(n){return fa(n,Zc),n};var Zc=Xo.geom.polygon.prototype=[];Zc.area=function(){for(var n,t=-1,e=this.length,r=this[e-1],u=0;++t<e;)n=r,r=this[t],u+=n[1]*r[0]-n[0]*r[1];return.5*u},Zc.centroid=function(n){var t,e,r=-1,u=this.length,i=0,o=0,a=this[u-1];for(arguments.length||(n=-1/(6*this.area()));++r<u;)t=a,a=this[r],e=t[0]*a[1]-a[0]*t[1],i+=(t[0]+a[0])*e,o+=(t[1]+a[1])*e;return[i*n,o*n]},Zc.clip=function(n){for(var t,e,r,u,i,o,a=Cr(n),c=-1,s=this.length-Cr(this),l=this[s-1];++c<s;){for(t=n.slice(),n.length=0,u=this[c],i=t[(r=t.length-a)-1],e=-1;++e<r;)o=t[e],Er(o,l,u)?(Er(i,l,u)||n.push(Ar(i,o,l,u)),n.push(o)):Er(i,l,u)&&n.push(Ar(i,o,l,u)),i=o;a&&n.push(n[0]),l=u}return n};var Vc,Xc,$c,Bc,Wc,Jc=[],Gc=[];Pr.prototype.prepare=function(){for(var n,t=this.edges,e=t.length;e--;)n=t[e].edge,n.b&&n.a||t.splice(e,1);return t.sort(jr),t.length},Br.prototype={start:function(){return this.edge.l===this.site?this.edge.a:this.edge.b},end:function(){return this.edge.l===this.site?this.edge.b:this.edge.a}},Wr.prototype={insert:function(n,t){var e,r,u;if(n){if(t.P=n,t.N=n.N,n.N&&(n.N.P=t),n.N=t,n.R){for(n=n.R;n.L;)n=n.L;n.L=t}else n.R=t;e=n}else this._?(n=Qr(this._),t.P=null,t.N=n,n.P=n.L=t,e=n):(t.P=t.N=null,this._=t,e=null);for(t.L=t.R=null,t.U=e,t.C=!0,n=t;e&&e.C;)r=e.U,e===r.L?(u=r.R,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.R&&(Gr(this,e),n=e,e=n.U),e.C=!1,r.C=!0,Kr(this,r))):(u=r.L,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.L&&(Kr(this,e),n=e,e=n.U),e.C=!1,r.C=!0,Gr(this,r))),e=n.U;this._.C=!1},remove:function(n){n.N&&(n.N.P=n.P),n.P&&(n.P.N=n.N),n.N=n.P=null;var t,e,r,u=n.U,i=n.L,o=n.R;if(e=i?o?Qr(o):i:o,u?u.L===n?u.L=e:u.R=e:this._=e,i&&o?(r=e.C,e.C=n.C,e.L=i,i.U=e,e!==o?(u=e.U,e.U=n.U,n=e.R,u.L=n,e.R=o,o.U=e):(e.U=u,u=e,n=e.R)):(r=n.C,n=e),n&&(n.U=u),!r){if(n&&n.C)return n.C=!1,void 0;do{if(n===this._)break;if(n===u.L){if(t=u.R,t.C&&(t.C=!1,u.C=!0,Gr(this,u),t=u.R),t.L&&t.L.C||t.R&&t.R.C){t.R&&t.R.C||(t.L.C=!1,t.C=!0,Kr(this,t),t=u.R),t.C=u.C,u.C=t.R.C=!1,Gr(this,u),n=this._;break}}else if(t=u.L,t.C&&(t.C=!1,u.C=!0,Kr(this,u),t=u.L),t.L&&t.L.C||t.R&&t.R.C){t.L&&t.L.C||(t.R.C=!1,t.C=!0,Gr(this,t),t=u.L),t.C=u.C,u.C=t.L.C=!1,Kr(this,u),n=this._;break}t.C=!0,n=u,u=u.U}while(!n.C);n&&(n.C=!1)}}},Xo.geom.voronoi=function(n){function t(n){var t=new Array(n.length),r=a[0][0],u=a[0][1],i=a[1][0],o=a[1][1];return nu(e(n),a).cells.forEach(function(e,a){var c=e.edges,s=e.site,l=t[a]=c.length?c.map(function(n){var t=n.start();return[t.x,t.y]}):s.x>=r&&s.x<=i&&s.y>=u&&s.y<=o?[[r,o],[i,o],[i,u],[r,u]]:[];l.point=n[a]}),t}function e(n){return n.map(function(n,t){return{x:Math.round(i(n,t)/Aa)*Aa,y:Math.round(o(n,t)/Aa)*Aa,i:t}})}var r=br,u=wr,i=r,o=u,a=Kc;return n?t(n):(t.links=function(n){return nu(e(n)).edges.filter(function(n){return n.l&&n.r}).map(function(t){return{source:n[t.l.i],target:n[t.r.i]}})},t.triangles=function(n){var t=[];return nu(e(n)).cells.forEach(function(e,r){for(var u,i,o=e.site,a=e.edges.sort(jr),c=-1,s=a.length,l=a[s-1].edge,f=l.l===o?l.r:l.l;++c<s;)u=l,i=f,l=a[c].edge,f=l.l===o?l.r:l.l,r<i.i&&r<f.i&&eu(o,i,f)<0&&t.push([n[r],n[i.i],n[f.i]])}),t},t.x=function(n){return arguments.length?(i=_t(r=n),t):r},t.y=function(n){return arguments.length?(o=_t(u=n),t):u},t.clipExtent=function(n){return arguments.length?(a=null==n?Kc:n,t):a===Kc?null:a},t.size=function(n){return arguments.length?t.clipExtent(n&&[[0,0],n]):a===Kc?null:a&&a[1]},t)};var Kc=[[-1e6,-1e6],[1e6,1e6]];Xo.geom.delaunay=function(n){return Xo.geom.voronoi().triangles(n)},Xo.geom.quadtree=function(n,t,e,r,u){function i(n){function i(n,t,e,r,u,i,o,a){if(!isNaN(e)&&!isNaN(r))if(n.leaf){var c=n.x,l=n.y;if(null!=c)if(oa(c-e)+oa(l-r)<.01)s(n,t,e,r,u,i,o,a);else{var f=n.point;n.x=n.y=n.point=null,s(n,f,c,l,u,i,o,a),s(n,t,e,r,u,i,o,a)}else n.x=e,n.y=r,n.point=t}else s(n,t,e,r,u,i,o,a)}function s(n,t,e,r,u,o,a,c){var s=.5*(u+a),l=.5*(o+c),f=e>=s,h=r>=l,g=(h<<1)+f;n.leaf=!1,n=n.nodes[g]||(n.nodes[g]=iu()),f?u=s:a=s,h?o=l:c=l,i(n,t,e,r,u,o,a,c)}var l,f,h,g,p,v,d,m,y,x=_t(a),M=_t(c);if(null!=t)v=t,d=e,m=r,y=u;else if(m=y=-(v=d=1/0),f=[],h=[],p=n.length,o)for(g=0;p>g;++g)l=n[g],l.x<v&&(v=l.x),l.y<d&&(d=l.y),l.x>m&&(m=l.x),l.y>y&&(y=l.y),f.push(l.x),h.push(l.y);else for(g=0;p>g;++g){var _=+x(l=n[g],g),b=+M(l,g);v>_&&(v=_),d>b&&(d=b),_>m&&(m=_),b>y&&(y=b),f.push(_),h.push(b)}var w=m-v,S=y-d;w>S?y=d+w:m=v+S;var k=iu();if(k.add=function(n){i(k,n,+x(n,++g),+M(n,g),v,d,m,y)},k.visit=function(n){ou(n,k,v,d,m,y)},g=-1,null==t){for(;++g<p;)i(k,n[g],f[g],h[g],v,d,m,y);--g}else n.forEach(k.add);return f=h=n=l=null,k}var o,a=br,c=wr;return(o=arguments.length)?(a=ru,c=uu,3===o&&(u=e,r=t,e=t=0),i(n)):(i.x=function(n){return arguments.length?(a=n,i):a},i.y=function(n){return arguments.length?(c=n,i):c},i.extent=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=+n[0][0],e=+n[0][1],r=+n[1][0],u=+n[1][1]),i):null==t?null:[[t,e],[r,u]]},i.size=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=e=0,r=+n[0],u=+n[1]),i):null==t?null:[r-t,u-e]},i)},Xo.interpolateRgb=au,Xo.interpolateObject=cu,Xo.interpolateNumber=su,Xo.interpolateString=lu;var Qc=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g;Xo.interpolate=fu,Xo.interpolators=[function(n,t){var e=typeof t;return("string"===e?Va.has(t)||/^(#|rgb\(|hsl\()/.test(t)?au:lu:t instanceof G?au:"object"===e?Array.isArray(t)?hu:cu:su)(n,t)}],Xo.interpolateArray=hu;var ns=function(){return bt},ts=Xo.map({linear:ns,poly:xu,quad:function(){return du},cubic:function(){return mu},sin:function(){return Mu},exp:function(){return _u},circle:function(){return bu},elastic:wu,back:Su,bounce:function(){return ku}}),es=Xo.map({"in":bt,out:pu,"in-out":vu,"out-in":function(n){return vu(pu(n))}});Xo.ease=function(n){var t=n.indexOf("-"),e=t>=0?n.substring(0,t):n,r=t>=0?n.substring(t+1):"in";return e=ts.get(e)||ns,r=es.get(r)||bt,gu(r(e.apply(null,$o.call(arguments,1))))},Xo.interpolateHcl=Eu,Xo.interpolateHsl=Au,Xo.interpolateLab=Cu,Xo.interpolateRound=Nu,Xo.transform=function(n){var t=Wo.createElementNS(Xo.ns.prefix.svg,"g");return(Xo.transform=function(n){if(null!=n){t.setAttribute("transform",n);var e=t.transform.baseVal.consolidate()}return new Lu(e?e.matrix:rs)})(n)},Lu.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")"};var rs={a:1,b:0,c:0,d:1,e:0,f:0};Xo.interpolateTransform=Ru,Xo.layout={},Xo.layout.bundle=function(){return function(n){for(var t=[],e=-1,r=n.length;++e<r;)t.push(Uu(n[e]));return t}},Xo.layout.chord=function(){function n(){var n,s,f,h,g,p={},v=[],d=Xo.range(i),m=[];for(e=[],r=[],n=0,h=-1;++h<i;){for(s=0,g=-1;++g<i;)s+=u[h][g];v.push(s),m.push(Xo.range(i)),n+=s}for(o&&d.sort(function(n,t){return o(v[n],v[t])}),a&&m.forEach(function(n,t){n.sort(function(n,e){return a(u[t][n],u[t][e])})}),n=(ka-l*i)/n,s=0,h=-1;++h<i;){for(f=s,g=-1;++g<i;){var y=d[h],x=m[y][g],M=u[y][x],_=s,b=s+=M*n;p[y+"-"+x]={index:y,subindex:x,startAngle:_,endAngle:b,value:M}}r[y]={index:y,startAngle:f,endAngle:s,value:(s-f)/n},s+=l}for(h=-1;++h<i;)for(g=h-1;++g<i;){var w=p[h+"-"+g],S=p[g+"-"+h];(w.value||S.value)&&e.push(w.value<S.value?{source:S,target:w}:{source:w,target:S})}c&&t()}function t(){e.sort(function(n,t){return c((n.source.value+n.target.value)/2,(t.source.value+t.target.value)/2)})}var e,r,u,i,o,a,c,s={},l=0;return s.matrix=function(n){return arguments.length?(i=(u=n)&&u.length,e=r=null,s):u},s.padding=function(n){return arguments.length?(l=n,e=r=null,s):l},s.sortGroups=function(n){return arguments.length?(o=n,e=r=null,s):o},s.sortSubgroups=function(n){return arguments.length?(a=n,e=null,s):a},s.sortChords=function(n){return arguments.length?(c=n,e&&t(),s):c},s.chords=function(){return e||n(),e},s.groups=function(){return r||n(),r},s},Xo.layout.force=function(){function n(n){return function(t,e,r,u){if(t.point!==n){var i=t.cx-n.x,o=t.cy-n.y,a=u-e,c=i*i+o*o;if(c>a*a/d){if(p>c){var s=t.charge/c;n.px-=i*s,n.py-=o*s}return!0}if(t.point&&c&&p>c){var s=t.pointCharge/c;n.px-=i*s,n.py-=o*s}}return!t.charge}}function t(n){n.px=Xo.event.x,n.py=Xo.event.y,a.resume()}var e,r,u,i,o,a={},c=Xo.dispatch("start","tick","end"),s=[1,1],l=.9,f=us,h=is,g=-30,p=os,v=.1,d=.64,m=[],y=[];return a.tick=function(){if((r*=.99)<.005)return c.end({type:"end",alpha:r=0}),!0;var t,e,a,f,h,p,d,x,M,_=m.length,b=y.length;for(e=0;b>e;++e)a=y[e],f=a.source,h=a.target,x=h.x-f.x,M=h.y-f.y,(p=x*x+M*M)&&(p=r*i[e]*((p=Math.sqrt(p))-u[e])/p,x*=p,M*=p,h.x-=x*(d=f.weight/(h.weight+f.weight)),h.y-=M*d,f.x+=x*(d=1-d),f.y+=M*d);if((d=r*v)&&(x=s[0]/2,M=s[1]/2,e=-1,d))for(;++e<_;)a=m[e],a.x+=(x-a.x)*d,a.y+=(M-a.y)*d;if(g)for(Zu(t=Xo.geom.quadtree(m),r,o),e=-1;++e<_;)(a=m[e]).fixed||t.visit(n(a));for(e=-1;++e<_;)a=m[e],a.fixed?(a.x=a.px,a.y=a.py):(a.x-=(a.px-(a.px=a.x))*l,a.y-=(a.py-(a.py=a.y))*l);c.tick({type:"tick",alpha:r})},a.nodes=function(n){return arguments.length?(m=n,a):m},a.links=function(n){return arguments.length?(y=n,a):y},a.size=function(n){return arguments.length?(s=n,a):s},a.linkDistance=function(n){return arguments.length?(f="function"==typeof n?n:+n,a):f},a.distance=a.linkDistance,a.linkStrength=function(n){return arguments.length?(h="function"==typeof n?n:+n,a):h},a.friction=function(n){return arguments.length?(l=+n,a):l},a.charge=function(n){return arguments.length?(g="function"==typeof n?n:+n,a):g},a.chargeDistance=function(n){return arguments.length?(p=n*n,a):Math.sqrt(p)},a.gravity=function(n){return arguments.length?(v=+n,a):v},a.theta=function(n){return arguments.length?(d=n*n,a):Math.sqrt(d)},a.alpha=function(n){return arguments.length?(n=+n,r?r=n>0?n:0:n>0&&(c.start({type:"start",alpha:r=n}),Xo.timer(a.tick)),a):r},a.start=function(){function n(n,r){if(!e){for(e=new Array(c),a=0;c>a;++a)e[a]=[];for(a=0;s>a;++a){var u=y[a];e[u.source.index].push(u.target),e[u.target.index].push(u.source)}}for(var i,o=e[t],a=-1,s=o.length;++a<s;)if(!isNaN(i=o[a][n]))return i;return Math.random()*r}var t,e,r,c=m.length,l=y.length,p=s[0],v=s[1];for(t=0;c>t;++t)(r=m[t]).index=t,r.weight=0;for(t=0;l>t;++t)r=y[t],"number"==typeof r.source&&(r.source=m[r.source]),"number"==typeof r.target&&(r.target=m[r.target]),++r.source.weight,++r.target.weight;for(t=0;c>t;++t)r=m[t],isNaN(r.x)&&(r.x=n("x",p)),isNaN(r.y)&&(r.y=n("y",v)),isNaN(r.px)&&(r.px=r.x),isNaN(r.py)&&(r.py=r.y);if(u=[],"function"==typeof f)for(t=0;l>t;++t)u[t]=+f.call(this,y[t],t);else for(t=0;l>t;++t)u[t]=f;if(i=[],"function"==typeof h)for(t=0;l>t;++t)i[t]=+h.call(this,y[t],t);else for(t=0;l>t;++t)i[t]=h;if(o=[],"function"==typeof g)for(t=0;c>t;++t)o[t]=+g.call(this,m[t],t);else for(t=0;c>t;++t)o[t]=g;return a.resume()},a.resume=function(){return a.alpha(.1)},a.stop=function(){return a.alpha(0)},a.drag=function(){return e||(e=Xo.behavior.drag().origin(bt).on("dragstart.force",Fu).on("drag.force",t).on("dragend.force",Ou)),arguments.length?(this.on("mouseover.force",Yu).on("mouseout.force",Iu).call(e),void 0):e},Xo.rebind(a,c,"on")};var us=20,is=1,os=1/0;Xo.layout.hierarchy=function(){function n(t,o,a){var c=u.call(e,t,o);if(t.depth=o,a.push(t),c&&(s=c.length)){for(var s,l,f=-1,h=t.children=new Array(s),g=0,p=o+1;++f<s;)l=h[f]=n(c[f],p,a),l.parent=t,g+=l.value;r&&h.sort(r),i&&(t.value=g)}else delete t.children,i&&(t.value=+i.call(e,t,o)||0);return t}function t(n,r){var u=n.children,o=0;if(u&&(a=u.length))for(var a,c=-1,s=r+1;++c<a;)o+=t(u[c],s);else i&&(o=+i.call(e,n,r)||0);return i&&(n.value=o),o}function e(t){var e=[];return n(t,0,e),e}var r=Bu,u=Xu,i=$u;return e.sort=function(n){return arguments.length?(r=n,e):r},e.children=function(n){return arguments.length?(u=n,e):u},e.value=function(n){return arguments.length?(i=n,e):i},e.revalue=function(n){return t(n,0),n},e},Xo.layout.partition=function(){function n(t,e,r,u){var i=t.children;if(t.x=e,t.y=t.depth*u,t.dx=r,t.dy=u,i&&(o=i.length)){var o,a,c,s=-1;for(r=t.value?r/t.value:0;++s<o;)n(a=i[s],e,c=a.value*r,u),e+=c}}function t(n){var e=n.children,r=0;if(e&&(u=e.length))for(var u,i=-1;++i<u;)r=Math.max(r,t(e[i]));return 1+r}function e(e,i){var o=r.call(this,e,i);return n(o[0],0,u[0],u[1]/t(o[0])),o}var r=Xo.layout.hierarchy(),u=[1,1];return e.size=function(n){return arguments.length?(u=n,e):u},Vu(e,r)},Xo.layout.pie=function(){function n(i){var o=i.map(function(e,r){return+t.call(n,e,r)}),a=+("function"==typeof r?r.apply(this,arguments):r),c=(("function"==typeof u?u.apply(this,arguments):u)-a)/Xo.sum(o),s=Xo.range(i.length);null!=e&&s.sort(e===as?function(n,t){return o[t]-o[n]}:function(n,t){return e(i[n],i[t])});var l=[];return s.forEach(function(n){var t;l[n]={data:i[n],value:t=o[n],startAngle:a,endAngle:a+=t*c}}),l}var t=Number,e=as,r=0,u=ka;return n.value=function(e){return arguments.length?(t=e,n):t},n.sort=function(t){return arguments.length?(e=t,n):e},n.startAngle=function(t){return arguments.length?(r=t,n):r},n.endAngle=function(t){return arguments.length?(u=t,n):u},n};var as={};Xo.layout.stack=function(){function n(a,c){var s=a.map(function(e,r){return t.call(n,e,r)}),l=s.map(function(t){return t.map(function(t,e){return[i.call(n,t,e),o.call(n,t,e)]})}),f=e.call(n,l,c);s=Xo.permute(s,f),l=Xo.permute(l,f);var h,g,p,v=r.call(n,l,c),d=s.length,m=s[0].length;for(g=0;m>g;++g)for(u.call(n,s[0][g],p=v[g],l[0][g][1]),h=1;d>h;++h)u.call(n,s[h][g],p+=l[h-1][g][1],l[h][g][1]);return a}var t=bt,e=Qu,r=ni,u=Ku,i=Ju,o=Gu;return n.values=function(e){return arguments.length?(t=e,n):t},n.order=function(t){return arguments.length?(e="function"==typeof t?t:cs.get(t)||Qu,n):e},n.offset=function(t){return arguments.length?(r="function"==typeof t?t:ss.get(t)||ni,n):r},n.x=function(t){return arguments.length?(i=t,n):i},n.y=function(t){return arguments.length?(o=t,n):o},n.out=function(t){return arguments.length?(u=t,n):u},n};var cs=Xo.map({"inside-out":function(n){var t,e,r=n.length,u=n.map(ti),i=n.map(ei),o=Xo.range(r).sort(function(n,t){return u[n]-u[t]}),a=0,c=0,s=[],l=[];for(t=0;r>t;++t)e=o[t],c>a?(a+=i[e],s.push(e)):(c+=i[e],l.push(e));return l.reverse().concat(s)},reverse:function(n){return Xo.range(n.length).reverse()},"default":Qu}),ss=Xo.map({silhouette:function(n){var t,e,r,u=n.length,i=n[0].length,o=[],a=0,c=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++)r+=n[t][e][1];r>a&&(a=r),o.push(r)}for(e=0;i>e;++e)c[e]=(a-o[e])/2;return c},wiggle:function(n){var t,e,r,u,i,o,a,c,s,l=n.length,f=n[0],h=f.length,g=[];for(g[0]=c=s=0,e=1;h>e;++e){for(t=0,u=0;l>t;++t)u+=n[t][e][1];for(t=0,i=0,a=f[e][0]-f[e-1][0];l>t;++t){for(r=0,o=(n[t][e][1]-n[t][e-1][1])/(2*a);t>r;++r)o+=(n[r][e][1]-n[r][e-1][1])/a;i+=o*n[t][e][1]}g[e]=c-=u?i/u*a:0,s>c&&(s=c)}for(e=0;h>e;++e)g[e]-=s;return g},expand:function(n){var t,e,r,u=n.length,i=n[0].length,o=1/u,a=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++)r+=n[t][e][1];if(r)for(t=0;u>t;t++)n[t][e][1]/=r;else for(t=0;u>t;t++)n[t][e][1]=o}for(e=0;i>e;++e)a[e]=0;return a},zero:ni});Xo.layout.histogram=function(){function n(n,i){for(var o,a,c=[],s=n.map(e,this),l=r.call(this,s,i),f=u.call(this,l,s,i),i=-1,h=s.length,g=f.length-1,p=t?1:1/h;++i<g;)o=c[i]=[],o.dx=f[i+1]-(o.x=f[i]),o.y=0;if(g>0)for(i=-1;++i<h;)a=s[i],a>=l[0]&&a<=l[1]&&(o=c[Xo.bisect(f,a,1,g)-1],o.y+=p,o.push(n[i]));return c}var t=!0,e=Number,r=oi,u=ui;return n.value=function(t){return arguments.length?(e=t,n):e},n.range=function(t){return arguments.length?(r=_t(t),n):r},n.bins=function(t){return arguments.length?(u="number"==typeof t?function(n){return ii(n,t)}:_t(t),n):u},n.frequency=function(e){return arguments.length?(t=!!e,n):t},n},Xo.layout.tree=function(){function n(n,i){function o(n,t){var r=n.children,u=n._tree;if(r&&(i=r.length)){for(var i,a,s,l=r[0],f=l,h=-1;++h<i;)s=r[h],o(s,a),f=c(s,a,f),a=s;vi(n);var g=.5*(l._tree.prelim+s._tree.prelim);t?(u.prelim=t._tree.prelim+e(n,t),u.mod=u.prelim-g):u.prelim=g}else t&&(u.prelim=t._tree.prelim+e(n,t))}function a(n,t){n.x=n._tree.prelim+t;var e=n.children;if(e&&(r=e.length)){var r,u=-1;for(t+=n._tree.mod;++u<r;)a(e[u],t)}}function c(n,t,r){if(t){for(var u,i=n,o=n,a=t,c=n.parent.children[0],s=i._tree.mod,l=o._tree.mod,f=a._tree.mod,h=c._tree.mod;a=si(a),i=ci(i),a&&i;)c=ci(c),o=si(o),o._tree.ancestor=n,u=a._tree.prelim+f-i._tree.prelim-s+e(a,i),u>0&&(di(mi(a,n,r),n,u),s+=u,l+=u),f+=a._tree.mod,s+=i._tree.mod,h+=c._tree.mod,l+=o._tree.mod;a&&!si(o)&&(o._tree.thread=a,o._tree.mod+=f-l),i&&!ci(c)&&(c._tree.thread=i,c._tree.mod+=s-h,r=n)}return r}var s=t.call(this,n,i),l=s[0];pi(l,function(n,t){n._tree={ancestor:n,prelim:0,mod:0,change:0,shift:0,number:t?t._tree.number+1:0}}),o(l),a(l,-l._tree.prelim);var f=li(l,hi),h=li(l,fi),g=li(l,gi),p=f.x-e(f,h)/2,v=h.x+e(h,f)/2,d=g.depth||1;return pi(l,u?function(n){n.x*=r[0],n.y=n.depth*r[1],delete n._tree}:function(n){n.x=(n.x-p)/(v-p)*r[0],n.y=n.depth/d*r[1],delete n._tree}),s}var t=Xo.layout.hierarchy().sort(null).value(null),e=ai,r=[1,1],u=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(u=null==(r=t),n):u?null:r},n.nodeSize=function(t){return arguments.length?(u=null!=(r=t),n):u?r:null},Vu(n,t)},Xo.layout.pack=function(){function n(n,i){var o=e.call(this,n,i),a=o[0],c=u[0],s=u[1],l=null==t?Math.sqrt:"function"==typeof t?t:function(){return t};if(a.x=a.y=0,pi(a,function(n){n.r=+l(n.value)}),pi(a,bi),r){var f=r*(t?1:Math.max(2*a.r/c,2*a.r/s))/2;pi(a,function(n){n.r+=f}),pi(a,bi),pi(a,function(n){n.r-=f})}return ki(a,c/2,s/2,t?1:1/Math.max(2*a.r/c,2*a.r/s)),o}var t,e=Xo.layout.hierarchy().sort(yi),r=0,u=[1,1];return n.size=function(t){return arguments.length?(u=t,n):u},n.radius=function(e){return arguments.length?(t=null==e||"function"==typeof e?e:+e,n):t},n.padding=function(t){return arguments.length?(r=+t,n):r},Vu(n,e)},Xo.layout.cluster=function(){function n(n,i){var o,a=t.call(this,n,i),c=a[0],s=0;pi(c,function(n){var t=n.children;t&&t.length?(n.x=Ci(t),n.y=Ai(t)):(n.x=o?s+=e(n,o):0,n.y=0,o=n)});var l=Ni(c),f=Li(c),h=l.x-e(l,f)/2,g=f.x+e(f,l)/2;return pi(c,u?function(n){n.x=(n.x-c.x)*r[0],n.y=(c.y-n.y)*r[1]}:function(n){n.x=(n.x-h)/(g-h)*r[0],n.y=(1-(c.y?n.y/c.y:1))*r[1]}),a}var t=Xo.layout.hierarchy().sort(null).value(null),e=ai,r=[1,1],u=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(u=null==(r=t),n):u?null:r},n.nodeSize=function(t){return arguments.length?(u=null!=(r=t),n):u?r:null},Vu(n,t)},Xo.layout.treemap=function(){function n(n,t){for(var e,r,u=-1,i=n.length;++u<i;)r=(e=n[u]).value*(0>t?0:t),e.area=isNaN(r)||0>=r?0:r}function t(e){var i=e.children;if(i&&i.length){var o,a,c,s=f(e),l=[],h=i.slice(),p=1/0,v="slice"===g?s.dx:"dice"===g?s.dy:"slice-dice"===g?1&e.depth?s.dy:s.dx:Math.min(s.dx,s.dy);for(n(h,s.dx*s.dy/e.value),l.area=0;(c=h.length)>0;)l.push(o=h[c-1]),l.area+=o.area,"squarify"!==g||(a=r(l,v))<=p?(h.pop(),p=a):(l.area-=l.pop().area,u(l,v,s,!1),v=Math.min(s.dx,s.dy),l.length=l.area=0,p=1/0);l.length&&(u(l,v,s,!0),l.length=l.area=0),i.forEach(t)}}function e(t){var r=t.children;if(r&&r.length){var i,o=f(t),a=r.slice(),c=[];for(n(a,o.dx*o.dy/t.value),c.area=0;i=a.pop();)c.push(i),c.area+=i.area,null!=i.z&&(u(c,i.z?o.dx:o.dy,o,!a.length),c.length=c.area=0);r.forEach(e)}}function r(n,t){for(var e,r=n.area,u=0,i=1/0,o=-1,a=n.length;++o<a;)(e=n[o].area)&&(i>e&&(i=e),e>u&&(u=e));return r*=r,t*=t,r?Math.max(t*u*p/r,r/(t*i*p)):1/0}function u(n,t,e,r){var u,i=-1,o=n.length,a=e.x,s=e.y,l=t?c(n.area/t):0;if(t==e.dx){for((r||l>e.dy)&&(l=e.dy);++i<o;)u=n[i],u.x=a,u.y=s,u.dy=l,a+=u.dx=Math.min(e.x+e.dx-a,l?c(u.area/l):0);u.z=!0,u.dx+=e.x+e.dx-a,e.y+=l,e.dy-=l}else{for((r||l>e.dx)&&(l=e.dx);++i<o;)u=n[i],u.x=a,u.y=s,u.dx=l,s+=u.dy=Math.min(e.y+e.dy-s,l?c(u.area/l):0);u.z=!1,u.dy+=e.y+e.dy-s,e.x+=l,e.dx-=l}}function i(r){var u=o||a(r),i=u[0];return i.x=0,i.y=0,i.dx=s[0],i.dy=s[1],o&&a.revalue(i),n([i],i.dx*i.dy/i.value),(o?e:t)(i),h&&(o=u),u}var o,a=Xo.layout.hierarchy(),c=Math.round,s=[1,1],l=null,f=zi,h=!1,g="squarify",p=.5*(1+Math.sqrt(5));return i.size=function(n){return arguments.length?(s=n,i):s},i.padding=function(n){function t(t){var e=n.call(i,t,t.depth);return null==e?zi(t):qi(t,"number"==typeof e?[e,e,e,e]:e)}function e(t){return qi(t,n)}if(!arguments.length)return l;var r;return f=null==(l=n)?zi:"function"==(r=typeof n)?t:"number"===r?(n=[n,n,n,n],e):e,i},i.round=function(n){return arguments.length?(c=n?Math.round:Number,i):c!=Number},i.sticky=function(n){return arguments.length?(h=n,o=null,i):h},i.ratio=function(n){return arguments.length?(p=n,i):p},i.mode=function(n){return arguments.length?(g=n+"",i):g},Vu(i,a)},Xo.random={normal:function(n,t){var e=arguments.length;return 2>e&&(t=1),1>e&&(n=0),function(){var e,r,u;do e=2*Math.random()-1,r=2*Math.random()-1,u=e*e+r*r;while(!u||u>1);return n+t*e*Math.sqrt(-2*Math.log(u)/u)}},logNormal:function(){var n=Xo.random.normal.apply(Xo,arguments);return function(){return Math.exp(n())}},bates:function(n){var t=Xo.random.irwinHall(n);return function(){return t()/n}},irwinHall:function(n){return function(){for(var t=0,e=0;n>e;e++)t+=Math.random();return t}}},Xo.scale={};var ls={floor:bt,ceil:bt};Xo.scale.linear=function(){return Hi([0,1],[0,1],fu,!1)};var fs={s:1,g:1,p:1,r:1,e:1};Xo.scale.log=function(){return $i(Xo.scale.linear().domain([0,1]),10,!0,[1,10])};var hs=Xo.format(".0e"),gs={floor:function(n){return-Math.ceil(-n)},ceil:function(n){return-Math.floor(-n)}};Xo.scale.pow=function(){return Bi(Xo.scale.linear(),1,[0,1])},Xo.scale.sqrt=function(){return Xo.scale.pow().exponent(.5)},Xo.scale.ordinal=function(){return Ji([],{t:"range",a:[[]]})},Xo.scale.category10=function(){return Xo.scale.ordinal().range(ps)},Xo.scale.category20=function(){return Xo.scale.ordinal().range(vs)},Xo.scale.category20b=function(){return Xo.scale.ordinal().range(ds)},Xo.scale.category20c=function(){return Xo.scale.ordinal().range(ms)};var ps=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(ht),vs=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(ht),ds=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(ht),ms=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(ht);Xo.scale.quantile=function(){return Gi([],[])
+},Xo.scale.quantize=function(){return Ki(0,1,[0,1])},Xo.scale.threshold=function(){return Qi([.5],[0,1])},Xo.scale.identity=function(){return no([0,1])},Xo.svg={},Xo.svg.arc=function(){function n(){var n=t.apply(this,arguments),i=e.apply(this,arguments),o=r.apply(this,arguments)+ys,a=u.apply(this,arguments)+ys,c=(o>a&&(c=o,o=a,a=c),a-o),s=Sa>c?"0":"1",l=Math.cos(o),f=Math.sin(o),h=Math.cos(a),g=Math.sin(a);return c>=xs?n?"M0,"+i+"A"+i+","+i+" 0 1,1 0,"+-i+"A"+i+","+i+" 0 1,1 0,"+i+"M0,"+n+"A"+n+","+n+" 0 1,0 0,"+-n+"A"+n+","+n+" 0 1,0 0,"+n+"Z":"M0,"+i+"A"+i+","+i+" 0 1,1 0,"+-i+"A"+i+","+i+" 0 1,1 0,"+i+"Z":n?"M"+i*l+","+i*f+"A"+i+","+i+" 0 "+s+",1 "+i*h+","+i*g+"L"+n*h+","+n*g+"A"+n+","+n+" 0 "+s+",0 "+n*l+","+n*f+"Z":"M"+i*l+","+i*f+"A"+i+","+i+" 0 "+s+",1 "+i*h+","+i*g+"L0,0"+"Z"}var t=to,e=eo,r=ro,u=uo;return n.innerRadius=function(e){return arguments.length?(t=_t(e),n):t},n.outerRadius=function(t){return arguments.length?(e=_t(t),n):e},n.startAngle=function(t){return arguments.length?(r=_t(t),n):r},n.endAngle=function(t){return arguments.length?(u=_t(t),n):u},n.centroid=function(){var n=(t.apply(this,arguments)+e.apply(this,arguments))/2,i=(r.apply(this,arguments)+u.apply(this,arguments))/2+ys;return[Math.cos(i)*n,Math.sin(i)*n]},n};var ys=-Ea,xs=ka-Aa;Xo.svg.line=function(){return io(bt)};var Ms=Xo.map({linear:oo,"linear-closed":ao,step:co,"step-before":so,"step-after":lo,basis:mo,"basis-open":yo,"basis-closed":xo,bundle:Mo,cardinal:go,"cardinal-open":fo,"cardinal-closed":ho,monotone:Eo});Ms.forEach(function(n,t){t.key=n,t.closed=/-closed$/.test(n)});var _s=[0,2/3,1/3,0],bs=[0,1/3,2/3,0],ws=[0,1/6,2/3,1/6];Xo.svg.line.radial=function(){var n=io(Ao);return n.radius=n.x,delete n.x,n.angle=n.y,delete n.y,n},so.reverse=lo,lo.reverse=so,Xo.svg.area=function(){return Co(bt)},Xo.svg.area.radial=function(){var n=Co(Ao);return n.radius=n.x,delete n.x,n.innerRadius=n.x0,delete n.x0,n.outerRadius=n.x1,delete n.x1,n.angle=n.y,delete n.y,n.startAngle=n.y0,delete n.y0,n.endAngle=n.y1,delete n.y1,n},Xo.svg.chord=function(){function n(n,a){var c=t(this,i,n,a),s=t(this,o,n,a);return"M"+c.p0+r(c.r,c.p1,c.a1-c.a0)+(e(c,s)?u(c.r,c.p1,c.r,c.p0):u(c.r,c.p1,s.r,s.p0)+r(s.r,s.p1,s.a1-s.a0)+u(s.r,s.p1,c.r,c.p0))+"Z"}function t(n,t,e,r){var u=t.call(n,e,r),i=a.call(n,u,r),o=c.call(n,u,r)+ys,l=s.call(n,u,r)+ys;return{r:i,a0:o,a1:l,p0:[i*Math.cos(o),i*Math.sin(o)],p1:[i*Math.cos(l),i*Math.sin(l)]}}function e(n,t){return n.a0==t.a0&&n.a1==t.a1}function r(n,t,e){return"A"+n+","+n+" 0 "+ +(e>Sa)+",1 "+t}function u(n,t,e,r){return"Q 0,0 "+r}var i=hr,o=gr,a=No,c=ro,s=uo;return n.radius=function(t){return arguments.length?(a=_t(t),n):a},n.source=function(t){return arguments.length?(i=_t(t),n):i},n.target=function(t){return arguments.length?(o=_t(t),n):o},n.startAngle=function(t){return arguments.length?(c=_t(t),n):c},n.endAngle=function(t){return arguments.length?(s=_t(t),n):s},n},Xo.svg.diagonal=function(){function n(n,u){var i=t.call(this,n,u),o=e.call(this,n,u),a=(i.y+o.y)/2,c=[i,{x:i.x,y:a},{x:o.x,y:a},o];return c=c.map(r),"M"+c[0]+"C"+c[1]+" "+c[2]+" "+c[3]}var t=hr,e=gr,r=Lo;return n.source=function(e){return arguments.length?(t=_t(e),n):t},n.target=function(t){return arguments.length?(e=_t(t),n):e},n.projection=function(t){return arguments.length?(r=t,n):r},n},Xo.svg.diagonal.radial=function(){var n=Xo.svg.diagonal(),t=Lo,e=n.projection;return n.projection=function(n){return arguments.length?e(zo(t=n)):t},n},Xo.svg.symbol=function(){function n(n,r){return(Ss.get(t.call(this,n,r))||Ro)(e.call(this,n,r))}var t=To,e=qo;return n.type=function(e){return arguments.length?(t=_t(e),n):t},n.size=function(t){return arguments.length?(e=_t(t),n):e},n};var Ss=Xo.map({circle:Ro,cross:function(n){var t=Math.sqrt(n/5)/2;return"M"+-3*t+","+-t+"H"+-t+"V"+-3*t+"H"+t+"V"+-t+"H"+3*t+"V"+t+"H"+t+"V"+3*t+"H"+-t+"V"+t+"H"+-3*t+"Z"},diamond:function(n){var t=Math.sqrt(n/(2*Cs)),e=t*Cs;return"M0,"+-t+"L"+e+",0"+" 0,"+t+" "+-e+",0"+"Z"},square:function(n){var t=Math.sqrt(n)/2;return"M"+-t+","+-t+"L"+t+","+-t+" "+t+","+t+" "+-t+","+t+"Z"},"triangle-down":function(n){var t=Math.sqrt(n/As),e=t*As/2;return"M0,"+e+"L"+t+","+-e+" "+-t+","+-e+"Z"},"triangle-up":function(n){var t=Math.sqrt(n/As),e=t*As/2;return"M0,"+-e+"L"+t+","+e+" "+-t+","+e+"Z"}});Xo.svg.symbolTypes=Ss.keys();var ks,Es,As=Math.sqrt(3),Cs=Math.tan(30*Na),Ns=[],Ls=0;Ns.call=da.call,Ns.empty=da.empty,Ns.node=da.node,Ns.size=da.size,Xo.transition=function(n){return arguments.length?ks?n.transition():n:xa.transition()},Xo.transition.prototype=Ns,Ns.select=function(n){var t,e,r,u=this.id,i=[];n=M(n);for(var o=-1,a=this.length;++o<a;){i.push(t=[]);for(var c=this[o],s=-1,l=c.length;++s<l;)(r=c[s])&&(e=n.call(r,r.__data__,s,o))?("__data__"in r&&(e.__data__=r.__data__),jo(e,s,u,r.__transition__[u]),t.push(e)):t.push(null)}return Do(i,u)},Ns.selectAll=function(n){var t,e,r,u,i,o=this.id,a=[];n=_(n);for(var c=-1,s=this.length;++c<s;)for(var l=this[c],f=-1,h=l.length;++f<h;)if(r=l[f]){i=r.__transition__[o],e=n.call(r,r.__data__,f,c),a.push(t=[]);for(var g=-1,p=e.length;++g<p;)(u=e[g])&&jo(u,g,o,i),t.push(u)}return Do(a,o)},Ns.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=q(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]);for(var e=this[i],a=0,c=e.length;c>a;a++)(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}return Do(u,this.id)},Ns.tween=function(n,t){var e=this.id;return arguments.length<2?this.node().__transition__[e].tween.get(n):R(this,null==t?function(t){t.__transition__[e].tween.remove(n)}:function(r){r.__transition__[e].tween.set(n,t)})},Ns.attr=function(n,t){function e(){this.removeAttribute(a)}function r(){this.removeAttributeNS(a.space,a.local)}function u(n){return null==n?e:(n+="",function(){var t,e=this.getAttribute(a);return e!==n&&(t=o(e,n),function(n){this.setAttribute(a,t(n))})})}function i(n){return null==n?r:(n+="",function(){var t,e=this.getAttributeNS(a.space,a.local);return e!==n&&(t=o(e,n),function(n){this.setAttributeNS(a.space,a.local,t(n))})})}if(arguments.length<2){for(t in n)this.attr(t,n[t]);return this}var o="transform"==n?Ru:fu,a=Xo.ns.qualify(n);return Po(this,"attr."+n,t,a.local?i:u)},Ns.attrTween=function(n,t){function e(n,e){var r=t.call(this,n,e,this.getAttribute(u));return r&&function(n){this.setAttribute(u,r(n))}}function r(n,e){var r=t.call(this,n,e,this.getAttributeNS(u.space,u.local));return r&&function(n){this.setAttributeNS(u.space,u.local,r(n))}}var u=Xo.ns.qualify(n);return this.tween("attr."+n,u.local?r:e)},Ns.style=function(n,t,e){function r(){this.style.removeProperty(n)}function u(t){return null==t?r:(t+="",function(){var r,u=Go.getComputedStyle(this,null).getPropertyValue(n);return u!==t&&(r=fu(u,t),function(t){this.style.setProperty(n,r(t),e)})})}var i=arguments.length;if(3>i){if("string"!=typeof n){2>i&&(t="");for(e in n)this.style(e,n[e],t);return this}e=""}return Po(this,"style."+n,t,u)},Ns.styleTween=function(n,t,e){function r(r,u){var i=t.call(this,r,u,Go.getComputedStyle(this,null).getPropertyValue(n));return i&&function(t){this.style.setProperty(n,i(t),e)}}return arguments.length<3&&(e=""),this.tween("style."+n,r)},Ns.text=function(n){return Po(this,"text",n,Uo)},Ns.remove=function(){return this.each("end.transition",function(){var n;this.__transition__.count<2&&(n=this.parentNode)&&n.removeChild(this)})},Ns.ease=function(n){var t=this.id;return arguments.length<1?this.node().__transition__[t].ease:("function"!=typeof n&&(n=Xo.ease.apply(Xo,arguments)),R(this,function(e){e.__transition__[t].ease=n}))},Ns.delay=function(n){var t=this.id;return R(this,"function"==typeof n?function(e,r,u){e.__transition__[t].delay=+n.call(e,e.__data__,r,u)}:(n=+n,function(e){e.__transition__[t].delay=n}))},Ns.duration=function(n){var t=this.id;return R(this,"function"==typeof n?function(e,r,u){e.__transition__[t].duration=Math.max(1,n.call(e,e.__data__,r,u))}:(n=Math.max(1,n),function(e){e.__transition__[t].duration=n}))},Ns.each=function(n,t){var e=this.id;if(arguments.length<2){var r=Es,u=ks;ks=e,R(this,function(t,r,u){Es=t.__transition__[e],n.call(t,t.__data__,r,u)}),Es=r,ks=u}else R(this,function(r){var u=r.__transition__[e];(u.event||(u.event=Xo.dispatch("start","end"))).on(n,t)});return this},Ns.transition=function(){for(var n,t,e,r,u=this.id,i=++Ls,o=[],a=0,c=this.length;c>a;a++){o.push(n=[]);for(var t=this[a],s=0,l=t.length;l>s;s++)(e=t[s])&&(r=Object.create(e.__transition__[u]),r.delay+=r.duration,jo(e,s,i,r)),n.push(e)}return Do(o,i)},Xo.svg.axis=function(){function n(n){n.each(function(){var n,s=Xo.select(this),l=this.__chart__||e,f=this.__chart__=e.copy(),h=null==c?f.ticks?f.ticks.apply(f,a):f.domain():c,g=null==t?f.tickFormat?f.tickFormat.apply(f,a):bt:t,p=s.selectAll(".tick").data(h,f),v=p.enter().insert("g",".domain").attr("class","tick").style("opacity",Aa),d=Xo.transition(p.exit()).style("opacity",Aa).remove(),m=Xo.transition(p).style("opacity",1),y=Ri(f),x=s.selectAll(".domain").data([0]),M=(x.enter().append("path").attr("class","domain"),Xo.transition(x));v.append("line"),v.append("text");var _=v.select("line"),b=m.select("line"),w=p.select("text").text(g),S=v.select("text"),k=m.select("text");switch(r){case"bottom":n=Ho,_.attr("y2",u),S.attr("y",Math.max(u,0)+o),b.attr("x2",0).attr("y2",u),k.attr("x",0).attr("y",Math.max(u,0)+o),w.attr("dy",".71em").style("text-anchor","middle"),M.attr("d","M"+y[0]+","+i+"V0H"+y[1]+"V"+i);break;case"top":n=Ho,_.attr("y2",-u),S.attr("y",-(Math.max(u,0)+o)),b.attr("x2",0).attr("y2",-u),k.attr("x",0).attr("y",-(Math.max(u,0)+o)),w.attr("dy","0em").style("text-anchor","middle"),M.attr("d","M"+y[0]+","+-i+"V0H"+y[1]+"V"+-i);break;case"left":n=Fo,_.attr("x2",-u),S.attr("x",-(Math.max(u,0)+o)),b.attr("x2",-u).attr("y2",0),k.attr("x",-(Math.max(u,0)+o)).attr("y",0),w.attr("dy",".32em").style("text-anchor","end"),M.attr("d","M"+-i+","+y[0]+"H0V"+y[1]+"H"+-i);break;case"right":n=Fo,_.attr("x2",u),S.attr("x",Math.max(u,0)+o),b.attr("x2",u).attr("y2",0),k.attr("x",Math.max(u,0)+o).attr("y",0),w.attr("dy",".32em").style("text-anchor","start"),M.attr("d","M"+i+","+y[0]+"H0V"+y[1]+"H"+i)}if(f.rangeBand){var E=f,A=E.rangeBand()/2;l=f=function(n){return E(n)+A}}else l.rangeBand?l=f:d.call(n,f);v.call(n,l),m.call(n,f)})}var t,e=Xo.scale.linear(),r=zs,u=6,i=6,o=3,a=[10],c=null;return n.scale=function(t){return arguments.length?(e=t,n):e},n.orient=function(t){return arguments.length?(r=t in qs?t+"":zs,n):r},n.ticks=function(){return arguments.length?(a=arguments,n):a},n.tickValues=function(t){return arguments.length?(c=t,n):c},n.tickFormat=function(e){return arguments.length?(t=e,n):t},n.tickSize=function(t){var e=arguments.length;return e?(u=+t,i=+arguments[e-1],n):u},n.innerTickSize=function(t){return arguments.length?(u=+t,n):u},n.outerTickSize=function(t){return arguments.length?(i=+t,n):i},n.tickPadding=function(t){return arguments.length?(o=+t,n):o},n.tickSubdivide=function(){return arguments.length&&n},n};var zs="bottom",qs={top:1,right:1,bottom:1,left:1};Xo.svg.brush=function(){function n(i){i.each(function(){var i=Xo.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",u).on("touchstart.brush",u),o=i.selectAll(".background").data([0]);o.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),i.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var a=i.selectAll(".resize").data(p,bt);a.exit().remove(),a.enter().append("g").attr("class",function(n){return"resize "+n}).style("cursor",function(n){return Ts[n]}).append("rect").attr("x",function(n){return/[ew]$/.test(n)?-3:null}).attr("y",function(n){return/^[ns]/.test(n)?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden"),a.style("display",n.empty()?"none":null);var l,f=Xo.transition(i),h=Xo.transition(o);c&&(l=Ri(c),h.attr("x",l[0]).attr("width",l[1]-l[0]),e(f)),s&&(l=Ri(s),h.attr("y",l[0]).attr("height",l[1]-l[0]),r(f)),t(f)})}function t(n){n.selectAll(".resize").attr("transform",function(n){return"translate("+l[+/e$/.test(n)]+","+f[+/^s/.test(n)]+")"})}function e(n){n.select(".extent").attr("x",l[0]),n.selectAll(".extent,.n>rect,.s>rect").attr("width",l[1]-l[0])}function r(n){n.select(".extent").attr("y",f[0]),n.selectAll(".extent,.e>rect,.w>rect").attr("height",f[1]-f[0])}function u(){function u(){32==Xo.event.keyCode&&(C||(x=null,L[0]-=l[1],L[1]-=f[1],C=2),d())}function p(){32==Xo.event.keyCode&&2==C&&(L[0]+=l[1],L[1]+=f[1],C=0,d())}function v(){var n=Xo.mouse(_),u=!1;M&&(n[0]+=M[0],n[1]+=M[1]),C||(Xo.event.altKey?(x||(x=[(l[0]+l[1])/2,(f[0]+f[1])/2]),L[0]=l[+(n[0]<x[0])],L[1]=f[+(n[1]<x[1])]):x=null),E&&m(n,c,0)&&(e(S),u=!0),A&&m(n,s,1)&&(r(S),u=!0),u&&(t(S),w({type:"brush",mode:C?"move":"resize"}))}function m(n,t,e){var r,u,a=Ri(t),c=a[0],s=a[1],p=L[e],v=e?f:l,d=v[1]-v[0];return C&&(c-=p,s-=d+p),r=(e?g:h)?Math.max(c,Math.min(s,n[e])):n[e],C?u=(r+=p)+d:(x&&(p=Math.max(c,Math.min(s,2*x[e]-r))),r>p?(u=r,r=p):u=p),v[0]!=r||v[1]!=u?(e?o=null:i=null,v[0]=r,v[1]=u,!0):void 0}function y(){v(),S.style("pointer-events","all").selectAll(".resize").style("display",n.empty()?"none":null),Xo.select("body").style("cursor",null),z.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null),N(),w({type:"brushend"})}var x,M,_=this,b=Xo.select(Xo.event.target),w=a.of(_,arguments),S=Xo.select(_),k=b.datum(),E=!/^(n|s)$/.test(k)&&c,A=!/^(e|w)$/.test(k)&&s,C=b.classed("extent"),N=O(),L=Xo.mouse(_),z=Xo.select(Go).on("keydown.brush",u).on("keyup.brush",p);if(Xo.event.changedTouches?z.on("touchmove.brush",v).on("touchend.brush",y):z.on("mousemove.brush",v).on("mouseup.brush",y),S.interrupt().selectAll("*").interrupt(),C)L[0]=l[0]-L[0],L[1]=f[0]-L[1];else if(k){var q=+/w$/.test(k),T=+/^n/.test(k);M=[l[1-q]-L[0],f[1-T]-L[1]],L[0]=l[q],L[1]=f[T]}else Xo.event.altKey&&(x=L.slice());S.style("pointer-events","none").selectAll(".resize").style("display",null),Xo.select("body").style("cursor",b.style("cursor")),w({type:"brushstart"}),v()}var i,o,a=y(n,"brushstart","brush","brushend"),c=null,s=null,l=[0,0],f=[0,0],h=!0,g=!0,p=Rs[0];return n.event=function(n){n.each(function(){var n=a.of(this,arguments),t={x:l,y:f,i:i,j:o},e=this.__chart__||t;this.__chart__=t,ks?Xo.select(this).transition().each("start.brush",function(){i=e.i,o=e.j,l=e.x,f=e.y,n({type:"brushstart"})}).tween("brush:brush",function(){var e=hu(l,t.x),r=hu(f,t.y);return i=o=null,function(u){l=t.x=e(u),f=t.y=r(u),n({type:"brush",mode:"resize"})}}).each("end.brush",function(){i=t.i,o=t.j,n({type:"brush",mode:"resize"}),n({type:"brushend"})}):(n({type:"brushstart"}),n({type:"brush",mode:"resize"}),n({type:"brushend"}))})},n.x=function(t){return arguments.length?(c=t,p=Rs[!c<<1|!s],n):c},n.y=function(t){return arguments.length?(s=t,p=Rs[!c<<1|!s],n):s},n.clamp=function(t){return arguments.length?(c&&s?(h=!!t[0],g=!!t[1]):c?h=!!t:s&&(g=!!t),n):c&&s?[h,g]:c?h:s?g:null},n.extent=function(t){var e,r,u,a,h;return arguments.length?(c&&(e=t[0],r=t[1],s&&(e=e[0],r=r[0]),i=[e,r],c.invert&&(e=c(e),r=c(r)),e>r&&(h=e,e=r,r=h),(e!=l[0]||r!=l[1])&&(l=[e,r])),s&&(u=t[0],a=t[1],c&&(u=u[1],a=a[1]),o=[u,a],s.invert&&(u=s(u),a=s(a)),u>a&&(h=u,u=a,a=h),(u!=f[0]||a!=f[1])&&(f=[u,a])),n):(c&&(i?(e=i[0],r=i[1]):(e=l[0],r=l[1],c.invert&&(e=c.invert(e),r=c.invert(r)),e>r&&(h=e,e=r,r=h))),s&&(o?(u=o[0],a=o[1]):(u=f[0],a=f[1],s.invert&&(u=s.invert(u),a=s.invert(a)),u>a&&(h=u,u=a,a=h))),c&&s?[[e,u],[r,a]]:c?[e,r]:s&&[u,a])},n.clear=function(){return n.empty()||(l=[0,0],f=[0,0],i=o=null),n},n.empty=function(){return!!c&&l[0]==l[1]||!!s&&f[0]==f[1]},Xo.rebind(n,a,"on")};var Ts={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},Rs=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]],Ds=tc.format=ac.timeFormat,Ps=Ds.utc,Us=Ps("%Y-%m-%dT%H:%M:%S.%LZ");Ds.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?Oo:Us,Oo.parse=function(n){var t=new Date(n);return isNaN(t)?null:t},Oo.toString=Us.toString,tc.second=Rt(function(n){return new ec(1e3*Math.floor(n/1e3))},function(n,t){n.setTime(n.getTime()+1e3*Math.floor(t))},function(n){return n.getSeconds()}),tc.seconds=tc.second.range,tc.seconds.utc=tc.second.utc.range,tc.minute=Rt(function(n){return new ec(6e4*Math.floor(n/6e4))},function(n,t){n.setTime(n.getTime()+6e4*Math.floor(t))},function(n){return n.getMinutes()}),tc.minutes=tc.minute.range,tc.minutes.utc=tc.minute.utc.range,tc.hour=Rt(function(n){var t=n.getTimezoneOffset()/60;return new ec(36e5*(Math.floor(n/36e5-t)+t))},function(n,t){n.setTime(n.getTime()+36e5*Math.floor(t))},function(n){return n.getHours()}),tc.hours=tc.hour.range,tc.hours.utc=tc.hour.utc.range,tc.month=Rt(function(n){return n=tc.day(n),n.setDate(1),n},function(n,t){n.setMonth(n.getMonth()+t)},function(n){return n.getMonth()}),tc.months=tc.month.range,tc.months.utc=tc.month.utc.range;var js=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6],Hs=[[tc.second,1],[tc.second,5],[tc.second,15],[tc.second,30],[tc.minute,1],[tc.minute,5],[tc.minute,15],[tc.minute,30],[tc.hour,1],[tc.hour,3],[tc.hour,6],[tc.hour,12],[tc.day,1],[tc.day,2],[tc.week,1],[tc.month,1],[tc.month,3],[tc.year,1]],Fs=Ds.multi([[".%L",function(n){return n.getMilliseconds()}],[":%S",function(n){return n.getSeconds()}],["%I:%M",function(n){return n.getMinutes()}],["%I %p",function(n){return n.getHours()}],["%a %d",function(n){return n.getDay()&&1!=n.getDate()}],["%b %d",function(n){return 1!=n.getDate()}],["%B",function(n){return n.getMonth()}],["%Y",be]]),Os={range:function(n,t,e){return Xo.range(+n,+t,e).map(Io)},floor:bt,ceil:bt};Hs.year=tc.year,tc.scale=function(){return Yo(Xo.scale.linear(),Hs,Fs)};var Ys=Hs.map(function(n){return[n[0].utc,n[1]]}),Is=Ps.multi([[".%L",function(n){return n.getUTCMilliseconds()}],[":%S",function(n){return n.getUTCSeconds()}],["%I:%M",function(n){return n.getUTCMinutes()}],["%I %p",function(n){return n.getUTCHours()}],["%a %d",function(n){return n.getUTCDay()&&1!=n.getUTCDate()}],["%b %d",function(n){return 1!=n.getUTCDate()}],["%B",function(n){return n.getUTCMonth()}],["%Y",be]]);Ys.year=tc.year.utc,tc.scale.utc=function(){return Yo(Xo.scale.linear(),Ys,Is)},Xo.text=wt(function(n){return n.responseText}),Xo.json=function(n,t){return St(n,"application/json",Zo,t)},Xo.html=function(n,t){return St(n,"text/html",Vo,t)},Xo.xml=wt(function(n){return n.responseXML}),"function"==typeof define&&define.amd?define(Xo):"object"==typeof module&&module.exports?module.exports=Xo:this.d3=Xo}();
\ No newline at end of file
diff --git a/web/src/main/webapp/js/ghrequest.js b/web/src/main/webapp/js/ghrequest.js
index cfee31d616..6a78c27a99 100644
--- a/web/src/main/webapp/js/ghrequest.js
+++ b/web/src/main/webapp/js/ghrequest.js
@@ -1,28 +1,34 @@
 // IE fix
 if (!window.console) {
     var console = {
-        log: function() {},
-        warn: function() {},
-        error: function() {},
-        time: function() {},
-        timeEnd: function() {}
+        log: function() {
+        },
+        warn: function() {
+        },
+        error: function() {
+        },
+        time: function() {
+        },
+        timeEnd: function() {
+        }
     };
 }
 
 GHRequest = function(host) {
-    this.minPathPrecision = 1;
+    this.min_path_precision = 1;
     this.host = host;
     this.from = new GHInput("");
     this.to = new GHInput("");
     this.vehicle = "car";
     this.weighting = "fastest";
-    this.encodedPolyline = true;
+    this.points_encoded = true;
     this.instructions = true;
     this.debug = false;
     this.locale = "en";
-    this.doZoom = true;
-    // if your server allows CORS you can use json here
+    this.do_zoom = true;
+    // use jsonp here if host allows CORS
     this.dataType = "jsonp";
+    this.key = "tcV28oCCNIzu4GD1Hsp8dYGAHqFBXvYrBvBwthGE";
 };
 
 GHRequest.prototype.init = function(params) {
@@ -44,17 +50,14 @@ GHRequest.prototype.init = function(params) {
         this.vehicle = params.vehicle;
     if (params.weighting)
         this.weighting = params.weighting;
-    // REMOVE_IN 0.3
-    if (params.algoType)
-        this.weighting = params.algoType;
     if (params.algorithm)
         this.algorithm = params.algorithm;
     if (params.locale)
         this.locale = params.locale;
 
-    this.handleBoolean("doZoom", params);
+    this.handleBoolean("do_zoom", params);
     this.handleBoolean("instructions", params);
-    this.handleBoolean("encodedPolyline", params);
+    this.handleBoolean("points_encoded", params);
 
     if (params.q) {
         var qStr = params.q;
@@ -75,7 +78,7 @@ GHRequest.prototype.init = function(params) {
             var points = qStr.split("p:");
             for (var i = 0; i < points.length; i++) {
                 var str = points[i].trim();
-                if (str.length == 0)
+                if (str.length === 0)
                     continue;
 
                 params.point.push(str);
@@ -86,17 +89,21 @@ GHRequest.prototype.init = function(params) {
 
 GHRequest.prototype.handleBoolean = function(key, params) {
     if (key in params)
-        this.doZoom = params[key] == "true" || params[key] == true;
+        this[key] = params[key] === "true" || params[key] === true;
+};
+
+GHRequest.prototype.createGeocodeURL = function() {
+    return this.createPath(this.host + "/geocode?limit=8&type=" + this.dataType + "&key=" + this.key);
 };
 
 GHRequest.prototype.createURL = function(demoUrl) {
-    return this.createPath(this.host + "/api/route?" + demoUrl + "&type=" + this.dataType);
+    return this.createPath(this.host + "/route?" + demoUrl + "&type=" + this.dataType + "&key=" + this.key);
 };
 
 GHRequest.prototype.createGPXURL = function() {
     // use points instead of strings
     var str = "point=" + encodeURIComponent(this.from.toString()) + "&point=" + encodeURIComponent(this.to.toString());
-    return this.createPath(this.host + "/api/route?" + str + "&type=gpx");
+    return this.createPath(this.host + "/route?" + str + "&type=gpx&key=" + this.key);
 };
 
 GHRequest.prototype.createFullURL = function() {
@@ -117,22 +124,23 @@ GHRequest.prototype.createPath = function(url) {
         url += "&algorithm=" + this.algorithm;
     if (!this.instructions)
         url += "&instructions=false";
-    if (!this.encodedPolyline)
-        url += "&encodedPolyline=false";
-    if (this.minPathPrecision != 1)
-        url += "&minPathPrecision=" + this.minPathPrecision;
+    if (!this.points_encoded)
+        url += "&points_encoded=false";
+    if (this.min_path_precision !== 1)
+        url += "&min_path_precision=" + this.min_path_precision;
     if (this.debug)
         url += "&debug=true";
     return url;
 }
 
-function decodePath(encoded, geoJson) {
-    var start = new Date().getTime();
+function decodePath(encoded, is3D) {
+    // var start = new Date().getTime();
     var len = encoded.length;
     var index = 0;
     var array = [];
     var lat = 0;
     var lng = 0;
+    var ele = 0;
 
     while (index < len) {
         var b;
@@ -156,37 +164,50 @@ function decodePath(encoded, geoJson) {
         var deltaLon = ((result & 1) ? ~(result >> 1) : (result >> 1));
         lng += deltaLon;
 
-        if (geoJson)
+        if (is3D) {
+            // elevation
+            shift = 0;
+            result = 0;
+            do
+            {
+                b = encoded.charCodeAt(index++) - 63;
+                result |= (b & 0x1f) << shift;
+                shift += 5;
+            } while (b >= 0x20);
+            var deltaEle = ((result & 1) ? ~(result >> 1) : (result >> 1));
+            ele += deltaEle;
+            array.push([lng * 1e-5, lat * 1e-5, ele / 100]);
+        } else
             array.push([lng * 1e-5, lat * 1e-5]);
-        else
-            array.push([lat * 1e-5, lng * 1e-5]);
     }
-    var end = new Date().getTime();
-    console.log("decoded " + len + " coordinates in " + ((end - start) / 1000) + "s");
+    // var end = new Date().getTime();
+    // console.log("decoded " + len + " coordinates in " + ((end - start) / 1000) + "s");
     return array;
 }
 
 GHRequest.prototype.doRequest = function(url, callback) {
-    var tmpEncodedPolyline = this.encodedPolyline;
     $.ajax({
         "timeout": 30000,
         "url": url,
         "success": function(json) {
-            if (tmpEncodedPolyline && json.route) {
-                // convert encoded polyline stuff to normal json
-                if (json.route.coordinates) {
-                    var tmpArray = decodePath(json.route.coordinates, true);
-                    json.route.coordinates = null;
-                    json.route.data = {
-                        "type": "LineString",
-                        "coordinates": tmpArray
-                    };
-                } else
-                    console.log("something wrong on server? wrong server version? as we have encodedPolyline=" + tmpEncodedPolyline + " but no encoded data was return?");
+            if (json.paths) {
+                for (var i = 0; i < json.paths.length; i++) {
+                    var path = json.paths[i];
+                    // convert encoded polyline to geo json
+                    if (path.points_encoded) {
+                        var tmpArray = decodePath(path.points, path.points_dimension === 3);
+                        path.points = {
+                            "type": "LineString",
+                            "coordinates": tmpArray
+                        };
+                    }
+                }
             }
             callback(json);
         },
         "error": function(err) {
+            // problematic: this callback is not invoked when using JSONP!
+            // http://stackoverflow.com/questions/19035557/jsonp-request-error-handling
             var msg = "API did not respond! ";
             if (err && err.statusText && err.statusText != "OK")
                 msg += err.statusText;
@@ -209,7 +230,7 @@ GHRequest.prototype.doRequest = function(url, callback) {
 };
 
 GHRequest.prototype.getInfo = function() {
-    var url = this.host + "/api/info?type=" + this.dataType;
+    var url = this.host + "/info?type=" + this.dataType + "&key=" + this.key;
     console.log(url);
     return $.ajax({
         "url": url,
@@ -230,8 +251,8 @@ GHInput = function(str) {
             if (!isNaN(this.lat) && !isNaN(this.lng)) {
                 this.input = this.toString();
             } else {
-                this.lat = false;
-                this.lng = false;
+                this.lat = undefined;
+                this.lng = undefined;
             }
         }
     } catch (ex) {
@@ -249,7 +270,7 @@ GHInput.prototype.setCoord = function(lat, lng) {
 };
 
 GHInput.prototype.toString = function() {
-    if (this.lat && this.lng)
+    if (this.lat !== undefined && this.lng !== undefined)
         return this.lat + "," + this.lng;
     return undefined;
 };
@@ -263,7 +284,7 @@ GHRequest.prototype.fetchTranslationMap = function(urlLocaleParam) {
     if (!urlLocaleParam)
         // let servlet figure out the locale from the Accept-Language header
         urlLocaleParam = "";
-    var url = this.host + "/api/i18n/" + urlLocaleParam + "?type=" + this.dataType;
+    var url = this.host + "/i18n/" + urlLocaleParam + "?type=" + this.dataType + "&key=" + this.key;
     console.log(url);
     return $.ajax({
         "url": url,
diff --git a/web/src/main/webapp/js/jquery-1.10.2.min.js b/web/src/main/webapp/js/jquery-1.10.2.min.js
deleted file mode 100644
index da4170647d..0000000000
--- a/web/src/main/webapp/js/jquery-1.10.2.min.js
+++ /dev/null
@@ -1,6 +0,0 @@
-/*! jQuery v1.10.2 | (c) 2005, 2013 jQuery Foundation, Inc. | jquery.org/license
-//@ sourceMappingURL=jquery-1.10.2.min.map
-*/
-(function(e,t){var n,r,i=typeof t,o=e.location,a=e.document,s=a.documentElement,l=e.jQuery,u=e.$,c={},p=[],f="1.10.2",d=p.concat,h=p.push,g=p.slice,m=p.indexOf,y=c.toString,v=c.hasOwnProperty,b=f.trim,x=function(e,t){return new x.fn.init(e,t,r)},w=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,T=/\S+/g,C=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,N=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,k=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,E=/^[\],:{}\s]*$/,S=/(?:^|:|,)(?:\s*\[)+/g,A=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,j=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,D=/^-ms-/,L=/-([\da-z])/gi,H=function(e,t){return t.toUpperCase()},q=function(e){(a.addEventListener||"load"===e.type||"complete"===a.readyState)&&(_(),x.ready())},_=function(){a.addEventListener?(a.removeEventListener("DOMContentLoaded",q,!1),e.removeEventListener("load",q,!1)):(a.detachEvent("onreadystatechange",q),e.detachEvent("onload",q))};x.fn=x.prototype={jquery:f,constructor:x,init:function(e,n,r){var i,o;if(!e)return this;if("string"==typeof e){if(i="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:N.exec(e),!i||!i[1]&&n)return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e);if(i[1]){if(n=n instanceof x?n[0]:n,x.merge(this,x.parseHTML(i[1],n&&n.nodeType?n.ownerDocument||n:a,!0)),k.test(i[1])&&x.isPlainObject(n))for(i in n)x.isFunction(this[i])?this[i](n[i]):this.attr(i,n[i]);return this}if(o=a.getElementById(i[2]),o&&o.parentNode){if(o.id!==i[2])return r.find(e);this.length=1,this[0]=o}return this.context=a,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):x.isFunction(e)?r.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),x.makeArray(e,this))},selector:"",length:0,toArray:function(){return g.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=x.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return x.each(this,e,t)},ready:function(e){return x.ready.promise().done(e),this},slice:function(){return this.pushStack(g.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},map:function(e){return this.pushStack(x.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:h,sort:[].sort,splice:[].splice},x.fn.init.prototype=x.fn,x.extend=x.fn.extend=function(){var e,n,r,i,o,a,s=arguments[0]||{},l=1,u=arguments.length,c=!1;for("boolean"==typeof s&&(c=s,s=arguments[1]||{},l=2),"object"==typeof s||x.isFunction(s)||(s={}),u===l&&(s=this,--l);u>l;l++)if(null!=(o=arguments[l]))for(i in o)e=s[i],r=o[i],s!==r&&(c&&r&&(x.isPlainObject(r)||(n=x.isArray(r)))?(n?(n=!1,a=e&&x.isArray(e)?e:[]):a=e&&x.isPlainObject(e)?e:{},s[i]=x.extend(c,a,r)):r!==t&&(s[i]=r));return s},x.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),noConflict:function(t){return e.$===x&&(e.$=u),t&&e.jQuery===x&&(e.jQuery=l),x},isReady:!1,readyWait:1,holdReady:function(e){e?x.readyWait++:x.ready(!0)},ready:function(e){if(e===!0?!--x.readyWait:!x.isReady){if(!a.body)return setTimeout(x.ready);x.isReady=!0,e!==!0&&--x.readyWait>0||(n.resolveWith(a,[x]),x.fn.trigger&&x(a).trigger("ready").off("ready"))}},isFunction:function(e){return"function"===x.type(e)},isArray:Array.isArray||function(e){return"array"===x.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?c[y.call(e)]||"object":typeof e},isPlainObject:function(e){var n;if(!e||"object"!==x.type(e)||e.nodeType||x.isWindow(e))return!1;try{if(e.constructor&&!v.call(e,"constructor")&&!v.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(r){return!1}if(x.support.ownLast)for(n in e)return v.call(e,n);for(n in e);return n===t||v.call(e,n)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||a;var r=k.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=x.buildFragment([e],t,i),i&&x(i).remove(),x.merge([],r.childNodes))},parseJSON:function(n){return e.JSON&&e.JSON.parse?e.JSON.parse(n):null===n?n:"string"==typeof n&&(n=x.trim(n),n&&E.test(n.replace(A,"@").replace(j,"]").replace(S,"")))?Function("return "+n)():(x.error("Invalid JSON: "+n),t)},parseXML:function(n){var r,i;if(!n||"string"!=typeof n)return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(o){r=t}return r&&r.documentElement&&!r.getElementsByTagName("parsererror").length||x.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&&x.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(D,"ms-").replace(L,H)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var r,i=0,o=e.length,a=M(e);if(n){if(a){for(;o>i;i++)if(r=t.apply(e[i],n),r===!1)break}else for(i in e)if(r=t.apply(e[i],n),r===!1)break}else if(a){for(;o>i;i++)if(r=t.call(e[i],i,e[i]),r===!1)break}else for(i in e)if(r=t.call(e[i],i,e[i]),r===!1)break;return e},trim:b&&!b.call("\ufeff\u00a0")?function(e){return null==e?"":b.call(e)}:function(e){return null==e?"":(e+"").replace(C,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(M(Object(e))?x.merge(n,"string"==typeof e?[e]:e):h.call(n,e)),n},inArray:function(e,t,n){var r;if(t){if(m)return m.call(t,e,n);for(r=t.length,n=n?0>n?Math.max(0,r+n):n:0;r>n;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,o=0;if("number"==typeof r)for(;r>o;o++)e[i++]=n[o];else while(n[o]!==t)e[i++]=n[o++];return e.length=i,e},grep:function(e,t,n){var r,i=[],o=0,a=e.length;for(n=!!n;a>o;o++)r=!!t(e[o],o),n!==r&&i.push(e[o]);return i},map:function(e,t,n){var r,i=0,o=e.length,a=M(e),s=[];if(a)for(;o>i;i++)r=t(e[i],i,n),null!=r&&(s[s.length]=r);else for(i in e)r=t(e[i],i,n),null!=r&&(s[s.length]=r);return d.apply([],s)},guid:1,proxy:function(e,n){var r,i,o;return"string"==typeof n&&(o=e[n],n=e,e=o),x.isFunction(e)?(r=g.call(arguments,2),i=function(){return e.apply(n||this,r.concat(g.call(arguments)))},i.guid=e.guid=e.guid||x.guid++,i):t},access:function(e,n,r,i,o,a,s){var l=0,u=e.length,c=null==r;if("object"===x.type(r)){o=!0;for(l in r)x.access(e,n,l,r[l],!0,a,s)}else if(i!==t&&(o=!0,x.isFunction(i)||(s=!0),c&&(s?(n.call(e,i),n=null):(c=n,n=function(e,t,n){return c.call(x(e),n)})),n))for(;u>l;l++)n(e[l],r,s?i:i.call(e[l],l,n(e[l],r)));return o?e:c?n.call(e):u?n(e[0],r):a},now:function(){return(new Date).getTime()},swap:function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i}}),x.ready.promise=function(t){if(!n)if(n=x.Deferred(),"complete"===a.readyState)setTimeout(x.ready);else if(a.addEventListener)a.addEventListener("DOMContentLoaded",q,!1),e.addEventListener("load",q,!1);else{a.attachEvent("onreadystatechange",q),e.attachEvent("onload",q);var r=!1;try{r=null==e.frameElement&&a.documentElement}catch(i){}r&&r.doScroll&&function o(){if(!x.isReady){try{r.doScroll("left")}catch(e){return setTimeout(o,50)}_(),x.ready()}}()}return n.promise(t)},x.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){c["[object "+t+"]"]=t.toLowerCase()});function M(e){var t=e.length,n=x.type(e);return x.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}r=x(a),function(e,t){var n,r,i,o,a,s,l,u,c,p,f,d,h,g,m,y,v,b="sizzle"+-new Date,w=e.document,T=0,C=0,N=st(),k=st(),E=st(),S=!1,A=function(e,t){return e===t?(S=!0,0):0},j=typeof t,D=1<<31,L={}.hasOwnProperty,H=[],q=H.pop,_=H.push,M=H.push,O=H.slice,F=H.indexOf||function(e){var t=0,n=this.length;for(;n>t;t++)if(this[t]===e)return t;return-1},B="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",P="[\\x20\\t\\r\\n\\f]",R="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",W=R.replace("w","w#"),$="\\["+P+"*("+R+")"+P+"*(?:([*^$|!~]?=)"+P+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+W+")|)|)"+P+"*\\]",I=":("+R+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+$.replace(3,8)+")*)|.*)\\)|)",z=RegExp("^"+P+"+|((?:^|[^\\\\])(?:\\\\.)*)"+P+"+$","g"),X=RegExp("^"+P+"*,"+P+"*"),U=RegExp("^"+P+"*([>+~]|"+P+")"+P+"*"),V=RegExp(P+"*[+~]"),Y=RegExp("="+P+"*([^\\]'\"]*)"+P+"*\\]","g"),J=RegExp(I),G=RegExp("^"+W+"$"),Q={ID:RegExp("^#("+R+")"),CLASS:RegExp("^\\.("+R+")"),TAG:RegExp("^("+R.replace("w","w*")+")"),ATTR:RegExp("^"+$),PSEUDO:RegExp("^"+I),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+P+"*(even|odd|(([+-]|)(\\d*)n|)"+P+"*(?:([+-]|)"+P+"*(\\d+)|))"+P+"*\\)|)","i"),bool:RegExp("^(?:"+B+")$","i"),needsContext:RegExp("^"+P+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+P+"*((?:-\\d)?\\d*)"+P+"*\\)|)(?=[^-]|$)","i")},K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,et=/^(?:input|select|textarea|button)$/i,tt=/^h\d$/i,nt=/'|\\/g,rt=RegExp("\\\\([\\da-f]{1,6}"+P+"?|("+P+")|.)","ig"),it=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(55296|r>>10,56320|1023&r)};try{M.apply(H=O.call(w.childNodes),w.childNodes),H[w.childNodes.length].nodeType}catch(ot){M={apply:H.length?function(e,t){_.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function at(e,t,n,i){var o,a,s,l,u,c,d,m,y,x;if((t?t.ownerDocument||t:w)!==f&&p(t),t=t||f,n=n||[],!e||"string"!=typeof e)return n;if(1!==(l=t.nodeType)&&9!==l)return[];if(h&&!i){if(o=Z.exec(e))if(s=o[1]){if(9===l){if(a=t.getElementById(s),!a||!a.parentNode)return n;if(a.id===s)return n.push(a),n}else if(t.ownerDocument&&(a=t.ownerDocument.getElementById(s))&&v(t,a)&&a.id===s)return n.push(a),n}else{if(o[2])return M.apply(n,t.getElementsByTagName(e)),n;if((s=o[3])&&r.getElementsByClassName&&t.getElementsByClassName)return M.apply(n,t.getElementsByClassName(s)),n}if(r.qsa&&(!g||!g.test(e))){if(m=d=b,y=t,x=9===l&&e,1===l&&"object"!==t.nodeName.toLowerCase()){c=mt(e),(d=t.getAttribute("id"))?m=d.replace(nt,"\\$&"):t.setAttribute("id",m),m="[id='"+m+"'] ",u=c.length;while(u--)c[u]=m+yt(c[u]);y=V.test(e)&&t.parentNode||t,x=c.join(",")}if(x)try{return M.apply(n,y.querySelectorAll(x)),n}catch(T){}finally{d||t.removeAttribute("id")}}}return kt(e.replace(z,"$1"),t,n,i)}function st(){var e=[];function t(n,r){return e.push(n+=" ")>o.cacheLength&&delete t[e.shift()],t[n]=r}return t}function lt(e){return e[b]=!0,e}function ut(e){var t=f.createElement("div");try{return!!e(t)}catch(n){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function ct(e,t){var n=e.split("|"),r=e.length;while(r--)o.attrHandle[n[r]]=t}function pt(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||D)-(~e.sourceIndex||D);if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function ft(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function dt(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function ht(e){return lt(function(t){return t=+t,lt(function(n,r){var i,o=e([],n.length,t),a=o.length;while(a--)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}s=at.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},r=at.support={},p=at.setDocument=function(e){var n=e?e.ownerDocument||e:w,i=n.defaultView;return n!==f&&9===n.nodeType&&n.documentElement?(f=n,d=n.documentElement,h=!s(n),i&&i.attachEvent&&i!==i.top&&i.attachEvent("onbeforeunload",function(){p()}),r.attributes=ut(function(e){return e.className="i",!e.getAttribute("className")}),r.getElementsByTagName=ut(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),r.getElementsByClassName=ut(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),r.getById=ut(function(e){return d.appendChild(e).id=b,!n.getElementsByName||!n.getElementsByName(b).length}),r.getById?(o.find.ID=function(e,t){if(typeof t.getElementById!==j&&h){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},o.filter.ID=function(e){var t=e.replace(rt,it);return function(e){return e.getAttribute("id")===t}}):(delete o.find.ID,o.filter.ID=function(e){var t=e.replace(rt,it);return function(e){var n=typeof e.getAttributeNode!==j&&e.getAttributeNode("id");return n&&n.value===t}}),o.find.TAG=r.getElementsByTagName?function(e,n){return typeof n.getElementsByTagName!==j?n.getElementsByTagName(e):t}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},o.find.CLASS=r.getElementsByClassName&&function(e,n){return typeof n.getElementsByClassName!==j&&h?n.getElementsByClassName(e):t},m=[],g=[],(r.qsa=K.test(n.querySelectorAll))&&(ut(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||g.push("\\["+P+"*(?:value|"+B+")"),e.querySelectorAll(":checked").length||g.push(":checked")}),ut(function(e){var t=n.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("t",""),e.querySelectorAll("[t^='']").length&&g.push("[*^$]="+P+"*(?:''|\"\")"),e.querySelectorAll(":enabled").length||g.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),g.push(",.*:")})),(r.matchesSelector=K.test(y=d.webkitMatchesSelector||d.mozMatchesSelector||d.oMatchesSelector||d.msMatchesSelector))&&ut(function(e){r.disconnectedMatch=y.call(e,"div"),y.call(e,"[s!='']:x"),m.push("!=",I)}),g=g.length&&RegExp(g.join("|")),m=m.length&&RegExp(m.join("|")),v=K.test(d.contains)||d.compareDocumentPosition?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},A=d.compareDocumentPosition?function(e,t){if(e===t)return S=!0,0;var i=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t);return i?1&i||!r.sortDetached&&t.compareDocumentPosition(e)===i?e===n||v(w,e)?-1:t===n||v(w,t)?1:c?F.call(c,e)-F.call(c,t):0:4&i?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,i=0,o=e.parentNode,a=t.parentNode,s=[e],l=[t];if(e===t)return S=!0,0;if(!o||!a)return e===n?-1:t===n?1:o?-1:a?1:c?F.call(c,e)-F.call(c,t):0;if(o===a)return pt(e,t);r=e;while(r=r.parentNode)s.unshift(r);r=t;while(r=r.parentNode)l.unshift(r);while(s[i]===l[i])i++;return i?pt(s[i],l[i]):s[i]===w?-1:l[i]===w?1:0},n):f},at.matches=function(e,t){return at(e,null,null,t)},at.matchesSelector=function(e,t){if((e.ownerDocument||e)!==f&&p(e),t=t.replace(Y,"='$1']"),!(!r.matchesSelector||!h||m&&m.test(t)||g&&g.test(t)))try{var n=y.call(e,t);if(n||r.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(i){}return at(t,f,null,[e]).length>0},at.contains=function(e,t){return(e.ownerDocument||e)!==f&&p(e),v(e,t)},at.attr=function(e,n){(e.ownerDocument||e)!==f&&p(e);var i=o.attrHandle[n.toLowerCase()],a=i&&L.call(o.attrHandle,n.toLowerCase())?i(e,n,!h):t;return a===t?r.attributes||!h?e.getAttribute(n):(a=e.getAttributeNode(n))&&a.specified?a.value:null:a},at.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},at.uniqueSort=function(e){var t,n=[],i=0,o=0;if(S=!r.detectDuplicates,c=!r.sortStable&&e.slice(0),e.sort(A),S){while(t=e[o++])t===e[o]&&(i=n.push(o));while(i--)e.splice(n[i],1)}return e},a=at.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=a(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r];r++)n+=a(t);return n},o=at.selectors={cacheLength:50,createPseudo:lt,match:Q,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(rt,it),e[3]=(e[4]||e[5]||"").replace(rt,it),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||at.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&at.error(e[0]),e},PSEUDO:function(e){var n,r=!e[5]&&e[2];return Q.CHILD.test(e[0])?null:(e[3]&&e[4]!==t?e[2]=e[4]:r&&J.test(r)&&(n=mt(r,!0))&&(n=r.indexOf(")",r.length-n)-r.length)&&(e[0]=e[0].slice(0,n),e[2]=r.slice(0,n)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(rt,it).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=N[e+" "];return t||(t=RegExp("(^|"+P+")"+e+"("+P+"|$)"))&&N(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==j&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=at.attr(r,e);return null==i?"!="===t:t?(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i+" ").indexOf(n)>-1:"|="===t?i===n||i.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,l){var u,c,p,f,d,h,g=o!==a?"nextSibling":"previousSibling",m=t.parentNode,y=s&&t.nodeName.toLowerCase(),v=!l&&!s;if(m){if(o){while(g){p=t;while(p=p[g])if(s?p.nodeName.toLowerCase()===y:1===p.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?m.firstChild:m.lastChild],a&&v){c=m[b]||(m[b]={}),u=c[e]||[],d=u[0]===T&&u[1],f=u[0]===T&&u[2],p=d&&m.childNodes[d];while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if(1===p.nodeType&&++f&&p===t){c[e]=[T,d,f];break}}else if(v&&(u=(t[b]||(t[b]={}))[e])&&u[0]===T)f=u[1];else while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if((s?p.nodeName.toLowerCase()===y:1===p.nodeType)&&++f&&(v&&((p[b]||(p[b]={}))[e]=[T,f]),p===t))break;return f-=i,f===r||0===f%r&&f/r>=0}}},PSEUDO:function(e,t){var n,r=o.pseudos[e]||o.setFilters[e.toLowerCase()]||at.error("unsupported pseudo: "+e);return r[b]?r(t):r.length>1?(n=[e,e,"",t],o.setFilters.hasOwnProperty(e.toLowerCase())?lt(function(e,n){var i,o=r(e,t),a=o.length;while(a--)i=F.call(e,o[a]),e[i]=!(n[i]=o[a])}):function(e){return r(e,0,n)}):r}},pseudos:{not:lt(function(e){var t=[],n=[],r=l(e.replace(z,"$1"));return r[b]?lt(function(e,t,n,i){var o,a=r(e,null,i,[]),s=e.length;while(s--)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:lt(function(e){return function(t){return at(e,t).length>0}}),contains:lt(function(e){return function(t){return(t.textContent||t.innerText||a(t)).indexOf(e)>-1}}),lang:lt(function(e){return G.test(e||"")||at.error("unsupported lang: "+e),e=e.replace(rt,it).toLowerCase(),function(t){var n;do if(n=h?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===d},focus:function(e){return e===f.activeElement&&(!f.hasFocus||f.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!o.pseudos.empty(e)},header:function(e){return tt.test(e.nodeName)},input:function(e){return et.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:ht(function(){return[0]}),last:ht(function(e,t){return[t-1]}),eq:ht(function(e,t,n){return[0>n?n+t:n]}),even:ht(function(e,t){var n=0;for(;t>n;n+=2)e.push(n);return e}),odd:ht(function(e,t){var n=1;for(;t>n;n+=2)e.push(n);return e}),lt:ht(function(e,t,n){var r=0>n?n+t:n;for(;--r>=0;)e.push(r);return e}),gt:ht(function(e,t,n){var r=0>n?n+t:n;for(;t>++r;)e.push(r);return e})}},o.pseudos.nth=o.pseudos.eq;for(n in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})o.pseudos[n]=ft(n);for(n in{submit:!0,reset:!0})o.pseudos[n]=dt(n);function gt(){}gt.prototype=o.filters=o.pseudos,o.setFilters=new gt;function mt(e,t){var n,r,i,a,s,l,u,c=k[e+" "];if(c)return t?0:c.slice(0);s=e,l=[],u=o.preFilter;while(s){(!n||(r=X.exec(s)))&&(r&&(s=s.slice(r[0].length)||s),l.push(i=[])),n=!1,(r=U.exec(s))&&(n=r.shift(),i.push({value:n,type:r[0].replace(z," ")}),s=s.slice(n.length));for(a in o.filter)!(r=Q[a].exec(s))||u[a]&&!(r=u[a](r))||(n=r.shift(),i.push({value:n,type:a,matches:r}),s=s.slice(n.length));if(!n)break}return t?s.length:s?at.error(e):k(e,l).slice(0)}function yt(e){var t=0,n=e.length,r="";for(;n>t;t++)r+=e[t].value;return r}function vt(e,t,n){var r=t.dir,o=n&&"parentNode"===r,a=C++;return t.first?function(t,n,i){while(t=t[r])if(1===t.nodeType||o)return e(t,n,i)}:function(t,n,s){var l,u,c,p=T+" "+a;if(s){while(t=t[r])if((1===t.nodeType||o)&&e(t,n,s))return!0}else while(t=t[r])if(1===t.nodeType||o)if(c=t[b]||(t[b]={}),(u=c[r])&&u[0]===p){if((l=u[1])===!0||l===i)return l===!0}else if(u=c[r]=[p],u[1]=e(t,n,s)||i,u[1]===!0)return!0}}function bt(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function xt(e,t,n,r,i){var o,a=[],s=0,l=e.length,u=null!=t;for(;l>s;s++)(o=e[s])&&(!n||n(o,r,i))&&(a.push(o),u&&t.push(s));return a}function wt(e,t,n,r,i,o){return r&&!r[b]&&(r=wt(r)),i&&!i[b]&&(i=wt(i,o)),lt(function(o,a,s,l){var u,c,p,f=[],d=[],h=a.length,g=o||Nt(t||"*",s.nodeType?[s]:s,[]),m=!e||!o&&t?g:xt(g,f,e,s,l),y=n?i||(o?e:h||r)?[]:a:m;if(n&&n(m,y,s,l),r){u=xt(y,d),r(u,[],s,l),c=u.length;while(c--)(p=u[c])&&(y[d[c]]=!(m[d[c]]=p))}if(o){if(i||e){if(i){u=[],c=y.length;while(c--)(p=y[c])&&u.push(m[c]=p);i(null,y=[],u,l)}c=y.length;while(c--)(p=y[c])&&(u=i?F.call(o,p):f[c])>-1&&(o[u]=!(a[u]=p))}}else y=xt(y===a?y.splice(h,y.length):y),i?i(null,a,y,l):M.apply(a,y)})}function Tt(e){var t,n,r,i=e.length,a=o.relative[e[0].type],s=a||o.relative[" "],l=a?1:0,c=vt(function(e){return e===t},s,!0),p=vt(function(e){return F.call(t,e)>-1},s,!0),f=[function(e,n,r){return!a&&(r||n!==u)||((t=n).nodeType?c(e,n,r):p(e,n,r))}];for(;i>l;l++)if(n=o.relative[e[l].type])f=[vt(bt(f),n)];else{if(n=o.filter[e[l].type].apply(null,e[l].matches),n[b]){for(r=++l;i>r;r++)if(o.relative[e[r].type])break;return wt(l>1&&bt(f),l>1&&yt(e.slice(0,l-1).concat({value:" "===e[l-2].type?"*":""})).replace(z,"$1"),n,r>l&&Tt(e.slice(l,r)),i>r&&Tt(e=e.slice(r)),i>r&&yt(e))}f.push(n)}return bt(f)}function Ct(e,t){var n=0,r=t.length>0,a=e.length>0,s=function(s,l,c,p,d){var h,g,m,y=[],v=0,b="0",x=s&&[],w=null!=d,C=u,N=s||a&&o.find.TAG("*",d&&l.parentNode||l),k=T+=null==C?1:Math.random()||.1;for(w&&(u=l!==f&&l,i=n);null!=(h=N[b]);b++){if(a&&h){g=0;while(m=e[g++])if(m(h,l,c)){p.push(h);break}w&&(T=k,i=++n)}r&&((h=!m&&h)&&v--,s&&x.push(h))}if(v+=b,r&&b!==v){g=0;while(m=t[g++])m(x,y,l,c);if(s){if(v>0)while(b--)x[b]||y[b]||(y[b]=q.call(p));y=xt(y)}M.apply(p,y),w&&!s&&y.length>0&&v+t.length>1&&at.uniqueSort(p)}return w&&(T=k,u=C),x};return r?lt(s):s}l=at.compile=function(e,t){var n,r=[],i=[],o=E[e+" "];if(!o){t||(t=mt(e)),n=t.length;while(n--)o=Tt(t[n]),o[b]?r.push(o):i.push(o);o=E(e,Ct(i,r))}return o};function Nt(e,t,n){var r=0,i=t.length;for(;i>r;r++)at(e,t[r],n);return n}function kt(e,t,n,i){var a,s,u,c,p,f=mt(e);if(!i&&1===f.length){if(s=f[0]=f[0].slice(0),s.length>2&&"ID"===(u=s[0]).type&&r.getById&&9===t.nodeType&&h&&o.relative[s[1].type]){if(t=(o.find.ID(u.matches[0].replace(rt,it),t)||[])[0],!t)return n;e=e.slice(s.shift().value.length)}a=Q.needsContext.test(e)?0:s.length;while(a--){if(u=s[a],o.relative[c=u.type])break;if((p=o.find[c])&&(i=p(u.matches[0].replace(rt,it),V.test(s[0].type)&&t.parentNode||t))){if(s.splice(a,1),e=i.length&&yt(s),!e)return M.apply(n,i),n;break}}}return l(e,f)(i,t,!h,n,V.test(e)),n}r.sortStable=b.split("").sort(A).join("")===b,r.detectDuplicates=S,p(),r.sortDetached=ut(function(e){return 1&e.compareDocumentPosition(f.createElement("div"))}),ut(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||ct("type|href|height|width",function(e,n,r){return r?t:e.getAttribute(n,"type"===n.toLowerCase()?1:2)}),r.attributes&&ut(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||ct("value",function(e,n,r){return r||"input"!==e.nodeName.toLowerCase()?t:e.defaultValue}),ut(function(e){return null==e.getAttribute("disabled")})||ct(B,function(e,n,r){var i;return r?t:(i=e.getAttributeNode(n))&&i.specified?i.value:e[n]===!0?n.toLowerCase():null}),x.find=at,x.expr=at.selectors,x.expr[":"]=x.expr.pseudos,x.unique=at.uniqueSort,x.text=at.getText,x.isXMLDoc=at.isXML,x.contains=at.contains}(e);var O={};function F(e){var t=O[e]={};return x.each(e.match(T)||[],function(e,n){t[n]=!0}),t}x.Callbacks=function(e){e="string"==typeof e?O[e]||F(e):x.extend({},e);var n,r,i,o,a,s,l=[],u=!e.once&&[],c=function(t){for(r=e.memory&&t,i=!0,a=s||0,s=0,o=l.length,n=!0;l&&o>a;a++)if(l[a].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}n=!1,l&&(u?u.length&&c(u.shift()):r?l=[]:p.disable())},p={add:function(){if(l){var t=l.length;(function i(t){x.each(t,function(t,n){var r=x.type(n);"function"===r?e.unique&&p.has(n)||l.push(n):n&&n.length&&"string"!==r&&i(n)})})(arguments),n?o=l.length:r&&(s=t,c(r))}return this},remove:function(){return l&&x.each(arguments,function(e,t){var r;while((r=x.inArray(t,l,r))>-1)l.splice(r,1),n&&(o>=r&&o--,a>=r&&a--)}),this},has:function(e){return e?x.inArray(e,l)>-1:!(!l||!l.length)},empty:function(){return l=[],o=0,this},disable:function(){return l=u=r=t,this},disabled:function(){return!l},lock:function(){return u=t,r||p.disable(),this},locked:function(){return!u},fireWith:function(e,t){return!l||i&&!u||(t=t||[],t=[e,t.slice?t.slice():t],n?u.push(t):c(t)),this},fire:function(){return p.fireWith(this,arguments),this},fired:function(){return!!i}};return p},x.extend({Deferred:function(e){var t=[["resolve","done",x.Callbacks("once memory"),"resolved"],["reject","fail",x.Callbacks("once memory"),"rejected"],["notify","progress",x.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return x.Deferred(function(n){x.each(t,function(t,o){var a=o[0],s=x.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&x.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[a+"With"](this===r?n.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?x.extend(e,r):r}},i={};return r.pipe=r.then,x.each(t,function(e,o){var a=o[2],s=o[3];r[o[1]]=a.add,s&&a.add(function(){n=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=a.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=g.call(arguments),r=n.length,i=1!==r||e&&x.isFunction(e.promise)?r:0,o=1===i?e:x.Deferred(),a=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?g.call(arguments):r,n===s?o.notifyWith(t,n):--i||o.resolveWith(t,n)}},s,l,u;if(r>1)for(s=Array(r),l=Array(r),u=Array(r);r>t;t++)n[t]&&x.isFunction(n[t].promise)?n[t].promise().done(a(t,u,n)).fail(o.reject).progress(a(t,l,s)):--i;return i||o.resolveWith(u,n),o.promise()}}),x.support=function(t){var n,r,o,s,l,u,c,p,f,d=a.createElement("div");if(d.setAttribute("className","t"),d.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=d.getElementsByTagName("*")||[],r=d.getElementsByTagName("a")[0],!r||!r.style||!n.length)return t;s=a.createElement("select"),u=s.appendChild(a.createElement("option")),o=d.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t.getSetAttribute="t"!==d.className,t.leadingWhitespace=3===d.firstChild.nodeType,t.tbody=!d.getElementsByTagName("tbody").length,t.htmlSerialize=!!d.getElementsByTagName("link").length,t.style=/top/.test(r.getAttribute("style")),t.hrefNormalized="/a"===r.getAttribute("href"),t.opacity=/^0.5/.test(r.style.opacity),t.cssFloat=!!r.style.cssFloat,t.checkOn=!!o.value,t.optSelected=u.selected,t.enctype=!!a.createElement("form").enctype,t.html5Clone="<:nav></:nav>"!==a.createElement("nav").cloneNode(!0).outerHTML,t.inlineBlockNeedsLayout=!1,t.shrinkWrapBlocks=!1,t.pixelPosition=!1,t.deleteExpando=!0,t.noCloneEvent=!0,t.reliableMarginRight=!0,t.boxSizingReliable=!0,o.checked=!0,t.noCloneChecked=o.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!u.disabled;try{delete d.test}catch(h){t.deleteExpando=!1}o=a.createElement("input"),o.setAttribute("value",""),t.input=""===o.getAttribute("value"),o.value="t",o.setAttribute("type","radio"),t.radioValue="t"===o.value,o.setAttribute("checked","t"),o.setAttribute("name","t"),l=a.createDocumentFragment(),l.appendChild(o),t.appendChecked=o.checked,t.checkClone=l.cloneNode(!0).cloneNode(!0).lastChild.checked,d.attachEvent&&(d.attachEvent("onclick",function(){t.noCloneEvent=!1}),d.cloneNode(!0).click());for(f in{submit:!0,change:!0,focusin:!0})d.setAttribute(c="on"+f,"t"),t[f+"Bubbles"]=c in e||d.attributes[c].expando===!1;d.style.backgroundClip="content-box",d.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===d.style.backgroundClip;for(f in x(t))break;return t.ownLast="0"!==f,x(function(){var n,r,o,s="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",l=a.getElementsByTagName("body")[0];l&&(n=a.createElement("div"),n.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",l.appendChild(n).appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",o=d.getElementsByTagName("td"),o[0].style.cssText="padding:0;margin:0;border:0;display:none",p=0===o[0].offsetHeight,o[0].style.display="",o[1].style.display="none",t.reliableHiddenOffsets=p&&0===o[0].offsetHeight,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",x.swap(l,null!=l.style.zoom?{zoom:1}:{},function(){t.boxSizing=4===d.offsetWidth}),e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(d,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(d,null)||{width:"4px"}).width,r=d.appendChild(a.createElement("div")),r.style.cssText=d.style.cssText=s,r.style.marginRight=r.style.width="0",d.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(r,null)||{}).marginRight)),typeof d.style.zoom!==i&&(d.innerHTML="",d.style.cssText=s+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=3===d.offsetWidth,d.style.display="block",d.innerHTML="<div></div>",d.firstChild.style.width="5px",t.shrinkWrapBlocks=3!==d.offsetWidth,t.inlineBlockNeedsLayout&&(l.style.zoom=1)),l.removeChild(n),n=d=o=r=null)}),n=s=l=u=r=o=null,t
-}({});var B=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,P=/([A-Z])/g;function R(e,n,r,i){if(x.acceptData(e)){var o,a,s=x.expando,l=e.nodeType,u=l?x.cache:e,c=l?e[s]:e[s]&&s;if(c&&u[c]&&(i||u[c].data)||r!==t||"string"!=typeof n)return c||(c=l?e[s]=p.pop()||x.guid++:s),u[c]||(u[c]=l?{}:{toJSON:x.noop}),("object"==typeof n||"function"==typeof n)&&(i?u[c]=x.extend(u[c],n):u[c].data=x.extend(u[c].data,n)),a=u[c],i||(a.data||(a.data={}),a=a.data),r!==t&&(a[x.camelCase(n)]=r),"string"==typeof n?(o=a[n],null==o&&(o=a[x.camelCase(n)])):o=a,o}}function W(e,t,n){if(x.acceptData(e)){var r,i,o=e.nodeType,a=o?x.cache:e,s=o?e[x.expando]:x.expando;if(a[s]){if(t&&(r=n?a[s]:a[s].data)){x.isArray(t)?t=t.concat(x.map(t,x.camelCase)):t in r?t=[t]:(t=x.camelCase(t),t=t in r?[t]:t.split(" ")),i=t.length;while(i--)delete r[t[i]];if(n?!I(r):!x.isEmptyObject(r))return}(n||(delete a[s].data,I(a[s])))&&(o?x.cleanData([e],!0):x.support.deleteExpando||a!=a.window?delete a[s]:a[s]=null)}}}x.extend({cache:{},noData:{applet:!0,embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(e){return e=e.nodeType?x.cache[e[x.expando]]:e[x.expando],!!e&&!I(e)},data:function(e,t,n){return R(e,t,n)},removeData:function(e,t){return W(e,t)},_data:function(e,t,n){return R(e,t,n,!0)},_removeData:function(e,t){return W(e,t,!0)},acceptData:function(e){if(e.nodeType&&1!==e.nodeType&&9!==e.nodeType)return!1;var t=e.nodeName&&x.noData[e.nodeName.toLowerCase()];return!t||t!==!0&&e.getAttribute("classid")===t}}),x.fn.extend({data:function(e,n){var r,i,o=null,a=0,s=this[0];if(e===t){if(this.length&&(o=x.data(s),1===s.nodeType&&!x._data(s,"parsedAttrs"))){for(r=s.attributes;r.length>a;a++)i=r[a].name,0===i.indexOf("data-")&&(i=x.camelCase(i.slice(5)),$(s,i,o[i]));x._data(s,"parsedAttrs",!0)}return o}return"object"==typeof e?this.each(function(){x.data(this,e)}):arguments.length>1?this.each(function(){x.data(this,e,n)}):s?$(s,e,x.data(s,e)):null},removeData:function(e){return this.each(function(){x.removeData(this,e)})}});function $(e,n,r){if(r===t&&1===e.nodeType){var i="data-"+n.replace(P,"-$1").toLowerCase();if(r=e.getAttribute(i),"string"==typeof r){try{r="true"===r?!0:"false"===r?!1:"null"===r?null:+r+""===r?+r:B.test(r)?x.parseJSON(r):r}catch(o){}x.data(e,n,r)}else r=t}return r}function I(e){var t;for(t in e)if(("data"!==t||!x.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}x.extend({queue:function(e,n,r){var i;return e?(n=(n||"fx")+"queue",i=x._data(e,n),r&&(!i||x.isArray(r)?i=x._data(e,n,x.makeArray(r)):i.push(r)),i||[]):t},dequeue:function(e,t){t=t||"fx";var n=x.queue(e,t),r=n.length,i=n.shift(),o=x._queueHooks(e,t),a=function(){x.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return x._data(e,n)||x._data(e,n,{empty:x.Callbacks("once memory").add(function(){x._removeData(e,t+"queue"),x._removeData(e,n)})})}}),x.fn.extend({queue:function(e,n){var r=2;return"string"!=typeof e&&(n=e,e="fx",r--),r>arguments.length?x.queue(this[0],e):n===t?this:this.each(function(){var t=x.queue(this,e,n);x._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&x.dequeue(this,e)})},dequeue:function(e){return this.each(function(){x.dequeue(this,e)})},delay:function(e,t){return e=x.fx?x.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,o=x.Deferred(),a=this,s=this.length,l=function(){--i||o.resolveWith(a,[a])};"string"!=typeof e&&(n=e,e=t),e=e||"fx";while(s--)r=x._data(a[s],e+"queueHooks"),r&&r.empty&&(i++,r.empty.add(l));return l(),o.promise(n)}});var z,X,U=/[\t\r\n\f]/g,V=/\r/g,Y=/^(?:input|select|textarea|button|object)$/i,J=/^(?:a|area)$/i,G=/^(?:checked|selected)$/i,Q=x.support.getSetAttribute,K=x.support.input;x.fn.extend({attr:function(e,t){return x.access(this,x.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){x.removeAttr(this,e)})},prop:function(e,t){return x.access(this,x.prop,e,t,arguments.length>1)},removeProp:function(e){return e=x.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,o,a=0,s=this.length,l="string"==typeof e&&e;if(x.isFunction(e))return this.each(function(t){x(this).addClass(e.call(this,t,this.className))});if(l)for(t=(e||"").match(T)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(U," "):" ")){o=0;while(i=t[o++])0>r.indexOf(" "+i+" ")&&(r+=i+" ");n.className=x.trim(r)}return this},removeClass:function(e){var t,n,r,i,o,a=0,s=this.length,l=0===arguments.length||"string"==typeof e&&e;if(x.isFunction(e))return this.each(function(t){x(this).removeClass(e.call(this,t,this.className))});if(l)for(t=(e||"").match(T)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(U," "):"")){o=0;while(i=t[o++])while(r.indexOf(" "+i+" ")>=0)r=r.replace(" "+i+" "," ");n.className=e?x.trim(r):""}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):x.isFunction(e)?this.each(function(n){x(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if("string"===n){var t,r=0,o=x(this),a=e.match(T)||[];while(t=a[r++])o.hasClass(t)?o.removeClass(t):o.addClass(t)}else(n===i||"boolean"===n)&&(this.className&&x._data(this,"__className__",this.className),this.className=this.className||e===!1?"":x._data(this,"__className__")||"")})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(U," ").indexOf(t)>=0)return!0;return!1},val:function(e){var n,r,i,o=this[0];{if(arguments.length)return i=x.isFunction(e),this.each(function(n){var o;1===this.nodeType&&(o=i?e.call(this,n,x(this).val()):e,null==o?o="":"number"==typeof o?o+="":x.isArray(o)&&(o=x.map(o,function(e){return null==e?"":e+""})),r=x.valHooks[this.type]||x.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))});if(o)return r=x.valHooks[o.type]||x.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(n=r.get(o,"value"))!==t?n:(n=o.value,"string"==typeof n?n.replace(V,""):null==n?"":n)}}}),x.extend({valHooks:{option:{get:function(e){var t=x.find.attr(e,"value");return null!=t?t:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:r.length,l=0>i?s:o?i:0;for(;s>l;l++)if(n=r[l],!(!n.selected&&l!==i||(x.support.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&x.nodeName(n.parentNode,"optgroup"))){if(t=x(n).val(),o)return t;a.push(t)}return a},set:function(e,t){var n,r,i=e.options,o=x.makeArray(t),a=i.length;while(a--)r=i[a],(r.selected=x.inArray(x(r).val(),o)>=0)&&(n=!0);return n||(e.selectedIndex=-1),o}}},attr:function(e,n,r){var o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return typeof e.getAttribute===i?x.prop(e,n,r):(1===s&&x.isXMLDoc(e)||(n=n.toLowerCase(),o=x.attrHooks[n]||(x.expr.match.bool.test(n)?X:z)),r===t?o&&"get"in o&&null!==(a=o.get(e,n))?a:(a=x.find.attr(e,n),null==a?t:a):null!==r?o&&"set"in o&&(a=o.set(e,r,n))!==t?a:(e.setAttribute(n,r+""),r):(x.removeAttr(e,n),t))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(T);if(o&&1===e.nodeType)while(n=o[i++])r=x.propFix[n]||n,x.expr.match.bool.test(n)?K&&Q||!G.test(n)?e[r]=!1:e[x.camelCase("default-"+n)]=e[r]=!1:x.attr(e,n,""),e.removeAttribute(Q?n:r)},attrHooks:{type:{set:function(e,t){if(!x.support.radioValue&&"radio"===t&&x.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(e,n,r){var i,o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return a=1!==s||!x.isXMLDoc(e),a&&(n=x.propFix[n]||n,o=x.propHooks[n]),r!==t?o&&"set"in o&&(i=o.set(e,r,n))!==t?i:e[n]=r:o&&"get"in o&&null!==(i=o.get(e,n))?i:e[n]},propHooks:{tabIndex:{get:function(e){var t=x.find.attr(e,"tabindex");return t?parseInt(t,10):Y.test(e.nodeName)||J.test(e.nodeName)&&e.href?0:-1}}}}),X={set:function(e,t,n){return t===!1?x.removeAttr(e,n):K&&Q||!G.test(n)?e.setAttribute(!Q&&x.propFix[n]||n,n):e[x.camelCase("default-"+n)]=e[n]=!0,n}},x.each(x.expr.match.bool.source.match(/\w+/g),function(e,n){var r=x.expr.attrHandle[n]||x.find.attr;x.expr.attrHandle[n]=K&&Q||!G.test(n)?function(e,n,i){var o=x.expr.attrHandle[n],a=i?t:(x.expr.attrHandle[n]=t)!=r(e,n,i)?n.toLowerCase():null;return x.expr.attrHandle[n]=o,a}:function(e,n,r){return r?t:e[x.camelCase("default-"+n)]?n.toLowerCase():null}}),K&&Q||(x.attrHooks.value={set:function(e,n,r){return x.nodeName(e,"input")?(e.defaultValue=n,t):z&&z.set(e,n,r)}}),Q||(z={set:function(e,n,r){var i=e.getAttributeNode(r);return i||e.setAttributeNode(i=e.ownerDocument.createAttribute(r)),i.value=n+="","value"===r||n===e.getAttribute(r)?n:t}},x.expr.attrHandle.id=x.expr.attrHandle.name=x.expr.attrHandle.coords=function(e,n,r){var i;return r?t:(i=e.getAttributeNode(n))&&""!==i.value?i.value:null},x.valHooks.button={get:function(e,n){var r=e.getAttributeNode(n);return r&&r.specified?r.value:t},set:z.set},x.attrHooks.contenteditable={set:function(e,t,n){z.set(e,""===t?!1:t,n)}},x.each(["width","height"],function(e,n){x.attrHooks[n]={set:function(e,r){return""===r?(e.setAttribute(n,"auto"),r):t}}})),x.support.hrefNormalized||x.each(["href","src"],function(e,t){x.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}}),x.support.style||(x.attrHooks.style={get:function(e){return e.style.cssText||t},set:function(e,t){return e.style.cssText=t+""}}),x.support.optSelected||(x.propHooks.selected={get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}}),x.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){x.propFix[this.toLowerCase()]=this}),x.support.enctype||(x.propFix.enctype="encoding"),x.each(["radio","checkbox"],function(){x.valHooks[this]={set:function(e,n){return x.isArray(n)?e.checked=x.inArray(x(e).val(),n)>=0:t}},x.support.checkOn||(x.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Z=/^(?:input|select|textarea)$/i,et=/^key/,tt=/^(?:mouse|contextmenu)|click/,nt=/^(?:focusinfocus|focusoutblur)$/,rt=/^([^.]*)(?:\.(.+)|)$/;function it(){return!0}function ot(){return!1}function at(){try{return a.activeElement}catch(e){}}x.event={global:{},add:function(e,n,r,o,a){var s,l,u,c,p,f,d,h,g,m,y,v=x._data(e);if(v){r.handler&&(c=r,r=c.handler,a=c.selector),r.guid||(r.guid=x.guid++),(l=v.events)||(l=v.events={}),(f=v.handle)||(f=v.handle=function(e){return typeof x===i||e&&x.event.triggered===e.type?t:x.event.dispatch.apply(f.elem,arguments)},f.elem=e),n=(n||"").match(T)||[""],u=n.length;while(u--)s=rt.exec(n[u])||[],g=y=s[1],m=(s[2]||"").split(".").sort(),g&&(p=x.event.special[g]||{},g=(a?p.delegateType:p.bindType)||g,p=x.event.special[g]||{},d=x.extend({type:g,origType:y,data:o,handler:r,guid:r.guid,selector:a,needsContext:a&&x.expr.match.needsContext.test(a),namespace:m.join(".")},c),(h=l[g])||(h=l[g]=[],h.delegateCount=0,p.setup&&p.setup.call(e,o,m,f)!==!1||(e.addEventListener?e.addEventListener(g,f,!1):e.attachEvent&&e.attachEvent("on"+g,f))),p.add&&(p.add.call(e,d),d.handler.guid||(d.handler.guid=r.guid)),a?h.splice(h.delegateCount++,0,d):h.push(d),x.event.global[g]=!0);e=null}},remove:function(e,t,n,r,i){var o,a,s,l,u,c,p,f,d,h,g,m=x.hasData(e)&&x._data(e);if(m&&(c=m.events)){t=(t||"").match(T)||[""],u=t.length;while(u--)if(s=rt.exec(t[u])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d){p=x.event.special[d]||{},d=(r?p.delegateType:p.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),l=o=f.length;while(o--)a=f[o],!i&&g!==a.origType||n&&n.guid!==a.guid||s&&!s.test(a.namespace)||r&&r!==a.selector&&("**"!==r||!a.selector)||(f.splice(o,1),a.selector&&f.delegateCount--,p.remove&&p.remove.call(e,a));l&&!f.length&&(p.teardown&&p.teardown.call(e,h,m.handle)!==!1||x.removeEvent(e,d,m.handle),delete c[d])}else for(d in c)x.event.remove(e,d+t[u],n,r,!0);x.isEmptyObject(c)&&(delete m.handle,x._removeData(e,"events"))}},trigger:function(n,r,i,o){var s,l,u,c,p,f,d,h=[i||a],g=v.call(n,"type")?n.type:n,m=v.call(n,"namespace")?n.namespace.split("."):[];if(u=f=i=i||a,3!==i.nodeType&&8!==i.nodeType&&!nt.test(g+x.event.triggered)&&(g.indexOf(".")>=0&&(m=g.split("."),g=m.shift(),m.sort()),l=0>g.indexOf(":")&&"on"+g,n=n[x.expando]?n:new x.Event(g,"object"==typeof n&&n),n.isTrigger=o?2:3,n.namespace=m.join("."),n.namespace_re=n.namespace?RegExp("(^|\\.)"+m.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,n.result=t,n.target||(n.target=i),r=null==r?[n]:x.makeArray(r,[n]),p=x.event.special[g]||{},o||!p.trigger||p.trigger.apply(i,r)!==!1)){if(!o&&!p.noBubble&&!x.isWindow(i)){for(c=p.delegateType||g,nt.test(c+g)||(u=u.parentNode);u;u=u.parentNode)h.push(u),f=u;f===(i.ownerDocument||a)&&h.push(f.defaultView||f.parentWindow||e)}d=0;while((u=h[d++])&&!n.isPropagationStopped())n.type=d>1?c:p.bindType||g,s=(x._data(u,"events")||{})[n.type]&&x._data(u,"handle"),s&&s.apply(u,r),s=l&&u[l],s&&x.acceptData(u)&&s.apply&&s.apply(u,r)===!1&&n.preventDefault();if(n.type=g,!o&&!n.isDefaultPrevented()&&(!p._default||p._default.apply(h.pop(),r)===!1)&&x.acceptData(i)&&l&&i[g]&&!x.isWindow(i)){f=i[l],f&&(i[l]=null),x.event.triggered=g;try{i[g]()}catch(y){}x.event.triggered=t,f&&(i[l]=f)}return n.result}},dispatch:function(e){e=x.event.fix(e);var n,r,i,o,a,s=[],l=g.call(arguments),u=(x._data(this,"events")||{})[e.type]||[],c=x.event.special[e.type]||{};if(l[0]=e,e.delegateTarget=this,!c.preDispatch||c.preDispatch.call(this,e)!==!1){s=x.event.handlers.call(this,e,u),n=0;while((o=s[n++])&&!e.isPropagationStopped()){e.currentTarget=o.elem,a=0;while((i=o.handlers[a++])&&!e.isImmediatePropagationStopped())(!e.namespace_re||e.namespace_re.test(i.namespace))&&(e.handleObj=i,e.data=i.data,r=((x.event.special[i.origType]||{}).handle||i.handler).apply(o.elem,l),r!==t&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,n){var r,i,o,a,s=[],l=n.delegateCount,u=e.target;if(l&&u.nodeType&&(!e.button||"click"!==e.type))for(;u!=this;u=u.parentNode||this)if(1===u.nodeType&&(u.disabled!==!0||"click"!==e.type)){for(o=[],a=0;l>a;a++)i=n[a],r=i.selector+" ",o[r]===t&&(o[r]=i.needsContext?x(r,this).index(u)>=0:x.find(r,this,null,[u]).length),o[r]&&o.push(i);o.length&&s.push({elem:u,handlers:o})}return n.length>l&&s.push({elem:this,handlers:n.slice(l)}),s},fix:function(e){if(e[x.expando])return e;var t,n,r,i=e.type,o=e,s=this.fixHooks[i];s||(this.fixHooks[i]=s=tt.test(i)?this.mouseHooks:et.test(i)?this.keyHooks:{}),r=s.props?this.props.concat(s.props):this.props,e=new x.Event(o),t=r.length;while(t--)n=r[t],e[n]=o[n];return e.target||(e.target=o.srcElement||a),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,o):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,i,o,s=n.button,l=n.fromElement;return null==e.pageX&&null!=n.clientX&&(i=e.target.ownerDocument||a,o=i.documentElement,r=i.body,e.pageX=n.clientX+(o&&o.scrollLeft||r&&r.scrollLeft||0)-(o&&o.clientLeft||r&&r.clientLeft||0),e.pageY=n.clientY+(o&&o.scrollTop||r&&r.scrollTop||0)-(o&&o.clientTop||r&&r.clientTop||0)),!e.relatedTarget&&l&&(e.relatedTarget=l===e.target?n.toElement:l),e.which||s===t||(e.which=1&s?1:2&s?3:4&s?2:0),e}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==at()&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===at()&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},click:{trigger:function(){return x.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):t},_default:function(e){return x.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=x.extend(new x.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?x.event.trigger(i,null,t):x.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},x.removeEvent=a.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&&(typeof e[r]===i&&(e[r]=null),e.detachEvent(r,n))},x.Event=function(e,n){return this instanceof x.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault()?it:ot):this.type=e,n&&x.extend(this,n),this.timeStamp=e&&e.timeStamp||x.now(),this[x.expando]=!0,t):new x.Event(e,n)},x.Event.prototype={isDefaultPrevented:ot,isPropagationStopped:ot,isImmediatePropagationStopped:ot,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=it,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=it,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=it,this.stopPropagation()}},x.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){x.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;return(!i||i!==r&&!x.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),x.support.submitBubbles||(x.event.special.submit={setup:function(){return x.nodeName(this,"form")?!1:(x.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=x.nodeName(n,"input")||x.nodeName(n,"button")?n.form:t;r&&!x._data(r,"submitBubbles")&&(x.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),x._data(r,"submitBubbles",!0))}),t)},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&x.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){return x.nodeName(this,"form")?!1:(x.event.remove(this,"._submit"),t)}}),x.support.changeBubbles||(x.event.special.change={setup:function(){return Z.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(x.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)}),x.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),x.event.simulate("change",this,e,!0)})),!1):(x.event.add(this,"beforeactivate._change",function(e){var t=e.target;Z.test(t.nodeName)&&!x._data(t,"changeBubbles")&&(x.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||x.event.simulate("change",this.parentNode,e,!0)}),x._data(t,"changeBubbles",!0))}),t)},handle:function(e){var n=e.target;return this!==n||e.isSimulated||e.isTrigger||"radio"!==n.type&&"checkbox"!==n.type?e.handleObj.handler.apply(this,arguments):t},teardown:function(){return x.event.remove(this,"._change"),!Z.test(this.nodeName)}}),x.support.focusinBubbles||x.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){x.event.simulate(t,e.target,x.event.fix(e),!0)};x.event.special[t]={setup:function(){0===n++&&a.addEventListener(e,r,!0)},teardown:function(){0===--n&&a.removeEventListener(e,r,!0)}}}),x.fn.extend({on:function(e,n,r,i,o){var a,s;if("object"==typeof e){"string"!=typeof n&&(r=r||n,n=t);for(a in e)this.on(a,n,r,e[a],o);return this}if(null==r&&null==i?(i=n,r=n=t):null==i&&("string"==typeof n?(i=r,r=t):(i=r,r=n,n=t)),i===!1)i=ot;else if(!i)return this;return 1===o&&(s=i,i=function(e){return x().off(e),s.apply(this,arguments)},i.guid=s.guid||(s.guid=x.guid++)),this.each(function(){x.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,o;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,x(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(o in e)this.off(o,n,e[o]);return this}return(n===!1||"function"==typeof n)&&(r=n,n=t),r===!1&&(r=ot),this.each(function(){x.event.remove(this,e,r,n)})},trigger:function(e,t){return this.each(function(){x.event.trigger(e,t,this)})},triggerHandler:function(e,n){var r=this[0];return r?x.event.trigger(e,n,r,!0):t}});var st=/^.[^:#\[\.,]*$/,lt=/^(?:parents|prev(?:Until|All))/,ut=x.expr.match.needsContext,ct={children:!0,contents:!0,next:!0,prev:!0};x.fn.extend({find:function(e){var t,n=[],r=this,i=r.length;if("string"!=typeof e)return this.pushStack(x(e).filter(function(){for(t=0;i>t;t++)if(x.contains(r[t],this))return!0}));for(t=0;i>t;t++)x.find(e,r[t],n);return n=this.pushStack(i>1?x.unique(n):n),n.selector=this.selector?this.selector+" "+e:e,n},has:function(e){var t,n=x(e,this),r=n.length;return this.filter(function(){for(t=0;r>t;t++)if(x.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e||[],!0))},filter:function(e){return this.pushStack(ft(this,e||[],!1))},is:function(e){return!!ft(this,"string"==typeof e&&ut.test(e)?x(e):e||[],!1).length},closest:function(e,t){var n,r=0,i=this.length,o=[],a=ut.test(e)||"string"!=typeof e?x(e,t||this.context):0;for(;i>r;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(11>n.nodeType&&(a?a.index(n)>-1:1===n.nodeType&&x.find.matchesSelector(n,e))){n=o.push(n);break}return this.pushStack(o.length>1?x.unique(o):o)},index:function(e){return e?"string"==typeof e?x.inArray(this[0],x(e)):x.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var n="string"==typeof e?x(e,t):x.makeArray(e&&e.nodeType?[e]:e),r=x.merge(this.get(),n);return this.pushStack(x.unique(r))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}});function pt(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}x.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return x.dir(e,"parentNode")},parentsUntil:function(e,t,n){return x.dir(e,"parentNode",n)},next:function(e){return pt(e,"nextSibling")},prev:function(e){return pt(e,"previousSibling")},nextAll:function(e){return x.dir(e,"nextSibling")},prevAll:function(e){return x.dir(e,"previousSibling")},nextUntil:function(e,t,n){return x.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return x.dir(e,"previousSibling",n)},siblings:function(e){return x.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return x.sibling(e.firstChild)},contents:function(e){return x.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:x.merge([],e.childNodes)}},function(e,t){x.fn[e]=function(n,r){var i=x.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=x.filter(r,i)),this.length>1&&(ct[e]||(i=x.unique(i)),lt.test(e)&&(i=i.reverse())),this.pushStack(i)}}),x.extend({filter:function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?x.find.matchesSelector(r,e)?[r]:[]:x.find.matches(e,x.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,n,r){var i=[],o=e[n];while(o&&9!==o.nodeType&&(r===t||1!==o.nodeType||!x(o).is(r)))1===o.nodeType&&i.push(o),o=o[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}});function ft(e,t,n){if(x.isFunction(t))return x.grep(e,function(e,r){return!!t.call(e,r,e)!==n});if(t.nodeType)return x.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(st.test(t))return x.filter(t,e,n);t=x.filter(t,e)}return x.grep(e,function(e){return x.inArray(e,t)>=0!==n})}function dt(e){var t=ht.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}var ht="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gt=/ jQuery\d+="(?:null|\d+)"/g,mt=RegExp("<(?:"+ht+")[\\s/>]","i"),yt=/^\s+/,vt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bt=/<([\w:]+)/,xt=/<tbody/i,wt=/<|&#?\w+;/,Tt=/<(?:script|style|link)/i,Ct=/^(?:checkbox|radio)$/i,Nt=/checked\s*(?:[^=]|=\s*.checked.)/i,kt=/^$|\/(?:java|ecma)script/i,Et=/^true\/(.*)/,St=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,At={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:x.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},jt=dt(a),Dt=jt.appendChild(a.createElement("div"));At.optgroup=At.option,At.tbody=At.tfoot=At.colgroup=At.caption=At.thead,At.th=At.td,x.fn.extend({text:function(e){return x.access(this,function(e){return e===t?x.text(this):this.empty().append((this[0]&&this[0].ownerDocument||a).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Lt(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Lt(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){var n,r=e?x.filter(e,this):this,i=0;for(;null!=(n=r[i]);i++)t||1!==n.nodeType||x.cleanData(Ft(n)),n.parentNode&&(t&&x.contains(n.ownerDocument,n)&&_t(Ft(n,"script")),n.parentNode.removeChild(n));return this},empty:function(){var e,t=0;for(;null!=(e=this[t]);t++){1===e.nodeType&&x.cleanData(Ft(e,!1));while(e.firstChild)e.removeChild(e.firstChild);e.options&&x.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return x.clone(this,e,t)})},html:function(e){return x.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return 1===n.nodeType?n.innerHTML.replace(gt,""):t;if(!("string"!=typeof e||Tt.test(e)||!x.support.htmlSerialize&&mt.test(e)||!x.support.leadingWhitespace&&yt.test(e)||At[(bt.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(vt,"<$1></$2>");try{for(;i>r;r++)n=this[r]||{},1===n.nodeType&&(x.cleanData(Ft(n,!1)),n.innerHTML=e);n=0}catch(o){}}n&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=x.map(this,function(e){return[e.nextSibling,e.parentNode]}),t=0;return this.domManip(arguments,function(n){var r=e[t++],i=e[t++];i&&(r&&r.parentNode!==i&&(r=this.nextSibling),x(this).remove(),i.insertBefore(n,r))},!0),t?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t,n){e=d.apply([],e);var r,i,o,a,s,l,u=0,c=this.length,p=this,f=c-1,h=e[0],g=x.isFunction(h);if(g||!(1>=c||"string"!=typeof h||x.support.checkClone)&&Nt.test(h))return this.each(function(r){var i=p.eq(r);g&&(e[0]=h.call(this,r,i.html())),i.domManip(e,t,n)});if(c&&(l=x.buildFragment(e,this[0].ownerDocument,!1,!n&&this),r=l.firstChild,1===l.childNodes.length&&(l=r),r)){for(a=x.map(Ft(l,"script"),Ht),o=a.length;c>u;u++)i=l,u!==f&&(i=x.clone(i,!0,!0),o&&x.merge(a,Ft(i,"script"))),t.call(this[u],i,u);if(o)for(s=a[a.length-1].ownerDocument,x.map(a,qt),u=0;o>u;u++)i=a[u],kt.test(i.type||"")&&!x._data(i,"globalEval")&&x.contains(s,i)&&(i.src?x._evalUrl(i.src):x.globalEval((i.text||i.textContent||i.innerHTML||"").replace(St,"")));l=r=null}return this}});function Lt(e,t){return x.nodeName(e,"table")&&x.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function Ht(e){return e.type=(null!==x.find.attr(e,"type"))+"/"+e.type,e}function qt(e){var t=Et.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function _t(e,t){var n,r=0;for(;null!=(n=e[r]);r++)x._data(n,"globalEval",!t||x._data(t[r],"globalEval"))}function Mt(e,t){if(1===t.nodeType&&x.hasData(e)){var n,r,i,o=x._data(e),a=x._data(t,o),s=o.events;if(s){delete a.handle,a.events={};for(n in s)for(r=0,i=s[n].length;i>r;r++)x.event.add(t,n,s[n][r])}a.data&&(a.data=x.extend({},a.data))}}function Ot(e,t){var n,r,i;if(1===t.nodeType){if(n=t.nodeName.toLowerCase(),!x.support.noCloneEvent&&t[x.expando]){i=x._data(t);for(r in i.events)x.removeEvent(t,r,i.handle);t.removeAttribute(x.expando)}"script"===n&&t.text!==e.text?(Ht(t).text=e.text,qt(t)):"object"===n?(t.parentNode&&(t.outerHTML=e.outerHTML),x.support.html5Clone&&e.innerHTML&&!x.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===n&&Ct.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===n?t.defaultSelected=t.selected=e.defaultSelected:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}}x.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){x.fn[e]=function(e){var n,r=0,i=[],o=x(e),a=o.length-1;for(;a>=r;r++)n=r===a?this:this.clone(!0),x(o[r])[t](n),h.apply(i,n.get());return this.pushStack(i)}});function Ft(e,n){var r,o,a=0,s=typeof e.getElementsByTagName!==i?e.getElementsByTagName(n||"*"):typeof e.querySelectorAll!==i?e.querySelectorAll(n||"*"):t;if(!s)for(s=[],r=e.childNodes||e;null!=(o=r[a]);a++)!n||x.nodeName(o,n)?s.push(o):x.merge(s,Ft(o,n));return n===t||n&&x.nodeName(e,n)?x.merge([e],s):s}function Bt(e){Ct.test(e.type)&&(e.defaultChecked=e.checked)}x.extend({clone:function(e,t,n){var r,i,o,a,s,l=x.contains(e.ownerDocument,e);if(x.support.html5Clone||x.isXMLDoc(e)||!mt.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(Dt.innerHTML=e.outerHTML,Dt.removeChild(o=Dt.firstChild)),!(x.support.noCloneEvent&&x.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||x.isXMLDoc(e)))for(r=Ft(o),s=Ft(e),a=0;null!=(i=s[a]);++a)r[a]&&Ot(i,r[a]);if(t)if(n)for(s=s||Ft(e),r=r||Ft(o),a=0;null!=(i=s[a]);a++)Mt(i,r[a]);else Mt(e,o);return r=Ft(o,"script"),r.length>0&&_t(r,!l&&Ft(e,"script")),r=s=i=null,o},buildFragment:function(e,t,n,r){var i,o,a,s,l,u,c,p=e.length,f=dt(t),d=[],h=0;for(;p>h;h++)if(o=e[h],o||0===o)if("object"===x.type(o))x.merge(d,o.nodeType?[o]:o);else if(wt.test(o)){s=s||f.appendChild(t.createElement("div")),l=(bt.exec(o)||["",""])[1].toLowerCase(),c=At[l]||At._default,s.innerHTML=c[1]+o.replace(vt,"<$1></$2>")+c[2],i=c[0];while(i--)s=s.lastChild;if(!x.support.leadingWhitespace&&yt.test(o)&&d.push(t.createTextNode(yt.exec(o)[0])),!x.support.tbody){o="table"!==l||xt.test(o)?"<table>"!==c[1]||xt.test(o)?0:s:s.firstChild,i=o&&o.childNodes.length;while(i--)x.nodeName(u=o.childNodes[i],"tbody")&&!u.childNodes.length&&o.removeChild(u)}x.merge(d,s.childNodes),s.textContent="";while(s.firstChild)s.removeChild(s.firstChild);s=f.lastChild}else d.push(t.createTextNode(o));s&&f.removeChild(s),x.support.appendChecked||x.grep(Ft(d,"input"),Bt),h=0;while(o=d[h++])if((!r||-1===x.inArray(o,r))&&(a=x.contains(o.ownerDocument,o),s=Ft(f.appendChild(o),"script"),a&&_t(s),n)){i=0;while(o=s[i++])kt.test(o.type||"")&&n.push(o)}return s=null,f},cleanData:function(e,t){var n,r,o,a,s=0,l=x.expando,u=x.cache,c=x.support.deleteExpando,f=x.event.special;for(;null!=(n=e[s]);s++)if((t||x.acceptData(n))&&(o=n[l],a=o&&u[o])){if(a.events)for(r in a.events)f[r]?x.event.remove(n,r):x.removeEvent(n,r,a.handle);
-u[o]&&(delete u[o],c?delete n[l]:typeof n.removeAttribute!==i?n.removeAttribute(l):n[l]=null,p.push(o))}},_evalUrl:function(e){return x.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})}}),x.fn.extend({wrapAll:function(e){if(x.isFunction(e))return this.each(function(t){x(this).wrapAll(e.call(this,t))});if(this[0]){var t=x(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&&1===e.firstChild.nodeType)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return x.isFunction(e)?this.each(function(t){x(this).wrapInner(e.call(this,t))}):this.each(function(){var t=x(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=x.isFunction(e);return this.each(function(n){x(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){x.nodeName(this,"body")||x(this).replaceWith(this.childNodes)}).end()}});var Pt,Rt,Wt,$t=/alpha\([^)]*\)/i,It=/opacity\s*=\s*([^)]*)/,zt=/^(top|right|bottom|left)$/,Xt=/^(none|table(?!-c[ea]).+)/,Ut=/^margin/,Vt=RegExp("^("+w+")(.*)$","i"),Yt=RegExp("^("+w+")(?!px)[a-z%]+$","i"),Jt=RegExp("^([+-])=("+w+")","i"),Gt={BODY:"block"},Qt={position:"absolute",visibility:"hidden",display:"block"},Kt={letterSpacing:0,fontWeight:400},Zt=["Top","Right","Bottom","Left"],en=["Webkit","O","Moz","ms"];function tn(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=en.length;while(i--)if(t=en[i]+n,t in e)return t;return r}function nn(e,t){return e=t||e,"none"===x.css(e,"display")||!x.contains(e.ownerDocument,e)}function rn(e,t){var n,r,i,o=[],a=0,s=e.length;for(;s>a;a++)r=e[a],r.style&&(o[a]=x._data(r,"olddisplay"),n=r.style.display,t?(o[a]||"none"!==n||(r.style.display=""),""===r.style.display&&nn(r)&&(o[a]=x._data(r,"olddisplay",ln(r.nodeName)))):o[a]||(i=nn(r),(n&&"none"!==n||!i)&&x._data(r,"olddisplay",i?n:x.css(r,"display"))));for(a=0;s>a;a++)r=e[a],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[a]||"":"none"));return e}x.fn.extend({css:function(e,n){return x.access(this,function(e,n,r){var i,o,a={},s=0;if(x.isArray(n)){for(o=Rt(e),i=n.length;i>s;s++)a[n[s]]=x.css(e,n[s],!1,o);return a}return r!==t?x.style(e,n,r):x.css(e,n)},e,n,arguments.length>1)},show:function(){return rn(this,!0)},hide:function(){return rn(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){nn(this)?x(this).show():x(this).hide()})}}),x.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Wt(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":x.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,l=x.camelCase(n),u=e.style;if(n=x.cssProps[l]||(x.cssProps[l]=tn(u,l)),s=x.cssHooks[n]||x.cssHooks[l],r===t)return s&&"get"in s&&(o=s.get(e,!1,i))!==t?o:u[n];if(a=typeof r,"string"===a&&(o=Jt.exec(r))&&(r=(o[1]+1)*o[2]+parseFloat(x.css(e,n)),a="number"),!(null==r||"number"===a&&isNaN(r)||("number"!==a||x.cssNumber[l]||(r+="px"),x.support.clearCloneStyle||""!==r||0!==n.indexOf("background")||(u[n]="inherit"),s&&"set"in s&&(r=s.set(e,r,i))===t)))try{u[n]=r}catch(c){}}},css:function(e,n,r,i){var o,a,s,l=x.camelCase(n);return n=x.cssProps[l]||(x.cssProps[l]=tn(e.style,l)),s=x.cssHooks[n]||x.cssHooks[l],s&&"get"in s&&(a=s.get(e,!0,r)),a===t&&(a=Wt(e,n,i)),"normal"===a&&n in Kt&&(a=Kt[n]),""===r||r?(o=parseFloat(a),r===!0||x.isNumeric(o)?o||0:a):a}}),e.getComputedStyle?(Rt=function(t){return e.getComputedStyle(t,null)},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),l=s?s.getPropertyValue(n)||s[n]:t,u=e.style;return s&&(""!==l||x.contains(e.ownerDocument,e)||(l=x.style(e,n)),Yt.test(l)&&Ut.test(n)&&(i=u.width,o=u.minWidth,a=u.maxWidth,u.minWidth=u.maxWidth=u.width=l,l=s.width,u.width=i,u.minWidth=o,u.maxWidth=a)),l}):a.documentElement.currentStyle&&(Rt=function(e){return e.currentStyle},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),l=s?s[n]:t,u=e.style;return null==l&&u&&u[n]&&(l=u[n]),Yt.test(l)&&!zt.test(n)&&(i=u.left,o=e.runtimeStyle,a=o&&o.left,a&&(o.left=e.currentStyle.left),u.left="fontSize"===n?"1em":l,l=u.pixelLeft+"px",u.left=i,a&&(o.left=a)),""===l?"auto":l});function on(e,t,n){var r=Vt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function an(e,t,n,r,i){var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;for(;4>o;o+=2)"margin"===n&&(a+=x.css(e,n+Zt[o],!0,i)),r?("content"===n&&(a-=x.css(e,"padding"+Zt[o],!0,i)),"margin"!==n&&(a-=x.css(e,"border"+Zt[o]+"Width",!0,i))):(a+=x.css(e,"padding"+Zt[o],!0,i),"padding"!==n&&(a+=x.css(e,"border"+Zt[o]+"Width",!0,i)));return a}function sn(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=Rt(e),a=x.support.boxSizing&&"border-box"===x.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=Wt(e,t,o),(0>i||null==i)&&(i=e.style[t]),Yt.test(i))return i;r=a&&(x.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+an(e,t,n||(a?"border":"content"),r,o)+"px"}function ln(e){var t=a,n=Gt[e];return n||(n=un(e,t),"none"!==n&&n||(Pt=(Pt||x("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Pt[0].contentWindow||Pt[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),n=un(e,t),Pt.detach()),Gt[e]=n),n}function un(e,t){var n=x(t.createElement(e)).appendTo(t.body),r=x.css(n[0],"display");return n.remove(),r}x.each(["height","width"],function(e,n){x.cssHooks[n]={get:function(e,r,i){return r?0===e.offsetWidth&&Xt.test(x.css(e,"display"))?x.swap(e,Qt,function(){return sn(e,n,i)}):sn(e,n,i):t},set:function(e,t,r){var i=r&&Rt(e);return on(e,t,r?an(e,n,r,x.support.boxSizing&&"border-box"===x.css(e,"boxSizing",!1,i),i):0)}}}),x.support.opacity||(x.cssHooks.opacity={get:function(e,t){return It.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=x.isNumeric(t)?"alpha(opacity="+100*t+")":"",o=r&&r.filter||n.filter||"";n.zoom=1,(t>=1||""===t)&&""===x.trim(o.replace($t,""))&&n.removeAttribute&&(n.removeAttribute("filter"),""===t||r&&!r.filter)||(n.filter=$t.test(o)?o.replace($t,i):o+" "+i)}}),x(function(){x.support.reliableMarginRight||(x.cssHooks.marginRight={get:function(e,n){return n?x.swap(e,{display:"inline-block"},Wt,[e,"marginRight"]):t}}),!x.support.pixelPosition&&x.fn.position&&x.each(["top","left"],function(e,n){x.cssHooks[n]={get:function(e,r){return r?(r=Wt(e,n),Yt.test(r)?x(e).position()[n]+"px":r):t}}})}),x.expr&&x.expr.filters&&(x.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight||!x.support.reliableHiddenOffsets&&"none"===(e.style&&e.style.display||x.css(e,"display"))},x.expr.filters.visible=function(e){return!x.expr.filters.hidden(e)}),x.each({margin:"",padding:"",border:"Width"},function(e,t){x.cssHooks[e+t]={expand:function(n){var r=0,i={},o="string"==typeof n?n.split(" "):[n];for(;4>r;r++)i[e+Zt[r]+t]=o[r]||o[r-2]||o[0];return i}},Ut.test(e)||(x.cssHooks[e+t].set=on)});var cn=/%20/g,pn=/\[\]$/,fn=/\r?\n/g,dn=/^(?:submit|button|image|reset|file)$/i,hn=/^(?:input|select|textarea|keygen)/i;x.fn.extend({serialize:function(){return x.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=x.prop(this,"elements");return e?x.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!x(this).is(":disabled")&&hn.test(this.nodeName)&&!dn.test(e)&&(this.checked||!Ct.test(e))}).map(function(e,t){var n=x(this).val();return null==n?null:x.isArray(n)?x.map(n,function(e){return{name:t.name,value:e.replace(fn,"\r\n")}}):{name:t.name,value:n.replace(fn,"\r\n")}}).get()}}),x.param=function(e,n){var r,i=[],o=function(e,t){t=x.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(n===t&&(n=x.ajaxSettings&&x.ajaxSettings.traditional),x.isArray(e)||e.jquery&&!x.isPlainObject(e))x.each(e,function(){o(this.name,this.value)});else for(r in e)gn(r,e[r],n,o);return i.join("&").replace(cn,"+")};function gn(e,t,n,r){var i;if(x.isArray(t))x.each(t,function(t,i){n||pn.test(e)?r(e,i):gn(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==x.type(t))r(e,t);else for(i in t)gn(e+"["+i+"]",t[i],n,r)}x.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){x.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),x.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}});var mn,yn,vn=x.now(),bn=/\?/,xn=/#.*$/,wn=/([?&])_=[^&]*/,Tn=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Cn=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Nn=/^(?:GET|HEAD)$/,kn=/^\/\//,En=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,Sn=x.fn.load,An={},jn={},Dn="*/".concat("*");try{yn=o.href}catch(Ln){yn=a.createElement("a"),yn.href="",yn=yn.href}mn=En.exec(yn.toLowerCase())||[];function Hn(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(T)||[];if(x.isFunction(n))while(r=o[i++])"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function qn(e,n,r,i){var o={},a=e===jn;function s(l){var u;return o[l]=!0,x.each(e[l]||[],function(e,l){var c=l(n,r,i);return"string"!=typeof c||a||o[c]?a?!(u=c):t:(n.dataTypes.unshift(c),s(c),!1)}),u}return s(n.dataTypes[0])||!o["*"]&&s("*")}function _n(e,n){var r,i,o=x.ajaxSettings.flatOptions||{};for(i in n)n[i]!==t&&((o[i]?e:r||(r={}))[i]=n[i]);return r&&x.extend(!0,e,r),e}x.fn.load=function(e,n,r){if("string"!=typeof e&&Sn)return Sn.apply(this,arguments);var i,o,a,s=this,l=e.indexOf(" ");return l>=0&&(i=e.slice(l,e.length),e=e.slice(0,l)),x.isFunction(n)?(r=n,n=t):n&&"object"==typeof n&&(a="POST"),s.length>0&&x.ajax({url:e,type:a,dataType:"html",data:n}).done(function(e){o=arguments,s.html(i?x("<div>").append(x.parseHTML(e)).find(i):e)}).complete(r&&function(e,t){s.each(r,o||[e.responseText,t,e])}),this},x.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){x.fn[t]=function(e){return this.on(t,e)}}),x.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:yn,type:"GET",isLocal:Cn.test(mn[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Dn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":x.parseJSON,"text xml":x.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?_n(_n(e,x.ajaxSettings),t):_n(x.ajaxSettings,e)},ajaxPrefilter:Hn(An),ajaxTransport:Hn(jn),ajax:function(e,n){"object"==typeof e&&(n=e,e=t),n=n||{};var r,i,o,a,s,l,u,c,p=x.ajaxSetup({},n),f=p.context||p,d=p.context&&(f.nodeType||f.jquery)?x(f):x.event,h=x.Deferred(),g=x.Callbacks("once memory"),m=p.statusCode||{},y={},v={},b=0,w="canceled",C={readyState:0,getResponseHeader:function(e){var t;if(2===b){if(!c){c={};while(t=Tn.exec(a))c[t[1].toLowerCase()]=t[2]}t=c[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===b?a:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return b||(e=v[n]=v[n]||e,y[e]=t),this},overrideMimeType:function(e){return b||(p.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>b)for(t in e)m[t]=[m[t],e[t]];else C.always(e[C.status]);return this},abort:function(e){var t=e||w;return u&&u.abort(t),k(0,t),this}};if(h.promise(C).complete=g.add,C.success=C.done,C.error=C.fail,p.url=((e||p.url||yn)+"").replace(xn,"").replace(kn,mn[1]+"//"),p.type=n.method||n.type||p.method||p.type,p.dataTypes=x.trim(p.dataType||"*").toLowerCase().match(T)||[""],null==p.crossDomain&&(r=En.exec(p.url.toLowerCase()),p.crossDomain=!(!r||r[1]===mn[1]&&r[2]===mn[2]&&(r[3]||("http:"===r[1]?"80":"443"))===(mn[3]||("http:"===mn[1]?"80":"443")))),p.data&&p.processData&&"string"!=typeof p.data&&(p.data=x.param(p.data,p.traditional)),qn(An,p,n,C),2===b)return C;l=p.global,l&&0===x.active++&&x.event.trigger("ajaxStart"),p.type=p.type.toUpperCase(),p.hasContent=!Nn.test(p.type),o=p.url,p.hasContent||(p.data&&(o=p.url+=(bn.test(o)?"&":"?")+p.data,delete p.data),p.cache===!1&&(p.url=wn.test(o)?o.replace(wn,"$1_="+vn++):o+(bn.test(o)?"&":"?")+"_="+vn++)),p.ifModified&&(x.lastModified[o]&&C.setRequestHeader("If-Modified-Since",x.lastModified[o]),x.etag[o]&&C.setRequestHeader("If-None-Match",x.etag[o])),(p.data&&p.hasContent&&p.contentType!==!1||n.contentType)&&C.setRequestHeader("Content-Type",p.contentType),C.setRequestHeader("Accept",p.dataTypes[0]&&p.accepts[p.dataTypes[0]]?p.accepts[p.dataTypes[0]]+("*"!==p.dataTypes[0]?", "+Dn+"; q=0.01":""):p.accepts["*"]);for(i in p.headers)C.setRequestHeader(i,p.headers[i]);if(p.beforeSend&&(p.beforeSend.call(f,C,p)===!1||2===b))return C.abort();w="abort";for(i in{success:1,error:1,complete:1})C[i](p[i]);if(u=qn(jn,p,n,C)){C.readyState=1,l&&d.trigger("ajaxSend",[C,p]),p.async&&p.timeout>0&&(s=setTimeout(function(){C.abort("timeout")},p.timeout));try{b=1,u.send(y,k)}catch(N){if(!(2>b))throw N;k(-1,N)}}else k(-1,"No Transport");function k(e,n,r,i){var c,y,v,w,T,N=n;2!==b&&(b=2,s&&clearTimeout(s),u=t,a=i||"",C.readyState=e>0?4:0,c=e>=200&&300>e||304===e,r&&(w=Mn(p,C,r)),w=On(p,w,C,c),c?(p.ifModified&&(T=C.getResponseHeader("Last-Modified"),T&&(x.lastModified[o]=T),T=C.getResponseHeader("etag"),T&&(x.etag[o]=T)),204===e||"HEAD"===p.type?N="nocontent":304===e?N="notmodified":(N=w.state,y=w.data,v=w.error,c=!v)):(v=N,(e||!N)&&(N="error",0>e&&(e=0))),C.status=e,C.statusText=(n||N)+"",c?h.resolveWith(f,[y,N,C]):h.rejectWith(f,[C,N,v]),C.statusCode(m),m=t,l&&d.trigger(c?"ajaxSuccess":"ajaxError",[C,p,c?y:v]),g.fireWith(f,[C,N]),l&&(d.trigger("ajaxComplete",[C,p]),--x.active||x.event.trigger("ajaxStop")))}return C},getJSON:function(e,t,n){return x.get(e,t,n,"json")},getScript:function(e,n){return x.get(e,t,n,"script")}}),x.each(["get","post"],function(e,n){x[n]=function(e,r,i,o){return x.isFunction(r)&&(o=o||i,i=r,r=t),x.ajax({url:e,type:n,dataType:o,data:r,success:i})}});function Mn(e,n,r){var i,o,a,s,l=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),o===t&&(o=e.mimeType||n.getResponseHeader("Content-Type"));if(o)for(s in l)if(l[s]&&l[s].test(o)){u.unshift(s);break}if(u[0]in r)a=u[0];else{for(s in r){if(!u[0]||e.converters[s+" "+u[0]]){a=s;break}i||(i=s)}a=a||i}return a?(a!==u[0]&&u.unshift(a),r[a]):t}function On(e,t,n,r){var i,o,a,s,l,u={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!l&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),l=o,o=c.shift())if("*"===o)o=l;else if("*"!==l&&l!==o){if(a=u[l+" "+o]||u["* "+o],!a)for(i in u)if(s=i.split(" "),s[1]===o&&(a=u[l+" "+s[0]]||u["* "+s[0]])){a===!0?a=u[i]:u[i]!==!0&&(o=s[0],c.unshift(s[1]));break}if(a!==!0)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(p){return{state:"parsererror",error:a?p:"No conversion from "+l+" to "+o}}}return{state:"success",data:t}}x.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return x.globalEval(e),e}}}),x.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),x.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=a.head||x("head")[0]||a.documentElement;return{send:function(t,i){n=a.createElement("script"),n.async=!0,e.scriptCharset&&(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,t){(t||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),n=null,t||i(200,"success"))},r.insertBefore(n,r.firstChild)},abort:function(){n&&n.onload(t,!0)}}}});var Fn=[],Bn=/(=)\?(?=&|$)|\?\?/;x.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Fn.pop()||x.expando+"_"+vn++;return this[e]=!0,e}}),x.ajaxPrefilter("json jsonp",function(n,r,i){var o,a,s,l=n.jsonp!==!1&&(Bn.test(n.url)?"url":"string"==typeof n.data&&!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&&Bn.test(n.data)&&"data");return l||"jsonp"===n.dataTypes[0]?(o=n.jsonpCallback=x.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,l?n[l]=n[l].replace(Bn,"$1"+o):n.jsonp!==!1&&(n.url+=(bn.test(n.url)?"&":"?")+n.jsonp+"="+o),n.converters["script json"]=function(){return s||x.error(o+" was not called"),s[0]},n.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},i.always(function(){e[o]=a,n[o]&&(n.jsonpCallback=r.jsonpCallback,Fn.push(o)),s&&x.isFunction(a)&&a(s[0]),s=a=t}),"script"):t});var Pn,Rn,Wn=0,$n=e.ActiveXObject&&function(){var e;for(e in Pn)Pn[e](t,!0)};function In(){try{return new e.XMLHttpRequest}catch(t){}}function zn(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}x.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&In()||zn()}:In,Rn=x.ajaxSettings.xhr(),x.support.cors=!!Rn&&"withCredentials"in Rn,Rn=x.support.ajax=!!Rn,Rn&&x.ajaxTransport(function(n){if(!n.crossDomain||x.support.cors){var r;return{send:function(i,o){var a,s,l=n.xhr();if(n.username?l.open(n.type,n.url,n.async,n.username,n.password):l.open(n.type,n.url,n.async),n.xhrFields)for(s in n.xhrFields)l[s]=n.xhrFields[s];n.mimeType&&l.overrideMimeType&&l.overrideMimeType(n.mimeType),n.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");try{for(s in i)l.setRequestHeader(s,i[s])}catch(u){}l.send(n.hasContent&&n.data||null),r=function(e,i){var s,u,c,p;try{if(r&&(i||4===l.readyState))if(r=t,a&&(l.onreadystatechange=x.noop,$n&&delete Pn[a]),i)4!==l.readyState&&l.abort();else{p={},s=l.status,u=l.getAllResponseHeaders(),"string"==typeof l.responseText&&(p.text=l.responseText);try{c=l.statusText}catch(f){c=""}s||!n.isLocal||n.crossDomain?1223===s&&(s=204):s=p.text?200:404}}catch(d){i||o(-1,d)}p&&o(s,c,p,u)},n.async?4===l.readyState?setTimeout(r):(a=++Wn,$n&&(Pn||(Pn={},x(e).unload($n)),Pn[a]=r),l.onreadystatechange=r):r()},abort:function(){r&&r(t,!0)}}}});var Xn,Un,Vn=/^(?:toggle|show|hide)$/,Yn=RegExp("^(?:([+-])=|)("+w+")([a-z%]*)$","i"),Jn=/queueHooks$/,Gn=[nr],Qn={"*":[function(e,t){var n=this.createTween(e,t),r=n.cur(),i=Yn.exec(t),o=i&&i[3]||(x.cssNumber[e]?"":"px"),a=(x.cssNumber[e]||"px"!==o&&+r)&&Yn.exec(x.css(n.elem,e)),s=1,l=20;if(a&&a[3]!==o){o=o||a[3],i=i||[],a=+r||1;do s=s||".5",a/=s,x.style(n.elem,e,a+o);while(s!==(s=n.cur()/r)&&1!==s&&--l)}return i&&(a=n.start=+a||+r||0,n.unit=o,n.end=i[1]?a+(i[1]+1)*i[2]:+i[2]),n}]};function Kn(){return setTimeout(function(){Xn=t}),Xn=x.now()}function Zn(e,t,n){var r,i=(Qn[t]||[]).concat(Qn["*"]),o=0,a=i.length;for(;a>o;o++)if(r=i[o].call(n,t,e))return r}function er(e,t,n){var r,i,o=0,a=Gn.length,s=x.Deferred().always(function(){delete l.elem}),l=function(){if(i)return!1;var t=Xn||Kn(),n=Math.max(0,u.startTime+u.duration-t),r=n/u.duration||0,o=1-r,a=0,l=u.tweens.length;for(;l>a;a++)u.tweens[a].run(o);return s.notifyWith(e,[u,o,n]),1>o&&l?n:(s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:x.extend({},t),opts:x.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Xn||Kn(),duration:n.duration,tweens:[],createTween:function(t,n){var r=x.Tween(e,u.opts,t,n,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(r),r},stop:function(t){var n=0,r=t?u.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)u.tweens[n].run(1);return t?s.resolveWith(e,[u,t]):s.rejectWith(e,[u,t]),this}}),c=u.props;for(tr(c,u.opts.specialEasing);a>o;o++)if(r=Gn[o].call(u,e,c,u.opts))return r;return x.map(c,Zn,u),x.isFunction(u.opts.start)&&u.opts.start.call(e,u),x.fx.timer(x.extend(l,{elem:e,anim:u,queue:u.opts.queue})),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always)}function tr(e,t){var n,r,i,o,a;for(n in e)if(r=x.camelCase(n),i=t[r],o=e[n],x.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),a=x.cssHooks[r],a&&"expand"in a){o=a.expand(o),delete e[r];for(n in o)n in e||(e[n]=o[n],t[n]=i)}else t[r]=i}x.Animation=x.extend(er,{tweener:function(e,t){x.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;i>r;r++)n=e[r],Qn[n]=Qn[n]||[],Qn[n].unshift(t)},prefilter:function(e,t){t?Gn.unshift(e):Gn.push(e)}});function nr(e,t,n){var r,i,o,a,s,l,u=this,c={},p=e.style,f=e.nodeType&&nn(e),d=x._data(e,"fxshow");n.queue||(s=x._queueHooks(e,"fx"),null==s.unqueued&&(s.unqueued=0,l=s.empty.fire,s.empty.fire=function(){s.unqueued||l()}),s.unqueued++,u.always(function(){u.always(function(){s.unqueued--,x.queue(e,"fx").length||s.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],"inline"===x.css(e,"display")&&"none"===x.css(e,"float")&&(x.support.inlineBlockNeedsLayout&&"inline"!==ln(e.nodeName)?p.zoom=1:p.display="inline-block")),n.overflow&&(p.overflow="hidden",x.support.shrinkWrapBlocks||u.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t)if(i=t[r],Vn.exec(i)){if(delete t[r],o=o||"toggle"===i,i===(f?"hide":"show"))continue;c[r]=d&&d[r]||x.style(e,r)}if(!x.isEmptyObject(c)){d?"hidden"in d&&(f=d.hidden):d=x._data(e,"fxshow",{}),o&&(d.hidden=!f),f?x(e).show():u.done(function(){x(e).hide()}),u.done(function(){var t;x._removeData(e,"fxshow");for(t in c)x.style(e,t,c[t])});for(r in c)a=Zn(f?d[r]:0,r,u),r in d||(d[r]=a.start,f&&(a.end=a.start,a.start="width"===r||"height"===r?1:0))}}function rr(e,t,n,r,i){return new rr.prototype.init(e,t,n,r,i)}x.Tween=rr,rr.prototype={constructor:rr,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(x.cssNumber[n]?"":"px")},cur:function(){var e=rr.propHooks[this.prop];return e&&e.get?e.get(this):rr.propHooks._default.get(this)},run:function(e){var t,n=rr.propHooks[this.prop];return this.pos=t=this.options.duration?x.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):rr.propHooks._default.set(this),this}},rr.prototype.init.prototype=rr.prototype,rr.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=x.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){x.fx.step[e.prop]?x.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[x.cssProps[e.prop]]||x.cssHooks[e.prop])?x.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},rr.propHooks.scrollTop=rr.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},x.each(["toggle","show","hide"],function(e,t){var n=x.fn[t];x.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(ir(t,!0),e,r,i)}}),x.fn.extend({fadeTo:function(e,t,n,r){return this.filter(nn).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=x.isEmptyObject(e),o=x.speed(t,n,r),a=function(){var t=er(this,x.extend({},e),o);(i||x._data(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=n,n=e,e=t),n&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,n=null!=e&&e+"queueHooks",o=x.timers,a=x._data(this);if(n)a[n]&&a[n].stop&&i(a[n]);else for(n in a)a[n]&&a[n].stop&&Jn.test(n)&&i(a[n]);for(n=o.length;n--;)o[n].elem!==this||null!=e&&o[n].queue!==e||(o[n].anim.stop(r),t=!1,o.splice(n,1));(t||!r)&&x.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=x._data(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=x.timers,a=r?r.length:0;for(n.finish=!0,x.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}});function ir(e,t){var n,r={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)n=Zt[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}x.each({slideDown:ir("show"),slideUp:ir("hide"),slideToggle:ir("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){x.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),x.speed=function(e,t,n){var r=e&&"object"==typeof e?x.extend({},e):{complete:n||!n&&t||x.isFunction(e)&&e,duration:e,easing:n&&t||t&&!x.isFunction(t)&&t};return r.duration=x.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in x.fx.speeds?x.fx.speeds[r.duration]:x.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){x.isFunction(r.old)&&r.old.call(this),r.queue&&x.dequeue(this,r.queue)},r},x.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},x.timers=[],x.fx=rr.prototype.init,x.fx.tick=function(){var e,n=x.timers,r=0;for(Xn=x.now();n.length>r;r++)e=n[r],e()||n[r]!==e||n.splice(r--,1);n.length||x.fx.stop(),Xn=t},x.fx.timer=function(e){e()&&x.timers.push(e)&&x.fx.start()},x.fx.interval=13,x.fx.start=function(){Un||(Un=setInterval(x.fx.tick,x.fx.interval))},x.fx.stop=function(){clearInterval(Un),Un=null},x.fx.speeds={slow:600,fast:200,_default:400},x.fx.step={},x.expr&&x.expr.filters&&(x.expr.filters.animated=function(e){return x.grep(x.timers,function(t){return e===t.elem}).length}),x.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){x.offset.setOffset(this,e,t)});var n,r,o={top:0,left:0},a=this[0],s=a&&a.ownerDocument;if(s)return n=s.documentElement,x.contains(n,a)?(typeof a.getBoundingClientRect!==i&&(o=a.getBoundingClientRect()),r=or(s),{top:o.top+(r.pageYOffset||n.scrollTop)-(n.clientTop||0),left:o.left+(r.pageXOffset||n.scrollLeft)-(n.clientLeft||0)}):o},x.offset={setOffset:function(e,t,n){var r=x.css(e,"position");"static"===r&&(e.style.position="relative");var i=x(e),o=i.offset(),a=x.css(e,"top"),s=x.css(e,"left"),l=("absolute"===r||"fixed"===r)&&x.inArray("auto",[a,s])>-1,u={},c={},p,f;l?(c=i.position(),p=c.top,f=c.left):(p=parseFloat(a)||0,f=parseFloat(s)||0),x.isFunction(t)&&(t=t.call(e,n,o)),null!=t.top&&(u.top=t.top-o.top+p),null!=t.left&&(u.left=t.left-o.left+f),"using"in t?t.using.call(e,u):i.css(u)}},x.fn.extend({position:function(){if(this[0]){var e,t,n={top:0,left:0},r=this[0];return"fixed"===x.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),x.nodeName(e[0],"html")||(n=e.offset()),n.top+=x.css(e[0],"borderTopWidth",!0),n.left+=x.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-x.css(r,"marginTop",!0),left:t.left-n.left-x.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||s;while(e&&!x.nodeName(e,"html")&&"static"===x.css(e,"position"))e=e.offsetParent;return e||s})}}),x.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);x.fn[e]=function(i){return x.access(this,function(e,i,o){var a=or(e);return o===t?a?n in a?a[n]:a.document.documentElement[i]:e[i]:(a?a.scrollTo(r?x(a).scrollLeft():o,r?o:x(a).scrollTop()):e[i]=o,t)},e,i,arguments.length,null)}});function or(e){return x.isWindow(e)?e:9===e.nodeType?e.defaultView||e.parentWindow:!1}x.each({Height:"height",Width:"width"},function(e,n){x.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){x.fn[i]=function(i,o){var a=arguments.length&&(r||"boolean"!=typeof i),s=r||(i===!0||o===!0?"margin":"border");return x.access(this,function(n,r,i){var o;return x.isWindow(n)?n.document.documentElement["client"+e]:9===n.nodeType?(o=n.documentElement,Math.max(n.body["scroll"+e],o["scroll"+e],n.body["offset"+e],o["offset"+e],o["client"+e])):i===t?x.css(n,r,s):x.style(n,r,i,s)},n,a?i:t,a,null)}})}),x.fn.size=function(){return this.length},x.fn.andSelf=x.fn.addBack,"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=x:(e.jQuery=e.$=x,"function"==typeof define&&define.amd&&define("jquery",[],function(){return x}))})(window);
diff --git a/web/src/main/webapp/js/jquery-2.1.0.min.js b/web/src/main/webapp/js/jquery-2.1.0.min.js
new file mode 100644
index 0000000000..cbe6abe59a
--- /dev/null
+++ b/web/src/main/webapp/js/jquery-2.1.0.min.js
@@ -0,0 +1,4 @@
+/*! jQuery v2.1.0 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
+!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k="".trim,l={},m=a.document,n="2.1.0",o=function(a,b){return new o.fn.init(a,b)},p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};o.fn=o.prototype={jquery:n,constructor:o,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=o.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return o.each(this,a,b)},map:function(a){return this.pushStack(o.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},o.extend=o.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||o.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(o.isPlainObject(d)||(e=o.isArray(d)))?(e?(e=!1,f=c&&o.isArray(c)?c:[]):f=c&&o.isPlainObject(c)?c:{},g[b]=o.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},o.extend({expando:"jQuery"+(n+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===o.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return a-parseFloat(a)>=0},isPlainObject:function(a){if("object"!==o.type(a)||a.nodeType||o.isWindow(a))return!1;try{if(a.constructor&&!j.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}return!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=o.trim(a),a&&(1===a.indexOf("use strict")?(b=m.createElement("script"),b.text=a,m.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:function(a){return null==a?"":k.call(a)},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?o.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:g.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(c=a[b],b=a,a=c),o.isFunction(a)?(e=d.call(arguments,2),f=function(){return a.apply(b||this,e.concat(d.call(arguments)))},f.guid=a.guid=a.guid||o.guid++,f):void 0},now:Date.now,support:l}),o.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=o.type(a);return"function"===c||o.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="sizzle"+-new Date,t=a.document,u=0,v=0,w=eb(),x=eb(),y=eb(),z=function(a,b){return a===b&&(j=!0),0},A="undefined",B=1<<31,C={}.hasOwnProperty,D=[],E=D.pop,F=D.push,G=D.push,H=D.slice,I=D.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},J="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",K="[\\x20\\t\\r\\n\\f]",L="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",M=L.replace("w","w#"),N="\\["+K+"*("+L+")"+K+"*(?:([*^$|!~]?=)"+K+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+M+")|)|)"+K+"*\\]",O=":("+L+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+N.replace(3,8)+")*)|.*)\\)|)",P=new RegExp("^"+K+"+|((?:^|[^\\\\])(?:\\\\.)*)"+K+"+$","g"),Q=new RegExp("^"+K+"*,"+K+"*"),R=new RegExp("^"+K+"*([>+~]|"+K+")"+K+"*"),S=new RegExp("="+K+"*([^\\]'\"]*?)"+K+"*\\]","g"),T=new RegExp(O),U=new RegExp("^"+M+"$"),V={ID:new RegExp("^#("+L+")"),CLASS:new RegExp("^\\.("+L+")"),TAG:new RegExp("^("+L.replace("w","w*")+")"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+K+"*(even|odd|(([+-]|)(\\d*)n|)"+K+"*(?:([+-]|)"+K+"*(\\d+)|))"+K+"*\\)|)","i"),bool:new RegExp("^(?:"+J+")$","i"),needsContext:new RegExp("^"+K+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+K+"*((?:-\\d)?\\d*)"+K+"*\\)|)(?=[^-]|$)","i")},W=/^(?:input|select|textarea|button)$/i,X=/^h\d$/i,Y=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,$=/[+~]/,_=/'|\\/g,ab=new RegExp("\\\\([\\da-f]{1,6}"+K+"?|("+K+")|.)","ig"),bb=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{G.apply(D=H.call(t.childNodes),t.childNodes),D[t.childNodes.length].nodeType}catch(cb){G={apply:D.length?function(a,b){F.apply(a,H.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function db(a,b,d,e){var f,g,h,i,j,m,p,q,u,v;if((b?b.ownerDocument||b:t)!==l&&k(b),b=b||l,d=d||[],!a||"string"!=typeof a)return d;if(1!==(i=b.nodeType)&&9!==i)return[];if(n&&!e){if(f=Z.exec(a))if(h=f[1]){if(9===i){if(g=b.getElementById(h),!g||!g.parentNode)return d;if(g.id===h)return d.push(g),d}else if(b.ownerDocument&&(g=b.ownerDocument.getElementById(h))&&r(b,g)&&g.id===h)return d.push(g),d}else{if(f[2])return G.apply(d,b.getElementsByTagName(a)),d;if((h=f[3])&&c.getElementsByClassName&&b.getElementsByClassName)return G.apply(d,b.getElementsByClassName(h)),d}if(c.qsa&&(!o||!o.test(a))){if(q=p=s,u=b,v=9===i&&a,1===i&&"object"!==b.nodeName.toLowerCase()){m=ob(a),(p=b.getAttribute("id"))?q=p.replace(_,"\\$&"):b.setAttribute("id",q),q="[id='"+q+"'] ",j=m.length;while(j--)m[j]=q+pb(m[j]);u=$.test(a)&&mb(b.parentNode)||b,v=m.join(",")}if(v)try{return G.apply(d,u.querySelectorAll(v)),d}catch(w){}finally{p||b.removeAttribute("id")}}}return xb(a.replace(P,"$1"),b,d,e)}function eb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function fb(a){return a[s]=!0,a}function gb(a){var b=l.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function hb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function ib(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||B)-(~a.sourceIndex||B);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function jb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function kb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function lb(a){return fb(function(b){return b=+b,fb(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function mb(a){return a&&typeof a.getElementsByTagName!==A&&a}c=db.support={},f=db.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},k=db.setDocument=function(a){var b,e=a?a.ownerDocument||a:t,g=e.defaultView;return e!==l&&9===e.nodeType&&e.documentElement?(l=e,m=e.documentElement,n=!f(e),g&&g!==g.top&&(g.addEventListener?g.addEventListener("unload",function(){k()},!1):g.attachEvent&&g.attachEvent("onunload",function(){k()})),c.attributes=gb(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=gb(function(a){return a.appendChild(e.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Y.test(e.getElementsByClassName)&&gb(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),c.getById=gb(function(a){return m.appendChild(a).id=s,!e.getElementsByName||!e.getElementsByName(s).length}),c.getById?(d.find.ID=function(a,b){if(typeof b.getElementById!==A&&n){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ab,bb);return function(a){var c=typeof a.getAttributeNode!==A&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==A?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==A&&n?b.getElementsByClassName(a):void 0},p=[],o=[],(c.qsa=Y.test(e.querySelectorAll))&&(gb(function(a){a.innerHTML="<select t=''><option selected=''></option></select>",a.querySelectorAll("[t^='']").length&&o.push("[*^$]="+K+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||o.push("\\["+K+"*(?:value|"+J+")"),a.querySelectorAll(":checked").length||o.push(":checked")}),gb(function(a){var b=e.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&o.push("name"+K+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||o.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),o.push(",.*:")})),(c.matchesSelector=Y.test(q=m.webkitMatchesSelector||m.mozMatchesSelector||m.oMatchesSelector||m.msMatchesSelector))&&gb(function(a){c.disconnectedMatch=q.call(a,"div"),q.call(a,"[s!='']:x"),p.push("!=",O)}),o=o.length&&new RegExp(o.join("|")),p=p.length&&new RegExp(p.join("|")),b=Y.test(m.compareDocumentPosition),r=b||Y.test(m.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},z=b?function(a,b){if(a===b)return j=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===e||a.ownerDocument===t&&r(t,a)?-1:b===e||b.ownerDocument===t&&r(t,b)?1:i?I.call(i,a)-I.call(i,b):0:4&d?-1:1)}:function(a,b){if(a===b)return j=!0,0;var c,d=0,f=a.parentNode,g=b.parentNode,h=[a],k=[b];if(!f||!g)return a===e?-1:b===e?1:f?-1:g?1:i?I.call(i,a)-I.call(i,b):0;if(f===g)return ib(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)k.unshift(c);while(h[d]===k[d])d++;return d?ib(h[d],k[d]):h[d]===t?-1:k[d]===t?1:0},e):l},db.matches=function(a,b){return db(a,null,null,b)},db.matchesSelector=function(a,b){if((a.ownerDocument||a)!==l&&k(a),b=b.replace(S,"='$1']"),!(!c.matchesSelector||!n||p&&p.test(b)||o&&o.test(b)))try{var d=q.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return db(b,l,null,[a]).length>0},db.contains=function(a,b){return(a.ownerDocument||a)!==l&&k(a),r(a,b)},db.attr=function(a,b){(a.ownerDocument||a)!==l&&k(a);var e=d.attrHandle[b.toLowerCase()],f=e&&C.call(d.attrHandle,b.toLowerCase())?e(a,b,!n):void 0;return void 0!==f?f:c.attributes||!n?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},db.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},db.uniqueSort=function(a){var b,d=[],e=0,f=0;if(j=!c.detectDuplicates,i=!c.sortStable&&a.slice(0),a.sort(z),j){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return i=null,a},e=db.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=db.selectors={cacheLength:50,createPseudo:fb,match:V,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ab,bb),a[3]=(a[4]||a[5]||"").replace(ab,bb),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||db.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&db.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return V.CHILD.test(a[0])?null:(a[3]&&void 0!==a[4]?a[2]=a[4]:c&&T.test(c)&&(b=ob(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ab,bb).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=w[a+" "];return b||(b=new RegExp("(^|"+K+")"+a+"("+K+"|$)"))&&w(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==A&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=db.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),t=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&t){k=q[s]||(q[s]={}),j=k[a]||[],n=j[0]===u&&j[1],m=j[0]===u&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[u,n,m];break}}else if(t&&(j=(b[s]||(b[s]={}))[a])&&j[0]===u)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(t&&((l[s]||(l[s]={}))[a]=[u,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||db.error("unsupported pseudo: "+a);return e[s]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?fb(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=I.call(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:fb(function(a){var b=[],c=[],d=g(a.replace(P,"$1"));return d[s]?fb(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),!c.pop()}}),has:fb(function(a){return function(b){return db(a,b).length>0}}),contains:fb(function(a){return function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:fb(function(a){return U.test(a||"")||db.error("unsupported lang: "+a),a=a.replace(ab,bb).toLowerCase(),function(b){var c;do if(c=n?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===m},focus:function(a){return a===l.activeElement&&(!l.hasFocus||l.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return X.test(a.nodeName)},input:function(a){return W.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:lb(function(){return[0]}),last:lb(function(a,b){return[b-1]}),eq:lb(function(a,b,c){return[0>c?c+b:c]}),even:lb(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:lb(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:lb(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:lb(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=jb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=kb(b);function nb(){}nb.prototype=d.filters=d.pseudos,d.setFilters=new nb;function ob(a,b){var c,e,f,g,h,i,j,k=x[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=Q.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=R.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(P," ")}),h=h.slice(c.length));for(g in d.filter)!(e=V[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?db.error(a):x(a,i).slice(0)}function pb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function qb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=v++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[u,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[s]||(b[s]={}),(h=i[d])&&h[0]===u&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function rb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function sb(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function tb(a,b,c,d,e,f){return d&&!d[s]&&(d=tb(d)),e&&!e[s]&&(e=tb(e,f)),fb(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||wb(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:sb(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=sb(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?I.call(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=sb(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):G.apply(g,r)})}function ub(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],i=g||d.relative[" "],j=g?1:0,k=qb(function(a){return a===b},i,!0),l=qb(function(a){return I.call(b,a)>-1},i,!0),m=[function(a,c,d){return!g&&(d||c!==h)||((b=c).nodeType?k(a,c,d):l(a,c,d))}];f>j;j++)if(c=d.relative[a[j].type])m=[qb(rb(m),c)];else{if(c=d.filter[a[j].type].apply(null,a[j].matches),c[s]){for(e=++j;f>e;e++)if(d.relative[a[e].type])break;return tb(j>1&&rb(m),j>1&&pb(a.slice(0,j-1).concat({value:" "===a[j-2].type?"*":""})).replace(P,"$1"),c,e>j&&ub(a.slice(j,e)),f>e&&ub(a=a.slice(e)),f>e&&pb(a))}m.push(c)}return rb(m)}function vb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,i,j,k){var m,n,o,p=0,q="0",r=f&&[],s=[],t=h,v=f||e&&d.find.TAG("*",k),w=u+=null==t?1:Math.random()||.1,x=v.length;for(k&&(h=g!==l&&g);q!==x&&null!=(m=v[q]);q++){if(e&&m){n=0;while(o=a[n++])if(o(m,g,i)){j.push(m);break}k&&(u=w)}c&&((m=!o&&m)&&p--,f&&r.push(m))}if(p+=q,c&&q!==p){n=0;while(o=b[n++])o(r,s,g,i);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=E.call(j));s=sb(s)}G.apply(j,s),k&&!f&&s.length>0&&p+b.length>1&&db.uniqueSort(j)}return k&&(u=w,h=t),r};return c?fb(f):f}g=db.compile=function(a,b){var c,d=[],e=[],f=y[a+" "];if(!f){b||(b=ob(a)),c=b.length;while(c--)f=ub(b[c]),f[s]?d.push(f):e.push(f);f=y(a,vb(e,d))}return f};function wb(a,b,c){for(var d=0,e=b.length;e>d;d++)db(a,b[d],c);return c}function xb(a,b,e,f){var h,i,j,k,l,m=ob(a);if(!f&&1===m.length){if(i=m[0]=m[0].slice(0),i.length>2&&"ID"===(j=i[0]).type&&c.getById&&9===b.nodeType&&n&&d.relative[i[1].type]){if(b=(d.find.ID(j.matches[0].replace(ab,bb),b)||[])[0],!b)return e;a=a.slice(i.shift().value.length)}h=V.needsContext.test(a)?0:i.length;while(h--){if(j=i[h],d.relative[k=j.type])break;if((l=d.find[k])&&(f=l(j.matches[0].replace(ab,bb),$.test(i[0].type)&&mb(b.parentNode)||b))){if(i.splice(h,1),a=f.length&&pb(i),!a)return G.apply(e,f),e;break}}}return g(a,m)(f,b,!n,e,$.test(a)&&mb(b.parentNode)||b),e}return c.sortStable=s.split("").sort(z).join("")===s,c.detectDuplicates=!!j,k(),c.sortDetached=gb(function(a){return 1&a.compareDocumentPosition(l.createElement("div"))}),gb(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||hb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&gb(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||hb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),gb(function(a){return null==a.getAttribute("disabled")})||hb(J,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),db}(a);o.find=t,o.expr=t.selectors,o.expr[":"]=o.expr.pseudos,o.unique=t.uniqueSort,o.text=t.getText,o.isXMLDoc=t.isXML,o.contains=t.contains;var u=o.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(o.isFunction(b))return o.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return o.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return o.filter(b,a,c);b=o.filter(b,a)}return o.grep(a,function(a){return g.call(b,a)>=0!==c})}o.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?o.find.matchesSelector(d,a)?[d]:[]:o.find.matches(a,o.grep(b,function(a){return 1===a.nodeType}))},o.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(o(a).filter(function(){for(b=0;c>b;b++)if(o.contains(e[b],this))return!0}));for(b=0;c>b;b++)o.find(a,e[b],d);return d=this.pushStack(c>1?o.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?o(a):a||[],!1).length}});var y,z=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,A=o.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof o?b[0]:b,o.merge(this,o.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:m,!0)),v.test(c[1])&&o.isPlainObject(b))for(c in b)o.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}return d=m.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=m,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):o.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(o):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),o.makeArray(a,this))};A.prototype=o.fn,y=o(m);var B=/^(?:parents|prev(?:Until|All))/,C={children:!0,contents:!0,next:!0,prev:!0};o.extend({dir:function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&o(a).is(c))break;d.push(a)}return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),o.fn.extend({has:function(a){var b=o(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(o.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?o(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&o.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?o.unique(f):f)},index:function(a){return a?"string"==typeof a?g.call(o(a),this[0]):g.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(o.unique(o.merge(this.get(),o(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function D(a,b){while((a=a[b])&&1!==a.nodeType);return a}o.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return o.dir(a,"parentNode")},parentsUntil:function(a,b,c){return o.dir(a,"parentNode",c)},next:function(a){return D(a,"nextSibling")},prev:function(a){return D(a,"previousSibling")},nextAll:function(a){return o.dir(a,"nextSibling")},prevAll:function(a){return o.dir(a,"previousSibling")},nextUntil:function(a,b,c){return o.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return o.dir(a,"previousSibling",c)},siblings:function(a){return o.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return o.sibling(a.firstChild)},contents:function(a){return a.contentDocument||o.merge([],a.childNodes)}},function(a,b){o.fn[a]=function(c,d){var e=o.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=o.filter(d,e)),this.length>1&&(C[a]||o.unique(e),B.test(a)&&e.reverse()),this.pushStack(e)}});var E=/\S+/g,F={};function G(a){var b=F[a]={};return o.each(a.match(E)||[],function(a,c){b[c]=!0}),b}o.Callbacks=function(a){a="string"==typeof a?F[a]||G(a):o.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(b=a.memory&&l,c=!0,g=e||0,e=0,f=h.length,d=!0;h&&f>g;g++)if(h[g].apply(l[0],l[1])===!1&&a.stopOnFalse){b=!1;break}d=!1,h&&(i?i.length&&j(i.shift()):b?h=[]:k.disable())},k={add:function(){if(h){var c=h.length;!function g(b){o.each(b,function(b,c){var d=o.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&g(c)})}(arguments),d?f=h.length:b&&(e=c,j(b))}return this},remove:function(){return h&&o.each(arguments,function(a,b){var c;while((c=o.inArray(b,h,c))>-1)h.splice(c,1),d&&(f>=c&&f--,g>=c&&g--)}),this},has:function(a){return a?o.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],f=0,this},disable:function(){return h=i=b=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,b||k.disable(),this},locked:function(){return!i},fireWith:function(a,b){return!h||c&&!i||(b=b||[],b=[a,b.slice?b.slice():b],d?i.push(b):j(b)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!c}};return k},o.extend({Deferred:function(a){var b=[["resolve","done",o.Callbacks("once memory"),"resolved"],["reject","fail",o.Callbacks("once memory"),"rejected"],["notify","progress",o.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return o.Deferred(function(c){o.each(b,function(b,f){var g=o.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&o.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?o.extend(a,d):d}},e={};return d.pipe=d.then,o.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&o.isFunction(a.promise)?e:0,g=1===f?a:o.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&o.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var H;o.fn.ready=function(a){return o.ready.promise().done(a),this},o.extend({isReady:!1,readyWait:1,holdReady:function(a){a?o.readyWait++:o.ready(!0)},ready:function(a){(a===!0?--o.readyWait:o.isReady)||(o.isReady=!0,a!==!0&&--o.readyWait>0||(H.resolveWith(m,[o]),o.fn.trigger&&o(m).trigger("ready").off("ready")))}});function I(){m.removeEventListener("DOMContentLoaded",I,!1),a.removeEventListener("load",I,!1),o.ready()}o.ready.promise=function(b){return H||(H=o.Deferred(),"complete"===m.readyState?setTimeout(o.ready):(m.addEventListener("DOMContentLoaded",I,!1),a.addEventListener("load",I,!1))),H.promise(b)},o.ready.promise();var J=o.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===o.type(c)){e=!0;for(h in c)o.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,o.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(o(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f};o.acceptData=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function K(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=o.expando+Math.random()}K.uid=1,K.accepts=o.acceptData,K.prototype={key:function(a){if(!K.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=K.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(d){b[this.expando]=c,o.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,e=this.key(a),f=this.cache[e];if("string"==typeof b)f[b]=c;else if(o.isEmptyObject(f))o.extend(this.cache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[this.key(a)];return void 0===b?c:c[b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,o.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=this.key(a),g=this.cache[f];if(void 0===b)this.cache[f]={};else{o.isArray(b)?d=b.concat(b.map(o.camelCase)):(e=o.camelCase(b),b in g?d=[b,e]:(d=e,d=d in g?[d]:d.match(E)||[])),c=d.length;while(c--)delete g[d[c]]}},hasData:function(a){return!o.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){a[this.expando]&&delete this.cache[a[this.expando]]}};var L=new K,M=new K,N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(O,"-$1").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?o.parseJSON(c):c}catch(e){}M.set(a,b,c)}else c=void 0;return c}o.extend({hasData:function(a){return M.hasData(a)||L.hasData(a)},data:function(a,b,c){return M.access(a,b,c)},removeData:function(a,b){M.remove(a,b)},_data:function(a,b,c){return L.access(a,b,c)},_removeData:function(a,b){L.remove(a,b)}}),o.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=M.get(f),1===f.nodeType&&!L.get(f,"hasDataAttrs"))){c=g.length;
+while(c--)d=g[c].name,0===d.indexOf("data-")&&(d=o.camelCase(d.slice(5)),P(f,d,e[d]));L.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){M.set(this,a)}):J(this,function(b){var c,d=o.camelCase(a);if(f&&void 0===b){if(c=M.get(f,a),void 0!==c)return c;if(c=M.get(f,d),void 0!==c)return c;if(c=P(f,d,void 0),void 0!==c)return c}else this.each(function(){var c=M.get(this,d);M.set(this,d,b),-1!==a.indexOf("-")&&void 0!==c&&M.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){M.remove(this,a)})}}),o.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=L.get(a,b),c&&(!d||o.isArray(c)?d=L.access(a,b,o.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=o.queue(a,b),d=c.length,e=c.shift(),f=o._queueHooks(a,b),g=function(){o.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return L.get(a,c)||L.access(a,c,{empty:o.Callbacks("once memory").add(function(){L.remove(a,[b+"queue",c])})})}}),o.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?o.queue(this[0],a):void 0===b?this:this.each(function(){var c=o.queue(this,a,b);o._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&o.dequeue(this,a)})},dequeue:function(a){return this.each(function(){o.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=o.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=L.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=["Top","Right","Bottom","Left"],S=function(a,b){return a=b||a,"none"===o.css(a,"display")||!o.contains(a.ownerDocument,a)},T=/^(?:checkbox|radio)$/i;!function(){var a=m.createDocumentFragment(),b=a.appendChild(m.createElement("div"));b.innerHTML="<input type='radio' checked='checked' name='t'/>",l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var U="undefined";l.focusinBubbles="onfocusin"in a;var V=/^key/,W=/^(?:mouse|contextmenu)|click/,X=/^(?:focusinfocus|focusoutblur)$/,Y=/^([^.]*)(?:\.(.+)|)$/;function Z(){return!0}function $(){return!1}function _(){try{return m.activeElement}catch(a){}}o.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,p,q,r=L.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=o.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return typeof o!==U&&o.event.triggered!==b.type?o.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(E)||[""],j=b.length;while(j--)h=Y.exec(b[j])||[],n=q=h[1],p=(h[2]||"").split(".").sort(),n&&(l=o.event.special[n]||{},n=(e?l.delegateType:l.bindType)||n,l=o.event.special[n]||{},k=o.extend({type:n,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&o.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[n])||(m=i[n]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(n,g,!1)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),o.event.global[n]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,p,q,r=L.hasData(a)&&L.get(a);if(r&&(i=r.events)){b=(b||"").match(E)||[""],j=b.length;while(j--)if(h=Y.exec(b[j])||[],n=q=h[1],p=(h[2]||"").split(".").sort(),n){l=o.event.special[n]||{},n=(d?l.delegateType:l.bindType)||n,m=i[n]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||o.removeEvent(a,n,r.handle),delete i[n])}else for(n in i)o.event.remove(a,n+b[j],c,d,!0);o.isEmptyObject(i)&&(delete r.handle,L.remove(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,l,n,p=[d||m],q=j.call(b,"type")?b.type:b,r=j.call(b,"namespace")?b.namespace.split("."):[];if(g=h=d=d||m,3!==d.nodeType&&8!==d.nodeType&&!X.test(q+o.event.triggered)&&(q.indexOf(".")>=0&&(r=q.split("."),q=r.shift(),r.sort()),k=q.indexOf(":")<0&&"on"+q,b=b[o.expando]?b:new o.Event(q,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=r.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:o.makeArray(c,[b]),n=o.event.special[q]||{},e||!n.trigger||n.trigger.apply(d,c)!==!1)){if(!e&&!n.noBubble&&!o.isWindow(d)){for(i=n.delegateType||q,X.test(i+q)||(g=g.parentNode);g;g=g.parentNode)p.push(g),h=g;h===(d.ownerDocument||m)&&p.push(h.defaultView||h.parentWindow||a)}f=0;while((g=p[f++])&&!b.isPropagationStopped())b.type=f>1?i:n.bindType||q,l=(L.get(g,"events")||{})[b.type]&&L.get(g,"handle"),l&&l.apply(g,c),l=k&&g[k],l&&l.apply&&o.acceptData(g)&&(b.result=l.apply(g,c),b.result===!1&&b.preventDefault());return b.type=q,e||b.isDefaultPrevented()||n._default&&n._default.apply(p.pop(),c)!==!1||!o.acceptData(d)||k&&o.isFunction(d[q])&&!o.isWindow(d)&&(h=d[k],h&&(d[k]=null),o.event.triggered=q,d[q](),o.event.triggered=void 0,h&&(d[k]=h)),b.result}},dispatch:function(a){a=o.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(L.get(this,"events")||{})[a.type]||[],k=o.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=o.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(g.namespace))&&(a.handleObj=g,a.data=g.data,e=((o.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(a.result=e)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0||"click"!==a.type){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?o(e,this).index(i)>=0:o.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||m,d=c.documentElement,e=c.body,a.pageX=b.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),a.pageY=b.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},fix:function(a){if(a[o.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=W.test(e)?this.mouseHooks:V.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new o.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=m),3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,f):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==_()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===_()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&o.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return o.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=o.extend(new o.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?o.event.trigger(e,null,b):o.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},o.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)},o.Event=function(a,b){return this instanceof o.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.getPreventDefault&&a.getPreventDefault()?Z:$):this.type=a,b&&o.extend(this,b),this.timeStamp=a&&a.timeStamp||o.now(),void(this[o.expando]=!0)):new o.Event(a,b)},o.Event.prototype={isDefaultPrevented:$,isPropagationStopped:$,isImmediatePropagationStopped:$,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=Z,a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=Z,a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=Z,this.stopPropagation()}},o.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){o.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!o.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.focusinBubbles||o.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){o.event.simulate(b,a.target,o.event.fix(a),!0)};o.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=L.access(d,b);e||d.addEventListener(a,c,!0),L.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=L.access(d,b)-1;e?L.access(d,b,e):(d.removeEventListener(a,c,!0),L.remove(d,b))}}}),o.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(g in a)this.on(g,b,c,a[g],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=$;else if(!d)return this;return 1===e&&(f=d,d=function(a){return o().off(a),f.apply(this,arguments)},d.guid=f.guid||(f.guid=o.guid++)),this.each(function(){o.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,o(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=$),this.each(function(){o.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){o.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?o.event.trigger(a,b,c,!0):void 0}});var ab=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bb=/<([\w:]+)/,cb=/<|&#?\w+;/,db=/<(?:script|style|link)/i,eb=/checked\s*(?:[^=]|=\s*.checked.)/i,fb=/^$|\/(?:java|ecma)script/i,gb=/^true\/(.*)/,hb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ib={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ib.optgroup=ib.option,ib.tbody=ib.tfoot=ib.colgroup=ib.caption=ib.thead,ib.th=ib.td;function jb(a,b){return o.nodeName(a,"table")&&o.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function kb(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function lb(a){var b=gb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function mb(a,b){for(var c=0,d=a.length;d>c;c++)L.set(a[c],"globalEval",!b||L.get(b[c],"globalEval"))}function nb(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(L.hasData(a)&&(f=L.access(a),g=L.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)o.event.add(b,e,j[e][c])}M.hasData(a)&&(h=M.access(a),i=o.extend({},h),M.set(b,i))}}function ob(a,b){var c=a.getElementsByTagName?a.getElementsByTagName(b||"*"):a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&o.nodeName(a,b)?o.merge([a],c):c}function pb(a,b){var c=b.nodeName.toLowerCase();"input"===c&&T.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}o.extend({clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=o.contains(a.ownerDocument,a);if(!(l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||o.isXMLDoc(a)))for(g=ob(h),f=ob(a),d=0,e=f.length;e>d;d++)pb(f[d],g[d]);if(b)if(c)for(f=f||ob(a),g=g||ob(h),d=0,e=f.length;e>d;d++)nb(f[d],g[d]);else nb(a,h);return g=ob(h,"script"),g.length>0&&mb(g,!i&&ob(a,"script")),h},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k=b.createDocumentFragment(),l=[],m=0,n=a.length;n>m;m++)if(e=a[m],e||0===e)if("object"===o.type(e))o.merge(l,e.nodeType?[e]:e);else if(cb.test(e)){f=f||k.appendChild(b.createElement("div")),g=(bb.exec(e)||["",""])[1].toLowerCase(),h=ib[g]||ib._default,f.innerHTML=h[1]+e.replace(ab,"<$1></$2>")+h[2],j=h[0];while(j--)f=f.lastChild;o.merge(l,f.childNodes),f=k.firstChild,f.textContent=""}else l.push(b.createTextNode(e));k.textContent="",m=0;while(e=l[m++])if((!d||-1===o.inArray(e,d))&&(i=o.contains(e.ownerDocument,e),f=ob(k.appendChild(e),"script"),i&&mb(f),c)){j=0;while(e=f[j++])fb.test(e.type||"")&&c.push(e)}return k},cleanData:function(a){for(var b,c,d,e,f,g,h=o.event.special,i=0;void 0!==(c=a[i]);i++){if(o.acceptData(c)&&(f=c[L.expando],f&&(b=L.cache[f]))){if(d=Object.keys(b.events||{}),d.length)for(g=0;void 0!==(e=d[g]);g++)h[e]?o.event.remove(c,e):o.removeEvent(c,e,b.handle);L.cache[f]&&delete L.cache[f]}delete M.cache[c[M.expando]]}}}),o.fn.extend({text:function(a){return J(this,function(a){return void 0===a?o.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?o.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||o.cleanData(ob(c)),c.parentNode&&(b&&o.contains(c.ownerDocument,c)&&mb(ob(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(o.cleanData(ob(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return o.clone(this,a,b)})},html:function(a){return J(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!db.test(a)&&!ib[(bb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(ab,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(o.cleanData(ob(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,o.cleanData(ob(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,k=this.length,m=this,n=k-1,p=a[0],q=o.isFunction(p);if(q||k>1&&"string"==typeof p&&!l.checkClone&&eb.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(k&&(c=o.buildFragment(a,this[0].ownerDocument,!1,this),d=c.firstChild,1===c.childNodes.length&&(c=d),d)){for(f=o.map(ob(c,"script"),kb),g=f.length;k>j;j++)h=c,j!==n&&(h=o.clone(h,!0,!0),g&&o.merge(f,ob(h,"script"))),b.call(this[j],h,j);if(g)for(i=f[f.length-1].ownerDocument,o.map(f,lb),j=0;g>j;j++)h=f[j],fb.test(h.type||"")&&!L.access(h,"globalEval")&&o.contains(i,h)&&(h.src?o._evalUrl&&o._evalUrl(h.src):o.globalEval(h.textContent.replace(hb,"")))}return this}}),o.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){o.fn[a]=function(a){for(var c,d=[],e=o(a),g=e.length-1,h=0;g>=h;h++)c=h===g?this:this.clone(!0),o(e[h])[b](c),f.apply(d,c.get());return this.pushStack(d)}});var qb,rb={};function sb(b,c){var d=o(c.createElement(b)).appendTo(c.body),e=a.getDefaultComputedStyle?a.getDefaultComputedStyle(d[0]).display:o.css(d[0],"display");return d.detach(),e}function tb(a){var b=m,c=rb[a];return c||(c=sb(a,b),"none"!==c&&c||(qb=(qb||o("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=qb[0].contentDocument,b.write(),b.close(),c=sb(a,b),qb.detach()),rb[a]=c),c}var ub=/^margin/,vb=new RegExp("^("+Q+")(?!px)[a-z%]+$","i"),wb=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)};function xb(a,b,c){var d,e,f,g,h=a.style;return c=c||wb(a),c&&(g=c.getPropertyValue(b)||c[b]),c&&(""!==g||o.contains(a.ownerDocument,a)||(g=o.style(a,b)),vb.test(g)&&ub.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+"":g}function yb(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",e=m.documentElement,f=m.createElement("div"),g=m.createElement("div");g.style.backgroundClip="content-box",g.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===g.style.backgroundClip,f.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",f.appendChild(g);function h(){g.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",e.appendChild(f);var d=a.getComputedStyle(g,null);b="1%"!==d.top,c="4px"===d.width,e.removeChild(f)}a.getComputedStyle&&o.extend(l,{pixelPosition:function(){return h(),b},boxSizingReliable:function(){return null==c&&h(),c},reliableMarginRight:function(){var b,c=g.appendChild(m.createElement("div"));return c.style.cssText=g.style.cssText=d,c.style.marginRight=c.style.width="0",g.style.width="1px",e.appendChild(f),b=!parseFloat(a.getComputedStyle(c,null).marginRight),e.removeChild(f),g.innerHTML="",b}})}(),o.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var zb=/^(none|table(?!-c[ea]).+)/,Ab=new RegExp("^("+Q+")(.*)$","i"),Bb=new RegExp("^([+-])=("+Q+")","i"),Cb={position:"absolute",visibility:"hidden",display:"block"},Db={letterSpacing:0,fontWeight:400},Eb=["Webkit","O","Moz","ms"];function Fb(a,b){if(b in a)return b;var c=b[0].toUpperCase()+b.slice(1),d=b,e=Eb.length;while(e--)if(b=Eb[e]+c,b in a)return b;return d}function Gb(a,b,c){var d=Ab.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Hb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=o.css(a,c+R[f],!0,e)),d?("content"===c&&(g-=o.css(a,"padding"+R[f],!0,e)),"margin"!==c&&(g-=o.css(a,"border"+R[f]+"Width",!0,e))):(g+=o.css(a,"padding"+R[f],!0,e),"padding"!==c&&(g+=o.css(a,"border"+R[f]+"Width",!0,e)));return g}function Ib(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=wb(a),g="border-box"===o.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=xb(a,b,f),(0>e||null==e)&&(e=a.style[b]),vb.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Hb(a,b,c||(g?"border":"content"),d,f)+"px"}function Jb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=L.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&S(d)&&(f[g]=L.access(d,"olddisplay",tb(d.nodeName)))):f[g]||(e=S(d),(c&&"none"!==c||!e)&&L.set(d,"olddisplay",e?c:o.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}o.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=xb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=o.camelCase(b),i=a.style;return b=o.cssProps[h]||(o.cssProps[h]=Fb(i,h)),g=o.cssHooks[b]||o.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=Bb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(o.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||o.cssNumber[h]||(c+="px"),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]="",i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=o.camelCase(b);return b=o.cssProps[h]||(o.cssProps[h]=Fb(a.style,h)),g=o.cssHooks[b]||o.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=xb(a,b,d)),"normal"===e&&b in Db&&(e=Db[b]),""===c||c?(f=parseFloat(e),c===!0||o.isNumeric(f)?f||0:e):e}}),o.each(["height","width"],function(a,b){o.cssHooks[b]={get:function(a,c,d){return c?0===a.offsetWidth&&zb.test(o.css(a,"display"))?o.swap(a,Cb,function(){return Ib(a,b,d)}):Ib(a,b,d):void 0},set:function(a,c,d){var e=d&&wb(a);return Gb(a,c,d?Hb(a,b,d,"border-box"===o.css(a,"boxSizing",!1,e),e):0)}}}),o.cssHooks.marginRight=yb(l.reliableMarginRight,function(a,b){return b?o.swap(a,{display:"inline-block"},xb,[a,"marginRight"]):void 0}),o.each({margin:"",padding:"",border:"Width"},function(a,b){o.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+R[d]+b]=f[d]||f[d-2]||f[0];return e}},ub.test(a)||(o.cssHooks[a+b].set=Gb)}),o.fn.extend({css:function(a,b){return J(this,function(a,b,c){var d,e,f={},g=0;if(o.isArray(b)){for(d=wb(a),e=b.length;e>g;g++)f[b[g]]=o.css(a,b[g],!1,d);return f}return void 0!==c?o.style(a,b,c):o.css(a,b)},a,b,arguments.length>1)},show:function(){return Jb(this,!0)},hide:function(){return Jb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){S(this)?o(this).show():o(this).hide()})}});function Kb(a,b,c,d,e){return new Kb.prototype.init(a,b,c,d,e)}o.Tween=Kb,Kb.prototype={constructor:Kb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(o.cssNumber[c]?"":"px")},cur:function(){var a=Kb.propHooks[this.prop];return a&&a.get?a.get(this):Kb.propHooks._default.get(this)},run:function(a){var b,c=Kb.propHooks[this.prop];return this.pos=b=this.options.duration?o.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Kb.propHooks._default.set(this),this}},Kb.prototype.init.prototype=Kb.prototype,Kb.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=o.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){o.fx.step[a.prop]?o.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[o.cssProps[a.prop]]||o.cssHooks[a.prop])?o.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},Kb.propHooks.scrollTop=Kb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},o.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},o.fx=Kb.prototype.init,o.fx.step={};var Lb,Mb,Nb=/^(?:toggle|show|hide)$/,Ob=new RegExp("^(?:([+-])=|)("+Q+")([a-z%]*)$","i"),Pb=/queueHooks$/,Qb=[Vb],Rb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=Ob.exec(b),f=e&&e[3]||(o.cssNumber[a]?"":"px"),g=(o.cssNumber[a]||"px"!==f&&+d)&&Ob.exec(o.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,o.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function Sb(){return setTimeout(function(){Lb=void 0}),Lb=o.now()}function Tb(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=R[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ub(a,b,c){for(var d,e=(Rb[b]||[]).concat(Rb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Vb(a,b,c){var d,e,f,g,h,i,j,k=this,l={},m=a.style,n=a.nodeType&&S(a),p=L.get(a,"fxshow");c.queue||(h=o._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,k.always(function(){k.always(function(){h.unqueued--,o.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[m.overflow,m.overflowX,m.overflowY],j=o.css(a,"display"),"none"===j&&(j=tb(a.nodeName)),"inline"===j&&"none"===o.css(a,"float")&&(m.display="inline-block")),c.overflow&&(m.overflow="hidden",k.always(function(){m.overflow=c.overflow[0],m.overflowX=c.overflow[1],m.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Nb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(n?"hide":"show")){if("show"!==e||!p||void 0===p[d])continue;n=!0}l[d]=p&&p[d]||o.style(a,d)}if(!o.isEmptyObject(l)){p?"hidden"in p&&(n=p.hidden):p=L.access(a,"fxshow",{}),f&&(p.hidden=!n),n?o(a).show():k.done(function(){o(a).hide()}),k.done(function(){var b;L.remove(a,"fxshow");for(b in l)o.style(a,b,l[b])});for(d in l)g=Ub(n?p[d]:0,d,k),d in p||(p[d]=g.start,n&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function Wb(a,b){var c,d,e,f,g;for(c in a)if(d=o.camelCase(c),e=b[d],f=a[c],o.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=o.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function Xb(a,b,c){var d,e,f=0,g=Qb.length,h=o.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Lb||Sb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:o.extend({},b),opts:o.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:Lb||Sb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=o.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(Wb(k,j.opts.specialEasing);g>f;f++)if(d=Qb[f].call(j,a,k,j.opts))return d;return o.map(k,Ub,j),o.isFunction(j.opts.start)&&j.opts.start.call(a,j),o.fx.timer(o.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}o.Animation=o.extend(Xb,{tweener:function(a,b){o.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],Rb[c]=Rb[c]||[],Rb[c].unshift(b)},prefilter:function(a,b){b?Qb.unshift(a):Qb.push(a)}}),o.speed=function(a,b,c){var d=a&&"object"==typeof a?o.extend({},a):{complete:c||!c&&b||o.isFunction(a)&&a,duration:a,easing:c&&b||b&&!o.isFunction(b)&&b};return d.duration=o.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in o.fx.speeds?o.fx.speeds[d.duration]:o.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){o.isFunction(d.old)&&d.old.call(this),d.queue&&o.dequeue(this,d.queue)},d},o.fn.extend({fadeTo:function(a,b,c,d){return this.filter(S).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=o.isEmptyObject(a),f=o.speed(b,c,d),g=function(){var b=Xb(this,o.extend({},a),f);(e||L.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=o.timers,g=L.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Pb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&o.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=L.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=o.timers,g=d?d.length:0;for(c.finish=!0,o.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),o.each(["toggle","show","hide"],function(a,b){var c=o.fn[b];o.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Tb(b,!0),a,d,e)}}),o.each({slideDown:Tb("show"),slideUp:Tb("hide"),slideToggle:Tb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){o.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),o.timers=[],o.fx.tick=function(){var a,b=0,c=o.timers;for(Lb=o.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||o.fx.stop(),Lb=void 0},o.fx.timer=function(a){o.timers.push(a),a()?o.fx.start():o.timers.pop()},o.fx.interval=13,o.fx.start=function(){Mb||(Mb=setInterval(o.fx.tick,o.fx.interval))},o.fx.stop=function(){clearInterval(Mb),Mb=null},o.fx.speeds={slow:600,fast:200,_default:400},o.fn.delay=function(a,b){return a=o.fx?o.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a=m.createElement("input"),b=m.createElement("select"),c=b.appendChild(m.createElement("option"));a.type="checkbox",l.checkOn=""!==a.value,l.optSelected=c.selected,b.disabled=!0,l.optDisabled=!c.disabled,a=m.createElement("input"),a.value="t",a.type="radio",l.radioValue="t"===a.value}();var Yb,Zb,$b=o.expr.attrHandle;o.fn.extend({attr:function(a,b){return J(this,o.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){o.removeAttr(this,a)})}}),o.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===U?o.prop(a,b,c):(1===f&&o.isXMLDoc(a)||(b=b.toLowerCase(),d=o.attrHooks[b]||(o.expr.match.bool.test(b)?Zb:Yb)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=o.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void o.removeAttr(a,b))},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(E);if(f&&1===a.nodeType)while(c=f[e++])d=o.propFix[c]||c,o.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&o.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),Zb={set:function(a,b,c){return b===!1?o.removeAttr(a,c):a.setAttribute(c,c),c}},o.each(o.expr.match.bool.source.match(/\w+/g),function(a,b){var c=$b[b]||o.find.attr;$b[b]=function(a,b,d){var e,f;
+return d||(f=$b[b],$b[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,$b[b]=f),e}});var _b=/^(?:input|select|textarea|button)$/i;o.fn.extend({prop:function(a,b){return J(this,o.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[o.propFix[a]||a]})}}),o.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!o.isXMLDoc(a),f&&(b=o.propFix[b]||b,e=o.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||_b.test(a.nodeName)||a.href?a.tabIndex:-1}}}}),l.optSelected||(o.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),o.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){o.propFix[this.toLowerCase()]=this});var ac=/[\t\r\n\f]/g;o.fn.extend({addClass:function(a){var b,c,d,e,f,g,h="string"==typeof a&&a,i=0,j=this.length;if(o.isFunction(a))return this.each(function(b){o(this).addClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=o.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0===arguments.length||"string"==typeof a&&a,i=0,j=this.length;if(o.isFunction(a))return this.each(function(b){o(this).removeClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?o.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(o.isFunction(a)?function(c){o(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=o(this),f=a.match(E)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===U||"boolean"===c)&&(this.className&&L.set(this,"__className__",this.className),this.className=this.className||a===!1?"":L.get(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(ac," ").indexOf(b)>=0)return!0;return!1}});var bc=/\r/g;o.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=o.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,o(this).val()):a,null==e?e="":"number"==typeof e?e+="":o.isArray(e)&&(e=o.map(e,function(a){return null==a?"":a+""})),b=o.valHooks[this.type]||o.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=o.valHooks[e.type]||o.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(bc,""):null==c?"":c)}}}),o.extend({valHooks:{select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(l.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&o.nodeName(c.parentNode,"optgroup"))){if(b=o(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=o.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=o.inArray(o(d).val(),f)>=0)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),o.each(["radio","checkbox"],function(){o.valHooks[this]={set:function(a,b){return o.isArray(b)?a.checked=o.inArray(o(a).val(),b)>=0:void 0}},l.checkOn||(o.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})}),o.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){o.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),o.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var cc=o.now(),dc=/\?/;o.parseJSON=function(a){return JSON.parse(a+"")},o.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&o.error("Invalid XML: "+a),b};var ec,fc,gc=/#.*$/,hc=/([?&])_=[^&]*/,ic=/^(.*?):[ \t]*([^\r\n]*)$/gm,jc=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,kc=/^(?:GET|HEAD)$/,lc=/^\/\//,mc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,nc={},oc={},pc="*/".concat("*");try{fc=location.href}catch(qc){fc=m.createElement("a"),fc.href="",fc=fc.href}ec=mc.exec(fc.toLowerCase())||[];function rc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(E)||[];if(o.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function sc(a,b,c,d){var e={},f=a===oc;function g(h){var i;return e[h]=!0,o.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function tc(a,b){var c,d,e=o.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&o.extend(!0,a,d),a}function uc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function vc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}o.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:fc,type:"GET",isLocal:jc.test(ec[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":pc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":o.parseJSON,"text xml":o.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?tc(tc(a,o.ajaxSettings),b):tc(o.ajaxSettings,a)},ajaxPrefilter:rc(nc),ajaxTransport:rc(oc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=o.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?o(l):o.event,n=o.Deferred(),p=o.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!f){f={};while(b=ic.exec(e))f[b[1].toLowerCase()]=b[2]}b=f[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?e:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return c&&c.abort(b),x(0,b),this}};if(n.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||fc)+"").replace(gc,"").replace(lc,ec[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=o.trim(k.dataType||"*").toLowerCase().match(E)||[""],null==k.crossDomain&&(h=mc.exec(k.url.toLowerCase()),k.crossDomain=!(!h||h[1]===ec[1]&&h[2]===ec[2]&&(h[3]||("http:"===h[1]?"80":"443"))===(ec[3]||("http:"===ec[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=o.param(k.data,k.traditional)),sc(nc,k,b,v),2===t)return v;i=k.global,i&&0===o.active++&&o.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!kc.test(k.type),d=k.url,k.hasContent||(k.data&&(d=k.url+=(dc.test(d)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=hc.test(d)?d.replace(hc,"$1_="+cc++):d+(dc.test(d)?"&":"?")+"_="+cc++)),k.ifModified&&(o.lastModified[d]&&v.setRequestHeader("If-Modified-Since",o.lastModified[d]),o.etag[d]&&v.setRequestHeader("If-None-Match",o.etag[d])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+pc+"; q=0.01":""):k.accepts["*"]);for(j in k.headers)v.setRequestHeader(j,k.headers[j]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(j in{success:1,error:1,complete:1})v[j](k[j]);if(c=sc(oc,k,b,v)){v.readyState=1,i&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,c.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,f,h){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),c=void 0,e=h||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,f&&(u=uc(k,v,f)),u=vc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(o.lastModified[d]=w),w=v.getResponseHeader("etag"),w&&(o.etag[d]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?n.resolveWith(l,[r,x,v]):n.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,i&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),i&&(m.trigger("ajaxComplete",[v,k]),--o.active||o.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return o.get(a,b,c,"json")},getScript:function(a,b){return o.get(a,void 0,b,"script")}}),o.each(["get","post"],function(a,b){o[b]=function(a,c,d,e){return o.isFunction(c)&&(e=e||d,d=c,c=void 0),o.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),o.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){o.fn[b]=function(a){return this.on(b,a)}}),o._evalUrl=function(a){return o.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},o.fn.extend({wrapAll:function(a){var b;return o.isFunction(a)?this.each(function(b){o(this).wrapAll(a.call(this,b))}):(this[0]&&(b=o(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return this.each(o.isFunction(a)?function(b){o(this).wrapInner(a.call(this,b))}:function(){var b=o(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=o.isFunction(a);return this.each(function(c){o(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){o.nodeName(this,"body")||o(this).replaceWith(this.childNodes)}).end()}}),o.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0},o.expr.filters.visible=function(a){return!o.expr.filters.hidden(a)};var wc=/%20/g,xc=/\[\]$/,yc=/\r?\n/g,zc=/^(?:submit|button|image|reset|file)$/i,Ac=/^(?:input|select|textarea|keygen)/i;function Bc(a,b,c,d){var e;if(o.isArray(b))o.each(b,function(b,e){c||xc.test(a)?d(a,e):Bc(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==o.type(b))d(a,b);else for(e in b)Bc(a+"["+e+"]",b[e],c,d)}o.param=function(a,b){var c,d=[],e=function(a,b){b=o.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=o.ajaxSettings&&o.ajaxSettings.traditional),o.isArray(a)||a.jquery&&!o.isPlainObject(a))o.each(a,function(){e(this.name,this.value)});else for(c in a)Bc(c,a[c],b,e);return d.join("&").replace(wc,"+")},o.fn.extend({serialize:function(){return o.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=o.prop(this,"elements");return a?o.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!o(this).is(":disabled")&&Ac.test(this.nodeName)&&!zc.test(a)&&(this.checked||!T.test(a))}).map(function(a,b){var c=o(this).val();return null==c?null:o.isArray(c)?o.map(c,function(a){return{name:b.name,value:a.replace(yc,"\r\n")}}):{name:b.name,value:c.replace(yc,"\r\n")}}).get()}}),o.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var Cc=0,Dc={},Ec={0:200,1223:204},Fc=o.ajaxSettings.xhr();a.ActiveXObject&&o(a).on("unload",function(){for(var a in Dc)Dc[a]()}),l.cors=!!Fc&&"withCredentials"in Fc,l.ajax=Fc=!!Fc,o.ajaxTransport(function(a){var b;return l.cors||Fc&&!a.crossDomain?{send:function(c,d){var e,f=a.xhr(),g=++Cc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)f.setRequestHeader(e,c[e]);b=function(a){return function(){b&&(delete Dc[g],b=f.onload=f.onerror=null,"abort"===a?f.abort():"error"===a?d(f.status,f.statusText):d(Ec[f.status]||f.status,f.statusText,"string"==typeof f.responseText?{text:f.responseText}:void 0,f.getAllResponseHeaders()))}},f.onload=b(),f.onerror=b("error"),b=Dc[g]=b("abort"),f.send(a.hasContent&&a.data||null)},abort:function(){b&&b()}}:void 0}),o.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return o.globalEval(a),a}}}),o.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),o.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=o("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&e("error"===a.type?404:200,a.type)}),m.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Gc=[],Hc=/(=)\?(?=&|$)|\?\?/;o.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Gc.pop()||o.expando+"_"+cc++;return this[a]=!0,a}}),o.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Hc.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Hc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=o.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Hc,"$1"+e):b.jsonp!==!1&&(b.url+=(dc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||o.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Gc.push(e)),g&&o.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),o.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||m;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=o.buildFragment([a],b,e),e&&e.length&&o(e).remove(),o.merge([],d.childNodes))};var Ic=o.fn.load;o.fn.load=function(a,b,c){if("string"!=typeof a&&Ic)return Ic.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=a.slice(h),a=a.slice(0,h)),o.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&o.ajax({url:a,type:e,dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?o("<div>").append(o.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,f||[a.responseText,b,a])}),this},o.expr.filters.animated=function(a){return o.grep(o.timers,function(b){return a===b.elem}).length};var Jc=a.document.documentElement;function Kc(a){return o.isWindow(a)?a:9===a.nodeType&&a.defaultView}o.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=o.css(a,"position"),l=o(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=o.css(a,"top"),i=o.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),o.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},o.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){o.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,o.contains(b,d)?(typeof d.getBoundingClientRect!==U&&(e=d.getBoundingClientRect()),c=Kc(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===o.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),o.nodeName(a[0],"html")||(d=a.offset()),d.top+=o.css(a[0],"borderTopWidth",!0),d.left+=o.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-o.css(c,"marginTop",!0),left:b.left-d.left-o.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||Jc;while(a&&!o.nodeName(a,"html")&&"static"===o.css(a,"position"))a=a.offsetParent;return a||Jc})}}),o.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(b,c){var d="pageYOffset"===c;o.fn[b]=function(e){return J(this,function(b,e,f){var g=Kc(b);return void 0===f?g?g[c]:b[e]:void(g?g.scrollTo(d?a.pageXOffset:f,d?f:a.pageYOffset):b[e]=f)},b,e,arguments.length,null)}}),o.each(["top","left"],function(a,b){o.cssHooks[b]=yb(l.pixelPosition,function(a,c){return c?(c=xb(a,b),vb.test(c)?o(a).position()[b]+"px":c):void 0})}),o.each({Height:"height",Width:"width"},function(a,b){o.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){o.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return J(this,function(b,c,d){var e;return o.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?o.css(b,c,g):o.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),o.fn.size=function(){return this.length},o.fn.andSelf=o.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return o});var Lc=a.jQuery,Mc=a.$;return o.noConflict=function(b){return a.$===o&&(a.$=Mc),b&&a.jQuery===o&&(a.jQuery=Lc),o},typeof b===U&&(a.jQuery=a.$=o),o});
diff --git a/web/src/main/webapp/js/jquery.autocomplete.js b/web/src/main/webapp/js/jquery.autocomplete.js
index 908634f8c2..9dde944ab9 100644
--- a/web/src/main/webapp/js/jquery.autocomplete.js
+++ b/web/src/main/webapp/js/jquery.autocomplete.js
@@ -65,9 +65,6 @@
                 params: {},
                 formatResult: Autocomplete.formatResult,
                 onPreSelect: noop,
-                interceptData: function(params) {return params},
-                customDiv: '',
-                addDivToItem: function(suggestion) {return ''},
                 delimiter: null,
                 zIndex: 9999,
                 type: 'GET',
@@ -157,7 +154,7 @@
             if (options.width !== 'auto') {
                 container.width(options.width);
             }
-            
+
             // special on() plugin code for 'autocomplete'
             // http://api.jquery.com/on/#on-events-selector-data
             // Listen for mouse over event on suggestions list:
@@ -224,11 +221,7 @@
                 'z-index': options.zIndex
             });
         },
-        forceSuggest: function (val) {
-            var that = this;
-            that.currentValue=val;
-            that.getSuggestions(val);
-        },
+
         clearCache: function () {
             this.cachedResponse = {};
             this.badQueries = [];
@@ -483,12 +476,11 @@
                 that = this,
                 options = that.options,
                 serviceUrl = options.serviceUrl,
-                data = null,
+                data,
                 cacheKey;
 
             options.params[options.paramName] = q;
-            if(!options.ignoreParams)
-                data = options.interceptData(options.params);
+            data = options.ignoreParams ? null : options.params;
 
             if (that.isLocal) {
                 response = that.getSuggestionsLocal(q);
@@ -574,12 +566,8 @@
 
             // Build suggestions inner HTML:
             $.each(that.suggestions, function (i, suggestion) {
-                html += '<div class="' + className + '" data-index="' + i + '">' + formatResult(suggestion, value);
-                html += that.options.addDivToItem(suggestion);
-                html += '</div>';
+                html += '<div class="' + className + '" data-index="' + i + '">' + formatResult(suggestion, value) + '</div>';
             });
-            
-            html += that.options.customDiv;
 
             // If width is auto, adjust width before displaying suggestions,
             // because if instance was created before input had width, it will be zero.
@@ -686,10 +674,10 @@
             if(that.selectedIndex === index)
                 return null;
             
-            container.children('.' + selected).removeClass(selected);            
-            
+            container.children('.' + selected).removeClass(selected);
+
             that.selectedIndex = index;
-            
+
             if (that.selectedIndex !== -1 && children.length > that.selectedIndex) {
                 activeItem = children.get(that.selectedIndex);
                 $(activeItem).addClass(selected);
diff --git a/web/src/main/webapp/js/jquery.history.js b/web/src/main/webapp/js/jquery.history.js
index caeb7aa4b5..d16813e34f 100644
--- a/web/src/main/webapp/js/jquery.history.js
+++ b/web/src/main/webapp/js/jquery.history.js
@@ -1 +1 @@
-(function(e,t){"use strict";var n=e.History=e.History||{},r=e.jQuery;if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");n.Adapter={bind:function(e,t,n){r(e).bind(t,n)},trigger:function(e,t,n){r(e).trigger(t,n)},extractEventData:function(e,n,r){var i=n&&n.originalEvent&&n.originalEvent[e]||r&&r[e]||t;return i},onDomLoad:function(e){r(e)}},typeof n.init!="undefined"&&n.init()})(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=e.sessionStorage||!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window)
\ No newline at end of file
+(function(e,t){"use strict";var n=e.History=e.History||{},r=e.jQuery;if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");n.Adapter={bind:function(e,t,n){r(e).bind(t,n)},trigger:function(e,t,n){r(e).trigger(t,n)},extractEventData:function(e,n,r){var i=n&&n.originalEvent&&n.originalEvent[e]||r&&r[e]||t;return i},onDomLoad:function(e){r(e)}},typeof n.init!="undefined"&&n.init()})(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s=e.sessionStorage,s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window)
\ No newline at end of file
diff --git a/web/src/main/webapp/js/leaflet.js b/web/src/main/webapp/js/leaflet.js
index 1d4c6e5450..e7d2be1cc9 100644
--- a/web/src/main/webapp/js/leaflet.js
+++ b/web/src/main/webapp/js/leaflet.js
@@ -3,7 +3,7 @@
  (c) 2010-2013, Vladimir Agafonkin
  (c) 2010-2011, CloudMade
 */
-!function(t,e,i){var n=t.L,o={};o.version="0.6.4","object"==typeof module&&"object"==typeof module.exports?module.exports=o:"function"==typeof define&&define.amd&&define(o),o.noConflict=function(){return t.L=n,this},t.L=o,o.Util={extend:function(t){var e,i,n,o,s=Array.prototype.slice.call(arguments,1);for(i=0,n=s.length;n>i;i++){o=s[i]||{};for(e in o)o.hasOwnProperty(e)&&(t[e]=o[e])}return t},bind:function(t,e){var i=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(e,i||arguments)}},stamp:function(){var t=0,e="_leaflet_id";return function(i){return i[e]=i[e]||++t,i[e]}}(),invokeEach:function(t,e,i){var n,o;if("object"==typeof t){o=Array.prototype.slice.call(arguments,3);for(n in t)e.apply(i,[n,t[n]].concat(o));return!0}return!1},limitExecByInterval:function(t,e,i){var n,o;return function s(){var a=arguments;return n?(o=!0,void 0):(n=!0,setTimeout(function(){n=!1,o&&(s.apply(i,a),o=!1)},e),t.apply(i,a),void 0)}},falseFn:function(){return!1},formatNum:function(t,e){var i=Math.pow(10,e||5);return Math.round(t*i)/i},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return o.Util.trim(t).split(/\s+/)},setOptions:function(t,e){return t.options=o.extend({},t.options,e),t.options},getParamString:function(t,e,i){var n=[];for(var o in t)n.push(encodeURIComponent(i?o.toUpperCase():o)+"="+encodeURIComponent(t[o]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")},template:function(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,n){var o=e[n];if(o===i)throw new Error("No value provided for variable "+t);return"function"==typeof o&&(o=o(e)),o})},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function e(e){var i,n,o=["webkit","moz","o","ms"];for(i=0;i<o.length&&!n;i++)n=t[o[i]+e];return n}function i(e){var i=+new Date,o=Math.max(0,16-(i-n));return n=i+o,t.setTimeout(e,o)}var n=0,s=t.requestAnimationFrame||e("RequestAnimationFrame")||i,a=t.cancelAnimationFrame||e("CancelAnimationFrame")||e("CancelRequestAnimationFrame")||function(e){t.clearTimeout(e)};o.Util.requestAnimFrame=function(e,n,a,r){return e=o.bind(e,n),a&&s===i?(e(),void 0):s.call(t,e,r)},o.Util.cancelAnimFrame=function(e){e&&a.call(t,e)}}(),o.extend=o.Util.extend,o.bind=o.Util.bind,o.stamp=o.Util.stamp,o.setOptions=o.Util.setOptions,o.Class=function(){},o.Class.extend=function(t){var e=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},i=function(){};i.prototype=this.prototype;var n=new i;n.constructor=e,e.prototype=n;for(var s in this)this.hasOwnProperty(s)&&"prototype"!==s&&(e[s]=this[s]);t.statics&&(o.extend(e,t.statics),delete t.statics),t.includes&&(o.Util.extend.apply(null,[n].concat(t.includes)),delete t.includes),t.options&&n.options&&(t.options=o.extend({},n.options,t.options)),o.extend(n,t),n._initHooks=[];var a=this;return e.__super__=a.prototype,n.callInitHooks=function(){if(!this._initHooksCalled){a.prototype.callInitHooks&&a.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=n._initHooks.length;e>t;t++)n._initHooks[t].call(this)}},e},o.Class.include=function(t){o.extend(this.prototype,t)},o.Class.mergeOptions=function(t){o.extend(this.prototype.options,t)},o.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i)};var s="_leaflet_events";o.Mixin={},o.Mixin.Events={addEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addEventListener,this,e,i))return this;var n,a,r,h,l,u,c,d=this[s]=this[s]||{},p=i&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,a=t.length;a>n;n++)r={action:e,context:i||this},h=t[n],i?(l=h+"_idx",u=l+"_len",c=d[l]=d[l]||{},c[p]||(c[p]=[],d[u]=(d[u]||0)+1),c[p].push(r)):(d[h]=d[h]||[],d[h].push(r));return this},hasEventListeners:function(t){var e=this[s];return!!e&&(t in e&&e[t].length>0||t+"_idx"in e&&e[t+"_idx_len"]>0)},removeEventListener:function(t,e,i){if(!this[s])return this;if(!t)return this.clearAllEventListeners();if(o.Util.invokeEach(t,this.removeEventListener,this,e,i))return this;var n,a,r,h,l,u,c,d,p,_=this[s],m=i&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,a=t.length;a>n;n++)if(r=t[n],u=r+"_idx",c=u+"_len",d=_[u],e){if(h=i&&d?d[m]:_[r]){for(l=h.length-1;l>=0;l--)h[l].action!==e||i&&h[l].context!==i||(p=h.splice(l,1),p[0].action=o.Util.falseFn);i&&d&&0===h.length&&(delete d[m],_[c]--)}}else delete _[r],delete _[u];return this},clearAllEventListeners:function(){return delete this[s],this},fireEvent:function(t,e){if(!this.hasEventListeners(t))return this;var i,n,a,r,h,l=o.Util.extend({},e,{type:t,target:this}),u=this[s];if(u[t])for(i=u[t].slice(),n=0,a=i.length;a>n;n++)i[n].action.call(i[n].context||this,l);r=u[t+"_idx"];for(h in r)if(i=r[h].slice())for(n=0,a=i.length;a>n;n++)i[n].action.call(i[n].context||this,l);return this},addOneTimeEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addOneTimeEventListener,this,e,i))return this;var n=o.bind(function(){this.removeEventListener(t,e,i).removeEventListener(t,n,i)},this);return this.addEventListener(t,e,i).addEventListener(t,n,i)}},o.Mixin.Events.on=o.Mixin.Events.addEventListener,o.Mixin.Events.off=o.Mixin.Events.removeEventListener,o.Mixin.Events.once=o.Mixin.Events.addOneTimeEventListener,o.Mixin.Events.fire=o.Mixin.Events.fireEvent,function(){var n=!!t.ActiveXObject,s=n&&!t.XMLHttpRequest,a=n&&!e.querySelector,r=n&&!e.addEventListener,h=navigator.userAgent.toLowerCase(),l=-1!==h.indexOf("webkit"),u=-1!==h.indexOf("chrome"),c=-1!==h.indexOf("phantom"),d=-1!==h.indexOf("android"),p=-1!==h.search("android [23]"),_=typeof orientation!=i+"",m=t.navigator&&t.navigator.msPointerEnabled&&t.navigator.msMaxTouchPoints,f="devicePixelRatio"in t&&t.devicePixelRatio>1||"matchMedia"in t&&t.matchMedia("(min-resolution:144dpi)")&&t.matchMedia("(min-resolution:144dpi)").matches,g=e.documentElement,v=n&&"transition"in g.style,y="WebKitCSSMatrix"in t&&"m11"in new t.WebKitCSSMatrix,L="MozPerspective"in g.style,P="OTransition"in g.style,x=!t.L_DISABLE_3D&&(v||y||L||P)&&!c,w=!t.L_NO_TOUCH&&!c&&function(){var t="ontouchstart";if(m||t in g)return!0;var i=e.createElement("div"),n=!1;return i.setAttribute?(i.setAttribute(t,"return;"),"function"==typeof i[t]&&(n=!0),i.removeAttribute(t),i=null,n):!1}();o.Browser={ie:n,ie6:s,ie7:a,ielt9:r,webkit:l,android:d,android23:p,chrome:u,ie3d:v,webkit3d:y,gecko3d:L,opera3d:P,any3d:x,mobile:_,mobileWebkit:_&&l,mobileWebkit3d:_&&y,mobileOpera:_&&t.opera,touch:w,msTouch:m,retina:f}}(),o.Point=function(t,e,i){this.x=i?Math.round(t):t,this.y=i?Math.round(e):e},o.Point.prototype={clone:function(){return new o.Point(this.x,this.y)},add:function(t){return this.clone()._add(o.point(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(o.point(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},distanceTo:function(t){t=o.point(t);var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},equals:function(t){return t=o.point(t),t.x===this.x&&t.y===this.y},contains:function(t){return t=o.point(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+o.Util.formatNum(this.x)+", "+o.Util.formatNum(this.y)+")"}},o.point=function(t,e,n){return t instanceof o.Point?t:o.Util.isArray(t)?new o.Point(t[0],t[1]):t===i||null===t?t:new o.Point(t,e,n)},o.Bounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.Bounds.prototype={extend:function(t){return t=o.point(t),this.min||this.max?(this.min.x=Math.min(t.x,this.min.x),this.max.x=Math.max(t.x,this.max.x),this.min.y=Math.min(t.y,this.min.y),this.max.y=Math.max(t.y,this.max.y)):(this.min=t.clone(),this.max=t.clone()),this},getCenter:function(t){return new o.Point((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return new o.Point(this.min.x,this.max.y)},getTopRight:function(){return new o.Point(this.max.x,this.min.y)},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,i;return t="number"==typeof t[0]||t instanceof o.Point?o.point(t):o.bounds(t),t instanceof o.Bounds?(e=t.min,i=t.max):e=i=t,e.x>=this.min.x&&i.x<=this.max.x&&e.y>=this.min.y&&i.y<=this.max.y},intersects:function(t){t=o.bounds(t);var e=this.min,i=this.max,n=t.min,s=t.max,a=s.x>=e.x&&n.x<=i.x,r=s.y>=e.y&&n.y<=i.y;return a&&r},isValid:function(){return!(!this.min||!this.max)}},o.bounds=function(t,e){return!t||t instanceof o.Bounds?t:new o.Bounds(t,e)},o.Transformation=function(t,e,i,n){this._a=t,this._b=e,this._c=i,this._d=n},o.Transformation.prototype={transform:function(t,e){return this._transform(t.clone(),e)},_transform:function(t,e){return e=e||1,t.x=e*(this._a*t.x+this._b),t.y=e*(this._c*t.y+this._d),t},untransform:function(t,e){return e=e||1,new o.Point((t.x/e-this._b)/this._a,(t.y/e-this._d)/this._c)}},o.DomUtil={get:function(t){return"string"==typeof t?e.getElementById(t):t},getStyle:function(t,i){var n=t.style[i];if(!n&&t.currentStyle&&(n=t.currentStyle[i]),(!n||"auto"===n)&&e.defaultView){var o=e.defaultView.getComputedStyle(t,null);n=o?o[i]:null}return"auto"===n?null:n},getViewportOffset:function(t){var i,n=0,s=0,a=t,r=e.body,h=e.documentElement,l=o.Browser.ie7;do{if(n+=a.offsetTop||0,s+=a.offsetLeft||0,n+=parseInt(o.DomUtil.getStyle(a,"borderTopWidth"),10)||0,s+=parseInt(o.DomUtil.getStyle(a,"borderLeftWidth"),10)||0,i=o.DomUtil.getStyle(a,"position"),a.offsetParent===r&&"absolute"===i)break;if("fixed"===i){n+=r.scrollTop||h.scrollTop||0,s+=r.scrollLeft||h.scrollLeft||0;break}if("relative"===i&&!a.offsetLeft){var u=o.DomUtil.getStyle(a,"width"),c=o.DomUtil.getStyle(a,"max-width"),d=a.getBoundingClientRect();("none"!==u||"none"!==c)&&(s+=d.left+a.clientLeft),n+=d.top+(r.scrollTop||h.scrollTop||0);break}a=a.offsetParent}while(a);a=t;do{if(a===r)break;n-=a.scrollTop||0,s-=a.scrollLeft||0,o.DomUtil.documentIsLtr()||!o.Browser.webkit&&!l||(s+=a.scrollWidth-a.clientWidth,l&&"hidden"!==o.DomUtil.getStyle(a,"overflow-y")&&"hidden"!==o.DomUtil.getStyle(a,"overflow")&&(s+=17)),a=a.parentNode}while(a);return new o.Point(s,n)},documentIsLtr:function(){return o.DomUtil._docIsLtrCached||(o.DomUtil._docIsLtrCached=!0,o.DomUtil._docIsLtr="ltr"===o.DomUtil.getStyle(e.body,"direction")),o.DomUtil._docIsLtr},create:function(t,i,n){var o=e.createElement(t);return o.className=i,n&&n.appendChild(o),o},hasClass:function(t,e){return t.className.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(t.className)},addClass:function(t,e){o.DomUtil.hasClass(t,e)||(t.className+=(t.className?" ":"")+e)},removeClass:function(t,e){t.className=o.Util.trim((" "+t.className+" ").replace(" "+e+" "," "))},setOpacity:function(t,e){if("opacity"in t.style)t.style.opacity=e;else if("filter"in t.style){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(o){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"}},testProp:function(t){for(var i=e.documentElement.style,n=0;n<t.length;n++)if(t[n]in i)return t[n];return!1},getTranslateString:function(t){var e=o.Browser.webkit3d,i="translate"+(e?"3d":"")+"(",n=(e?",0":"")+")";return i+t.x+"px,"+t.y+"px"+n},getScaleString:function(t,e){var i=o.DomUtil.getTranslateString(e.add(e.multiplyBy(-1*t))),n=" scale("+t+") ";return i+n},setPosition:function(t,e,i){t._leaflet_pos=e,!i&&o.Browser.any3d?(t.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(e),o.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden")):(t.style.left=e.x+"px",t.style.top=e.y+"px")},getPosition:function(t){return t._leaflet_pos}},o.DomUtil.TRANSFORM=o.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),o.DomUtil.TRANSITION=o.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),o.DomUtil.TRANSITION_END="webkitTransition"===o.DomUtil.TRANSITION||"OTransition"===o.DomUtil.TRANSITION?o.DomUtil.TRANSITION+"End":"transitionend",function(){var i=o.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);o.extend(o.DomUtil,{disableTextSelection:function(){if(o.DomEvent.on(t,"selectstart",o.DomEvent.preventDefault),i){var n=e.documentElement.style;this._userSelect=n[i],n[i]="none"}},enableTextSelection:function(){o.DomEvent.off(t,"selectstart",o.DomEvent.preventDefault),i&&(e.documentElement.style[i]=this._userSelect,delete this._userSelect)},disableImageDrag:function(){o.DomEvent.on(t,"dragstart",o.DomEvent.preventDefault)},enableImageDrag:function(){o.DomEvent.off(t,"dragstart",o.DomEvent.preventDefault)}})}(),o.LatLng=function(t,e){var i=parseFloat(t),n=parseFloat(e);if(isNaN(i)||isNaN(n))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=i,this.lng=n},o.extend(o.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),o.LatLng.prototype={equals:function(t){if(!t)return!1;t=o.latLng(t);var e=Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng));return e<=o.LatLng.MAX_MARGIN},toString:function(t){return"LatLng("+o.Util.formatNum(this.lat,t)+", "+o.Util.formatNum(this.lng,t)+")"},distanceTo:function(t){t=o.latLng(t);var e=6378137,i=o.LatLng.DEG_TO_RAD,n=(t.lat-this.lat)*i,s=(t.lng-this.lng)*i,a=this.lat*i,r=t.lat*i,h=Math.sin(n/2),l=Math.sin(s/2),u=h*h+l*l*Math.cos(a)*Math.cos(r);return 2*e*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))},wrap:function(t,e){var i=this.lng;return t=t||-180,e=e||180,i=(i+e)%(e-t)+(t>i||i===e?e:t),new o.LatLng(this.lat,i)}},o.latLng=function(t,e){return t instanceof o.LatLng?t:o.Util.isArray(t)?new o.LatLng(t[0],t[1]):t===i||null===t?t:"object"==typeof t&&"lat"in t?new o.LatLng(t.lat,"lng"in t?t.lng:t.lon):new o.LatLng(t,e)},o.LatLngBounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.LatLngBounds.prototype={extend:function(t){return t?(t="number"==typeof t[0]||"string"==typeof t[0]||t instanceof o.LatLng?o.latLng(t):o.latLngBounds(t),t instanceof o.LatLng?this._southWest||this._northEast?(this._southWest.lat=Math.min(t.lat,this._southWest.lat),this._southWest.lng=Math.min(t.lng,this._southWest.lng),this._northEast.lat=Math.max(t.lat,this._northEast.lat),this._northEast.lng=Math.max(t.lng,this._northEast.lng)):(this._southWest=new o.LatLng(t.lat,t.lng),this._northEast=new o.LatLng(t.lat,t.lng)):t instanceof o.LatLngBounds&&(this.extend(t._southWest),this.extend(t._northEast)),this):this},pad:function(t){var e=this._southWest,i=this._northEast,n=Math.abs(e.lat-i.lat)*t,s=Math.abs(e.lng-i.lng)*t;return new o.LatLngBounds(new o.LatLng(e.lat-n,e.lng-s),new o.LatLng(i.lat+n,i.lng+s))},getCenter:function(){return new o.LatLng((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new o.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new o.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof o.LatLng?o.latLng(t):o.latLngBounds(t);var e,i,n=this._southWest,s=this._northEast;return t instanceof o.LatLngBounds?(e=t.getSouthWest(),i=t.getNorthEast()):e=i=t,e.lat>=n.lat&&i.lat<=s.lat&&e.lng>=n.lng&&i.lng<=s.lng},intersects:function(t){t=o.latLngBounds(t);var e=this._southWest,i=this._northEast,n=t.getSouthWest(),s=t.getNorthEast(),a=s.lat>=e.lat&&n.lat<=i.lat,r=s.lng>=e.lng&&n.lng<=i.lng;return a&&r},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t){return t?(t=o.latLngBounds(t),this._southWest.equals(t.getSouthWest())&&this._northEast.equals(t.getNorthEast())):!1},isValid:function(){return!(!this._southWest||!this._northEast)}},o.latLngBounds=function(t,e){return!t||t instanceof o.LatLngBounds?t:new o.LatLngBounds(t,e)},o.Projection={},o.Projection.SphericalMercator={MAX_LATITUDE:85.0511287798,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),s=t.lng*e,a=n*e;return a=Math.log(Math.tan(Math.PI/4+a/2)),new o.Point(s,a)},unproject:function(t){var e=o.LatLng.RAD_TO_DEG,i=t.x*e,n=(2*Math.atan(Math.exp(t.y))-Math.PI/2)*e;return new o.LatLng(n,i)}},o.Projection.LonLat={project:function(t){return new o.Point(t.lng,t.lat)},unproject:function(t){return new o.LatLng(t.y,t.x)}},o.CRS={latLngToPoint:function(t,e){var i=this.projection.project(t),n=this.scale(e);return this.transformation._transform(i,n)},pointToLatLng:function(t,e){var i=this.scale(e),n=this.transformation.untransform(t,i);return this.projection.unproject(n)},project:function(t){return this.projection.project(t)},scale:function(t){return 256*Math.pow(2,t)}},o.CRS.Simple=o.extend({},o.CRS,{projection:o.Projection.LonLat,transformation:new o.Transformation(1,0,-1,0),scale:function(t){return Math.pow(2,t)}}),o.CRS.EPSG3857=o.extend({},o.CRS,{code:"EPSG:3857",projection:o.Projection.SphericalMercator,transformation:new o.Transformation(.5/Math.PI,.5,-.5/Math.PI,.5),project:function(t){var e=this.projection.project(t),i=6378137;return e.multiplyBy(i)}}),o.CRS.EPSG900913=o.extend({},o.CRS.EPSG3857,{code:"EPSG:900913"}),o.CRS.EPSG4326=o.extend({},o.CRS,{code:"EPSG:4326",projection:o.Projection.LonLat,transformation:new o.Transformation(1/360,.5,-1/360,.5)}),o.Map=o.Class.extend({includes:o.Mixin.Events,options:{crs:o.CRS.EPSG3857,fadeAnimation:o.DomUtil.TRANSITION&&!o.Browser.android23,trackResize:!0,markerZoomAnimation:o.DomUtil.TRANSITION&&o.Browser.any3d},initialize:function(t,e){e=o.setOptions(this,e),this._initContainer(t),this._initLayout(),this._initEvents(),e.maxBounds&&this.setMaxBounds(e.maxBounds),e.center&&e.zoom!==i&&this.setView(o.latLng(e.center),e.zoom,{reset:!0}),this._handlers=[],this._layers={},this._zoomBoundLayers={},this._tileLayersNum=0,this.callInitHooks(),this._addLayers(e.layers)},setView:function(t,e){return this._resetView(o.latLng(t),this._limitZoom(e)),this},setZoom:function(t,e){return this.setView(this.getCenter(),t,{zoom:e})},zoomIn:function(t,e){return this.setZoom(this._zoom+(t||1),e)},zoomOut:function(t,e){return this.setZoom(this._zoom-(t||1),e)},setZoomAround:function(t,e,i){var n=this.getZoomScale(e),s=this.getSize().divideBy(2),a=t instanceof o.Point?t:this.latLngToContainerPoint(t),r=a.subtract(s).multiplyBy(1-1/n),h=this.containerPointToLatLng(s.add(r));return this.setView(h,e,{zoom:i})},fitBounds:function(t,e){e=e||{},t=t.getBounds?t.getBounds():o.latLngBounds(t);var i=o.point(e.paddingTopLeft||e.padding||[0,0]),n=o.point(e.paddingBottomRight||e.padding||[0,0]),s=this.getBoundsZoom(t,!1,i.add(n)),a=n.subtract(i).divideBy(2),r=this.project(t.getSouthWest(),s),h=this.project(t.getNorthEast(),s),l=this.unproject(r.add(h).divideBy(2).add(a),s);return this.setView(l,s,e)},fitWorld:function(t){return this.fitBounds([[-90,-180],[90,180]],t)},panTo:function(t,e){return this.setView(t,this._zoom,{pan:e})},panBy:function(t){return this.fire("movestart"),this._rawPanBy(o.point(t)),this.fire("move"),this.fire("moveend")},setMaxBounds:function(t,e){if(t=o.latLngBounds(t),this.options.maxBounds=t,!t)return this._boundsMinZoom=null,this.off("moveend",this._panInsideMaxBounds,this),this;var i=this.getBoundsZoom(t,!0);return this._boundsMinZoom=i,this._loaded&&(this._zoom<i?this.setView(t.getCenter(),i,e):this.panInsideBounds(t)),this.on("moveend",this._panInsideMaxBounds,this),this},panInsideBounds:function(t){t=o.latLngBounds(t);var e=this.getPixelBounds(),i=e.getBottomLeft(),n=e.getTopRight(),s=this.project(t.getSouthWest()),a=this.project(t.getNorthEast()),r=0,h=0;return n.y<a.y&&(h=Math.ceil(a.y-n.y)),n.x>a.x&&(r=Math.floor(a.x-n.x)),i.y>s.y&&(h=Math.floor(s.y-i.y)),i.x<s.x&&(r=Math.ceil(s.x-i.x)),r||h?this.panBy([r,h]):this},addLayer:function(t){var e=o.stamp(t);return this._layers[e]?this:(this._layers[e]=t,!t.options||isNaN(t.options.maxZoom)&&isNaN(t.options.minZoom)||(this._zoomBoundLayers[e]=t,this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum++,this._tileLayersToLoad++,t.on("load",this._onTileLayerLoad,this)),this._loaded&&this._layerAdd(t),this)},removeLayer:function(t){var e=o.stamp(t);if(this._layers[e])return this._loaded&&t.onRemove(this),delete this._layers[e],this._loaded&&this.fire("layerremove",{layer:t}),this._zoomBoundLayers[e]&&(delete this._zoomBoundLayers[e],this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum--,this._tileLayersToLoad--,t.off("load",this._onTileLayerLoad,this)),this},hasLayer:function(t){return t?o.stamp(t)in this._layers:!1},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},invalidateSize:function(t){t=o.extend({animate:!1,pan:!0},t===!0?{animate:!0}:t);var e=this.getSize();if(this._sizeChanged=!0,this.options.maxBounds&&this.setMaxBounds(this.options.maxBounds),!this._loaded)return this;var i=this.getSize(),n=e.subtract(i).divideBy(2).round();return n.x||n.y?(t.animate&&t.pan?this.panBy(n):(t.pan&&this._rawPanBy(n),this.fire("move"),clearTimeout(this._sizeTimer),this._sizeTimer=setTimeout(o.bind(this.fire,this,"moveend"),200)),this.fire("resize",{oldSize:e,newSize:i})):this},addHandler:function(t,e){if(e){var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this}},remove:function(){return this._loaded&&this.fire("unload"),this._initEvents("off"),delete this._container._leaflet,this._clearPanes(),this._clearControlPos&&this._clearControlPos(),this._clearHandlers(),this},getCenter:function(){return this._checkIfLoaded(),this._moved()?this.layerPointToLatLng(this._getCenterLayerPoint()):this._initialCenter},getZoom:function(){return this._zoom},getBounds:function(){var t=this.getPixelBounds(),e=this.unproject(t.getBottomLeft()),i=this.unproject(t.getTopRight());return new o.LatLngBounds(e,i)},getMinZoom:function(){var t=this._layersMinZoom===i?0:this._layersMinZoom,e=this._boundsMinZoom===i?0:this._boundsMinZoom;return this.options.minZoom===i?Math.max(t,e):this.options.minZoom},getMaxZoom:function(){return this.options.maxZoom===i?this._layersMaxZoom===i?1/0:this._layersMaxZoom:this.options.maxZoom},getBoundsZoom:function(t,e,i){t=o.latLngBounds(t);var n,s=this.getMinZoom()-(e?1:0),a=this.getMaxZoom(),r=this.getSize(),h=t.getNorthWest(),l=t.getSouthEast(),u=!0;i=o.point(i||[0,0]);do s++,n=this.project(l,s).subtract(this.project(h,s)).add(i),u=e?n.x<r.x||n.y<r.y:r.contains(n);while(u&&a>=s);return u&&e?null:e?s:s-1},getSize:function(){return(!this._size||this._sizeChanged)&&(this._size=new o.Point(this._container.clientWidth,this._container.clientHeight),this._sizeChanged=!1),this._size.clone()},getPixelBounds:function(){var t=this._getTopLeftPoint();return new o.Bounds(t,t.add(this.getSize()))},getPixelOrigin:function(){return this._checkIfLoaded(),this._initialTopLeftPoint},getPanes:function(){return this._panes},getContainer:function(){return this._container},getZoomScale:function(t){var e=this.options.crs;return e.scale(t)/e.scale(this._zoom)},getScaleZoom:function(t){return this._zoom+Math.log(t)/Math.LN2},project:function(t,e){return e=e===i?this._zoom:e,this.options.crs.latLngToPoint(o.latLng(t),e)},unproject:function(t,e){return e=e===i?this._zoom:e,this.options.crs.pointToLatLng(o.point(t),e)},layerPointToLatLng:function(t){var e=o.point(t).add(this.getPixelOrigin());return this.unproject(e)},latLngToLayerPoint:function(t){var e=this.project(o.latLng(t))._round();return e._subtract(this.getPixelOrigin())},containerPointToLayerPoint:function(t){return o.point(t).subtract(this._getMapPanePos())},layerPointToContainerPoint:function(t){return o.point(t).add(this._getMapPanePos())},containerPointToLatLng:function(t){var e=this.containerPointToLayerPoint(o.point(t));return this.layerPointToLatLng(e)},latLngToContainerPoint:function(t){return this.layerPointToContainerPoint(this.latLngToLayerPoint(o.latLng(t)))},mouseEventToContainerPoint:function(t){return o.DomEvent.getMousePosition(t,this._container)},mouseEventToLayerPoint:function(t){return this.containerPointToLayerPoint(this.mouseEventToContainerPoint(t))},mouseEventToLatLng:function(t){return this.layerPointToLatLng(this.mouseEventToLayerPoint(t))},_initContainer:function(t){var e=this._container=o.DomUtil.get(t);if(!e)throw new Error("Map container not found.");if(e._leaflet)throw new Error("Map container is already initialized.");e._leaflet=!0},_initLayout:function(){var t=this._container;o.DomUtil.addClass(t,"leaflet-container"+(o.Browser.touch?" leaflet-touch":"")+(o.Browser.retina?" leaflet-retina":"")+(this.options.fadeAnimation?" leaflet-fade-anim":""));var e=o.DomUtil.getStyle(t,"position");"absolute"!==e&&"relative"!==e&&"fixed"!==e&&(t.style.position="relative"),this._initPanes(),this._initControlPos&&this._initControlPos()},_initPanes:function(){var t=this._panes={};this._mapPane=t.mapPane=this._createPane("leaflet-map-pane",this._container),this._tilePane=t.tilePane=this._createPane("leaflet-tile-pane",this._mapPane),t.objectsPane=this._createPane("leaflet-objects-pane",this._mapPane),t.shadowPane=this._createPane("leaflet-shadow-pane"),t.overlayPane=this._createPane("leaflet-overlay-pane"),t.markerPane=this._createPane("leaflet-marker-pane"),t.popupPane=this._createPane("leaflet-popup-pane");var e=" leaflet-zoom-hide";this.options.markerZoomAnimation||(o.DomUtil.addClass(t.markerPane,e),o.DomUtil.addClass(t.shadowPane,e),o.DomUtil.addClass(t.popupPane,e))},_createPane:function(t,e){return o.DomUtil.create("div",t,e||this._panes.objectsPane)},_clearPanes:function(){this._container.removeChild(this._mapPane)},_addLayers:function(t){t=t?o.Util.isArray(t)?t:[t]:[];for(var e=0,i=t.length;i>e;e++)this.addLayer(t[e])},_resetView:function(t,e,i,n){var s=this._zoom!==e;n||(this.fire("movestart"),s&&this.fire("zoomstart")),this._zoom=e,this._initialCenter=t,this._initialTopLeftPoint=this._getNewTopLeftPoint(t),i?this._initialTopLeftPoint._add(this._getMapPanePos()):o.DomUtil.setPosition(this._mapPane,new o.Point(0,0)),this._tileLayersToLoad=this._tileLayersNum;var a=!this._loaded;this._loaded=!0,a&&(this.fire("load"),this.eachLayer(this._layerAdd,this)),this.fire("viewreset",{hard:!i}),this.fire("move"),(s||n)&&this.fire("zoomend"),this.fire("moveend",{hard:!i})},_rawPanBy:function(t){o.DomUtil.setPosition(this._mapPane,this._getMapPanePos().subtract(t))},_getZoomSpan:function(){return this.getMaxZoom()-this.getMinZoom()},_updateZoomLevels:function(){var t,e=1/0,n=-1/0,o=this._getZoomSpan();for(t in this._zoomBoundLayers){var s=this._zoomBoundLayers[t];isNaN(s.options.minZoom)||(e=Math.min(e,s.options.minZoom)),isNaN(s.options.maxZoom)||(n=Math.max(n,s.options.maxZoom))}t===i?this._layersMaxZoom=this._layersMinZoom=i:(this._layersMaxZoom=n,this._layersMinZoom=e),o!==this._getZoomSpan()&&this.fire("zoomlevelschange")},_panInsideMaxBounds:function(){this.panInsideBounds(this.options.maxBounds)},_checkIfLoaded:function(){if(!this._loaded)throw new Error("Set map center and zoom first.")},_initEvents:function(e){if(o.DomEvent){e=e||"on",o.DomEvent[e](this._container,"click",this._onMouseClick,this);var i,n,s=["dblclick","mousedown","mouseup","mouseenter","mouseleave","mousemove","contextmenu"];for(i=0,n=s.length;n>i;i++)o.DomEvent[e](this._container,s[i],this._fireMouseEvent,this);this.options.trackResize&&o.DomEvent[e](t,"resize",this._onResize,this)}},_onResize:function(){o.Util.cancelAnimFrame(this._resizeRequest),this._resizeRequest=o.Util.requestAnimFrame(this.invalidateSize,this,!1,this._container)},_onMouseClick:function(t){!this._loaded||!t._simulated&&this.dragging&&this.dragging.moved()||o.DomEvent._skipped(t)||(this.fire("preclick"),this._fireMouseEvent(t))},_fireMouseEvent:function(t){if(this._loaded&&!o.DomEvent._skipped(t)){var e=t.type;if(e="mouseenter"===e?"mouseover":"mouseleave"===e?"mouseout":e,this.hasEventListeners(e)){"contextmenu"===e&&o.DomEvent.preventDefault(t);var i=this.mouseEventToContainerPoint(t),n=this.containerPointToLayerPoint(i),s=this.layerPointToLatLng(n);this.fire(e,{latlng:s,layerPoint:n,containerPoint:i,originalEvent:t})}}},_onTileLayerLoad:function(){this._tileLayersToLoad--,this._tileLayersNum&&!this._tileLayersToLoad&&this.fire("tilelayersload")},_clearHandlers:function(){for(var t=0,e=this._handlers.length;e>t;t++)this._handlers[t].disable()},whenReady:function(t,e){return this._loaded?t.call(e||this,this):this.on("load",t,e),this},_layerAdd:function(t){t.onAdd(this),this.fire("layeradd",{layer:t})},_getMapPanePos:function(){return o.DomUtil.getPosition(this._mapPane)},_moved:function(){var t=this._getMapPanePos();return t&&!t.equals([0,0])},_getTopLeftPoint:function(){return this.getPixelOrigin().subtract(this._getMapPanePos())},_getNewTopLeftPoint:function(t,e){var i=this.getSize()._divideBy(2);return this.project(t,e)._subtract(i)._round()},_latLngToNewLayerPoint:function(t,e,i){var n=this._getNewTopLeftPoint(i,e).add(this._getMapPanePos());return this.project(t,e)._subtract(n)},_getCenterLayerPoint:function(){return this.containerPointToLayerPoint(this.getSize()._divideBy(2))},_getCenterOffset:function(t){return this.latLngToLayerPoint(t).subtract(this._getCenterLayerPoint())},_limitZoom:function(t){var e=this.getMinZoom(),i=this.getMaxZoom();return Math.max(e,Math.min(i,t))}}),o.map=function(t,e){return new o.Map(t,e)},o.Projection.Mercator={MAX_LATITUDE:85.0840591556,R_MINOR:6356752.314245179,R_MAJOR:6378137,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),s=this.R_MAJOR,a=this.R_MINOR,r=t.lng*e*s,h=n*e,l=a/s,u=Math.sqrt(1-l*l),c=u*Math.sin(h);c=Math.pow((1-c)/(1+c),.5*u);var d=Math.tan(.5*(.5*Math.PI-h))/c;return h=-s*Math.log(d),new o.Point(r,h)},unproject:function(t){for(var e,i=o.LatLng.RAD_TO_DEG,n=this.R_MAJOR,s=this.R_MINOR,a=t.x*i/n,r=s/n,h=Math.sqrt(1-r*r),l=Math.exp(-t.y/n),u=Math.PI/2-2*Math.atan(l),c=15,d=1e-7,p=c,_=.1;Math.abs(_)>d&&--p>0;)e=h*Math.sin(u),_=Math.PI/2-2*Math.atan(l*Math.pow((1-e)/(1+e),.5*h))-u,u+=_;return new o.LatLng(u*i,a)}},o.CRS.EPSG3395=o.extend({},o.CRS,{code:"EPSG:3395",projection:o.Projection.Mercator,transformation:function(){var t=o.Projection.Mercator,e=t.R_MAJOR,i=t.R_MINOR;return new o.Transformation(.5/(Math.PI*e),.5,-.5/(Math.PI*i),.5)}()}),o.TileLayer=o.Class.extend({includes:o.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",zoomOffset:0,opacity:1,unloadInvisibleTiles:o.Browser.mobile,updateWhenIdle:o.Browser.mobile},initialize:function(t,e){e=o.setOptions(this,e),e.detectRetina&&o.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom>0&&e.minZoom--,this.options.maxZoom--),e.bounds&&(e.bounds=o.latLngBounds(e.bounds)),this._url=t;var i=this.options.subdomains;"string"==typeof i&&(this.options.subdomains=i.split(""))},onAdd:function(t){this._map=t,this._animated=t._zoomAnimated,this._initContainer(),this._createTileProto(),t.on({viewreset:this._reset,moveend:this._update},this),this._animated&&t.on({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||(this._limitedUpdate=o.Util.limitExecByInterval(this._update,150,this),t.on("move",this._limitedUpdate,this)),this._reset(),this._update()
-},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this._container.parentNode.removeChild(this._container),t.off({viewreset:this._reset,moveend:this._update},this),this._animated&&t.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||t.off("move",this._limitedUpdate,this),this._container=null,this._map=null},bringToFront:function(){var t=this._map._panes.tilePane;return this._container&&(t.appendChild(this._container),this._setAutoZIndex(t,Math.max)),this},bringToBack:function(){var t=this._map._panes.tilePane;return this._container&&(t.insertBefore(this._container,t.firstChild),this._setAutoZIndex(t,Math.min)),this},getAttribution:function(){return this.options.attribution},getContainer:function(){return this._container},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},setUrl:function(t,e){return this._url=t,e||this.redraw(),this},redraw:function(){return this._map&&(this._reset({hard:!0}),this._update()),this},_updateZIndex:function(){this._container&&this.options.zIndex!==i&&(this._container.style.zIndex=this.options.zIndex)},_setAutoZIndex:function(t,e){var i,n,o,s=t.children,a=-e(1/0,-1/0);for(n=0,o=s.length;o>n;n++)s[n]!==this._container&&(i=parseInt(s[n].style.zIndex,10),isNaN(i)||(a=e(a,i)));this.options.zIndex=this._container.style.zIndex=(isFinite(a)?a:0)+e(1,-1)},_updateOpacity:function(){var t,e=this._tiles;if(o.Browser.ielt9)for(t in e)o.DomUtil.setOpacity(e[t],this.options.opacity);else o.DomUtil.setOpacity(this._container,this.options.opacity)},_initContainer:function(){var t=this._map._panes.tilePane;if(!this._container){if(this._container=o.DomUtil.create("div","leaflet-layer"),this._updateZIndex(),this._animated){var e="leaflet-tile-container leaflet-zoom-animated";this._bgBuffer=o.DomUtil.create("div",e,this._container),this._tileContainer=o.DomUtil.create("div",e,this._container)}else this._tileContainer=this._container;t.appendChild(this._container),this.options.opacity<1&&this._updateOpacity()}},_reset:function(t){for(var e in this._tiles)this.fire("tileunload",{tile:this._tiles[e]});this._tiles={},this._tilesToLoad=0,this.options.reuseTiles&&(this._unusedTiles=[]),this._tileContainer.innerHTML="",this._animated&&t&&t.hard&&this._clearBgBuffer(),this._initContainer()},_update:function(){if(this._map){var t=this._map.getPixelBounds(),e=this._map.getZoom(),i=this.options.tileSize;if(!(e>this.options.maxZoom||e<this.options.minZoom)){var n=o.bounds(t.min.divideBy(i)._floor(),t.max.divideBy(i)._floor());this._addTilesFromCenterOut(n),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(n)}}},_addTilesFromCenterOut:function(t){var i,n,s,a=[],r=t.getCenter();for(i=t.min.y;i<=t.max.y;i++)for(n=t.min.x;n<=t.max.x;n++)s=new o.Point(n,i),this._tileShouldBeLoaded(s)&&a.push(s);var h=a.length;if(0!==h){a.sort(function(t,e){return t.distanceTo(r)-e.distanceTo(r)});var l=e.createDocumentFragment();for(this._tilesToLoad||this.fire("loading"),this._tilesToLoad+=h,n=0;h>n;n++)this._addTile(a[n],l);this._tileContainer.appendChild(l)}},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var e=this.options;if(!e.continuousWorld){var i=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=i)||t.y<0||t.y>=i)return!1}if(e.bounds){var n=e.tileSize,o=t.multiplyBy(n),s=o.add([n,n]),a=this._map.unproject(o),r=this._map.unproject(s);if(e.continuousWorld||e.noWrap||(a=a.wrap(),r=r.wrap()),!e.bounds.intersects([a,r]))return!1}return!0},_removeOtherTiles:function(t){var e,i,n,o;for(o in this._tiles)e=o.split(":"),i=parseInt(e[0],10),n=parseInt(e[1],10),(i<t.min.x||i>t.max.x||n<t.min.y||n>t.max.y)&&this._removeTile(o)},_removeTile:function(t){var e=this._tiles[t];this.fire("tileunload",{tile:e,url:e.src}),this.options.reuseTiles?(o.DomUtil.removeClass(e,"leaflet-tile-loaded"),this._unusedTiles.push(e)):e.parentNode===this._tileContainer&&this._tileContainer.removeChild(e),o.Browser.android||(e.onload=null,e.src=o.Util.emptyImageUrl),delete this._tiles[t]},_addTile:function(t,e){var i=this._getTilePos(t),n=this._getTile();o.DomUtil.setPosition(n,i,o.Browser.chrome||o.Browser.android23),this._tiles[t.x+":"+t.y]=n,this._loadTile(n,t),n.parentNode!==this._tileContainer&&e.appendChild(n)},_getZoomForUrl:function(){var t=this.options,e=this._map.getZoom();return t.zoomReverse&&(e=t.maxZoom-e),e+t.zoomOffset},_getTilePos:function(t){var e=this._map.getPixelOrigin(),i=this.options.tileSize;return t.multiplyBy(i).subtract(e)},getTileUrl:function(t){return o.Util.template(this._url,o.extend({s:this._getSubdomain(t),z:t.z,x:t.x,y:t.y},this.options))},_getWrapTileNum:function(){return Math.pow(2,this._getZoomForUrl())},_adjustTilePoint:function(t){var e=this._getWrapTileNum();this.options.continuousWorld||this.options.noWrap||(t.x=(t.x%e+e)%e),this.options.tms&&(t.y=e-t.y-1),t.z=this._getZoomForUrl()},_getSubdomain:function(t){var e=Math.abs(t.x+t.y)%this.options.subdomains.length;return this.options.subdomains[e]},_createTileProto:function(){var t=this._tileImg=o.DomUtil.create("img","leaflet-tile");t.style.width=t.style.height=this.options.tileSize+"px",t.galleryimg="no"},_getTile:function(){if(this.options.reuseTiles&&this._unusedTiles.length>0){var t=this._unusedTiles.pop();return this._resetTile(t),t}return this._createTile()},_resetTile:function(){},_createTile:function(){var t=this._tileImg.cloneNode(!1);return t.onselectstart=t.onmousemove=o.Util.falseFn,o.Browser.ielt9&&this.options.opacity!==i&&o.DomUtil.setOpacity(t,this.options.opacity),t},_loadTile:function(t,e){t._layer=this,t.onload=this._tileOnLoad,t.onerror=this._tileOnError,this._adjustTilePoint(e),t.src=this.getTileUrl(e)},_tileLoaded:function(){this._tilesToLoad--,this._tilesToLoad||(this.fire("load"),this._animated&&(clearTimeout(this._clearBgBufferTimer),this._clearBgBufferTimer=setTimeout(o.bind(this._clearBgBuffer,this),500)))},_tileOnLoad:function(){var t=this._layer;this.src!==o.Util.emptyImageUrl&&(o.DomUtil.addClass(this,"leaflet-tile-loaded"),t.fire("tileload",{tile:this,url:this.src})),t._tileLoaded()},_tileOnError:function(){var t=this._layer;t.fire("tileerror",{tile:this,url:this.src});var e=t.options.errorTileUrl;e&&(this.src=e),t._tileLoaded()}}),o.tileLayer=function(t,e){return new o.TileLayer(t,e)},o.TileLayer.WMS=o.TileLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},initialize:function(t,e){this._url=t;var i=o.extend({},this.defaultWmsParams),n=e.tileSize||this.options.tileSize;i.width=i.height=e.detectRetina&&o.Browser.retina?2*n:n;for(var s in e)this.options.hasOwnProperty(s)||"crs"===s||(i[s]=e[s]);this.wmsParams=i,o.setOptions(this,e)},onAdd:function(t){this._crs=this.options.crs||t.options.crs;var e=parseFloat(this.wmsParams.version)>=1.3?"crs":"srs";this.wmsParams[e]=this._crs.code,o.TileLayer.prototype.onAdd.call(this,t)},getTileUrl:function(t,e){var i=this._map,n=this.options.tileSize,s=t.multiplyBy(n),a=s.add([n,n]),r=this._crs.project(i.unproject(s,e)),h=this._crs.project(i.unproject(a,e)),l=[r.x,h.y,h.x,r.y].join(","),u=o.Util.template(this._url,{s:this._getSubdomain(t)});return u+o.Util.getParamString(this.wmsParams,u,!0)+"&BBOX="+l},setParams:function(t,e){return o.extend(this.wmsParams,t),e||this.redraw(),this}}),o.tileLayer.wms=function(t,e){return new o.TileLayer.WMS(t,e)},o.TileLayer.Canvas=o.TileLayer.extend({options:{async:!1},initialize:function(t){o.setOptions(this,t)},redraw:function(){this._map&&(this._reset({hard:!0}),this._update());for(var t in this._tiles)this._redrawTile(this._tiles[t]);return this},_redrawTile:function(t){this.drawTile(t,t._tilePoint,this._map._zoom)},_createTileProto:function(){var t=this._canvasProto=o.DomUtil.create("canvas","leaflet-tile");t.width=t.height=this.options.tileSize},_createTile:function(){var t=this._canvasProto.cloneNode(!1);return t.onselectstart=t.onmousemove=o.Util.falseFn,t},_loadTile:function(t,e){t._layer=this,t._tilePoint=e,this._redrawTile(t),this.options.async||this.tileDrawn(t)},drawTile:function(){},tileDrawn:function(t){this._tileOnLoad.call(t)}}),o.tileLayer.canvas=function(t){return new o.TileLayer.Canvas(t)},o.ImageOverlay=o.Class.extend({includes:o.Mixin.Events,options:{opacity:1},initialize:function(t,e,i){this._url=t,this._bounds=o.latLngBounds(e),o.setOptions(this,i)},onAdd:function(t){this._map=t,this._image||this._initImage(),t._panes.overlayPane.appendChild(this._image),t.on("viewreset",this._reset,this),t.options.zoomAnimation&&o.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._image),t.off("viewreset",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._image&&this._map._panes.overlayPane.appendChild(this._image),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._image&&t.insertBefore(this._image,t.firstChild),this},_initImage:function(){this._image=o.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&o.Browser.any3d?o.DomUtil.addClass(this._image,"leaflet-zoom-animated"):o.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),o.extend(this._image,{galleryimg:"no",onselectstart:o.Util.falseFn,onmousemove:o.Util.falseFn,onload:o.bind(this._onImageLoad,this),src:this._url})},_animateZoom:function(t){var e=this._map,i=this._image,n=e.getZoomScale(t.zoom),s=this._bounds.getNorthWest(),a=this._bounds.getSouthEast(),r=e._latLngToNewLayerPoint(s,t.zoom,t.center),h=e._latLngToNewLayerPoint(a,t.zoom,t.center)._subtract(r),l=r._add(h._multiplyBy(.5*(1-1/n)));i.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(l)+" scale("+n+") "},_reset:function(){var t=this._image,e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),i=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(e);o.DomUtil.setPosition(t,e),t.style.width=i.x+"px",t.style.height=i.y+"px"},_onImageLoad:function(){this.fire("load")},_updateOpacity:function(){o.DomUtil.setOpacity(this._image,this.options.opacity)}}),o.imageOverlay=function(t,e,i){return new o.ImageOverlay(t,e,i)},o.Icon=o.Class.extend({options:{className:""},initialize:function(t){o.setOptions(this,t)},createIcon:function(t){return this._createIcon("icon",t)},createShadow:function(t){return this._createIcon("shadow",t)},_createIcon:function(t,e){var i=this._getIconUrl(t);if(!i){if("icon"===t)throw new Error("iconUrl not set in Icon options (see the docs).");return null}var n;return n=e&&"IMG"===e.tagName?this._createImg(i,e):this._createImg(i),this._setIconStyles(n,t),n},_setIconStyles:function(t,e){var i,n=this.options,s=o.point(n[e+"Size"]);i="shadow"===e?o.point(n.shadowAnchor||n.iconAnchor):o.point(n.iconAnchor),!i&&s&&(i=s.divideBy(2,!0)),t.className="leaflet-marker-"+e+" "+n.className,i&&(t.style.marginLeft=-i.x+"px",t.style.marginTop=-i.y+"px"),s&&(t.style.width=s.x+"px",t.style.height=s.y+"px")},_createImg:function(t,i){return o.Browser.ie6?(i||(i=e.createElement("div")),i.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+t+'")'):(i||(i=e.createElement("img")),i.src=t),i},_getIconUrl:function(t){return o.Browser.retina&&this.options[t+"RetinaUrl"]?this.options[t+"RetinaUrl"]:this.options[t+"Url"]}}),o.icon=function(t){return new o.Icon(t)},o.Icon.Default=o.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]},_getIconUrl:function(t){var e=t+"Url";if(this.options[e])return this.options[e];o.Browser.retina&&"icon"===t&&(t+="-2x");var i=o.Icon.Default.imagePath;if(!i)throw new Error("Couldn't autodetect L.Icon.Default.imagePath, set it manually.");return i+"/marker-"+t+".png"}}),o.Icon.Default.imagePath=function(){var t,i,n,o,s,a=e.getElementsByTagName("script"),r=/[\/^]leaflet[\-\._]?([\w\-\._]*)\.js\??/;for(t=0,i=a.length;i>t;t++)if(n=a[t].src,o=n.match(r))return s=n.split(r)[0],(s?s+"/":"")+"images"}(),o.Marker=o.Class.extend({includes:o.Mixin.Events,options:{icon:new o.Icon.Default,title:"",clickable:!0,draggable:!1,keyboard:!0,zIndexOffset:0,opacity:1,riseOnHover:!1,riseOffset:250},initialize:function(t,e){o.setOptions(this,e),this._latlng=o.latLng(t)},onAdd:function(t){this._map=t,t.on("viewreset",this.update,this),this._initIcon(),this.update(),t.options.zoomAnimation&&t.options.markerZoomAnimation&&t.on("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this.dragging&&this.dragging.disable(),this._removeIcon(),this._removeShadow(),this.fire("remove"),t.off({viewreset:this.update,zoomanim:this._animateZoom},this),this._map=null},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=o.latLng(t),this.update(),this.fire("move",{latlng:this._latlng})},setZIndexOffset:function(t){return this.options.zIndexOffset=t,this.update(),this},setIcon:function(t){return this.options.icon=t,this._map&&(this._initIcon(),this.update()),this},update:function(){if(this._icon){var t=this._map.latLngToLayerPoint(this._latlng).round();this._setPos(t)}return this},_initIcon:function(){var t=this.options,e=this._map,i=e.options.zoomAnimation&&e.options.markerZoomAnimation,n=i?"leaflet-zoom-animated":"leaflet-zoom-hide",s=t.icon.createIcon(this._icon),a=!1;s!==this._icon&&(this._icon&&this._removeIcon(),a=!0,t.title&&(s.title=t.title)),o.DomUtil.addClass(s,n),t.keyboard&&(s.tabIndex="0"),this._icon=s,this._initInteraction(),t.riseOnHover&&o.DomEvent.on(s,"mouseover",this._bringToFront,this).on(s,"mouseout",this._resetZIndex,this);var r=t.icon.createShadow(this._shadow),h=!1;r!==this._shadow&&(this._removeShadow(),h=!0),r&&o.DomUtil.addClass(r,n),this._shadow=r,t.opacity<1&&this._updateOpacity();var l=this._map._panes;a&&l.markerPane.appendChild(this._icon),r&&h&&l.shadowPane.appendChild(this._shadow)},_removeIcon:function(){this.options.riseOnHover&&o.DomEvent.off(this._icon,"mouseover",this._bringToFront).off(this._icon,"mouseout",this._resetZIndex),this._map._panes.markerPane.removeChild(this._icon),this._icon=null},_removeShadow:function(){this._shadow&&this._map._panes.shadowPane.removeChild(this._shadow),this._shadow=null},_setPos:function(t){o.DomUtil.setPosition(this._icon,t),this._shadow&&o.DomUtil.setPosition(this._shadow,t),this._zIndex=t.y+this.options.zIndexOffset,this._resetZIndex()},_updateZIndex:function(t){this._icon.style.zIndex=this._zIndex+t},_animateZoom:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center);this._setPos(e)},_initInteraction:function(){if(this.options.clickable){var t=this._icon,e=["dblclick","mousedown","mouseover","mouseout","contextmenu"];o.DomUtil.addClass(t,"leaflet-clickable"),o.DomEvent.on(t,"click",this._onMouseClick,this),o.DomEvent.on(t,"keypress",this._onKeyPress,this);for(var i=0;i<e.length;i++)o.DomEvent.on(t,e[i],this._fireMouseEvent,this);o.Handler.MarkerDrag&&(this.dragging=new o.Handler.MarkerDrag(this),this.options.draggable&&this.dragging.enable())}},_onMouseClick:function(t){var e=this.dragging&&this.dragging.moved();(this.hasEventListeners(t.type)||e)&&o.DomEvent.stopPropagation(t),e||(this.dragging&&this.dragging._enabled||!this._map.dragging||!this._map.dragging.moved())&&this.fire(t.type,{originalEvent:t,latlng:this._latlng})},_onKeyPress:function(t){13===t.keyCode&&this.fire("click",{originalEvent:t,latlng:this._latlng})},_fireMouseEvent:function(t){this.fire(t.type,{originalEvent:t,latlng:this._latlng}),"contextmenu"===t.type&&this.hasEventListeners(t.type)&&o.DomEvent.preventDefault(t),"mousedown"!==t.type?o.DomEvent.stopPropagation(t):o.DomEvent.preventDefault(t)},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},_updateOpacity:function(){o.DomUtil.setOpacity(this._icon,this.options.opacity),this._shadow&&o.DomUtil.setOpacity(this._shadow,this.options.opacity)},_bringToFront:function(){this._updateZIndex(this.options.riseOffset)},_resetZIndex:function(){this._updateZIndex(0)}}),o.marker=function(t,e){return new o.Marker(t,e)},o.DivIcon=o.Icon.extend({options:{iconSize:[12,12],className:"leaflet-div-icon",html:!1},createIcon:function(t){var i=t&&"DIV"===t.tagName?t:e.createElement("div"),n=this.options;return i.innerHTML=n.html!==!1?n.html:"",n.bgPos&&(i.style.backgroundPosition=-n.bgPos.x+"px "+-n.bgPos.y+"px"),this._setIconStyles(i,"icon"),i},createShadow:function(){return null}}),o.divIcon=function(t){return new o.DivIcon(t)},o.Map.mergeOptions({closePopupOnClick:!0}),o.Popup=o.Class.extend({includes:o.Mixin.Events,options:{minWidth:50,maxWidth:300,maxHeight:null,autoPan:!0,closeButton:!0,offset:[0,7],autoPanPadding:[5,5],keepInView:!1,className:"",zoomAnimation:!0},initialize:function(t,e){o.setOptions(this,t),this._source=e,this._animated=o.Browser.any3d&&this.options.zoomAnimation,this._isOpen=!1},onAdd:function(t){this._map=t,this._container||this._initLayout(),this._updateContent();var e=t.options.fadeAnimation;e&&o.DomUtil.setOpacity(this._container,0),t._panes.popupPane.appendChild(this._container),t.on(this._getEvents(),this),this._update(),e&&o.DomUtil.setOpacity(this._container,1),this.fire("open"),t.fire("popupopen",{popup:this}),this._source&&this._source.fire("popupopen",{popup:this})},addTo:function(t){return t.addLayer(this),this},openOn:function(t){return t.openPopup(this),this},onRemove:function(t){t._panes.popupPane.removeChild(this._container),o.Util.falseFn(this._container.offsetWidth),t.off(this._getEvents(),this),t.options.fadeAnimation&&o.DomUtil.setOpacity(this._container,0),this._map=null,this.fire("close"),t.fire("popupclose",{popup:this}),this._source&&this._source.fire("popupclose",{popup:this})},setLatLng:function(t){return this._latlng=o.latLng(t),this._update(),this},setContent:function(t){return this._content=t,this._update(),this},_getEvents:function(){var t={viewreset:this._updatePosition};return this._animated&&(t.zoomanim=this._zoomAnimation),("closeOnClick"in this.options?this.options.closeOnClick:this._map.options.closePopupOnClick)&&(t.preclick=this._close),this.options.keepInView&&(t.moveend=this._adjustPan),t},_close:function(){this._map&&this._map.closePopup(this)},_initLayout:function(){var t,e="leaflet-popup",i=e+" "+this.options.className+" leaflet-zoom-"+(this._animated?"animated":"hide"),n=this._container=o.DomUtil.create("div",i);this.options.closeButton&&(t=this._closeButton=o.DomUtil.create("a",e+"-close-button",n),t.href="#close",t.innerHTML="&#215;",o.DomEvent.disableClickPropagation(t),o.DomEvent.on(t,"click",this._onCloseButtonClick,this));var s=this._wrapper=o.DomUtil.create("div",e+"-content-wrapper",n);o.DomEvent.disableClickPropagation(s),this._contentNode=o.DomUtil.create("div",e+"-content",s),o.DomEvent.on(this._contentNode,"mousewheel",o.DomEvent.stopPropagation),o.DomEvent.on(this._contentNode,"MozMousePixelScroll",o.DomEvent.stopPropagation),o.DomEvent.on(s,"contextmenu",o.DomEvent.stopPropagation),this._tipContainer=o.DomUtil.create("div",e+"-tip-container",n),this._tip=o.DomUtil.create("div",e+"-tip",this._tipContainer)},_update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this._adjustPan())},_updateContent:function(){if(this._content){if("string"==typeof this._content)this._contentNode.innerHTML=this._content;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(this._content)}this.fire("contentupdate")}},_updateLayout:function(){var t=this._contentNode,e=t.style;e.width="",e.whiteSpace="nowrap";var i=t.offsetWidth;i=Math.min(i,this.options.maxWidth),i=Math.max(i,this.options.minWidth),e.width=i+1+"px",e.whiteSpace="",e.height="";var n=t.offsetHeight,s=this.options.maxHeight,a="leaflet-popup-scrolled";s&&n>s?(e.height=s+"px",o.DomUtil.addClass(t,a)):o.DomUtil.removeClass(t,a),this._containerWidth=this._container.offsetWidth},_updatePosition:function(){if(this._map){var t=this._map.latLngToLayerPoint(this._latlng),e=this._animated,i=o.point(this.options.offset);e&&o.DomUtil.setPosition(this._container,t),this._containerBottom=-i.y-(e?0:t.y),this._containerLeft=-Math.round(this._containerWidth/2)+i.x+(e?0:t.x),this._container.style.bottom=this._containerBottom+"px",this._container.style.left=this._containerLeft+"px"}},_zoomAnimation:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center);o.DomUtil.setPosition(this._container,e)},_adjustPan:function(){if(this.options.autoPan){var t=this._map,e=this._container.offsetHeight,i=this._containerWidth,n=new o.Point(this._containerLeft,-e-this._containerBottom);this._animated&&n._add(o.DomUtil.getPosition(this._container));var s=t.layerPointToContainerPoint(n),a=o.point(this.options.autoPanPadding),r=t.getSize(),h=0,l=0;s.x+i>r.x&&(h=s.x+i-r.x+a.x),s.x-h<0&&(h=s.x-a.x),s.y+e>r.y&&(l=s.y+e-r.y+a.y),s.y-l<0&&(l=s.y-a.y),(h||l)&&t.fire("autopanstart").panBy([h,l])}},_onCloseButtonClick:function(t){this._close(),o.DomEvent.stop(t)}}),o.popup=function(t,e){return new o.Popup(t,e)},o.Map.include({openPopup:function(t,e,i){if(this.closePopup(),!(t instanceof o.Popup)){var n=t;t=new o.Popup(i).setLatLng(e).setContent(n)}return t._isOpen=!0,this._popup=t,this.addLayer(t)},closePopup:function(t){return t&&t!==this._popup||(t=this._popup,this._popup=null),t&&(this.removeLayer(t),t._isOpen=!1),this}}),o.Marker.include({openPopup:function(){return this._popup&&this._map&&!this._map.hasLayer(this._popup)&&(this._popup.setLatLng(this._latlng),this._map.openPopup(this._popup)),this},closePopup:function(){return this._popup&&this._popup._close(),this},togglePopup:function(){return this._popup&&(this._popup._isOpen?this.closePopup():this.openPopup()),this},bindPopup:function(t,e){var i=o.point(this.options.icon.options.popupAnchor||[0,0]);return i=i.add(o.Popup.prototype.options.offset),e&&e.offset&&(i=i.add(e.offset)),e=o.extend({offset:i},e),this._popup||this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),t instanceof o.Popup?(o.setOptions(t,e),this._popup=t):this._popup=new o.Popup(e,this).setContent(t),this},setPopupContent:function(t){return this._popup&&this._popup.setContent(t),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this.togglePopup).off("remove",this.closePopup).off("move",this._movePopup)),this},_movePopup:function(t){this._popup.setLatLng(t.latlng)}}),o.LayerGroup=o.Class.extend({initialize:function(t){this._layers={};var e,i;if(t)for(e=0,i=t.length;i>e;e++)this.addLayer(t[e])},addLayer:function(t){var e=this.getLayerId(t);return this._layers[e]=t,this._map&&this._map.addLayer(t),this},removeLayer:function(t){var e=t in this._layers?t:this.getLayerId(t);return this._map&&this._layers[e]&&this._map.removeLayer(this._layers[e]),delete this._layers[e],this},hasLayer:function(t){return t?t in this._layers||this.getLayerId(t)in this._layers:!1},clearLayers:function(){return this.eachLayer(this.removeLayer,this),this},invoke:function(t){var e,i,n=Array.prototype.slice.call(arguments,1);for(e in this._layers)i=this._layers[e],i[t]&&i[t].apply(i,n);return this},onAdd:function(t){this._map=t,this.eachLayer(t.addLayer,t)},onRemove:function(t){this.eachLayer(t.removeLayer,t),this._map=null},addTo:function(t){return t.addLayer(this),this},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getLayer:function(t){return this._layers[t]},getLayers:function(){var t=[];for(var e in this._layers)t.push(this._layers[e]);return t},setZIndex:function(t){return this.invoke("setZIndex",t)},getLayerId:function(t){return o.stamp(t)}}),o.layerGroup=function(t){return new o.LayerGroup(t)},o.FeatureGroup=o.LayerGroup.extend({includes:o.Mixin.Events,statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose"},addLayer:function(t){return this.hasLayer(t)?this:(t.on(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.addLayer.call(this,t),this._popupContent&&t.bindPopup&&t.bindPopup(this._popupContent,this._popupOptions),this.fire("layeradd",{layer:t}))},removeLayer:function(t){return this.hasLayer(t)?(t in this._layers&&(t=this._layers[t]),t.off(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.removeLayer.call(this,t),this._popupContent&&this.invoke("unbindPopup"),this.fire("layerremove",{layer:t})):this},bindPopup:function(t,e){return this._popupContent=t,this._popupOptions=e,this.invoke("bindPopup",t,e)},setStyle:function(t){return this.invoke("setStyle",t)},bringToFront:function(){return this.invoke("bringToFront")},bringToBack:function(){return this.invoke("bringToBack")},getBounds:function(){var t=new o.LatLngBounds;return this.eachLayer(function(e){t.extend(e instanceof o.Marker?e.getLatLng():e.getBounds())}),t},_propagateEvent:function(t){t.layer||(t.layer=t.target),t.target=this,this.fire(t.type,t)}}),o.featureGroup=function(t){return new o.FeatureGroup(t)},o.Path=o.Class.extend({includes:[o.Mixin.Events],statics:{CLIP_PADDING:function(){var e=o.Browser.mobile?1280:2e3,i=(e/Math.max(t.outerWidth,t.outerHeight)-1)/2;return Math.max(0,Math.min(.5,i))}()},options:{stroke:!0,color:"#0033ff",dashArray:null,weight:5,opacity:.5,fill:!1,fillColor:null,fillOpacity:.2,clickable:!0},initialize:function(t){o.setOptions(this,t)},onAdd:function(t){this._map=t,this._container||(this._initElements(),this._initEvents()),this.projectLatlngs(),this._updatePath(),this._container&&this._map._pathRoot.appendChild(this._container),this.fire("add"),t.on({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){t._pathRoot.removeChild(this._container),this.fire("remove"),this._map=null,o.Browser.vml&&(this._container=null,this._stroke=null,this._fill=null),t.off({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},projectLatlngs:function(){},setStyle:function(t){return o.setOptions(this,t),this._container&&this._updateStyle(),this},redraw:function(){return this._map&&(this.projectLatlngs(),this._updatePath()),this}}),o.Map.include({_updatePathViewport:function(){var t=o.Path.CLIP_PADDING,e=this.getSize(),i=o.DomUtil.getPosition(this._mapPane),n=i.multiplyBy(-1)._subtract(e.multiplyBy(t)._round()),s=n.add(e.multiplyBy(1+2*t)._round());this._pathViewport=new o.Bounds(n,s)}}),o.Path.SVG_NS="http://www.w3.org/2000/svg",o.Browser.svg=!(!e.createElementNS||!e.createElementNS(o.Path.SVG_NS,"svg").createSVGRect),o.Path=o.Path.extend({statics:{SVG:o.Browser.svg},bringToFront:function(){var t=this._map._pathRoot,e=this._container;return e&&t.lastChild!==e&&t.appendChild(e),this},bringToBack:function(){var t=this._map._pathRoot,e=this._container,i=t.firstChild;return e&&i!==e&&t.insertBefore(e,i),this},getPathString:function(){},_createElement:function(t){return e.createElementNS(o.Path.SVG_NS,t)},_initElements:function(){this._map._initPathRoot(),this._initPath(),this._initStyle()},_initPath:function(){this._container=this._createElement("g"),this._path=this._createElement("path"),this._container.appendChild(this._path)},_initStyle:function(){this.options.stroke&&(this._path.setAttribute("stroke-linejoin","round"),this._path.setAttribute("stroke-linecap","round")),this.options.fill&&this._path.setAttribute("fill-rule","evenodd"),this.options.pointerEvents&&this._path.setAttribute("pointer-events",this.options.pointerEvents),this.options.clickable||this.options.pointerEvents||this._path.setAttribute("pointer-events","none"),this._updateStyle()},_updateStyle:function(){this.options.stroke?(this._path.setAttribute("stroke",this.options.color),this._path.setAttribute("stroke-opacity",this.options.opacity),this._path.setAttribute("stroke-width",this.options.weight),this.options.dashArray?this._path.setAttribute("stroke-dasharray",this.options.dashArray):this._path.removeAttribute("stroke-dasharray")):this._path.setAttribute("stroke","none"),this.options.fill?(this._path.setAttribute("fill",this.options.fillColor||this.options.color),this._path.setAttribute("fill-opacity",this.options.fillOpacity)):this._path.setAttribute("fill","none")},_updatePath:function(){var t=this.getPathString();t||(t="M0 0"),this._path.setAttribute("d",t)},_initEvents:function(){if(this.options.clickable){(o.Browser.svg||!o.Browser.vml)&&this._path.setAttribute("class","leaflet-clickable"),o.DomEvent.on(this._container,"click",this._onMouseClick,this);for(var t=["dblclick","mousedown","mouseover","mouseout","mousemove","contextmenu"],e=0;e<t.length;e++)o.DomEvent.on(this._container,t[e],this._fireMouseEvent,this)}},_onMouseClick:function(t){this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(t)},_fireMouseEvent:function(t){if(this.hasEventListeners(t.type)){var e=this._map,i=e.mouseEventToContainerPoint(t),n=e.containerPointToLayerPoint(i),s=e.layerPointToLatLng(n);this.fire(t.type,{latlng:s,layerPoint:n,containerPoint:i,originalEvent:t}),"contextmenu"===t.type&&o.DomEvent.preventDefault(t),"mousemove"!==t.type&&o.DomEvent.stopPropagation(t)}}}),o.Map.include({_initPathRoot:function(){this._pathRoot||(this._pathRoot=o.Path.prototype._createElement("svg"),this._panes.overlayPane.appendChild(this._pathRoot),this.options.zoomAnimation&&o.Browser.any3d?(this._pathRoot.setAttribute("class"," leaflet-zoom-animated"),this.on({zoomanim:this._animatePathZoom,zoomend:this._endPathZoom})):this._pathRoot.setAttribute("class"," leaflet-zoom-hide"),this.on("moveend",this._updateSvgViewport),this._updateSvgViewport())},_animatePathZoom:function(t){var e=this.getZoomScale(t.zoom),i=this._getCenterOffset(t.center)._multiplyBy(-e)._add(this._pathViewport.min);this._pathRoot.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(i)+" scale("+e+") ",this._pathZooming=!0},_endPathZoom:function(){this._pathZooming=!1},_updateSvgViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max,n=i.x-e.x,s=i.y-e.y,a=this._pathRoot,r=this._panes.overlayPane;o.Browser.mobileWebkit&&r.removeChild(a),o.DomUtil.setPosition(a,e),a.setAttribute("width",n),a.setAttribute("height",s),a.setAttribute("viewBox",[e.x,e.y,n,s].join(" ")),o.Browser.mobileWebkit&&r.appendChild(a)}}}),o.Path.include({bindPopup:function(t,e){return t instanceof o.Popup?this._popup=t:((!this._popup||e)&&(this._popup=new o.Popup(e,this)),this._popup.setContent(t)),this._popupHandlersAdded||(this.on("click",this._openPopup,this).on("remove",this.closePopup,this),this._popupHandlersAdded=!0),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openPopup).off("remove",this.closePopup),this._popupHandlersAdded=!1),this},openPopup:function(t){return this._popup&&(t=t||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],this._openPopup({latlng:t})),this},closePopup:function(){return this._popup&&this._popup._close(),this},_openPopup:function(t){this._popup.setLatLng(t.latlng),this._map.openPopup(this._popup)}}),o.Browser.vml=!o.Browser.svg&&function(){try{var t=e.createElement("div");t.innerHTML='<v:shape adj="1"/>';var i=t.firstChild;return i.style.behavior="url(#default#VML)",i&&"object"==typeof i.adj}catch(n){return!1}}(),o.Path=o.Browser.svg||!o.Browser.vml?o.Path:o.Path.extend({statics:{VML:!0,CLIP_PADDING:.02},_createElement:function(){try{return e.namespaces.add("lvml","urn:schemas-microsoft-com:vml"),function(t){return e.createElement("<lvml:"+t+' class="lvml">')}}catch(t){return function(t){return e.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="lvml">')}}}(),_initPath:function(){var t=this._container=this._createElement("shape");
-o.DomUtil.addClass(t,"leaflet-vml-shape"),this.options.clickable&&o.DomUtil.addClass(t,"leaflet-clickable"),t.coordsize="1 1",this._path=this._createElement("path"),t.appendChild(this._path),this._map._pathRoot.appendChild(t)},_initStyle:function(){this._updateStyle()},_updateStyle:function(){var t=this._stroke,e=this._fill,i=this.options,n=this._container;n.stroked=i.stroke,n.filled=i.fill,i.stroke?(t||(t=this._stroke=this._createElement("stroke"),t.endcap="round",n.appendChild(t)),t.weight=i.weight+"px",t.color=i.color,t.opacity=i.opacity,t.dashStyle=i.dashArray?i.dashArray instanceof Array?i.dashArray.join(" "):i.dashArray.replace(/( *, *)/g," "):""):t&&(n.removeChild(t),this._stroke=null),i.fill?(e||(e=this._fill=this._createElement("fill"),n.appendChild(e)),e.color=i.fillColor||i.color,e.opacity=i.fillOpacity):e&&(n.removeChild(e),this._fill=null)},_updatePath:function(){var t=this._container.style;t.display="none",this._path.v=this.getPathString()+" ",t.display=""}}),o.Map.include(o.Browser.svg||!o.Browser.vml?{}:{_initPathRoot:function(){if(!this._pathRoot){var t=this._pathRoot=e.createElement("div");t.className="leaflet-vml-container",this._panes.overlayPane.appendChild(t),this.on("moveend",this._updatePathViewport),this._updatePathViewport()}}}),o.Browser.canvas=function(){return!!e.createElement("canvas").getContext}(),o.Path=o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?o.Path:o.Path.extend({statics:{CANVAS:!0,SVG:!1},redraw:function(){return this._map&&(this.projectLatlngs(),this._requestUpdate()),this},setStyle:function(t){return o.setOptions(this,t),this._map&&(this._updateStyle(),this._requestUpdate()),this},onRemove:function(t){t.off("viewreset",this.projectLatlngs,this).off("moveend",this._updatePath,this),this.options.clickable&&(this._map.off("click",this._onClick,this),this._map.off("mousemove",this._onMouseMove,this)),this._requestUpdate(),this._map=null},_requestUpdate:function(){this._map&&!o.Path._updateRequest&&(o.Path._updateRequest=o.Util.requestAnimFrame(this._fireMapMoveEnd,this._map))},_fireMapMoveEnd:function(){o.Path._updateRequest=null,this.fire("moveend")},_initElements:function(){this._map._initPathRoot(),this._ctx=this._map._canvasCtx},_updateStyle:function(){var t=this.options;t.stroke&&(this._ctx.lineWidth=t.weight,this._ctx.strokeStyle=t.color),t.fill&&(this._ctx.fillStyle=t.fillColor||t.color)},_drawPath:function(){var t,e,i,n,s,a;for(this._ctx.beginPath(),t=0,i=this._parts.length;i>t;t++){for(e=0,n=this._parts[t].length;n>e;e++)s=this._parts[t][e],a=(0===e?"move":"line")+"To",this._ctx[a](s.x,s.y);this instanceof o.Polygon&&this._ctx.closePath()}},_checkIfEmpty:function(){return!this._parts.length},_updatePath:function(){if(!this._checkIfEmpty()){var t=this._ctx,e=this.options;this._drawPath(),t.save(),this._updateStyle(),e.fill&&(t.globalAlpha=e.fillOpacity,t.fill()),e.stroke&&(t.globalAlpha=e.opacity,t.stroke()),t.restore()}},_initEvents:function(){this.options.clickable&&(this._map.on("mousemove",this._onMouseMove,this),this._map.on("click",this._onClick,this))},_onClick:function(t){this._containsPoint(t.layerPoint)&&this.fire("click",t)},_onMouseMove:function(t){this._map&&!this._map._animatingZoom&&(this._containsPoint(t.layerPoint)?(this._ctx.canvas.style.cursor="pointer",this._mouseInside=!0,this.fire("mouseover",t)):this._mouseInside&&(this._ctx.canvas.style.cursor="",this._mouseInside=!1,this.fire("mouseout",t)))}}),o.Map.include(o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?{}:{_initPathRoot:function(){var t,i=this._pathRoot;i||(i=this._pathRoot=e.createElement("canvas"),i.style.position="absolute",t=this._canvasCtx=i.getContext("2d"),t.lineCap="round",t.lineJoin="round",this._panes.overlayPane.appendChild(i),this.options.zoomAnimation&&(this._pathRoot.className="leaflet-zoom-animated",this.on("zoomanim",this._animatePathZoom),this.on("zoomend",this._endPathZoom)),this.on("moveend",this._updateCanvasViewport),this._updateCanvasViewport())},_updateCanvasViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max.subtract(e),n=this._pathRoot;o.DomUtil.setPosition(n,e),n.width=i.x,n.height=i.y,n.getContext("2d").translate(-e.x,-e.y)}}}),o.LineUtil={simplify:function(t,e){if(!e||!t.length)return t.slice();var i=e*e;return t=this._reducePoints(t,i),t=this._simplifyDP(t,i)},pointToSegmentDistance:function(t,e,i){return Math.sqrt(this._sqClosestPointOnSegment(t,e,i,!0))},closestPointOnSegment:function(t,e,i){return this._sqClosestPointOnSegment(t,e,i)},_simplifyDP:function(t,e){var n=t.length,o=typeof Uint8Array!=i+""?Uint8Array:Array,s=new o(n);s[0]=s[n-1]=1,this._simplifyDPStep(t,s,e,0,n-1);var a,r=[];for(a=0;n>a;a++)s[a]&&r.push(t[a]);return r},_simplifyDPStep:function(t,e,i,n,o){var s,a,r,h=0;for(a=n+1;o-1>=a;a++)r=this._sqClosestPointOnSegment(t[a],t[n],t[o],!0),r>h&&(s=a,h=r);h>i&&(e[s]=1,this._simplifyDPStep(t,e,i,n,s),this._simplifyDPStep(t,e,i,s,o))},_reducePoints:function(t,e){for(var i=[t[0]],n=1,o=0,s=t.length;s>n;n++)this._sqDist(t[n],t[o])>e&&(i.push(t[n]),o=n);return s-1>o&&i.push(t[s-1]),i},clipSegment:function(t,e,i,n){var o,s,a,r=n?this._lastCode:this._getBitCode(t,i),h=this._getBitCode(e,i);for(this._lastCode=h;;){if(!(r|h))return[t,e];if(r&h)return!1;o=r||h,s=this._getEdgeIntersection(t,e,o,i),a=this._getBitCode(s,i),o===r?(t=s,r=a):(e=s,h=a)}},_getEdgeIntersection:function(t,e,i,n){var s=e.x-t.x,a=e.y-t.y,r=n.min,h=n.max;return 8&i?new o.Point(t.x+s*(h.y-t.y)/a,h.y):4&i?new o.Point(t.x+s*(r.y-t.y)/a,r.y):2&i?new o.Point(h.x,t.y+a*(h.x-t.x)/s):1&i?new o.Point(r.x,t.y+a*(r.x-t.x)/s):void 0},_getBitCode:function(t,e){var i=0;return t.x<e.min.x?i|=1:t.x>e.max.x&&(i|=2),t.y<e.min.y?i|=4:t.y>e.max.y&&(i|=8),i},_sqDist:function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},_sqClosestPointOnSegment:function(t,e,i,n){var s,a=e.x,r=e.y,h=i.x-a,l=i.y-r,u=h*h+l*l;return u>0&&(s=((t.x-a)*h+(t.y-r)*l)/u,s>1?(a=i.x,r=i.y):s>0&&(a+=h*s,r+=l*s)),h=t.x-a,l=t.y-r,n?h*h+l*l:new o.Point(a,r)}},o.Polyline=o.Path.extend({initialize:function(t,e){o.Path.prototype.initialize.call(this,e),this._latlngs=this._convertLatLngs(t)},options:{smoothFactor:1,noClip:!1},projectLatlngs:function(){this._originalPoints=[];for(var t=0,e=this._latlngs.length;e>t;t++)this._originalPoints[t]=this._map.latLngToLayerPoint(this._latlngs[t])},getPathString:function(){for(var t=0,e=this._parts.length,i="";e>t;t++)i+=this._getPathPartStr(this._parts[t]);return i},getLatLngs:function(){return this._latlngs},setLatLngs:function(t){return this._latlngs=this._convertLatLngs(t),this.redraw()},addLatLng:function(t){return this._latlngs.push(o.latLng(t)),this.redraw()},spliceLatLngs:function(){var t=[].splice.apply(this._latlngs,arguments);return this._convertLatLngs(this._latlngs,!0),this.redraw(),t},closestLayerPoint:function(t){for(var e,i,n=1/0,s=this._parts,a=null,r=0,h=s.length;h>r;r++)for(var l=s[r],u=1,c=l.length;c>u;u++){e=l[u-1],i=l[u];var d=o.LineUtil._sqClosestPointOnSegment(t,e,i,!0);n>d&&(n=d,a=o.LineUtil._sqClosestPointOnSegment(t,e,i))}return a&&(a.distance=Math.sqrt(n)),a},getBounds:function(){return new o.LatLngBounds(this.getLatLngs())},_convertLatLngs:function(t,e){var i,n,s=e?t:[];for(i=0,n=t.length;n>i;i++){if(o.Util.isArray(t[i])&&"number"!=typeof t[i][0])return;s[i]=o.latLng(t[i])}return s},_initEvents:function(){o.Path.prototype._initEvents.call(this)},_getPathPartStr:function(t){for(var e,i=o.Path.VML,n=0,s=t.length,a="";s>n;n++)e=t[n],i&&e._round(),a+=(n?"L":"M")+e.x+" "+e.y;return a},_clipPoints:function(){var t,e,i,n=this._originalPoints,s=n.length;if(this.options.noClip)return this._parts=[n],void 0;this._parts=[];var a=this._parts,r=this._map._pathViewport,h=o.LineUtil;for(t=0,e=0;s-1>t;t++)i=h.clipSegment(n[t],n[t+1],r,t),i&&(a[e]=a[e]||[],a[e].push(i[0]),(i[1]!==n[t+1]||t===s-2)&&(a[e].push(i[1]),e++))},_simplifyPoints:function(){for(var t=this._parts,e=o.LineUtil,i=0,n=t.length;n>i;i++)t[i]=e.simplify(t[i],this.options.smoothFactor)},_updatePath:function(){this._map&&(this._clipPoints(),this._simplifyPoints(),o.Path.prototype._updatePath.call(this))}}),o.polyline=function(t,e){return new o.Polyline(t,e)},o.PolyUtil={},o.PolyUtil.clipPolygon=function(t,e){var i,n,s,a,r,h,l,u,c,d=[1,4,2,8],p=o.LineUtil;for(n=0,l=t.length;l>n;n++)t[n]._code=p._getBitCode(t[n],e);for(a=0;4>a;a++){for(u=d[a],i=[],n=0,l=t.length,s=l-1;l>n;s=n++)r=t[n],h=t[s],r._code&u?h._code&u||(c=p._getEdgeIntersection(h,r,u,e),c._code=p._getBitCode(c,e),i.push(c)):(h._code&u&&(c=p._getEdgeIntersection(h,r,u,e),c._code=p._getBitCode(c,e),i.push(c)),i.push(r));t=i}return t},o.Polygon=o.Polyline.extend({options:{fill:!0},initialize:function(t,e){var i,n,s;if(o.Polyline.prototype.initialize.call(this,t,e),t&&o.Util.isArray(t[0])&&"number"!=typeof t[0][0])for(this._latlngs=this._convertLatLngs(t[0]),this._holes=t.slice(1),i=0,n=this._holes.length;n>i;i++)s=this._holes[i]=this._convertLatLngs(this._holes[i]),s[0].equals(s[s.length-1])&&s.pop();t=this._latlngs,t.length>=2&&t[0].equals(t[t.length-1])&&t.pop()},projectLatlngs:function(){if(o.Polyline.prototype.projectLatlngs.call(this),this._holePoints=[],this._holes){var t,e,i,n;for(t=0,i=this._holes.length;i>t;t++)for(this._holePoints[t]=[],e=0,n=this._holes[t].length;n>e;e++)this._holePoints[t][e]=this._map.latLngToLayerPoint(this._holes[t][e])}},_clipPoints:function(){var t=this._originalPoints,e=[];if(this._parts=[t].concat(this._holePoints),!this.options.noClip){for(var i=0,n=this._parts.length;n>i;i++){var s=o.PolyUtil.clipPolygon(this._parts[i],this._map._pathViewport);s.length&&e.push(s)}this._parts=e}},_getPathPartStr:function(t){var e=o.Polyline.prototype._getPathPartStr.call(this,t);return e+(o.Browser.svg?"z":"x")}}),o.polygon=function(t,e){return new o.Polygon(t,e)},function(){function t(t){return o.FeatureGroup.extend({initialize:function(t,e){this._layers={},this._options=e,this.setLatLngs(t)},setLatLngs:function(e){var i=0,n=e.length;for(this.eachLayer(function(t){n>i?t.setLatLngs(e[i++]):this.removeLayer(t)},this);n>i;)this.addLayer(new t(e[i++],this._options));return this},getLatLngs:function(){var t=[];return this.eachLayer(function(e){t.push(e.getLatLngs())}),t}})}o.MultiPolyline=t(o.Polyline),o.MultiPolygon=t(o.Polygon),o.multiPolyline=function(t,e){return new o.MultiPolyline(t,e)},o.multiPolygon=function(t,e){return new o.MultiPolygon(t,e)}}(),o.Rectangle=o.Polygon.extend({initialize:function(t,e){o.Polygon.prototype.initialize.call(this,this._boundsToLatLngs(t),e)},setBounds:function(t){this.setLatLngs(this._boundsToLatLngs(t))},_boundsToLatLngs:function(t){return t=o.latLngBounds(t),[t.getSouthWest(),t.getNorthWest(),t.getNorthEast(),t.getSouthEast()]}}),o.rectangle=function(t,e){return new o.Rectangle(t,e)},o.Circle=o.Path.extend({initialize:function(t,e,i){o.Path.prototype.initialize.call(this,i),this._latlng=o.latLng(t),this._mRadius=e},options:{fill:!0},setLatLng:function(t){return this._latlng=o.latLng(t),this.redraw()},setRadius:function(t){return this._mRadius=t,this.redraw()},projectLatlngs:function(){var t=this._getLngRadius(),e=this._latlng,i=this._map.latLngToLayerPoint([e.lat,e.lng-t]);this._point=this._map.latLngToLayerPoint(e),this._radius=Math.max(this._point.x-i.x,1)},getBounds:function(){var t=this._getLngRadius(),e=360*(this._mRadius/40075017),i=this._latlng;return new o.LatLngBounds([i.lat-e,i.lng-t],[i.lat+e,i.lng+t])},getLatLng:function(){return this._latlng},getPathString:function(){var t=this._point,e=this._radius;return this._checkIfEmpty()?"":o.Browser.svg?"M"+t.x+","+(t.y-e)+"A"+e+","+e+",0,1,1,"+(t.x-.1)+","+(t.y-e)+" z":(t._round(),e=Math.round(e),"AL "+t.x+","+t.y+" "+e+","+e+" 0,"+23592600)},getRadius:function(){return this._mRadius},_getLatRadius:function(){return 360*(this._mRadius/40075017)},_getLngRadius:function(){return this._getLatRadius()/Math.cos(o.LatLng.DEG_TO_RAD*this._latlng.lat)},_checkIfEmpty:function(){if(!this._map)return!1;var t=this._map._pathViewport,e=this._radius,i=this._point;return i.x-e>t.max.x||i.y-e>t.max.y||i.x+e<t.min.x||i.y+e<t.min.y}}),o.circle=function(t,e,i){return new o.Circle(t,e,i)},o.CircleMarker=o.Circle.extend({options:{radius:10,weight:2},initialize:function(t,e){o.Circle.prototype.initialize.call(this,t,null,e),this._radius=this.options.radius},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_updateStyle:function(){o.Circle.prototype._updateStyle.call(this),this.setRadius(this.options.radius)},setRadius:function(t){return this.options.radius=this._radius=t,this.redraw()}}),o.circleMarker=function(t,e){return new o.CircleMarker(t,e)},o.Polyline.include(o.Path.CANVAS?{_containsPoint:function(t,e){var i,n,s,a,r,h,l,u=this.options.weight/2;for(o.Browser.touch&&(u+=10),i=0,a=this._parts.length;a>i;i++)for(l=this._parts[i],n=0,r=l.length,s=r-1;r>n;s=n++)if((e||0!==n)&&(h=o.LineUtil.pointToSegmentDistance(t,l[s],l[n]),u>=h))return!0;return!1}}:{}),o.Polygon.include(o.Path.CANVAS?{_containsPoint:function(t){var e,i,n,s,a,r,h,l,u=!1;if(o.Polyline.prototype._containsPoint.call(this,t,!0))return!0;for(s=0,h=this._parts.length;h>s;s++)for(e=this._parts[s],a=0,l=e.length,r=l-1;l>a;r=a++)i=e[a],n=e[r],i.y>t.y!=n.y>t.y&&t.x<(n.x-i.x)*(t.y-i.y)/(n.y-i.y)+i.x&&(u=!u);return u}}:{}),o.Circle.include(o.Path.CANVAS?{_drawPath:function(){var t=this._point;this._ctx.beginPath(),this._ctx.arc(t.x,t.y,this._radius,0,2*Math.PI,!1)},_containsPoint:function(t){var e=this._point,i=this.options.stroke?this.options.weight/2:0;return t.distanceTo(e)<=this._radius+i}}:{}),o.CircleMarker.include(o.Path.CANVAS?{_updateStyle:function(){o.Path.prototype._updateStyle.call(this)}}:{}),o.GeoJSON=o.FeatureGroup.extend({initialize:function(t,e){o.setOptions(this,e),this._layers={},t&&this.addData(t)},addData:function(t){var e,i,n,s=o.Util.isArray(t)?t:t.features;if(s){for(e=0,i=s.length;i>e;e++)n=s[e],(n.geometries||n.geometry||n.features||n.coordinates)&&this.addData(s[e]);return this}var a=this.options;if(!a.filter||a.filter(t)){var r=o.GeoJSON.geometryToLayer(t,a.pointToLayer,a.coordsToLatLng);return r.feature=o.GeoJSON.asFeature(t),r.defaultOptions=r.options,this.resetStyle(r),a.onEachFeature&&a.onEachFeature(t,r),this.addLayer(r)}},resetStyle:function(t){var e=this.options.style;e&&(o.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(t){this.eachLayer(function(e){this._setLayerStyle(e,t)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)}}),o.extend(o.GeoJSON,{geometryToLayer:function(t,e,i){var n,s,a,r,h,l="Feature"===t.type?t.geometry:t,u=l.coordinates,c=[];switch(i=i||this.coordsToLatLng,l.type){case"Point":return n=i(u),e?e(t,n):new o.Marker(n);case"MultiPoint":for(a=0,r=u.length;r>a;a++)n=i(u[a]),h=e?e(t,n):new o.Marker(n),c.push(h);return new o.FeatureGroup(c);case"LineString":return s=this.coordsToLatLngs(u,0,i),new o.Polyline(s);case"Polygon":return s=this.coordsToLatLngs(u,1,i),new o.Polygon(s);case"MultiLineString":return s=this.coordsToLatLngs(u,1,i),new o.MultiPolyline(s);case"MultiPolygon":return s=this.coordsToLatLngs(u,2,i),new o.MultiPolygon(s);case"GeometryCollection":for(a=0,r=l.geometries.length;r>a;a++)h=this.geometryToLayer({geometry:l.geometries[a],type:"Feature",properties:t.properties},e,i),c.push(h);return new o.FeatureGroup(c);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(t){return new o.LatLng(t[1],t[0])},coordsToLatLngs:function(t,e,i){var n,o,s,a=[];for(o=0,s=t.length;s>o;o++)n=e?this.coordsToLatLngs(t[o],e-1,i):(i||this.coordsToLatLng)(t[o]),a.push(n);return a},latLngToCoords:function(t){return[t.lng,t.lat]},latLngsToCoords:function(t){for(var e=[],i=0,n=t.length;n>i;i++)e.push(o.GeoJSON.latLngToCoords(t[i]));return e},getFeature:function(t,e){return t.feature?o.extend({},t.feature,{geometry:e}):o.GeoJSON.asFeature(e)},asFeature:function(t){return"Feature"===t.type?t:{type:"Feature",properties:{},geometry:t}}});var a={toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"Point",coordinates:o.GeoJSON.latLngToCoords(this.getLatLng())})}};o.Marker.include(a),o.Circle.include(a),o.CircleMarker.include(a),o.Polyline.include({toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"LineString",coordinates:o.GeoJSON.latLngsToCoords(this.getLatLngs())})}}),o.Polygon.include({toGeoJSON:function(){var t,e,i,n=[o.GeoJSON.latLngsToCoords(this.getLatLngs())];if(n[0].push(n[0][0]),this._holes)for(t=0,e=this._holes.length;e>t;t++)i=o.GeoJSON.latLngsToCoords(this._holes[t]),i.push(i[0]),n.push(i);return o.GeoJSON.getFeature(this,{type:"Polygon",coordinates:n})}}),function(){function t(t,e){t.include({toGeoJSON:function(){var t=[];return this.eachLayer(function(e){t.push(e.toGeoJSON().geometry.coordinates)}),o.GeoJSON.getFeature(this,{type:e,coordinates:t})}})}t(o.MultiPolyline,"MultiLineString"),t(o.MultiPolygon,"MultiPolygon")}(),o.LayerGroup.include({toGeoJSON:function(){var t=[];return this.eachLayer(function(e){e.toGeoJSON&&t.push(o.GeoJSON.asFeature(e.toGeoJSON()))}),{type:"FeatureCollection",features:t}}}),o.geoJson=function(t,e){return new o.GeoJSON(t,e)},o.DomEvent={addListener:function(t,e,i,n){var s,a,r,h=o.stamp(i),l="_leaflet_"+e+h;return t[l]?this:(s=function(e){return i.call(n||t,e||o.DomEvent._getEvent())},o.Browser.msTouch&&0===e.indexOf("touch")?this.addMsTouchListener(t,e,s,h):(o.Browser.touch&&"dblclick"===e&&this.addDoubleTapListener&&this.addDoubleTapListener(t,s,h),"addEventListener"in t?"mousewheel"===e?(t.addEventListener("DOMMouseScroll",s,!1),t.addEventListener(e,s,!1)):"mouseenter"===e||"mouseleave"===e?(a=s,r="mouseenter"===e?"mouseover":"mouseout",s=function(e){return o.DomEvent._checkMouse(t,e)?a(e):void 0},t.addEventListener(r,s,!1)):"click"===e&&o.Browser.android?(a=s,s=function(t){return o.DomEvent._filterClick(t,a)},t.addEventListener(e,s,!1)):t.addEventListener(e,s,!1):"attachEvent"in t&&t.attachEvent("on"+e,s),t[l]=s,this))},removeListener:function(t,e,i){var n=o.stamp(i),s="_leaflet_"+e+n,a=t[s];return a?(o.Browser.msTouch&&0===e.indexOf("touch")?this.removeMsTouchListener(t,e,n):o.Browser.touch&&"dblclick"===e&&this.removeDoubleTapListener?this.removeDoubleTapListener(t,n):"removeEventListener"in t?"mousewheel"===e?(t.removeEventListener("DOMMouseScroll",a,!1),t.removeEventListener(e,a,!1)):"mouseenter"===e||"mouseleave"===e?t.removeEventListener("mouseenter"===e?"mouseover":"mouseout",a,!1):t.removeEventListener(e,a,!1):"detachEvent"in t&&t.detachEvent("on"+e,a),t[s]=null,this):this},stopPropagation:function(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this},disableClickPropagation:function(t){for(var e=o.DomEvent.stopPropagation,i=o.Draggable.START.length-1;i>=0;i--)o.DomEvent.addListener(t,o.Draggable.START[i],e);return o.DomEvent.addListener(t,"click",o.DomEvent._fakeStop).addListener(t,"dblclick",e)},preventDefault:function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this},stop:function(t){return o.DomEvent.preventDefault(t).stopPropagation(t)},getMousePosition:function(t,i){var n=o.Browser.ie7,s=e.body,a=e.documentElement,r=t.pageX?t.pageX-s.scrollLeft-a.scrollLeft:t.clientX,h=t.pageY?t.pageY-s.scrollTop-a.scrollTop:t.clientY,l=new o.Point(r,h),u=i.getBoundingClientRect(),c=u.left-i.clientLeft,d=u.top-i.clientTop;return o.DomUtil.documentIsLtr()||!o.Browser.webkit&&!n||(c+=i.scrollWidth-i.clientWidth,n&&"hidden"!==o.DomUtil.getStyle(i,"overflow-y")&&"hidden"!==o.DomUtil.getStyle(i,"overflow")&&(c+=17)),l._subtract(new o.Point(c,d))},getWheelDelta:function(t){var e=0;return t.wheelDelta&&(e=t.wheelDelta/120),t.detail&&(e=-t.detail/3),e},_skipEvents:{},_fakeStop:function(t){o.DomEvent._skipEvents[t.type]=!0},_skipped:function(t){var e=this._skipEvents[t.type];return this._skipEvents[t.type]=!1,e},_checkMouse:function(t,e){var i=e.relatedTarget;if(!i)return!0;try{for(;i&&i!==t;)i=i.parentNode}catch(n){return!1}return i!==t},_getEvent:function(){var e=t.event;if(!e)for(var i=arguments.callee.caller;i&&(e=i.arguments[0],!e||t.Event!==e.constructor);)i=i.caller;return e},_filterClick:function(t,e){var i=t.timeStamp||t.originalEvent.timeStamp,n=o.DomEvent._lastClick&&i-o.DomEvent._lastClick;return n&&n>100&&1e3>n||t.target._simulatedClick&&!t._simulated?(o.DomEvent.stop(t),void 0):(o.DomEvent._lastClick=i,e(t))}},o.DomEvent.on=o.DomEvent.addListener,o.DomEvent.off=o.DomEvent.removeListener,o.Draggable=o.Class.extend({includes:o.Mixin.Events,statics:{START:o.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",MSPointerDown:"touchmove"}},initialize:function(t,e){this._element=t,this._dragStartTarget=e||t},enable:function(){if(!this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.on(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!0}},disable:function(){if(this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.off(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!1,this._moved=!1}},_onDown:function(t){if(!t.shiftKey&&(1===t.which||1===t.button||t.touches)&&(o.DomEvent.stopPropagation(t),!o.Draggable._disabled)){o.DomUtil.disableImageDrag(),o.DomUtil.disableTextSelection();var i=t.touches?t.touches[0]:t,n=i.target;o.Browser.touch&&"a"===n.tagName.toLowerCase()&&o.DomUtil.addClass(n,"leaflet-active"),this._moved=!1,this._moving||(this._startPoint=new o.Point(i.clientX,i.clientY),this._startPos=this._newPos=o.DomUtil.getPosition(this._element),o.DomEvent.on(e,o.Draggable.MOVE[t.type],this._onMove,this).on(e,o.Draggable.END[t.type],this._onUp,this))}},_onMove:function(t){if(!(t.touches&&t.touches.length>1)){var i=t.touches&&1===t.touches.length?t.touches[0]:t,n=new o.Point(i.clientX,i.clientY),s=n.subtract(this._startPoint);(s.x||s.y)&&(o.DomEvent.preventDefault(t),this._moved||(this.fire("dragstart"),this._moved=!0,this._startPos=o.DomUtil.getPosition(this._element).subtract(s),o.Browser.touch||o.DomUtil.addClass(e.body,"leaflet-dragging")),this._newPos=this._startPos.add(s),this._moving=!0,o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updatePosition,this,!0,this._dragStartTarget))}},_updatePosition:function(){this.fire("predrag"),o.DomUtil.setPosition(this._element,this._newPos),this.fire("drag")},_onUp:function(){o.Browser.touch||o.DomUtil.removeClass(e.body,"leaflet-dragging");for(var t in o.Draggable.MOVE)o.DomEvent.off(e,o.Draggable.MOVE[t],this._onMove).off(e,o.Draggable.END[t],this._onUp);o.DomUtil.enableImageDrag(),o.DomUtil.enableTextSelection(),this._moved&&(o.Util.cancelAnimFrame(this._animRequest),this.fire("dragend")),this._moving=!1}}),o.Handler=o.Class.extend({initialize:function(t){this._map=t},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled}}),o.Map.mergeOptions({dragging:!0,inertia:!o.Browser.android23,inertiaDeceleration:3400,inertiaMaxSpeed:1/0,inertiaThreshold:o.Browser.touch?32:18,easeLinearity:.25,worldCopyJump:!1}),o.Map.Drag=o.Handler.extend({addHooks:function(){if(!this._draggable){var t=this._map;this._draggable=new o.Draggable(t._mapPane,t._container),this._draggable.on({dragstart:this._onDragStart,drag:this._onDrag,dragend:this._onDragEnd},this),t.options.worldCopyJump&&(this._draggable.on("predrag",this._onPreDrag,this),t.on("viewreset",this._onViewReset,this),this._onViewReset())}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){var t=this._map;t._panAnim&&t._panAnim.stop(),t.fire("movestart").fire("dragstart"),t.options.inertia&&(this._positions=[],this._times=[])},_onDrag:function(){if(this._map.options.inertia){var t=this._lastTime=+new Date,e=this._lastPos=this._draggable._newPos;this._positions.push(e),this._times.push(t),t-this._times[0]>200&&(this._positions.shift(),this._times.shift())}this._map.fire("move").fire("drag")},_onViewReset:function(){var t=this._map.getSize()._divideBy(2),e=this._map.latLngToLayerPoint([0,0]);this._initialWorldOffset=e.subtract(t).x,this._worldWidth=this._map.project([0,180]).x},_onPreDrag:function(){var t=this._worldWidth,e=Math.round(t/2),i=this._initialWorldOffset,n=this._draggable._newPos.x,o=(n-e+i)%t+e-i,s=(n+e+i)%t-e-i,a=Math.abs(o+i)<Math.abs(s+i)?o:s;this._draggable._newPos.x=a},_onDragEnd:function(){var t=this._map,e=t.options,i=+new Date-this._lastTime,n=!e.inertia||i>e.inertiaThreshold||!this._positions[0];if(t.fire("dragend"),n)t.fire("moveend");else{var s=this._lastPos.subtract(this._positions[0]),a=(this._lastTime+i-this._times[0])/1e3,r=e.easeLinearity,h=s.multiplyBy(r/a),l=h.distanceTo([0,0]),u=Math.min(e.inertiaMaxSpeed,l),c=h.multiplyBy(u/l),d=u/(e.inertiaDeceleration*r),p=c.multiplyBy(-d/2).round();p.x&&p.y?o.Util.requestAnimFrame(function(){t.panBy(p,{duration:d,easeLinearity:r,noMoveStart:!0})}):t.fire("moveend")}}}),o.Map.addInitHook("addHandler","dragging",o.Map.Drag),o.Map.mergeOptions({doubleClickZoom:!0}),o.Map.DoubleClickZoom=o.Handler.extend({addHooks:function(){this._map.on("dblclick",this._onDoubleClick)},removeHooks:function(){this._map.off("dblclick",this._onDoubleClick)},_onDoubleClick:function(t){this.setZoomAround(t.containerPoint,this._zoom+1)}}),o.Map.addInitHook("addHandler","doubleClickZoom",o.Map.DoubleClickZoom),o.Map.mergeOptions({scrollWheelZoom:!0}),o.Map.ScrollWheelZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"mousewheel",this._onWheelScroll,this),o.DomEvent.on(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault),this._delta=0},removeHooks:function(){o.DomEvent.off(this._map._container,"mousewheel",this._onWheelScroll),o.DomEvent.off(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault)},_onWheelScroll:function(t){var e=o.DomEvent.getWheelDelta(t);this._delta+=e,this._lastMousePos=this._map.mouseEventToContainerPoint(t),this._startTime||(this._startTime=+new Date);var i=Math.max(40-(+new Date-this._startTime),0);clearTimeout(this._timer),this._timer=setTimeout(o.bind(this._performZoom,this),i),o.DomEvent.preventDefault(t),o.DomEvent.stopPropagation(t)},_performZoom:function(){var t=this._map,e=this._delta,i=t.getZoom();e=e>0?Math.ceil(e):Math.floor(e),e=Math.max(Math.min(e,4),-4),e=t._limitZoom(i+e)-i,this._delta=0,this._startTime=null,e&&t.setZoomAround(this._lastMousePos,i+e)}}),o.Map.addInitHook("addHandler","scrollWheelZoom",o.Map.ScrollWheelZoom),o.extend(o.DomEvent,{_touchstart:o.Browser.msTouch?"MSPointerDown":"touchstart",_touchend:o.Browser.msTouch?"MSPointerUp":"touchend",addDoubleTapListener:function(t,i,n){function s(t){var e;if(o.Browser.msTouch?(_.push(t.pointerId),e=_.length):e=t.touches.length,!(e>1)){var i=Date.now(),n=i-(r||i);h=t.touches?t.touches[0]:t,l=n>0&&u>=n,r=i}}function a(t){if(o.Browser.msTouch){var e=_.indexOf(t.pointerId);if(-1===e)return;_.splice(e,1)}if(l){if(o.Browser.msTouch){var n,s={};for(var a in h)n=h[a],s[a]="function"==typeof n?n.bind(h):n;h=s}h.type="dblclick",i(h),r=null}}var r,h,l=!1,u=250,c="_leaflet_",d=this._touchstart,p=this._touchend,_=[];t[c+d+n]=s,t[c+p+n]=a;var m=o.Browser.msTouch?e.documentElement:t;return t.addEventListener(d,s,!1),m.addEventListener(p,a,!1),o.Browser.msTouch&&m.addEventListener("MSPointerCancel",a,!1),this},removeDoubleTapListener:function(t,i){var n="_leaflet_";return t.removeEventListener(this._touchstart,t[n+this._touchstart+i],!1),(o.Browser.msTouch?e.documentElement:t).removeEventListener(this._touchend,t[n+this._touchend+i],!1),o.Browser.msTouch&&e.documentElement.removeEventListener("MSPointerCancel",t[n+this._touchend+i],!1),this}}),o.extend(o.DomEvent,{_msTouches:[],_msDocumentListener:!1,addMsTouchListener:function(t,e,i,n){switch(e){case"touchstart":return this.addMsTouchListenerStart(t,e,i,n);case"touchend":return this.addMsTouchListenerEnd(t,e,i,n);case"touchmove":return this.addMsTouchListenerMove(t,e,i,n);default:throw"Unknown touch event type"}},addMsTouchListenerStart:function(t,i,n,o){var s="_leaflet_",a=this._msTouches,r=function(t){for(var e=!1,i=0;i<a.length;i++)if(a[i].pointerId===t.pointerId){e=!0;break}e||a.push(t),t.touches=a.slice(),t.changedTouches=[t],n(t)};if(t[s+"touchstart"+o]=r,t.addEventListener("MSPointerDown",r,!1),!this._msDocumentListener){var h=function(t){for(var e=0;e<a.length;e++)if(a[e].pointerId===t.pointerId){a.splice(e,1);break}};e.documentElement.addEventListener("MSPointerUp",h,!1),e.documentElement.addEventListener("MSPointerCancel",h,!1),this._msDocumentListener=!0}return this},addMsTouchListenerMove:function(t,e,i,n){function o(t){if(t.pointerType!==t.MSPOINTER_TYPE_MOUSE||0!==t.buttons){for(var e=0;e<a.length;e++)if(a[e].pointerId===t.pointerId){a[e]=t;break}t.touches=a.slice(),t.changedTouches=[t],i(t)}}var s="_leaflet_",a=this._msTouches;return t[s+"touchmove"+n]=o,t.addEventListener("MSPointerMove",o,!1),this},addMsTouchListenerEnd:function(t,e,i,n){var o="_leaflet_",s=this._msTouches,a=function(t){for(var e=0;e<s.length;e++)if(s[e].pointerId===t.pointerId){s.splice(e,1);break}t.touches=s.slice(),t.changedTouches=[t],i(t)};return t[o+"touchend"+n]=a,t.addEventListener("MSPointerUp",a,!1),t.addEventListener("MSPointerCancel",a,!1),this},removeMsTouchListener:function(t,e,i){var n="_leaflet_",o=t[n+e+i];switch(e){case"touchstart":t.removeEventListener("MSPointerDown",o,!1);break;case"touchmove":t.removeEventListener("MSPointerMove",o,!1);break;case"touchend":t.removeEventListener("MSPointerUp",o,!1),t.removeEventListener("MSPointerCancel",o,!1)}return this}}),o.Map.mergeOptions({touchZoom:o.Browser.touch&&!o.Browser.android23}),o.Map.TouchZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(t){var i=this._map;if(t.touches&&2===t.touches.length&&!i._animatingZoom&&!this._zooming){var n=i.mouseEventToLayerPoint(t.touches[0]),s=i.mouseEventToLayerPoint(t.touches[1]),a=i._getCenterLayerPoint();this._startCenter=n.add(s)._divideBy(2),this._startDist=n.distanceTo(s),this._moved=!1,this._zooming=!0,this._centerOffset=a.subtract(this._startCenter),i._panAnim&&i._panAnim.stop(),o.DomEvent.on(e,"touchmove",this._onTouchMove,this).on(e,"touchend",this._onTouchEnd,this),o.DomEvent.preventDefault(t)}},_onTouchMove:function(t){var e=this._map;if(t.touches&&2===t.touches.length&&this._zooming){var i=e.mouseEventToLayerPoint(t.touches[0]),n=e.mouseEventToLayerPoint(t.touches[1]);this._scale=i.distanceTo(n)/this._startDist,this._delta=i._add(n)._divideBy(2)._subtract(this._startCenter),1!==this._scale&&(this._moved||(o.DomUtil.addClass(e._mapPane,"leaflet-touching"),e.fire("movestart").fire("zoomstart"),this._moved=!0),o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updateOnMove,this,!0,this._map._container),o.DomEvent.preventDefault(t))}},_updateOnMove:function(){var t=this._map,e=this._getScaleOrigin(),i=t.layerPointToLatLng(e),n=t.getScaleZoom(this._scale);t._animateZoom(i,n,this._startCenter,this._scale,this._delta)},_onTouchEnd:function(){if(!this._moved||!this._zooming)return this._zooming=!1,void 0;var t=this._map;this._zooming=!1,o.DomUtil.removeClass(t._mapPane,"leaflet-touching"),o.Util.cancelAnimFrame(this._animRequest),o.DomEvent.off(e,"touchmove",this._onTouchMove).off(e,"touchend",this._onTouchEnd);var i=this._getScaleOrigin(),n=t.layerPointToLatLng(i),s=t.getZoom(),a=t.getScaleZoom(this._scale)-s,r=a>0?Math.ceil(a):Math.floor(a),h=t._limitZoom(s+r),l=t.getZoomScale(h)/this._scale;t._animateZoom(n,h,i,l)},_getScaleOrigin:function(){var t=this._centerOffset.subtract(this._delta).divideBy(this._scale);return this._startCenter.add(t)}}),o.Map.addInitHook("addHandler","touchZoom",o.Map.TouchZoom),o.Map.mergeOptions({tap:!0,tapTolerance:15}),o.Map.Tap=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onDown,this)
-},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onDown,this)},_onDown:function(t){if(t.touches){if(o.DomEvent.preventDefault(t),this._fireClick=!0,t.touches.length>1)return this._fireClick=!1,clearTimeout(this._holdTimeout),void 0;var i=t.touches[0],n=i.target;this._startPos=this._newPos=new o.Point(i.clientX,i.clientY),"a"===n.tagName.toLowerCase()&&o.DomUtil.addClass(n,"leaflet-active"),this._holdTimeout=setTimeout(o.bind(function(){this._isTapValid()&&(this._fireClick=!1,this._onUp(),this._simulateEvent("contextmenu",i))},this),1e3),o.DomEvent.on(e,"touchmove",this._onMove,this).on(e,"touchend",this._onUp,this)}},_onUp:function(t){if(clearTimeout(this._holdTimeout),o.DomEvent.off(e,"touchmove",this._onMove,this).off(e,"touchend",this._onUp,this),this._fireClick&&t&&t.changedTouches){var i=t.changedTouches[0],n=i.target;"a"===n.tagName.toLowerCase()&&o.DomUtil.removeClass(n,"leaflet-active"),this._isTapValid()&&this._simulateEvent("click",i)}},_isTapValid:function(){return this._newPos.distanceTo(this._startPos)<=this._map.options.tapTolerance},_onMove:function(t){var e=t.touches[0];this._newPos=new o.Point(e.clientX,e.clientY)},_simulateEvent:function(i,n){var o=e.createEvent("MouseEvents");o._simulated=!0,n.target._simulatedClick=!0,o.initMouseEvent(i,!0,!0,t,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(o)}}),o.Browser.touch&&!o.Browser.msTouch&&o.Map.addInitHook("addHandler","tap",o.Map.Tap),o.Map.mergeOptions({boxZoom:!0}),o.Map.BoxZoom=o.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane},addHooks:function(){o.DomEvent.on(this._container,"mousedown",this._onMouseDown,this)},removeHooks:function(){o.DomEvent.off(this._container,"mousedown",this._onMouseDown)},_onMouseDown:function(t){return!t.shiftKey||1!==t.which&&1!==t.button?!1:(o.DomUtil.disableTextSelection(),o.DomUtil.disableImageDrag(),this._startLayerPoint=this._map.mouseEventToLayerPoint(t),this._box=o.DomUtil.create("div","leaflet-zoom-box",this._pane),o.DomUtil.setPosition(this._box,this._startLayerPoint),this._container.style.cursor="crosshair",o.DomEvent.on(e,"mousemove",this._onMouseMove,this).on(e,"mouseup",this._onMouseUp,this).on(e,"keydown",this._onKeyDown,this),this._map.fire("boxzoomstart"),void 0)},_onMouseMove:function(t){var e=this._startLayerPoint,i=this._box,n=this._map.mouseEventToLayerPoint(t),s=n.subtract(e),a=new o.Point(Math.min(n.x,e.x),Math.min(n.y,e.y));o.DomUtil.setPosition(i,a),i.style.width=Math.max(0,Math.abs(s.x)-4)+"px",i.style.height=Math.max(0,Math.abs(s.y)-4)+"px"},_finish:function(){this._pane.removeChild(this._box),this._container.style.cursor="",o.DomUtil.enableTextSelection(),o.DomUtil.enableImageDrag(),o.DomEvent.off(e,"mousemove",this._onMouseMove).off(e,"mouseup",this._onMouseUp).off(e,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finish();var e=this._map,i=e.mouseEventToLayerPoint(t);if(!this._startLayerPoint.equals(i)){var n=new o.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(i));e.fitBounds(n),e.fire("boxzoomend",{boxZoomBounds:n})}},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),o.Map.addInitHook("addHandler","boxZoom",o.Map.BoxZoom),o.Map.mergeOptions({keyboard:!0,keyboardPanOffset:80,keyboardZoomOffset:1}),o.Map.Keyboard=o.Handler.extend({keyCodes:{left:[37],right:[39],down:[40],up:[38],zoomIn:[187,107,61],zoomOut:[189,109,173]},initialize:function(t){this._map=t,this._setPanOffset(t.options.keyboardPanOffset),this._setZoomOffset(t.options.keyboardZoomOffset)},addHooks:function(){var t=this._map._container;-1===t.tabIndex&&(t.tabIndex="0"),o.DomEvent.on(t,"focus",this._onFocus,this).on(t,"blur",this._onBlur,this).on(t,"mousedown",this._onMouseDown,this),this._map.on("focus",this._addHooks,this).on("blur",this._removeHooks,this)},removeHooks:function(){this._removeHooks();var t=this._map._container;o.DomEvent.off(t,"focus",this._onFocus,this).off(t,"blur",this._onBlur,this).off(t,"mousedown",this._onMouseDown,this),this._map.off("focus",this._addHooks,this).off("blur",this._removeHooks,this)},_onMouseDown:function(){if(!this._focused){var i=e.body,n=e.documentElement,o=i.scrollTop||n.scrollTop,s=i.scrollLeft||n.scrollLeft;this._map._container.focus(),t.scrollTo(s,o)}},_onFocus:function(){this._focused=!0,this._map.fire("focus")},_onBlur:function(){this._focused=!1,this._map.fire("blur")},_setPanOffset:function(t){var e,i,n=this._panKeys={},o=this.keyCodes;for(e=0,i=o.left.length;i>e;e++)n[o.left[e]]=[-1*t,0];for(e=0,i=o.right.length;i>e;e++)n[o.right[e]]=[t,0];for(e=0,i=o.down.length;i>e;e++)n[o.down[e]]=[0,t];for(e=0,i=o.up.length;i>e;e++)n[o.up[e]]=[0,-1*t]},_setZoomOffset:function(t){var e,i,n=this._zoomKeys={},o=this.keyCodes;for(e=0,i=o.zoomIn.length;i>e;e++)n[o.zoomIn[e]]=t;for(e=0,i=o.zoomOut.length;i>e;e++)n[o.zoomOut[e]]=-t},_addHooks:function(){o.DomEvent.on(e,"keydown",this._onKeyDown,this)},_removeHooks:function(){o.DomEvent.off(e,"keydown",this._onKeyDown,this)},_onKeyDown:function(t){var e=t.keyCode,i=this._map;if(e in this._panKeys){if(i._panAnim&&i._panAnim._inProgress)return;i.panBy(this._panKeys[e]),i.options.maxBounds&&i.panInsideBounds(i.options.maxBounds)}else{if(!(e in this._zoomKeys))return;i.setZoom(i.getZoom()+this._zoomKeys[e])}o.DomEvent.stop(t)}}),o.Map.addInitHook("addHandler","keyboard",o.Map.Keyboard),o.Handler.MarkerDrag=o.Handler.extend({initialize:function(t){this._marker=t},addHooks:function(){var t=this._marker._icon;this._draggable||(this._draggable=new o.Draggable(t,t)),this._draggable.on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this),this._draggable.enable()},removeHooks:function(){this._draggable.off("dragstart",this._onDragStart,this).off("drag",this._onDrag,this).off("dragend",this._onDragEnd,this),this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){this._marker.closePopup().fire("movestart").fire("dragstart")},_onDrag:function(){var t=this._marker,e=t._shadow,i=o.DomUtil.getPosition(t._icon),n=t._map.layerPointToLatLng(i);e&&o.DomUtil.setPosition(e,i),t._latlng=n,t.fire("move",{latlng:n}).fire("drag")},_onDragEnd:function(){this._marker.fire("moveend").fire("dragend")}}),o.Control=o.Class.extend({options:{position:"topright"},initialize:function(t){o.setOptions(this,t)},getPosition:function(){return this.options.position},setPosition:function(t){var e=this._map;return e&&e.removeControl(this),this.options.position=t,e&&e.addControl(this),this},getContainer:function(){return this._container},addTo:function(t){this._map=t;var e=this._container=this.onAdd(t),i=this.getPosition(),n=t._controlCorners[i];return o.DomUtil.addClass(e,"leaflet-control"),-1!==i.indexOf("bottom")?n.insertBefore(e,n.firstChild):n.appendChild(e),this},removeFrom:function(t){var e=this.getPosition(),i=t._controlCorners[e];return i.removeChild(this._container),this._map=null,this.onRemove&&this.onRemove(t),this}}),o.control=function(t){return new o.Control(t)},o.Map.include({addControl:function(t){return t.addTo(this),this},removeControl:function(t){return t.removeFrom(this),this},_initControlPos:function(){function t(t,s){var a=i+t+" "+i+s;e[t+s]=o.DomUtil.create("div",a,n)}var e=this._controlCorners={},i="leaflet-",n=this._controlContainer=o.DomUtil.create("div",i+"control-container",this._container);t("top","left"),t("top","right"),t("bottom","left"),t("bottom","right")},_clearControlPos:function(){this._container.removeChild(this._controlContainer)}}),o.Control.Zoom=o.Control.extend({options:{position:"topleft"},onAdd:function(t){var e="leaflet-control-zoom",i=o.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._zoomInButton=this._createButton("+","Zoom in",e+"-in",i,this._zoomIn,this),this._zoomOutButton=this._createButton("-","Zoom out",e+"-out",i,this._zoomOut,this),t.on("zoomend zoomlevelschange",this._updateDisabled,this),i},onRemove:function(t){t.off("zoomend zoomlevelschange",this._updateDisabled,this)},_zoomIn:function(t){this._map.zoomIn(t.shiftKey?3:1)},_zoomOut:function(t){this._map.zoomOut(t.shiftKey?3:1)},_createButton:function(t,e,i,n,s,a){var r=o.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var h=o.DomEvent.stopPropagation;return o.DomEvent.on(r,"click",h).on(r,"mousedown",h).on(r,"dblclick",h).on(r,"click",o.DomEvent.preventDefault).on(r,"click",s,a),r},_updateDisabled:function(){var t=this._map,e="leaflet-disabled";o.DomUtil.removeClass(this._zoomInButton,e),o.DomUtil.removeClass(this._zoomOutButton,e),t._zoom===t.getMinZoom()&&o.DomUtil.addClass(this._zoomOutButton,e),t._zoom===t.getMaxZoom()&&o.DomUtil.addClass(this._zoomInButton,e)}}),o.Map.mergeOptions({zoomControl:!0}),o.Map.addInitHook(function(){this.options.zoomControl&&(this.zoomControl=new o.Control.Zoom,this.addControl(this.zoomControl))}),o.control.zoom=function(t){return new o.Control.Zoom(t)},o.Control.Attribution=o.Control.extend({options:{position:"bottomright",prefix:'<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>'},initialize:function(t){o.setOptions(this,t),this._attributions={}},onAdd:function(t){return this._container=o.DomUtil.create("div","leaflet-control-attribution"),o.DomEvent.disableClickPropagation(this._container),t.on("layeradd",this._onLayerAdd,this).on("layerremove",this._onLayerRemove,this),this._update(),this._container},onRemove:function(t){t.off("layeradd",this._onLayerAdd).off("layerremove",this._onLayerRemove)},setPrefix:function(t){return this.options.prefix=t,this._update(),this},addAttribution:function(t){return t?(this._attributions[t]||(this._attributions[t]=0),this._attributions[t]++,this._update(),this):void 0},removeAttribution:function(t){return t?(this._attributions[t]&&(this._attributions[t]--,this._update()),this):void 0},_update:function(){if(this._map){var t=[];for(var e in this._attributions)this._attributions[e]&&t.push(e);var i=[];this.options.prefix&&i.push(this.options.prefix),t.length&&i.push(t.join(", ")),this._container.innerHTML=i.join(" | ")}},_onLayerAdd:function(t){t.layer.getAttribution&&this.addAttribution(t.layer.getAttribution())},_onLayerRemove:function(t){t.layer.getAttribution&&this.removeAttribution(t.layer.getAttribution())}}),o.Map.mergeOptions({attributionControl:!0}),o.Map.addInitHook(function(){this.options.attributionControl&&(this.attributionControl=(new o.Control.Attribution).addTo(this))}),o.control.attribution=function(t){return new o.Control.Attribution(t)},o.Control.Scale=o.Control.extend({options:{position:"bottomleft",maxWidth:100,metric:!0,imperial:!0,updateWhenIdle:!1},onAdd:function(t){this._map=t;var e="leaflet-control-scale",i=o.DomUtil.create("div",e),n=this.options;return this._addScales(n,e,i),t.on(n.updateWhenIdle?"moveend":"move",this._update,this),t.whenReady(this._update,this),i},onRemove:function(t){t.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScales:function(t,e,i){t.metric&&(this._mScale=o.DomUtil.create("div",e+"-line",i)),t.imperial&&(this._iScale=o.DomUtil.create("div",e+"-line",i))},_update:function(){var t=this._map.getBounds(),e=t.getCenter().lat,i=6378137*Math.PI*Math.cos(e*Math.PI/180),n=i*(t.getNorthEast().lng-t.getSouthWest().lng)/180,o=this._map.getSize(),s=this.options,a=0;o.x>0&&(a=n*(s.maxWidth/o.x)),this._updateScales(s,a)},_updateScales:function(t,e){t.metric&&e&&this._updateMetric(e),t.imperial&&e&&this._updateImperial(e)},_updateMetric:function(t){var e=this._getRoundNum(t);this._mScale.style.width=this._getScaleWidth(e/t)+"px",this._mScale.innerHTML=1e3>e?e+" m":e/1e3+" km"},_updateImperial:function(t){var e,i,n,o=3.2808399*t,s=this._iScale;o>5280?(e=o/5280,i=this._getRoundNum(e),s.style.width=this._getScaleWidth(i/e)+"px",s.innerHTML=i+" mi"):(n=this._getRoundNum(o),s.style.width=this._getScaleWidth(n/o)+"px",s.innerHTML=n+" ft")},_getScaleWidth:function(t){return Math.round(this.options.maxWidth*t)-10},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,e*i}}),o.control.scale=function(t){return new o.Control.Scale(t)},o.Control.Layers=o.Control.extend({options:{collapsed:!0,position:"topright",autoZIndex:!0},initialize:function(t,e,i){o.setOptions(this,i),this._layers={},this._lastZIndex=0,this._handlingClick=!1;for(var n in t)this._addLayer(t[n],n);for(n in e)this._addLayer(e[n],n,!0)},onAdd:function(t){return this._initLayout(),this._update(),t.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},onRemove:function(t){t.off("layeradd",this._onLayerChange).off("layerremove",this._onLayerChange)},addBaseLayer:function(t,e){return this._addLayer(t,e),this._update(),this},addOverlay:function(t,e){return this._addLayer(t,e,!0),this._update(),this},removeLayer:function(t){var e=o.stamp(t);return delete this._layers[e],this._update(),this},_initLayout:function(){var t="leaflet-control-layers",e=this._container=o.DomUtil.create("div",t);e.setAttribute("aria-haspopup",!0),o.Browser.touch?o.DomEvent.on(e,"click",o.DomEvent.stopPropagation):(o.DomEvent.disableClickPropagation(e),o.DomEvent.on(e,"mousewheel",o.DomEvent.stopPropagation));var i=this._form=o.DomUtil.create("form",t+"-list");if(this.options.collapsed){o.Browser.android||o.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var n=this._layersLink=o.DomUtil.create("a",t+"-toggle",e);n.href="#",n.title="Layers",o.Browser.touch?o.DomEvent.on(n,"click",o.DomEvent.stop).on(n,"click",this._expand,this):o.DomEvent.on(n,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();this._baseLayersList=o.DomUtil.create("div",t+"-base",i),this._separator=o.DomUtil.create("div",t+"-separator",i),this._overlaysList=o.DomUtil.create("div",t+"-overlays",i),e.appendChild(i)},_addLayer:function(t,e,i){var n=o.stamp(t);this._layers[n]={layer:t,name:e,overlay:i},this.options.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex))},_update:function(){if(this._container){this._baseLayersList.innerHTML="",this._overlaysList.innerHTML="";var t,e,i=!1,n=!1;for(t in this._layers)e=this._layers[t],this._addItem(e),n=n||e.overlay,i=i||!e.overlay;this._separator.style.display=n&&i?"":"none"}},_onLayerChange:function(t){var e=this._layers[o.stamp(t.layer)];if(e){this._handlingClick||this._update();var i=e.overlay?"layeradd"===t.type?"overlayadd":"overlayremove":"layeradd"===t.type?"baselayerchange":null;i&&this._map.fire(i,e)}},_createRadioElement:function(t,i){var n='<input type="radio" class="leaflet-control-layers-selector" name="'+t+'"';i&&(n+=' checked="checked"'),n+="/>";var o=e.createElement("div");return o.innerHTML=n,o.firstChild},_addItem:function(t){var i,n=e.createElement("label"),s=this._map.hasLayer(t.layer);t.overlay?(i=e.createElement("input"),i.type="checkbox",i.className="leaflet-control-layers-selector",i.defaultChecked=s):i=this._createRadioElement("leaflet-base-layers",s),i.layerId=o.stamp(t.layer),o.DomEvent.on(i,"click",this._onInputClick,this);var a=e.createElement("span");a.innerHTML=" "+t.name,n.appendChild(i),n.appendChild(a);var r=t.overlay?this._overlaysList:this._baseLayersList;return r.appendChild(n),n},_onInputClick:function(){var t,e,i,n=this._form.getElementsByTagName("input"),o=n.length;for(this._handlingClick=!0,t=0;o>t;t++)e=n[t],i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?this._map.addLayer(i.layer):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer);this._handlingClick=!1},_expand:function(){o.DomUtil.addClass(this._container,"leaflet-control-layers-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-layers-expanded","")}}),o.control.layers=function(t,e,i){return new o.Control.Layers(t,e,i)},o.PosAnimation=o.Class.extend({includes:o.Mixin.Events,run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._newPos=e,this.fire("start"),t.style[o.DomUtil.TRANSITION]="all "+(i||.25)+"s cubic-bezier(0,0,"+(n||.5)+",1)",o.DomEvent.on(t,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),o.DomUtil.setPosition(t,e),o.Util.falseFn(t.offsetWidth),this._stepTimer=setInterval(o.bind(this._onStep,this),50)},stop:function(){this._inProgress&&(o.DomUtil.setPosition(this._el,this._getPos()),this._onTransitionEnd(),o.Util.falseFn(this._el.offsetWidth))},_onStep:function(){var t=this._getPos();return t?(this._el._leaflet_pos=t,this.fire("step"),void 0):(this._onTransitionEnd(),void 0)},_transformRe:/([-+]?(?:\d*\.)?\d+)\D*, ([-+]?(?:\d*\.)?\d+)\D*\)/,_getPos:function(){var e,i,n,s=this._el,a=t.getComputedStyle(s);if(o.Browser.any3d){if(n=a[o.DomUtil.TRANSFORM].match(this._transformRe),!n)return;e=parseFloat(n[1]),i=parseFloat(n[2])}else e=parseFloat(a.left),i=parseFloat(a.top);return new o.Point(e,i,!0)},_onTransitionEnd:function(){o.DomEvent.off(this._el,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),this._inProgress&&(this._inProgress=!1,this._el.style[o.DomUtil.TRANSITION]="",this._el._leaflet_pos=this._newPos,clearInterval(this._stepTimer),this.fire("step").fire("end"))}}),o.Map.include({setView:function(t,e,n){if(e=this._limitZoom(e),t=o.latLng(t),n=n||{},this._panAnim&&this._panAnim.stop(),this._loaded&&!n.reset&&n!==!0){n.animate!==i&&(n.zoom=o.extend({animate:n.animate},n.zoom),n.pan=o.extend({animate:n.animate},n.pan));var s=this._zoom!==e?this._tryAnimatedZoom&&this._tryAnimatedZoom(t,e,n.zoom):this._tryAnimatedPan(t,n.pan);if(s)return clearTimeout(this._sizeTimer),this}return this._resetView(t,e),this},panBy:function(t,e){if(t=o.point(t).round(),e=e||{},!t.x&&!t.y)return this;if(this._panAnim||(this._panAnim=new o.PosAnimation,this._panAnim.on({step:this._onPanTransitionStep,end:this._onPanTransitionEnd},this)),e.noMoveStart||this.fire("movestart"),e.animate!==!1){o.DomUtil.addClass(this._mapPane,"leaflet-pan-anim");var i=this._getMapPanePos().subtract(t);this._panAnim.run(this._mapPane,i,e.duration||.25,e.easeLinearity)}else this._rawPanBy(t),this.fire("move").fire("moveend");return this},_onPanTransitionStep:function(){this.fire("move")},_onPanTransitionEnd:function(){o.DomUtil.removeClass(this._mapPane,"leaflet-pan-anim"),this.fire("moveend")},_tryAnimatedPan:function(t,e){var i=this._getCenterOffset(t)._floor();return(e&&e.animate)===!0||this.getSize().contains(i)?(this.panBy(i,e),!0):!1}}),o.PosAnimation=o.DomUtil.TRANSITION?o.PosAnimation:o.PosAnimation.extend({run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._duration=i||.25,this._easeOutPower=1/Math.max(n||.5,.2),this._startPos=o.DomUtil.getPosition(t),this._offset=e.subtract(this._startPos),this._startTime=+new Date,this.fire("start"),this._animate()},stop:function(){this._inProgress&&(this._step(),this._complete())},_animate:function(){this._animId=o.Util.requestAnimFrame(this._animate,this),this._step()},_step:function(){var t=+new Date-this._startTime,e=1e3*this._duration;e>t?this._runFrame(this._easeOut(t/e)):(this._runFrame(1),this._complete())},_runFrame:function(t){var e=this._startPos.add(this._offset.multiplyBy(t));o.DomUtil.setPosition(this._el,e),this.fire("step")},_complete:function(){o.Util.cancelAnimFrame(this._animId),this._inProgress=!1,this.fire("end")},_easeOut:function(t){return 1-Math.pow(1-t,this._easeOutPower)}}),o.Map.mergeOptions({zoomAnimation:!0,zoomAnimationThreshold:4}),o.DomUtil.TRANSITION&&o.Map.addInitHook(function(){this._zoomAnimated=this.options.zoomAnimation&&o.DomUtil.TRANSITION&&o.Browser.any3d&&!o.Browser.android23&&!o.Browser.mobileOpera,this._zoomAnimated&&o.DomEvent.on(this._mapPane,o.DomUtil.TRANSITION_END,this._catchTransitionEnd,this)}),o.Map.include(o.DomUtil.TRANSITION?{_catchTransitionEnd:function(){this._animatingZoom&&this._onZoomTransitionEnd()},_nothingToAnimate:function(){return!this._container.getElementsByClassName("leaflet-zoom-animated").length},_tryAnimatedZoom:function(t,e,i){if(this._animatingZoom)return!0;if(i=i||{},!this._zoomAnimated||i.animate===!1||this._nothingToAnimate()||Math.abs(e-this._zoom)>this.options.zoomAnimationThreshold)return!1;var n=this.getZoomScale(e),o=this._getCenterOffset(t)._divideBy(1-1/n),s=this._getCenterLayerPoint()._add(o);return i.animate===!0||this.getSize().contains(o)?(this.fire("movestart").fire("zoomstart"),this._animateZoom(t,e,s,n,null,!0),!0):!1},_animateZoom:function(t,e,i,n,s,a){this._animatingZoom=!0,o.DomUtil.addClass(this._mapPane,"leaflet-zoom-anim"),this._animateToCenter=t,this._animateToZoom=e,o.Draggable&&(o.Draggable._disabled=!0),this.fire("zoomanim",{center:t,zoom:e,origin:i,scale:n,delta:s,backwards:a})},_onZoomTransitionEnd:function(){this._animatingZoom=!1,o.DomUtil.removeClass(this._mapPane,"leaflet-zoom-anim"),this._resetView(this._animateToCenter,this._animateToZoom,!0,!0),o.Draggable&&(o.Draggable._disabled=!1)}}:{}),o.TileLayer.include({_animateZoom:function(t){this._animating||(this._animating=!0,this._prepareBgBuffer());var e=this._bgBuffer,i=o.DomUtil.TRANSFORM,n=t.delta?o.DomUtil.getTranslateString(t.delta):e.style[i],s=o.DomUtil.getScaleString(t.scale,t.origin);e.style[i]=t.backwards?s+" "+n:n+" "+s},_endZoomAnim:function(){var t=this._tileContainer,e=this._bgBuffer;t.style.visibility="",t.parentNode.appendChild(t),o.Util.falseFn(e.offsetWidth),this._animating=!1},_clearBgBuffer:function(){var t=this._map;!t||t._animatingZoom||t.touchZoom._zooming||(this._bgBuffer.innerHTML="",this._bgBuffer.style[o.DomUtil.TRANSFORM]="")},_prepareBgBuffer:function(){var t=this._tileContainer,e=this._bgBuffer,i=this._getLoadedTilesPercentage(e),n=this._getLoadedTilesPercentage(t);return e&&i>.5&&.5>n?(t.style.visibility="hidden",this._stopLoadingImages(t),void 0):(e.style.visibility="hidden",e.style[o.DomUtil.TRANSFORM]="",this._tileContainer=e,e=this._bgBuffer=t,this._stopLoadingImages(e),clearTimeout(this._clearBgBufferTimer),void 0)},_getLoadedTilesPercentage:function(t){var e,i,n=t.getElementsByTagName("img"),o=0;for(e=0,i=n.length;i>e;e++)n[e].complete&&o++;return o/i},_stopLoadingImages:function(t){var e,i,n,s=Array.prototype.slice.call(t.getElementsByTagName("img"));for(e=0,i=s.length;i>e;e++)n=s[e],n.complete||(n.onload=o.Util.falseFn,n.onerror=o.Util.falseFn,n.src=o.Util.emptyImageUrl,n.parentNode.removeChild(n))}}),o.Map.include({_defaultLocateOptions:{watch:!1,setView:!1,maxZoom:1/0,timeout:1e4,maximumAge:0,enableHighAccuracy:!1},locate:function(t){if(t=this._locateOptions=o.extend(this._defaultLocateOptions,t),!navigator.geolocation)return this._handleGeolocationError({code:0,message:"Geolocation not supported."}),this;var e=o.bind(this._handleGeolocationResponse,this),i=o.bind(this._handleGeolocationError,this);return t.watch?this._locationWatchId=navigator.geolocation.watchPosition(e,i,t):navigator.geolocation.getCurrentPosition(e,i,t),this},stopLocate:function(){return navigator.geolocation&&navigator.geolocation.clearWatch(this._locationWatchId),this._locateOptions&&(this._locateOptions.setView=!1),this},_handleGeolocationError:function(t){var e=t.code,i=t.message||(1===e?"permission denied":2===e?"position unavailable":"timeout");this._locateOptions.setView&&!this._loaded&&this.fitWorld(),this.fire("locationerror",{code:e,message:"Geolocation error: "+i+"."})},_handleGeolocationResponse:function(t){var e=t.coords.latitude,i=t.coords.longitude,n=new o.LatLng(e,i),s=180*t.coords.accuracy/40075017,a=s/Math.cos(o.LatLng.DEG_TO_RAD*e),r=o.latLngBounds([e-s,i-a],[e+s,i+a]),h=this._locateOptions;if(h.setView){var l=Math.min(this.getBoundsZoom(r),h.maxZoom);this.setView(n,l)}var u={latlng:n,bounds:r};for(var c in t.coords)"number"==typeof t.coords[c]&&(u[c]=t.coords[c]);this.fire("locationfound",u)}})}(window,document);
\ No newline at end of file
+!function(t,e,i){var n=t.L,o={};o.version="0.7.2","object"==typeof module&&"object"==typeof module.exports?module.exports=o:"function"==typeof define&&define.amd&&define(o),o.noConflict=function(){return t.L=n,this},t.L=o,o.Util={extend:function(t){var e,i,n,o,s=Array.prototype.slice.call(arguments,1);for(i=0,n=s.length;n>i;i++){o=s[i]||{};for(e in o)o.hasOwnProperty(e)&&(t[e]=o[e])}return t},bind:function(t,e){var i=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(e,i||arguments)}},stamp:function(){var t=0,e="_leaflet_id";return function(i){return i[e]=i[e]||++t,i[e]}}(),invokeEach:function(t,e,i){var n,o;if("object"==typeof t){o=Array.prototype.slice.call(arguments,3);for(n in t)e.apply(i,[n,t[n]].concat(o));return!0}return!1},limitExecByInterval:function(t,e,i){var n,o;return function s(){var a=arguments;return n?void(o=!0):(n=!0,setTimeout(function(){n=!1,o&&(s.apply(i,a),o=!1)},e),void t.apply(i,a))}},falseFn:function(){return!1},formatNum:function(t,e){var i=Math.pow(10,e||5);return Math.round(t*i)/i},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return o.Util.trim(t).split(/\s+/)},setOptions:function(t,e){return t.options=o.extend({},t.options,e),t.options},getParamString:function(t,e,i){var n=[];for(var o in t)n.push(encodeURIComponent(i?o.toUpperCase():o)+"="+encodeURIComponent(t[o]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")},template:function(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,n){var o=e[n];if(o===i)throw new Error("No value provided for variable "+t);return"function"==typeof o&&(o=o(e)),o})},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function e(e){var i,n,o=["webkit","moz","o","ms"];for(i=0;i<o.length&&!n;i++)n=t[o[i]+e];return n}function i(e){var i=+new Date,o=Math.max(0,16-(i-n));return n=i+o,t.setTimeout(e,o)}var n=0,s=t.requestAnimationFrame||e("RequestAnimationFrame")||i,a=t.cancelAnimationFrame||e("CancelAnimationFrame")||e("CancelRequestAnimationFrame")||function(e){t.clearTimeout(e)};o.Util.requestAnimFrame=function(e,n,a,r){return e=o.bind(e,n),a&&s===i?void e():s.call(t,e,r)},o.Util.cancelAnimFrame=function(e){e&&a.call(t,e)}}(),o.extend=o.Util.extend,o.bind=o.Util.bind,o.stamp=o.Util.stamp,o.setOptions=o.Util.setOptions,o.Class=function(){},o.Class.extend=function(t){var e=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},i=function(){};i.prototype=this.prototype;var n=new i;n.constructor=e,e.prototype=n;for(var s in this)this.hasOwnProperty(s)&&"prototype"!==s&&(e[s]=this[s]);t.statics&&(o.extend(e,t.statics),delete t.statics),t.includes&&(o.Util.extend.apply(null,[n].concat(t.includes)),delete t.includes),t.options&&n.options&&(t.options=o.extend({},n.options,t.options)),o.extend(n,t),n._initHooks=[];var a=this;return e.__super__=a.prototype,n.callInitHooks=function(){if(!this._initHooksCalled){a.prototype.callInitHooks&&a.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=n._initHooks.length;e>t;t++)n._initHooks[t].call(this)}},e},o.Class.include=function(t){o.extend(this.prototype,t)},o.Class.mergeOptions=function(t){o.extend(this.prototype.options,t)},o.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i)};var s="_leaflet_events";o.Mixin={},o.Mixin.Events={addEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addEventListener,this,e,i))return this;var n,a,r,h,l,u,c,d=this[s]=this[s]||{},p=i&&i!==this&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,a=t.length;a>n;n++)r={action:e,context:i||this},h=t[n],p?(l=h+"_idx",u=l+"_len",c=d[l]=d[l]||{},c[p]||(c[p]=[],d[u]=(d[u]||0)+1),c[p].push(r)):(d[h]=d[h]||[],d[h].push(r));return this},hasEventListeners:function(t){var e=this[s];return!!e&&(t in e&&e[t].length>0||t+"_idx"in e&&e[t+"_idx_len"]>0)},removeEventListener:function(t,e,i){if(!this[s])return this;if(!t)return this.clearAllEventListeners();if(o.Util.invokeEach(t,this.removeEventListener,this,e,i))return this;var n,a,r,h,l,u,c,d,p,_=this[s],m=i&&i!==this&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,a=t.length;a>n;n++)if(r=t[n],u=r+"_idx",c=u+"_len",d=_[u],e){if(h=m&&d?d[m]:_[r]){for(l=h.length-1;l>=0;l--)h[l].action!==e||i&&h[l].context!==i||(p=h.splice(l,1),p[0].action=o.Util.falseFn);i&&d&&0===h.length&&(delete d[m],_[c]--)}}else delete _[r],delete _[u],delete _[c];return this},clearAllEventListeners:function(){return delete this[s],this},fireEvent:function(t,e){if(!this.hasEventListeners(t))return this;var i,n,a,r,h,l=o.Util.extend({},e,{type:t,target:this}),u=this[s];if(u[t])for(i=u[t].slice(),n=0,a=i.length;a>n;n++)i[n].action.call(i[n].context,l);r=u[t+"_idx"];for(h in r)if(i=r[h].slice())for(n=0,a=i.length;a>n;n++)i[n].action.call(i[n].context,l);return this},addOneTimeEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addOneTimeEventListener,this,e,i))return this;var n=o.bind(function(){this.removeEventListener(t,e,i).removeEventListener(t,n,i)},this);return this.addEventListener(t,e,i).addEventListener(t,n,i)}},o.Mixin.Events.on=o.Mixin.Events.addEventListener,o.Mixin.Events.off=o.Mixin.Events.removeEventListener,o.Mixin.Events.once=o.Mixin.Events.addOneTimeEventListener,o.Mixin.Events.fire=o.Mixin.Events.fireEvent,function(){var n="ActiveXObject"in t,s=n&&!e.addEventListener,a=navigator.userAgent.toLowerCase(),r=-1!==a.indexOf("webkit"),h=-1!==a.indexOf("chrome"),l=-1!==a.indexOf("phantom"),u=-1!==a.indexOf("android"),c=-1!==a.search("android [23]"),d=-1!==a.indexOf("gecko"),p=typeof orientation!=i+"",_=t.navigator&&t.navigator.msPointerEnabled&&t.navigator.msMaxTouchPoints&&!t.PointerEvent,m=t.PointerEvent&&t.navigator.pointerEnabled&&t.navigator.maxTouchPoints||_,f="devicePixelRatio"in t&&t.devicePixelRatio>1||"matchMedia"in t&&t.matchMedia("(min-resolution:144dpi)")&&t.matchMedia("(min-resolution:144dpi)").matches,g=e.documentElement,v=n&&"transition"in g.style,y="WebKitCSSMatrix"in t&&"m11"in new t.WebKitCSSMatrix&&!c,P="MozPerspective"in g.style,L="OTransition"in g.style,x=!t.L_DISABLE_3D&&(v||y||P||L)&&!l,w=!t.L_NO_TOUCH&&!l&&function(){var t="ontouchstart";if(m||t in g)return!0;var i=e.createElement("div"),n=!1;return i.setAttribute?(i.setAttribute(t,"return;"),"function"==typeof i[t]&&(n=!0),i.removeAttribute(t),i=null,n):!1}();o.Browser={ie:n,ielt9:s,webkit:r,gecko:d&&!r&&!t.opera&&!n,android:u,android23:c,chrome:h,ie3d:v,webkit3d:y,gecko3d:P,opera3d:L,any3d:x,mobile:p,mobileWebkit:p&&r,mobileWebkit3d:p&&y,mobileOpera:p&&t.opera,touch:w,msPointer:_,pointer:m,retina:f}}(),o.Point=function(t,e,i){this.x=i?Math.round(t):t,this.y=i?Math.round(e):e},o.Point.prototype={clone:function(){return new o.Point(this.x,this.y)},add:function(t){return this.clone()._add(o.point(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(o.point(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},distanceTo:function(t){t=o.point(t);var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},equals:function(t){return t=o.point(t),t.x===this.x&&t.y===this.y},contains:function(t){return t=o.point(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+o.Util.formatNum(this.x)+", "+o.Util.formatNum(this.y)+")"}},o.point=function(t,e,n){return t instanceof o.Point?t:o.Util.isArray(t)?new o.Point(t[0],t[1]):t===i||null===t?t:new o.Point(t,e,n)},o.Bounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.Bounds.prototype={extend:function(t){return t=o.point(t),this.min||this.max?(this.min.x=Math.min(t.x,this.min.x),this.max.x=Math.max(t.x,this.max.x),this.min.y=Math.min(t.y,this.min.y),this.max.y=Math.max(t.y,this.max.y)):(this.min=t.clone(),this.max=t.clone()),this},getCenter:function(t){return new o.Point((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return new o.Point(this.min.x,this.max.y)},getTopRight:function(){return new o.Point(this.max.x,this.min.y)},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,i;return t="number"==typeof t[0]||t instanceof o.Point?o.point(t):o.bounds(t),t instanceof o.Bounds?(e=t.min,i=t.max):e=i=t,e.x>=this.min.x&&i.x<=this.max.x&&e.y>=this.min.y&&i.y<=this.max.y},intersects:function(t){t=o.bounds(t);var e=this.min,i=this.max,n=t.min,s=t.max,a=s.x>=e.x&&n.x<=i.x,r=s.y>=e.y&&n.y<=i.y;return a&&r},isValid:function(){return!(!this.min||!this.max)}},o.bounds=function(t,e){return!t||t instanceof o.Bounds?t:new o.Bounds(t,e)},o.Transformation=function(t,e,i,n){this._a=t,this._b=e,this._c=i,this._d=n},o.Transformation.prototype={transform:function(t,e){return this._transform(t.clone(),e)},_transform:function(t,e){return e=e||1,t.x=e*(this._a*t.x+this._b),t.y=e*(this._c*t.y+this._d),t},untransform:function(t,e){return e=e||1,new o.Point((t.x/e-this._b)/this._a,(t.y/e-this._d)/this._c)}},o.DomUtil={get:function(t){return"string"==typeof t?e.getElementById(t):t},getStyle:function(t,i){var n=t.style[i];if(!n&&t.currentStyle&&(n=t.currentStyle[i]),(!n||"auto"===n)&&e.defaultView){var o=e.defaultView.getComputedStyle(t,null);n=o?o[i]:null}return"auto"===n?null:n},getViewportOffset:function(t){var i,n=0,s=0,a=t,r=e.body,h=e.documentElement;do{if(n+=a.offsetTop||0,s+=a.offsetLeft||0,n+=parseInt(o.DomUtil.getStyle(a,"borderTopWidth"),10)||0,s+=parseInt(o.DomUtil.getStyle(a,"borderLeftWidth"),10)||0,i=o.DomUtil.getStyle(a,"position"),a.offsetParent===r&&"absolute"===i)break;if("fixed"===i){n+=r.scrollTop||h.scrollTop||0,s+=r.scrollLeft||h.scrollLeft||0;break}if("relative"===i&&!a.offsetLeft){var l=o.DomUtil.getStyle(a,"width"),u=o.DomUtil.getStyle(a,"max-width"),c=a.getBoundingClientRect();("none"!==l||"none"!==u)&&(s+=c.left+a.clientLeft),n+=c.top+(r.scrollTop||h.scrollTop||0);break}a=a.offsetParent}while(a);a=t;do{if(a===r)break;n-=a.scrollTop||0,s-=a.scrollLeft||0,a=a.parentNode}while(a);return new o.Point(s,n)},documentIsLtr:function(){return o.DomUtil._docIsLtrCached||(o.DomUtil._docIsLtrCached=!0,o.DomUtil._docIsLtr="ltr"===o.DomUtil.getStyle(e.body,"direction")),o.DomUtil._docIsLtr},create:function(t,i,n){var o=e.createElement(t);return o.className=i,n&&n.appendChild(o),o},hasClass:function(t,e){if(t.classList!==i)return t.classList.contains(e);var n=o.DomUtil._getClass(t);return n.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(n)},addClass:function(t,e){if(t.classList!==i)for(var n=o.Util.splitWords(e),s=0,a=n.length;a>s;s++)t.classList.add(n[s]);else if(!o.DomUtil.hasClass(t,e)){var r=o.DomUtil._getClass(t);o.DomUtil._setClass(t,(r?r+" ":"")+e)}},removeClass:function(t,e){t.classList!==i?t.classList.remove(e):o.DomUtil._setClass(t,o.Util.trim((" "+o.DomUtil._getClass(t)+" ").replace(" "+e+" "," ")))},_setClass:function(t,e){t.className.baseVal===i?t.className=e:t.className.baseVal=e},_getClass:function(t){return t.className.baseVal===i?t.className:t.className.baseVal},setOpacity:function(t,e){if("opacity"in t.style)t.style.opacity=e;else if("filter"in t.style){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(o){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"}},testProp:function(t){for(var i=e.documentElement.style,n=0;n<t.length;n++)if(t[n]in i)return t[n];return!1},getTranslateString:function(t){var e=o.Browser.webkit3d,i="translate"+(e?"3d":"")+"(",n=(e?",0":"")+")";return i+t.x+"px,"+t.y+"px"+n},getScaleString:function(t,e){var i=o.DomUtil.getTranslateString(e.add(e.multiplyBy(-1*t))),n=" scale("+t+") ";return i+n},setPosition:function(t,e,i){t._leaflet_pos=e,!i&&o.Browser.any3d?t.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(e):(t.style.left=e.x+"px",t.style.top=e.y+"px")},getPosition:function(t){return t._leaflet_pos}},o.DomUtil.TRANSFORM=o.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),o.DomUtil.TRANSITION=o.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),o.DomUtil.TRANSITION_END="webkitTransition"===o.DomUtil.TRANSITION||"OTransition"===o.DomUtil.TRANSITION?o.DomUtil.TRANSITION+"End":"transitionend",function(){if("onselectstart"in e)o.extend(o.DomUtil,{disableTextSelection:function(){o.DomEvent.on(t,"selectstart",o.DomEvent.preventDefault)},enableTextSelection:function(){o.DomEvent.off(t,"selectstart",o.DomEvent.preventDefault)}});else{var i=o.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);o.extend(o.DomUtil,{disableTextSelection:function(){if(i){var t=e.documentElement.style;this._userSelect=t[i],t[i]="none"}},enableTextSelection:function(){i&&(e.documentElement.style[i]=this._userSelect,delete this._userSelect)}})}o.extend(o.DomUtil,{disableImageDrag:function(){o.DomEvent.on(t,"dragstart",o.DomEvent.preventDefault)},enableImageDrag:function(){o.DomEvent.off(t,"dragstart",o.DomEvent.preventDefault)}})}(),o.LatLng=function(t,e,n){if(t=parseFloat(t),e=parseFloat(e),isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=t,this.lng=e,n!==i&&(this.alt=parseFloat(n))},o.extend(o.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),o.LatLng.prototype={equals:function(t){if(!t)return!1;t=o.latLng(t);var e=Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng));return e<=o.LatLng.MAX_MARGIN},toString:function(t){return"LatLng("+o.Util.formatNum(this.lat,t)+", "+o.Util.formatNum(this.lng,t)+")"},distanceTo:function(t){t=o.latLng(t);var e=6378137,i=o.LatLng.DEG_TO_RAD,n=(t.lat-this.lat)*i,s=(t.lng-this.lng)*i,a=this.lat*i,r=t.lat*i,h=Math.sin(n/2),l=Math.sin(s/2),u=h*h+l*l*Math.cos(a)*Math.cos(r);return 2*e*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))},wrap:function(t,e){var i=this.lng;return t=t||-180,e=e||180,i=(i+e)%(e-t)+(t>i||i===e?e:t),new o.LatLng(this.lat,i)}},o.latLng=function(t,e){return t instanceof o.LatLng?t:o.Util.isArray(t)?"number"==typeof t[0]||"string"==typeof t[0]?new o.LatLng(t[0],t[1],t[2]):null:t===i||null===t?t:"object"==typeof t&&"lat"in t?new o.LatLng(t.lat,"lng"in t?t.lng:t.lon):e===i?null:new o.LatLng(t,e)},o.LatLngBounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.LatLngBounds.prototype={extend:function(t){if(!t)return this;var e=o.latLng(t);return t=null!==e?e:o.latLngBounds(t),t instanceof o.LatLng?this._southWest||this._northEast?(this._southWest.lat=Math.min(t.lat,this._southWest.lat),this._southWest.lng=Math.min(t.lng,this._southWest.lng),this._northEast.lat=Math.max(t.lat,this._northEast.lat),this._northEast.lng=Math.max(t.lng,this._northEast.lng)):(this._southWest=new o.LatLng(t.lat,t.lng),this._northEast=new o.LatLng(t.lat,t.lng)):t instanceof o.LatLngBounds&&(this.extend(t._southWest),this.extend(t._northEast)),this},pad:function(t){var e=this._southWest,i=this._northEast,n=Math.abs(e.lat-i.lat)*t,s=Math.abs(e.lng-i.lng)*t;return new o.LatLngBounds(new o.LatLng(e.lat-n,e.lng-s),new o.LatLng(i.lat+n,i.lng+s))},getCenter:function(){return new o.LatLng((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new o.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new o.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof o.LatLng?o.latLng(t):o.latLngBounds(t);var e,i,n=this._southWest,s=this._northEast;return t instanceof o.LatLngBounds?(e=t.getSouthWest(),i=t.getNorthEast()):e=i=t,e.lat>=n.lat&&i.lat<=s.lat&&e.lng>=n.lng&&i.lng<=s.lng},intersects:function(t){t=o.latLngBounds(t);var e=this._southWest,i=this._northEast,n=t.getSouthWest(),s=t.getNorthEast(),a=s.lat>=e.lat&&n.lat<=i.lat,r=s.lng>=e.lng&&n.lng<=i.lng;return a&&r},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t){return t?(t=o.latLngBounds(t),this._southWest.equals(t.getSouthWest())&&this._northEast.equals(t.getNorthEast())):!1},isValid:function(){return!(!this._southWest||!this._northEast)}},o.latLngBounds=function(t,e){return!t||t instanceof o.LatLngBounds?t:new o.LatLngBounds(t,e)},o.Projection={},o.Projection.SphericalMercator={MAX_LATITUDE:85.0511287798,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),s=t.lng*e,a=n*e;return a=Math.log(Math.tan(Math.PI/4+a/2)),new o.Point(s,a)},unproject:function(t){var e=o.LatLng.RAD_TO_DEG,i=t.x*e,n=(2*Math.atan(Math.exp(t.y))-Math.PI/2)*e;return new o.LatLng(n,i)}},o.Projection.LonLat={project:function(t){return new o.Point(t.lng,t.lat)},unproject:function(t){return new o.LatLng(t.y,t.x)}},o.CRS={latLngToPoint:function(t,e){var i=this.projection.project(t),n=this.scale(e);return this.transformation._transform(i,n)},pointToLatLng:function(t,e){var i=this.scale(e),n=this.transformation.untransform(t,i);return this.projection.unproject(n)},project:function(t){return this.projection.project(t)},scale:function(t){return 256*Math.pow(2,t)},getSize:function(t){var e=this.scale(t);return o.point(e,e)}},o.CRS.Simple=o.extend({},o.CRS,{projection:o.Projection.LonLat,transformation:new o.Transformation(1,0,-1,0),scale:function(t){return Math.pow(2,t)}}),o.CRS.EPSG3857=o.extend({},o.CRS,{code:"EPSG:3857",projection:o.Projection.SphericalMercator,transformation:new o.Transformation(.5/Math.PI,.5,-.5/Math.PI,.5),project:function(t){var e=this.projection.project(t),i=6378137;return e.multiplyBy(i)}}),o.CRS.EPSG900913=o.extend({},o.CRS.EPSG3857,{code:"EPSG:900913"}),o.CRS.EPSG4326=o.extend({},o.CRS,{code:"EPSG:4326",projection:o.Projection.LonLat,transformation:new o.Transformation(1/360,.5,-1/360,.5)}),o.Map=o.Class.extend({includes:o.Mixin.Events,options:{crs:o.CRS.EPSG3857,fadeAnimation:o.DomUtil.TRANSITION&&!o.Browser.android23,trackResize:!0,markerZoomAnimation:o.DomUtil.TRANSITION&&o.Browser.any3d},initialize:function(t,e){e=o.setOptions(this,e),this._initContainer(t),this._initLayout(),this._onResize=o.bind(this._onResize,this),this._initEvents(),e.maxBounds&&this.setMaxBounds(e.maxBounds),e.center&&e.zoom!==i&&this.setView(o.latLng(e.center),e.zoom,{reset:!0}),this._handlers=[],this._layers={},this._zoomBoundLayers={},this._tileLayersNum=0,this.callInitHooks(),this._addLayers(e.layers)},setView:function(t,e){return e=e===i?this.getZoom():e,this._resetView(o.latLng(t),this._limitZoom(e)),this},setZoom:function(t,e){return this._loaded?this.setView(this.getCenter(),t,{zoom:e}):(this._zoom=this._limitZoom(t),this)},zoomIn:function(t,e){return this.setZoom(this._zoom+(t||1),e)},zoomOut:function(t,e){return this.setZoom(this._zoom-(t||1),e)},setZoomAround:function(t,e,i){var n=this.getZoomScale(e),s=this.getSize().divideBy(2),a=t instanceof o.Point?t:this.latLngToContainerPoint(t),r=a.subtract(s).multiplyBy(1-1/n),h=this.containerPointToLatLng(s.add(r));return this.setView(h,e,{zoom:i})},fitBounds:function(t,e){e=e||{},t=t.getBounds?t.getBounds():o.latLngBounds(t);var i=o.point(e.paddingTopLeft||e.padding||[0,0]),n=o.point(e.paddingBottomRight||e.padding||[0,0]),s=this.getBoundsZoom(t,!1,i.add(n)),a=n.subtract(i).divideBy(2),r=this.project(t.getSouthWest(),s),h=this.project(t.getNorthEast(),s),l=this.unproject(r.add(h).divideBy(2).add(a),s);return s=e&&e.maxZoom?Math.min(e.maxZoom,s):s,this.setView(l,s,e)},fitWorld:function(t){return this.fitBounds([[-90,-180],[90,180]],t)},panTo:function(t,e){return this.setView(t,this._zoom,{pan:e})},panBy:function(t){return this.fire("movestart"),this._rawPanBy(o.point(t)),this.fire("move"),this.fire("moveend")},setMaxBounds:function(t){return t=o.latLngBounds(t),this.options.maxBounds=t,t?(this._loaded&&this._panInsideMaxBounds(),this.on("moveend",this._panInsideMaxBounds,this)):this.off("moveend",this._panInsideMaxBounds,this)},panInsideBounds:function(t,e){var i=this.getCenter(),n=this._limitCenter(i,this._zoom,t);return i.equals(n)?this:this.panTo(n,e)},addLayer:function(t){var e=o.stamp(t);return this._layers[e]?this:(this._layers[e]=t,!t.options||isNaN(t.options.maxZoom)&&isNaN(t.options.minZoom)||(this._zoomBoundLayers[e]=t,this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum++,this._tileLayersToLoad++,t.on("load",this._onTileLayerLoad,this)),this._loaded&&this._layerAdd(t),this)},removeLayer:function(t){var e=o.stamp(t);return this._layers[e]?(this._loaded&&t.onRemove(this),delete this._layers[e],this._loaded&&this.fire("layerremove",{layer:t}),this._zoomBoundLayers[e]&&(delete this._zoomBoundLayers[e],this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum--,this._tileLayersToLoad--,t.off("load",this._onTileLayerLoad,this)),this):this},hasLayer:function(t){return t?o.stamp(t)in this._layers:!1},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},invalidateSize:function(t){if(!this._loaded)return this;t=o.extend({animate:!1,pan:!0},t===!0?{animate:!0}:t);var e=this.getSize();this._sizeChanged=!0,this._initialCenter=null;var i=this.getSize(),n=e.divideBy(2).round(),s=i.divideBy(2).round(),a=n.subtract(s);return a.x||a.y?(t.animate&&t.pan?this.panBy(a):(t.pan&&this._rawPanBy(a),this.fire("move"),t.debounceMoveend?(clearTimeout(this._sizeTimer),this._sizeTimer=setTimeout(o.bind(this.fire,this,"moveend"),200)):this.fire("moveend")),this.fire("resize",{oldSize:e,newSize:i})):this},addHandler:function(t,e){if(!e)return this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},remove:function(){this._loaded&&this.fire("unload"),this._initEvents("off");try{delete this._container._leaflet}catch(t){this._container._leaflet=i}return this._clearPanes(),this._clearControlPos&&this._clearControlPos(),this._clearHandlers(),this},getCenter:function(){return this._checkIfLoaded(),this._initialCenter&&!this._moved()?this._initialCenter:this.layerPointToLatLng(this._getCenterLayerPoint())},getZoom:function(){return this._zoom},getBounds:function(){var t=this.getPixelBounds(),e=this.unproject(t.getBottomLeft()),i=this.unproject(t.getTopRight());return new o.LatLngBounds(e,i)},getMinZoom:function(){return this.options.minZoom===i?this._layersMinZoom===i?0:this._layersMinZoom:this.options.minZoom},getMaxZoom:function(){return this.options.maxZoom===i?this._layersMaxZoom===i?1/0:this._layersMaxZoom:this.options.maxZoom},getBoundsZoom:function(t,e,i){t=o.latLngBounds(t);var n,s=this.getMinZoom()-(e?1:0),a=this.getMaxZoom(),r=this.getSize(),h=t.getNorthWest(),l=t.getSouthEast(),u=!0;i=o.point(i||[0,0]);do s++,n=this.project(l,s).subtract(this.project(h,s)).add(i),u=e?n.x<r.x||n.y<r.y:r.contains(n);while(u&&a>=s);return u&&e?null:e?s:s-1},getSize:function(){return(!this._size||this._sizeChanged)&&(this._size=new o.Point(this._container.clientWidth,this._container.clientHeight),this._sizeChanged=!1),this._size.clone()},getPixelBounds:function(){var t=this._getTopLeftPoint();return new o.Bounds(t,t.add(this.getSize()))},getPixelOrigin:function(){return this._checkIfLoaded(),this._initialTopLeftPoint},getPanes:function(){return this._panes},getContainer:function(){return this._container},getZoomScale:function(t){var e=this.options.crs;return e.scale(t)/e.scale(this._zoom)},getScaleZoom:function(t){return this._zoom+Math.log(t)/Math.LN2},project:function(t,e){return e=e===i?this._zoom:e,this.options.crs.latLngToPoint(o.latLng(t),e)},unproject:function(t,e){return e=e===i?this._zoom:e,this.options.crs.pointToLatLng(o.point(t),e)},layerPointToLatLng:function(t){var e=o.point(t).add(this.getPixelOrigin());return this.unproject(e)},latLngToLayerPoint:function(t){var e=this.project(o.latLng(t))._round();return e._subtract(this.getPixelOrigin())},containerPointToLayerPoint:function(t){return o.point(t).subtract(this._getMapPanePos())},layerPointToContainerPoint:function(t){return o.point(t).add(this._getMapPanePos())},containerPointToLatLng:function(t){var e=this.containerPointToLayerPoint(o.point(t));return this.layerPointToLatLng(e)},latLngToContainerPoint:function(t){return this.layerPointToContainerPoint(this.latLngToLayerPoint(o.latLng(t)))},mouseEventToContainerPoint:function(t){return o.DomEvent.getMousePosition(t,this._container)},mouseEventToLayerPoint:function(t){return this.containerPointToLayerPoint(this.mouseEventToContainerPoint(t))},mouseEventToLatLng:function(t){return this.layerPointToLatLng(this.mouseEventToLayerPoint(t))},_initContainer:function(t){var e=this._container=o.DomUtil.get(t);if(!e)throw new Error("Map container not found.");if(e._leaflet)throw new Error("Map container is already initialized.");e._leaflet=!0},_initLayout:function(){var t=this._container;o.DomUtil.addClass(t,"leaflet-container"+(o.Browser.touch?" leaflet-touch":"")+(o.Browser.retina?" leaflet-retina":"")+(o.Browser.ielt9?" leaflet-oldie":"")+(this.options.fadeAnimation?" leaflet-fade-anim":""));var e=o.DomUtil.getStyle(t,"position");"absolute"!==e&&"relative"!==e&&"fixed"!==e&&(t.style.position="relative"),this._initPanes(),this._initControlPos&&this._initControlPos()},_initPanes:function(){var t=this._panes={};this._mapPane=t.mapPane=this._createPane("leaflet-map-pane",this._container),this._tilePane=t.tilePane=this._createPane("leaflet-tile-pane",this._mapPane),t.objectsPane=this._createPane("leaflet-objects-pane",this._mapPane),t.shadowPane=this._createPane("leaflet-shadow-pane"),t.overlayPane=this._createPane("leaflet-overlay-pane"),t.markerPane=this._createPane("leaflet-marker-pane"),t.popupPane=this._createPane("leaflet-popup-pane");var e=" leaflet-zoom-hide";this.options.markerZoomAnimation||(o.DomUtil.addClass(t.markerPane,e),o.DomUtil.addClass(t.shadowPane,e),o.DomUtil.addClass(t.popupPane,e))},_createPane:function(t,e){return o.DomUtil.create("div",t,e||this._panes.objectsPane)},_clearPanes:function(){this._container.removeChild(this._mapPane)},_addLayers:function(t){t=t?o.Util.isArray(t)?t:[t]:[];for(var e=0,i=t.length;i>e;e++)this.addLayer(t[e])},_resetView:function(t,e,i,n){var s=this._zoom!==e;n||(this.fire("movestart"),s&&this.fire("zoomstart")),this._zoom=e,this._initialCenter=t,this._initialTopLeftPoint=this._getNewTopLeftPoint(t),i?this._initialTopLeftPoint._add(this._getMapPanePos()):o.DomUtil.setPosition(this._mapPane,new o.Point(0,0)),this._tileLayersToLoad=this._tileLayersNum;var a=!this._loaded;this._loaded=!0,a&&(this.fire("load"),this.eachLayer(this._layerAdd,this)),this.fire("viewreset",{hard:!i}),this.fire("move"),(s||n)&&this.fire("zoomend"),this.fire("moveend",{hard:!i})},_rawPanBy:function(t){o.DomUtil.setPosition(this._mapPane,this._getMapPanePos().subtract(t))},_getZoomSpan:function(){return this.getMaxZoom()-this.getMinZoom()},_updateZoomLevels:function(){var t,e=1/0,n=-1/0,o=this._getZoomSpan();for(t in this._zoomBoundLayers){var s=this._zoomBoundLayers[t];isNaN(s.options.minZoom)||(e=Math.min(e,s.options.minZoom)),isNaN(s.options.maxZoom)||(n=Math.max(n,s.options.maxZoom))}t===i?this._layersMaxZoom=this._layersMinZoom=i:(this._layersMaxZoom=n,this._layersMinZoom=e),o!==this._getZoomSpan()&&this.fire("zoomlevelschange")},_panInsideMaxBounds:function(){this.panInsideBounds(this.options.maxBounds)},_checkIfLoaded:function(){if(!this._loaded)throw new Error("Set map center and zoom first.")},_initEvents:function(e){if(o.DomEvent){e=e||"on",o.DomEvent[e](this._container,"click",this._onMouseClick,this);var i,n,s=["dblclick","mousedown","mouseup","mouseenter","mouseleave","mousemove","contextmenu"];for(i=0,n=s.length;n>i;i++)o.DomEvent[e](this._container,s[i],this._fireMouseEvent,this);this.options.trackResize&&o.DomEvent[e](t,"resize",this._onResize,this)}},_onResize:function(){o.Util.cancelAnimFrame(this._resizeRequest),this._resizeRequest=o.Util.requestAnimFrame(function(){this.invalidateSize({debounceMoveend:!0})},this,!1,this._container)},_onMouseClick:function(t){!this._loaded||!t._simulated&&(this.dragging&&this.dragging.moved()||this.boxZoom&&this.boxZoom.moved())||o.DomEvent._skipped(t)||(this.fire("preclick"),this._fireMouseEvent(t))},_fireMouseEvent:function(t){if(this._loaded&&!o.DomEvent._skipped(t)){var e=t.type;if(e="mouseenter"===e?"mouseover":"mouseleave"===e?"mouseout":e,this.hasEventListeners(e)){"contextmenu"===e&&o.DomEvent.preventDefault(t);var i=this.mouseEventToContainerPoint(t),n=this.containerPointToLayerPoint(i),s=this.layerPointToLatLng(n);this.fire(e,{latlng:s,layerPoint:n,containerPoint:i,originalEvent:t})}}},_onTileLayerLoad:function(){this._tileLayersToLoad--,this._tileLayersNum&&!this._tileLayersToLoad&&this.fire("tilelayersload")},_clearHandlers:function(){for(var t=0,e=this._handlers.length;e>t;t++)this._handlers[t].disable()},whenReady:function(t,e){return this._loaded?t.call(e||this,this):this.on("load",t,e),this},_layerAdd:function(t){t.onAdd(this),this.fire("layeradd",{layer:t})},_getMapPanePos:function(){return o.DomUtil.getPosition(this._mapPane)},_moved:function(){var t=this._getMapPanePos();return t&&!t.equals([0,0])},_getTopLeftPoint:function(){return this.getPixelOrigin().subtract(this._getMapPanePos())},_getNewTopLeftPoint:function(t,e){var i=this.getSize()._divideBy(2);return this.project(t,e)._subtract(i)._round()},_latLngToNewLayerPoint:function(t,e,i){var n=this._getNewTopLeftPoint(i,e).add(this._getMapPanePos());return this.project(t,e)._subtract(n)},_getCenterLayerPoint:function(){return this.containerPointToLayerPoint(this.getSize()._divideBy(2))},_getCenterOffset:function(t){return this.latLngToLayerPoint(t).subtract(this._getCenterLayerPoint())},_limitCenter:function(t,e,i){if(!i)return t;var n=this.project(t,e),s=this.getSize().divideBy(2),a=new o.Bounds(n.subtract(s),n.add(s)),r=this._getBoundsOffset(a,i,e);return this.unproject(n.add(r),e)},_limitOffset:function(t,e){if(!e)return t;var i=this.getPixelBounds(),n=new o.Bounds(i.min.add(t),i.max.add(t));return t.add(this._getBoundsOffset(n,e))},_getBoundsOffset:function(t,e,i){var n=this.project(e.getNorthWest(),i).subtract(t.min),s=this.project(e.getSouthEast(),i).subtract(t.max),a=this._rebound(n.x,-s.x),r=this._rebound(n.y,-s.y);return new o.Point(a,r)},_rebound:function(t,e){return t+e>0?Math.round(t-e)/2:Math.max(0,Math.ceil(t))-Math.max(0,Math.floor(e))},_limitZoom:function(t){var e=this.getMinZoom(),i=this.getMaxZoom();return Math.max(e,Math.min(i,t))}}),o.map=function(t,e){return new o.Map(t,e)},o.Projection.Mercator={MAX_LATITUDE:85.0840591556,R_MINOR:6356752.314245179,R_MAJOR:6378137,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),s=this.R_MAJOR,a=this.R_MINOR,r=t.lng*e*s,h=n*e,l=a/s,u=Math.sqrt(1-l*l),c=u*Math.sin(h);c=Math.pow((1-c)/(1+c),.5*u);var d=Math.tan(.5*(.5*Math.PI-h))/c;return h=-s*Math.log(d),new o.Point(r,h)},unproject:function(t){for(var e,i=o.LatLng.RAD_TO_DEG,n=this.R_MAJOR,s=this.R_MINOR,a=t.x*i/n,r=s/n,h=Math.sqrt(1-r*r),l=Math.exp(-t.y/n),u=Math.PI/2-2*Math.atan(l),c=15,d=1e-7,p=c,_=.1;Math.abs(_)>d&&--p>0;)e=h*Math.sin(u),_=Math.PI/2-2*Math.atan(l*Math.pow((1-e)/(1+e),.5*h))-u,u+=_;
+return new o.LatLng(u*i,a)}},o.CRS.EPSG3395=o.extend({},o.CRS,{code:"EPSG:3395",projection:o.Projection.Mercator,transformation:function(){var t=o.Projection.Mercator,e=t.R_MAJOR,i=.5/(Math.PI*e);return new o.Transformation(i,.5,-i,.5)}()}),o.TileLayer=o.Class.extend({includes:o.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",zoomOffset:0,opacity:1,unloadInvisibleTiles:o.Browser.mobile,updateWhenIdle:o.Browser.mobile},initialize:function(t,e){e=o.setOptions(this,e),e.detectRetina&&o.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom>0&&e.minZoom--,this.options.maxZoom--),e.bounds&&(e.bounds=o.latLngBounds(e.bounds)),this._url=t;var i=this.options.subdomains;"string"==typeof i&&(this.options.subdomains=i.split(""))},onAdd:function(t){this._map=t,this._animated=t._zoomAnimated,this._initContainer(),t.on({viewreset:this._reset,moveend:this._update},this),this._animated&&t.on({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||(this._limitedUpdate=o.Util.limitExecByInterval(this._update,150,this),t.on("move",this._limitedUpdate,this)),this._reset(),this._update()},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this._container.parentNode.removeChild(this._container),t.off({viewreset:this._reset,moveend:this._update},this),this._animated&&t.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||t.off("move",this._limitedUpdate,this),this._container=null,this._map=null},bringToFront:function(){var t=this._map._panes.tilePane;return this._container&&(t.appendChild(this._container),this._setAutoZIndex(t,Math.max)),this},bringToBack:function(){var t=this._map._panes.tilePane;return this._container&&(t.insertBefore(this._container,t.firstChild),this._setAutoZIndex(t,Math.min)),this},getAttribution:function(){return this.options.attribution},getContainer:function(){return this._container},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},setUrl:function(t,e){return this._url=t,e||this.redraw(),this},redraw:function(){return this._map&&(this._reset({hard:!0}),this._update()),this},_updateZIndex:function(){this._container&&this.options.zIndex!==i&&(this._container.style.zIndex=this.options.zIndex)},_setAutoZIndex:function(t,e){var i,n,o,s=t.children,a=-e(1/0,-1/0);for(n=0,o=s.length;o>n;n++)s[n]!==this._container&&(i=parseInt(s[n].style.zIndex,10),isNaN(i)||(a=e(a,i)));this.options.zIndex=this._container.style.zIndex=(isFinite(a)?a:0)+e(1,-1)},_updateOpacity:function(){var t,e=this._tiles;if(o.Browser.ielt9)for(t in e)o.DomUtil.setOpacity(e[t],this.options.opacity);else o.DomUtil.setOpacity(this._container,this.options.opacity)},_initContainer:function(){var t=this._map._panes.tilePane;if(!this._container){if(this._container=o.DomUtil.create("div","leaflet-layer"),this._updateZIndex(),this._animated){var e="leaflet-tile-container";this._bgBuffer=o.DomUtil.create("div",e,this._container),this._tileContainer=o.DomUtil.create("div",e,this._container)}else this._tileContainer=this._container;t.appendChild(this._container),this.options.opacity<1&&this._updateOpacity()}},_reset:function(t){for(var e in this._tiles)this.fire("tileunload",{tile:this._tiles[e]});this._tiles={},this._tilesToLoad=0,this.options.reuseTiles&&(this._unusedTiles=[]),this._tileContainer.innerHTML="",this._animated&&t&&t.hard&&this._clearBgBuffer(),this._initContainer()},_getTileSize:function(){var t=this._map,e=t.getZoom()+this.options.zoomOffset,i=this.options.maxNativeZoom,n=this.options.tileSize;return i&&e>i&&(n=Math.round(t.getZoomScale(e)/t.getZoomScale(i)*n)),n},_update:function(){if(this._map){var t=this._map,e=t.getPixelBounds(),i=t.getZoom(),n=this._getTileSize();if(!(i>this.options.maxZoom||i<this.options.minZoom)){var s=o.bounds(e.min.divideBy(n)._floor(),e.max.divideBy(n)._floor());this._addTilesFromCenterOut(s),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(s)}}},_addTilesFromCenterOut:function(t){var i,n,s,a=[],r=t.getCenter();for(i=t.min.y;i<=t.max.y;i++)for(n=t.min.x;n<=t.max.x;n++)s=new o.Point(n,i),this._tileShouldBeLoaded(s)&&a.push(s);var h=a.length;if(0!==h){a.sort(function(t,e){return t.distanceTo(r)-e.distanceTo(r)});var l=e.createDocumentFragment();for(this._tilesToLoad||this.fire("loading"),this._tilesToLoad+=h,n=0;h>n;n++)this._addTile(a[n],l);this._tileContainer.appendChild(l)}},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var e=this.options;if(!e.continuousWorld){var i=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=i.x)||t.y<0||t.y>=i.y)return!1}if(e.bounds){var n=e.tileSize,o=t.multiplyBy(n),s=o.add([n,n]),a=this._map.unproject(o),r=this._map.unproject(s);if(e.continuousWorld||e.noWrap||(a=a.wrap(),r=r.wrap()),!e.bounds.intersects([a,r]))return!1}return!0},_removeOtherTiles:function(t){var e,i,n,o;for(o in this._tiles)e=o.split(":"),i=parseInt(e[0],10),n=parseInt(e[1],10),(i<t.min.x||i>t.max.x||n<t.min.y||n>t.max.y)&&this._removeTile(o)},_removeTile:function(t){var e=this._tiles[t];this.fire("tileunload",{tile:e,url:e.src}),this.options.reuseTiles?(o.DomUtil.removeClass(e,"leaflet-tile-loaded"),this._unusedTiles.push(e)):e.parentNode===this._tileContainer&&this._tileContainer.removeChild(e),o.Browser.android||(e.onload=null,e.src=o.Util.emptyImageUrl),delete this._tiles[t]},_addTile:function(t,e){var i=this._getTilePos(t),n=this._getTile();o.DomUtil.setPosition(n,i,o.Browser.chrome),this._tiles[t.x+":"+t.y]=n,this._loadTile(n,t),n.parentNode!==this._tileContainer&&e.appendChild(n)},_getZoomForUrl:function(){var t=this.options,e=this._map.getZoom();return t.zoomReverse&&(e=t.maxZoom-e),e+=t.zoomOffset,t.maxNativeZoom?Math.min(e,t.maxNativeZoom):e},_getTilePos:function(t){var e=this._map.getPixelOrigin(),i=this._getTileSize();return t.multiplyBy(i).subtract(e)},getTileUrl:function(t){return o.Util.template(this._url,o.extend({s:this._getSubdomain(t),z:t.z,x:t.x,y:t.y},this.options))},_getWrapTileNum:function(){var t=this._map.options.crs,e=t.getSize(this._map.getZoom());return e.divideBy(this._getTileSize())._floor()},_adjustTilePoint:function(t){var e=this._getWrapTileNum();this.options.continuousWorld||this.options.noWrap||(t.x=(t.x%e.x+e.x)%e.x),this.options.tms&&(t.y=e.y-t.y-1),t.z=this._getZoomForUrl()},_getSubdomain:function(t){var e=Math.abs(t.x+t.y)%this.options.subdomains.length;return this.options.subdomains[e]},_getTile:function(){if(this.options.reuseTiles&&this._unusedTiles.length>0){var t=this._unusedTiles.pop();return this._resetTile(t),t}return this._createTile()},_resetTile:function(){},_createTile:function(){var t=o.DomUtil.create("img","leaflet-tile");return t.style.width=t.style.height=this._getTileSize()+"px",t.galleryimg="no",t.onselectstart=t.onmousemove=o.Util.falseFn,o.Browser.ielt9&&this.options.opacity!==i&&o.DomUtil.setOpacity(t,this.options.opacity),o.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden"),t},_loadTile:function(t,e){t._layer=this,t.onload=this._tileOnLoad,t.onerror=this._tileOnError,this._adjustTilePoint(e),t.src=this.getTileUrl(e),this.fire("tileloadstart",{tile:t,url:t.src})},_tileLoaded:function(){this._tilesToLoad--,this._animated&&o.DomUtil.addClass(this._tileContainer,"leaflet-zoom-animated"),this._tilesToLoad||(this.fire("load"),this._animated&&(clearTimeout(this._clearBgBufferTimer),this._clearBgBufferTimer=setTimeout(o.bind(this._clearBgBuffer,this),500)))},_tileOnLoad:function(){var t=this._layer;this.src!==o.Util.emptyImageUrl&&(o.DomUtil.addClass(this,"leaflet-tile-loaded"),t.fire("tileload",{tile:this,url:this.src})),t._tileLoaded()},_tileOnError:function(){var t=this._layer;t.fire("tileerror",{tile:this,url:this.src});var e=t.options.errorTileUrl;e&&(this.src=e),t._tileLoaded()}}),o.tileLayer=function(t,e){return new o.TileLayer(t,e)},o.TileLayer.WMS=o.TileLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},initialize:function(t,e){this._url=t;var i=o.extend({},this.defaultWmsParams),n=e.tileSize||this.options.tileSize;i.width=i.height=e.detectRetina&&o.Browser.retina?2*n:n;for(var s in e)this.options.hasOwnProperty(s)||"crs"===s||(i[s]=e[s]);this.wmsParams=i,o.setOptions(this,e)},onAdd:function(t){this._crs=this.options.crs||t.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version);var e=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[e]=this._crs.code,o.TileLayer.prototype.onAdd.call(this,t)},getTileUrl:function(t){var e=this._map,i=this.options.tileSize,n=t.multiplyBy(i),s=n.add([i,i]),a=this._crs.project(e.unproject(n,t.z)),r=this._crs.project(e.unproject(s,t.z)),h=this._wmsVersion>=1.3&&this._crs===o.CRS.EPSG4326?[r.y,a.x,a.y,r.x].join(","):[a.x,r.y,r.x,a.y].join(","),l=o.Util.template(this._url,{s:this._getSubdomain(t)});return l+o.Util.getParamString(this.wmsParams,l,!0)+"&BBOX="+h},setParams:function(t,e){return o.extend(this.wmsParams,t),e||this.redraw(),this}}),o.tileLayer.wms=function(t,e){return new o.TileLayer.WMS(t,e)},o.TileLayer.Canvas=o.TileLayer.extend({options:{async:!1},initialize:function(t){o.setOptions(this,t)},redraw:function(){this._map&&(this._reset({hard:!0}),this._update());for(var t in this._tiles)this._redrawTile(this._tiles[t]);return this},_redrawTile:function(t){this.drawTile(t,t._tilePoint,this._map._zoom)},_createTile:function(){var t=o.DomUtil.create("canvas","leaflet-tile");return t.width=t.height=this.options.tileSize,t.onselectstart=t.onmousemove=o.Util.falseFn,t},_loadTile:function(t,e){t._layer=this,t._tilePoint=e,this._redrawTile(t),this.options.async||this.tileDrawn(t)},drawTile:function(){},tileDrawn:function(t){this._tileOnLoad.call(t)}}),o.tileLayer.canvas=function(t){return new o.TileLayer.Canvas(t)},o.ImageOverlay=o.Class.extend({includes:o.Mixin.Events,options:{opacity:1},initialize:function(t,e,i){this._url=t,this._bounds=o.latLngBounds(e),o.setOptions(this,i)},onAdd:function(t){this._map=t,this._image||this._initImage(),t._panes.overlayPane.appendChild(this._image),t.on("viewreset",this._reset,this),t.options.zoomAnimation&&o.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._image),t.off("viewreset",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._image&&this._map._panes.overlayPane.appendChild(this._image),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._image&&t.insertBefore(this._image,t.firstChild),this},setUrl:function(t){this._url=t,this._image.src=this._url},getAttribution:function(){return this.options.attribution},_initImage:function(){this._image=o.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&o.Browser.any3d?o.DomUtil.addClass(this._image,"leaflet-zoom-animated"):o.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),o.extend(this._image,{galleryimg:"no",onselectstart:o.Util.falseFn,onmousemove:o.Util.falseFn,onload:o.bind(this._onImageLoad,this),src:this._url})},_animateZoom:function(t){var e=this._map,i=this._image,n=e.getZoomScale(t.zoom),s=this._bounds.getNorthWest(),a=this._bounds.getSouthEast(),r=e._latLngToNewLayerPoint(s,t.zoom,t.center),h=e._latLngToNewLayerPoint(a,t.zoom,t.center)._subtract(r),l=r._add(h._multiplyBy(.5*(1-1/n)));i.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(l)+" scale("+n+") "},_reset:function(){var t=this._image,e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),i=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(e);o.DomUtil.setPosition(t,e),t.style.width=i.x+"px",t.style.height=i.y+"px"},_onImageLoad:function(){this.fire("load")},_updateOpacity:function(){o.DomUtil.setOpacity(this._image,this.options.opacity)}}),o.imageOverlay=function(t,e,i){return new o.ImageOverlay(t,e,i)},o.Icon=o.Class.extend({options:{className:""},initialize:function(t){o.setOptions(this,t)},createIcon:function(t){return this._createIcon("icon",t)},createShadow:function(t){return this._createIcon("shadow",t)},_createIcon:function(t,e){var i=this._getIconUrl(t);if(!i){if("icon"===t)throw new Error("iconUrl not set in Icon options (see the docs).");return null}var n;return n=e&&"IMG"===e.tagName?this._createImg(i,e):this._createImg(i),this._setIconStyles(n,t),n},_setIconStyles:function(t,e){var i,n=this.options,s=o.point(n[e+"Size"]);i=o.point("shadow"===e?n.shadowAnchor||n.iconAnchor:n.iconAnchor),!i&&s&&(i=s.divideBy(2,!0)),t.className="leaflet-marker-"+e+" "+n.className,i&&(t.style.marginLeft=-i.x+"px",t.style.marginTop=-i.y+"px"),s&&(t.style.width=s.x+"px",t.style.height=s.y+"px")},_createImg:function(t,i){return i=i||e.createElement("img"),i.src=t,i},_getIconUrl:function(t){return o.Browser.retina&&this.options[t+"RetinaUrl"]?this.options[t+"RetinaUrl"]:this.options[t+"Url"]}}),o.icon=function(t){return new o.Icon(t)},o.Icon.Default=o.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]},_getIconUrl:function(t){var e=t+"Url";if(this.options[e])return this.options[e];o.Browser.retina&&"icon"===t&&(t+="-2x");var i=o.Icon.Default.imagePath;if(!i)throw new Error("Couldn't autodetect L.Icon.Default.imagePath, set it manually.");return i+"/marker-"+t+".png"}}),o.Icon.Default.imagePath=function(){var t,i,n,o,s,a=e.getElementsByTagName("script"),r=/[\/^]leaflet[\-\._]?([\w\-\._]*)\.js\??/;for(t=0,i=a.length;i>t;t++)if(n=a[t].src,o=n.match(r))return s=n.split(r)[0],(s?s+"/":"")+"images"}(),o.Marker=o.Class.extend({includes:o.Mixin.Events,options:{icon:new o.Icon.Default,title:"",alt:"",clickable:!0,draggable:!1,keyboard:!0,zIndexOffset:0,opacity:1,riseOnHover:!1,riseOffset:250},initialize:function(t,e){o.setOptions(this,e),this._latlng=o.latLng(t)},onAdd:function(t){this._map=t,t.on("viewreset",this.update,this),this._initIcon(),this.update(),this.fire("add"),t.options.zoomAnimation&&t.options.markerZoomAnimation&&t.on("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this.dragging&&this.dragging.disable(),this._removeIcon(),this._removeShadow(),this.fire("remove"),t.off({viewreset:this.update,zoomanim:this._animateZoom},this),this._map=null},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=o.latLng(t),this.update(),this.fire("move",{latlng:this._latlng})},setZIndexOffset:function(t){return this.options.zIndexOffset=t,this.update(),this},setIcon:function(t){return this.options.icon=t,this._map&&(this._initIcon(),this.update()),this._popup&&this.bindPopup(this._popup),this},update:function(){if(this._icon){var t=this._map.latLngToLayerPoint(this._latlng).round();this._setPos(t)}return this},_initIcon:function(){var t=this.options,e=this._map,i=e.options.zoomAnimation&&e.options.markerZoomAnimation,n=i?"leaflet-zoom-animated":"leaflet-zoom-hide",s=t.icon.createIcon(this._icon),a=!1;s!==this._icon&&(this._icon&&this._removeIcon(),a=!0,t.title&&(s.title=t.title),t.alt&&(s.alt=t.alt)),o.DomUtil.addClass(s,n),t.keyboard&&(s.tabIndex="0"),this._icon=s,this._initInteraction(),t.riseOnHover&&o.DomEvent.on(s,"mouseover",this._bringToFront,this).on(s,"mouseout",this._resetZIndex,this);var r=t.icon.createShadow(this._shadow),h=!1;r!==this._shadow&&(this._removeShadow(),h=!0),r&&o.DomUtil.addClass(r,n),this._shadow=r,t.opacity<1&&this._updateOpacity();var l=this._map._panes;a&&l.markerPane.appendChild(this._icon),r&&h&&l.shadowPane.appendChild(this._shadow)},_removeIcon:function(){this.options.riseOnHover&&o.DomEvent.off(this._icon,"mouseover",this._bringToFront).off(this._icon,"mouseout",this._resetZIndex),this._map._panes.markerPane.removeChild(this._icon),this._icon=null},_removeShadow:function(){this._shadow&&this._map._panes.shadowPane.removeChild(this._shadow),this._shadow=null},_setPos:function(t){o.DomUtil.setPosition(this._icon,t),this._shadow&&o.DomUtil.setPosition(this._shadow,t),this._zIndex=t.y+this.options.zIndexOffset,this._resetZIndex()},_updateZIndex:function(t){this._icon.style.zIndex=this._zIndex+t},_animateZoom:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center).round();this._setPos(e)},_initInteraction:function(){if(this.options.clickable){var t=this._icon,e=["dblclick","mousedown","mouseover","mouseout","contextmenu"];o.DomUtil.addClass(t,"leaflet-clickable"),o.DomEvent.on(t,"click",this._onMouseClick,this),o.DomEvent.on(t,"keypress",this._onKeyPress,this);for(var i=0;i<e.length;i++)o.DomEvent.on(t,e[i],this._fireMouseEvent,this);o.Handler.MarkerDrag&&(this.dragging=new o.Handler.MarkerDrag(this),this.options.draggable&&this.dragging.enable())}},_onMouseClick:function(t){var e=this.dragging&&this.dragging.moved();(this.hasEventListeners(t.type)||e)&&o.DomEvent.stopPropagation(t),e||(this.dragging&&this.dragging._enabled||!this._map.dragging||!this._map.dragging.moved())&&this.fire(t.type,{originalEvent:t,latlng:this._latlng})},_onKeyPress:function(t){13===t.keyCode&&this.fire("click",{originalEvent:t,latlng:this._latlng})},_fireMouseEvent:function(t){this.fire(t.type,{originalEvent:t,latlng:this._latlng}),"contextmenu"===t.type&&this.hasEventListeners(t.type)&&o.DomEvent.preventDefault(t),"mousedown"!==t.type?o.DomEvent.stopPropagation(t):o.DomEvent.preventDefault(t)},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},_updateOpacity:function(){o.DomUtil.setOpacity(this._icon,this.options.opacity),this._shadow&&o.DomUtil.setOpacity(this._shadow,this.options.opacity)},_bringToFront:function(){this._updateZIndex(this.options.riseOffset)},_resetZIndex:function(){this._updateZIndex(0)}}),o.marker=function(t,e){return new o.Marker(t,e)},o.DivIcon=o.Icon.extend({options:{iconSize:[12,12],className:"leaflet-div-icon",html:!1},createIcon:function(t){var i=t&&"DIV"===t.tagName?t:e.createElement("div"),n=this.options;return i.innerHTML=n.html!==!1?n.html:"",n.bgPos&&(i.style.backgroundPosition=-n.bgPos.x+"px "+-n.bgPos.y+"px"),this._setIconStyles(i,"icon"),i},createShadow:function(){return null}}),o.divIcon=function(t){return new o.DivIcon(t)},o.Map.mergeOptions({closePopupOnClick:!0}),o.Popup=o.Class.extend({includes:o.Mixin.Events,options:{minWidth:50,maxWidth:300,autoPan:!0,closeButton:!0,offset:[0,7],autoPanPadding:[5,5],keepInView:!1,className:"",zoomAnimation:!0},initialize:function(t,e){o.setOptions(this,t),this._source=e,this._animated=o.Browser.any3d&&this.options.zoomAnimation,this._isOpen=!1},onAdd:function(t){this._map=t,this._container||this._initLayout();var e=t.options.fadeAnimation;e&&o.DomUtil.setOpacity(this._container,0),t._panes.popupPane.appendChild(this._container),t.on(this._getEvents(),this),this.update(),e&&o.DomUtil.setOpacity(this._container,1),this.fire("open"),t.fire("popupopen",{popup:this}),this._source&&this._source.fire("popupopen",{popup:this})},addTo:function(t){return t.addLayer(this),this},openOn:function(t){return t.openPopup(this),this},onRemove:function(t){t._panes.popupPane.removeChild(this._container),o.Util.falseFn(this._container.offsetWidth),t.off(this._getEvents(),this),t.options.fadeAnimation&&o.DomUtil.setOpacity(this._container,0),this._map=null,this.fire("close"),t.fire("popupclose",{popup:this}),this._source&&this._source.fire("popupclose",{popup:this})},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=o.latLng(t),this._map&&(this._updatePosition(),this._adjustPan()),this},getContent:function(){return this._content},setContent:function(t){return this._content=t,this.update(),this},update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this._adjustPan())},_getEvents:function(){var t={viewreset:this._updatePosition};return this._animated&&(t.zoomanim=this._zoomAnimation),("closeOnClick"in this.options?this.options.closeOnClick:this._map.options.closePopupOnClick)&&(t.preclick=this._close),this.options.keepInView&&(t.moveend=this._adjustPan),t},_close:function(){this._map&&this._map.closePopup(this)},_initLayout:function(){var t,e="leaflet-popup",i=e+" "+this.options.className+" leaflet-zoom-"+(this._animated?"animated":"hide"),n=this._container=o.DomUtil.create("div",i);this.options.closeButton&&(t=this._closeButton=o.DomUtil.create("a",e+"-close-button",n),t.href="#close",t.innerHTML="&#215;",o.DomEvent.disableClickPropagation(t),o.DomEvent.on(t,"click",this._onCloseButtonClick,this));var s=this._wrapper=o.DomUtil.create("div",e+"-content-wrapper",n);o.DomEvent.disableClickPropagation(s),this._contentNode=o.DomUtil.create("div",e+"-content",s),o.DomEvent.disableScrollPropagation(this._contentNode),o.DomEvent.on(s,"contextmenu",o.DomEvent.stopPropagation),this._tipContainer=o.DomUtil.create("div",e+"-tip-container",n),this._tip=o.DomUtil.create("div",e+"-tip",this._tipContainer)},_updateContent:function(){if(this._content){if("string"==typeof this._content)this._contentNode.innerHTML=this._content;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(this._content)}this.fire("contentupdate")}},_updateLayout:function(){var t=this._contentNode,e=t.style;e.width="",e.whiteSpace="nowrap";var i=t.offsetWidth;i=Math.min(i,this.options.maxWidth),i=Math.max(i,this.options.minWidth),e.width=i+1+"px",e.whiteSpace="",e.height="";var n=t.offsetHeight,s=this.options.maxHeight,a="leaflet-popup-scrolled";s&&n>s?(e.height=s+"px",o.DomUtil.addClass(t,a)):o.DomUtil.removeClass(t,a),this._containerWidth=this._container.offsetWidth},_updatePosition:function(){if(this._map){var t=this._map.latLngToLayerPoint(this._latlng),e=this._animated,i=o.point(this.options.offset);e&&o.DomUtil.setPosition(this._container,t),this._containerBottom=-i.y-(e?0:t.y),this._containerLeft=-Math.round(this._containerWidth/2)+i.x+(e?0:t.x),this._container.style.bottom=this._containerBottom+"px",this._container.style.left=this._containerLeft+"px"}},_zoomAnimation:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center);o.DomUtil.setPosition(this._container,e)},_adjustPan:function(){if(this.options.autoPan){var t=this._map,e=this._container.offsetHeight,i=this._containerWidth,n=new o.Point(this._containerLeft,-e-this._containerBottom);this._animated&&n._add(o.DomUtil.getPosition(this._container));var s=t.layerPointToContainerPoint(n),a=o.point(this.options.autoPanPadding),r=o.point(this.options.autoPanPaddingTopLeft||a),h=o.point(this.options.autoPanPaddingBottomRight||a),l=t.getSize(),u=0,c=0;s.x+i+h.x>l.x&&(u=s.x+i-l.x+h.x),s.x-u-r.x<0&&(u=s.x-r.x),s.y+e+h.y>l.y&&(c=s.y+e-l.y+h.y),s.y-c-r.y<0&&(c=s.y-r.y),(u||c)&&t.fire("autopanstart").panBy([u,c])}},_onCloseButtonClick:function(t){this._close(),o.DomEvent.stop(t)}}),o.popup=function(t,e){return new o.Popup(t,e)},o.Map.include({openPopup:function(t,e,i){if(this.closePopup(),!(t instanceof o.Popup)){var n=t;t=new o.Popup(i).setLatLng(e).setContent(n)}return t._isOpen=!0,this._popup=t,this.addLayer(t)},closePopup:function(t){return t&&t!==this._popup||(t=this._popup,this._popup=null),t&&(this.removeLayer(t),t._isOpen=!1),this}}),o.Marker.include({openPopup:function(){return this._popup&&this._map&&!this._map.hasLayer(this._popup)&&(this._popup.setLatLng(this._latlng),this._map.openPopup(this._popup)),this},closePopup:function(){return this._popup&&this._popup._close(),this},togglePopup:function(){return this._popup&&(this._popup._isOpen?this.closePopup():this.openPopup()),this},bindPopup:function(t,e){var i=o.point(this.options.icon.options.popupAnchor||[0,0]);return i=i.add(o.Popup.prototype.options.offset),e&&e.offset&&(i=i.add(e.offset)),e=o.extend({offset:i},e),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),t instanceof o.Popup?(o.setOptions(t,e),this._popup=t):this._popup=new o.Popup(e,this).setContent(t),this},setPopupContent:function(t){return this._popup&&this._popup.setContent(t),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this.togglePopup,this).off("remove",this.closePopup,this).off("move",this._movePopup,this),this._popupHandlersAdded=!1),this},getPopup:function(){return this._popup},_movePopup:function(t){this._popup.setLatLng(t.latlng)}}),o.LayerGroup=o.Class.extend({initialize:function(t){this._layers={};var e,i;if(t)for(e=0,i=t.length;i>e;e++)this.addLayer(t[e])},addLayer:function(t){var e=this.getLayerId(t);return this._layers[e]=t,this._map&&this._map.addLayer(t),this},removeLayer:function(t){var e=t in this._layers?t:this.getLayerId(t);return this._map&&this._layers[e]&&this._map.removeLayer(this._layers[e]),delete this._layers[e],this},hasLayer:function(t){return t?t in this._layers||this.getLayerId(t)in this._layers:!1},clearLayers:function(){return this.eachLayer(this.removeLayer,this),this},invoke:function(t){var e,i,n=Array.prototype.slice.call(arguments,1);for(e in this._layers)i=this._layers[e],i[t]&&i[t].apply(i,n);return this},onAdd:function(t){this._map=t,this.eachLayer(t.addLayer,t)},onRemove:function(t){this.eachLayer(t.removeLayer,t),this._map=null},addTo:function(t){return t.addLayer(this),this},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getLayer:function(t){return this._layers[t]},getLayers:function(){var t=[];for(var e in this._layers)t.push(this._layers[e]);return t},setZIndex:function(t){return this.invoke("setZIndex",t)},getLayerId:function(t){return o.stamp(t)}}),o.layerGroup=function(t){return new o.LayerGroup(t)},o.FeatureGroup=o.LayerGroup.extend({includes:o.Mixin.Events,statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose"},addLayer:function(t){return this.hasLayer(t)?this:("on"in t&&t.on(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.addLayer.call(this,t),this._popupContent&&t.bindPopup&&t.bindPopup(this._popupContent,this._popupOptions),this.fire("layeradd",{layer:t}))},removeLayer:function(t){return this.hasLayer(t)?(t in this._layers&&(t=this._layers[t]),t.off(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.removeLayer.call(this,t),this._popupContent&&this.invoke("unbindPopup"),this.fire("layerremove",{layer:t})):this},bindPopup:function(t,e){return this._popupContent=t,this._popupOptions=e,this.invoke("bindPopup",t,e)},openPopup:function(t){for(var e in this._layers){this._layers[e].openPopup(t);break}return this},setStyle:function(t){return this.invoke("setStyle",t)},bringToFront:function(){return this.invoke("bringToFront")},bringToBack:function(){return this.invoke("bringToBack")},getBounds:function(){var t=new o.LatLngBounds;return this.eachLayer(function(e){t.extend(e instanceof o.Marker?e.getLatLng():e.getBounds())}),t},_propagateEvent:function(t){t=o.extend({layer:t.target,target:this},t),this.fire(t.type,t)}}),o.featureGroup=function(t){return new o.FeatureGroup(t)},o.Path=o.Class.extend({includes:[o.Mixin.Events],statics:{CLIP_PADDING:function(){var e=o.Browser.mobile?1280:2e3,i=(e/Math.max(t.outerWidth,t.outerHeight)-1)/2;return Math.max(0,Math.min(.5,i))}()},options:{stroke:!0,color:"#0033ff",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:.5,fill:!1,fillColor:null,fillOpacity:.2,clickable:!0},initialize:function(t){o.setOptions(this,t)},onAdd:function(t){this._map=t,this._container||(this._initElements(),this._initEvents()),this.projectLatlngs(),this._updatePath(),this._container&&this._map._pathRoot.appendChild(this._container),this.fire("add"),t.on({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){t._pathRoot.removeChild(this._container),this.fire("remove"),this._map=null,o.Browser.vml&&(this._container=null,this._stroke=null,this._fill=null),t.off({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},projectLatlngs:function(){},setStyle:function(t){return o.setOptions(this,t),this._container&&this._updateStyle(),this},redraw:function(){return this._map&&(this.projectLatlngs(),this._updatePath()),this}}),o.Map.include({_updatePathViewport:function(){var t=o.Path.CLIP_PADDING,e=this.getSize(),i=o.DomUtil.getPosition(this._mapPane),n=i.multiplyBy(-1)._subtract(e.multiplyBy(t)._round()),s=n.add(e.multiplyBy(1+2*t)._round());this._pathViewport=new o.Bounds(n,s)}}),o.Path.SVG_NS="http://www.w3.org/2000/svg",o.Browser.svg=!(!e.createElementNS||!e.createElementNS(o.Path.SVG_NS,"svg").createSVGRect),o.Path=o.Path.extend({statics:{SVG:o.Browser.svg},bringToFront:function(){var t=this._map._pathRoot,e=this._container;return e&&t.lastChild!==e&&t.appendChild(e),this},bringToBack:function(){var t=this._map._pathRoot,e=this._container,i=t.firstChild;return e&&i!==e&&t.insertBefore(e,i),this},getPathString:function(){},_createElement:function(t){return e.createElementNS(o.Path.SVG_NS,t)},_initElements:function(){this._map._initPathRoot(),this._initPath(),this._initStyle()},_initPath:function(){this._container=this._createElement("g"),this._path=this._createElement("path"),this.options.className&&o.DomUtil.addClass(this._path,this.options.className),this._container.appendChild(this._path)},_initStyle:function(){this.options.stroke&&(this._path.setAttribute("stroke-linejoin","round"),this._path.setAttribute("stroke-linecap","round")),this.options.fill&&this._path.setAttribute("fill-rule","evenodd"),this.options.pointerEvents&&this._path.setAttribute("pointer-events",this.options.pointerEvents),this.options.clickable||this.options.pointerEvents||this._path.setAttribute("pointer-events","none"),this._updateStyle()},_updateStyle:function(){this.options.stroke?(this._path.setAttribute("stroke",this.options.color),this._path.setAttribute("stroke-opacity",this.options.opacity),this._path.setAttribute("stroke-width",this.options.weight),this.options.dashArray?this._path.setAttribute("stroke-dasharray",this.options.dashArray):this._path.removeAttribute("stroke-dasharray"),this.options.lineCap&&this._path.setAttribute("stroke-linecap",this.options.lineCap),this.options.lineJoin&&this._path.setAttribute("stroke-linejoin",this.options.lineJoin)):this._path.setAttribute("stroke","none"),this.options.fill?(this._path.setAttribute("fill",this.options.fillColor||this.options.color),this._path.setAttribute("fill-opacity",this.options.fillOpacity)):this._path.setAttribute("fill","none")},_updatePath:function(){var t=this.getPathString();t||(t="M0 0"),this._path.setAttribute("d",t)},_initEvents:function(){if(this.options.clickable){(o.Browser.svg||!o.Browser.vml)&&o.DomUtil.addClass(this._path,"leaflet-clickable"),o.DomEvent.on(this._container,"click",this._onMouseClick,this);for(var t=["dblclick","mousedown","mouseover","mouseout","mousemove","contextmenu"],e=0;e<t.length;e++)o.DomEvent.on(this._container,t[e],this._fireMouseEvent,this)}},_onMouseClick:function(t){this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(t)},_fireMouseEvent:function(t){if(this.hasEventListeners(t.type)){var e=this._map,i=e.mouseEventToContainerPoint(t),n=e.containerPointToLayerPoint(i),s=e.layerPointToLatLng(n);this.fire(t.type,{latlng:s,layerPoint:n,containerPoint:i,originalEvent:t}),"contextmenu"===t.type&&o.DomEvent.preventDefault(t),"mousemove"!==t.type&&o.DomEvent.stopPropagation(t)}}}),o.Map.include({_initPathRoot:function(){this._pathRoot||(this._pathRoot=o.Path.prototype._createElement("svg"),this._panes.overlayPane.appendChild(this._pathRoot),this.options.zoomAnimation&&o.Browser.any3d?(o.DomUtil.addClass(this._pathRoot,"leaflet-zoom-animated"),this.on({zoomanim:this._animatePathZoom,zoomend:this._endPathZoom})):o.DomUtil.addClass(this._pathRoot,"leaflet-zoom-hide"),this.on("moveend",this._updateSvgViewport),this._updateSvgViewport())
+},_animatePathZoom:function(t){var e=this.getZoomScale(t.zoom),i=this._getCenterOffset(t.center)._multiplyBy(-e)._add(this._pathViewport.min);this._pathRoot.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(i)+" scale("+e+") ",this._pathZooming=!0},_endPathZoom:function(){this._pathZooming=!1},_updateSvgViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max,n=i.x-e.x,s=i.y-e.y,a=this._pathRoot,r=this._panes.overlayPane;o.Browser.mobileWebkit&&r.removeChild(a),o.DomUtil.setPosition(a,e),a.setAttribute("width",n),a.setAttribute("height",s),a.setAttribute("viewBox",[e.x,e.y,n,s].join(" ")),o.Browser.mobileWebkit&&r.appendChild(a)}}}),o.Path.include({bindPopup:function(t,e){return t instanceof o.Popup?this._popup=t:((!this._popup||e)&&(this._popup=new o.Popup(e,this)),this._popup.setContent(t)),this._popupHandlersAdded||(this.on("click",this._openPopup,this).on("remove",this.closePopup,this),this._popupHandlersAdded=!0),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openPopup).off("remove",this.closePopup),this._popupHandlersAdded=!1),this},openPopup:function(t){return this._popup&&(t=t||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],this._openPopup({latlng:t})),this},closePopup:function(){return this._popup&&this._popup._close(),this},_openPopup:function(t){this._popup.setLatLng(t.latlng),this._map.openPopup(this._popup)}}),o.Browser.vml=!o.Browser.svg&&function(){try{var t=e.createElement("div");t.innerHTML='<v:shape adj="1"/>';var i=t.firstChild;return i.style.behavior="url(#default#VML)",i&&"object"==typeof i.adj}catch(n){return!1}}(),o.Path=o.Browser.svg||!o.Browser.vml?o.Path:o.Path.extend({statics:{VML:!0,CLIP_PADDING:.02},_createElement:function(){try{return e.namespaces.add("lvml","urn:schemas-microsoft-com:vml"),function(t){return e.createElement("<lvml:"+t+' class="lvml">')}}catch(t){return function(t){return e.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="lvml">')}}}(),_initPath:function(){var t=this._container=this._createElement("shape");o.DomUtil.addClass(t,"leaflet-vml-shape"+(this.options.className?" "+this.options.className:"")),this.options.clickable&&o.DomUtil.addClass(t,"leaflet-clickable"),t.coordsize="1 1",this._path=this._createElement("path"),t.appendChild(this._path),this._map._pathRoot.appendChild(t)},_initStyle:function(){this._updateStyle()},_updateStyle:function(){var t=this._stroke,e=this._fill,i=this.options,n=this._container;n.stroked=i.stroke,n.filled=i.fill,i.stroke?(t||(t=this._stroke=this._createElement("stroke"),t.endcap="round",n.appendChild(t)),t.weight=i.weight+"px",t.color=i.color,t.opacity=i.opacity,t.dashStyle=i.dashArray?o.Util.isArray(i.dashArray)?i.dashArray.join(" "):i.dashArray.replace(/( *, *)/g," "):"",i.lineCap&&(t.endcap=i.lineCap.replace("butt","flat")),i.lineJoin&&(t.joinstyle=i.lineJoin)):t&&(n.removeChild(t),this._stroke=null),i.fill?(e||(e=this._fill=this._createElement("fill"),n.appendChild(e)),e.color=i.fillColor||i.color,e.opacity=i.fillOpacity):e&&(n.removeChild(e),this._fill=null)},_updatePath:function(){var t=this._container.style;t.display="none",this._path.v=this.getPathString()+" ",t.display=""}}),o.Map.include(o.Browser.svg||!o.Browser.vml?{}:{_initPathRoot:function(){if(!this._pathRoot){var t=this._pathRoot=e.createElement("div");t.className="leaflet-vml-container",this._panes.overlayPane.appendChild(t),this.on("moveend",this._updatePathViewport),this._updatePathViewport()}}}),o.Browser.canvas=function(){return!!e.createElement("canvas").getContext}(),o.Path=o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?o.Path:o.Path.extend({statics:{CANVAS:!0,SVG:!1},redraw:function(){return this._map&&(this.projectLatlngs(),this._requestUpdate()),this},setStyle:function(t){return o.setOptions(this,t),this._map&&(this._updateStyle(),this._requestUpdate()),this},onRemove:function(t){t.off("viewreset",this.projectLatlngs,this).off("moveend",this._updatePath,this),this.options.clickable&&(this._map.off("click",this._onClick,this),this._map.off("mousemove",this._onMouseMove,this)),this._requestUpdate(),this._map=null},_requestUpdate:function(){this._map&&!o.Path._updateRequest&&(o.Path._updateRequest=o.Util.requestAnimFrame(this._fireMapMoveEnd,this._map))},_fireMapMoveEnd:function(){o.Path._updateRequest=null,this.fire("moveend")},_initElements:function(){this._map._initPathRoot(),this._ctx=this._map._canvasCtx},_updateStyle:function(){var t=this.options;t.stroke&&(this._ctx.lineWidth=t.weight,this._ctx.strokeStyle=t.color),t.fill&&(this._ctx.fillStyle=t.fillColor||t.color)},_drawPath:function(){var t,e,i,n,s,a;for(this._ctx.beginPath(),t=0,i=this._parts.length;i>t;t++){for(e=0,n=this._parts[t].length;n>e;e++)s=this._parts[t][e],a=(0===e?"move":"line")+"To",this._ctx[a](s.x,s.y);this instanceof o.Polygon&&this._ctx.closePath()}},_checkIfEmpty:function(){return!this._parts.length},_updatePath:function(){if(!this._checkIfEmpty()){var t=this._ctx,e=this.options;this._drawPath(),t.save(),this._updateStyle(),e.fill&&(t.globalAlpha=e.fillOpacity,t.fill()),e.stroke&&(t.globalAlpha=e.opacity,t.stroke()),t.restore()}},_initEvents:function(){this.options.clickable&&(this._map.on("mousemove",this._onMouseMove,this),this._map.on("click",this._onClick,this))},_onClick:function(t){this._containsPoint(t.layerPoint)&&this.fire("click",t)},_onMouseMove:function(t){this._map&&!this._map._animatingZoom&&(this._containsPoint(t.layerPoint)?(this._ctx.canvas.style.cursor="pointer",this._mouseInside=!0,this.fire("mouseover",t)):this._mouseInside&&(this._ctx.canvas.style.cursor="",this._mouseInside=!1,this.fire("mouseout",t)))}}),o.Map.include(o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?{}:{_initPathRoot:function(){var t,i=this._pathRoot;i||(i=this._pathRoot=e.createElement("canvas"),i.style.position="absolute",t=this._canvasCtx=i.getContext("2d"),t.lineCap="round",t.lineJoin="round",this._panes.overlayPane.appendChild(i),this.options.zoomAnimation&&(this._pathRoot.className="leaflet-zoom-animated",this.on("zoomanim",this._animatePathZoom),this.on("zoomend",this._endPathZoom)),this.on("moveend",this._updateCanvasViewport),this._updateCanvasViewport())},_updateCanvasViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max.subtract(e),n=this._pathRoot;o.DomUtil.setPosition(n,e),n.width=i.x,n.height=i.y,n.getContext("2d").translate(-e.x,-e.y)}}}),o.LineUtil={simplify:function(t,e){if(!e||!t.length)return t.slice();var i=e*e;return t=this._reducePoints(t,i),t=this._simplifyDP(t,i)},pointToSegmentDistance:function(t,e,i){return Math.sqrt(this._sqClosestPointOnSegment(t,e,i,!0))},closestPointOnSegment:function(t,e,i){return this._sqClosestPointOnSegment(t,e,i)},_simplifyDP:function(t,e){var n=t.length,o=typeof Uint8Array!=i+""?Uint8Array:Array,s=new o(n);s[0]=s[n-1]=1,this._simplifyDPStep(t,s,e,0,n-1);var a,r=[];for(a=0;n>a;a++)s[a]&&r.push(t[a]);return r},_simplifyDPStep:function(t,e,i,n,o){var s,a,r,h=0;for(a=n+1;o-1>=a;a++)r=this._sqClosestPointOnSegment(t[a],t[n],t[o],!0),r>h&&(s=a,h=r);h>i&&(e[s]=1,this._simplifyDPStep(t,e,i,n,s),this._simplifyDPStep(t,e,i,s,o))},_reducePoints:function(t,e){for(var i=[t[0]],n=1,o=0,s=t.length;s>n;n++)this._sqDist(t[n],t[o])>e&&(i.push(t[n]),o=n);return s-1>o&&i.push(t[s-1]),i},clipSegment:function(t,e,i,n){var o,s,a,r=n?this._lastCode:this._getBitCode(t,i),h=this._getBitCode(e,i);for(this._lastCode=h;;){if(!(r|h))return[t,e];if(r&h)return!1;o=r||h,s=this._getEdgeIntersection(t,e,o,i),a=this._getBitCode(s,i),o===r?(t=s,r=a):(e=s,h=a)}},_getEdgeIntersection:function(t,e,i,n){var s=e.x-t.x,a=e.y-t.y,r=n.min,h=n.max;return 8&i?new o.Point(t.x+s*(h.y-t.y)/a,h.y):4&i?new o.Point(t.x+s*(r.y-t.y)/a,r.y):2&i?new o.Point(h.x,t.y+a*(h.x-t.x)/s):1&i?new o.Point(r.x,t.y+a*(r.x-t.x)/s):void 0},_getBitCode:function(t,e){var i=0;return t.x<e.min.x?i|=1:t.x>e.max.x&&(i|=2),t.y<e.min.y?i|=4:t.y>e.max.y&&(i|=8),i},_sqDist:function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},_sqClosestPointOnSegment:function(t,e,i,n){var s,a=e.x,r=e.y,h=i.x-a,l=i.y-r,u=h*h+l*l;return u>0&&(s=((t.x-a)*h+(t.y-r)*l)/u,s>1?(a=i.x,r=i.y):s>0&&(a+=h*s,r+=l*s)),h=t.x-a,l=t.y-r,n?h*h+l*l:new o.Point(a,r)}},o.Polyline=o.Path.extend({initialize:function(t,e){o.Path.prototype.initialize.call(this,e),this._latlngs=this._convertLatLngs(t)},options:{smoothFactor:1,noClip:!1},projectLatlngs:function(){this._originalPoints=[];for(var t=0,e=this._latlngs.length;e>t;t++)this._originalPoints[t]=this._map.latLngToLayerPoint(this._latlngs[t])},getPathString:function(){for(var t=0,e=this._parts.length,i="";e>t;t++)i+=this._getPathPartStr(this._parts[t]);return i},getLatLngs:function(){return this._latlngs},setLatLngs:function(t){return this._latlngs=this._convertLatLngs(t),this.redraw()},addLatLng:function(t){return this._latlngs.push(o.latLng(t)),this.redraw()},spliceLatLngs:function(){var t=[].splice.apply(this._latlngs,arguments);return this._convertLatLngs(this._latlngs,!0),this.redraw(),t},closestLayerPoint:function(t){for(var e,i,n=1/0,s=this._parts,a=null,r=0,h=s.length;h>r;r++)for(var l=s[r],u=1,c=l.length;c>u;u++){e=l[u-1],i=l[u];var d=o.LineUtil._sqClosestPointOnSegment(t,e,i,!0);n>d&&(n=d,a=o.LineUtil._sqClosestPointOnSegment(t,e,i))}return a&&(a.distance=Math.sqrt(n)),a},getBounds:function(){return new o.LatLngBounds(this.getLatLngs())},_convertLatLngs:function(t,e){var i,n,s=e?t:[];for(i=0,n=t.length;n>i;i++){if(o.Util.isArray(t[i])&&"number"!=typeof t[i][0])return;s[i]=o.latLng(t[i])}return s},_initEvents:function(){o.Path.prototype._initEvents.call(this)},_getPathPartStr:function(t){for(var e,i=o.Path.VML,n=0,s=t.length,a="";s>n;n++)e=t[n],i&&e._round(),a+=(n?"L":"M")+e.x+" "+e.y;return a},_clipPoints:function(){var t,e,i,n=this._originalPoints,s=n.length;if(this.options.noClip)return void(this._parts=[n]);this._parts=[];var a=this._parts,r=this._map._pathViewport,h=o.LineUtil;for(t=0,e=0;s-1>t;t++)i=h.clipSegment(n[t],n[t+1],r,t),i&&(a[e]=a[e]||[],a[e].push(i[0]),(i[1]!==n[t+1]||t===s-2)&&(a[e].push(i[1]),e++))},_simplifyPoints:function(){for(var t=this._parts,e=o.LineUtil,i=0,n=t.length;n>i;i++)t[i]=e.simplify(t[i],this.options.smoothFactor)},_updatePath:function(){this._map&&(this._clipPoints(),this._simplifyPoints(),o.Path.prototype._updatePath.call(this))}}),o.polyline=function(t,e){return new o.Polyline(t,e)},o.PolyUtil={},o.PolyUtil.clipPolygon=function(t,e){var i,n,s,a,r,h,l,u,c,d=[1,4,2,8],p=o.LineUtil;for(n=0,l=t.length;l>n;n++)t[n]._code=p._getBitCode(t[n],e);for(a=0;4>a;a++){for(u=d[a],i=[],n=0,l=t.length,s=l-1;l>n;s=n++)r=t[n],h=t[s],r._code&u?h._code&u||(c=p._getEdgeIntersection(h,r,u,e),c._code=p._getBitCode(c,e),i.push(c)):(h._code&u&&(c=p._getEdgeIntersection(h,r,u,e),c._code=p._getBitCode(c,e),i.push(c)),i.push(r));t=i}return t},o.Polygon=o.Polyline.extend({options:{fill:!0},initialize:function(t,e){o.Polyline.prototype.initialize.call(this,t,e),this._initWithHoles(t)},_initWithHoles:function(t){var e,i,n;if(t&&o.Util.isArray(t[0])&&"number"!=typeof t[0][0])for(this._latlngs=this._convertLatLngs(t[0]),this._holes=t.slice(1),e=0,i=this._holes.length;i>e;e++)n=this._holes[e]=this._convertLatLngs(this._holes[e]),n[0].equals(n[n.length-1])&&n.pop();t=this._latlngs,t.length>=2&&t[0].equals(t[t.length-1])&&t.pop()},projectLatlngs:function(){if(o.Polyline.prototype.projectLatlngs.call(this),this._holePoints=[],this._holes){var t,e,i,n;for(t=0,i=this._holes.length;i>t;t++)for(this._holePoints[t]=[],e=0,n=this._holes[t].length;n>e;e++)this._holePoints[t][e]=this._map.latLngToLayerPoint(this._holes[t][e])}},setLatLngs:function(t){return t&&o.Util.isArray(t[0])&&"number"!=typeof t[0][0]?(this._initWithHoles(t),this.redraw()):o.Polyline.prototype.setLatLngs.call(this,t)},_clipPoints:function(){var t=this._originalPoints,e=[];if(this._parts=[t].concat(this._holePoints),!this.options.noClip){for(var i=0,n=this._parts.length;n>i;i++){var s=o.PolyUtil.clipPolygon(this._parts[i],this._map._pathViewport);s.length&&e.push(s)}this._parts=e}},_getPathPartStr:function(t){var e=o.Polyline.prototype._getPathPartStr.call(this,t);return e+(o.Browser.svg?"z":"x")}}),o.polygon=function(t,e){return new o.Polygon(t,e)},function(){function t(t){return o.FeatureGroup.extend({initialize:function(t,e){this._layers={},this._options=e,this.setLatLngs(t)},setLatLngs:function(e){var i=0,n=e.length;for(this.eachLayer(function(t){n>i?t.setLatLngs(e[i++]):this.removeLayer(t)},this);n>i;)this.addLayer(new t(e[i++],this._options));return this},getLatLngs:function(){var t=[];return this.eachLayer(function(e){t.push(e.getLatLngs())}),t}})}o.MultiPolyline=t(o.Polyline),o.MultiPolygon=t(o.Polygon),o.multiPolyline=function(t,e){return new o.MultiPolyline(t,e)},o.multiPolygon=function(t,e){return new o.MultiPolygon(t,e)}}(),o.Rectangle=o.Polygon.extend({initialize:function(t,e){o.Polygon.prototype.initialize.call(this,this._boundsToLatLngs(t),e)},setBounds:function(t){this.setLatLngs(this._boundsToLatLngs(t))},_boundsToLatLngs:function(t){return t=o.latLngBounds(t),[t.getSouthWest(),t.getNorthWest(),t.getNorthEast(),t.getSouthEast()]}}),o.rectangle=function(t,e){return new o.Rectangle(t,e)},o.Circle=o.Path.extend({initialize:function(t,e,i){o.Path.prototype.initialize.call(this,i),this._latlng=o.latLng(t),this._mRadius=e},options:{fill:!0},setLatLng:function(t){return this._latlng=o.latLng(t),this.redraw()},setRadius:function(t){return this._mRadius=t,this.redraw()},projectLatlngs:function(){var t=this._getLngRadius(),e=this._latlng,i=this._map.latLngToLayerPoint([e.lat,e.lng-t]);this._point=this._map.latLngToLayerPoint(e),this._radius=Math.max(this._point.x-i.x,1)},getBounds:function(){var t=this._getLngRadius(),e=this._mRadius/40075017*360,i=this._latlng;return new o.LatLngBounds([i.lat-e,i.lng-t],[i.lat+e,i.lng+t])},getLatLng:function(){return this._latlng},getPathString:function(){var t=this._point,e=this._radius;return this._checkIfEmpty()?"":o.Browser.svg?"M"+t.x+","+(t.y-e)+"A"+e+","+e+",0,1,1,"+(t.x-.1)+","+(t.y-e)+" z":(t._round(),e=Math.round(e),"AL "+t.x+","+t.y+" "+e+","+e+" 0,23592600")},getRadius:function(){return this._mRadius},_getLatRadius:function(){return this._mRadius/40075017*360},_getLngRadius:function(){return this._getLatRadius()/Math.cos(o.LatLng.DEG_TO_RAD*this._latlng.lat)},_checkIfEmpty:function(){if(!this._map)return!1;var t=this._map._pathViewport,e=this._radius,i=this._point;return i.x-e>t.max.x||i.y-e>t.max.y||i.x+e<t.min.x||i.y+e<t.min.y}}),o.circle=function(t,e,i){return new o.Circle(t,e,i)},o.CircleMarker=o.Circle.extend({options:{radius:10,weight:2},initialize:function(t,e){o.Circle.prototype.initialize.call(this,t,null,e),this._radius=this.options.radius},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_updateStyle:function(){o.Circle.prototype._updateStyle.call(this),this.setRadius(this.options.radius)},setLatLng:function(t){return o.Circle.prototype.setLatLng.call(this,t),this._popup&&this._popup._isOpen&&this._popup.setLatLng(t),this},setRadius:function(t){return this.options.radius=this._radius=t,this.redraw()},getRadius:function(){return this._radius}}),o.circleMarker=function(t,e){return new o.CircleMarker(t,e)},o.Polyline.include(o.Path.CANVAS?{_containsPoint:function(t,e){var i,n,s,a,r,h,l,u=this.options.weight/2;for(o.Browser.touch&&(u+=10),i=0,a=this._parts.length;a>i;i++)for(l=this._parts[i],n=0,r=l.length,s=r-1;r>n;s=n++)if((e||0!==n)&&(h=o.LineUtil.pointToSegmentDistance(t,l[s],l[n]),u>=h))return!0;return!1}}:{}),o.Polygon.include(o.Path.CANVAS?{_containsPoint:function(t){var e,i,n,s,a,r,h,l,u=!1;if(o.Polyline.prototype._containsPoint.call(this,t,!0))return!0;for(s=0,h=this._parts.length;h>s;s++)for(e=this._parts[s],a=0,l=e.length,r=l-1;l>a;r=a++)i=e[a],n=e[r],i.y>t.y!=n.y>t.y&&t.x<(n.x-i.x)*(t.y-i.y)/(n.y-i.y)+i.x&&(u=!u);return u}}:{}),o.Circle.include(o.Path.CANVAS?{_drawPath:function(){var t=this._point;this._ctx.beginPath(),this._ctx.arc(t.x,t.y,this._radius,0,2*Math.PI,!1)},_containsPoint:function(t){var e=this._point,i=this.options.stroke?this.options.weight/2:0;return t.distanceTo(e)<=this._radius+i}}:{}),o.CircleMarker.include(o.Path.CANVAS?{_updateStyle:function(){o.Path.prototype._updateStyle.call(this)}}:{}),o.GeoJSON=o.FeatureGroup.extend({initialize:function(t,e){o.setOptions(this,e),this._layers={},t&&this.addData(t)},addData:function(t){var e,i,n,s=o.Util.isArray(t)?t:t.features;if(s){for(e=0,i=s.length;i>e;e++)n=s[e],(n.geometries||n.geometry||n.features||n.coordinates)&&this.addData(s[e]);return this}var a=this.options;if(!a.filter||a.filter(t)){var r=o.GeoJSON.geometryToLayer(t,a.pointToLayer,a.coordsToLatLng,a);return r.feature=o.GeoJSON.asFeature(t),r.defaultOptions=r.options,this.resetStyle(r),a.onEachFeature&&a.onEachFeature(t,r),this.addLayer(r)}},resetStyle:function(t){var e=this.options.style;e&&(o.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(t){this.eachLayer(function(e){this._setLayerStyle(e,t)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)}}),o.extend(o.GeoJSON,{geometryToLayer:function(t,e,i,n){var s,a,r,h,l="Feature"===t.type?t.geometry:t,u=l.coordinates,c=[];switch(i=i||this.coordsToLatLng,l.type){case"Point":return s=i(u),e?e(t,s):new o.Marker(s);case"MultiPoint":for(r=0,h=u.length;h>r;r++)s=i(u[r]),c.push(e?e(t,s):new o.Marker(s));return new o.FeatureGroup(c);case"LineString":return a=this.coordsToLatLngs(u,0,i),new o.Polyline(a,n);case"Polygon":if(2===u.length&&!u[1].length)throw new Error("Invalid GeoJSON object.");return a=this.coordsToLatLngs(u,1,i),new o.Polygon(a,n);case"MultiLineString":return a=this.coordsToLatLngs(u,1,i),new o.MultiPolyline(a,n);case"MultiPolygon":return a=this.coordsToLatLngs(u,2,i),new o.MultiPolygon(a,n);case"GeometryCollection":for(r=0,h=l.geometries.length;h>r;r++)c.push(this.geometryToLayer({geometry:l.geometries[r],type:"Feature",properties:t.properties},e,i,n));return new o.FeatureGroup(c);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(t){return new o.LatLng(t[1],t[0],t[2])},coordsToLatLngs:function(t,e,i){var n,o,s,a=[];for(o=0,s=t.length;s>o;o++)n=e?this.coordsToLatLngs(t[o],e-1,i):(i||this.coordsToLatLng)(t[o]),a.push(n);return a},latLngToCoords:function(t){var e=[t.lng,t.lat];return t.alt!==i&&e.push(t.alt),e},latLngsToCoords:function(t){for(var e=[],i=0,n=t.length;n>i;i++)e.push(o.GeoJSON.latLngToCoords(t[i]));return e},getFeature:function(t,e){return t.feature?o.extend({},t.feature,{geometry:e}):o.GeoJSON.asFeature(e)},asFeature:function(t){return"Feature"===t.type?t:{type:"Feature",properties:{},geometry:t}}});var a={toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"Point",coordinates:o.GeoJSON.latLngToCoords(this.getLatLng())})}};o.Marker.include(a),o.Circle.include(a),o.CircleMarker.include(a),o.Polyline.include({toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"LineString",coordinates:o.GeoJSON.latLngsToCoords(this.getLatLngs())})}}),o.Polygon.include({toGeoJSON:function(){var t,e,i,n=[o.GeoJSON.latLngsToCoords(this.getLatLngs())];if(n[0].push(n[0][0]),this._holes)for(t=0,e=this._holes.length;e>t;t++)i=o.GeoJSON.latLngsToCoords(this._holes[t]),i.push(i[0]),n.push(i);return o.GeoJSON.getFeature(this,{type:"Polygon",coordinates:n})}}),function(){function t(t){return function(){var e=[];return this.eachLayer(function(t){e.push(t.toGeoJSON().geometry.coordinates)}),o.GeoJSON.getFeature(this,{type:t,coordinates:e})}}o.MultiPolyline.include({toGeoJSON:t("MultiLineString")}),o.MultiPolygon.include({toGeoJSON:t("MultiPolygon")}),o.LayerGroup.include({toGeoJSON:function(){var e,i=this.feature&&this.feature.geometry,n=[];if(i&&"MultiPoint"===i.type)return t("MultiPoint").call(this);var s=i&&"GeometryCollection"===i.type;return this.eachLayer(function(t){t.toGeoJSON&&(e=t.toGeoJSON(),n.push(s?e.geometry:o.GeoJSON.asFeature(e)))}),s?o.GeoJSON.getFeature(this,{geometries:n,type:"GeometryCollection"}):{type:"FeatureCollection",features:n}}})}(),o.geoJson=function(t,e){return new o.GeoJSON(t,e)},o.DomEvent={addListener:function(t,e,i,n){var s,a,r,h=o.stamp(i),l="_leaflet_"+e+h;return t[l]?this:(s=function(e){return i.call(n||t,e||o.DomEvent._getEvent())},o.Browser.pointer&&0===e.indexOf("touch")?this.addPointerListener(t,e,s,h):(o.Browser.touch&&"dblclick"===e&&this.addDoubleTapListener&&this.addDoubleTapListener(t,s,h),"addEventListener"in t?"mousewheel"===e?(t.addEventListener("DOMMouseScroll",s,!1),t.addEventListener(e,s,!1)):"mouseenter"===e||"mouseleave"===e?(a=s,r="mouseenter"===e?"mouseover":"mouseout",s=function(e){return o.DomEvent._checkMouse(t,e)?a(e):void 0},t.addEventListener(r,s,!1)):"click"===e&&o.Browser.android?(a=s,s=function(t){return o.DomEvent._filterClick(t,a)},t.addEventListener(e,s,!1)):t.addEventListener(e,s,!1):"attachEvent"in t&&t.attachEvent("on"+e,s),t[l]=s,this))},removeListener:function(t,e,i){var n=o.stamp(i),s="_leaflet_"+e+n,a=t[s];return a?(o.Browser.pointer&&0===e.indexOf("touch")?this.removePointerListener(t,e,n):o.Browser.touch&&"dblclick"===e&&this.removeDoubleTapListener?this.removeDoubleTapListener(t,n):"removeEventListener"in t?"mousewheel"===e?(t.removeEventListener("DOMMouseScroll",a,!1),t.removeEventListener(e,a,!1)):"mouseenter"===e||"mouseleave"===e?t.removeEventListener("mouseenter"===e?"mouseover":"mouseout",a,!1):t.removeEventListener(e,a,!1):"detachEvent"in t&&t.detachEvent("on"+e,a),t[s]=null,this):this},stopPropagation:function(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,o.DomEvent._skipped(t),this},disableScrollPropagation:function(t){var e=o.DomEvent.stopPropagation;return o.DomEvent.on(t,"mousewheel",e).on(t,"MozMousePixelScroll",e)},disableClickPropagation:function(t){for(var e=o.DomEvent.stopPropagation,i=o.Draggable.START.length-1;i>=0;i--)o.DomEvent.on(t,o.Draggable.START[i],e);return o.DomEvent.on(t,"click",o.DomEvent._fakeStop).on(t,"dblclick",e)},preventDefault:function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this},stop:function(t){return o.DomEvent.preventDefault(t).stopPropagation(t)},getMousePosition:function(t,e){if(!e)return new o.Point(t.clientX,t.clientY);var i=e.getBoundingClientRect();return new o.Point(t.clientX-i.left-e.clientLeft,t.clientY-i.top-e.clientTop)},getWheelDelta:function(t){var e=0;return t.wheelDelta&&(e=t.wheelDelta/120),t.detail&&(e=-t.detail/3),e},_skipEvents:{},_fakeStop:function(t){o.DomEvent._skipEvents[t.type]=!0},_skipped:function(t){var e=this._skipEvents[t.type];return this._skipEvents[t.type]=!1,e},_checkMouse:function(t,e){var i=e.relatedTarget;if(!i)return!0;try{for(;i&&i!==t;)i=i.parentNode}catch(n){return!1}return i!==t},_getEvent:function(){var e=t.event;if(!e)for(var i=arguments.callee.caller;i&&(e=i.arguments[0],!e||t.Event!==e.constructor);)i=i.caller;return e},_filterClick:function(t,e){var i=t.timeStamp||t.originalEvent.timeStamp,n=o.DomEvent._lastClick&&i-o.DomEvent._lastClick;return n&&n>100&&1e3>n||t.target._simulatedClick&&!t._simulated?void o.DomEvent.stop(t):(o.DomEvent._lastClick=i,e(t))}},o.DomEvent.on=o.DomEvent.addListener,o.DomEvent.off=o.DomEvent.removeListener,o.Draggable=o.Class.extend({includes:o.Mixin.Events,statics:{START:o.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"}},initialize:function(t,e){this._element=t,this._dragStartTarget=e||t},enable:function(){if(!this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.on(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!0}},disable:function(){if(this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.off(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!1,this._moved=!1}},_onDown:function(t){if(this._moved=!1,!(t.shiftKey||1!==t.which&&1!==t.button&&!t.touches||(o.DomEvent.stopPropagation(t),o.Draggable._disabled||(o.DomUtil.disableImageDrag(),o.DomUtil.disableTextSelection(),this._moving)))){var i=t.touches?t.touches[0]:t;this._startPoint=new o.Point(i.clientX,i.clientY),this._startPos=this._newPos=o.DomUtil.getPosition(this._element),o.DomEvent.on(e,o.Draggable.MOVE[t.type],this._onMove,this).on(e,o.Draggable.END[t.type],this._onUp,this)}},_onMove:function(t){if(t.touches&&t.touches.length>1)return void(this._moved=!0);var i=t.touches&&1===t.touches.length?t.touches[0]:t,n=new o.Point(i.clientX,i.clientY),s=n.subtract(this._startPoint);(s.x||s.y)&&(o.DomEvent.preventDefault(t),this._moved||(this.fire("dragstart"),this._moved=!0,this._startPos=o.DomUtil.getPosition(this._element).subtract(s),o.DomUtil.addClass(e.body,"leaflet-dragging"),o.DomUtil.addClass(t.target||t.srcElement,"leaflet-drag-target")),this._newPos=this._startPos.add(s),this._moving=!0,o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updatePosition,this,!0,this._dragStartTarget))},_updatePosition:function(){this.fire("predrag"),o.DomUtil.setPosition(this._element,this._newPos),this.fire("drag")},_onUp:function(t){o.DomUtil.removeClass(e.body,"leaflet-dragging"),o.DomUtil.removeClass(t.target||t.srcElement,"leaflet-drag-target");for(var i in o.Draggable.MOVE)o.DomEvent.off(e,o.Draggable.MOVE[i],this._onMove).off(e,o.Draggable.END[i],this._onUp);o.DomUtil.enableImageDrag(),o.DomUtil.enableTextSelection(),this._moved&&this._moving&&(o.Util.cancelAnimFrame(this._animRequest),this.fire("dragend",{distance:this._newPos.distanceTo(this._startPos)})),this._moving=!1}}),o.Handler=o.Class.extend({initialize:function(t){this._map=t},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled}}),o.Map.mergeOptions({dragging:!0,inertia:!o.Browser.android23,inertiaDeceleration:3400,inertiaMaxSpeed:1/0,inertiaThreshold:o.Browser.touch?32:18,easeLinearity:.25,worldCopyJump:!1}),o.Map.Drag=o.Handler.extend({addHooks:function(){if(!this._draggable){var t=this._map;this._draggable=new o.Draggable(t._mapPane,t._container),this._draggable.on({dragstart:this._onDragStart,drag:this._onDrag,dragend:this._onDragEnd},this),t.options.worldCopyJump&&(this._draggable.on("predrag",this._onPreDrag,this),t.on("viewreset",this._onViewReset,this),t.whenReady(this._onViewReset,this))}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){var t=this._map;t._panAnim&&t._panAnim.stop(),t.fire("movestart").fire("dragstart"),t.options.inertia&&(this._positions=[],this._times=[])},_onDrag:function(){if(this._map.options.inertia){var t=this._lastTime=+new Date,e=this._lastPos=this._draggable._newPos;this._positions.push(e),this._times.push(t),t-this._times[0]>200&&(this._positions.shift(),this._times.shift())}this._map.fire("move").fire("drag")},_onViewReset:function(){var t=this._map.getSize()._divideBy(2),e=this._map.latLngToLayerPoint([0,0]);this._initialWorldOffset=e.subtract(t).x,this._worldWidth=this._map.project([0,180]).x},_onPreDrag:function(){var t=this._worldWidth,e=Math.round(t/2),i=this._initialWorldOffset,n=this._draggable._newPos.x,o=(n-e+i)%t+e-i,s=(n+e+i)%t-e-i,a=Math.abs(o+i)<Math.abs(s+i)?o:s;this._draggable._newPos.x=a},_onDragEnd:function(t){var e=this._map,i=e.options,n=+new Date-this._lastTime,s=!i.inertia||n>i.inertiaThreshold||!this._positions[0];if(e.fire("dragend",t),s)e.fire("moveend");else{var a=this._lastPos.subtract(this._positions[0]),r=(this._lastTime+n-this._times[0])/1e3,h=i.easeLinearity,l=a.multiplyBy(h/r),u=l.distanceTo([0,0]),c=Math.min(i.inertiaMaxSpeed,u),d=l.multiplyBy(c/u),p=c/(i.inertiaDeceleration*h),_=d.multiplyBy(-p/2).round();_.x&&_.y?(_=e._limitOffset(_,e.options.maxBounds),o.Util.requestAnimFrame(function(){e.panBy(_,{duration:p,easeLinearity:h,noMoveStart:!0})})):e.fire("moveend")}}}),o.Map.addInitHook("addHandler","dragging",o.Map.Drag),o.Map.mergeOptions({doubleClickZoom:!0}),o.Map.DoubleClickZoom=o.Handler.extend({addHooks:function(){this._map.on("dblclick",this._onDoubleClick,this)},removeHooks:function(){this._map.off("dblclick",this._onDoubleClick,this)},_onDoubleClick:function(t){var e=this._map,i=e.getZoom()+(t.originalEvent.shiftKey?-1:1);"center"===e.options.doubleClickZoom?e.setZoom(i):e.setZoomAround(t.containerPoint,i)}}),o.Map.addInitHook("addHandler","doubleClickZoom",o.Map.DoubleClickZoom),o.Map.mergeOptions({scrollWheelZoom:!0}),o.Map.ScrollWheelZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"mousewheel",this._onWheelScroll,this),o.DomEvent.on(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault),this._delta=0},removeHooks:function(){o.DomEvent.off(this._map._container,"mousewheel",this._onWheelScroll),o.DomEvent.off(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault)},_onWheelScroll:function(t){var e=o.DomEvent.getWheelDelta(t);this._delta+=e,this._lastMousePos=this._map.mouseEventToContainerPoint(t),this._startTime||(this._startTime=+new Date);var i=Math.max(40-(+new Date-this._startTime),0);clearTimeout(this._timer),this._timer=setTimeout(o.bind(this._performZoom,this),i),o.DomEvent.preventDefault(t),o.DomEvent.stopPropagation(t)},_performZoom:function(){var t=this._map,e=this._delta,i=t.getZoom();e=e>0?Math.ceil(e):Math.floor(e),e=Math.max(Math.min(e,4),-4),e=t._limitZoom(i+e)-i,this._delta=0,this._startTime=null,e&&("center"===t.options.scrollWheelZoom?t.setZoom(i+e):t.setZoomAround(this._lastMousePos,i+e))}}),o.Map.addInitHook("addHandler","scrollWheelZoom",o.Map.ScrollWheelZoom),o.extend(o.DomEvent,{_touchstart:o.Browser.msPointer?"MSPointerDown":o.Browser.pointer?"pointerdown":"touchstart",_touchend:o.Browser.msPointer?"MSPointerUp":o.Browser.pointer?"pointerup":"touchend",addDoubleTapListener:function(t,i,n){function s(t){var e;if(o.Browser.pointer?(_.push(t.pointerId),e=_.length):e=t.touches.length,!(e>1)){var i=Date.now(),n=i-(r||i);h=t.touches?t.touches[0]:t,l=n>0&&u>=n,r=i}}function a(t){if(o.Browser.pointer){var e=_.indexOf(t.pointerId);if(-1===e)return;_.splice(e,1)}if(l){if(o.Browser.pointer){var n,s={};for(var a in h)n=h[a],s[a]="function"==typeof n?n.bind(h):n;h=s}h.type="dblclick",i(h),r=null}}var r,h,l=!1,u=250,c="_leaflet_",d=this._touchstart,p=this._touchend,_=[];t[c+d+n]=s,t[c+p+n]=a;var m=o.Browser.pointer?e.documentElement:t;return t.addEventListener(d,s,!1),m.addEventListener(p,a,!1),o.Browser.pointer&&m.addEventListener(o.DomEvent.POINTER_CANCEL,a,!1),this},removeDoubleTapListener:function(t,i){var n="_leaflet_";return t.removeEventListener(this._touchstart,t[n+this._touchstart+i],!1),(o.Browser.pointer?e.documentElement:t).removeEventListener(this._touchend,t[n+this._touchend+i],!1),o.Browser.pointer&&e.documentElement.removeEventListener(o.DomEvent.POINTER_CANCEL,t[n+this._touchend+i],!1),this}}),o.extend(o.DomEvent,{POINTER_DOWN:o.Browser.msPointer?"MSPointerDown":"pointerdown",POINTER_MOVE:o.Browser.msPointer?"MSPointerMove":"pointermove",POINTER_UP:o.Browser.msPointer?"MSPointerUp":"pointerup",POINTER_CANCEL:o.Browser.msPointer?"MSPointerCancel":"pointercancel",_pointers:[],_pointerDocumentListener:!1,addPointerListener:function(t,e,i,n){switch(e){case"touchstart":return this.addPointerListenerStart(t,e,i,n);case"touchend":return this.addPointerListenerEnd(t,e,i,n);case"touchmove":return this.addPointerListenerMove(t,e,i,n);default:throw"Unknown touch event type"}},addPointerListenerStart:function(t,i,n,s){var a="_leaflet_",r=this._pointers,h=function(t){o.DomEvent.preventDefault(t);for(var e=!1,i=0;i<r.length;i++)if(r[i].pointerId===t.pointerId){e=!0;break}e||r.push(t),t.touches=r.slice(),t.changedTouches=[t],n(t)};if(t[a+"touchstart"+s]=h,t.addEventListener(this.POINTER_DOWN,h,!1),!this._pointerDocumentListener){var l=function(t){for(var e=0;e<r.length;e++)if(r[e].pointerId===t.pointerId){r.splice(e,1);
+break}};e.documentElement.addEventListener(this.POINTER_UP,l,!1),e.documentElement.addEventListener(this.POINTER_CANCEL,l,!1),this._pointerDocumentListener=!0}return this},addPointerListenerMove:function(t,e,i,n){function o(t){if(t.pointerType!==t.MSPOINTER_TYPE_MOUSE&&"mouse"!==t.pointerType||0!==t.buttons){for(var e=0;e<a.length;e++)if(a[e].pointerId===t.pointerId){a[e]=t;break}t.touches=a.slice(),t.changedTouches=[t],i(t)}}var s="_leaflet_",a=this._pointers;return t[s+"touchmove"+n]=o,t.addEventListener(this.POINTER_MOVE,o,!1),this},addPointerListenerEnd:function(t,e,i,n){var o="_leaflet_",s=this._pointers,a=function(t){for(var e=0;e<s.length;e++)if(s[e].pointerId===t.pointerId){s.splice(e,1);break}t.touches=s.slice(),t.changedTouches=[t],i(t)};return t[o+"touchend"+n]=a,t.addEventListener(this.POINTER_UP,a,!1),t.addEventListener(this.POINTER_CANCEL,a,!1),this},removePointerListener:function(t,e,i){var n="_leaflet_",o=t[n+e+i];switch(e){case"touchstart":t.removeEventListener(this.POINTER_DOWN,o,!1);break;case"touchmove":t.removeEventListener(this.POINTER_MOVE,o,!1);break;case"touchend":t.removeEventListener(this.POINTER_UP,o,!1),t.removeEventListener(this.POINTER_CANCEL,o,!1)}return this}}),o.Map.mergeOptions({touchZoom:o.Browser.touch&&!o.Browser.android23,bounceAtZoomLimits:!0}),o.Map.TouchZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(t){var i=this._map;if(t.touches&&2===t.touches.length&&!i._animatingZoom&&!this._zooming){var n=i.mouseEventToLayerPoint(t.touches[0]),s=i.mouseEventToLayerPoint(t.touches[1]),a=i._getCenterLayerPoint();this._startCenter=n.add(s)._divideBy(2),this._startDist=n.distanceTo(s),this._moved=!1,this._zooming=!0,this._centerOffset=a.subtract(this._startCenter),i._panAnim&&i._panAnim.stop(),o.DomEvent.on(e,"touchmove",this._onTouchMove,this).on(e,"touchend",this._onTouchEnd,this),o.DomEvent.preventDefault(t)}},_onTouchMove:function(t){var e=this._map;if(t.touches&&2===t.touches.length&&this._zooming){var i=e.mouseEventToLayerPoint(t.touches[0]),n=e.mouseEventToLayerPoint(t.touches[1]);this._scale=i.distanceTo(n)/this._startDist,this._delta=i._add(n)._divideBy(2)._subtract(this._startCenter),1!==this._scale&&(e.options.bounceAtZoomLimits||!(e.getZoom()===e.getMinZoom()&&this._scale<1||e.getZoom()===e.getMaxZoom()&&this._scale>1))&&(this._moved||(o.DomUtil.addClass(e._mapPane,"leaflet-touching"),e.fire("movestart").fire("zoomstart"),this._moved=!0),o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updateOnMove,this,!0,this._map._container),o.DomEvent.preventDefault(t))}},_updateOnMove:function(){var t=this._map,e=this._getScaleOrigin(),i=t.layerPointToLatLng(e),n=t.getScaleZoom(this._scale);t._animateZoom(i,n,this._startCenter,this._scale,this._delta)},_onTouchEnd:function(){if(!this._moved||!this._zooming)return void(this._zooming=!1);var t=this._map;this._zooming=!1,o.DomUtil.removeClass(t._mapPane,"leaflet-touching"),o.Util.cancelAnimFrame(this._animRequest),o.DomEvent.off(e,"touchmove",this._onTouchMove).off(e,"touchend",this._onTouchEnd);var i=this._getScaleOrigin(),n=t.layerPointToLatLng(i),s=t.getZoom(),a=t.getScaleZoom(this._scale)-s,r=a>0?Math.ceil(a):Math.floor(a),h=t._limitZoom(s+r),l=t.getZoomScale(h)/this._scale;t._animateZoom(n,h,i,l)},_getScaleOrigin:function(){var t=this._centerOffset.subtract(this._delta).divideBy(this._scale);return this._startCenter.add(t)}}),o.Map.addInitHook("addHandler","touchZoom",o.Map.TouchZoom),o.Map.mergeOptions({tap:!0,tapTolerance:15}),o.Map.Tap=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onDown,this)},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onDown,this)},_onDown:function(t){if(t.touches){if(o.DomEvent.preventDefault(t),this._fireClick=!0,t.touches.length>1)return this._fireClick=!1,void clearTimeout(this._holdTimeout);var i=t.touches[0],n=i.target;this._startPos=this._newPos=new o.Point(i.clientX,i.clientY),n.tagName&&"a"===n.tagName.toLowerCase()&&o.DomUtil.addClass(n,"leaflet-active"),this._holdTimeout=setTimeout(o.bind(function(){this._isTapValid()&&(this._fireClick=!1,this._onUp(),this._simulateEvent("contextmenu",i))},this),1e3),o.DomEvent.on(e,"touchmove",this._onMove,this).on(e,"touchend",this._onUp,this)}},_onUp:function(t){if(clearTimeout(this._holdTimeout),o.DomEvent.off(e,"touchmove",this._onMove,this).off(e,"touchend",this._onUp,this),this._fireClick&&t&&t.changedTouches){var i=t.changedTouches[0],n=i.target;n&&n.tagName&&"a"===n.tagName.toLowerCase()&&o.DomUtil.removeClass(n,"leaflet-active"),this._isTapValid()&&this._simulateEvent("click",i)}},_isTapValid:function(){return this._newPos.distanceTo(this._startPos)<=this._map.options.tapTolerance},_onMove:function(t){var e=t.touches[0];this._newPos=new o.Point(e.clientX,e.clientY)},_simulateEvent:function(i,n){var o=e.createEvent("MouseEvents");o._simulated=!0,n.target._simulatedClick=!0,o.initMouseEvent(i,!0,!0,t,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(o)}}),o.Browser.touch&&!o.Browser.pointer&&o.Map.addInitHook("addHandler","tap",o.Map.Tap),o.Map.mergeOptions({boxZoom:!0}),o.Map.BoxZoom=o.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane,this._moved=!1},addHooks:function(){o.DomEvent.on(this._container,"mousedown",this._onMouseDown,this)},removeHooks:function(){o.DomEvent.off(this._container,"mousedown",this._onMouseDown),this._moved=!1},moved:function(){return this._moved},_onMouseDown:function(t){return this._moved=!1,!t.shiftKey||1!==t.which&&1!==t.button?!1:(o.DomUtil.disableTextSelection(),o.DomUtil.disableImageDrag(),this._startLayerPoint=this._map.mouseEventToLayerPoint(t),void o.DomEvent.on(e,"mousemove",this._onMouseMove,this).on(e,"mouseup",this._onMouseUp,this).on(e,"keydown",this._onKeyDown,this))},_onMouseMove:function(t){this._moved||(this._box=o.DomUtil.create("div","leaflet-zoom-box",this._pane),o.DomUtil.setPosition(this._box,this._startLayerPoint),this._container.style.cursor="crosshair",this._map.fire("boxzoomstart"));var e=this._startLayerPoint,i=this._box,n=this._map.mouseEventToLayerPoint(t),s=n.subtract(e),a=new o.Point(Math.min(n.x,e.x),Math.min(n.y,e.y));o.DomUtil.setPosition(i,a),this._moved=!0,i.style.width=Math.max(0,Math.abs(s.x)-4)+"px",i.style.height=Math.max(0,Math.abs(s.y)-4)+"px"},_finish:function(){this._moved&&(this._pane.removeChild(this._box),this._container.style.cursor=""),o.DomUtil.enableTextSelection(),o.DomUtil.enableImageDrag(),o.DomEvent.off(e,"mousemove",this._onMouseMove).off(e,"mouseup",this._onMouseUp).off(e,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finish();var e=this._map,i=e.mouseEventToLayerPoint(t);if(!this._startLayerPoint.equals(i)){var n=new o.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(i));e.fitBounds(n),e.fire("boxzoomend",{boxZoomBounds:n})}},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),o.Map.addInitHook("addHandler","boxZoom",o.Map.BoxZoom),o.Map.mergeOptions({keyboard:!0,keyboardPanOffset:80,keyboardZoomOffset:1}),o.Map.Keyboard=o.Handler.extend({keyCodes:{left:[37],right:[39],down:[40],up:[38],zoomIn:[187,107,61,171],zoomOut:[189,109,173]},initialize:function(t){this._map=t,this._setPanOffset(t.options.keyboardPanOffset),this._setZoomOffset(t.options.keyboardZoomOffset)},addHooks:function(){var t=this._map._container;-1===t.tabIndex&&(t.tabIndex="0"),o.DomEvent.on(t,"focus",this._onFocus,this).on(t,"blur",this._onBlur,this).on(t,"mousedown",this._onMouseDown,this),this._map.on("focus",this._addHooks,this).on("blur",this._removeHooks,this)},removeHooks:function(){this._removeHooks();var t=this._map._container;o.DomEvent.off(t,"focus",this._onFocus,this).off(t,"blur",this._onBlur,this).off(t,"mousedown",this._onMouseDown,this),this._map.off("focus",this._addHooks,this).off("blur",this._removeHooks,this)},_onMouseDown:function(){if(!this._focused){var i=e.body,n=e.documentElement,o=i.scrollTop||n.scrollTop,s=i.scrollLeft||n.scrollLeft;this._map._container.focus(),t.scrollTo(s,o)}},_onFocus:function(){this._focused=!0,this._map.fire("focus")},_onBlur:function(){this._focused=!1,this._map.fire("blur")},_setPanOffset:function(t){var e,i,n=this._panKeys={},o=this.keyCodes;for(e=0,i=o.left.length;i>e;e++)n[o.left[e]]=[-1*t,0];for(e=0,i=o.right.length;i>e;e++)n[o.right[e]]=[t,0];for(e=0,i=o.down.length;i>e;e++)n[o.down[e]]=[0,t];for(e=0,i=o.up.length;i>e;e++)n[o.up[e]]=[0,-1*t]},_setZoomOffset:function(t){var e,i,n=this._zoomKeys={},o=this.keyCodes;for(e=0,i=o.zoomIn.length;i>e;e++)n[o.zoomIn[e]]=t;for(e=0,i=o.zoomOut.length;i>e;e++)n[o.zoomOut[e]]=-t},_addHooks:function(){o.DomEvent.on(e,"keydown",this._onKeyDown,this)},_removeHooks:function(){o.DomEvent.off(e,"keydown",this._onKeyDown,this)},_onKeyDown:function(t){var e=t.keyCode,i=this._map;if(e in this._panKeys){if(i._panAnim&&i._panAnim._inProgress)return;i.panBy(this._panKeys[e]),i.options.maxBounds&&i.panInsideBounds(i.options.maxBounds)}else{if(!(e in this._zoomKeys))return;i.setZoom(i.getZoom()+this._zoomKeys[e])}o.DomEvent.stop(t)}}),o.Map.addInitHook("addHandler","keyboard",o.Map.Keyboard),o.Handler.MarkerDrag=o.Handler.extend({initialize:function(t){this._marker=t},addHooks:function(){var t=this._marker._icon;this._draggable||(this._draggable=new o.Draggable(t,t)),this._draggable.on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this),this._draggable.enable(),o.DomUtil.addClass(this._marker._icon,"leaflet-marker-draggable")},removeHooks:function(){this._draggable.off("dragstart",this._onDragStart,this).off("drag",this._onDrag,this).off("dragend",this._onDragEnd,this),this._draggable.disable(),o.DomUtil.removeClass(this._marker._icon,"leaflet-marker-draggable")},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){this._marker.closePopup().fire("movestart").fire("dragstart")},_onDrag:function(){var t=this._marker,e=t._shadow,i=o.DomUtil.getPosition(t._icon),n=t._map.layerPointToLatLng(i);e&&o.DomUtil.setPosition(e,i),t._latlng=n,t.fire("move",{latlng:n}).fire("drag")},_onDragEnd:function(t){this._marker.fire("moveend").fire("dragend",t)}}),o.Control=o.Class.extend({options:{position:"topright"},initialize:function(t){o.setOptions(this,t)},getPosition:function(){return this.options.position},setPosition:function(t){var e=this._map;return e&&e.removeControl(this),this.options.position=t,e&&e.addControl(this),this},getContainer:function(){return this._container},addTo:function(t){this._map=t;var e=this._container=this.onAdd(t),i=this.getPosition(),n=t._controlCorners[i];return o.DomUtil.addClass(e,"leaflet-control"),-1!==i.indexOf("bottom")?n.insertBefore(e,n.firstChild):n.appendChild(e),this},removeFrom:function(t){var e=this.getPosition(),i=t._controlCorners[e];return i.removeChild(this._container),this._map=null,this.onRemove&&this.onRemove(t),this},_refocusOnMap:function(){this._map&&this._map.getContainer().focus()}}),o.control=function(t){return new o.Control(t)},o.Map.include({addControl:function(t){return t.addTo(this),this},removeControl:function(t){return t.removeFrom(this),this},_initControlPos:function(){function t(t,s){var a=i+t+" "+i+s;e[t+s]=o.DomUtil.create("div",a,n)}var e=this._controlCorners={},i="leaflet-",n=this._controlContainer=o.DomUtil.create("div",i+"control-container",this._container);t("top","left"),t("top","right"),t("bottom","left"),t("bottom","right")},_clearControlPos:function(){this._container.removeChild(this._controlContainer)}}),o.Control.Zoom=o.Control.extend({options:{position:"topleft",zoomInText:"+",zoomInTitle:"Zoom in",zoomOutText:"-",zoomOutTitle:"Zoom out"},onAdd:function(t){var e="leaflet-control-zoom",i=o.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._zoomInButton=this._createButton(this.options.zoomInText,this.options.zoomInTitle,e+"-in",i,this._zoomIn,this),this._zoomOutButton=this._createButton(this.options.zoomOutText,this.options.zoomOutTitle,e+"-out",i,this._zoomOut,this),this._updateDisabled(),t.on("zoomend zoomlevelschange",this._updateDisabled,this),i},onRemove:function(t){t.off("zoomend zoomlevelschange",this._updateDisabled,this)},_zoomIn:function(t){this._map.zoomIn(t.shiftKey?3:1)},_zoomOut:function(t){this._map.zoomOut(t.shiftKey?3:1)},_createButton:function(t,e,i,n,s,a){var r=o.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var h=o.DomEvent.stopPropagation;return o.DomEvent.on(r,"click",h).on(r,"mousedown",h).on(r,"dblclick",h).on(r,"click",o.DomEvent.preventDefault).on(r,"click",s,a).on(r,"click",this._refocusOnMap,a),r},_updateDisabled:function(){var t=this._map,e="leaflet-disabled";o.DomUtil.removeClass(this._zoomInButton,e),o.DomUtil.removeClass(this._zoomOutButton,e),t._zoom===t.getMinZoom()&&o.DomUtil.addClass(this._zoomOutButton,e),t._zoom===t.getMaxZoom()&&o.DomUtil.addClass(this._zoomInButton,e)}}),o.Map.mergeOptions({zoomControl:!0}),o.Map.addInitHook(function(){this.options.zoomControl&&(this.zoomControl=new o.Control.Zoom,this.addControl(this.zoomControl))}),o.control.zoom=function(t){return new o.Control.Zoom(t)},o.Control.Attribution=o.Control.extend({options:{position:"bottomright",prefix:'<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>'},initialize:function(t){o.setOptions(this,t),this._attributions={}},onAdd:function(t){this._container=o.DomUtil.create("div","leaflet-control-attribution"),o.DomEvent.disableClickPropagation(this._container);for(var e in t._layers)t._layers[e].getAttribution&&this.addAttribution(t._layers[e].getAttribution());return t.on("layeradd",this._onLayerAdd,this).on("layerremove",this._onLayerRemove,this),this._update(),this._container},onRemove:function(t){t.off("layeradd",this._onLayerAdd).off("layerremove",this._onLayerRemove)},setPrefix:function(t){return this.options.prefix=t,this._update(),this},addAttribution:function(t){return t?(this._attributions[t]||(this._attributions[t]=0),this._attributions[t]++,this._update(),this):void 0},removeAttribution:function(t){return t?(this._attributions[t]&&(this._attributions[t]--,this._update()),this):void 0},_update:function(){if(this._map){var t=[];for(var e in this._attributions)this._attributions[e]&&t.push(e);var i=[];this.options.prefix&&i.push(this.options.prefix),t.length&&i.push(t.join(", ")),this._container.innerHTML=i.join(" | ")}},_onLayerAdd:function(t){t.layer.getAttribution&&this.addAttribution(t.layer.getAttribution())},_onLayerRemove:function(t){t.layer.getAttribution&&this.removeAttribution(t.layer.getAttribution())}}),o.Map.mergeOptions({attributionControl:!0}),o.Map.addInitHook(function(){this.options.attributionControl&&(this.attributionControl=(new o.Control.Attribution).addTo(this))}),o.control.attribution=function(t){return new o.Control.Attribution(t)},o.Control.Scale=o.Control.extend({options:{position:"bottomleft",maxWidth:100,metric:!0,imperial:!0,updateWhenIdle:!1},onAdd:function(t){this._map=t;var e="leaflet-control-scale",i=o.DomUtil.create("div",e),n=this.options;return this._addScales(n,e,i),t.on(n.updateWhenIdle?"moveend":"move",this._update,this),t.whenReady(this._update,this),i},onRemove:function(t){t.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScales:function(t,e,i){t.metric&&(this._mScale=o.DomUtil.create("div",e+"-line",i)),t.imperial&&(this._iScale=o.DomUtil.create("div",e+"-line",i))},_update:function(){var t=this._map.getBounds(),e=t.getCenter().lat,i=6378137*Math.PI*Math.cos(e*Math.PI/180),n=i*(t.getNorthEast().lng-t.getSouthWest().lng)/180,o=this._map.getSize(),s=this.options,a=0;o.x>0&&(a=n*(s.maxWidth/o.x)),this._updateScales(s,a)},_updateScales:function(t,e){t.metric&&e&&this._updateMetric(e),t.imperial&&e&&this._updateImperial(e)},_updateMetric:function(t){var e=this._getRoundNum(t);this._mScale.style.width=this._getScaleWidth(e/t)+"px",this._mScale.innerHTML=1e3>e?e+" m":e/1e3+" km"},_updateImperial:function(t){var e,i,n,o=3.2808399*t,s=this._iScale;o>5280?(e=o/5280,i=this._getRoundNum(e),s.style.width=this._getScaleWidth(i/e)+"px",s.innerHTML=i+" mi"):(n=this._getRoundNum(o),s.style.width=this._getScaleWidth(n/o)+"px",s.innerHTML=n+" ft")},_getScaleWidth:function(t){return Math.round(this.options.maxWidth*t)-10},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,e*i}}),o.control.scale=function(t){return new o.Control.Scale(t)},o.Control.Layers=o.Control.extend({options:{collapsed:!0,position:"topright",autoZIndex:!0},initialize:function(t,e,i){o.setOptions(this,i),this._layers={},this._lastZIndex=0,this._handlingClick=!1;for(var n in t)this._addLayer(t[n],n);for(n in e)this._addLayer(e[n],n,!0)},onAdd:function(t){return this._initLayout(),this._update(),t.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},onRemove:function(t){t.off("layeradd",this._onLayerChange).off("layerremove",this._onLayerChange)},addBaseLayer:function(t,e){return this._addLayer(t,e),this._update(),this},addOverlay:function(t,e){return this._addLayer(t,e,!0),this._update(),this},removeLayer:function(t){var e=o.stamp(t);return delete this._layers[e],this._update(),this},_initLayout:function(){var t="leaflet-control-layers",e=this._container=o.DomUtil.create("div",t);e.setAttribute("aria-haspopup",!0),o.Browser.touch?o.DomEvent.on(e,"click",o.DomEvent.stopPropagation):o.DomEvent.disableClickPropagation(e).disableScrollPropagation(e);var i=this._form=o.DomUtil.create("form",t+"-list");if(this.options.collapsed){o.Browser.android||o.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var n=this._layersLink=o.DomUtil.create("a",t+"-toggle",e);n.href="#",n.title="Layers",o.Browser.touch?o.DomEvent.on(n,"click",o.DomEvent.stop).on(n,"click",this._expand,this):o.DomEvent.on(n,"focus",this._expand,this),o.DomEvent.on(i,"click",function(){setTimeout(o.bind(this._onInputClick,this),0)},this),this._map.on("click",this._collapse,this)}else this._expand();this._baseLayersList=o.DomUtil.create("div",t+"-base",i),this._separator=o.DomUtil.create("div",t+"-separator",i),this._overlaysList=o.DomUtil.create("div",t+"-overlays",i),e.appendChild(i)},_addLayer:function(t,e,i){var n=o.stamp(t);this._layers[n]={layer:t,name:e,overlay:i},this.options.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex))},_update:function(){if(this._container){this._baseLayersList.innerHTML="",this._overlaysList.innerHTML="";var t,e,i=!1,n=!1;for(t in this._layers)e=this._layers[t],this._addItem(e),n=n||e.overlay,i=i||!e.overlay;this._separator.style.display=n&&i?"":"none"}},_onLayerChange:function(t){var e=this._layers[o.stamp(t.layer)];if(e){this._handlingClick||this._update();var i=e.overlay?"layeradd"===t.type?"overlayadd":"overlayremove":"layeradd"===t.type?"baselayerchange":null;i&&this._map.fire(i,e)}},_createRadioElement:function(t,i){var n='<input type="radio" class="leaflet-control-layers-selector" name="'+t+'"';i&&(n+=' checked="checked"'),n+="/>";var o=e.createElement("div");return o.innerHTML=n,o.firstChild},_addItem:function(t){var i,n=e.createElement("label"),s=this._map.hasLayer(t.layer);t.overlay?(i=e.createElement("input"),i.type="checkbox",i.className="leaflet-control-layers-selector",i.defaultChecked=s):i=this._createRadioElement("leaflet-base-layers",s),i.layerId=o.stamp(t.layer),o.DomEvent.on(i,"click",this._onInputClick,this);var a=e.createElement("span");a.innerHTML=" "+t.name,n.appendChild(i),n.appendChild(a);var r=t.overlay?this._overlaysList:this._baseLayersList;return r.appendChild(n),n},_onInputClick:function(){var t,e,i,n=this._form.getElementsByTagName("input"),o=n.length;for(this._handlingClick=!0,t=0;o>t;t++)e=n[t],i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?this._map.addLayer(i.layer):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer);this._handlingClick=!1,this._refocusOnMap()},_expand:function(){o.DomUtil.addClass(this._container,"leaflet-control-layers-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-layers-expanded","")}}),o.control.layers=function(t,e,i){return new o.Control.Layers(t,e,i)},o.PosAnimation=o.Class.extend({includes:o.Mixin.Events,run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._newPos=e,this.fire("start"),t.style[o.DomUtil.TRANSITION]="all "+(i||.25)+"s cubic-bezier(0,0,"+(n||.5)+",1)",o.DomEvent.on(t,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),o.DomUtil.setPosition(t,e),o.Util.falseFn(t.offsetWidth),this._stepTimer=setInterval(o.bind(this._onStep,this),50)},stop:function(){this._inProgress&&(o.DomUtil.setPosition(this._el,this._getPos()),this._onTransitionEnd(),o.Util.falseFn(this._el.offsetWidth))},_onStep:function(){var t=this._getPos();return t?(this._el._leaflet_pos=t,void this.fire("step")):void this._onTransitionEnd()},_transformRe:/([-+]?(?:\d*\.)?\d+)\D*, ([-+]?(?:\d*\.)?\d+)\D*\)/,_getPos:function(){var e,i,n,s=this._el,a=t.getComputedStyle(s);if(o.Browser.any3d){if(n=a[o.DomUtil.TRANSFORM].match(this._transformRe),!n)return;e=parseFloat(n[1]),i=parseFloat(n[2])}else e=parseFloat(a.left),i=parseFloat(a.top);return new o.Point(e,i,!0)},_onTransitionEnd:function(){o.DomEvent.off(this._el,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),this._inProgress&&(this._inProgress=!1,this._el.style[o.DomUtil.TRANSITION]="",this._el._leaflet_pos=this._newPos,clearInterval(this._stepTimer),this.fire("step").fire("end"))}}),o.Map.include({setView:function(t,e,n){if(e=e===i?this._zoom:this._limitZoom(e),t=this._limitCenter(o.latLng(t),e,this.options.maxBounds),n=n||{},this._panAnim&&this._panAnim.stop(),this._loaded&&!n.reset&&n!==!0){n.animate!==i&&(n.zoom=o.extend({animate:n.animate},n.zoom),n.pan=o.extend({animate:n.animate},n.pan));var s=this._zoom!==e?this._tryAnimatedZoom&&this._tryAnimatedZoom(t,e,n.zoom):this._tryAnimatedPan(t,n.pan);if(s)return clearTimeout(this._sizeTimer),this}return this._resetView(t,e),this},panBy:function(t,e){if(t=o.point(t).round(),e=e||{},!t.x&&!t.y)return this;if(this._panAnim||(this._panAnim=new o.PosAnimation,this._panAnim.on({step:this._onPanTransitionStep,end:this._onPanTransitionEnd},this)),e.noMoveStart||this.fire("movestart"),e.animate!==!1){o.DomUtil.addClass(this._mapPane,"leaflet-pan-anim");var i=this._getMapPanePos().subtract(t);this._panAnim.run(this._mapPane,i,e.duration||.25,e.easeLinearity)}else this._rawPanBy(t),this.fire("move").fire("moveend");return this},_onPanTransitionStep:function(){this.fire("move")},_onPanTransitionEnd:function(){o.DomUtil.removeClass(this._mapPane,"leaflet-pan-anim"),this.fire("moveend")},_tryAnimatedPan:function(t,e){var i=this._getCenterOffset(t)._floor();return(e&&e.animate)===!0||this.getSize().contains(i)?(this.panBy(i,e),!0):!1}}),o.PosAnimation=o.DomUtil.TRANSITION?o.PosAnimation:o.PosAnimation.extend({run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._duration=i||.25,this._easeOutPower=1/Math.max(n||.5,.2),this._startPos=o.DomUtil.getPosition(t),this._offset=e.subtract(this._startPos),this._startTime=+new Date,this.fire("start"),this._animate()},stop:function(){this._inProgress&&(this._step(),this._complete())},_animate:function(){this._animId=o.Util.requestAnimFrame(this._animate,this),this._step()},_step:function(){var t=+new Date-this._startTime,e=1e3*this._duration;e>t?this._runFrame(this._easeOut(t/e)):(this._runFrame(1),this._complete())},_runFrame:function(t){var e=this._startPos.add(this._offset.multiplyBy(t));o.DomUtil.setPosition(this._el,e),this.fire("step")},_complete:function(){o.Util.cancelAnimFrame(this._animId),this._inProgress=!1,this.fire("end")},_easeOut:function(t){return 1-Math.pow(1-t,this._easeOutPower)}}),o.Map.mergeOptions({zoomAnimation:!0,zoomAnimationThreshold:4}),o.DomUtil.TRANSITION&&o.Map.addInitHook(function(){this._zoomAnimated=this.options.zoomAnimation&&o.DomUtil.TRANSITION&&o.Browser.any3d&&!o.Browser.android23&&!o.Browser.mobileOpera,this._zoomAnimated&&o.DomEvent.on(this._mapPane,o.DomUtil.TRANSITION_END,this._catchTransitionEnd,this)}),o.Map.include(o.DomUtil.TRANSITION?{_catchTransitionEnd:function(t){this._animatingZoom&&t.propertyName.indexOf("transform")>=0&&this._onZoomTransitionEnd()},_nothingToAnimate:function(){return!this._container.getElementsByClassName("leaflet-zoom-animated").length},_tryAnimatedZoom:function(t,e,i){if(this._animatingZoom)return!0;if(i=i||{},!this._zoomAnimated||i.animate===!1||this._nothingToAnimate()||Math.abs(e-this._zoom)>this.options.zoomAnimationThreshold)return!1;var n=this.getZoomScale(e),o=this._getCenterOffset(t)._divideBy(1-1/n),s=this._getCenterLayerPoint()._add(o);return i.animate===!0||this.getSize().contains(o)?(this.fire("movestart").fire("zoomstart"),this._animateZoom(t,e,s,n,null,!0),!0):!1},_animateZoom:function(t,e,i,n,s,a){this._animatingZoom=!0,o.DomUtil.addClass(this._mapPane,"leaflet-zoom-anim"),this._animateToCenter=t,this._animateToZoom=e,o.Draggable&&(o.Draggable._disabled=!0),this.fire("zoomanim",{center:t,zoom:e,origin:i,scale:n,delta:s,backwards:a})},_onZoomTransitionEnd:function(){this._animatingZoom=!1,o.DomUtil.removeClass(this._mapPane,"leaflet-zoom-anim"),this._resetView(this._animateToCenter,this._animateToZoom,!0,!0),o.Draggable&&(o.Draggable._disabled=!1)}}:{}),o.TileLayer.include({_animateZoom:function(t){this._animating||(this._animating=!0,this._prepareBgBuffer());var e=this._bgBuffer,i=o.DomUtil.TRANSFORM,n=t.delta?o.DomUtil.getTranslateString(t.delta):e.style[i],s=o.DomUtil.getScaleString(t.scale,t.origin);e.style[i]=t.backwards?s+" "+n:n+" "+s},_endZoomAnim:function(){var t=this._tileContainer,e=this._bgBuffer;t.style.visibility="",t.parentNode.appendChild(t),o.Util.falseFn(e.offsetWidth),this._animating=!1},_clearBgBuffer:function(){var t=this._map;!t||t._animatingZoom||t.touchZoom._zooming||(this._bgBuffer.innerHTML="",this._bgBuffer.style[o.DomUtil.TRANSFORM]="")},_prepareBgBuffer:function(){var t=this._tileContainer,e=this._bgBuffer,i=this._getLoadedTilesPercentage(e),n=this._getLoadedTilesPercentage(t);return e&&i>.5&&.5>n?(t.style.visibility="hidden",void this._stopLoadingImages(t)):(e.style.visibility="hidden",e.style[o.DomUtil.TRANSFORM]="",this._tileContainer=e,e=this._bgBuffer=t,this._stopLoadingImages(e),void clearTimeout(this._clearBgBufferTimer))},_getLoadedTilesPercentage:function(t){var e,i,n=t.getElementsByTagName("img"),o=0;for(e=0,i=n.length;i>e;e++)n[e].complete&&o++;return o/i},_stopLoadingImages:function(t){var e,i,n,s=Array.prototype.slice.call(t.getElementsByTagName("img"));for(e=0,i=s.length;i>e;e++)n=s[e],n.complete||(n.onload=o.Util.falseFn,n.onerror=o.Util.falseFn,n.src=o.Util.emptyImageUrl,n.parentNode.removeChild(n))}}),o.Map.include({_defaultLocateOptions:{watch:!1,setView:!1,maxZoom:1/0,timeout:1e4,maximumAge:0,enableHighAccuracy:!1},locate:function(t){if(t=this._locateOptions=o.extend(this._defaultLocateOptions,t),!navigator.geolocation)return this._handleGeolocationError({code:0,message:"Geolocation not supported."}),this;var e=o.bind(this._handleGeolocationResponse,this),i=o.bind(this._handleGeolocationError,this);return t.watch?this._locationWatchId=navigator.geolocation.watchPosition(e,i,t):navigator.geolocation.getCurrentPosition(e,i,t),this},stopLocate:function(){return navigator.geolocation&&navigator.geolocation.clearWatch(this._locationWatchId),this._locateOptions&&(this._locateOptions.setView=!1),this},_handleGeolocationError:function(t){var e=t.code,i=t.message||(1===e?"permission denied":2===e?"position unavailable":"timeout");this._locateOptions.setView&&!this._loaded&&this.fitWorld(),this.fire("locationerror",{code:e,message:"Geolocation error: "+i+"."})},_handleGeolocationResponse:function(t){var e=t.coords.latitude,i=t.coords.longitude,n=new o.LatLng(e,i),s=180*t.coords.accuracy/40075017,a=s/Math.cos(o.LatLng.DEG_TO_RAD*e),r=o.latLngBounds([e-s,i-a],[e+s,i+a]),h=this._locateOptions;if(h.setView){var l=Math.min(this.getBoundsZoom(r),h.maxZoom);this.setView(n,l)}var u={latlng:n,bounds:r,timestamp:t.timestamp};for(var c in t.coords)"number"==typeof t.coords[c]&&(u[c]=t.coords[c]);this.fire("locationfound",u)}})}(window,document);
\ No newline at end of file
diff --git a/web/src/main/webapp/js/main.js b/web/src/main/webapp/js/main.js
index ef6e5a2b1d..136a487b10 100644
--- a/web/src/main/webapp/js/main.js
+++ b/web/src/main/webapp/js/main.js
@@ -1,11 +1,11 @@
 /*
  * If you want to query another API append this something like
- * &host=http://graphhopper.com/routing
+ * &host=http://localhost:9000/
  * to the URL or overwrite the 'host' variable.
  */
 var tmpArgs = parseUrlWithHisto();
 var host = tmpArgs["host"];
-//var host = "http://graphhopper.com/routing";
+// var host = "http://graphhopper.com/api/1";
 if (host == null) {
     if (location.port === '') {
         host = location.protocol + '//' + location.hostname;
@@ -28,6 +28,7 @@ var firstClickToRoute;
 var defaultTranslationMap = null;
 var enTranslationMap = null;
 var routeSegmentPopup = null;
+var elevationControl = null;
 
 var iconFrom = L.icon({
     iconUrl: './img/marker-icon-green.png',
@@ -46,6 +47,10 @@ var iconTo = L.icon({
 $(document).ready(function(e) {
     // fixing cross domain support e.g in Opera
     jQuery.support.cors = true;
+
+    if (host.indexOf("graphhopper.com") > 0)
+        $('#hosting').show();
+
     var History = window.History;
     if (History.enabled) {
         History.Adapter.bind(window, 'statechange', function() {
@@ -98,7 +103,7 @@ $(document).ready(function(e) {
                 bounds.maxLat = tmp[3];
                 var vehiclesDiv = $("#vehicles");
                 function createButton(vehicle) {
-                    vehicle = vehicle.toLowerCase();
+                    var vehicle = vehicle.toLowerCase();
                     var button = $("<button class='vehicle-btn' title='" + tr(vehicle) + "'/>")
                     button.attr('id', vehicle);
                     button.html("<img src='img/" + vehicle + ".png' alt='" + tr(vehicle) + "'></img>");
@@ -111,10 +116,11 @@ $(document).ready(function(e) {
                     return button;
                 }
 
-                if (json.supportedVehicles) {
-                    var vehicles = json.supportedVehicles.split(",");
-                    if (vehicles.length > 1)
+                if (json.supported_vehicles) {
+                    var vehicles = json.supported_vehicles;
+                    if (vehicles.length > 0)
                         ghRequest.vehicle = vehicles[0];
+
                     for (var i = 0; i < vehicles.length; i++) {
                         vehiclesDiv.append(createButton(vehicles[i]));
                     }
@@ -122,12 +128,6 @@ $(document).ready(function(e) {
 
                 initMap();
 
-//        var data = JSON.parse("[[10.4049076,48.2802518],[10.405231,48.2801396],...]");
-//        var tempFeature = {
-//            "type": "Feature", "geometry": { "type": "LineString", "coordinates": data }
-//        };        
-//        routingLayer.addData(tempFeature);
-
                 // execute query
                 initFromParams(urlParams, true);
             }, function(err) {
@@ -142,12 +142,19 @@ $(document).ready(function(e) {
                 };
                 initMap();
             });
+
+    $(window).resize(function() {
+        adjustMapSize();
+    });
+
+    setAutoCompleteList("from");
+    setAutoCompleteList("to");
 });
 
 function initFromParams(params, doQuery) {
     ghRequest.init(params);
     var fromAndTo = params.from && params.to;
-    var routeNow = params.point && params.point.length == 2 || fromAndTo;
+    var routeNow = params.point && params.point.length === 2 || fromAndTo;
     if (routeNow) {
         if (fromAndTo)
             resolveCoords(params.from, params.to, doQuery);
@@ -176,85 +183,73 @@ function resolveCoords(fromStr, toStr, doQuery) {
     }
 }
 
-function initMap() {
+function adjustMapSize() {
     var mapDiv = $("#map");
-    var width = $(window).width() - 300;
-    if (width < 100)
-        width = $(window).width() - 5;
-    var height = $(window).height() - 5;
+    var width = $(window).width() - 295;
+    if (width < 400) {
+        width = 290;
+        mapDiv.attr("style", "position: relative; float: right;");
+    } else {
+        mapDiv.attr("style", "position: absolute; right: 0;");
+    }
+    var height = $(window).height();
     mapDiv.width(width).height(height);
-    if (height > 350)
-        height -= 265;
-    $("#info").css("max-height", height);
+    $("#input").height(height);
+    $("#info").css("max-height", height - $("#input_header").height() - 35);
+}
+
+function initMap() {
+    adjustMapSize();
     console.log("init map at " + JSON.stringify(bounds));
 
     // mapquest provider
-    var moreAttr = 'Data &copy; <a href="http://www.openstreetmap.org/copyright">OSM</a>,'
-            + 'JS: <a href="http://leafletjs.com/">Leaflet</a>';
+    var osmAttr = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
 
     var tp = "ls";
     if (L.Browser.retina)
         tp = "lr";
 
     var lyrk = L.tileLayer('http://{s}.tiles.lyrk.org/' + tp + '/{z}/{x}/{y}?apikey=6e8cfef737a140e2a58c8122aaa26077', {
-        attribution: '<a href="http://geodienste.lyrk.de/">Lyrk</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://geodienste.lyrk.de/">Lyrk</a>',
         subdomains: ['a', 'b', 'c']
     });
 
     var mapquest = L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://open.mapquest.co.uk">MapQuest</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://open.mapquest.co.uk">MapQuest</a>',
         subdomains: ['otile1', 'otile2', 'otile3', 'otile4']
     });
 
     var mapquestAerial = L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://open.mapquest.co.uk">MapQuest</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://open.mapquest.co.uk">MapQuest</a>',
         subdomains: ['otile1', 'otile2', 'otile3', 'otile4']
     });
 
     var thunderTransport = L.tileLayer('http://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://www.thunderforest.com/transport/">Thunderforest Transport</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://www.thunderforest.com/transport/">Thunderforest Transport</a>',
         subdomains: ['a', 'b', 'c']
     });
 
     var thunderCycle = L.tileLayer('http://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://www.thunderforest.com/opencyclemap/">Thunderforest Cycle</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://www.thunderforest.com/opencyclemap/">Thunderforest Cycle</a>',
         subdomains: ['a', 'b', 'c']
     });
 
     var thunderOutdoors = L.tileLayer('http://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://www.thunderforest.com/outdoors/">Thunderforest Outdoors</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://www.thunderforest.com/outdoors/">Thunderforest Outdoors</a>',
         subdomains: ['a', 'b', 'c']
     });
 
-    //    var mapbox = L.tileLayer('http://a.tiles.mapbox.com/v3/mapbox.world-bright/{z}/{x}/{y}.png', {
-    //        attribution: '<a href="http://www.mapbox.com">MapBox</a>,' + moreAttr, 
-    //        subdomains: ['a','b','c']
-    //    });    
-
     var wrk = L.tileLayer('http://{s}.wanderreitkarte.de/topo/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://wanderreitkarte.de">WanderReitKarte</a>,' + moreAttr,
+        attribution: osmAttr + ', <a href="http://wanderreitkarte.de">WanderReitKarte</a>',
         subdomains: ['topo4', 'topo', 'topo2', 'topo3']
     });
 
-    var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
-        attribution: '<a href="http://cloudmade.com">Cloudmade</a>,' + moreAttr,
-        key: '43b079df806c4e03b102055c4e1a8ba8',
-        styleId: 997
-    });
-
     var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
-        attribution: moreAttr
+        attribution: osmAttr
     });
 
     var osmde = L.tileLayer('http://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
-        attribution: moreAttr
-    });
-
-    // only work if you zoom a bit deeper
-    var lang = "en_US";
-    var apple = L.tileLayer('http://gsp2.apple.com/tile?api=1&style=slideshow&layers=default&lang=' + lang + '&z={z}&x={x}&y={y}&v=9', {
-        maxZoom: 17,
-        attribution: 'Map data and Imagery &copy; <a href="http://www.apple.com/ios/maps/">Apple</a>,' + moreAttr
+        attribution: osmAttr
     });
 
     // default
@@ -269,9 +264,7 @@ function initMap() {
         "TF Transport": thunderTransport,
         "TF Cycle": thunderCycle,
         "TF Outdoors": thunderOutdoors,
-        // didn't found a usage policy for this "Apple": apple,
         "WanderReitKarte": wrk,
-        "Cloudmade": cloudmade,
         "OpenStreetMap": osm,
         "OpenStreetMap.de": osmde
     };
@@ -316,6 +309,8 @@ function initMap() {
         }).addTo(map);
 
     routingLayer = L.geoJson().addTo(map);
+    routingLayer.options = {style: {color: "#00cc33", "weight": 5, "opacity": 0.6}};
+
     firstClickToRoute = true;
     function onMapClick(e) {
         var latlng = e.latlng;
@@ -365,7 +360,7 @@ function setFlag(coord, isFrom) {
                 resolveTo();
             }
             // do not wait for resolving and avoid zooming when dragging
-            ghRequest.doZoom = false;
+            ghRequest.do_zoom = false;
             routeLatLng(ghRequest, false);
         });
     }
@@ -389,22 +384,9 @@ function resolve(fromOrTo, locCoord) {
     return createAmbiguityList(locCoord).done(function(arg1) {
         var errorDiv = $("#" + fromOrTo + "ResolveError");
         errorDiv.empty();
-        var foundDiv = $("#" + fromOrTo + "ResolveFound");
-        // deinstallation of completion if there was one
-        // if (getAutoCompleteDiv(fromOrTo).autocomplete())
-        //    getAutoCompleteDiv(fromOrTo).autocomplete().dispose();
-
-        foundDiv.empty();
-        var list = locCoord.resolvedList;
-        if (locCoord.error) {
+        
+        if (locCoord.error)
             errorDiv.text(locCoord.error);
-        } else if (list) {
-            var anchor = String.fromCharCode(0x25BC);
-            var linkPart = $("<a>" + anchor + "<small>" + list.length + "</small></a>");
-            foundDiv.append(linkPart.click(function(e) {
-                setAutoCompleteList(fromOrTo, locCoord);
-            }));
-        }
 
         $("#" + fromOrTo + "Indicator").hide();
         $("#" + fromOrTo + "Flag").show();
@@ -606,9 +588,9 @@ function focus(coord, zoom, isFrom) {
     }
 }
 function routeLatLng(request, doQuery) {
-    // doZoom should not show up in the URL but in the request object to avoid zooming for history change
-    var doZoom = request.doZoom;
-    request.doZoom = true;
+    // do_zoom should not show up in the URL but in the request object to avoid zooming for history change
+    var doZoom = request.do_zoom;
+    request.do_zoom = true;
 
     var urlForHistory = request.createFullURL();
     // not enabled e.g. if no cookies allowed (?)
@@ -617,7 +599,7 @@ function routeLatLng(request, doQuery) {
         // 2. important workaround for encoding problems in history.js
         var params = parseUrl(urlForHistory);
         console.log(params);
-        params.doZoom = doZoom;
+        params.do_zoom = doZoom;
         // force a new request even if we have the same parameters
         params.mathRandom = Math.random();
         History.pushState(params, browserTitle, urlForHistory);
@@ -636,6 +618,9 @@ function routeLatLng(request, doQuery) {
         return;
     }
 
+    if (elevationControl)
+        elevationControl.clear();
+
     routingLayer.clearLayers();
     setFlag(request.from, true);
     setFlag(request.to, false);
@@ -654,116 +639,133 @@ function routeLatLng(request, doQuery) {
                 descriptionDiv.append("<div class='error'>" + tmpErrors[m].message + "</div>");
             }
             return;
-        } else if (json.info.routeFound === false) {
-            descriptionDiv.html('Route not found! Disconnected areas?');
-            return;
         }
+        var path = json.paths[0];
         var geojsonFeature = {
             "type": "Feature",
             // "style": myStyle,                
-            "geometry": json.route.data
+            "geometry": path.points
         };
 
+        if (path.points_dimension === 3) {
+            if (elevationControl === null) {
+                elevationControl = L.control.elevation({
+                    position: "bottomright",
+                    theme: "white-theme", //default: lime-theme
+                    width: 450,
+                    height: 125,
+                    yAxisMin: 0, // set min domain y axis
+                    // yAxisMax: 550, // set max domain y axis
+                    forceAxisBounds: false,
+                    margins: {
+                        top: 10,
+                        right: 20,
+                        bottom: 30,
+                        left: 50
+                    },
+                    useHeightIndicator: true, //if false a marker is drawn at map position
+                    interpolation: "linear", //see https://github.com/mbostock/d3/wiki/SVG-Shapes#wiki-area_interpolate
+                    hoverNumber: {
+                        decimalsX: 3, //decimals on distance (always in km)
+                        decimalsY: 0, //deciamls on height (always in m)
+                        formatter: undefined //custom formatter function may be injected
+                    },
+                    xTicks: undefined, //number of ticks in x axis, calculated by default according to width
+                    yTicks: undefined, //number of ticks on y axis, calculated by default according to height
+                    collapsed: false    //collapsed mode, show chart on click or mouseover
+                });
+                elevationControl.addTo(map);
+            }
+
+            elevationControl.addData(geojsonFeature);
+        }
+
         routingLayer.addData(geojsonFeature);
-        if (json.route.bbox && doZoom) {
-            var minLon = json.route.bbox[0];
-            var minLat = json.route.bbox[1];
-            var maxLon = json.route.bbox[2];
-            var maxLat = json.route.bbox[3];
+        if (path.bbox && doZoom) {
+            var minLon = path.bbox[0];
+            var minLat = path.bbox[1];
+            var maxLon = path.bbox[2];
+            var maxLat = path.bbox[3];
             var tmpB = new L.LatLngBounds(new L.LatLng(minLat, minLon), new L.LatLng(maxLat, maxLon));
             map.fitBounds(tmpB);
         }
 
-        var tmpTime = createTimeString(json.route.time);
-        var tmpDist = createDistanceString(json.route.distance);
-        descriptionDiv.html(tr("routeInfo", [tmpDist, tmpTime]));
-
-        var hiddenDiv = $("<div id='routeDetails'/>");
-        hiddenDiv.hide();
-
-        var toggly = $("<button style='font-size:14px; float: right; font-weight: bold; padding: 0px'>+</button>");
-        toggly.click(function() {
-            hiddenDiv.toggle();
-        });
-        $("#info").prepend(toggly);
-        var infoStr = "took: " + round(json.info.took, 1000) + "s"
-                + ", points: " + json.route.data.coordinates.length;
-        //if (json.route.instructions)
-        //    infoStr += ", instructions: " + json.route.instructions.descriptions.length;
-        hiddenDiv.append("<span>" + infoStr + "</span>");
-        $("#info").append(hiddenDiv);
-
-        var exportLink = $("#exportLink a");
-        exportLink.attr('href', urlForHistory);
-        var startOsmLink = $("<a>start</a>");
-        startOsmLink.attr("href", "http://www.openstreetmap.org/?zoom=14&mlat=" + request.from.lat + "&mlon=" + request.from.lng);
-        var endOsmLink = $("<a>end</a>");
-        endOsmLink.attr("href", "http://www.openstreetmap.org/?zoom=14&mlat=" + request.to.lat + "&mlon=" + request.to.lng);
-        hiddenDiv.append("<br/><span>View on OSM: </span>").append(startOsmLink).append(endOsmLink);
-
-        var osrmLink = $("<a>OSRM</a>");
-        osrmLink.attr("href", "http://map.project-osrm.org/?loc=" + from + "&loc=" + to);
-        hiddenDiv.append("<br/><span>Compare with: </span>");
-        hiddenDiv.append(osrmLink);
-        var googleLink = $("<a>Google</a> ");
-        var addToGoogle = "";
-        var addToBing = "";
-        if (request.vehicle.toUpperCase() == "FOOT") {
-            addToGoogle = "&dirflg=w";
-            addToBing = "&mode=W";
-        } else if ((request.vehicle.toUpperCase() == "BIKE") ||
-                (request.vehicle.toUpperCase() == "RACINGBIKE") ||
-                (request.vehicle.toUpperCase() == "MTB")) {
-            addToGoogle = "&dirflg=b";
-            // ? addToBing = "&mode=B";
-        }
-        googleLink.attr("href", "http://maps.google.com/?q=from:" + from + "+to:" + to + addToGoogle);
-        hiddenDiv.append(googleLink);
-        var bingLink = $("<a>Bing</a> ");
-        bingLink.attr("href", "http://www.bing.com/maps/default.aspx?rtp=adr." + from + "~adr." + to + addToBing);
-        hiddenDiv.append(bingLink);
-
-        if (host.indexOf("gpsies.com") > 0)
-            hiddenDiv.append("<div id='hosting'>The routing API is hosted by <a href='http://gpsies.com'>GPSies.com</a></div>");
+        var tmpTime = createTimeString(path.time);
+        var tmpDist = createDistanceString(path.distance);
+        descriptionDiv.append(tr("routeInfo", [tmpDist, tmpTime]));
 
         $('.defaulting').each(function(index, element) {
             $(element).css("color", "black");
         });
 
-        if (json.route.instructions) {
-            var instructionsElement = $("<table id='instructions'><colgroup>"
-                    + "<col width='10%'><col width='65%'><col width='25%'></colgroup>");
+        if (path.instructions) {
+            var instructionsElement = $("<table id='instructions'>");
+
+            var partialInstr = path.instructions.length > 100;
+            var len = Math.min(path.instructions.length, 100);
+            for (var m = 0; m < len; m++) {
+                var instr = path.instructions[m];
+                var lngLat = path.points.coordinates[instr.interval[0]];
+                addInstruction(instructionsElement, instr, m, lngLat);
+            }
             $("#info").append(instructionsElement);
-            var descriptions = json.route.instructions.descriptions;
-            var distances = json.route.instructions.distances;
-            var indications = json.route.instructions.indications;
-            var millis = json.route.instructions.millis;
-            var latLngs = json.route.instructions.latLngs;
-            for (var m = 0; m < descriptions.length; m++) {
-                var indi = indications[m];
-                if (m == 0)
-                    indi = "marker-from";
-                else if (indi == -3)
-                    indi = "sharp_left";
-                else if (indi == -2)
-                    indi = "left";
-                else if (indi == -1)
-                    indi = "slight_left";
-                else if (indi == 0)
-                    indi = "continue";
-                else if (indi == 1)
-                    indi = "slight_right";
-                else if (indi == 2)
-                    indi = "right";
-                else if (indi == 3)
-                    indi = "sharp_right";
-                else if (indi == 4)
-                    indi = "marker-to";
-                else
-                    throw "did not found indication " + indi;
-
-                addInstruction(instructionsElement, indi, descriptions[m], distances[m], millis[m], latLngs[m]);
+
+            if (partialInstr) {
+                var moreDiv = $("<button id='moreButton'>More...</button>");
+                moreDiv.click(function() {
+                    moreDiv.remove();
+                    for (var m = len; m < path.instructions.length; m++) {
+                        var instr = path.instructions[m];
+                        var lngLat = path.points.coordinates[instr.interval[0]];
+                        addInstruction(instructionsElement, instr, m, lngLat);
+                    }
+                });
+                instructionsElement.append(moreDiv);
+            }
+
+            var hiddenDiv = $("<div id='routeDetails'/>");
+            hiddenDiv.hide();
+
+            var toggly = $("<button id='expandDetails'>+</button>");
+            toggly.click(function() {
+                hiddenDiv.toggle();
+            });
+            $("#info").append(toggly);
+            var infoStr = "took: " + round(json.info.took, 1000) + "s"
+                    + ", points: " + path.points.coordinates.length;
+
+            hiddenDiv.append("<span>" + infoStr + "</span>");
+
+            var exportLink = $("#exportLink a");
+            exportLink.attr('href', urlForHistory);
+            var startOsmLink = $("<a>start</a>");
+            startOsmLink.attr("href", "http://www.openstreetmap.org/?zoom=14&mlat=" + request.from.lat + "&mlon=" + request.from.lng);
+            var endOsmLink = $("<a>end</a>");
+            endOsmLink.attr("href", "http://www.openstreetmap.org/?zoom=14&mlat=" + request.to.lat + "&mlon=" + request.to.lng);
+            hiddenDiv.append("<br/><span>View on OSM: </span>").append(startOsmLink).append(endOsmLink);
+
+            var osrmLink = $("<a>OSRM</a>");
+            osrmLink.attr("href", "http://map.project-osrm.org/?loc=" + from + "&loc=" + to);
+            hiddenDiv.append("<br/><span>Compare with: </span>");
+            hiddenDiv.append(osrmLink);
+            var googleLink = $("<a>Google</a> ");
+            var addToGoogle = "";
+            var addToBing = "";
+            if (request.vehicle.toUpperCase() === "FOOT") {
+                addToGoogle = "&dirflg=w";
+                addToBing = "&mode=W";
+            } else if ((request.vehicle.toUpperCase() === "BIKE") ||
+                    (request.vehicle.toUpperCase() === "RACINGBIKE") ||
+                    (request.vehicle.toUpperCase() === "MTB")) {
+                addToGoogle = "&dirflg=b";
+                // ? addToBing = "&mode=B";
             }
+            googleLink.attr("href", "http://maps.google.com/?q=from:" + from + "+to:" + to + addToGoogle);
+            hiddenDiv.append(googleLink);
+            var bingLink = $("<a>Bing</a> ");
+            bingLink.attr("href", "http://www.bing.com/maps/default.aspx?rtp=adr." + from + "~adr." + to + addToBing);
+            hiddenDiv.append(bingLink);
+            $("#info").append(hiddenDiv);
         }
     });
 }
@@ -798,43 +800,60 @@ function createTimeString(time) {
     return resTimeStr;
 }
 
-function addInstruction(main, indi, title, distance, milliEntry, latLng) {
-    var indiPic = "<img class='instr_pic' style='vertical-align: middle' src='" +
-            window.location.pathname + "img/" + indi + ".png'/>";
+function addInstruction(main, instr, instrIndex, lngLat) {
+    var sign = instr.sign;
+    if (instrIndex === 0)
+        sign = "marker-icon-green";
+    else if (sign === -3)
+        sign = "sharp_left";
+    else if (sign === -2)
+        sign = "left";
+    else if (sign === -1)
+        sign = "slight_left";
+    else if (sign === 0)
+        sign = "continue";
+    else if (sign === 1)
+        sign = "slight_right";
+    else if (sign === 2)
+        sign = "right";
+    else if (sign === 3)
+        sign = "sharp_right";
+    else if (sign === 4)
+        sign = "marker-icon-red";
+    else
+        throw "did not found sign " + sign;
+    var title = instr.text;
+    var distance = instr.distance;
     var str = "<td class='instr_title'>" + title + "</td>";
 
     if (distance > 0) {
-        str += " <td class='instr_distance_td'><span class='instr_distance'>" + createDistanceString(distance) + "<br/>"
-                + createTimeString(milliEntry) + "</span></td>";
+        str += " <td class='instr_distance'><span>"
+                + createDistanceString(distance) + "<br/>"
+                + createTimeString(instr.time) + "</span></td>";
     }
 
-    if (indi !== "continue")
-        str = "<td>" + indiPic + "</td>" + str;
-    else
-        str = "<td/>" + str;
+    if (sign !== "continue") {
+        var indiPic = "<img class='pic' style='vertical-align: middle' src='" +
+                window.location.pathname + "img/" + sign + ".png'/>";
+        str = "<td class='instr_pic'>" + indiPic + "</td>" + str;
+    } else
+        str = "<td class='instr_pic'/>" + str;
     var instructionDiv = $("<tr class='instruction'/>");
     instructionDiv.html(str);
-    if (latLng) {
+    if (lngLat) {
         instructionDiv.click(function() {
-            hideRouteSegmentPopup();
-            showRouteSegmentPopup(indiPic + " " + title, latLng);
+            if (routeSegmentPopup)
+                map.removeLayer(routeSegmentPopup);
+
+            routeSegmentPopup = L.popup().
+                    setLatLng([lngLat[1], lngLat[0]]).
+                    setContent(title).
+                    openOn(map);
         });
     }
     main.append(instructionDiv);
 }
 
-function showRouteSegmentPopup(html, latLng) {
-    hideRouteSegmentPopup();
-    routeSegmentPopup = L.popup().setLatLng(latLng).setContent(html).openOn(map);
-}
-
-function hideRouteSegmentPopup() {
-    if (routeSegmentPopup) {
-        map.removeLayer(routeSegmentPopup);
-        routeSegmentPopup = null;
-    }
-}
-
 function getCenter(bounds) {
     var center = {
         lat: 0,
@@ -977,105 +996,115 @@ function exportGPX() {
 }
 
 function getAutoCompleteDiv(fromOrTo) {
-    if (fromOrTo === "from")
-        return $('#fromInput')
-    else
-        return $('#toInput');
+    return $('#' + fromOrTo + 'Input');
+}
+
+function formatValue(orig, query) {
+    var pattern = '(' + $.Autocomplete.utils.escapeRegExChars(query) + ')';
+    return orig.replace(new RegExp(pattern, 'gi'), '<strong>$1<\/strong>');
 }
 
 function setAutoCompleteList(fromOrTo, ghRequestLoc) {
-    function formatValue(suggestionValue, currentValue) {
-        var pattern = '(' + $.Autocomplete.utils.escapeRegExChars(currentValue) + ')';
-        return suggestionValue.replace(new RegExp(pattern, 'gi'), '<strong>$1<\/strong>');
-    }
     var isFrom = fromOrTo === "from";
     var pointIndex = isFrom ? 1 : 2;
-    var fakeCurrentInput = ghRequestLoc.input.toLowerCase();
-    var valueDataList = [];
-    var list = ghRequestLoc.resolvedList;
-    for (var index in list) {
-        var dataItem = list[index];
-        valueDataList.push({value: dataToText(dataItem), data: dataItem});
-    }
-
+    var myAutoDiv = getAutoCompleteDiv(fromOrTo);
+    
     var options = {
+        containerClass: "complete-" + pointIndex,
+        /* as we use jsonp we need to set the timeout to a small value */        
+        timeout: 1000,
+        /* avoid too many requests when typing quickly */
+        deferRequestBy: 5,
+        minChars: 2,
         maxHeight: 510,
+        noCache: true,
+        /* this default could be problematic: preventBadQueries: true, */
         triggerSelectOnValidInput: false,
         autoSelectFirst: false,
-        lookup: valueDataList,
+        paramName: "q",
+        dataType: "jsonp",
+        serviceUrl: function() {
+            return ghRequest.createGeocodeURL();
+        },
+        transformResult: function(response, originalQuery) {
+            response.suggestions = [];
+            for (var i = 0; i < response.hits.length; i++) {
+                var hit = response.hits[i];
+                response.suggestions.push({value: dataToText(hit), data: hit});
+            }
+            return response;
+        },
         onSearchError: function(element, q, jqXHR, textStatus, errorThrown) {
-            console.log(element + ", " + q + ", textStatus " + textStatus + ", " + errorThrown);
+            // too many errors if interrupted console.log(element + ", " + JSON.stringify(q) + ", textStatus " + textStatus + ", " + errorThrown);
         },
         formatResult: function(suggestion, currInput) {
             // avoid highlighting for now as this breaks the html sometimes
-            return dataToHtml(suggestion.data);
+            return dataToHtml(suggestion.data, currInput);
+        },
+        onSelect: function(suggestion) {
+            options.onPreSelect(suggestion);
         },
-        lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
-            if (queryLowerCase === fakeCurrentInput)
-                return true;
-            return suggestion.value.toLowerCase().indexOf(queryLowerCase) !== -1;
+        onPreSelect: function(suggestion) {
+            var req = ghRequest.to;
+            if (isFrom)
+                req = ghRequest.from;
+
+            myAutoDiv.autocomplete().disable();
+            
+            var point = suggestion.data.point;
+            req.setCoord(point.lat, point.lng);            
+            
+            req.input = suggestion.value;            
+            if (ghRequest.from.isResolved() && ghRequest.to.isResolved())
+                routeLatLng(ghRequest);
+            else
+                focus(req, 15, isFrom);
+            
+            myAutoDiv.autocomplete().enable();
         }
     };
-    options.onSelect = function(suggestion) {
-        options.onPreSelect(suggestion);
-    };
-    options.onPreSelect = function(suggestion) {
-        var data = suggestion.data;
-        ghRequestLoc.setCoord(data.lat, data.lng);
-        ghRequestLoc.input = dataToText(suggestion.data);
-        if (ghRequest.from.isResolved() && ghRequest.to.isResolved())
-            routeLatLng(ghRequest);
-        else if (suggestion.data.boundingbox) {
-            var bbox = suggestion.data.box;
-            focusWithBounds(ghRequestLoc, [[bbox[0], bbox[2]], [bbox[1], bbox[3]]], isFrom);
-        } else
-            focus(ghRequestLoc, 15, isFrom);
-    };
-
-    options.containerClass = "complete-" + pointIndex;
-    var myAutoDiv = getAutoCompleteDiv(fromOrTo);
+    
     myAutoDiv.autocomplete(options);
-    myAutoDiv.autocomplete().forceSuggest("");
-    myAutoDiv.focus();
 }
 
-function dataToHtml(data) {
-    var data = data.locationDetails;
-    var text = "";
-    if (data.road)
-        text += "<div class='roadseg'>" + data.road + "</div>";
-    if (data.city) {
-        text += "<div class='cityseg'>" + insComma(data.city, data.country) + "</div>";
-    }
+function dataToHtml(data, query) {
+    var element = "";
+    if (data.name)
+        element += "<div class='nameseg'>" + formatValue(data.name, query) + "</div>";
+    var addStr = "";
+    if (data.postcode)
+        addStr = data.postcode;
+    if (data.city)
+        addStr = insComma(addStr, data.city);
     if (data.country)
-        text += "<div class='moreseg'>" + data.more + "</div>";
-    return text;
-}
+        addStr = insComma(addStr, data.country);
 
-// do not print everything as nominatim slows down or doesn't properly handle if continent etc is included
-function dataToText(data) {
-    var data = data.locationDetails;
-    var text = "";
-    if (data.road)
-        text += data.road;
+    if (addStr)
+        element += "<div class='cityseg'>" + formatValue(addStr, query) + "</div>";
 
-    if (data.city) {
-        if (text.length > 0)
-            text += ", ";
-        text += data.city;
-    }
-
-    if (data.postcode) {
-        if (text.length > 0)
-            text += ", ";
-        text += data.postcode;
+    if (data.osm_key === "highway") {
+        // ignore
     }
+    if (data.osm_key === "place") {
+        element += "<span class='moreseg'>" + data.osm_value + "</span>";
+    } else
+        element += "<span class='moreseg'>" + data.osm_key + "</span>";
+    return element;
+}
 
-    if (data.country) {
-        if (text.length > 0)
-            text += ", ";
-        var tmp = $.trim(data.country.replace(data.city, '').replace(data.city + ", ", ''));
-        text += tmp;
-    }
+function dataToText(data) {
+    var text = "";
+    if (data.name)
+        text += data.name;
+    
+    if (data.postcode)
+        text = insComma(text, data.postcode);
+    
+    // make sure name won't be duplicated
+    if (data.city && text.indexOf(data.city) < 0)
+        text = insComma(text, data.city);
+    
+    if (data.country && text.indexOf(data.country) < 0)
+        text = insComma(text, data.country);       
     return text;
 }
diff --git a/web/src/test/java/com/graphhopper/http/BaseServletTest.java b/web/src/test/java/com/graphhopper/http/BaseServletTest.java
index 90c6a33912..12995eb1ce 100644
--- a/web/src/test/java/com/graphhopper/http/BaseServletTest.java
+++ b/web/src/test/java/com/graphhopper/http/BaseServletTest.java
@@ -21,15 +21,8 @@
 import com.google.inject.Injector;
 import com.google.inject.Module;
 import com.google.inject.servlet.GuiceFilter;
-import com.graphhopper.util.Constants;
+import com.graphhopper.util.CmdArgs;
 import com.graphhopper.util.Downloader;
-import java.util.EnumSet;
-import javax.servlet.DispatcherType;
-import org.eclipse.jetty.server.Connector;
-import org.eclipse.jetty.server.Server;
-import org.eclipse.jetty.server.bio.SocketConnector;
-import org.eclipse.jetty.webapp.WebAppContext;
-import org.eclipse.jetty.webapp.WebXmlConfiguration;
 import org.json.JSONObject;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -39,7 +32,7 @@
  */
 public class BaseServletTest
 {
-    private static Server server;
+    private static GHServer server;
     protected static Logger logger = LoggerFactory.getLogger(GraphHopperServletIT.class);
     protected static int port;
     protected Injector injector;
@@ -65,47 +58,24 @@ private void bootJetty( int retryCount )
         if (server != null)
             return;
 
-        System.setProperty("graphhopper.config", "../config-example.properties");
-        System.setProperty("graphhopper.osmreader.osm", "../core/files/andorra.osm.pbf");
-        System.setProperty("graphhopper.graph.location", "./target/andorra-gh/");
+        CmdArgs args = new CmdArgs().
+                put("config", "../config-example.properties").
+                put("osmreader.osm", "../core/files/andorra.osm.pbf").
+                put("graph.location", "./target/andorra-gh/");
 
-        String webapp = "./target/graphhopper-web-" + Constants.VERSION;
-        WebAppContext app = new WebAppContext(webapp, "/");
-        // jetty 8:
-        app.addFilter(GuiceFilter.class, "/*", EnumSet.allOf(DispatcherType.class));
-        // jetty 7:
-        // app.addFilter(GuiceFilter.class, "/*", 0);
-        app.setConfigurationClasses(new String[]
-        {
-            WebXmlConfiguration.class.getName()
-        });
+        server = new GHServer(args);
 
-        app.addEventListener(new GuiceServletConfig()
-        {
-            @Override
-            protected Injector getInjector()
-            {
-                if (injector == null)
-                    setUpGuice(createDefaultModule(), createServletModule());
-
-                return injector;
-            }
-        });
-        app.setParentLoaderPriority(true);
+        if (injector == null)
+            setUpGuice(new DefaultModule(args), new GHServletModule());
 
         for (int i = 0; i < retryCount; i++)
         {
-            // We explicitly use the SocketConnector because the SelectChannelConnector locks files
-            Connector connector = new SocketConnector();
-            connector.setPort(port = 18080 + i);
-            connector.setMaxIdleTime(10000);
-            server = new Server();
-            server.addConnector(connector);
-            server.setHandler(app);
+            port = 18080 + i;
+            args.put("jetty.port", "" + port);
             try
             {
                 logger.info("Trying to start jetty at port " + port);
-                server.start();
+                server.start(injector);
 //                server.join();
                 break;
             } catch (Exception ex)
@@ -137,7 +107,7 @@ public void shutdownJetty( boolean force )
     protected String getTestAPIUrl()
     {
         String host = "localhost";
-        return "http://" + host + ":" + port + "/api/route";
+        return "http://" + host + ":" + port + "/route";
     }
 
     protected JSONObject query( String query ) throws Exception
diff --git a/web/src/test/java/com/graphhopper/http/GraphHopperServletIT.java b/web/src/test/java/com/graphhopper/http/GraphHopperServletIT.java
index 3e25c77607..38ebeec518 100644
--- a/web/src/test/java/com/graphhopper/http/GraphHopperServletIT.java
+++ b/web/src/test/java/com/graphhopper/http/GraphHopperServletIT.java
@@ -28,25 +28,29 @@
 /**
  * @author Peter Karich
  */
-public class GraphHopperServletIT extends BaseServletTest {
+public class GraphHopperServletIT extends BaseServletTest
+{
 
     @Before
-    public void setUp() {
+    public void setUp()
+    {
         setUpJetty();
     }
 
     @Test
-    public void testBasicQuery() throws Exception {
+    public void testBasicQuery() throws Exception
+    {
         JSONObject json = query("point=42.554851,1.536198&point=42.510071,1.548128");
         JSONObject infoJson = json.getJSONObject("info");
         assertFalse(infoJson.has("errors"));
-        double distance = json.getJSONObject("route").getDouble("distance");
+        double distance = json.getJSONArray("paths").getJSONObject(0).getDouble("distance");
         assertTrue("distance wasn't correct:" + distance, distance > 9000);
         assertTrue("distance wasn't correct:" + distance, distance < 9500);
     }
 
     @Test
-    public void testGraphHopperWeb() throws Exception {
+    public void testGraphHopperWeb() throws Exception
+    {
         GraphHopperAPI hopper = new GraphHopperWeb();
         assertTrue(hopper.load(getTestAPIUrl()));
         GHResponse rsp = hopper.route(new GHRequest(42.554851, 1.536198, 42.510071, 1.548128));
diff --git a/web/src/test/java/com/graphhopper/http/GraphHopperWebTest.java b/web/src/test/java/com/graphhopper/http/GraphHopperWebTest.java
index ce3613d35d..6b29124e4d 100644
--- a/web/src/test/java/com/graphhopper/http/GraphHopperWebTest.java
+++ b/web/src/test/java/com/graphhopper/http/GraphHopperWebTest.java
@@ -22,7 +22,6 @@
 import com.graphhopper.util.Downloader;
 import java.io.IOException;
 import java.io.InputStream;
-import java.net.HttpURLConnection;
 import org.junit.Test;
 import static org.junit.Assert.*;
 
@@ -30,35 +29,46 @@
  *
  * @author Peter Karich
  */
-public class GraphHopperWebTest {
+public class GraphHopperWebTest
+{
 
     @Test
-    public void testReadUnencoded() throws Exception {
-        Downloader downloader = new Downloader("GraphHopper Test") {
+    public void testReadUnencoded() throws Exception
+    {
+        Downloader downloader = new Downloader("GraphHopper Test")
+        {
             @Override
-            public InputStream fetch(String url) throws IOException {
+            public InputStream fetch( String url ) throws IOException
+            {
                 return getClass().getResourceAsStream("test.json");
             }
         };
-        GraphHopperWeb instance = new GraphHopperWeb().setEncodePolyline(false);
+        GraphHopperWeb instance = new GraphHopperWeb().setPointsEncoded(false);
         instance.setDownloader(downloader);
-        GHResponse res = instance.route(new GHRequest(11.561415, 49.9516, 11.560439, 49.950357));
-        assertEquals(0.218915, res.getDistance(), 1e-5);
-        assertEquals(7, res.getPoints().getSize());
+        GHResponse res = instance.route(new GHRequest(52.47379, 13.362808, 52.4736925, 13.3904394));
+        assertEquals(2138.3, res.getDistance(), 1e-1);
+        assertEquals(17, res.getPoints().getSize());
+        assertEquals(5, res.getInstructions().getSize());
     }
 
     @Test
-    public void testReadEncoded() throws Exception {
-        Downloader downloader = new Downloader("GraphHopper Test") {
+    public void testReadEncoded() throws Exception
+    {
+        Downloader downloader = new Downloader("GraphHopper Test")
+        {
             @Override
-            public InputStream fetch(String url) throws IOException {
+            public InputStream fetch( String url ) throws IOException
+            {
                 return getClass().getResourceAsStream("test_encoded.json");
             }
         };
-        GraphHopperWeb instance = new GraphHopperWeb().setEncodePolyline(true);
+        GraphHopperWeb instance = new GraphHopperWeb().setPointsEncoded(true);
         instance.setDownloader(downloader);
-        GHResponse res = instance.route(new GHRequest(11.561415, 49.9516, 11.560439, 49.950357));
-        assertEquals(0.218915, res.getDistance(), 1e-5);
-        assertEquals(7, res.getPoints().getSize());
+        GHResponse res = instance.route(new GHRequest(52.47379, 13.362808, 52.4736925, 13.3904394));
+        assertEquals(2138.3, res.getDistance(), 1e-1);
+        assertEquals(17, res.getPoints().getSize());
+        assertEquals(5, res.getInstructions().getSize());
+        assertEquals("(0,Geradeaus auf A 100,1268.519329705091,65237)", res.getInstructions().get(0).toString());
+        assertEquals(11, res.getInstructions().get(0).getPoints().size());
     }
 }
diff --git a/web/src/test/java/com/graphhopper/http/WebHelperTest.java b/web/src/test/java/com/graphhopper/http/WebHelperTest.java
index aad3f09aa4..4276ca4ed5 100644
--- a/web/src/test/java/com/graphhopper/http/WebHelperTest.java
+++ b/web/src/test/java/com/graphhopper/http/WebHelperTest.java
@@ -31,10 +31,10 @@
     @Test
     public void testDecode() throws Exception
     {
-        PointList list = WebHelper.decodePolyline("_p~iF~ps|U", 1);
+        PointList list = WebHelper.decodePolyline("_p~iF~ps|U", 1, false);
         assertEquals(Helper.createPointList(38.5, -120.2), list);
 
-        list = WebHelper.decodePolyline("_p~iF~ps|U_ulLnnqC_mqNvxq`@", 3);
+        list = WebHelper.decodePolyline("_p~iF~ps|U_ulLnnqC_mqNvxq`@", 3, false);
         assertEquals(Helper.createPointList(38.5, -120.2, 40.7, -120.95, 43.252, -126.453), list);
     }
 
@@ -54,11 +54,29 @@ public void testBoth() throws Exception
         PointList list = Helper.createPointList(38.5, -120.2, 43.252, -126.453,
                 40.7, -120.95, 50.3139, 10.61279, 50.04303, 9.49768);
         String str = WebHelper.encodePolyline(list);
-        assertEquals(list, WebHelper.decodePolyline(str, list.getSize()));
+        assertEquals(list, WebHelper.decodePolyline(str, list.getSize(), false));
 
         list = Helper.createPointList(38.5, -120.2, 43.252, -126.453,
                 40.7, -120.95, 40.70001, -120.95001);
         str = WebHelper.encodePolyline(list);
-        assertEquals(list, WebHelper.decodePolyline(str, list.getSize()));
+        assertEquals(list, WebHelper.decodePolyline(str, list.getSize(), false));
+    }
+
+    @Test
+    public void testDecode3D() throws Exception
+    {
+        PointList list = WebHelper.decodePolyline("_p~iF~ps|Uo}@", 1, true);
+        assertEquals(Helper.createPointList3D(38.5, -120.2, 10), list);
+
+        list = WebHelper.decodePolyline("_p~iF~ps|Uo}@_ulLnnqC_anF_mqNvxq`@?", 3, true);
+        assertEquals(Helper.createPointList3D(38.5, -120.2, 10, 40.7, -120.95, 1234, 43.252, -126.453, 1234), list);
+    }
+
+    @Test
+    public void testEncode3D() throws Exception
+    {
+        assertEquals("_p~iF~ps|Uo}@", WebHelper.encodePolyline(Helper.createPointList3D(38.5, -120.2, 10)));
+        assertEquals("_p~iF~ps|Uo}@_ulLnnqC_anF_mqNvxq`@?", WebHelper.encodePolyline(
+                Helper.createPointList3D(38.5, -120.2, 10, 40.7, -120.95, 1234, 43.252, -126.453, 1234)));
     }
 }
diff --git a/web/src/test/resources/com/graphhopper/http/test.json b/web/src/test/resources/com/graphhopper/http/test.json
index 90f154897d..734968699f 100644
--- a/web/src/test/resources/com/graphhopper/http/test.json
+++ b/web/src/test/resources/com/graphhopper/http/test.json
@@ -1,17 +1,139 @@
 {
-    "route":{
-        "data":{
-            "type":"LineString",
-            "coordinates":[[11.561414299042843,49.95161928128345],[11.561526057754294,49.95157271515368],[11.561657746769288,49.95148498456519],[11.562031020865538,49.95108730981694],[11.560899277647568,49.950499272730184],[11.56064409525642,49.950439854348595],[11.560398226091227,49.950342438005116]]
-        },
-        "to":[11.560439,49.950357],
-        "time":16,
-        "distance":0.21891499999999997,
-        "from":[11.561415,49.9516],
-        "bbox":[11.560398226091227,49.950342438005116,11.562031020865538,49.95161928128345]
+  "info": {"took": 0.004322056192904711},
+  "paths": [{
+    "bbox": [
+      13.362853824187303,
+      52.469481955531585,
+      13.385836736460217,
+      52.473849308838446
+    ],
+    "distance": 2138.3027624572337,
+    "instructions": [
+      {
+        "distance": 1268.519329705091,
+        "interval": [
+          0,
+          10
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf A 100",
+        "time": 65237
+      },
+      {
+        "distance": 379.74399999999997,
+        "interval": [
+          10,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Strasse",
+        "time": 24855
+      },
+      {
+        "distance": 16.451,
+        "interval": [
+          11,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Tempelhofer Damm",
+        "time": 1316
+      },
+      {
+        "distance": 473.58843275214315,
+        "interval": [
+          11,
+          12
+        ],
+        "sign": -2,
+        "text": "Links abbiegen auf Tempelhofer Damm, B 96",
+        "time": 37882
+      },
+      {
+        "distance": 0,
+        "interval": [
+          12,
+          12
+        ],
+        "sign": 4,
+        "text": "Ziel erreicht!",
+        "time": 0
+      }
+    ],
+    "points": {
+      "coordinates": [
+        [
+          13.362853824187303,
+          52.473849308838446
+        ],
+        [
+          13.36361795731525,
+          52.47361367509396
+        ],
+        [
+          13.365841769408624,
+          52.47262889458155
+        ],
+        [
+          13.368347585983893,
+          52.47146995674379
+        ],
+        [
+          13.369309455960455,
+          52.47115535597106
+        ],
+        [
+          13.370299824408438,
+          52.470938171541796
+        ],
+        [
+          13.372544498127949,
+          52.47050901808982
+        ],
+        [
+          13.373925277007936,
+          52.47029332377672
+        ],
+        [
+          13.374831267628773,
+          52.470171134252205
+        ],
+        [
+          13.375656233183806,
+          52.47009346194774
+        ],
+        [
+          13.378514089700149,
+          52.46991055019
+        ],
+        [
+          13.379928396193574,
+          52.46987162090551
+        ],
+        [
+          13.384775557773759,
+          52.46952423757742
+        ],
+        [
+          13.385498264107815,
+          52.46948735720264
+        ],
+        [
+          13.385740966776185,
+          52.469481955531585
+        ],
+        [
+          13.385832236390536,
+          52.47358033374504
+        ],
+        [
+          13.385836736460217,
+          52.47374048466245
+        ]
+      ],
+      "type": "LineString"
     },
-    "info":{
-        "took":0.026191529,
-        "tookGeocoding":7.2775E-5
-    }
+    "points_encoded": false,
+    "time": 129290
+  }]
 }
\ No newline at end of file
diff --git a/web/src/test/resources/com/graphhopper/http/test_encoded.json b/web/src/test/resources/com/graphhopper/http/test_encoded.json
index bf3549e22d..7d9f329d7f 100644
--- a/web/src/test/resources/com/graphhopper/http/test_encoded.json
+++ b/web/src/test/resources/com/graphhopper/http/test_encoded.json
@@ -1,14 +1,67 @@
 {
-    "route":{
-        "to":[11.560439,49.950357],
-        "time":16,
-        "distance":0.21891499999999997,
-        "from":[11.561415,49.9516],
-        "coordinates":"qd{oHyaqeAFUPYnAkAtBbFJp@Pp@",
-        "bbox":[11.560398226091227,49.950342438005116,11.562031020865538,49.95161928128345]
-    },
-    "info":{
-        "took":1.184025,
-        "tookGeocoding":7.6336E-5
-    }
+  "info": {"took": 0.00414920412003994},
+  "paths": [{
+    "bbox": [
+      13.362853824187303,
+      52.469481955531585,
+      13.385836736460217,
+      52.473849308838446
+    ],
+    "distance": 2138.3027624572337,
+    "instructions": [
+      {
+        "distance": 1268.519329705091,
+        "interval": [
+          0,
+          10
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf A 100",
+        "time": 65237
+      },
+      {
+        "distance": 379.74399999999997,
+        "interval": [
+          10,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Strasse",
+        "time": 24855
+      },
+      {
+        "distance": 16.451,
+        "interval": [
+          11,
+          11
+        ],
+        "sign": 0,
+        "text": "Geradeaus auf Tempelhofer Damm",
+        "time": 1316
+      },
+      {
+        "distance": 473.58843275214315,
+        "interval": [
+          11,
+          12
+        ],
+        "sign": -2,
+        "text": "Links abbiegen auf Tempelhofer Damm, B 96",
+        "time": 37882
+      },
+      {
+        "distance": 0,
+        "interval": [
+          12,
+          12
+        ],
+        "sign": 4,
+        "text": "Ziel erreicht!",
+        "time": 0
+      }
+    ],
+    "points": "oxg_Iy|ppAl@wCdE}LfFsN|@_Ej@eEtAaMh@sGVuDNcDb@{PFyGdAi]FoC?q@sXQ_@?",
+    "points_encoded": true,
+    "time": 129290
+  }]
 }
\ No newline at end of file
diff --git a/web/src/test/webapp/spec/UtilsSpec.js b/web/src/test/webapp/spec/UtilsSpec.js
index 255632d2b7..0d660f2e1f 100644
--- a/web/src/test/webapp/spec/UtilsSpec.js
+++ b/web/src/test/webapp/spec/UtilsSpec.js
@@ -4,18 +4,18 @@
 describe("utils", function() {
     it("should format time string correctly", function() {
         defaultTranslationMap = {};
-        defaultTranslationMap["minabbr"]='min';
-        defaultTranslationMap["hourabbr"]='h';
-        defaultTranslationMap["dayabbr"]='d';
+        defaultTranslationMap["minabbr"] = 'min';
+        defaultTranslationMap["hourabbr"] = 'h';
+        defaultTranslationMap["dayabbr"] = 'd';
         expect(createTimeString(10773331)).toBe("2h 59min");
-        
+
         expect(createTimeString(10773331 * 24)).toBe("2d 23h");
-        
+
         expect(createTimeString(260493166)).toBe("3d");
         expect(createTimeString(3642407)).toBe("1h");
         expect(createTimeString(12000)).toBe("0min");
     });
-    
+
     it("should format translation string correctly", function() {
         // toBe, toBeTruthy, toBeFalsy
         defaultTranslationMap = {};
@@ -52,4 +52,43 @@ describe("utils", function() {
         });
         expect(res).toEqual({postcode: undefined, city: "Rixdorf, Neuklln", country: "Deutschland", more: "Berlin, Europischen Union"});
     });
+
+    it("should decode the polyline", function() {
+        var list = decodePath("_p~iF~ps|U", false);
+        expect(list).toEqual([[-120.2, 38.5]]);
+
+        list = decodePath("_p~iF~ps|U_ulLnnqC_mqNvxq`@", false);
+        expect(list).toEqual([[-120.2, 38.5], [-120.95, 40.7], [-126.45300000000002, 43.252]]);
+    });
+
+    it("should decode the 3D polyline", function() {
+        var list = decodePath("_p~iF~ps|Uo}@", true);
+        expect(list).toEqual([[-120.2, 38.5, 10]]);
+
+        list = decodePath("_p~iF~ps|Uo}@_ulLnnqC_anF_mqNvxq`@?", true);
+        expect(list).toEqual([[-120.2, 38.5, 10], [-120.95, 40.7, 1234], [-126.45300000000002, 43.252, 1234]]);
+    });
+
+    it("ghrequest should init correctly from params", function() {
+        var ghRequest = new GHRequest("http://test.de");
+        var params = {};
+        params.do_zoom = true;
+        ghRequest.init(params);
+        expect(ghRequest.do_zoom).toEqual(params.do_zoom);
+
+        params.do_zoom = false;
+        ghRequest.init(params);
+        expect(ghRequest.do_zoom).toEqual(params.do_zoom);
+    });
+
+    it("input should accept 0", function() {        
+        var input = new GHInput("12,0");
+        expect(input.toString()).toEqual("12,0");
+        var input = new GHInput("bluo,0");
+        expect(input.toString()).toEqual(undefined);
+        var input = new GHInput("bluo");
+        expect(input.toString()).toEqual(undefined);
+        var input = new GHInput("");
+        expect(input.toString()).toEqual(undefined);
+    });
 });
\ No newline at end of file
